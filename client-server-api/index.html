

<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.119.0">
<meta name="robots" content="index, follow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Client-Server API | Matrix Specification</title>
<meta name="description" content="Home of the Matrix specification for decentralised communication">
<meta property="og:title" content="Client-Server API" />
<meta property="og:description" content="Home of the Matrix specification for decentralised communication" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/client-server-api/" />
<meta itemprop="name" content="Client-Server API">
<meta itemprop="description" content="Home of the Matrix specification for decentralised communication"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Client-Server API"/>
<meta name="twitter:description" content="Home of the Matrix specification for decentralised communication"/>




<link rel="preload" href="/scss/main.min.af4c3a756149c6e6a38a514505696051afd07c3cc0ac1bb64498d5cd0c8f613b.css" as="style">
<link href="/scss/main.min.af4c3a756149c6e6a38a514505696051afd07c3cc0ac1bb64498d5cd0c8f613b.css" rel="stylesheet" integrity="">

<script
  src="/js/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK">
</script>



<link rel="preload" href="/css/fonts/Inter.css" as="style">
<link rel="stylesheet" href="/css/fonts/Inter.css">




<link rel="preload" href="/scss/custom.min.e7010c4aa0015f690b91b7b50c35f1a5f21ea69d2fe93db6b124deb2722a2dcf.css" as="style">
<link href="/scss/custom.min.e7010c4aa0015f690b91b7b50c35f1a5f21ea69d2fe93db6b124deb2722a2dcf.css" rel="stylesheet" integrity="">


  </head>
  <body class="td-section">
    <header>
      


<nav class="js-navbar-scroll navbar navbar-expand navbar-light flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg width="75" height="32" xmlns="http://www.w3.org/2000/svg"><g fill="#000" fill-rule="nonzero"><path d="M.936.732V31.25H3.13v.732H.095V0h3.034v.732zm8.45 9.675v1.544h.044a4.461 4.461.0 011.487-1.368c.58-.323 1.245-.485 1.993-.485.72.0 1.377.14 1.972.42.595.279 1.047.771 1.355 1.477.338-.5.796-.941 1.377-1.323.58-.383 1.266-.574 2.06-.574.602.0 1.16.074 1.674.22.514.148.954.383 1.322.707.366.323.653.746.859 1.268.205.522.308 1.15.308 1.887v7.633H20.71v-6.464c0-.383-.015-.743-.044-1.082a2.305 2.305.0 00-.242-.882 1.473 1.473.0 00-.584-.596c-.257-.146-.606-.22-1.047-.22-.44.0-.796.085-1.068.253-.272.17-.485.39-.639.662a2.654 2.654.0 00-.308.927 7.074 7.074.0 00-.078 1.048v6.354h-3.128v-6.398c0-.338-.007-.673-.021-1.004a2.825 2.825.0 00-.188-.916 1.411 1.411.0 00-.55-.673c-.258-.168-.636-.253-1.135-.253a2.33 2.33.0 00-.584.1 1.94 1.94.0 00-.705.374c-.228.184-.422.449-.584.794-.161.346-.242.798-.242 1.357v6.619H6.434V10.407h2.952zm16.456 1.677a3.751 3.751.0 011.233-1.17 5.37 5.37.0 011.685-.629 9.579 9.579.0 011.884-.187c.573.0 1.153.04 1.74.121.588.081 1.124.24 1.609.475.484.235.88.562 1.19.981.308.42.462.975.462 1.666v5.934c0 .516.03 1.008.088 1.478.058.471.161.824.308 1.06H32.87a4.435 4.435.0 01-.22-1.104c-.5.515-1.087.876-1.762 1.081a7.084 7.084.0 01-2.071.31c-.544.0-1.05-.067-1.52-.2a3.472 3.472.0 01-1.234-.617 2.87 2.87.0 01-.826-1.059c-.199-.426-.298-.934-.298-1.522.0-.647.114-1.18.342-1.6.227-.419.52-.753.881-1.004.36-.25.771-.437 1.234-.562.462-.125.929-.224 1.399-.298.47-.073.932-.132 1.387-.176.456-.044.86-.11 1.212-.199.353-.088.631-.217.837-.386.206-.169.301-.415.287-.74.0-.337-.055-.606-.166-.804a1.217 1.217.0 00-.44-.464 1.737 1.737.0 00-.639-.22 5.292 5.292.0 00-.782-.055c-.617.0-1.101.132-1.454.397-.352.264-.558.706-.617 1.323h-3.128c.044-.735.227-1.345.55-1.83zm6.179 4.423a5.095 5.095.0 01-.639.165 9.68 9.68.0 01-.716.11c-.25.03-.5.067-.749.11a5.616 5.616.0 00-.694.177 2.057 2.057.0 00-.594.298c-.17.125-.305.284-.408.474-.103.192-.154.434-.154.728.0.28.051.515.154.706.103.192.242.342.419.453.176.11.381.187.617.231.234.044.477.066.726.066.617.0 1.094-.102 1.432-.309.338-.205.587-.452.75-.739.16-.286.26-.576.297-.87.036-.295.055-.53.055-.707v-1.17a1.4 1.4.0 01-.496.277zm11.863-6.1v2.096h-2.291v5.647c0 .53.088.883.264 1.059.176.177.529.265 1.057.265.177.0.345-.007.507-.022.161-.015.316-.037.463-.066v2.426a7.49 7.49.0 01-.882.089 21.67 21.67.0 01-.947.022c-.484.0-.944-.034-1.377-.1a3.233 3.233.0 01-1.145-.386 2.04 2.04.0 01-.782-.816c-.191-.353-.287-.816-.287-1.39v-6.728H36.57v-2.096h1.894v-3.42h3.129v3.42h2.29zm4.471.0v2.118h.044a3.907 3.907.0 011.454-1.754 4.213 4.213.0 011.036-.497 3.734 3.734.0 011.145-.176c.206.0.433.037.683.11v2.912a5.862 5.862.0 00-.528-.077 5.566 5.566.0 00-.595-.033c-.573.0-1.058.096-1.454.287a2.52 2.52.0 00-.958.783 3.143 3.143.0 00-.518 1.158 6.32 6.32.0 00-.154 1.434v5.14h-3.128V10.407h2.973zM54.039 8.642V6.06h3.128v2.582H54.04zm3.128 1.765v11.405H54.04V10.407h3.128zm1.63.0h3.569l2.005 2.978 1.982-2.978h3.459l-3.745 5.339 4.208 6.067h-3.57l-2.378-3.596-2.38 3.596h-3.502l4.097-6.001zM74.094 31.25V.732H71.9V0h3.035v31.982H71.9v-.732z"/></g></svg></span><span class="font-weight-bold">specification</span><span class="navbar-version"> &mdash; unstable version</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">

			<li class="nav-item mr-4 mb-2 mb-lg-0"><a href="https://matrix.org/foundation/">Foundation</a>
			</li>

      <li class="nav-item mr-4 mb-2 mb-lg-0"><a href="https://matrix.org/faq/">FAQs</a>
			</li>

      <li class="nav-item mr-4 mb-2 mb-lg-0"><a href="https://matrix.org/blog/posts">Blog</a>
      </li>

			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"></div>
</nav>




    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-3 td-sidebar d-print-none">
            
<div id="td-sidebar-menu" class="td-sidebar__inner">
  <div id="content-mobile">
  <form class="td-sidebar__search d-flex align-items-center">
    
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-section-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  </div>
  <div id="content-desktop"></div>
  <nav class="collapse td-sidebar-nav" id="td-section-nav">
    <ul class="td-sidebar-nav__section pr-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m--li">
  <a href="/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-"><span class="">Matrix Specification</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-client-server-api-li">
  <a href="/client-server-api/" class="align-left pl-0 active td-sidebar-link td-sidebar-link__section" id="m-client-server-api"><span class="td-sidebar-nav-active-item">Client-Server API</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-server-server-api-li">
  <a href="/server-server-api/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-server-server-api"><span class="">Server-Server API</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-application-service-api-li">
  <a href="/application-service-api/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-application-service-api"><span class="">Application Service API</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-identity-service-api-li">
  <a href="/identity-service-api/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-identity-service-api"><span class="">Identity Service API</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-push-gateway-api-li">
  <a href="/push-gateway-api/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-push-gateway-api"><span class="">Push Gateway API</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-rooms-li">
  <a href="/rooms/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-rooms"><span class="">Room Versions</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-roomsv1-li">
  <a href="/rooms/v1/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv1"><span class="">Room Version 1</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-roomsv2-li">
  <a href="/rooms/v2/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv2"><span class="">Room Version 2</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-roomsv3-li">
  <a href="/rooms/v3/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv3"><span class="">Room Version 3</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-roomsv4-li">
  <a href="/rooms/v4/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv4"><span class="">Room Version 4</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-roomsv5-li">
  <a href="/rooms/v5/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv5"><span class="">Room Version 5</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-roomsv6-li">
  <a href="/rooms/v6/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv6"><span class="">Room Version 6</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-roomsv7-li">
  <a href="/rooms/v7/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv7"><span class="">Room Version 7</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-roomsv8-li">
  <a href="/rooms/v8/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv8"><span class="">Room Version 8</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-roomsv9-li">
  <a href="/rooms/v9/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv9"><span class="">Room Version 9</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-roomsv10-li">
  <a href="/rooms/v10/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv10"><span class="">Room Version 10</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-roomsv11-li">
  <a href="/rooms/v11/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv11"><span class="">Room Version 11</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-proposals-li">
  <a href="/proposals/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-proposals"><span class="">Spec Change Proposals</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-appendices-li">
  <a href="/appendices/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-appendices"><span class="">Appendices</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-changelog-li">
  <a href="/changelog/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-changelog"><span class="">Changelog</span></a>
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </div>
          <main class="col-12 col-md-9 col-xl-7 pl-md-5" role="main">
            






<div class="pageinfo pageinfo-primary pageinfo-unstable">
  <p>You're looking at an unstable version of this specification.
  Unstable specifications may change at any time without notice.</p>
  <p><a href="https://spec.matrix.org/latest">Switch to the current stable release</a>.</p>
</div>


            


<nav aria-label="breadcrumb" class="d-none d-md-block d-print-none">
	<ol class="breadcrumb spb-1">





<li class="breadcrumb-item" >
	<a href="/">Matrix Specification</a>
</li>



<li class="breadcrumb-item active" aria-current="page">
	<a href="/client-server-api/">Client-Server API</a>
</li>

	</ol>
</nav	>




            
<div class="td-content">
	<h1>Client-Server API</h1>
        
	<p>The client-server API allows clients to
send messages, control rooms and synchronise conversation history. It is
designed to support both lightweight clients which store no state and
lazy-load data from the server as required - as well as heavyweight
clients which maintain a full local persistent copy of server state.</p>
<h2 id="api-standards">API Standards</h2>
<p>The mandatory baseline for client-server communication in Matrix is
exchanging JSON objects over HTTP APIs. More efficient transports may be
specified in future as optional extensions.</p>
<p>HTTPS is recommended for communication. The use of plain HTTP is not
recommended outside test environments.</p>
<p>Clients are authenticated using opaque <code>access_token</code> strings (see <a href="#client-authentication">Client
Authentication</a> for details).</p>
<p>All <code>POST</code> and <code>PUT</code> endpoints, with the exception of <a href="#post_matrixmediav3upload"><code>POST /_matrix/media/v3/upload</code></a> and <a href="#put_matrixmediav3uploadservernamemediaid"><code>PUT /_matrix/media/v3/upload/{serverName}/{mediaId}</code></a>,
require the client to supply a request body containing a (potentially empty)
JSON object.  Clients should supply a <code>Content-Type</code> header of
<code>application/json</code> for all requests with JSON bodies, but this is not required.</p>
<p>Similarly, all endpoints require the server to return a JSON object,
with the exception of 200 responses to
<a href="#get_matrixmediav3downloadservernamemediaid"><code>GET /_matrix/media/v3/download/{serverName}/{mediaId}</code></a>
and <a href="#get_matrixmediav3thumbnailservernamemediaid"><code>GET /_matrix/media/v3/thumbnail/{serverName}/{mediaId}</code></a>.
Servers must include a <code>Content-Type</code> header of <code>application/json</code> for all JSON responses.</p>
<p>All JSON data, in requests or responses, must be encoded using UTF-8.</p>
<p>See also <a href="/appendices#conventions-for-matrix-apis">Conventions for Matrix APIs</a>
in the Appendices for conventions which all Matrix APIs are expected to follow,
and <a href="#web-browser-clients">Web Browser Clients</a> below for additional
requirements for server responses.</p>
<h3 id="standard-error-response">Standard error response</h3>
<p>Any errors which occur at the Matrix API level MUST return a &ldquo;standard
error response&rdquo;. This is a JSON object which looks like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;error code&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;error message&gt;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The <code>error</code> string will be a human-readable error message, usually a
sentence explaining what went wrong.</p>
<p>The <code>errcode</code> string will be a unique string which can be used to handle an
error message e.g.  <code>M_FORBIDDEN</code>. Error codes should have their namespace
first in ALL CAPS, followed by a single <code>_</code>. For example, if there was a custom
namespace <code>com.mydomain.here</code>, and a <code>FORBIDDEN</code> code, the error code should
look like <code>COM.MYDOMAIN.HERE_FORBIDDEN</code>. Error codes defined by this
specification should start with <code>M_</code>.</p>
<p>Some <code>errcode</code>s define additional keys which should be present in the error
response object, but the keys <code>error</code> and <code>errcode</code> MUST always be present.</p>
<p>Errors are generally best expressed by their error code rather than the
HTTP status code returned. When encountering the error code <code>M_UNKNOWN</code>,
clients should prefer the HTTP status code as a more reliable reference
for what the issue was. For example, if the client receives an error
code of <code>M_NOT_FOUND</code> but the request gave a 400 Bad Request status
code, the client should treat the error as if the resource was not
found. However, if the client were to receive an error code of
<code>M_UNKNOWN</code> with a 400 Bad Request, the client should assume that the
request being made was invalid.</p>
<h4 id="common-error-codes">Common error codes</h4>
<p>These error codes can be returned by any API endpoint:</p>
<p><code>M_FORBIDDEN</code>
Forbidden access, e.g. joining a room without permission, failed login.</p>
<p><code>M_UNKNOWN_TOKEN</code>
The access or refresh token specified was not recognised.</p>
<p>An additional response parameter, <code>soft_logout</code>, might be present on the
response for 401 HTTP status codes. See <a href="#soft-logout">the soft logout
section</a> for more information.</p>
<p><code>M_MISSING_TOKEN</code>
No access token was specified for the request.</p>
<p><code>M_BAD_JSON</code>
Request contained valid JSON, but it was malformed in some way, e.g.
missing required keys, invalid values for keys.</p>
<p><code>M_NOT_JSON</code>
Request did not contain valid JSON.</p>
<p><code>M_NOT_FOUND</code>
No resource was found for this request.</p>
<p><code>M_LIMIT_EXCEEDED</code>
Too many requests have been sent in a short period of time. Wait a while
then try again.</p>
<p><code>M_UNRECOGNIZED</code>
The server did not understand the request. This is expected to be returned with
a 404 HTTP status code if the endpoint is not implemented or a 405 HTTP status
code if the endpoint is implemented, but the incorrect HTTP method is used.</p>
<p><code>M_UNKNOWN</code>
An unknown error has occurred.</p>
<h4 id="other-error-codes">Other error codes</h4>
<p>The following error codes are specific to certain endpoints.</p>
<!-- TODO: move them to the endpoints that return them -->
<p><code>M_UNAUTHORIZED</code>
The request was not correctly authorized. Usually due to login failures.</p>
<p><code>M_USER_DEACTIVATED</code>
The user ID associated with the request has been deactivated. Typically
for endpoints that prove authentication, such as <code>/login</code>.</p>
<p><code>M_USER_IN_USE</code>
Encountered when trying to register a user ID which has been taken.</p>
<p><code>M_INVALID_USERNAME</code>
Encountered when trying to register a user ID which is not valid.</p>
<p><code>M_ROOM_IN_USE</code>
Sent when the room alias given to the <code>createRoom</code> API is already in
use.</p>
<p><code>M_INVALID_ROOM_STATE</code>
Sent when the initial state given to the <code>createRoom</code> API is invalid.</p>
<p><code>M_THREEPID_IN_USE</code>
Sent when a threepid given to an API cannot be used because the same
threepid is already in use.</p>
<p><code>M_THREEPID_NOT_FOUND</code>
Sent when a threepid given to an API cannot be used because no record
matching the threepid was found.</p>
<p><code>M_THREEPID_AUTH_FAILED</code>
Authentication could not be performed on the third-party identifier.</p>
<p><code>M_THREEPID_DENIED</code>
The server does not permit this third-party identifier. This may happen
if the server only permits, for example, email addresses from a
particular domain.</p>
<p><code>M_SERVER_NOT_TRUSTED</code>
The client&rsquo;s request used a third-party server, e.g. identity server,
that this server does not trust.</p>
<p><code>M_UNSUPPORTED_ROOM_VERSION</code>
The client&rsquo;s request to create a room used a room version that the
server does not support.</p>
<p><code>M_INCOMPATIBLE_ROOM_VERSION</code>
The client attempted to join a room that has a version the server does
not support. Inspect the <code>room_version</code> property of the error response
for the room&rsquo;s version.</p>
<p><code>M_BAD_STATE</code>
The state change requested cannot be performed, such as attempting to
unban a user who is not banned.</p>
<p><code>M_GUEST_ACCESS_FORBIDDEN</code>
The room or resource does not permit guests to access it.</p>
<p><code>M_CAPTCHA_NEEDED</code>
A Captcha is required to complete the request.</p>
<p><code>M_CAPTCHA_INVALID</code>
The Captcha provided did not match what was expected.</p>
<p><code>M_MISSING_PARAM</code>
A required parameter was missing from the request.</p>
<p><code>M_INVALID_PARAM</code>
A parameter that was specified has the wrong value. For example, the
server expected an integer and instead received a string.</p>
<p><code>M_TOO_LARGE</code>
The request or entity was too large.</p>
<p><code>M_EXCLUSIVE</code>
The resource being requested is reserved by an application service, or
the application service making the request has not created the resource.</p>
<p><code>M_RESOURCE_LIMIT_EXCEEDED</code>
The request cannot be completed because the homeserver has reached a
resource limit imposed on it. For example, a homeserver held in a shared
hosting environment may reach a resource limit if it starts using too
much memory or disk space. The error MUST have an <code>admin_contact</code> field
to provide the user receiving the error a place to reach out to.
Typically, this error will appear on routes which attempt to modify
state (e.g.: sending messages, account data, etc) and not routes which
only read state (e.g.: <code>/sync</code>, get account data, etc).</p>
<p><code>M_CANNOT_LEAVE_SERVER_NOTICE_ROOM</code>
The user is unable to reject an invite to join the server notices room.
See the <a href="#server-notices">Server Notices</a> module for more information.</p>
<h3 id="transaction-identifiers">Transaction identifiers</h3>
<p>The client-server API typically uses <code>HTTP PUT</code> to submit requests with
a client-generated transaction identifier in the HTTP path.</p>
<p>The purpose of the transaction ID is to allow the homeserver to distinguish a
new request from a retransmission of a previous request so that it can make
the request idempotent.</p>
<p>The transaction ID should <strong>only</strong> be used for this purpose.</p>
<p>From the client perspective, after the request has finished, the <code>{txnId}</code>
value should be changed by for the next request (how is not specified; a
monotonically increasing integer is recommended).</p>
<p>The homeserver should identify a request as a retransmission if the
transaction ID is the same as a previous request, and the path of the
HTTP request is the same.</p>
<p>Where a retransmission has been identified, the homeserver should return
the same HTTP response code and content as the original request.
For example, <code>PUT /_matrix/client/v3/rooms/{roomId}/send/{eventType}/{txnId}</code>
would return a <code>200 OK</code> with the <code>event_id</code> of the original request in
the response body.</p>
<p>The scope of a transaction ID is for a single <a href="../index.html#devices">device</a>,
and a single HTTP endpoint. In other words: a single device could use the same
transaction ID for a request to <a href="#put_matrixclientv3roomsroomidsendeventtypetxnid"><code>PUT /_matrix/client/v3/rooms/{roomId}/send/{eventType}/{txnId}</code></a>
and <a href="#put_matrixclientv3sendtodeviceeventtypetxnid"><code>PUT /_matrix/client/v3/sendToDevice/{eventType}/{txnId}</code></a>,
and the two requests would be considered distinct because the two are
considered separate endpoints. Similarly, if a client logs out and back in
between two requests using the same transaction ID, the requests are distinct
because the act of logging in and out creates a new device (unless an existing
<code>device_id</code> is passed to <a href="#post_matrixclientv3login"><code>POST /_matrix/client/v3/login</code></a>). On the other hand, if a
client re-uses a transaction ID for the same endpoint after
<a href="#refreshing-access-tokens">refreshing</a> an access token, it will be assumed to
be a duplicate request and ignored. See also
<a href="#relationship-between-access-tokens-and-devices">Relationship between access tokens and devices</a>.</p>
<p>Some API endpoints may allow or require the use of <code>POST</code> requests
without a transaction ID. Where this is optional, the use of a <code>PUT</code>
request is strongly recommended.</p>
<div class="alert rationale " role="alert">
Prior to <code>v1.7</code>, transaction IDs were scoped to &ldquo;client sessions&rdquo; rather than
devices.
</div>
<h2 id="web-browser-clients">Web Browser Clients</h2>
<p>It is realistic to expect that some clients will be written to be run
within a web browser or similar environment. In these cases, the
homeserver should respond to pre-flight requests and supply Cross-Origin
Resource Sharing (CORS) headers on all requests.</p>
<p>Servers MUST expect that clients will approach them with <code>OPTIONS</code>
requests, allowing clients to discover the CORS headers. All endpoints
in this specification support the <code>OPTIONS</code> method, however the server
MUST NOT perform any logic defined for the endpoints when approached
with an <code>OPTIONS</code> request.</p>
<p>When a client approaches the server with a request, the server should
respond with the CORS headers for that route. The recommended CORS
headers to be returned by servers on all requests are:</p>
<pre><code>Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS
Access-Control-Allow-Headers: X-Requested-With, Content-Type, Authorization
</code></pre>
<h2 id="server-discovery">Server Discovery</h2>
<p>In order to allow users to connect to a Matrix server without needing to
explicitly specify the homeserver&rsquo;s URL or other parameters, clients
SHOULD use an auto-discovery mechanism to determine the server&rsquo;s URL
based on a user&rsquo;s Matrix ID. Auto-discovery should only be done at login
time.</p>
<p>In this section, the following terms are used with specific meanings:</p>
<p><code>PROMPT</code>
Retrieve the specific piece of information from the user in a way which
fits within the existing client user experience, if the client is
inclined to do so. Failure can take place instead if no good user
experience for this is possible at this point.</p>
<p><code>IGNORE</code>
Stop the current auto-discovery mechanism. If no more auto-discovery
mechanisms are available, then the client may use other methods of
determining the required parameters, such as prompting the user, or
using default values.</p>
<p><code>FAIL_PROMPT</code>
Inform the user that auto-discovery failed due to invalid/empty data and
<code>PROMPT</code> for the parameter.</p>
<p><code>FAIL_ERROR</code>
Inform the user that auto-discovery did not return any usable URLs. Do
not continue further with the current login process. At this point,
valid data was obtained, but no server is available to serve the client.
No further guess should be attempted and the user should make a
conscientious decision what to do next.</p>
<h3 id="well-known-uri">Well-known URI</h3>
<div class="alert note " role="alert">
Servers hosting the <code>.well-known</code> JSON file SHOULD offer CORS headers,
as per the <a href="#web-browser-clients">CORS</a> section in this specification.
</div>
<p>The <code>.well-known</code> method uses a JSON file at a predetermined location to
specify parameter values. The flow for this method is as follows:</p>
<ol>
<li>Extract the server name from the user&rsquo;s Matrix ID by splitting the
Matrix ID at the first colon.</li>
<li>Extract the hostname from the server name.</li>
<li>Make a GET request to <code>https://hostname/.well-known/matrix/client</code>.
<ol>
<li>If the returned status code is 404, then <code>IGNORE</code>.</li>
<li>If the returned status code is not 200, or the response body is
empty, then <code>FAIL_PROMPT</code>.</li>
<li>Parse the response body as a JSON object
<ol>
<li>If the content cannot be parsed, then <code>FAIL_PROMPT</code>.</li>
</ol>
</li>
<li>Extract the <code>base_url</code> value from the <code>m.homeserver</code> property.
This value is to be used as the base URL of the homeserver.
<ol>
<li>If this value is not provided, then <code>FAIL_PROMPT</code>.</li>
</ol>
</li>
<li>Validate the homeserver base URL:
<ol>
<li>Parse it as a URL. If it is not a URL, then <code>FAIL_ERROR</code>.</li>
<li>Clients SHOULD validate that the URL points to a valid
homeserver before accepting it by connecting to the
<a href="/client-server-api/#get_matrixclientversions"><code>/_matrix/client/versions</code></a> endpoint, ensuring that it does
not return an error, and parsing and validating that the
data conforms with the expected response format. If any step
in the validation fails, then <code>FAIL_ERROR</code>. Validation is
done as a simple check against configuration errors, in
order to ensure that the discovered address points to a
valid homeserver.</li>
<li>It is important to note that the <code>base_url</code> value might include
a trailing <code>/</code>. Consumers should be prepared to handle both cases.</li>
</ol>
</li>
<li>If the <code>m.identity_server</code> property is present, extract the
<code>base_url</code> value for use as the base URL of the identity server.
Validation for this URL is done as in the step above, but using
<code>/_matrix/identity/v2</code> as the endpoint to connect to. If the
<code>m.identity_server</code> property is present, but does not have a
<code>base_url</code> value, then <code>FAIL_PROMPT</code>.</li>
</ol>
</li>
</ol>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="getwell-knownmatrixclient">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/.well-known/matrix/client</span>
  </h1>
</summary>
  <hr/>
<p><p>Gets discovery information about the domain. The file may include
additional keys, which MUST follow the Java package naming convention,
e.g. <code>com.example.myapp.property</code>. This ensures property names are
suitably namespaced for each application and reduces the risk of
clashes.</p>
<p>Note that this endpoint is not necessarily handled by the homeserver,
but by another webserver, to be used for discovering the homeserver URL.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<p>No request parameters or request body.</p>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>Server discovery information.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>No server discovery information available.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="well-knownmatrixclient_discovery-information" class="object-table">
 <caption>Discovery Information</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>m.homeserver</code></td>
  <td><code>Homeserver Information</code></td>
  <td>
    <strong>Required: </strong>Used by clients to discover homeserver information.</td>
 </tr>
 <tr>
  <td><code>m.identity_server</code></td>
  <td><code>Identity Server Information</code></td>
  <td>
    Used by clients to discover identity server information.</td>
 </tr>
</table>
<table id="well-knownmatrixclient_homeserver-information" class="object-table">
 <caption>Homeserver Information</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>base_url</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The base URL for the homeserver for client-server connections.</td>
 </tr>
</table>
<table id="well-knownmatrixclient_identity-server-information" class="object-table">
 <caption>Identity Server Information</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>base_url</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The base URL for the identity server for client-server connections.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;m.homeserver&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;base_url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://matrix.example.com&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;m.identity_server&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;base_url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://identity.example.com&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;org.example.custom.property&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;app_url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://custom.app.example.org&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientversions">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/versions</span>
  </h1>
</summary>
  <hr/>
<p><p>Gets the versions of the specification supported by the server.</p>
<p>Values will take the form <code>vX.Y</code> or <code>rX.Y.Z</code> in historical cases. See
<a href="../#specification-versions">the Specification Versioning</a> for more
information.</p>
<p>The server may additionally advertise experimental features it supports
through <code>unstable_features</code>. These features should be namespaced and
may optionally include version information within their name if desired.
Features listed here are not for optionally toggling parts of the Matrix
specification and should only be used to advertise support for a feature
which has not yet landed in the spec. For example, a feature currently
undergoing the proposal process may appear here and eventually be taken
off this list once the feature lands in the spec and the server deems it
reasonable to do so. Servers may wish to keep advertising features here
after they&rsquo;ve been released into the spec to give clients a chance to
upgrade appropriately. Additionally, clients should avoid using unstable
features in their stable releases.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<p>No request parameters or request body.</p>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The versions supported by the server.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>unstable_features</code></td>
  <td><code>{string: boolean}</code></td>
  <td>
    Experimental features the server supports. Features not listed here,
or the lack of this property all together, indicate that a feature is
not supported.</td>
 </tr>
 <tr>
  <td><code>versions</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The supported versions.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unstable_features&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;org.example.my_feature&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;versions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;r0.0.1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;v1.1&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h2 id="client-authentication">Client Authentication</h2>
<p>Most API endpoints require the user to identify themselves by presenting
previously obtained credentials in the form of an <code>access_token</code> query
parameter or through an Authorization Header of <code>Bearer $access_token</code>.
An access token is typically obtained via the <a href="#login">Login</a> or
<a href="#account-registration-and-management">Registration</a> processes. Access tokens
can expire; a new access token can be generated by using a refresh token.</p>
<div class="alert note " role="alert">
This specification does not mandate a particular format for the access
token. Clients should treat it as an opaque byte sequence. Servers are
free to choose an appropriate format. Server implementors may like to
investigate <a href="http://research.google.com/pubs/pub41892.html">macaroons</a>.
</div>
<h3 id="using-access-tokens">Using access tokens</h3>
<p>Access tokens may be provided in two ways, both of which the homeserver
MUST support:</p>
<ol>
<li>Via a query string parameter, <code>access_token=TheTokenHere</code>.</li>
<li>Via a request header, <code>Authorization: Bearer TheTokenHere</code>.</li>
</ol>
<p>Clients are encouraged to use the <code>Authorization</code> header where possible
to prevent the access token being leaked in access/HTTP logs. The query
string should only be used in cases where the <code>Authorization</code> header is
inaccessible for the client.</p>
<p>When credentials are required but missing or invalid, the HTTP call will
return with a status of 401 and the error code, <code>M_MISSING_TOKEN</code> or
<code>M_UNKNOWN_TOKEN</code> respectively.  Note that an error code of <code>M_UNKNOWN_TOKEN</code>
could mean one of four things:</p>
<ol>
<li>the access token was never valid.</li>
<li>the access token has been logged out.</li>
<li>the access token has been <a href="#soft-logout">soft logged out</a>.</li>
<li>



  <span><strong>[Added in <code>v1.3</code>]</strong></span>
 
 the access token <a href="#refreshing-access-tokens">needs to be refreshed</a>.</li>
</ol>
<p>When a client receives an error code of <code>M_UNKNOWN_TOKEN</code>, it should:</p>
<ul>
<li>attempt to <a href="#refreshing-access-tokens">refresh the token</a>, if it has a refresh
token;</li>
<li>if <a href="#soft-logout"><code>soft_logout</code></a> is set to <code>true</code>, it can offer to
re-log in the user, retaining any of the client&rsquo;s persisted
information;</li>
<li>otherwise, consider the user as having been logged out.</li>
</ul>
<h3 id="relationship-between-access-tokens-and-devices">Relationship between access tokens and devices</h3>
<p>Client <a href="../index.html#devices">devices</a> are closely related to access
tokens and refresh tokens. Matrix servers should record which device
each access token and refresh token are assigned to, so that
subsequent requests can be handled correctly. When a refresh token is
used to generate a new access token and refresh token, the new access
and refresh tokens are now bound to the device associated with the
initial refresh token.</p>
<p>By default, the <a href="#login">Login</a> and <a href="#account-registration-and-management">Registration</a>
processes auto-generate a new <code>device_id</code>. A client is also free to
generate its own <code>device_id</code> or, provided the user remains the same,
reuse a device: in either case the client should pass the <code>device_id</code> in
the request body. If the client sets the <code>device_id</code>, the server will
invalidate any access and refresh tokens previously assigned to that device.</p>
<h3 id="refreshing-access-tokens">Refreshing access tokens</h3>
<p><span><strong>[Added in <code>v1.3</code>]</strong></span></p>
<p>Access tokens can expire after a certain amount of time. Any HTTP calls that
use an expired access token will return with an error code <code>M_UNKNOWN_TOKEN</code>,
preferably with <code>soft_logout: true</code>. When a client receives this error and it
has a refresh token, it should attempt to refresh the access token by calling
<a href="#post_matrixclientv3refresh"><code>/refresh</code></a>. Clients can also refresh their
access token at any time, even if it has not yet expired. If the token refresh
succeeds, the client should use the new token for future requests, and can
re-try previously-failed requests with the new token. When an access token is
refreshed, a new refresh token may be returned; if a new refresh token is
given, the old refresh token will be invalidated, and the new refresh token
should be used when the access token needs to be refreshed.</p>
<p>The old refresh token remains valid until the new access token or refresh token
is used, at which point the old refresh token is revoked. This ensures that if
a client fails to receive or persist the new tokens, it will be able to repeat
the refresh operation.</p>
<p>If the token refresh fails and the error response included a <code>soft_logout: true</code> property, then the client can treat it as a <a href="#soft-logout">soft logout</a>
and attempt to obtain a new access token by re-logging in. If the error
response does not include a <code>soft_logout: true</code> property, the client should
consider the user as being logged out.</p>
<p>Handling of clients that do not support refresh tokens is up to the homeserver;
clients indicate their support for refresh tokens by including a
<code>refresh_token: true</code> property in the request body of the
<a href="#post_matrixclientv3login"><code>/login</code></a> and
<a href="#post_matrixclientv3register"><code>/register</code></a> endpoints. For example, homeservers
may allow the use of non-expiring access tokens, or may expire access tokens
anyways and rely on soft logout behaviour on clients that don&rsquo;t support
refreshing.</p>
<h3 id="soft-logout">Soft logout</h3>
<p>A client can be in a &ldquo;soft logout&rdquo; state if the server requires
re-authentication before continuing, but does not want to invalidate the
client&rsquo;s session. The server indicates that the client is in a soft logout
state by including a <code>soft_logout: true</code> parameter in an <code>M_UNKNOWN_TOKEN</code>
error response; the <code>soft_logout</code> parameter defaults to <code>false</code>. If the
<code>soft_logout</code> parameter is omitted or is <code>false</code>, this means the server has
destroyed the session and the client should not reuse it. That is, any
persisted state held by the client, such as encryption keys and device
information, must not be reused and must be discarded. If <code>soft_logout</code> is
<code>true</code> the client can reuse any persisted state.</p>
<p><span><strong>[Changed in <code>v1.3</code>]</strong></span></p>
<p>A client that receives such a response can try to
<a href="#refreshing-access-tokens">refresh its access token</a>, if it has a refresh
token available. If it does not have a refresh token available, or refreshing
fails with <code>soft_logout: true</code>, the client can acquire a new access token by
specifying the device ID it is already using to the login API.</p>
<h3 id="user-interactive-authentication-api">User-Interactive Authentication API</h3>
<h4 id="overview">Overview</h4>
<p>Some API endpoints require authentication that interacts with the user.
The homeserver may provide many different ways of authenticating, such
as user/password auth, login via a single-sign-on server (SSO), etc.
This specification does not define how homeservers should authorise
their users but instead defines the standard interface which
implementations should follow so that ANY client can log in to ANY
homeserver.</p>
<p>The process takes the form of one or more &lsquo;stages&rsquo;. At each stage the
client submits a set of data for a given authentication type and awaits
a response from the server, which will either be a final success or a
request to perform an additional stage. This exchange continues until
the final success.</p>
<p>For each endpoint, a server offers one or more &lsquo;flows&rsquo; that the client
can use to authenticate itself. Each flow comprises a series of stages,
as described above. The client is free to choose which flow it follows,
however the flow&rsquo;s stages must be completed in order. Failing to follow
the flows in order must result in an HTTP 401 response, as defined
below. When all stages in a flow are complete, authentication is
complete and the API call succeeds.</p>
<h4 id="user-interactive-api-in-the-rest-api">User-interactive API in the REST API</h4>
<p>In the REST API described in this specification, authentication works by
the client and server exchanging JSON dictionaries. The server indicates
what authentication data it requires via the body of an HTTP 401
response, and the client submits that authentication data via the <code>auth</code>
request parameter.</p>
<p>A client should first make a request with no <code>auth</code> parameter.
The homeserver returns an HTTP 401 response, with a JSON body, as follows:</p>
<pre><code>HTTP/1.1 401 Unauthorized
Content-Type: application/json
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;flows&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;stages&#34;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&#34;example.type.foo&#34;</span><span class="p">,</span> <span class="s2">&#34;example.type.bar&#34;</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;stages&#34;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&#34;example.type.foo&#34;</span><span class="p">,</span> <span class="s2">&#34;example.type.baz&#34;</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;params&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;example.type.baz&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;example_key&#34;</span><span class="p">:</span> <span class="s2">&#34;foobar&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;xxxxxx&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>In addition to the <code>flows</code>, this object contains some extra information:</p>
<ul>
<li>
<p><code>params</code>: This section contains any information that the client will
need to know in order to use a given type of authentication. For each
authentication type presented, that type may be present as a key in this
dictionary. For example, the public part of an OAuth client ID could be
given here.</p>
</li>
<li>
<p><code>session</code>: This is a session identifier that the client must pass back
to the homeserver, if one is provided, in subsequent attempts to authenticate
in the same API call.</p>
</li>
</ul>
<p>The client then chooses a flow and attempts to complete the first stage.
It does this by resubmitting the same request with the addition of an
<code>auth</code> key in the object that it submits. This dictionary contains a
<code>type</code> key whose value is the name of the authentication type that the
client is attempting to complete. It must also contain a <code>session</code> key
with the value of the session key given by the homeserver, if one was
given. It also contains other keys dependent on the auth type being
attempted. For example, if the client is attempting to complete auth
type <code>example.type.foo</code>, it might submit something like this:</p>
<pre><code>POST /_matrix/client/v3/endpoint HTTP/1.1
Content-Type: application/json
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;a_request_parameter&#34;</span><span class="p">:</span> <span class="s2">&#34;something&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;another_request_parameter&#34;</span><span class="p">:</span> <span class="s2">&#34;something else&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;auth&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;example.type.foo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;xxxxxx&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;example_credential&#34;</span><span class="p">:</span> <span class="s2">&#34;verypoorsharedsecret&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>If the homeserver deems the authentication attempt to be successful but
still requires more stages to be completed, it returns HTTP status 401
along with the same object as when no authentication was attempted, with
the addition of the <code>completed</code> key which is an array of auth types the
client has completed successfully:</p>
<pre><code>HTTP/1.1 401 Unauthorized
Content-Type: application/json
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;completed&#34;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&#34;example.type.foo&#34;</span> <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;flows&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;stages&#34;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&#34;example.type.foo&#34;</span><span class="p">,</span> <span class="s2">&#34;example.type.bar&#34;</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;stages&#34;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&#34;example.type.foo&#34;</span><span class="p">,</span> <span class="s2">&#34;example.type.baz&#34;</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;params&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;example.type.baz&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;example_key&#34;</span><span class="p">:</span> <span class="s2">&#34;foobar&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;xxxxxx&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Individual stages may require more than one request to complete, in
which case the response will be as if the request was unauthenticated
with the addition of any other keys as defined by the auth type.</p>
<p>If the homeserver decides that an attempt on a stage was unsuccessful,
but the client may make a second attempt, it returns the same HTTP
status 401 response as above, with the addition of the standard
<code>errcode</code> and <code>error</code> fields describing the error. For example:</p>
<pre><code>HTTP/1.1 401 Unauthorized
Content-Type: application/json
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Invalid password&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;completed&#34;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&#34;example.type.foo&#34;</span> <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;flows&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;stages&#34;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&#34;example.type.foo&#34;</span><span class="p">,</span> <span class="s2">&#34;example.type.bar&#34;</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;stages&#34;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&#34;example.type.foo&#34;</span><span class="p">,</span> <span class="s2">&#34;example.type.baz&#34;</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;params&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;example.type.baz&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;example_key&#34;</span><span class="p">:</span> <span class="s2">&#34;foobar&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;xxxxxx&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>If the request fails for a reason other than authentication, the server
returns an error message in the standard format. For example:</p>
<pre><code>HTTP/1.1 400 Bad request
Content-Type: application/json
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_EXAMPLE_ERROR&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Something was wrong&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>If the client has completed all stages of a flow, the homeserver
performs the API call and returns the result as normal. Completed stages
cannot be retried by clients, therefore servers must return either a 401
response with the completed stages, or the result of the API call if all
stages were completed when a client retries a stage.</p>
<p>Some authentication types may be completed by means other than through
the Matrix client, for example, an email confirmation may be completed
when the user clicks on the link in the email. In this case, the client
retries the request with an auth dict containing only the session key.
The response to this will be the same as if the client were attempting
to complete an auth state normally, i.e. the request will either
complete or request auth, with the presence or absence of that auth type
in the &lsquo;completed&rsquo; array indicating whether that stage is complete.</p>
<div class="alert note " role="alert">
A request to an endpoint that uses User-Interactive Authentication never
succeeds without auth. Homeservers may allow requests that don&rsquo;t require
auth by offering a stage with only the <code>m.login.dummy</code> auth type, but they
must still give a 401 response to requests with no auth data.
</div>
<h4 id="example">Example</h4>
<p>At a high level, the requests made for an API call completing an auth
flow with three stages will resemble the following diagram:</p>
<pre tabindex="0"><code>    _______________________
    |       Stage 0         |
    | No auth               |
    |  ___________________  |
    | |_Request_1_________| | &lt;-- Returns &#34;session&#34; key which is used throughout.
    |_______________________|
             |
             |
    _________V_____________
    |       Stage 1         |
    | type: &#34;&lt;auth type1&gt;&#34;  |
    |  ___________________  |
    | |_Request_1_________| |
    |_______________________|
             |
             |
    _________V_____________
    |       Stage 2         |
    | type: &#34;&lt;auth type2&gt;&#34;  |
    |  ___________________  |
    | |_Request_1_________| |
    |  ___________________  |
    | |_Request_2_________| |
    |  ___________________  |
    | |_Request_3_________| |
    |_______________________|
             |
             |
    _________V_____________
    |       Stage 3         |
    | type: &#34;&lt;auth type3&gt;&#34;  |
    |  ___________________  |
    | |_Request_1_________| | &lt;-- Returns API response
    |_______________________|
</code></pre><h4 id="authentication-types">Authentication types</h4>
<p>This specification defines the following auth types:</p>
<ul>
<li><code>m.login.password</code></li>
<li><code>m.login.recaptcha</code></li>
<li><code>m.login.sso</code></li>
<li><code>m.login.email.identity</code></li>
<li><code>m.login.msisdn</code></li>
<li><code>m.login.dummy</code></li>
<li><code>m.login.registration_token</code></li>
</ul>
<h5 id="password-based">Password-based</h5>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>m.login.password</code></td>
<td>The client submits an identifier and secret password, both sent in plain-text.</td>
</tr>
</tbody>
</table>
<p>To use this authentication type, clients should submit an auth dict as
follows:</p>
<pre tabindex="0"><code>{
  &#34;type&#34;: &#34;m.login.password&#34;,
  &#34;identifier&#34;: {
    ...
  },
  &#34;password&#34;: &#34;&lt;password&gt;&#34;,
  &#34;session&#34;: &#34;&lt;session ID&gt;&#34;
}
</code></pre><p>where the <code>identifier</code> property is a user identifier object, as
described in <a href="#identifier-types">Identifier types</a>.</p>
<p>For example, to authenticate using the user&rsquo;s Matrix ID, clients would
submit:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.login.password&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;identifier&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.id.user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;user&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;user_id or user localpart&gt;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;password&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;password&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;session ID&gt;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Alternatively reply using a 3PID bound to the user&rsquo;s account on the
homeserver using the <a href="#get_matrixclientv3account3pid"><code>/account/3pid</code></a> API rather than giving the <code>user</code>
explicitly as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.login.password&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;identifier&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.id.thirdparty&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;medium&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;The medium of the third-party identifier.&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;The third-party address of the user&gt;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;password&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;password&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;session ID&gt;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>In the case that the homeserver does not know about the supplied 3PID,
the homeserver must respond with 403 Forbidden.</p>
<h5 id="google-recaptcha">Google ReCaptcha</h5>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>m.login.recaptcha</code></td>
<td>The user completes a Google ReCaptcha 2.0 challenge.</td>
</tr>
</tbody>
</table>
<p>To use this authentication type, clients should submit an auth dict as
follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.login.recaptcha&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;response&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;captcha response&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;session ID&gt;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h5 id="single-sign-on">Single Sign-On</h5>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>m.login.sso</code></td>
<td>Authentication is supported by authorising with an external single sign-on provider.</td>
</tr>
</tbody>
</table>
<p>A client wanting to complete authentication using SSO should use the
<a href="#fallback">Fallback</a> mechanism. See <a href="#sso-during-user-interactive-authentication">SSO during User-Interactive
Authentication</a> for more information.</p>
<h5 id="email-based-identity--homeserver">Email-based (identity / homeserver)</h5>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>m.login.email.identity</code></td>
<td>Authentication is supported by authorising an email address with an identity server, or homeserver if supported.</td>
</tr>
</tbody>
</table>
<p>Prior to submitting this, the client should authenticate with an
identity server (or homeserver). After authenticating, the session
information should be submitted to the homeserver.</p>
<p>To use this authentication type, clients should submit an auth dict as
follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.login.email.identity&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;threepid_creds&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sid&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;identity server session id&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;client_secret&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;identity server client secret&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;id_server&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;url of identity server authed with, e.g. &#39;matrix.org:8090&#39;&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;id_access_token&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;access token previously registered with the identity server&gt;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;session ID&gt;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Note that <code>id_server</code> (and therefore <code>id_access_token</code>) is optional if
the <code>/requestToken</code> request did not include them.</p>
<h5 id="phone-numbermsisdn-based-identity--homeserver">Phone number/MSISDN-based (identity / homeserver)</h5>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>m.login.msisdn</code></td>
<td>Authentication is supported by authorising a phone number with an identity server, or homeserver if supported.</td>
</tr>
</tbody>
</table>
<p>Prior to submitting this, the client should authenticate with an
identity server (or homeserver). After authenticating, the session
information should be submitted to the homeserver.</p>
<p>To use this authentication type, clients should submit an auth dict as
follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.login.msisdn&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;threepid_creds&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sid&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;identity server session id&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;client_secret&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;identity server client secret&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;id_server&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;url of identity server authed with, e.g. &#39;matrix.org:8090&#39;&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;id_access_token&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;access token previously registered with the identity server&gt;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;session ID&gt;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Note that <code>id_server</code> (and therefore <code>id_access_token</code>) is optional if
the <code>/requestToken</code> request did not include them.</p>
<h5 id="dummy-auth">Dummy Auth</h5>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>m.login.dummy</code></td>
<td>Dummy authentication always succeeds and requires no extra parameters.</td>
</tr>
</tbody>
</table>
<p>The purpose of dummy authentication is to allow servers to not require any form of
User-Interactive Authentication to perform a request. It can also be
used to differentiate flows where otherwise one flow would be a subset
of another flow. e.g. if a server offers flows <code>m.login.recaptcha</code> and
<code>m.login.recaptcha, m.login.email.identity</code> and the client completes the
recaptcha stage first, the auth would succeed with the former flow, even
if the client was intending to then complete the email auth stage. A
server can instead send flows <code>m.login.recaptcha, m.login.dummy</code> and
<code>m.login.recaptcha, m.login.email.identity</code> to fix the ambiguity.</p>
<p>To use this authentication type, clients should submit an auth dict with
just the type and session, if provided:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.login.dummy&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;session ID&gt;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h5 id="token-authenticated-registration">Token-authenticated registration</h5>
<p><span><strong>[Added in <code>v1.2</code>]</strong></span></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>m.login.registration_token</code></td>
<td>Registers an account with a pre-shared token for authentication</td>
</tr>
</tbody>
</table>
<div class="alert note " role="alert">
The <code>m.login.registration_token</code> authentication type is only valid on the
<a href="#post_matrixclientv3register"><code>/register</code></a> endpoint.
</div>
<p>This authentication type provides homeservers the ability to allow registrations
to a limited set of people instead of either offering completely open registrations
or completely closed registration (where the homeserver administrators create
and distribute accounts).</p>
<p>The token required for this authentication type is shared out of band from
Matrix and is an opaque string with maximum length of 64 characters in the
range <code>[A-Za-z0-9._~-]</code>. The server can keep any number of tokens for any
length of time/validity. Such cases might be a token limited to 100 uses or
for the next 2 hours - after the tokens expire, they can no longer be used
to create accounts.</p>
<p>To use this authentication type, clients should submit an auth dict with just
the type, token, and session:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.login.registration_token&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;token&#34;</span><span class="p">:</span> <span class="s2">&#34;fBVFdqVE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;session ID&gt;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>To determine if a token is valid before attempting to use it, the client can
use the <code>/validity</code> API defined below. The API doesn&rsquo;t guarantee that a token
will be valid when used, but does avoid cases where the user finds out late
in the registration process that their token has expired.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv1registermloginregistration_tokenvalidity">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v1/register/m.login.registration_token/validity</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.2</code></strong></p>
<p><p>Queries the server to determine if a given registration token is still
valid at the time of request. This is a point-in-time check where the
token might still expire by the time it is used.</p>
<p>Servers should be sure to rate limit this endpoint to avoid brute force
attacks.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>token</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The token to check validity of.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The check has a result.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The homeserver does not permit registration and thus all tokens are
considered invalid.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>valid</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>True if the token is still valid, false otherwise. This should
additionally be false if the token is not a recognised token by
the server.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;valid&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv1registermloginregistration_tokenvalidity_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Registration is not enabled on this homeserver.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv1registermloginregistration_tokenvalidity_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h4 id="fallback">Fallback</h4>
<p>Clients cannot be expected to be able to know how to process every
single login type. If a client does not know how to handle a given login
type, it can direct the user to a web browser with the URL of a fallback
page which will allow the user to complete that login step out-of-band
in their web browser. The URL it should open is:</p>
<pre><code>/_matrix/client/v3/auth/&lt;auth type&gt;/fallback/web?session=&lt;session ID&gt;
</code></pre>
<p>Where <code>auth type</code> is the type name of the stage it is attempting and
<code>session ID</code> is the ID of the session given by the homeserver.</p>
<p>This MUST return an HTML page which can perform this authentication
stage. This page must use the following JavaScript when the
authentication has been completed:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">onAuthDone</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">window</span><span class="p">.</span><span class="nx">onAuthDone</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">opener</span> <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">opener</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">window</span><span class="p">.</span><span class="nx">opener</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="s2">&#34;authDone&#34;</span><span class="p">,</span> <span class="s2">&#34;*&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This allows the client to either arrange for the global function
<code>onAuthDone</code> to be defined in an embedded browser, or to use the HTML5
<a href="https://www.w3.org/TR/webmessaging/#web-messaging">cross-document
messaging</a> API, to
receive a notification that the authentication stage has been completed.</p>
<p>Once a client receives the notification that the authentication stage
has been completed, it should resubmit the request with an auth dict
with just the session ID:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;session ID&gt;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h5 id="example-1">Example</h5>
<p>A client webapp might use the following JavaScript to open a popup
window which will handle unknown login types:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Arguments:
</span></span></span><span class="line"><span class="cl"><span class="cm"> *     homeserverUrl: the base url of the homeserver (e.g. &#34;https://matrix.org&#34;)
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *     apiEndpoint: the API endpoint being used (e.g.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *        &#34;/_matrix/client/v3/account/password&#34;)
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *     loginType: the loginType being attempted (e.g. &#34;m.login.recaptcha&#34;)
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *     sessionID: the session ID given by the homeserver in earlier requests
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *     onComplete: a callback which will be called with the results of the request
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">unknownLoginType</span><span class="p">(</span><span class="nx">homeserverUrl</span><span class="p">,</span> <span class="nx">apiEndpoint</span><span class="p">,</span> <span class="nx">loginType</span><span class="p">,</span> <span class="nx">sessionID</span><span class="p">,</span> <span class="nx">onComplete</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">popupWindow</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">eventListener</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// check it&#39;s the right message from the right place.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">data</span> <span class="o">!==</span> <span class="s2">&#34;authDone&#34;</span> <span class="o">||</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">origin</span> <span class="o">!==</span> <span class="nx">homeserverUrl</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// close the popup
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">popupWindow</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nb">window</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s2">&#34;message&#34;</span><span class="p">,</span> <span class="nx">eventListener</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// repeat the request
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">var</span> <span class="nx">requestBody</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">auth</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">session</span><span class="o">:</span> <span class="nx">sessionID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">request</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="nx">method</span><span class="o">:</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="nx">url</span><span class="o">:</span><span class="nx">apiEndpoint</span><span class="p">,</span> <span class="nx">json</span><span class="o">:</span><span class="nx">requestBody</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span> <span class="nx">onComplete</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&#34;message&#34;</span><span class="p">,</span> <span class="nx">eventListener</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">homeserverUrl</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;/_matrix/client/v3/auth/&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">        <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">loginType</span><span class="p">)</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;/fallback/web?session=&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">        <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">sessionID</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nx">popupWindow</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="identifier-types">Identifier types</h4>
<p>Some authentication mechanisms use a user identifier object to identify
a user. The user identifier object has a <code>type</code> field to indicate the
type of identifier being used, and depending on the type, has other
fields giving the information required to identify the user as described
below.</p>
<p>This specification defines the following identifier types:</p>
<ul>
<li><code>m.id.user</code></li>
<li><code>m.id.thirdparty</code></li>
<li><code>m.id.phone</code></li>
</ul>
<h5 id="matrix-user-id">Matrix User ID</h5>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>m.id.user</code></td>
<td>The user is identified by their Matrix ID.</td>
</tr>
</tbody>
</table>
<p>A client can identify a user using their Matrix ID. This can either be
the fully qualified Matrix user ID, or just the localpart of the user
ID.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="s2">&#34;identifier&#34;</span><span class="err">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.id.user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;user&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;user_id or user localpart&gt;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h5 id="third-party-id">Third-party ID</h5>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>m.id.thirdparty</code></td>
<td>The user is identified by a third-party identifier in canonicalised form.</td>
</tr>
</tbody>
</table>
<p>A client can identify a user using a 3PID associated with the user&rsquo;s
account on the homeserver, where the 3PID was previously associated
using the <a href="#get_matrixclientv3account3pid"><code>/account/3pid</code></a> API. See the <a href="/appendices#3pid-types">3PID
Types</a> Appendix for a list of Third-party
ID media.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="s2">&#34;identifier&#34;</span><span class="err">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.id.thirdparty&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;medium&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;The medium of the third-party identifier&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;The canonicalised third-party address of the user&gt;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h5 id="phone-number">Phone number</h5>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>m.id.phone</code></td>
<td>The user is identified by a phone number.</td>
</tr>
</tbody>
</table>
<p>A client can identify a user using a phone number associated with the
user&rsquo;s account, where the phone number was previously associated using
the <a href="#get_matrixclientv3account3pid"><code>/account/3pid</code></a> API. The phone number can be passed in as entered
by the user; the homeserver will be responsible for canonicalising it.
If the client wishes to canonicalise the phone number, then it can use
the <code>m.id.thirdparty</code> identifier type with a <code>medium</code> of <code>msisdn</code>
instead.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="s2">&#34;identifier&#34;</span><span class="err">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.id.phone&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;country&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;The country that the phone number is from&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;phone&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;The phone number&gt;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The <code>country</code> is the two-letter uppercase ISO-3166-1 alpha-2 country
code that the number in <code>phone</code> should be parsed as if it were dialled
from.</p>
<h3 id="login">Login</h3>
<p>A client can obtain access tokens using the <code>/login</code> API.</p>
<p>Note that this endpoint does <span class="title-ref">not</span>
currently use the <a href="#user-interactive-authentication-api">User-Interactive Authentication
API</a>.</p>
<p>For a simple username/password login, clients should submit a <code>/login</code>
request as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.login.password&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;identifier&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.id.user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;user&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;user_id or user localpart&gt;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;password&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;password&gt;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Alternatively, a client can use a 3PID bound to the user&rsquo;s account on
the homeserver using the <a href="#get_matrixclientv3account3pid"><code>/account/3pid</code></a> API rather than giving the
<code>user</code> explicitly, as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.login.password&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;identifier&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;medium&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;The medium of the third-party identifier&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;The canonicalised third-party address of the user&gt;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;password&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;password&gt;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>In the case that the homeserver does not know about the supplied 3PID,
the homeserver must respond with <code>403 Forbidden</code>.</p>
<p>To log in using a login token, clients should submit a <code>/login</code> request
as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.login.token&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;token&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;login token&gt;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The <code>token</code> must encode the user ID, since there is no other identifying
data in the request. In the case that the token is not valid, the homeserver must
respond with <code>403 Forbidden</code> and an error code of <code>M_FORBIDDEN</code>.</p>
<p>If the homeserver advertises <code>m.login.sso</code> as a viable flow, and the
client supports it, the client should redirect the user to the
<code>/redirect</code> endpoint for <a href="#client-login-via-sso">client login via SSO</a>. After authentication
is complete, the client will need to submit a <code>/login</code> request matching
<code>m.login.token</code>.</p>
<p>



  <span><strong>[Added in <code>v1.7</code>]</strong></span>
 
 Already-authenticated clients can additionally generate
a token for their user ID if supported by the homeserver using
<a href="/client-server-api/#post_matrixclientv1loginget_token"><code>POST /login/get_token</code></a>.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3login">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/login</span>
  </h1>
</summary>
  <hr/>
<p>Gets the homeserver&rsquo;s supported login types to authenticate users. Clients
should pick one of these and supply it as the <code>type</code> when logging in.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<p>No request parameters or request body.</p>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The login types the homeserver supports</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>flows</code></td>
  <td><code>[LoginFlow]</code></td>
  <td>
    The homeserver&rsquo;s supported login types</td>
 </tr>
</table>
<table id="_matrixclientv3login_loginflow" class="object-table">
 <caption>LoginFlow</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>get_login_token</code></td>
  <td><code>boolean</code></td>
  <td>
    If <code>type</code> is <code>m.login.token</code>, an optional field to indicate
to the unauthenticated client that the homeserver supports
the <a href="/client-server-api/#post_matrixclientv1loginget_token"><code>POST /login/get_token</code></a>
endpoint. Note that supporting the endpoint does not
necessarily indicate that the user attempting to log in will
be able to generate such a token.
<p><strong>Added in <code>v1.7</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The login type. This is supplied as the <code>type</code> when
logging in.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;flows&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.login.password&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;get_login_token&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.login.token&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3login_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3login">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/login</span>
  </h1>
</summary>
  <hr/>
<p><p>Authenticates the user, and issues an access token they can
use to authorize themself in subsequent requests.</p>
<p>If the client does not supply a <code>device_id</code>, the server must
auto-generate one.</p>
<p>The returned access token must be associated with the <code>device_id</code>
supplied by the client or generated by the server. The server may
invalidate any access token previously associated with that device. See
<a href="/client-server-api/#relationship-between-access-tokens-and-devices">Relationship between access tokens and devices</a>.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>address</code></td>
  <td><code>string</code></td>
  <td>
    Third-party identifier for the user.  Deprecated in favour of <code>identifier</code>.</td>
 </tr>
 <tr>
  <td><code>device_id</code></td>
  <td><code>string</code></td>
  <td>
    ID of the client device. If this does not correspond to a
known client device, a new device will be created. The given
device ID must not be the same as a
<a href="/client-server-api/#cross-signing">cross-signing</a> key ID.
The server will auto-generate a device_id
if this is not specified.</td>
 </tr>
 <tr>
  <td><code>identifier</code></td>
  <td><code>User identifier</code></td>
  <td>
    Identification information for a user</td>
 </tr>
 <tr>
  <td><code>initial_device_display_name</code></td>
  <td><code>string</code></td>
  <td>
    A display name to assign to the newly-created device. Ignored
if <code>device_id</code> corresponds to a known device.</td>
 </tr>
 <tr>
  <td><code>medium</code></td>
  <td><code>string</code></td>
  <td>
    When logging in using a third-party identifier, the medium of the identifier. Must be &rsquo;email&rsquo;.  Deprecated in favour of <code>identifier</code>.</td>
 </tr>
 <tr>
  <td><code>password</code></td>
  <td><code>string</code></td>
  <td>
    Required when <code>type</code> is <code>m.login.password</code>. The user&rsquo;s
password.</td>
 </tr>
 <tr>
  <td><code>refresh_token</code></td>
  <td><code>boolean</code></td>
  <td>
    If true, the client supports refresh tokens.
<p><strong>Added in <code>v1.3</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>token</code></td>
  <td><code>string</code></td>
  <td>
    Required when <code>type</code> is <code>m.login.token</code>. Part of Token-based login.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The login type being used.<p>One of: <code>[m.login.password, m.login.token]</code>.</p></td>
 </tr>
 <tr>
  <td><code>user</code></td>
  <td><code>string</code></td>
  <td>
    The fully qualified user ID or just local part of the user ID, to log in.  Deprecated in favour of <code>identifier</code>.</td>
 </tr>
</table>
<table id="_matrixclientv3login_user-identifier" class="object-table">
 <caption>User identifier</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of identification.  See <a href="/client-server-api/#identifier-types">Identifier types</a> for supported values and additional property descriptions.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;identifier&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.id.user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;user&#34;</span><span class="p">:</span> <span class="s2">&#34;cheeky_monkey&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;initial_device_display_name&#34;</span><span class="p">:</span> <span class="s2">&#34;Jungle Phone&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;password&#34;</span><span class="p">:</span> <span class="s2">&#34;ilovebananas&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.login.password&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The user has been authenticated.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td>Part of the request was invalid. For example, the login type may not be recognised.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td><p>The login attempt failed. This can include one of the following error codes:</p>
<ul>
<li><code>M_FORBIDDEN</code>: The provided authentication data was incorrect
or the requested device ID is the same as a cross-signing key
ID.</li>
<li><code>M_USER_DEACTIVATED</code>: The user has been deactivated.</li>
</ul>
</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>access_token</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An access token for the account.
This access token can then be used to authorize other requests.</td>
 </tr>
 <tr>
  <td><code>device_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>ID of the logged-in device. Will be the same as the
corresponding parameter in the request, if one was specified.</td>
 </tr>
 <tr>
  <td><code>expires_in_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The lifetime of the access token, in milliseconds. Once
the access token has expired a new access token can be
obtained by using the provided refresh token. If no
refresh token is provided, the client will need to re-log in
to obtain a new access token. If not given, the client can
assume that the access token will not expire.
<p><strong>Added in <code>v1.3</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>home_server</code></td>
  <td><code>string</code></td>
  <td>
    <p>The server_name of the homeserver on which the account has
been registered.</p>
<p><strong>Deprecated</strong>. Clients should extract the server_name from
<code>user_id</code> (by splitting at the first colon) if they require
it. Note also that <code>homeserver</code> is not spelt this way.</p>
</td>
 </tr>
 <tr>
  <td><code>refresh_token</code></td>
  <td><code>string</code></td>
  <td>
    A refresh token for the account. This token can be used to
obtain a new access token when it expires by calling the
<code>/refresh</code> endpoint.
<p><strong>Added in <code>v1.3</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The fully-qualified Matrix ID for the account.</td>
 </tr>
 <tr>
  <td><code>well_known</code></td>
  <td><code>Discovery Information</code></td>
  <td>
    Optional client configuration provided by the server. If present,
clients SHOULD use the provided object to reconfigure themselves,
optionally validating the URLs within. This object takes the same
form as the one returned from .well-known autodiscovery.</td>
 </tr>
</table>
<table id="_matrixclientv3login_discovery-information" class="object-table">
 <caption>Discovery Information</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>m.homeserver</code></td>
  <td><code>Homeserver Information</code></td>
  <td>
    <strong>Required: </strong>Used by clients to discover homeserver information.</td>
 </tr>
 <tr>
  <td><code>m.identity_server</code></td>
  <td><code>Identity Server Information</code></td>
  <td>
    Used by clients to discover identity server information.</td>
 </tr>
</table>
<table id="_matrixclientv3login_homeserver-information" class="object-table">
 <caption>Homeserver Information</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>base_url</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The base URL for the homeserver for client-server connections.</td>
 </tr>
</table>
<table id="_matrixclientv3login_identity-server-information" class="object-table">
 <caption>Identity Server Information</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>base_url</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The base URL for the identity server for client-server connections.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;access_token&#34;</span><span class="p">:</span> <span class="s2">&#34;abc123&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;device_id&#34;</span><span class="p">:</span> <span class="s2">&#34;GHTYAJCE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;expires_in_ms&#34;</span><span class="p">:</span> <span class="mi">60000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;refresh_token&#34;</span><span class="p">:</span> <span class="s2">&#34;def456&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@cheeky_monkey:matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;well_known&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.homeserver&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;base_url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://example.org&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.identity_server&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;base_url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://id.example.org&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3login_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_UNKNOWN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Bad login type.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3login_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3login_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv1loginget_token">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v1/login/get_token</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.7</code></strong></p>
<p><p>Optional endpoint - the server is not required to implement this endpoint if it does not
intend to use or support this functionality.</p>
<p>This API endpoint uses the <a href="/client-server-api/#user-interactive-authentication-api">User-Interactive Authentication API</a>.</p>
<p>An already-authenticated client can call this endpoint to generate a single-use, time-limited,
token for an unauthenticated client to log in with, becoming logged in as the same user which
called this endpoint. The unauthenticated client uses the generated token in a <code>m.login.token</code>
login flow with the homeserver.</p>
<p>Clients, both authenticated and unauthenticated, might wish to hide user interface which exposes
this feature if the server is not offering it. Authenticated clients can check for support on
a per-user basis with the <code>m.get_login_token</code> <a href="/client-server-api/#capabilities-negotiation">capability</a>,
while unauthenticated clients can detect server support by looking for an <code>m.login.token</code> login
flow with <code>get_login_token: true</code> on <a href="/client-server-api/#post_matrixclientv3login"><code>GET /login</code></a>.</p>
<p>In v1.7 of the specification, transmission of the generated token to an unauthenticated client is
left as an implementation detail. Future MSCs such as <a href="https://github.com/matrix-org/matrix-spec-proposals/pull/3906">MSC3906</a>
might standardise a way to transmit the token between clients.</p>
<p>The generated token MUST only be valid for a single login, enforced by the server. Clients which
intend to log in multiple devices must generate a token for each.</p>
<p>With other User-Interactive Authentication (UIA)-supporting endpoints, servers sometimes do not re-prompt
for verification if the session recently passed UIA. For this endpoint, servers should always re-prompt
the user for verification to ensure explicit consent is gained for each additional client.</p>
<p>Servers are encouraged to apply stricter than normal rate limiting to this endpoint, such as maximum
of 1 request per minute.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>auth</code></td>
  <td><code>Authentication Data</code></td>
  <td>
    Additional authentication information for the user-interactive authentication API.</td>
 </tr>
</table>
<table id="_matrixclientv1loginget_token_authentication-data" class="object-table">
 <caption>Authentication Data</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>session</code></td>
  <td><code>string</code></td>
  <td>
    The value of the session key given by the homeserver.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    The authentication type that the client is attempting to complete.
May be omitted if <code>session</code> is given, and the client is reissuing a
request which it believes has been completed out-of-band (for example,
via the <a href="#fallback">fallback mechanism</a>).</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;auth&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;example_credential&#34;</span><span class="p">:</span> <span class="s2">&#34;verypoorsharedsecret&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;xxxxx&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;example.type.foo&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The login token an unauthenticated client can use to log in as the requesting user.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td><p>The request was malformed, or the user does not have an ability to generate tokens for their devices,
as implied by the <a href="/client-server-api/#user-interactive-authentication-api">User-Interactive Authentication API</a>.</p>
<p>Clients should verify whether the user has an ability to call this endpoint with the <code>m.get_login_token</code>
<a href="/client-server-api/#capabilities-negotiation">capability</a>.</p>
</td>
 </tr>
 <tr>
  <td><code>401</code></td>
  <td>The homeserver requires additional authentication information.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>expires_in_ms</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The time remaining in milliseconds until the homeserver will no longer accept the token. <code>120000</code>
(2 minutes) is recommended as a default.</td>
 </tr>
 <tr>
  <td><code>login_token</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The login token for the <code>m.login.token</code> login flow.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;expires_in_ms&#34;</span><span class="p">:</span> <span class="mi">120000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;login_token&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;opaque string&gt;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv1loginget_token_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_UNKNOWN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;An unknown error occurred&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>401 response</h3>
<table id="_matrixclientv1loginget_token_authentication-response" class="object-table">
 <caption>Authentication response</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>completed</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of the stages the client has completed successfully</td>
 </tr>
 <tr>
  <td><code>flows</code></td>
  <td><code>[Flow information]</code></td>
  <td>
    <strong>Required: </strong>A list of the login flows supported by the server for this API.</td>
 </tr>
 <tr>
  <td><code>params</code></td>
  <td><code>{string: object}</code></td>
  <td>
    Contains any information that the client will need to know in order to
use a given type of authentication. For each login type presented,
that type may be present as a key in this dictionary. For example, the
public part of an OAuth client ID could be given here.</td>
 </tr>
 <tr>
  <td><code>session</code></td>
  <td><code>string</code></td>
  <td>
    This is a session identifier that the client must pass back to the home
server, if one is provided, in subsequent attempts to authenticate in the
same API call.</td>
 </tr>
</table>
<table id="_matrixclientv1loginget_token_flow-information" class="object-table">
 <caption>Flow information</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>stages</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The login type of each of the stages required to complete this
authentication flow</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;completed&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;example.type.foo&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;flows&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;stages&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;example.type.foo&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;params&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;example.type.baz&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;example_key&#34;</span><span class="p">:</span> <span class="s2">&#34;foobar&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;xxxxxxyz&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv1loginget_token_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3refresh">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/refresh</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.3</code></strong></p>
<p><p>Refresh an access token. Clients should use the returned access token
when making subsequent API calls, and store the returned refresh token
(if given) in order to refresh the new access token when necessary.</p>
<p>After an access token has been refreshed, a server can choose to
invalidate the old access token immediately, or can choose not to, for
example if the access token would expire soon anyways. Clients should
not make any assumptions about the old access token still being valid,
and should use the newly provided access token instead.</p>
<p>The old refresh token remains valid until the new access token or refresh token
is used, at which point the old refresh token is revoked.</p>
<p>Note that this endpoint does not require authentication via an
access token. Authentication is provided via the refresh token.</p>
<p>Application Service identity assertion is disabled for this endpoint.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>refresh_token</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The refresh token</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;refresh_token&#34;</span><span class="p">:</span> <span class="s2">&#34;some_token&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>A new access token and refresh token were generated.</td>
 </tr>
 <tr>
  <td><code>401</code></td>
  <td>The provided token was unknown, or has already been used.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>access_token</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The new access token to use.</td>
 </tr>
 <tr>
  <td><code>expires_in_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The lifetime of the access token, in milliseconds. If not
given, the client can assume that the access token will not
expire.</td>
 </tr>
 <tr>
  <td><code>refresh_token</code></td>
  <td><code>string</code></td>
  <td>
    The new refresh token to use when the access token needs to
be refreshed again. If not given, the old refresh token can
be re-used.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;access_token&#34;</span><span class="p">:</span> <span class="s2">&#34;a_new_token&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;expires_in_ms&#34;</span><span class="p">:</span> <span class="mi">60000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;refresh_token&#34;</span><span class="p">:</span> <span class="s2">&#34;another_new_token&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>401 response</h3>
<table id="_matrixclientv3refresh_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_UNKNOWN_TOKEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Soft logged out&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;soft_logout&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3refresh_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3logout">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/logout</span>
  </h1>
</summary>
  <hr/>
<p>Invalidates an existing access token, so that it can no longer be used for
authorization. The device associated with the access token is also deleted.
<a href="/client-server-api/#device-keys">Device keys</a> for the device are deleted alongside the device.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<p>No request parameters or request body.</p>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The access token used in the request was successfully invalidated.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3logoutall">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/logout/all</span>
  </h1>
</summary>
  <hr/>
<p><p>Invalidates all access tokens for a user, so that they can no longer be used for
authorization. This includes the access token that made this request. All devices
for the user are also deleted. <a href="/client-server-api/#device-keys">Device keys</a> for the device are
deleted alongside the device.</p>
<p>This endpoint does not use the <a href="/client-server-api/#user-interactive-authentication-api">User-Interactive Authentication API</a> because
User-Interactive Authentication is designed to protect against attacks where the
someone gets hold of a single access token then takes over the account. This
endpoint invalidates all access tokens for the user, including the token used in
the request, and therefore the attacker is unable to take over the account in
this way.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<p>No request parameters or request body.</p>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The user&rsquo;s access tokens were successfully invalidated.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div></details>
</section>
<h4 id="appservice-login">Appservice Login</h4>
<p><span><strong>[Added in <code>v1.2</code>]</strong></span></p>
<p>An appservice can log in by providing a valid appservice token and a user within the appservice&rsquo;s
namespace.</p>
<div class="alert note " role="alert">
Appservices do not need to log in as individual users in all cases, as they
can perform <a href="/application-service-api#identity-assertion">Identity Assertion</a>
using the appservice token. However, if the appservice needs a scoped token
for a single user then they can use this API instead.
</div>
<p>This request must be authenticated by the <a href="/application-service-api#registration">appservice <code>as_token</code></a>
(see <a href="#client-authentication">Client Authentication</a> on how to provide the token).</p>
<p>To use this login type, clients should submit a <code>/login</code> request as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.login.application_service&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;identifier&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.id.user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;user&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;user_id or user localpart&gt;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>If the access token is not valid, does not correspond to an appservice
or the user has not previously been registered then the homeserver will
respond with an errcode of <code>M_FORBIDDEN</code>.</p>
<p>If the access token does correspond to an appservice, but the user id does
not lie within its namespace then the homeserver will respond with an
errcode of <code>M_EXCLUSIVE</code>.</p>
<h4 id="login-fallback">Login Fallback</h4>
<p>If a client does not recognize any or all login flows it can use the
fallback login API:</p>
<pre><code>GET /_matrix/static/client/login/
</code></pre>
<p>This returns an HTML and JavaScript page which can perform the entire
login process. The page will attempt to call the JavaScript function
<code>window.onLogin</code> when login has been successfully completed.</p>
<p><span><strong>[Added in <code>v1.1</code>]</strong></span></p>
<p>Non-credential parameters valid for the <code>/login</code>
endpoint can be provided as query string parameters here. These are to be
forwarded to the login endpoint during the login process. For example:</p>
<pre><code>GET /_matrix/static/client/login/?device_id=GHTYAJCE
</code></pre>
<h3 id="account-registration-and-management">Account registration and management</h3>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3accountdeactivate">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/account/deactivate</span>
  </h1>
</summary>
  <hr/>
<p><p>Deactivate the user&rsquo;s account, removing all ability for the user to
login again.</p>
<p>This API endpoint uses the <a href="/client-server-api/#user-interactive-authentication-api">User-Interactive Authentication API</a>.</p>
<p>An access token should be submitted to this endpoint if the client has
an active session.</p>
<p>The homeserver may change the flows available depending on whether a
valid access token is provided.</p>
<p>Unlike other endpoints, this endpoint does not take an <code>id_access_token</code>
parameter because the homeserver is expected to sign the request to the
identity server instead.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>auth</code></td>
  <td><code>Authentication Data</code></td>
  <td>
    Additional authentication information for the user-interactive authentication API.</td>
 </tr>
 <tr>
  <td><code>id_server</code></td>
  <td><code>string</code></td>
  <td>
    The identity server to unbind all of the user&rsquo;s 3PIDs from.
If not provided, the homeserver MUST use the <code>id_server</code>
that was originally use to bind each identifier. If the
homeserver does not know which <code>id_server</code> that was,
it must return an <code>id_server_unbind_result</code> of
<code>no-support</code>.</td>
 </tr>
</table>
<table id="_matrixclientv3accountdeactivate_authentication-data" class="object-table">
 <caption>Authentication Data</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>session</code></td>
  <td><code>string</code></td>
  <td>
    The value of the session key given by the homeserver.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    The authentication type that the client is attempting to complete.
May be omitted if <code>session</code> is given, and the client is reissuing a
request which it believes has been completed out-of-band (for example,
via the <a href="#fallback">fallback mechanism</a>).</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;auth&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;example_credential&#34;</span><span class="p">:</span> <span class="s2">&#34;verypoorsharedsecret&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;xxxxx&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;example.type.foo&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;id_server&#34;</span><span class="p">:</span> <span class="s2">&#34;example.org&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The account has been deactivated.</td>
 </tr>
 <tr>
  <td><code>401</code></td>
  <td>The homeserver requires additional authentication information.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>id_server_unbind_result</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An indicator as to whether or not the homeserver was able to unbind
the user&rsquo;s 3PIDs from the identity server(s). <code>success</code> indicates
that all identifiers have been unbound from the identity server while
<code>no-support</code> indicates that one or more identifiers failed to unbind
due to the identity server refusing the request or the homeserver
being unable to determine an identity server to unbind from. This
must be <code>success</code> if the homeserver has no identifiers to unbind
for the user.<p>One of: <code>[success, no-support]</code>.</p></td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;id_server_unbind_result&#34;</span><span class="p">:</span> <span class="s2">&#34;success&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>401 response</h3>
<table id="_matrixclientv3accountdeactivate_authentication-response" class="object-table">
 <caption>Authentication response</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>completed</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of the stages the client has completed successfully</td>
 </tr>
 <tr>
  <td><code>flows</code></td>
  <td><code>[Flow information]</code></td>
  <td>
    <strong>Required: </strong>A list of the login flows supported by the server for this API.</td>
 </tr>
 <tr>
  <td><code>params</code></td>
  <td><code>{string: object}</code></td>
  <td>
    Contains any information that the client will need to know in order to
use a given type of authentication. For each login type presented,
that type may be present as a key in this dictionary. For example, the
public part of an OAuth client ID could be given here.</td>
 </tr>
 <tr>
  <td><code>session</code></td>
  <td><code>string</code></td>
  <td>
    This is a session identifier that the client must pass back to the home
server, if one is provided, in subsequent attempts to authenticate in the
same API call.</td>
 </tr>
</table>
<table id="_matrixclientv3accountdeactivate_flow-information" class="object-table">
 <caption>Flow information</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>stages</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The login type of each of the stages required to complete this
authentication flow</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;completed&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;example.type.foo&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;flows&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;stages&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;example.type.foo&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;params&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;example.type.baz&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;example_key&#34;</span><span class="p">:</span> <span class="s2">&#34;foobar&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;xxxxxxyz&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3accountdeactivate_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3accountpassword">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/account/password</span>
  </h1>
</summary>
  <hr/>
<p><p>Changes the password for an account on this homeserver.</p>
<p>This API endpoint uses the <a href="/client-server-api/#user-interactive-authentication-api">User-Interactive Authentication API</a> to
ensure the user changing the password is actually the owner of the
account.</p>
<p>An access token should be submitted to this endpoint if the client has
an active session.</p>
<p>The homeserver may change the flows available depending on whether a
valid access token is provided. The homeserver SHOULD NOT revoke the
access token provided in the request. Whether other access tokens for
the user are revoked depends on the request parameters.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>auth</code></td>
  <td><code>Authentication Data</code></td>
  <td>
    Additional authentication information for the user-interactive authentication API.</td>
 </tr>
 <tr>
  <td><code>logout_devices</code></td>
  <td><code>boolean</code></td>
  <td>
    <p>Whether the user&rsquo;s other access tokens, and their associated devices, should be
revoked if the request succeeds. Defaults to true.</p>
<p>When <code>false</code>, the server can still take advantage of the <a href="/client-server-api/#soft-logout">soft logout method</a>
for the user&rsquo;s remaining devices.</p>
</td>
 </tr>
 <tr>
  <td><code>new_password</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The new password for the account.</td>
 </tr>
</table>
<table id="_matrixclientv3accountpassword_authentication-data" class="object-table">
 <caption>Authentication Data</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>session</code></td>
  <td><code>string</code></td>
  <td>
    The value of the session key given by the homeserver.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    The authentication type that the client is attempting to complete.
May be omitted if <code>session</code> is given, and the client is reissuing a
request which it believes has been completed out-of-band (for example,
via the <a href="#fallback">fallback mechanism</a>).</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;auth&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;example_credential&#34;</span><span class="p">:</span> <span class="s2">&#34;verypoorsharedsecret&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;xxxxx&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;example.type.foo&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;logout_devices&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;new_password&#34;</span><span class="p">:</span> <span class="s2">&#34;ihatebananas&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The password has been changed.</td>
 </tr>
 <tr>
  <td><code>401</code></td>
  <td>The homeserver requires additional authentication information.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>401 response</h3>
<table id="_matrixclientv3accountpassword_authentication-response" class="object-table">
 <caption>Authentication response</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>completed</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of the stages the client has completed successfully</td>
 </tr>
 <tr>
  <td><code>flows</code></td>
  <td><code>[Flow information]</code></td>
  <td>
    <strong>Required: </strong>A list of the login flows supported by the server for this API.</td>
 </tr>
 <tr>
  <td><code>params</code></td>
  <td><code>{string: object}</code></td>
  <td>
    Contains any information that the client will need to know in order to
use a given type of authentication. For each login type presented,
that type may be present as a key in this dictionary. For example, the
public part of an OAuth client ID could be given here.</td>
 </tr>
 <tr>
  <td><code>session</code></td>
  <td><code>string</code></td>
  <td>
    This is a session identifier that the client must pass back to the home
server, if one is provided, in subsequent attempts to authenticate in the
same API call.</td>
 </tr>
</table>
<table id="_matrixclientv3accountpassword_flow-information" class="object-table">
 <caption>Flow information</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>stages</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The login type of each of the stages required to complete this
authentication flow</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;completed&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;example.type.foo&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;flows&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;stages&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;example.type.foo&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;params&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;example.type.baz&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;example_key&#34;</span><span class="p">:</span> <span class="s2">&#34;foobar&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;xxxxxxyz&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3accountpassword_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3accountpasswordemailrequesttoken">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/account/password/email/requestToken</span>
  </h1>
</summary>
  <hr/>
<p><p>The homeserver must check that the given email address <strong>is
associated</strong> with an account on this homeserver. This API should be
used to request validation tokens when authenticating for the
<code>/account/password</code> endpoint.</p>
<p>This API&rsquo;s parameters and response are identical to that of the
<a href="/client-server-api/#post_matrixclientv3registeremailrequesttoken"><code>/register/email/requestToken</code></a>
endpoint, except that
<code>M_THREEPID_NOT_FOUND</code> may be returned if no account matching the
given email address could be found. The server may instead send an
email to the given address prompting the user to create an account.
<code>M_THREEPID_IN_USE</code> may not be returned.</p>
<p>The homeserver should validate the email itself, either by sending a
validation email itself or by using a service it has control over.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>client_secret</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A unique string generated by the client, and used to identify the
validation attempt. It must be a string consisting of the characters
<code>[0-9a-zA-Z.=_-]</code>. Its length must not exceed 255 characters and it
must not be empty.</td>
 </tr>
 <tr>
  <td><code>email</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The email address to validate.</td>
 </tr>
 <tr>
  <td><code>id_access_token</code></td>
  <td><code>string</code></td>
  <td>
    <p>An access token previously registered with the identity server. Servers
can treat this as optional to distinguish between r0.5-compatible clients
and this specification version.</p>
<p>Required if an <code>id_server</code> is supplied.</p>
</td>
 </tr>
 <tr>
  <td><code>id_server</code></td>
  <td><code>string</code></td>
  <td>
    <p>The hostname of the identity server to communicate with. May optionally
include a port. This parameter is ignored when the homeserver handles
3PID verification.</p>
<p>This parameter is deprecated with a plan to be removed in a future specification
version for <code>/account/password</code> and <code>/register</code> requests.</p>
</td>
 </tr>
 <tr>
  <td><code>next_link</code></td>
  <td><code>string</code></td>
  <td>
    Optional. When the validation is completed, the identity server will
redirect the user to this URL. This option is ignored when submitting
3PID validation information through a POST request.</td>
 </tr>
 <tr>
  <td><code>send_attempt</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The server will only send an email if the <code>send_attempt</code>
is a number greater than the most recent one which it has seen,
scoped to that <code>email</code> + <code>client_secret</code> pair. This is to
avoid repeatedly sending the same email in the case of request
retries between the POSTing user and the identity server.
The client should increment this value if they desire a new
email (e.g. a reminder) to be sent. If they do not, the server
should respond with success but not resend the email.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;client_secret&#34;</span><span class="p">:</span> <span class="s2">&#34;monkeys_are_GREAT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;email&#34;</span><span class="p">:</span> <span class="s2">&#34;alice@example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;id_server&#34;</span><span class="p">:</span> <span class="s2">&#34;id.example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;next_link&#34;</span><span class="p">:</span> <span class="s2">&#34;https://example.org/congratulations.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;send_attempt&#34;</span><span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>An email was sent to the given address.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td>The referenced third-party identifier is not recognised by the
homeserver, or the request was invalid. The error code <code>M_SERVER_NOT_TRUSTED</code>
can be returned if the server does not trust/support the identity server
provided in the request.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The homeserver does not allow the third-party identifier as a
contact option.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="_matrixclientv3accountpasswordemailrequesttoken_requesttokenresponse" class="object-table">
 <caption>RequestTokenResponse</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>sid</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The session ID. Session IDs are opaque strings that must consist entirely
of the characters <code>[0-9a-zA-Z.=_-]</code>. Their length must not exceed 255
characters and they must not be empty.</td>
 </tr>
 <tr>
  <td><code>submit_url</code></td>
  <td><code>string</code></td>
  <td>
    <p>An optional field containing a URL where the client must submit the
validation token to, with identical parameters to the Identity Service
API&rsquo;s <code>POST /validate/email/submitToken</code> endpoint (without the requirement
for an access token). The homeserver must send this token to the user (if
applicable), who should then be prompted to provide it to the client.</p>
<p>If this field is not present, the client can assume that verification
will happen without the client&rsquo;s involvement provided the homeserver
advertises this specification version in the <code>/versions</code> response
(ie: r0.5.0).</p>
</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sid&#34;</span><span class="p">:</span> <span class="s2">&#34;123abc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;submit_url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://example.org/path/to/submitToken&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3accountpasswordemailrequesttoken_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_THREEPID_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Email not found&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3accountpasswordemailrequesttoken_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_THREEPID_DENIED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Third-party identifier is not allowed&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3accountpasswordmsisdnrequesttoken">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/account/password/msisdn/requestToken</span>
  </h1>
</summary>
  <hr/>
<p><p>The homeserver must check that the given phone number <strong>is
associated</strong> with an account on this homeserver. This API should be
used to request validation tokens when authenticating for the
<code>/account/password</code> endpoint.</p>
<p>This API&rsquo;s parameters and response are identical to that of the
<a href="/client-server-api/#post_matrixclientv3registermsisdnrequesttoken"><code>/register/msisdn/requestToken</code></a>
endpoint, except that
<code>M_THREEPID_NOT_FOUND</code> may be returned if no account matching the
given phone number could be found. The server may instead send the SMS
to the given phone number prompting the user to create an account.
<code>M_THREEPID_IN_USE</code> may not be returned.</p>
<p>The homeserver should validate the phone number itself, either by sending a
validation message itself or by using a service it has control over.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>client_secret</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A unique string generated by the client, and used to identify the
validation attempt. It must be a string consisting of the characters
<code>[0-9a-zA-Z.=_-]</code>. Its length must not exceed 255 characters and it
must not be empty.</td>
 </tr>
 <tr>
  <td><code>country</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The two-letter uppercase ISO-3166-1 alpha-2 country code that the
number in <code>phone_number</code> should be parsed as if it were dialled from.</td>
 </tr>
 <tr>
  <td><code>id_access_token</code></td>
  <td><code>string</code></td>
  <td>
    <p>An access token previously registered with the identity server. Servers
can treat this as optional to distinguish between r0.5-compatible clients
and this specification version.</p>
<p>Required if an <code>id_server</code> is supplied.</p>
</td>
 </tr>
 <tr>
  <td><code>id_server</code></td>
  <td><code>string</code></td>
  <td>
    <p>The hostname of the identity server to communicate with. May optionally
include a port. This parameter is ignored when the homeserver handles
3PID verification.</p>
<p>This parameter is deprecated with a plan to be removed in a future specification
version for <code>/account/password</code> and <code>/register</code> requests.</p>
</td>
 </tr>
 <tr>
  <td><code>next_link</code></td>
  <td><code>string</code></td>
  <td>
    Optional. When the validation is completed, the identity server will
redirect the user to this URL. This option is ignored when submitting
3PID validation information through a POST request.</td>
 </tr>
 <tr>
  <td><code>phone_number</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The phone number to validate.</td>
 </tr>
 <tr>
  <td><code>send_attempt</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The server will only send an SMS if the <code>send_attempt</code> is a
number greater than the most recent one which it has seen,
scoped to that <code>country</code> + <code>phone_number</code> + <code>client_secret</code>
triple. This is to avoid repeatedly sending the same SMS in
the case of request retries between the POSTing user and the
identity server. The client should increment this value if
they desire a new SMS (e.g. a reminder) to be sent.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;client_secret&#34;</span><span class="p">:</span> <span class="s2">&#34;monkeys_are_GREAT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;country&#34;</span><span class="p">:</span> <span class="s2">&#34;GB&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;id_server&#34;</span><span class="p">:</span> <span class="s2">&#34;id.example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;next_link&#34;</span><span class="p">:</span> <span class="s2">&#34;https://example.org/congratulations.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;phone_number&#34;</span><span class="p">:</span> <span class="s2">&#34;07700900001&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;send_attempt&#34;</span><span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>An SMS message was sent to the given phone number.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td>The referenced third-party identifier is not recognised by the
homeserver, or the request was invalid. The error code <code>M_SERVER_NOT_TRUSTED</code>
can be returned if the server does not trust/support the identity server
provided in the request.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The homeserver does not allow the third-party identifier as a
contact option.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="_matrixclientv3accountpasswordmsisdnrequesttoken_requesttokenresponse" class="object-table">
 <caption>RequestTokenResponse</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>sid</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The session ID. Session IDs are opaque strings that must consist entirely
of the characters <code>[0-9a-zA-Z.=_-]</code>. Their length must not exceed 255
characters and they must not be empty.</td>
 </tr>
 <tr>
  <td><code>submit_url</code></td>
  <td><code>string</code></td>
  <td>
    <p>An optional field containing a URL where the client must submit the
validation token to, with identical parameters to the Identity Service
API&rsquo;s <code>POST /validate/email/submitToken</code> endpoint (without the requirement
for an access token). The homeserver must send this token to the user (if
applicable), who should then be prompted to provide it to the client.</p>
<p>If this field is not present, the client can assume that verification
will happen without the client&rsquo;s involvement provided the homeserver
advertises this specification version in the <code>/versions</code> response
(ie: r0.5.0).</p>
</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sid&#34;</span><span class="p">:</span> <span class="s2">&#34;123abc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;submit_url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://example.org/path/to/submitToken&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3accountpasswordmsisdnrequesttoken_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_THREEPID_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Phone number not found&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3accountpasswordmsisdnrequesttoken_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_THREEPID_DENIED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Third-party identifier is not allowed&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3register">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/register</span>
  </h1>
</summary>
  <hr/>
<p><p>This API endpoint uses the <a href="/client-server-api/#user-interactive-authentication-api">User-Interactive Authentication API</a>, except in
the cases where a guest account is being registered.</p>
<p>Register for an account on this homeserver.</p>
<p>There are two kinds of user account:</p>
<ul>
<li>
<p><code>user</code> accounts. These accounts may use the full API described in this specification.</p>
</li>
<li>
<p><code>guest</code> accounts. These accounts may have limited permissions and may not be supported by all servers.</p>
</li>
</ul>
<p>If registration is successful, this endpoint will issue an access token
the client can use to authorize itself in subsequent requests.</p>
<p>If the client does not supply a <code>device_id</code>, the server must
auto-generate one.</p>
<p>The server SHOULD register an account with a User ID based on the
<code>username</code> provided, if any. Note that the grammar of Matrix User ID
localparts is restricted, so the server MUST either map the provided
<code>username</code> onto a <code>user_id</code> in a logical manner, or reject any
<code>username</code> which does not comply to the grammar with
<code>M_INVALID_USERNAME</code>.</p>
<p>Matrix clients MUST NOT assume that localpart of the registered
<code>user_id</code> matches the provided <code>username</code>.</p>
<p>The returned access token must be associated with the <code>device_id</code>
supplied by the client or generated by the server. The server may
invalidate any access token previously associated with that device. See
<a href="/client-server-api/#relationship-between-access-tokens-and-devices">Relationship between access tokens and devices</a>.</p>
<p>When registering a guest account, all parameters in the request body
with the exception of <code>initial_device_display_name</code> MUST BE ignored
by the server. The server MUST pick a <code>device_id</code> for the account
regardless of input.</p>
<p>Any user ID returned by this API must conform to the grammar given in the
<a href="/appendices/#user-identifiers">Matrix specification</a>.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>kind</code></td>
  <td><code>string</code></td>
  <td>
    The kind of account to register. Defaults to <code>user</code>.<p>One of: <code>[guest, user]</code>.</p></td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>auth</code></td>
  <td><code>Authentication Data</code></td>
  <td>
    Additional authentication information for the
user-interactive authentication API. Note that this
information is <em>not</em> used to define how the registered user
should be authenticated, but is instead used to
authenticate the <code>register</code> call itself.</td>
 </tr>
 <tr>
  <td><code>device_id</code></td>
  <td><code>string</code></td>
  <td>
    ID of the client device. If this does not correspond to a
known client device, a new device will be created. The server
will auto-generate a device_id if this is not specified.</td>
 </tr>
 <tr>
  <td><code>inhibit_login</code></td>
  <td><code>boolean</code></td>
  <td>
    If true, an <code>access_token</code> and <code>device_id</code> should not be
returned from this call, therefore preventing an automatic
login. Defaults to false.</td>
 </tr>
 <tr>
  <td><code>initial_device_display_name</code></td>
  <td><code>string</code></td>
  <td>
    A display name to assign to the newly-created device. Ignored
if <code>device_id</code> corresponds to a known device.</td>
 </tr>
 <tr>
  <td><code>password</code></td>
  <td><code>string</code></td>
  <td>
    The desired password for the account.</td>
 </tr>
 <tr>
  <td><code>refresh_token</code></td>
  <td><code>boolean</code></td>
  <td>
    If true, the client supports refresh tokens.
<p><strong>Added in <code>v1.3</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>username</code></td>
  <td><code>string</code></td>
  <td>
    The basis for the localpart of the desired Matrix ID. If omitted,
the homeserver MUST generate a Matrix ID local part.</td>
 </tr>
</table>
<table id="_matrixclientv3register_authentication-data" class="object-table">
 <caption>Authentication Data</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>session</code></td>
  <td><code>string</code></td>
  <td>
    The value of the session key given by the homeserver.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    The authentication type that the client is attempting to complete.
May be omitted if <code>session</code> is given, and the client is reissuing a
request which it believes has been completed out-of-band (for example,
via the <a href="#fallback">fallback mechanism</a>).</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;auth&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;example_credential&#34;</span><span class="p">:</span> <span class="s2">&#34;verypoorsharedsecret&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;xxxxx&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;example.type.foo&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;device_id&#34;</span><span class="p">:</span> <span class="s2">&#34;GHTYAJCE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;initial_device_display_name&#34;</span><span class="p">:</span> <span class="s2">&#34;Jungle Phone&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;password&#34;</span><span class="p">:</span> <span class="s2">&#34;ilovebananas&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;username&#34;</span><span class="p">:</span> <span class="s2">&#34;cheeky_monkey&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The account has been registered.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td><p>Part of the request was invalid. This may include one of the following error codes:</p>
<ul>
<li><code>M_USER_IN_USE</code> : The desired user ID is already taken.</li>
<li><code>M_INVALID_USERNAME</code> : The desired user ID is not a valid user name.</li>
<li><code>M_EXCLUSIVE</code> : The desired user ID is in the exclusive namespace
claimed by an application service.</li>
</ul>
<p>These errors may be returned at any stage of the registration process,
including after authentication if the requested user ID was registered
whilst the client was performing authentication.</p>
<p>Homeservers MUST perform the relevant checks and return these codes before
performing User-Interactive Authentication, although they may also return
them after authentication is completed if, for example, the requested user ID
was registered whilst the client was performing authentication.</p>
</td>
 </tr>
 <tr>
  <td><code>401</code></td>
  <td>The homeserver requires additional authentication information.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The homeserver does not permit registering the account. This response
can be used to identify that a particular <code>kind</code> of account is not
allowed, or that registration is generally not supported by the homeserver.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>access_token</code></td>
  <td><code>string</code></td>
  <td>
    An access token for the account.
This access token can then be used to authorize other requests.
Required if the <code>inhibit_login</code> option is false.</td>
 </tr>
 <tr>
  <td><code>device_id</code></td>
  <td><code>string</code></td>
  <td>
    ID of the registered device. Will be the same as the
corresponding parameter in the request, if one was specified.
Required if the <code>inhibit_login</code> option is false.</td>
 </tr>
 <tr>
  <td><code>expires_in_ms</code></td>
  <td><code>integer</code></td>
  <td>
    <p>The lifetime of the access token, in milliseconds. Once
the access token has expired a new access token can be
obtained by using the provided refresh token. If no
refresh token is provided, the client will need to re-log in
to obtain a new access token. If not given, the client can
assume that the access token will not expire.</p>
<p>Omitted if the <code>inhibit_login</code> option is true.</p>
<p><strong>Added in <code>v1.3</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>home_server</code></td>
  <td><code>string</code></td>
  <td>
    <p>The server_name of the homeserver on which the account has
been registered.</p>
<p><strong>Deprecated</strong>. Clients should extract the server_name from
<code>user_id</code> (by splitting at the first colon) if they require
it. Note also that <code>homeserver</code> is not spelt this way.</p>
</td>
 </tr>
 <tr>
  <td><code>refresh_token</code></td>
  <td><code>string</code></td>
  <td>
    <p>A refresh token for the account. This token can be used to
obtain a new access token when it expires by calling the
<code>/refresh</code> endpoint.</p>
<p>Omitted if the <code>inhibit_login</code> option is true.</p>
<p><strong>Added in <code>v1.3</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><p>The fully-qualified Matrix user ID (MXID) that has been registered.</p>
<p>Any user ID returned by this API must conform to the grammar given in the
<a href="/appendices/#user-identifiers">Matrix specification</a>.</p>
</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;access_token&#34;</span><span class="p">:</span> <span class="s2">&#34;abc123&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;device_id&#34;</span><span class="p">:</span> <span class="s2">&#34;GHTYAJCE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@cheeky_monkey:matrix.org&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3register_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_USER_IN_USE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Desired user ID is already taken.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>401 response</h3>
<table id="_matrixclientv3register_authentication-response" class="object-table">
 <caption>Authentication response</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>completed</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of the stages the client has completed successfully</td>
 </tr>
 <tr>
  <td><code>flows</code></td>
  <td><code>[Flow information]</code></td>
  <td>
    <strong>Required: </strong>A list of the login flows supported by the server for this API.</td>
 </tr>
 <tr>
  <td><code>params</code></td>
  <td><code>{string: object}</code></td>
  <td>
    Contains any information that the client will need to know in order to
use a given type of authentication. For each login type presented,
that type may be present as a key in this dictionary. For example, the
public part of an OAuth client ID could be given here.</td>
 </tr>
 <tr>
  <td><code>session</code></td>
  <td><code>string</code></td>
  <td>
    This is a session identifier that the client must pass back to the home
server, if one is provided, in subsequent attempts to authenticate in the
same API call.</td>
 </tr>
</table>
<table id="_matrixclientv3register_flow-information" class="object-table">
 <caption>Flow information</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>stages</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The login type of each of the stages required to complete this
authentication flow</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;completed&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;example.type.foo&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;flows&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;stages&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;example.type.foo&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;params&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;example.type.baz&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;example_key&#34;</span><span class="p">:</span> <span class="s2">&#34;foobar&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;xxxxxxyz&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3register_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Registration is disabled&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3register_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3registeravailable">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/register/available</span>
  </h1>
</summary>
  <hr/>
<p><p>Checks to see if a username is available, and valid, for the server.</p>
<p>The server should check to ensure that, at the time of the request, the
username requested is available for use. This includes verifying that an
application service has not claimed the username and that the username
fits the server&rsquo;s desired requirements (for example, a server could dictate
that it does not permit usernames with underscores).</p>
<p>Matrix clients may wish to use this API prior to attempting registration,
however the clients must also be aware that using this API does not normally
reserve the username. This can mean that the username becomes unavailable
between checking its availability and attempting to register it.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>username</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The username to check the availability of.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The username is available</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td><p>Part of the request was invalid or the username is not available. This may
include one of the following error codes:</p>
<ul>
<li><code>M_USER_IN_USE</code> : The desired username is already taken.</li>
<li><code>M_INVALID_USERNAME</code> : The desired username is not a valid user name.</li>
<li><code>M_EXCLUSIVE</code> : The desired username is in the exclusive namespace
claimed by an application service.</li>
</ul>
</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>available</code></td>
  <td><code>boolean</code></td>
  <td>
    A flag to indicate that the username is available. This should always
be <code>true</code> when the server replies with 200 OK.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;available&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3registeravailable_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_USER_IN_USE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Desired user ID is already taken.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3registeravailable_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3registeremailrequesttoken">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/register/email/requestToken</span>
  </h1>
</summary>
  <hr/>
<p>The homeserver must check that the given email address is <strong>not</strong>
already associated with an account on this homeserver. The homeserver
should validate the email itself, either by sending a validation email
itself or by using a service it has control over.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>client_secret</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A unique string generated by the client, and used to identify the
validation attempt. It must be a string consisting of the characters
<code>[0-9a-zA-Z.=_-]</code>. Its length must not exceed 255 characters and it
must not be empty.</td>
 </tr>
 <tr>
  <td><code>email</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The email address to validate.</td>
 </tr>
 <tr>
  <td><code>id_access_token</code></td>
  <td><code>string</code></td>
  <td>
    <p>An access token previously registered with the identity server. Servers
can treat this as optional to distinguish between r0.5-compatible clients
and this specification version.</p>
<p>Required if an <code>id_server</code> is supplied.</p>
</td>
 </tr>
 <tr>
  <td><code>id_server</code></td>
  <td><code>string</code></td>
  <td>
    <p>The hostname of the identity server to communicate with. May optionally
include a port. This parameter is ignored when the homeserver handles
3PID verification.</p>
<p>This parameter is deprecated with a plan to be removed in a future specification
version for <code>/account/password</code> and <code>/register</code> requests.</p>
</td>
 </tr>
 <tr>
  <td><code>next_link</code></td>
  <td><code>string</code></td>
  <td>
    Optional. When the validation is completed, the identity server will
redirect the user to this URL. This option is ignored when submitting
3PID validation information through a POST request.</td>
 </tr>
 <tr>
  <td><code>send_attempt</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The server will only send an email if the <code>send_attempt</code>
is a number greater than the most recent one which it has seen,
scoped to that <code>email</code> + <code>client_secret</code> pair. This is to
avoid repeatedly sending the same email in the case of request
retries between the POSTing user and the identity server.
The client should increment this value if they desire a new
email (e.g. a reminder) to be sent. If they do not, the server
should respond with success but not resend the email.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;client_secret&#34;</span><span class="p">:</span> <span class="s2">&#34;monkeys_are_GREAT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;email&#34;</span><span class="p">:</span> <span class="s2">&#34;alice@example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;id_server&#34;</span><span class="p">:</span> <span class="s2">&#34;id.example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;next_link&#34;</span><span class="p">:</span> <span class="s2">&#34;https://example.org/congratulations.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;send_attempt&#34;</span><span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>An email has been sent to the specified address. Note that this
may be an email containing the validation token or it may be
informing the user of an error.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td><p>Part of the request was invalid. This may include one of the following error codes:</p>
<ul>
<li><code>M_THREEPID_IN_USE</code> : The email address is already registered to an account on this server.
However, if the homeserver has the ability to send email, it is recommended that the server
instead send an email to the user with instructions on how to reset their password.
This prevents malicious parties from being able to determine if a given email address
has an account on the homeserver in question.</li>
<li><code>M_SERVER_NOT_TRUSTED</code> : The <code>id_server</code> parameter refers to an identity server
that is not trusted by this homeserver.</li>
</ul>
</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The homeserver does not permit the address to be bound.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="_matrixclientv3registeremailrequesttoken_requesttokenresponse" class="object-table">
 <caption>RequestTokenResponse</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>sid</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The session ID. Session IDs are opaque strings that must consist entirely
of the characters <code>[0-9a-zA-Z.=_-]</code>. Their length must not exceed 255
characters and they must not be empty.</td>
 </tr>
 <tr>
  <td><code>submit_url</code></td>
  <td><code>string</code></td>
  <td>
    <p>An optional field containing a URL where the client must submit the
validation token to, with identical parameters to the Identity Service
API&rsquo;s <code>POST /validate/email/submitToken</code> endpoint (without the requirement
for an access token). The homeserver must send this token to the user (if
applicable), who should then be prompted to provide it to the client.</p>
<p>If this field is not present, the client can assume that verification
will happen without the client&rsquo;s involvement provided the homeserver
advertises this specification version in the <code>/versions</code> response
(ie: r0.5.0).</p>
</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sid&#34;</span><span class="p">:</span> <span class="s2">&#34;123abc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;submit_url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://example.org/path/to/submitToken&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3registeremailrequesttoken_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_THREEPID_IN_USE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;The specified address is already in use&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3registeremailrequesttoken_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_THREEPID_DENIED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Third-party identifier is not allowed&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3registermsisdnrequesttoken">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/register/msisdn/requestToken</span>
  </h1>
</summary>
  <hr/>
<p>The homeserver must check that the given phone number is <strong>not</strong>
already associated with an account on this homeserver. The homeserver
should validate the phone number itself, either by sending a validation
message itself or by using a service it has control over.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>client_secret</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A unique string generated by the client, and used to identify the
validation attempt. It must be a string consisting of the characters
<code>[0-9a-zA-Z.=_-]</code>. Its length must not exceed 255 characters and it
must not be empty.</td>
 </tr>
 <tr>
  <td><code>country</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The two-letter uppercase ISO-3166-1 alpha-2 country code that the
number in <code>phone_number</code> should be parsed as if it were dialled from.</td>
 </tr>
 <tr>
  <td><code>id_access_token</code></td>
  <td><code>string</code></td>
  <td>
    <p>An access token previously registered with the identity server. Servers
can treat this as optional to distinguish between r0.5-compatible clients
and this specification version.</p>
<p>Required if an <code>id_server</code> is supplied.</p>
</td>
 </tr>
 <tr>
  <td><code>id_server</code></td>
  <td><code>string</code></td>
  <td>
    <p>The hostname of the identity server to communicate with. May optionally
include a port. This parameter is ignored when the homeserver handles
3PID verification.</p>
<p>This parameter is deprecated with a plan to be removed in a future specification
version for <code>/account/password</code> and <code>/register</code> requests.</p>
</td>
 </tr>
 <tr>
  <td><code>next_link</code></td>
  <td><code>string</code></td>
  <td>
    Optional. When the validation is completed, the identity server will
redirect the user to this URL. This option is ignored when submitting
3PID validation information through a POST request.</td>
 </tr>
 <tr>
  <td><code>phone_number</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The phone number to validate.</td>
 </tr>
 <tr>
  <td><code>send_attempt</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The server will only send an SMS if the <code>send_attempt</code> is a
number greater than the most recent one which it has seen,
scoped to that <code>country</code> + <code>phone_number</code> + <code>client_secret</code>
triple. This is to avoid repeatedly sending the same SMS in
the case of request retries between the POSTing user and the
identity server. The client should increment this value if
they desire a new SMS (e.g. a reminder) to be sent.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;client_secret&#34;</span><span class="p">:</span> <span class="s2">&#34;monkeys_are_GREAT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;country&#34;</span><span class="p">:</span> <span class="s2">&#34;GB&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;id_server&#34;</span><span class="p">:</span> <span class="s2">&#34;id.example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;next_link&#34;</span><span class="p">:</span> <span class="s2">&#34;https://example.org/congratulations.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;phone_number&#34;</span><span class="p">:</span> <span class="s2">&#34;07700900001&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;send_attempt&#34;</span><span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>An SMS message has been sent to the specified phone number. Note
that this may be an SMS message containing the validation token or
it may be informing the user of an error.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td><p>Part of the request was invalid. This may include one of the following error codes:</p>
<ul>
<li><code>M_THREEPID_IN_USE</code> : The phone number is already registered to an account on this server.
However, if the homeserver has the ability to send SMS message, it is recommended that the server
instead send an SMS message to the user with instructions on how to reset their password.
This prevents malicious parties from being able to determine if a given phone number
has an account on the homeserver in question.</li>
<li><code>M_SERVER_NOT_TRUSTED</code> : The <code>id_server</code> parameter refers to an identity server
that is not trusted by this homeserver.</li>
</ul>
</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The homeserver does not permit the address to be bound.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="_matrixclientv3registermsisdnrequesttoken_requesttokenresponse" class="object-table">
 <caption>RequestTokenResponse</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>sid</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The session ID. Session IDs are opaque strings that must consist entirely
of the characters <code>[0-9a-zA-Z.=_-]</code>. Their length must not exceed 255
characters and they must not be empty.</td>
 </tr>
 <tr>
  <td><code>submit_url</code></td>
  <td><code>string</code></td>
  <td>
    <p>An optional field containing a URL where the client must submit the
validation token to, with identical parameters to the Identity Service
API&rsquo;s <code>POST /validate/email/submitToken</code> endpoint (without the requirement
for an access token). The homeserver must send this token to the user (if
applicable), who should then be prompted to provide it to the client.</p>
<p>If this field is not present, the client can assume that verification
will happen without the client&rsquo;s involvement provided the homeserver
advertises this specification version in the <code>/versions</code> response
(ie: r0.5.0).</p>
</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sid&#34;</span><span class="p">:</span> <span class="s2">&#34;123abc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;submit_url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://example.org/path/to/submitToken&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3registermsisdnrequesttoken_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_THREEPID_IN_USE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;The specified address is already in use&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3registermsisdnrequesttoken_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_THREEPID_DENIED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Third-party identifier is not allowed&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h4 id="notes-on-password-management">Notes on password management</h4>
<div class="alert warning " role="alert">
Clients SHOULD enforce that the password provided is suitably complex.
The password SHOULD include a lower-case letter, an upper-case letter, a
number and a symbol and be at a minimum 8 characters in length. Servers
MAY reject weak passwords with an error code <code>M_WEAK_PASSWORD</code>.
</div>
<h3 id="adding-account-administrative-contact-information">Adding Account Administrative Contact Information</h3>
<p>A homeserver may keep some contact information for administrative use.
This is independent of any information kept by any identity servers,
though can be proxied (bound) to the identity server in many cases.</p>
<div class="alert note " role="alert">
This section deals with two terms: &ldquo;add&rdquo; and &ldquo;bind&rdquo;. Where &ldquo;add&rdquo; (or
&ldquo;remove&rdquo;) is used, it is speaking about an identifier that was not bound
to an identity server. As a result, &ldquo;bind&rdquo; (or &ldquo;unbind&rdquo;) references an
identifier that is found in an identity server. Note that an identifier
can be added and bound at the same time, depending on context.
</div>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3account3pid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/account/3pid</span>
  </h1>
</summary>
  <hr/>
<p><p>Gets a list of the third-party identifiers that the homeserver has
associated with the user&rsquo;s account.</p>
<p>This is <em>not</em> the same as the list of third-party identifiers bound to
the user&rsquo;s Matrix ID in identity servers.</p>
<p>Identifiers in this list may be used by the homeserver as, for example,
identifiers that it will accept to reset the user&rsquo;s account password.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<p>No request parameters or request body.</p>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The lookup was successful.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>threepids</code></td>
  <td><code>[Third-party identifier]</code></td>
  <td>
    </td>
 </tr>
</table>
<table id="_matrixclientv3account3pid_third-party-identifier" class="object-table">
 <caption>Third-party identifier</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>added_at</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The timestamp, in milliseconds, when the homeserver associated the third-party identifier with the user.</td>
 </tr>
 <tr>
  <td><code>address</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The third-party identifier address.</td>
 </tr>
 <tr>
  <td><code>medium</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The medium of the third-party identifier.<p>One of: <code>[email, msisdn]</code>.</p></td>
 </tr>
 <tr>
  <td><code>validated_at</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The timestamp, in milliseconds, when the identifier was
validated by the identity server.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;threepids&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;added_at&#34;</span><span class="p">:</span> <span class="mi">1535336848756</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;monkey@banana.island&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;medium&#34;</span><span class="p">:</span> <span class="s2">&#34;email&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;validated_at&#34;</span><span class="p">:</span> <span class="mi">1535176800000</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3account3pid">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint deprecated-inline">/_matrix/client/v3/account/3pid</span>
  </h1>
</summary>
  <hr/>
<div class="alert warning omit-title" role="alert">
This API is deprecated and will be removed from a future release.
</div>
<p><p>Adds contact information to the user&rsquo;s account.</p>
<p>This endpoint is deprecated in favour of the more specific <code>/3pid/add</code>
and <code>/3pid/bind</code> endpoints.</p>
<p><strong>Note:</strong>
Previously this endpoint supported a <code>bind</code> parameter. This parameter
has been removed, making this endpoint behave as though it was <code>false</code>.
This results in this endpoint being an equivalent to <code>/3pid/bind</code> rather
than dual-purpose.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>three_pid_creds</code></td>
  <td><code>ThreePidCredentials</code></td>
  <td>
    <strong>Required: </strong>The third-party credentials to associate with the account.</td>
 </tr>
</table>
<table id="_matrixclientv3account3pid_threepidcredentials" class="object-table">
 <caption>ThreePidCredentials</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>client_secret</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The client secret used in the session with the identity server.</td>
 </tr>
 <tr>
  <td><code>id_access_token</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An access token previously registered with the identity server. Servers
can treat this as optional to distinguish between r0.5-compatible clients
and this specification version.</td>
 </tr>
 <tr>
  <td><code>id_server</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The identity server to use.</td>
 </tr>
 <tr>
  <td><code>sid</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The session identifier given by the identity server.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;three_pid_creds&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;client_secret&#34;</span><span class="p">:</span> <span class="s2">&#34;d0nt-T3ll&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;id_access_token&#34;</span><span class="p">:</span> <span class="s2">&#34;abc123_OpaqueString&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;id_server&#34;</span><span class="p">:</span> <span class="s2">&#34;matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sid&#34;</span><span class="p">:</span> <span class="s2">&#34;abc123987&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The addition was successful.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The credentials could not be verified with the identity server.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>submit_url</code></td>
  <td><code>string</code></td>
  <td>
    <p>An optional field containing a URL where the client must
submit the validation token to, with identical parameters
to the Identity Service API&rsquo;s <code>POST /validate/email/submitToken</code> endpoint (without the requirement
for an access token). The homeserver must send this token to the
user (if applicable), who should then be prompted to provide it
to the client.</p>
<p>If this field is not present, the client can assume that
verification will happen without the client&rsquo;s involvement
provided the homeserver advertises this specification version
in the <code>/versions</code> response (ie: r0.5.0).</p>
</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;submit_url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://example.org/path/to/submitToken&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3account3pid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_THREEPID_AUTH_FAILED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;The third-party credentials could not be verified by the identity server.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3account3pidadd">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/account/3pid/add</span>
  </h1>
</summary>
  <hr/>
<p><p>This API endpoint uses the <a href="/client-server-api/#user-interactive-authentication-api">User-Interactive Authentication API</a>.</p>
<p>Adds contact information to the user&rsquo;s account. Homeservers should use 3PIDs added
through this endpoint for password resets instead of relying on the identity server.</p>
<p>Homeservers should prevent the caller from adding a 3PID to their account if it has
already been added to another user&rsquo;s account on the homeserver.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>auth</code></td>
  <td><code>Authentication Data</code></td>
  <td>
    Additional authentication information for the
user-interactive authentication API.</td>
 </tr>
 <tr>
  <td><code>client_secret</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The client secret used in the session with the homeserver.</td>
 </tr>
 <tr>
  <td><code>sid</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The session identifier given by the homeserver.</td>
 </tr>
</table>
<table id="_matrixclientv3account3pidadd_authentication-data" class="object-table">
 <caption>Authentication Data</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>session</code></td>
  <td><code>string</code></td>
  <td>
    The value of the session key given by the homeserver.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    The authentication type that the client is attempting to complete.
May be omitted if <code>session</code> is given, and the client is reissuing a
request which it believes has been completed out-of-band (for example,
via the <a href="#fallback">fallback mechanism</a>).</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;auth&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;example_credential&#34;</span><span class="p">:</span> <span class="s2">&#34;verypoorsharedsecret&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;xxxxx&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;example.type.foo&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;client_secret&#34;</span><span class="p">:</span> <span class="s2">&#34;d0nt-T3ll&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sid&#34;</span><span class="p">:</span> <span class="s2">&#34;abc123987&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The addition was successful.</td>
 </tr>
 <tr>
  <td><code>401</code></td>
  <td>The homeserver requires additional authentication information.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>401 response</h3>
<table id="_matrixclientv3account3pidadd_authentication-response" class="object-table">
 <caption>Authentication response</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>completed</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of the stages the client has completed successfully</td>
 </tr>
 <tr>
  <td><code>flows</code></td>
  <td><code>[Flow information]</code></td>
  <td>
    <strong>Required: </strong>A list of the login flows supported by the server for this API.</td>
 </tr>
 <tr>
  <td><code>params</code></td>
  <td><code>{string: object}</code></td>
  <td>
    Contains any information that the client will need to know in order to
use a given type of authentication. For each login type presented,
that type may be present as a key in this dictionary. For example, the
public part of an OAuth client ID could be given here.</td>
 </tr>
 <tr>
  <td><code>session</code></td>
  <td><code>string</code></td>
  <td>
    This is a session identifier that the client must pass back to the home
server, if one is provided, in subsequent attempts to authenticate in the
same API call.</td>
 </tr>
</table>
<table id="_matrixclientv3account3pidadd_flow-information" class="object-table">
 <caption>Flow information</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>stages</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The login type of each of the stages required to complete this
authentication flow</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;completed&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;example.type.foo&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;flows&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;stages&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;example.type.foo&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;params&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;example.type.baz&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;example_key&#34;</span><span class="p">:</span> <span class="s2">&#34;foobar&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;xxxxxxyz&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3account3pidadd_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3account3pidbind">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/account/3pid/bind</span>
  </h1>
</summary>
  <hr/>
<p><p>Binds a 3PID to the user&rsquo;s account through the specified identity server.</p>
<p>Homeservers should not prevent this request from succeeding if another user
has bound the 3PID. Homeservers should simply proxy any errors received by
the identity server to the caller.</p>
<p>Homeservers should track successful binds so they can be unbound later.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>client_secret</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The client secret used in the session with the identity server.</td>
 </tr>
 <tr>
  <td><code>id_access_token</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An access token previously registered with the identity server.</td>
 </tr>
 <tr>
  <td><code>id_server</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The identity server to use.</td>
 </tr>
 <tr>
  <td><code>sid</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The session identifier given by the identity server.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;client_secret&#34;</span><span class="p">:</span> <span class="s2">&#34;d0nt-T3ll&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;id_access_token&#34;</span><span class="p">:</span> <span class="s2">&#34;abc123_OpaqueString&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;id_server&#34;</span><span class="p">:</span> <span class="s2">&#34;example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sid&#34;</span><span class="p">:</span> <span class="s2">&#34;abc123987&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The addition was successful.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3account3pidbind_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3account3piddelete">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/account/3pid/delete</span>
  </h1>
</summary>
  <hr/>
<p><p>Removes a third-party identifier from the user&rsquo;s account. This might not
cause an unbind of the identifier from the identity server.</p>
<p>Unlike other endpoints, this endpoint does not take an <code>id_access_token</code>
parameter because the homeserver is expected to sign the request to the
identity server instead.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>address</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The third-party address being removed.</td>
 </tr>
 <tr>
  <td><code>id_server</code></td>
  <td><code>string</code></td>
  <td>
    The identity server to unbind from. If not provided, the homeserver
MUST use the <code>id_server</code> the identifier was added through. If the
homeserver does not know the original <code>id_server</code>, it MUST return
a <code>id_server_unbind_result</code> of <code>no-support</code>.</td>
 </tr>
 <tr>
  <td><code>medium</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The medium of the third-party identifier being removed.<p>One of: <code>[email, msisdn]</code>.</p></td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;example@example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;id_server&#34;</span><span class="p">:</span> <span class="s2">&#34;example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;medium&#34;</span><span class="p">:</span> <span class="s2">&#34;email&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The homeserver has disassociated the third-party identifier from the
user.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>id_server_unbind_result</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An indicator as to whether or not the homeserver was able to unbind
the 3PID from the identity server. <code>success</code> indicates that the
identity server has unbound the identifier whereas <code>no-support</code>
indicates that the identity server refuses to support the request
or the homeserver was not able to determine an identity server to
unbind from.<p>One of: <code>[no-support, success]</code>.</p></td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;id_server_unbind_result&#34;</span><span class="p">:</span> <span class="s2">&#34;success&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3account3pidemailrequesttoken">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/account/3pid/email/requestToken</span>
  </h1>
</summary>
  <hr/>
<p>The homeserver must check that the given email address is <strong>not</strong>
already associated with an account on this homeserver. This API should
be used to request validation tokens when adding an email address to an
account. This API&rsquo;s parameters and response are identical to that of
the <a href="/client-server-api/#post_matrixclientv3registeremailrequesttoken"><code>/register/email/requestToken</code></a>
endpoint. The homeserver should validate
the email itself, either by sending a validation email itself or by using
a service it has control over.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>client_secret</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A unique string generated by the client, and used to identify the
validation attempt. It must be a string consisting of the characters
<code>[0-9a-zA-Z.=_-]</code>. Its length must not exceed 255 characters and it
must not be empty.</td>
 </tr>
 <tr>
  <td><code>email</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The email address to validate.</td>
 </tr>
 <tr>
  <td><code>id_access_token</code></td>
  <td><code>string</code></td>
  <td>
    <p>An access token previously registered with the identity server. Servers
can treat this as optional to distinguish between r0.5-compatible clients
and this specification version.</p>
<p>Required if an <code>id_server</code> is supplied.</p>
</td>
 </tr>
 <tr>
  <td><code>id_server</code></td>
  <td><code>string</code></td>
  <td>
    <p>The hostname of the identity server to communicate with. May optionally
include a port. This parameter is ignored when the homeserver handles
3PID verification.</p>
<p>This parameter is deprecated with a plan to be removed in a future specification
version for <code>/account/password</code> and <code>/register</code> requests.</p>
</td>
 </tr>
 <tr>
  <td><code>next_link</code></td>
  <td><code>string</code></td>
  <td>
    Optional. When the validation is completed, the identity server will
redirect the user to this URL. This option is ignored when submitting
3PID validation information through a POST request.</td>
 </tr>
 <tr>
  <td><code>send_attempt</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The server will only send an email if the <code>send_attempt</code>
is a number greater than the most recent one which it has seen,
scoped to that <code>email</code> + <code>client_secret</code> pair. This is to
avoid repeatedly sending the same email in the case of request
retries between the POSTing user and the identity server.
The client should increment this value if they desire a new
email (e.g. a reminder) to be sent. If they do not, the server
should respond with success but not resend the email.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;client_secret&#34;</span><span class="p">:</span> <span class="s2">&#34;monkeys_are_GREAT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;email&#34;</span><span class="p">:</span> <span class="s2">&#34;alice@example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;id_server&#34;</span><span class="p">:</span> <span class="s2">&#34;id.example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;next_link&#34;</span><span class="p">:</span> <span class="s2">&#34;https://example.org/congratulations.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;send_attempt&#34;</span><span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>An email was sent to the given address. Note that this may be an
email containing the validation token or it may be informing the
user of an error.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td>The third-party identifier is already in use on the homeserver, or
the request was invalid. The error code <code>M_SERVER_NOT_TRUSTED</code>
can be returned if the server does not trust/support the identity server
provided in the request.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The homeserver does not allow the third-party identifier as a
contact option.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="_matrixclientv3account3pidemailrequesttoken_requesttokenresponse" class="object-table">
 <caption>RequestTokenResponse</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>sid</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The session ID. Session IDs are opaque strings that must consist entirely
of the characters <code>[0-9a-zA-Z.=_-]</code>. Their length must not exceed 255
characters and they must not be empty.</td>
 </tr>
 <tr>
  <td><code>submit_url</code></td>
  <td><code>string</code></td>
  <td>
    <p>An optional field containing a URL where the client must submit the
validation token to, with identical parameters to the Identity Service
API&rsquo;s <code>POST /validate/email/submitToken</code> endpoint (without the requirement
for an access token). The homeserver must send this token to the user (if
applicable), who should then be prompted to provide it to the client.</p>
<p>If this field is not present, the client can assume that verification
will happen without the client&rsquo;s involvement provided the homeserver
advertises this specification version in the <code>/versions</code> response
(ie: r0.5.0).</p>
</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sid&#34;</span><span class="p">:</span> <span class="s2">&#34;123abc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;submit_url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://example.org/path/to/submitToken&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3account3pidemailrequesttoken_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_THREEPID_IN_USE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Third-party identifier already in use&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3account3pidemailrequesttoken_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_THREEPID_DENIED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Third-party identifier is not allowed&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3account3pidmsisdnrequesttoken">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/account/3pid/msisdn/requestToken</span>
  </h1>
</summary>
  <hr/>
<p>The homeserver must check that the given phone number is <strong>not</strong>
already associated with an account on this homeserver. This API should
be used to request validation tokens when adding a phone number to an
account. This API&rsquo;s parameters and response are identical to that of
the <a href="/client-server-api/#post_matrixclientv3registermsisdnrequesttoken"><code>/register/msisdn/requestToken</code></a>
endpoint. The homeserver should validate
the phone number itself, either by sending a validation message itself or by using
a service it has control over.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>client_secret</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A unique string generated by the client, and used to identify the
validation attempt. It must be a string consisting of the characters
<code>[0-9a-zA-Z.=_-]</code>. Its length must not exceed 255 characters and it
must not be empty.</td>
 </tr>
 <tr>
  <td><code>country</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The two-letter uppercase ISO-3166-1 alpha-2 country code that the
number in <code>phone_number</code> should be parsed as if it were dialled from.</td>
 </tr>
 <tr>
  <td><code>id_access_token</code></td>
  <td><code>string</code></td>
  <td>
    <p>An access token previously registered with the identity server. Servers
can treat this as optional to distinguish between r0.5-compatible clients
and this specification version.</p>
<p>Required if an <code>id_server</code> is supplied.</p>
</td>
 </tr>
 <tr>
  <td><code>id_server</code></td>
  <td><code>string</code></td>
  <td>
    <p>The hostname of the identity server to communicate with. May optionally
include a port. This parameter is ignored when the homeserver handles
3PID verification.</p>
<p>This parameter is deprecated with a plan to be removed in a future specification
version for <code>/account/password</code> and <code>/register</code> requests.</p>
</td>
 </tr>
 <tr>
  <td><code>next_link</code></td>
  <td><code>string</code></td>
  <td>
    Optional. When the validation is completed, the identity server will
redirect the user to this URL. This option is ignored when submitting
3PID validation information through a POST request.</td>
 </tr>
 <tr>
  <td><code>phone_number</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The phone number to validate.</td>
 </tr>
 <tr>
  <td><code>send_attempt</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The server will only send an SMS if the <code>send_attempt</code> is a
number greater than the most recent one which it has seen,
scoped to that <code>country</code> + <code>phone_number</code> + <code>client_secret</code>
triple. This is to avoid repeatedly sending the same SMS in
the case of request retries between the POSTing user and the
identity server. The client should increment this value if
they desire a new SMS (e.g. a reminder) to be sent.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;client_secret&#34;</span><span class="p">:</span> <span class="s2">&#34;monkeys_are_GREAT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;country&#34;</span><span class="p">:</span> <span class="s2">&#34;GB&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;id_server&#34;</span><span class="p">:</span> <span class="s2">&#34;id.example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;next_link&#34;</span><span class="p">:</span> <span class="s2">&#34;https://example.org/congratulations.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;phone_number&#34;</span><span class="p">:</span> <span class="s2">&#34;07700900001&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;send_attempt&#34;</span><span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>An SMS message was sent to the given phone number.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td>The third-party identifier is already in use on the homeserver, or
the request was invalid. The error code <code>M_SERVER_NOT_TRUSTED</code>
can be returned if the server does not trust/support the identity server
provided in the request.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The homeserver does not allow the third-party identifier as a
contact option.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="_matrixclientv3account3pidmsisdnrequesttoken_requesttokenresponse" class="object-table">
 <caption>RequestTokenResponse</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>sid</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The session ID. Session IDs are opaque strings that must consist entirely
of the characters <code>[0-9a-zA-Z.=_-]</code>. Their length must not exceed 255
characters and they must not be empty.</td>
 </tr>
 <tr>
  <td><code>submit_url</code></td>
  <td><code>string</code></td>
  <td>
    <p>An optional field containing a URL where the client must submit the
validation token to, with identical parameters to the Identity Service
API&rsquo;s <code>POST /validate/email/submitToken</code> endpoint (without the requirement
for an access token). The homeserver must send this token to the user (if
applicable), who should then be prompted to provide it to the client.</p>
<p>If this field is not present, the client can assume that verification
will happen without the client&rsquo;s involvement provided the homeserver
advertises this specification version in the <code>/versions</code> response
(ie: r0.5.0).</p>
</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sid&#34;</span><span class="p">:</span> <span class="s2">&#34;123abc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;submit_url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://example.org/path/to/submitToken&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3account3pidmsisdnrequesttoken_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_THREEPID_IN_USE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Third-party identifier already in use&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3account3pidmsisdnrequesttoken_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_THREEPID_DENIED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Third-party identifier is not allowed&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3account3pidunbind">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/account/3pid/unbind</span>
  </h1>
</summary>
  <hr/>
<p><p>Removes a user&rsquo;s third-party identifier from the provided identity server
without removing it from the homeserver.</p>
<p>Unlike other endpoints, this endpoint does not take an <code>id_access_token</code>
parameter because the homeserver is expected to sign the request to the
identity server instead.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>address</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The third-party address being removed.</td>
 </tr>
 <tr>
  <td><code>id_server</code></td>
  <td><code>string</code></td>
  <td>
    The identity server to unbind from. If not provided, the homeserver
MUST use the <code>id_server</code> the identifier was added through. If the
homeserver does not know the original <code>id_server</code>, it MUST return
a <code>id_server_unbind_result</code> of <code>no-support</code>.</td>
 </tr>
 <tr>
  <td><code>medium</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The medium of the third-party identifier being removed.<p>One of: <code>[email, msisdn]</code>.</p></td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;example@example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;id_server&#34;</span><span class="p">:</span> <span class="s2">&#34;example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;medium&#34;</span><span class="p">:</span> <span class="s2">&#34;email&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The identity server has disassociated the third-party identifier from the
user.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>id_server_unbind_result</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An indicator as to whether or not the identity server was able to unbind
the 3PID. <code>success</code> indicates that the identity server has unbound the
identifier whereas <code>no-support</code> indicates that the identity server
refuses to support the request or the homeserver was not able to determine
an identity server to unbind from.<p>One of: <code>[no-support, success]</code>.</p></td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;id_server_unbind_result&#34;</span><span class="p">:</span> <span class="s2">&#34;success&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h3 id="current-account-information">Current account information</h3>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3accountwhoami">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/account/whoami</span>
  </h1>
</summary>
  <hr/>
<p><p>Gets information about the owner of a given access token.</p>
<p>Note that, as with the rest of the Client-Server API,
Application Services may masquerade as users within their
namespace by giving a <code>user_id</code> query parameter. In this
situation, the server should verify that the given <code>user_id</code>
is registered by the appservice, and return it in the response
body.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<p>No request parameters or request body.</p>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The token belongs to a known user.</td>
 </tr>
 <tr>
  <td><code>401</code></td>
  <td>The token is not recognised</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The appservice cannot masquerade as the user or has not registered them.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>device_id</code></td>
  <td><code>string</code></td>
  <td>
    Device ID associated with the access token. If no device
is associated with the access token (such as in the case
of application services) then this field can be omitted.
Otherwise this is required.
<p><strong>Added in <code>v1.1</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>is_guest</code></td>
  <td><code>boolean</code></td>
  <td>
    When <code>true</code>, the user is a <a href="#guest-access">Guest User</a>. When
not present or <code>false</code>, the user is presumed to be a non-guest
user.
<p><strong>Added in <code>v1.2</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID that owns the access token.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;device_id&#34;</span><span class="p">:</span> <span class="s2">&#34;ABC1234&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@joe:example.org&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>401 response</h3>
<table id="_matrixclientv3accountwhoami_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_UNKNOWN_TOKEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Unrecognised access token.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3accountwhoami_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Application service has not registered this user.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3accountwhoami_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h4 id="notes-on-identity-servers">Notes on identity servers</h4>
<p>Identity servers in Matrix store bindings (relationships) between a
user&rsquo;s third-party identifier, typically email or phone number, and
their user ID. Once a user has chosen an identity server, that identity
server should be used by all clients.</p>
<p>Clients can see which identity server the user has chosen through the
<code>m.identity_server</code> account data event, as described below. Clients
SHOULD refrain from making requests to any identity server until the
presence of <code>m.identity_server</code> is confirmed as (not) present. If
present, the client SHOULD check for the presence of the <code>base_url</code>
property in the event&rsquo;s content. If the <code>base_url</code> is present, the
client SHOULD use the identity server in that property as the identity
server for the user. If the <code>base_url</code> is missing, or the account data
event is not present, the client SHOULD use whichever default value it
normally would for an identity server, if applicable. Clients SHOULD NOT
update the account data with the default identity server when the user
is missing an identity server in their account data.</p>
<p>Clients SHOULD listen for changes to the <code>m.identity_server</code> account
data event and update the identity server they are contacting as a
result.</p>
<p>If the client offers a way to set the identity server to use, it MUST
update the value of <code>m.identity_server</code> accordingly. A <code>base_url</code> of
<code>null</code> MUST be treated as though the user does not want to use an
identity server, disabling all related functionality as a result.</p>
<p>Clients SHOULD refrain from populating the account data as a migration
step for users who are lacking the account data, unless the user sets
the identity server within the client to a value. For example, a user
which has no <code>m.identity_server</code> account data event should not end up
with the client&rsquo;s default identity server in their account data, unless
the user first visits their account settings to set the identity server.</p>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="midentity_server">
   <code>m.identity_server</code>
  </h1>
</summary>
  <hr/>
<p>Persists the users preferred identity server, or preference to not use
an identity server at all, in the users account data.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>base_url</code></td>
  <td><code>string</code></td>
  <td>
    The URL of the identity server the user prefers to use, or <code>null</code>
if the user does not want to use an identity server. This value is
similar in structure to the <code>base_url</code> for identity servers in the
<code>.well-known/matrix/client</code> schema.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;base_url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://example.org&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.identity_server&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h2 id="capabilities-negotiation">Capabilities negotiation</h2>
<p>A homeserver may not support certain operations and clients must be able
to query for what the homeserver can and can&rsquo;t offer. For example, a
homeserver may not support users changing their password as it is
configured to perform authentication against an external system.</p>
<p>The capabilities advertised through this system are intended to
advertise functionality which is optional in the API, or which depend in
some way on the state of the user or server. This system should not be
used to advertise unstable or experimental features - this is better
done by the <code>/versions</code> endpoint.</p>
<p>Some examples of what a reasonable capability could be are:</p>
<ul>
<li>Whether the server supports user presence.</li>
<li>Whether the server supports optional features, such as the user or
room directories.</li>
<li>The rate limits or file type restrictions imposed on clients by the
server.</li>
</ul>
<p>Some examples of what should <strong>not</strong> be a capability are:</p>
<ul>
<li>Whether the server supports a feature in the <code>unstable</code>
specification.</li>
<li>Media size limits - these are handled by the
<a href="#get_matrixmediav3config"><code>/config</code></a> API.</li>
<li>Optional encodings or alternative transports for communicating with
the server.</li>
</ul>
<p>Capabilities prefixed with <code>m.</code> are reserved for definition in the
Matrix specification while other values may be used by servers using the
Java package naming convention. The capabilities supported by the Matrix
specification are defined later in this section.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3capabilities">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/capabilities</span>
  </h1>
</summary>
  <hr/>
<p>Gets information about the server&rsquo;s supported feature set
and other relevant capabilities.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<p>No request parameters or request body.</p>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The capabilities of the server.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>capabilities</code></td>
  <td><code>Capabilities</code></td>
  <td>
    <strong>Required: </strong>The custom capabilities the server supports, using the
Java package naming convention.</td>
 </tr>
</table>
<table id="_matrixclientv3capabilities_capabilities" class="object-table">
 <caption>Capabilities</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>m.change_password</code></td>
  <td><code>ChangePasswordCapability</code></td>
  <td>
    Capability to indicate if the user can change their password.</td>
 </tr>
 <tr>
  <td><code>m.room_versions</code></td>
  <td><code>RoomVersionsCapability</code></td>
  <td>
    The room versions the server supports.</td>
 </tr>
</table>
<table id="_matrixclientv3capabilities_changepasswordcapability" class="object-table">
 <caption>ChangePasswordCapability</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>enabled</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>True if the user can change their password, false otherwise.</td>
 </tr>
</table>
<table id="_matrixclientv3capabilities_roomversionscapability" class="object-table">
 <caption>RoomVersionsCapability</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>available</code></td>
  <td><code>{string: string}</code></td>
  <td>
    <strong>Required: </strong>A detailed description of the room versions the server supports.</td>
 </tr>
 <tr>
  <td><code>default</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The default room version the server is using for new rooms.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;capabilities&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;com.example.custom.ratelimit&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;max_requests_per_hour&#34;</span><span class="p">:</span> <span class="mi">600</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.change_password&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.room_versions&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;available&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;1&#34;</span><span class="p">:</span> <span class="s2">&#34;stable&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;2&#34;</span><span class="p">:</span> <span class="s2">&#34;stable&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;3&#34;</span><span class="p">:</span> <span class="s2">&#34;unstable&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;test-version&#34;</span><span class="p">:</span> <span class="s2">&#34;unstable&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3capabilities_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h3 id="mchange_password-capability"><code>m.change_password</code> capability</h3>
<p>This capability has a single flag, <code>enabled</code>, which indicates whether or
not the user can use the <code>/account/password</code> API to change their
password. If not present, the client should assume that password changes
are possible via the API. When present, clients SHOULD respect the
capability&rsquo;s <code>enabled</code> flag and indicate to the user if they are unable
to change their password.</p>
<p>An example of the capability API&rsquo;s response for this capability is:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;capabilities&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.change_password&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="mroom_versions-capability"><code>m.room_versions</code> capability</h3>
<p>This capability describes the default and available room versions a
server supports, and at what level of stability. Clients should make use
of this capability to determine if users need to be encouraged to
upgrade their rooms.</p>
<p>An example of the capability API&rsquo;s response for this capability is:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;capabilities&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.room_versions&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;available&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;1&#34;</span><span class="p">:</span> <span class="s2">&#34;stable&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;2&#34;</span><span class="p">:</span> <span class="s2">&#34;stable&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;3&#34;</span><span class="p">:</span> <span class="s2">&#34;unstable&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;custom-version&#34;</span><span class="p">:</span> <span class="s2">&#34;unstable&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This capability mirrors the same restrictions of <a href="/rooms">room
versions</a> to describe which versions are
stable and unstable. Clients should assume that the <code>default</code> version is
<code>stable</code>. Any version not explicitly labelled as <code>stable</code> in the
<code>available</code> versions is to be treated as <code>unstable</code>. For example, a
version listed as <code>future-stable</code> should be treated as <code>unstable</code>.</p>
<p>The <code>default</code> version is the version the server is using to create new
rooms. Clients should encourage users with sufficient permissions in a
room to upgrade their room to the <code>default</code> version when the room is
using an <code>unstable</code> version.</p>
<p>When this capability is not listed, clients should use <code>&quot;1&quot;</code> as the
default and only stable <code>available</code> room version.</p>
<h3 id="mset_displayname-capability"><code>m.set_displayname</code> capability</h3>
<p>This capability has a single flag, <code>enabled</code>, to denote whether the user
is able to change their own display name via profile endpoints. Cases for
disabling might include users mapped from external identity/directory
services, such as LDAP.</p>
<p>Note that this is well paired with the <code>m.set_avatar_url</code> capability.</p>
<p>When not listed, clients should assume the user is able to change their
display name.</p>
<p>An example of the capability API&rsquo;s response for this capability is:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;capabilities&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.set_displayname&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="mset_avatar_url-capability"><code>m.set_avatar_url</code> capability</h3>
<p>This capability has a single flag, <code>enabled</code>, to denote whether the user
is able to change their own avatar via profile endpoints. Cases for
disabling might include users mapped from external identity/directory
services, such as LDAP.</p>
<p>Note that this is well paired with the <code>m.set_displayname</code> capability.</p>
<p>When not listed, clients should assume the user is able to change their
avatar.</p>
<p>An example of the capability API&rsquo;s response for this capability is:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;capabilities&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.set_avatar_url&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="m3pid_changes-capability"><code>m.3pid_changes</code> capability</h3>
<p>This capability has a single flag, <code>enabled</code>, to denote whether the user
is able to add, remove, or change 3PID associations on their account. Note
that this only affects a user&rsquo;s ability to use the
<a href="#adding-account-administrative-contact-information">Admin Contact Information</a>
API, not endpoints exposed by an Identity Service. Cases for disabling
might include users mapped from external identity/directory  services,
such as LDAP.</p>
<p>When not listed, clients should assume the user is able to modify their 3PID
associations.</p>
<p>An example of the capability API&rsquo;s response for this capability is:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;capabilities&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.3pid_changes&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="filtering">Filtering</h2>
<p>Filters can be created on the server and can be passed as a parameter to
APIs which return events. These filters alter the data returned from
those APIs. Not all APIs accept filters.</p>
<h3 id="lazy-loading-room-members">Lazy-loading room members</h3>
<p>Membership events often take significant resources for clients to track.
In an effort to reduce the number of resources used, clients can enable
&ldquo;lazy-loading&rdquo; for room members. By doing this, servers will attempt to
only send membership events which are relevant to the client.</p>
<p>It is important to understand that lazy-loading is not intended to be a
perfect optimisation, and that it may not be practical for the server to
calculate precisely which membership events are relevant to the client.
As a result, it is valid for the server to send redundant membership
events to the client to ease implementation, although such redundancy
should be minimised where possible to conserve bandwidth.</p>
<p>In terms of filters, lazy-loading is enabled by enabling
<code>lazy_load_members</code> on a <code>RoomEventFilter</code> (or a <code>StateFilter</code> in the
case of <code>/sync</code> only). When enabled, lazy-loading aware endpoints (see
below) will only include membership events for the <code>sender</code> of events
being included in the response. For example, if a client makes a <code>/sync</code>
request with lazy-loading enabled, the server will only return
membership events for the <code>sender</code> of events in the timeline, not all
members of a room.</p>
<p>When processing a sequence of events (e.g. by looping on <code>/sync</code> or
paginating <code>/messages</code>), it is common for blocks of events in the
sequence to share a similar set of senders. Rather than responses in the
sequence sending duplicate membership events for these senders to the
client, the server MAY assume that clients will remember membership
events they have already been sent, and choose to skip sending
membership events for members whose membership has not changed. These
are called &lsquo;redundant membership events&rsquo;. Clients may request that
redundant membership events are always included in responses by setting
<code>include_redundant_members</code> to true in the filter.</p>
<p>The expected pattern for using lazy-loading is currently:</p>
<ul>
<li>Client performs an initial /sync with lazy-loading enabled, and
receives only the membership events which relate to the senders of
the events it receives.</li>
<li>Clients which support display-name tab-completion or other
operations which require rapid access to all members in a room
should call /members for the currently selected room, with an <code>?at</code>
parameter set to the /sync response&rsquo;s from token. The member list
for the room is then maintained by the state in subsequent
incremental /sync responses.</li>
<li>Clients which do not support tab-completion may instead pull in
profiles for arbitrary users (e.g. read receipts, typing
notifications) on demand by querying the room state or <code>/profile</code>.</li>
</ul>
<p>The current endpoints which support lazy-loading room members are:</p>
<ul>
<li><a href="/client-server-api/#get_matrixclientv3sync"><code>/sync</code></a></li>
<li><a href="/client-server-api/#get_matrixclientv3roomsroomidmessages"><code>/rooms/&lt;room_id&gt;/messages</code></a></li>
<li><a href="/client-server-api/#get_matrixclientv3roomsroomidcontexteventid"><code>/rooms/{roomId}/context/{eventId}</code></a></li>
</ul>
<h3 id="api-endpoints">API endpoints</h3>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3useruseridfilter">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/user/{userId}/filter</span>
  </h1>
</summary>
  <hr/>
<p>Uploads a new filter definition to the homeserver.
Returns a filter ID that may be used in future requests to
restrict which events are returned to the client.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>userId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The id of the user uploading the filter. The access token must be authorized to make requests for this user id.</td>
 </tr>
</table>
<h3>Request body</h3>
<table id="_matrixclientv3useruseridfilter_filter" class="object-table">
 <caption>Filter</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>account_data</code></td>
  <td><code>EventFilter</code></td>
  <td>
    The user account data that isn&rsquo;t associated with rooms to include.</td>
 </tr>
 <tr>
  <td><code>event_fields</code></td>
  <td><code>[string]</code></td>
  <td>
    List of event fields to include. If this list is absent then all fields are included. The entries are <a href="/appendices#dot-separated-property-paths">dot-separated paths for each property</a> to include. So [&lsquo;content.body&rsquo;] will include the &lsquo;body&rsquo; field of the &lsquo;content&rsquo; object. A server may include more fields than were requested.</td>
 </tr>
 <tr>
  <td><code>event_format</code></td>
  <td><code>string</code></td>
  <td>
    The format to use for events. &lsquo;client&rsquo; will return the events in a format suitable for clients. &lsquo;federation&rsquo; will return the raw event as received over federation. The default is &lsquo;client&rsquo;.<p>One of: <code>[client, federation]</code>.</p></td>
 </tr>
 <tr>
  <td><code>presence</code></td>
  <td><code>EventFilter</code></td>
  <td>
    The presence updates to include.</td>
 </tr>
 <tr>
  <td><code>room</code></td>
  <td><code>RoomFilter</code></td>
  <td>
    Filters to be applied to room data.</td>
 </tr>
</table>
<table id="_matrixclientv3useruseridfilter_eventfilter" class="object-table">
 <caption>EventFilter</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>limit</code></td>
  <td><code>integer</code></td>
  <td>
    <p>The maximum number of events to return, must be an integer greater than 0.</p>
<p>Servers should apply a default value, and impose a maximum value to avoid
resource exhaustion.</p>
</td>
 </tr>
 <tr>
  <td><code>not_senders</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of sender IDs to exclude. If this list is absent then no senders are excluded. A matching sender will be excluded even if it is listed in the <code>'senders'</code> filter.</td>
 </tr>
 <tr>
  <td><code>not_types</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of event types to exclude. If this list is absent then no event types are excluded. A matching type will be excluded even if it is listed in the <code>'types'</code> filter. A &lsquo;*&rsquo; can be used as a wildcard to match any sequence of characters.</td>
 </tr>
 <tr>
  <td><code>senders</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of senders IDs to include. If this list is absent then all senders are included.</td>
 </tr>
 <tr>
  <td><code>types</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of event types to include. If this list is absent then all event types are included. A <code>'*'</code> can be used as a wildcard to match any sequence of characters.</td>
 </tr>
</table>
<table id="_matrixclientv3useruseridfilter_roomfilter" class="object-table">
 <caption>RoomFilter</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>account_data</code></td>
  <td><code>RoomEventFilter</code></td>
  <td>
    The per user account data to include for rooms.</td>
 </tr>
 <tr>
  <td><code>ephemeral</code></td>
  <td><code>RoomEventFilter</code></td>
  <td>
    The ephemeral events to include for rooms. These are the events that appear in the <code>ephemeral</code> property in the <code>/sync</code> response.</td>
 </tr>
 <tr>
  <td><code>include_leave</code></td>
  <td><code>boolean</code></td>
  <td>
    Include rooms that the user has left in the sync, default false</td>
 </tr>
 <tr>
  <td><code>not_rooms</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of room IDs to exclude. If this list is absent then no rooms are excluded. A matching room will be excluded even if it is listed in the <code>'rooms'</code> filter. This filter is applied before the filters in <code>ephemeral</code>, <code>state</code>, <code>timeline</code> or <code>account_data</code></td>
 </tr>
 <tr>
  <td><code>rooms</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of room IDs to include. If this list is absent then all rooms are included. This filter is applied before the filters in <code>ephemeral</code>, <code>state</code>, <code>timeline</code> or <code>account_data</code></td>
 </tr>
 <tr>
  <td><code>state</code></td>
  <td><code>StateFilter</code></td>
  <td>
    The state events to include for rooms.</td>
 </tr>
 <tr>
  <td><code>timeline</code></td>
  <td><code>RoomEventFilter</code></td>
  <td>
    The message and state update events to include for rooms.</td>
 </tr>
</table>
<table id="_matrixclientv3useruseridfilter_roomeventfilter" class="object-table">
 <caption>RoomEventFilter</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>contains_url</code></td>
  <td><code>boolean</code></td>
  <td>
    If <code>true</code>, includes only events with a <code>url</code> key in their content. If <code>false</code>, excludes those events. If omitted, <code>url</code> key is not considered for filtering.</td>
 </tr>
 <tr>
  <td><code>include_redundant_members</code></td>
  <td><code>boolean</code></td>
  <td>
    If <code>true</code>, sends all membership events for all events, even if they have already
been sent to the client. Does not
apply unless <code>lazy_load_members</code> is <code>true</code>. See
<a href="/client-server-api/#lazy-loading-room-members">Lazy-loading room members</a>
for more information. Defaults to <code>false</code>.</td>
 </tr>
 <tr>
  <td><code>lazy_load_members</code></td>
  <td><code>boolean</code></td>
  <td>
    If <code>true</code>, enables lazy-loading of membership events. See
<a href="/client-server-api/#lazy-loading-room-members">Lazy-loading room members</a>
for more information. Defaults to <code>false</code>.</td>
 </tr>
 <tr>
  <td><code>limit</code></td>
  <td><code>integer</code></td>
  <td>
    <p>The maximum number of events to return, must be an integer greater than 0.</p>
<p>Servers should apply a default value, and impose a maximum value to avoid
resource exhaustion.</p>
</td>
 </tr>
 <tr>
  <td><code>not_rooms</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of room IDs to exclude. If this list is absent then no rooms are excluded. A matching room will be excluded even if it is listed in the <code>'rooms'</code> filter.</td>
 </tr>
 <tr>
  <td><code>not_senders</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of sender IDs to exclude. If this list is absent then no senders are excluded. A matching sender will be excluded even if it is listed in the <code>'senders'</code> filter.</td>
 </tr>
 <tr>
  <td><code>not_types</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of event types to exclude. If this list is absent then no event types are excluded. A matching type will be excluded even if it is listed in the <code>'types'</code> filter. A &lsquo;*&rsquo; can be used as a wildcard to match any sequence of characters.</td>
 </tr>
 <tr>
  <td><code>rooms</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of room IDs to include. If this list is absent then all rooms are included.</td>
 </tr>
 <tr>
  <td><code>senders</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of senders IDs to include. If this list is absent then all senders are included.</td>
 </tr>
 <tr>
  <td><code>types</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of event types to include. If this list is absent then all event types are included. A <code>'*'</code> can be used as a wildcard to match any sequence of characters.</td>
 </tr>
 <tr>
  <td><code>unread_thread_notifications</code></td>
  <td><code>boolean</code></td>
  <td>
    If <code>true</code>, enables per-<a href="/client-server-api/#threading">thread</a> notification
counts. Only applies to the <code>/sync</code> endpoint. Defaults to <code>false</code>.
<p><strong>Added in <code>v1.4</code></strong></p>
</td>
 </tr>
</table>
<table id="_matrixclientv3useruseridfilter_statefilter" class="object-table">
 <caption>StateFilter</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>contains_url</code></td>
  <td><code>boolean</code></td>
  <td>
    If <code>true</code>, includes only events with a <code>url</code> key in their content. If <code>false</code>, excludes those events. If omitted, <code>url</code> key is not considered for filtering.</td>
 </tr>
 <tr>
  <td><code>include_redundant_members</code></td>
  <td><code>boolean</code></td>
  <td>
    If <code>true</code>, sends all membership events for all events, even if they have already
been sent to the client. Does not
apply unless <code>lazy_load_members</code> is <code>true</code>. See
<a href="/client-server-api/#lazy-loading-room-members">Lazy-loading room members</a>
for more information. Defaults to <code>false</code>.</td>
 </tr>
 <tr>
  <td><code>lazy_load_members</code></td>
  <td><code>boolean</code></td>
  <td>
    If <code>true</code>, enables lazy-loading of membership events. See
<a href="/client-server-api/#lazy-loading-room-members">Lazy-loading room members</a>
for more information. Defaults to <code>false</code>.</td>
 </tr>
 <tr>
  <td><code>limit</code></td>
  <td><code>integer</code></td>
  <td>
    <p>The maximum number of events to return, must be an integer greater than 0.</p>
<p>Servers should apply a default value, and impose a maximum value to avoid
resource exhaustion.</p>
</td>
 </tr>
 <tr>
  <td><code>not_rooms</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of room IDs to exclude. If this list is absent then no rooms are excluded. A matching room will be excluded even if it is listed in the <code>'rooms'</code> filter.</td>
 </tr>
 <tr>
  <td><code>not_senders</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of sender IDs to exclude. If this list is absent then no senders are excluded. A matching sender will be excluded even if it is listed in the <code>'senders'</code> filter.</td>
 </tr>
 <tr>
  <td><code>not_types</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of event types to exclude. If this list is absent then no event types are excluded. A matching type will be excluded even if it is listed in the <code>'types'</code> filter. A &lsquo;*&rsquo; can be used as a wildcard to match any sequence of characters.</td>
 </tr>
 <tr>
  <td><code>rooms</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of room IDs to include. If this list is absent then all rooms are included.</td>
 </tr>
 <tr>
  <td><code>senders</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of senders IDs to include. If this list is absent then all senders are included.</td>
 </tr>
 <tr>
  <td><code>types</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of event types to include. If this list is absent then all event types are included. A <code>'*'</code> can be used as a wildcard to match any sequence of characters.</td>
 </tr>
 <tr>
  <td><code>unread_thread_notifications</code></td>
  <td><code>boolean</code></td>
  <td>
    If <code>true</code>, enables per-<a href="/client-server-api/#threading">thread</a> notification
counts. Only applies to the <code>/sync</code> endpoint. Defaults to <code>false</code>.
<p><strong>Added in <code>v1.4</code></strong></p>
</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_fields&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;type&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;content&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;sender&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_format&#34;</span><span class="p">:</span> <span class="s2">&#34;client&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;presence&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;not_senders&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;@alice:example.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;types&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;m.presence&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ephemeral&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;not_rooms&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;!726s6s6q:example.com&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;not_senders&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;@spam:example.com&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;types&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;m.receipt&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;m.typing&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;state&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;not_rooms&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;!726s6s6q:example.com&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;types&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;m.room.*&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;timeline&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;limit&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;not_rooms&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;!726s6s6q:example.com&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;not_senders&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;@spam:example.com&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;types&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;m.room.message&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The filter was created.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>filter_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the filter that was created. Cannot start
with a <code>{</code> as this character is used to determine
if the filter provided is inline JSON or a previously
declared filter by homeservers on some APIs.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;filter_id&#34;</span><span class="p">:</span> <span class="s2">&#34;66696p746572&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3useruseridfilterfilterid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/user/{userId}/filter/{filterId}</span>
  </h1>
</summary>
  <hr/>
<p></p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>filterId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The filter ID to download.</td>
 </tr>
 <tr>
  <td><code>userId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID to download a filter for.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The filter definition.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>Unknown filter.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="_matrixclientv3useruseridfilterfilterid_filter" class="object-table">
 <caption>Filter</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>account_data</code></td>
  <td><code>EventFilter</code></td>
  <td>
    The user account data that isn&rsquo;t associated with rooms to include.</td>
 </tr>
 <tr>
  <td><code>event_fields</code></td>
  <td><code>[string]</code></td>
  <td>
    List of event fields to include. If this list is absent then all fields are included. The entries are <a href="/appendices#dot-separated-property-paths">dot-separated paths for each property</a> to include. So [&lsquo;content.body&rsquo;] will include the &lsquo;body&rsquo; field of the &lsquo;content&rsquo; object. A server may include more fields than were requested.</td>
 </tr>
 <tr>
  <td><code>event_format</code></td>
  <td><code>string</code></td>
  <td>
    The format to use for events. &lsquo;client&rsquo; will return the events in a format suitable for clients. &lsquo;federation&rsquo; will return the raw event as received over federation. The default is &lsquo;client&rsquo;.<p>One of: <code>[client, federation]</code>.</p></td>
 </tr>
 <tr>
  <td><code>presence</code></td>
  <td><code>EventFilter</code></td>
  <td>
    The presence updates to include.</td>
 </tr>
 <tr>
  <td><code>room</code></td>
  <td><code>RoomFilter</code></td>
  <td>
    Filters to be applied to room data.</td>
 </tr>
</table>
<table id="_matrixclientv3useruseridfilterfilterid_eventfilter" class="object-table">
 <caption>EventFilter</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>limit</code></td>
  <td><code>integer</code></td>
  <td>
    <p>The maximum number of events to return, must be an integer greater than 0.</p>
<p>Servers should apply a default value, and impose a maximum value to avoid
resource exhaustion.</p>
</td>
 </tr>
 <tr>
  <td><code>not_senders</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of sender IDs to exclude. If this list is absent then no senders are excluded. A matching sender will be excluded even if it is listed in the <code>'senders'</code> filter.</td>
 </tr>
 <tr>
  <td><code>not_types</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of event types to exclude. If this list is absent then no event types are excluded. A matching type will be excluded even if it is listed in the <code>'types'</code> filter. A &lsquo;*&rsquo; can be used as a wildcard to match any sequence of characters.</td>
 </tr>
 <tr>
  <td><code>senders</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of senders IDs to include. If this list is absent then all senders are included.</td>
 </tr>
 <tr>
  <td><code>types</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of event types to include. If this list is absent then all event types are included. A <code>'*'</code> can be used as a wildcard to match any sequence of characters.</td>
 </tr>
</table>
<table id="_matrixclientv3useruseridfilterfilterid_roomfilter" class="object-table">
 <caption>RoomFilter</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>account_data</code></td>
  <td><code>RoomEventFilter</code></td>
  <td>
    The per user account data to include for rooms.</td>
 </tr>
 <tr>
  <td><code>ephemeral</code></td>
  <td><code>RoomEventFilter</code></td>
  <td>
    The ephemeral events to include for rooms. These are the events that appear in the <code>ephemeral</code> property in the <code>/sync</code> response.</td>
 </tr>
 <tr>
  <td><code>include_leave</code></td>
  <td><code>boolean</code></td>
  <td>
    Include rooms that the user has left in the sync, default false</td>
 </tr>
 <tr>
  <td><code>not_rooms</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of room IDs to exclude. If this list is absent then no rooms are excluded. A matching room will be excluded even if it is listed in the <code>'rooms'</code> filter. This filter is applied before the filters in <code>ephemeral</code>, <code>state</code>, <code>timeline</code> or <code>account_data</code></td>
 </tr>
 <tr>
  <td><code>rooms</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of room IDs to include. If this list is absent then all rooms are included. This filter is applied before the filters in <code>ephemeral</code>, <code>state</code>, <code>timeline</code> or <code>account_data</code></td>
 </tr>
 <tr>
  <td><code>state</code></td>
  <td><code>StateFilter</code></td>
  <td>
    The state events to include for rooms.</td>
 </tr>
 <tr>
  <td><code>timeline</code></td>
  <td><code>RoomEventFilter</code></td>
  <td>
    The message and state update events to include for rooms.</td>
 </tr>
</table>
<table id="_matrixclientv3useruseridfilterfilterid_roomeventfilter" class="object-table">
 <caption>RoomEventFilter</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>contains_url</code></td>
  <td><code>boolean</code></td>
  <td>
    If <code>true</code>, includes only events with a <code>url</code> key in their content. If <code>false</code>, excludes those events. If omitted, <code>url</code> key is not considered for filtering.</td>
 </tr>
 <tr>
  <td><code>include_redundant_members</code></td>
  <td><code>boolean</code></td>
  <td>
    If <code>true</code>, sends all membership events for all events, even if they have already
been sent to the client. Does not
apply unless <code>lazy_load_members</code> is <code>true</code>. See
<a href="/client-server-api/#lazy-loading-room-members">Lazy-loading room members</a>
for more information. Defaults to <code>false</code>.</td>
 </tr>
 <tr>
  <td><code>lazy_load_members</code></td>
  <td><code>boolean</code></td>
  <td>
    If <code>true</code>, enables lazy-loading of membership events. See
<a href="/client-server-api/#lazy-loading-room-members">Lazy-loading room members</a>
for more information. Defaults to <code>false</code>.</td>
 </tr>
 <tr>
  <td><code>limit</code></td>
  <td><code>integer</code></td>
  <td>
    <p>The maximum number of events to return, must be an integer greater than 0.</p>
<p>Servers should apply a default value, and impose a maximum value to avoid
resource exhaustion.</p>
</td>
 </tr>
 <tr>
  <td><code>not_rooms</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of room IDs to exclude. If this list is absent then no rooms are excluded. A matching room will be excluded even if it is listed in the <code>'rooms'</code> filter.</td>
 </tr>
 <tr>
  <td><code>not_senders</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of sender IDs to exclude. If this list is absent then no senders are excluded. A matching sender will be excluded even if it is listed in the <code>'senders'</code> filter.</td>
 </tr>
 <tr>
  <td><code>not_types</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of event types to exclude. If this list is absent then no event types are excluded. A matching type will be excluded even if it is listed in the <code>'types'</code> filter. A &lsquo;*&rsquo; can be used as a wildcard to match any sequence of characters.</td>
 </tr>
 <tr>
  <td><code>rooms</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of room IDs to include. If this list is absent then all rooms are included.</td>
 </tr>
 <tr>
  <td><code>senders</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of senders IDs to include. If this list is absent then all senders are included.</td>
 </tr>
 <tr>
  <td><code>types</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of event types to include. If this list is absent then all event types are included. A <code>'*'</code> can be used as a wildcard to match any sequence of characters.</td>
 </tr>
 <tr>
  <td><code>unread_thread_notifications</code></td>
  <td><code>boolean</code></td>
  <td>
    If <code>true</code>, enables per-<a href="/client-server-api/#threading">thread</a> notification
counts. Only applies to the <code>/sync</code> endpoint. Defaults to <code>false</code>.
<p><strong>Added in <code>v1.4</code></strong></p>
</td>
 </tr>
</table>
<table id="_matrixclientv3useruseridfilterfilterid_statefilter" class="object-table">
 <caption>StateFilter</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>contains_url</code></td>
  <td><code>boolean</code></td>
  <td>
    If <code>true</code>, includes only events with a <code>url</code> key in their content. If <code>false</code>, excludes those events. If omitted, <code>url</code> key is not considered for filtering.</td>
 </tr>
 <tr>
  <td><code>include_redundant_members</code></td>
  <td><code>boolean</code></td>
  <td>
    If <code>true</code>, sends all membership events for all events, even if they have already
been sent to the client. Does not
apply unless <code>lazy_load_members</code> is <code>true</code>. See
<a href="/client-server-api/#lazy-loading-room-members">Lazy-loading room members</a>
for more information. Defaults to <code>false</code>.</td>
 </tr>
 <tr>
  <td><code>lazy_load_members</code></td>
  <td><code>boolean</code></td>
  <td>
    If <code>true</code>, enables lazy-loading of membership events. See
<a href="/client-server-api/#lazy-loading-room-members">Lazy-loading room members</a>
for more information. Defaults to <code>false</code>.</td>
 </tr>
 <tr>
  <td><code>limit</code></td>
  <td><code>integer</code></td>
  <td>
    <p>The maximum number of events to return, must be an integer greater than 0.</p>
<p>Servers should apply a default value, and impose a maximum value to avoid
resource exhaustion.</p>
</td>
 </tr>
 <tr>
  <td><code>not_rooms</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of room IDs to exclude. If this list is absent then no rooms are excluded. A matching room will be excluded even if it is listed in the <code>'rooms'</code> filter.</td>
 </tr>
 <tr>
  <td><code>not_senders</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of sender IDs to exclude. If this list is absent then no senders are excluded. A matching sender will be excluded even if it is listed in the <code>'senders'</code> filter.</td>
 </tr>
 <tr>
  <td><code>not_types</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of event types to exclude. If this list is absent then no event types are excluded. A matching type will be excluded even if it is listed in the <code>'types'</code> filter. A &lsquo;*&rsquo; can be used as a wildcard to match any sequence of characters.</td>
 </tr>
 <tr>
  <td><code>rooms</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of room IDs to include. If this list is absent then all rooms are included.</td>
 </tr>
 <tr>
  <td><code>senders</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of senders IDs to include. If this list is absent then all senders are included.</td>
 </tr>
 <tr>
  <td><code>types</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of event types to include. If this list is absent then all event types are included. A <code>'*'</code> can be used as a wildcard to match any sequence of characters.</td>
 </tr>
 <tr>
  <td><code>unread_thread_notifications</code></td>
  <td><code>boolean</code></td>
  <td>
    If <code>true</code>, enables per-<a href="/client-server-api/#threading">thread</a> notification
counts. Only applies to the <code>/sync</code> endpoint. Defaults to <code>false</code>.
<p><strong>Added in <code>v1.4</code></strong></p>
</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_fields&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;type&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;content&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;sender&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_format&#34;</span><span class="p">:</span> <span class="s2">&#34;client&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;presence&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;not_senders&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;@alice:example.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;types&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;m.presence&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ephemeral&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;not_rooms&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;!726s6s6q:example.com&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;not_senders&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;@spam:example.com&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;types&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;m.receipt&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;m.typing&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;state&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;not_rooms&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;!726s6s6q:example.com&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;types&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;m.room.*&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;timeline&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;limit&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;not_rooms&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;!726s6s6q:example.com&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;not_senders&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;@spam:example.com&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;types&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;m.room.message&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h2 id="events">Events</h2>
<p>The model of conversation history exposed by the client-server API can
be considered as a list of events. The server &rsquo;linearises&rsquo; the
eventually-consistent event graph of events into an &rsquo;event stream&rsquo; at
any given point in time:</p>
<pre><code>[E0]-&gt;[E1]-&gt;[E2]-&gt;[E3]-&gt;[E4]-&gt;[E5]
</code></pre>
<h3 id="types-of-room-events">Types of room events</h3>
<p>Room events are split into two categories:</p>
<ul>
<li>
<p><strong>State events</strong>: These are events which update the metadata state of the room (e.g. room
topic, room membership etc). State is keyed by a tuple of event <code>type</code>
and a <code>state_key</code>. State in the room with the same key-tuple will be
overwritten.</p>
</li>
<li>
<p><strong>Message events</strong>: These are events which describe transient &ldquo;once-off&rdquo; activity in a room:
typically communication such as sending an instant message or setting up
a VoIP call.</p>
</li>
</ul>
<p>This specification outlines several events, all with the event type
prefix <code>m.</code>. (See <a href="#room-events">Room Events</a> for the m. event
specification.) However, applications may wish to add their own type of
event, and this can be achieved using the REST API detailed in the
following sections. If new events are added, the event <code>type</code> key SHOULD
follow the Java package naming convention, e.g.
<code>com.example.myapp.event</code>. This ensures event types are suitably
namespaced for each application and reduces the risk of clashes.</p>
<div class="alert note " role="alert">
Events are not limited to the types defined in this specification. New
or custom event types can be created on a whim using the Java package
naming convention. For example, a <code>com.example.game.score</code> event can be
sent by clients and other clients would receive it through Matrix,
assuming the client has access to the <code>com.example</code> namespace.
</div>
<h3 id="room-event-format">Room event format</h3>
<p>The &ldquo;federation&rdquo; format of a room event, which is used internally by homeservers
and between homeservers via the Server-Server API, depends on the <a href="/rooms">&ldquo;room
version&rdquo;</a> in use by the room. See, for example, the definitions
in <a href="/rooms/v1#event-format">room version 1</a> and <a href="/rooms/v3#event-format">room version
3</a>.</p>
<p>However, it is unusual that a Matrix client would encounter this event
format. Instead, homeservers are responsible for converting events into the
format shown below so that they can be easily parsed by clients.</p>
<div class="alert warning " role="alert">
<p>Event bodies are considered untrusted data. This means that any application using
Matrix must validate that the event body is of the expected shape/schema
before using the contents verbatim.</p>
<p><strong>It is not safe to assume that an event body will have all the expected
fields of the expected types.</strong></p>
<p>See <a href="https://github.com/matrix-org/matrix-spec-proposals/pull/2801">MSC2801</a> for more
detail on why this assumption is unsafe.</p>
</div>
<section class="rendered-data definition" id="definition-clientevent">
<details open>
<summary>
<h1>
 <code>ClientEvent</code>
</h1>
</summary>
<hr/>
<p>The format used for events when they are returned from a homeserver to a client
via the Client-Server API, or sent to an Application Service via the Application Services API.</p>
<table class="object-table">
 <caption>ClientEvent</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The body of this event, as created by the client which sent it.</td>
 </tr>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The globally unique identifier for this event.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>Timestamp (in milliseconds since the unix epoch) on originating homeserver
when this event was sent.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room associated with this event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Contains the fully-qualified ID of the user who sent this event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <p>Present if, and only if, this event is a <em>state</em> event. The key making
this piece of state unique in the room. Note that it is often an empty
string.</p>
<p>State keys starting with an <code>@</code> are reserved for referencing user IDs, such
as room members. With the exception of a few events, state events set with a
given user&rsquo;s ID as the state key MUST only be set by that user.</p>
</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of the event.</td>
 </tr>
 <tr>
  <td><code>unsigned</code></td>
  <td><code>UnsignedData</code></td>
  <td>
    Contains optional extra information about the event.</td>
 </tr>
</table>
<table class="object-table">
 <caption>UnsignedData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>age</code></td>
  <td><code>integer</code></td>
  <td>
    The time in milliseconds that has elapsed since the event was sent. This field is generated by the local homeserver, and may be incorrect if the local time on at least one of the two servers is out of sync, which can cause the age to either be negative or greater than it actually is.</td>
 </tr>
 <tr>
  <td><code>prev_content</code></td>
  <td><code>EventContent</code></td>
  <td>
    The previous <code>content</code> for this event. This field is generated
by the local homeserver, and is only returned if the event is a state event,
and the client has permission to see the previous content.<br><br>
    <strong>
      Changed in <code>v1.2</code>:
    </strong>
    Previously, this field was specified at the top level of returned
events rather than in <code>unsigned</code> (with the exception of the <a href="/client-server-api/#get_matrixclientv3notifications"><code>GET .../notifications</code></a>
endpoint), though in practice no known server implementations honoured
this.
</td>
 </tr>
 <tr>
  <td><code>redacted_because</code></td>
  <td><code>ClientEvent</code></td>
  <td>
    The event that redacted this event, if any.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    The client-supplied <a href="/client-server-api/#transaction-identifiers">transaction ID</a>, for example, provided via
<code>PUT /_matrix/client/v3/rooms/{roomId}/send/{eventType}/{txnId}</code>,
if the client being given the event is the same one which sent it.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;join&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$26RqwJMLw-yds1GAH_QxjHRC1Da9oasK0e5VLnck_45&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1632489532305</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@user:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1567437</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;redacted_because&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;spam&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$Nhl3rsgHMjk-DjMJANawr9HHAhLg4GcoTYrSiYYGqEE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1632491098485</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;redacts&#34;</span><span class="p">:</span> <span class="s2">&#34;$26RqwJMLw-yds1GAH_QxjHRC1Da9oasK0e5VLnck_45&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@moderator:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.redaction&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1257</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h3 id="stripped-state">Stripped state</h3>
<p>Stripped state is a simplified view of the state of a room intended to help a
potential joiner identify the room. It consists of a limited set of state events
that are themselves simplified to reduce the amount of data required.</p>
<p>Stripped state events can only have the <code>sender</code>, <code>type</code>, <code>state_key</code> and
<code>content</code> properties present.</p>
<p>Stripped state typically appears in invites, knocks, and in other places where a
user <em>could</em> join the room under the conditions available (such as a
<a href="#restricted-rooms"><code>restricted</code> room</a>).</p>
<p>Clients should only use stripped state events when they don&rsquo;t have
access to the proper state of the room. Once the state of the room is
available, all stripped state should be discarded. In cases where the
client has an archived state of the room (such as after being kicked)
and the client is receiving stripped state for the room, such as from an
invite or knock, then the stripped state should take precedence until
fresh state can be acquired from a join.</p>
<p>Stripped state should contain some or all of the following state events, which
should be represented as stripped state events when possible:</p>
<ul>
<li><a href="#mroomcreate"><code>m.room.create</code></a></li>
<li><a href="#mroomname"><code>m.room.name</code></a></li>
<li><a href="#mroomavatar"><code>m.room.avatar</code></a></li>
<li><a href="#mroomtopic"><code>m.room.topic</code></a></li>
<li><a href="#mroomjoin_rules"><code>m.room.join_rules</code></a></li>
<li><a href="#mroomcanonical_alias"><code>m.room.canonical_alias</code></a></li>
<li><a href="#mroomencryption"><code>m.room.encryption</code></a></li>
</ul>
<div class="alert note " role="alert">
Clients should inspect the list of stripped state events and not assume any
particular event is present. The server might include events not described
here as well.
</div>
<div class="alert rationale " role="alert">
<p>The name, avatar, topic, and aliases are presented as aesthetic information
about the room, allowing users to make decisions about whether or not they
want to join the room.</p>
<p>The join rules are given to help the client determine <em>why</em> it is able to
potentially join. For example, annotating the room decoration with iconography
consistent with the respective join rule for the room.</p>
<p>The create event can help identify what kind of room is being joined, as it
may be a Space or other kind of room. The client might choose to render the
invite in a different area of the application as a result.</p>
<p>Similar to join rules, the encryption information is given to help clients
decorate the room with appropriate iconography or messaging.</p>
</div>
<div class="alert warning " role="alert">
Although stripped state is usually generated and provided by the server, it
is still possible to be incorrect on the receiving end. The stripped state
events are not signed and could theoretically be modified, or outdated due to
updates not being sent.
</div>
<section class="rendered-data event">
<details open>
<summary>
<h1>
 <code>Stripped state event</code>
</h1>
</summary>
<hr/>
<p>A stripped down state event, with only the <code>type</code>, <code>state_key</code>,
<code>sender</code>, and <code>content</code> keys.</p>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>EventContent</code></td>
  <td>
    <strong>Required: </strong>The <code>content</code> for the event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>sender</code> for the event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>state_key</code> for the event.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>type</code> for the event.</td>
 </tr>
</table>
</details>
</section>
<h3 id="size-limits">Size limits</h3>
<p>The complete event MUST NOT be larger than 65536 bytes, when formatted
with the <a href="#room-event-format">federation event format</a>, including any
signatures, and encoded as <a href="/appendices#canonical-json">Canonical
JSON</a>.</p>
<p>There are additional restrictions on sizes per key:</p>
<ul>
<li><code>sender</code> MUST NOT exceed 255 bytes (including domain).</li>
<li><code>room_id</code> MUST NOT exceed 255 bytes.</li>
<li><code>state_key</code> MUST NOT exceed 255 bytes.</li>
<li><code>type</code> MUST NOT exceed 255 bytes.</li>
<li><code>event_id</code> MUST NOT exceed 255 bytes.</li>
</ul>
<p>Some event types have additional size restrictions which are specified
in the description of the event. Additional keys have no limit other
than that implied by the total 64 KiB limit on events.</p>
<h3 id="room-events">Room Events</h3>
<div class="alert note " role="alert">
This section is a work in progress.
</div>
<p>This specification outlines several standard event types, all of which
are prefixed with <code>m.</code></p>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mroomcanonical_alias">
   <code>m.room.canonical_alias</code>
  </h1>
</summary>
  <hr/>
<p>This event is used to inform the room about which alias should be
considered the canonical one, and which other aliases point to the room.
This could be for display purposes or as suggestion to users which alias
to use to advertise and access the room.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>State event</td>
  </tr>
  <tr>
   <th>State key</th>
   <td>A zero-length string.</td>
 </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>alias</code></td>
  <td><code>string</code></td>
  <td>
    The canonical alias for the room. If not present, null, or empty the
room should be considered to have no canonical alias.</td>
 </tr>
 <tr>
  <td><code>alt_aliases</code></td>
  <td><code>[string]</code></td>
  <td>
    Alternative aliases the room advertises. This list can have aliases
despite the <code>alias</code> field being null, empty, or otherwise not present.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;alias&#34;</span><span class="p">:</span> <span class="s2">&#34;#somewhere:localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;alt_aliases&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;#somewhere:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;#myroom:example.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.canonical_alias&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mroomcreate">
   <code>m.room.create</code>
  </h1>
</summary>
  <hr/>
<p>This is the first event in a room and cannot be changed. It acts as the root of all other events.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>State event</td>
  </tr>
  <tr>
   <th>State key</th>
   <td>A zero-length string.</td>
 </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>creator</code></td>
  <td><code>string</code></td>
  <td>
    The <code>user_id</code> of the room creator. <strong>Required</strong> for, and only present in, room versions 1 - 10. Starting with
room version 11 the event <code>sender</code> should be used instead.</td>
 </tr>
 <tr>
  <td><code>m.federate</code></td>
  <td><code>boolean</code></td>
  <td>
    Whether users on other servers can join this room. Defaults to <code>true</code> if key does not exist.</td>
 </tr>
 <tr>
  <td><code>predecessor</code></td>
  <td><code>Previous Room</code></td>
  <td>
    A reference to the room this room replaces, if the previous room was upgraded.</td>
 </tr>
 <tr>
  <td><code>room_version</code></td>
  <td><code>string</code></td>
  <td>
    The version of the room. Defaults to <code>&quot;1&quot;</code> if the key does not exist.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <p>Optional <a href="#types">room type</a> to denote a room&rsquo;s intended function outside of traditional conversation.</p>
<p>Unspecified room types are possible using <a href="/appendices/#common-namespaced-identifier-grammar">Namespaced Identifiers</a>.</p>
</td>
 </tr>
</table>
<table id="mroomcreate_previous-room" class="object-table">
 <caption>Previous Room</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The event ID of the last known event in the old room.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the old room.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.federate&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;predecessor&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$something:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!oldroom:example.org&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;room_version&#34;</span><span class="p">:</span> <span class="s2">&#34;11&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.create&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mroomjoin_rules">
   <code>m.room.join_rules</code>
  </h1>
</summary>
  <hr/>
<p>A room may have one of the following designations:</p>
<ul>
<li><code>public</code> - anyone can join the room without any prior action.</li>
<li><code>invite</code> - a user must first receive an invite from someone already in the room
in order to join.</li>
<li><code>knock</code> - a user can request an invite to the room. They can be allowed (invited)
or denied (kicked/banned) access. Otherwise, users need to be invited in. Only
available in rooms <a href="/rooms/#feature-matrix">which support knocking</a>.</li>
<li><code>restricted</code> - anyone able to satisfy at least one of the allow conditions is
able to join the room without prior action. Otherwise, an invite is required.
Only available in rooms <a href="/rooms/#feature-matrix">which support the join rule</a>.</li>
<li><code>knock_restricted</code> - a user can request an invite using the same functions offered
by the <code>knock</code> join rule, or can attempt to join having satisfied an allow condition
per the <code>restricted</code> join rule. Only available in rooms
<a href="/rooms/#feature-matrix">which support the join rule</a>.</li>
<li><code>private</code> - reserved without implementation. No significant meaning.</li>
</ul>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>State event</td>
  </tr>
  <tr>
   <th>State key</th>
   <td>A zero-length string.</td>
 </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>allow</code></td>
  <td><code>[AllowCondition]</code></td>
  <td>
    For <code>restricted</code> rooms, the conditions the user will be tested against. The
user needs only to satisfy one of the conditions to join the <code>restricted</code>
room. If the user fails to meet any condition, or the condition is unable
to be confirmed as satisfied, then the user requires an invite to join the
room. Improper or no <code>allow</code> conditions on a <code>restricted</code> join rule imply
the room is effectively invite-only (no conditions can be satisfied).
<p><strong>Added in <code>v1.2</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>join_rule</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of rules used for users wishing to join this room.<p>One of: <code>[public, knock, invite, private, restricted, knock_restricted]</code>.</p></td>
 </tr>
</table>
<table id="mroomjoin_rules_allowcondition" class="object-table">
 <caption>AllowCondition</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    Required if <code>type</code> is <code>m.room_membership</code>. The room ID to check the
user&rsquo;s membership against. If the user is joined to this room, they
satisfy the condition and thus are permitted to join the <code>restricted</code>
room.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><p>The type of condition:</p>
<ul>
<li><code>m.room_membership</code> - the user satisfies the condition if they are
joined to the referenced room.</li>
</ul>
<p>One of: <code>[m.room_membership]</code>.</p></td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;join_rule&#34;</span><span class="p">:</span> <span class="s2">&#34;public&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.join_rules&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;allow&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!other:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room_membership&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!elsewhere:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room_membership&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;join_rule&#34;</span><span class="p">:</span> <span class="s2">&#34;restricted&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.join_rules&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mroommember">
   <code>m.room.member</code>
  </h1>
</summary>
  <hr/>
<p>Adjusts the membership state for a user in a room. It is preferable to use the membership APIs (<code>/rooms/&lt;room id&gt;/invite</code> etc) when performing membership actions rather than adjusting the state directly as there are a restricted set of valid transformations. For example, user A cannot force user B to join a room, and trying to force this state change directly will fail.</p>
<p>The following membership states are specified:</p>
<ul>
<li><code>invite</code> - The user has been invited to join a room, but has not yet joined it. They may not participate in the room until they join.</li>
<li><code>join</code> - The user has joined the room (possibly after accepting an invite), and may participate in it.</li>
<li><code>leave</code> - The user was once joined to the room, but has since left (possibly by choice, or possibly by being kicked).</li>
<li><code>ban</code> - The user has been banned from the room, and is no longer allowed to join it until they are un-banned from the room (by having their membership state set to a value other than <code>ban</code>).</li>
<li><code>knock</code> - The user has knocked on the room, requesting permission to participate. They may not participate in the room until they join.</li>
</ul>
<p>The <code>third_party_invite</code> property will be set if this invite is an <code>invite</code> event and is the successor of an <code>m.room.third_party_invite</code> event, and absent otherwise.</p>
<p>This event may also include an <code>invite_room_state</code> key inside the event&rsquo;s <code>unsigned</code> data.
If present, this contains an array of <a href="/client-server-api/#stripped-state">stripped state events</a>
to assist the receiver in identifying the room.</p>
<p>The user for which a membership applies is represented by the <code>state_key</code>. Under some conditions,
the <code>sender</code> and <code>state_key</code> may not match - this may be interpreted as the <code>sender</code> affecting
the membership state of the <code>state_key</code> user.</p>
<p>The <code>membership</code> for a given user can change over time. The table below represents the various changes
over time and how clients and servers must interpret those changes. Previous membership can be retrieved
from the <code>prev_content</code> object on an event. If not present, the user&rsquo;s previous membership must be assumed
as <code>leave</code>.</p>
<table>
<thead>
<tr>
<th></th>
<th>to <code>invite</code></th>
<th>to <code>join</code></th>
<th>to <code>leave</code></th>
<th>to <code>ban</code></th>
<th>to <code>knock</code></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>from <code>invite</code></strong></td>
<td>No change.</td>
<td>User joined the room.</td>
<td>If the <code>state_key</code> is the same as the <code>sender</code>, the user rejected the invite. Otherwise, the <code>state_key</code> user had their invite revoked.</td>
<td>User was banned.</td>
<td>User is re-knocking.</td>
</tr>
<tr>
<td><strong>from <code>join</code></strong></td>
<td>Must never happen.</td>
<td><code>displayname</code> or <code>avatar_url</code> changed.</td>
<td>If the <code>state_key</code> is the same as the <code>sender</code>, the user left. Otherwise, the <code>state_key</code> user was kicked.</td>
<td>User was kicked and banned.</td>
<td>Must never happen.</td>
</tr>
<tr>
<td><strong>from <code>leave</code></strong></td>
<td>New invitation sent.</td>
<td>User joined.</td>
<td>No change.</td>
<td>User was banned.</td>
<td>User is knocking.</td>
</tr>
<tr>
<td><strong>from <code>ban</code></strong></td>
<td>Must never happen.</td>
<td>Must never happen.</td>
<td>User was unbanned.</td>
<td>No change.</td>
<td>Must never happen.</td>
</tr>
<tr>
<td><strong>from <code>knock</code></strong></td>
<td>Knock accepted.</td>
<td>Must never happen.</td>
<td>If the <code>state_key</code> is the same as the <code>sender</code>, the user retracted the knock. Otherwise, the <code>state_key</code> user had their knock denied.</td>
<td>User was banned.</td>
<td>No change.</td>
</tr>
</tbody>
</table>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>State event</td>
  </tr>
  <tr>
   <th>State key</th>
   <td>The <code>user_id</code> this membership event relates to. In all cases except for when <code>membership</code> is
<code>join</code>, the user ID sending the event does not need to match the user ID in the <code>state_key</code>,
unlike other events. Regular authorisation rules still apply.</td>
 </tr>
</table>
<h2>Content</h2>
<table id="mroommember_eventcontent" class="object-table">
 <caption>EventContent</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>avatar_url</code></td>
  <td><code>string</code></td>
  <td>
    The avatar URL for this user, if any.</td>
 </tr>
 <tr>
  <td><code>displayname</code></td>
  <td><code>[string null]</code></td>
  <td>
    The display name for this user, if any.</td>
 </tr>
 <tr>
  <td><code>is_direct</code></td>
  <td><code>boolean</code></td>
  <td>
    Flag indicating if the room containing this event was created with the intention of being a direct chat. See <a href="/client-server-api/#direct-messaging">Direct Messaging</a>.</td>
 </tr>
 <tr>
  <td><code>join_authorised_via_users_server</code></td>
  <td><code>string</code></td>
  <td>
    <p>Usually found on <code>join</code> events, this field is used to denote which homeserver (through representation of a user with sufficient power level)
authorised the user&rsquo;s join. More information about this field can be found in the <a href="#restricted-rooms">Restricted Rooms Specification</a>.</p>
<p>Client and server implementations should be aware of the <a href="/rooms/v8/#authorization-rules">signing implications</a> of including this
field in further events: in particular, the event must be signed by the server which
owns the user ID in the field. When copying the membership event&rsquo;s <code>content</code>
(for profile updates and similar) it is therefore encouraged to exclude this
field in the copy, as otherwise the event might fail event authorization.</p>
<p><strong>Added in <code>v1.2</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>membership</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The membership state of the user.<p>One of: <code>[invite, join, knock, leave, ban]</code>.</p></td>
 </tr>
 <tr>
  <td><code>reason</code></td>
  <td><code>string</code></td>
  <td>
    <p>Optional user-supplied text for why their membership has changed. For kicks and bans, this is typically the reason for the kick or ban.
For other membership changes, this is a way for the user to communicate their intent without having to send a message to the room, such
as in a case where Bob rejects an invite from Alice about an upcoming concert, but can&rsquo;t make it that day.</p>
<p>Clients are not recommended to show this reason to users when receiving an invite due to the potential for spam and abuse. Hiding the
reason behind a button or other component is recommended.</p>
<p><strong>Added in <code>v1.1</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>third_party_invite</code></td>
  <td><code>Invite</code></td>
  <td>
    </td>
 </tr>
</table>
<table id="mroommember_invite" class="object-table">
 <caption>Invite</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>display_name</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A name which can be displayed to represent the user instead of their third-party identifier</td>
 </tr>
 <tr>
  <td><code>signed</code></td>
  <td><code>signed</code></td>
  <td>
    <strong>Required: </strong>A block of content which has been signed, which servers can use to verify the event. Clients should ignore this.</td>
 </tr>
</table>
<table id="mroommember_signed" class="object-table">
 <caption>signed</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>mxid</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The invited matrix user ID. Must be equal to the user_id property of the event.</td>
 </tr>
 <tr>
  <td><code>signatures</code></td>
  <td><code>Signatures</code></td>
  <td>
    <strong>Required: </strong>A single signature from the verifying server, in the format specified by the Signing Events section of the server-server API.</td>
 </tr>
 <tr>
  <td><code>token</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The token property of the containing third_party_invite object.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/SEsfnsuifSDFSSEF&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;displayname&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice Margatroid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;join&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;Looking for support&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/SEsfnsuifSDFSSEF&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;displayname&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice Margatroid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;invite&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;Looking for support&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;invite_room_state&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Example Room&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@bob:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.name&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;join_rule&#34;</span><span class="p">:</span> <span class="s2">&#34;invite&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@bob:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.join_rules&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/SEsfnsuifSDFSSEF&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;displayname&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice Margatroid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;join_authorised_via_users_server&#34;</span><span class="p">:</span> <span class="s2">&#34;@bob:other.example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;join&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/SEsfnsuifSDFSSEF&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;displayname&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice Margatroid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;knock&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;Looking for support&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;knock_room_state&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Example Room&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@bob:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.name&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;join_rule&#34;</span><span class="p">:</span> <span class="s2">&#34;knock&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@bob:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.join_rules&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/SEsfnsuifSDFSSEF&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;displayname&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice Margatroid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;invite&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;third_party_invite&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;display_name&#34;</span><span class="p">:</span> <span class="s2">&#34;alice&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;signed&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;mxid&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;magic.forest&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;ed25519:3&#34;</span><span class="p">:</span> <span class="s2">&#34;fQpGIW1Snz+pwLZu6sTy2aHy/DYWWTspTJRPyNp0PKkymfIsNffysMl6ObMMFdIJhk6g6pwlIqZ54rxo8SLmAg&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;token&#34;</span><span class="p">:</span> <span class="s2">&#34;abc123&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mroompower_levels">
   <code>m.room.power_levels</code>
  </h1>
</summary>
  <hr/>
<p>This event specifies the minimum level a user must have in order to perform a
certain action. It also specifies the levels of each user in the room.</p>
<p>If a <code>user_id</code> is in the <code>users</code> list, then that <code>user_id</code> has the
associated power level. Otherwise they have the default level
<code>users_default</code>. If <code>users_default</code> is not supplied, it is assumed to be
0. If the room contains no <code>m.room.power_levels</code> event, the room&rsquo;s creator has
a power level of 100, and all other users have a power level of 0.</p>
<p>The level required to send a certain event is governed by <code>events</code>,
<code>state_default</code> and <code>events_default</code>. If an event type is specified in
<code>events</code>, then the user must have at least the level specified in order to
send that event. If the event type is not supplied, it defaults to
<code>events_default</code> for Message Events and <code>state_default</code> for State
Events.</p>
<p>If there is no <code>state_default</code> in the <code>m.room.power_levels</code> event, or
there is no <code>m.room.power_levels</code> event, the <code>state_default</code> is 50.
If there is no <code>events_default</code> in the <code>m.room.power_levels</code> event,
or there is no <code>m.room.power_levels</code> event, the <code>events_default</code> is 0.</p>
<p>The power level required to invite a user to the room, kick a user from the
room, ban a user from the room, or redact an event sent by another user, is
defined by <code>invite</code>, <code>kick</code>, <code>ban</code>, and <code>redact</code>, respectively.  The levels
for <code>kick</code>, <code>ban</code> and <code>redact</code> default to 50 if they are not specified in the
<code>m.room.power_levels</code> event, or if the room contains no <code>m.room.power_levels</code>
event. <code>invite</code> defaults to 0 in either case.</p>
<p><strong>Note:</strong></p>
<p>The allowed range for power level values is <code>[-(2**53)+1, (2**53)-1]</code>,
as required by the <a href="/appendices/#canonical-json">Canonical JSON specification</a>.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>State event</td>
  </tr>
  <tr>
   <th>State key</th>
   <td>A zero-length string.</td>
 </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>ban</code></td>
  <td><code>integer</code></td>
  <td>
    The level required to ban a user. Defaults to 50 if unspecified.</td>
 </tr>
 <tr>
  <td><code>events</code></td>
  <td><code>Event power levels</code></td>
  <td>
    The level required to send specific event types. This is a mapping from event type to power level required.</td>
 </tr>
 <tr>
  <td><code>events_default</code></td>
  <td><code>integer</code></td>
  <td>
    The default level required to send message events. Can be
overridden by the <code>events</code> key.  Defaults to 0 if unspecified.</td>
 </tr>
 <tr>
  <td><code>invite</code></td>
  <td><code>integer</code></td>
  <td>
    The level required to invite a user. Defaults to 0 if unspecified.</td>
 </tr>
 <tr>
  <td><code>kick</code></td>
  <td><code>integer</code></td>
  <td>
    The level required to kick a user. Defaults to 50 if unspecified.</td>
 </tr>
 <tr>
  <td><code>notifications</code></td>
  <td><code>Notifications</code></td>
  <td>
    The power level requirements for specific notification types.
This is a mapping from <code>key</code> to power level for that notifications key.</td>
 </tr>
 <tr>
  <td><code>redact</code></td>
  <td><code>integer</code></td>
  <td>
    The level required to redact an event sent by another user. Defaults to 50 if unspecified.</td>
 </tr>
 <tr>
  <td><code>state_default</code></td>
  <td><code>integer</code></td>
  <td>
    The default level required to send state events. Can be overridden
by the <code>events</code> key. Defaults to 50 if unspecified.</td>
 </tr>
 <tr>
  <td><code>users</code></td>
  <td><code>User power levels</code></td>
  <td>
    The power levels for specific users. This is a mapping from <code>user_id</code> to power level for that user.</td>
 </tr>
 <tr>
  <td><code>users_default</code></td>
  <td><code>integer</code></td>
  <td>
    <p>The power level for users in the room whose <code>user_id</code> is not mentioned in the <code>users</code> key. Defaults to 0 if
unspecified.</p>
<p><strong>Note</strong>: When there is no <code>m.room.power_levels</code> event in the room, the room creator has
a power level of 100, and all other users have a power level of 0.</p>
</td>
 </tr>
</table>
<table id="mroompower_levels_notifications" class="object-table">
 <caption>Notifications</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>room</code></td>
  <td><code>integer</code></td>
  <td>
    The level required to trigger an <code>@room</code> notification. Defaults to 50 if unspecified.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ban&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;events&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;m.room.name&#34;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;m.room.power_levels&#34;</span><span class="p">:</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;events_default&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;invite&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;kick&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;notifications&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room&#34;</span><span class="p">:</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;redact&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;state_default&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;users&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;@example:localhost&#34;</span><span class="p">:</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;users_default&#34;</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.power_levels&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h4 id="historical-events">Historical events</h4>
<p>Some events within the <code>m.</code> namespace might appear in rooms, however
they serve no significant meaning in this version of the specification.
They are:</p>
<ul>
<li><code>m.room.aliases</code></li>
</ul>
<p>Previous versions of the specification have more information on these
events.</p>
<h3 id="syncing">Syncing</h3>
<p>To read events, the intended flow of operation is for clients to first
call the <a href="/client-server-api/#get_matrixclientv3sync"><code>/sync</code></a> API without a <code>since</code> parameter. This returns the
most recent message events for each room, as well as the state of the
room at the start of the returned timeline. The response also includes a
<code>next_batch</code> field, which should be used as the value of the <code>since</code>
parameter in the next call to <code>/sync</code>. Finally, the response includes,
for each room, a <code>prev_batch</code> field, which can be passed as a <code>start</code>
parameter to the <a href="/client-server-api/#get_matrixclientv3roomsroomidmessages"><code>/rooms/&lt;room_id&gt;/messages</code></a> API to retrieve earlier
messages.</p>
<p>For example, a <code>/sync</code> request might return a range of four events
<code>E2</code>, <code>E3</code>, <code>E4</code> and <code>E5</code> within a given room, omitting two prior events
<code>E0</code> and <code>E1</code>. This can be visualised as follows:</p>
<pre tabindex="0"><code>    [E0]-&gt;[E1]-&gt;[E2]-&gt;[E3]-&gt;[E4]-&gt;[E5]
               ^                      ^
               |                      |
         prev_batch: &#39;1-2-3&#39;        next_batch: &#39;a-b-c&#39;
</code></pre><p>Clients then receive new events by &ldquo;long-polling&rdquo; the homeserver via the
<code>/sync</code> API, passing the value of the <code>next_batch</code> field from the
response to the previous call as the <code>since</code> parameter. The client
should also pass a <code>timeout</code> parameter. The server will then hold open
the HTTP connection for a short period of time waiting for new events,
returning early if an event occurs. Only the <code>/sync</code> API (and the
deprecated <code>/events</code> API) support long-polling in this way.</p>
<p>Continuing the example above, an incremental sync might report
a single new event <code>E6</code>. The response can be visualised as:</p>
<pre tabindex="0"><code>    [E0]-&gt;[E1]-&gt;[E2]-&gt;[E3]-&gt;[E4]-&gt;[E5]-&gt;[E6]
                                      ^     ^
                                      |     |
                                      |  next_batch: &#39;x-y-z&#39;
                                    prev_batch: &#39;a-b-c&#39;
</code></pre><p>Normally, all new events which are visible to the client will appear in
the response to the <code>/sync</code> API. However, if a large number of events
arrive between calls to <code>/sync</code>, a &ldquo;limited&rdquo; timeline is returned,
containing only the most recent message events. A state &ldquo;delta&rdquo; is also
returned, summarising any state changes in the omitted part of the
timeline. The client may therefore end up with &ldquo;gaps&rdquo; in its knowledge
of the message timeline. The client can fill these gaps using the
<a href="/client-server-api/#get_matrixclientv3roomsroomidmessages"><code>/rooms/&lt;room_id&gt;/messages</code></a> API.</p>
<p>Continuing our example, suppose we make a third <code>/sync</code> request asking for
events since the last sync, by passing the <code>next_batch</code> token <code>x-y-z</code> as
the <code>since</code> parameter. The server knows about four new events, <code>E7</code>, <code>E8</code>,
<code>E9</code> and <code>E10</code>, but decides this is too many to report at once. Instead,
the server sends a <code>limited</code> response containing <code>E8</code>, <code>E9</code> and <code>E10</code>but
omitting <code>E7</code>. This forms a gap, which we can see in the visualisation:</p>
<pre tabindex="0"><code>                                            | gap |
                                            | &lt;-&gt; |
    [E0]-&gt;[E1]-&gt;[E2]-&gt;[E3]-&gt;[E4]-&gt;[E5]-&gt;[E6]-&gt;[E7]-&gt;[E8]-&gt;[E9]-&gt;[E10]
                                            ^     ^                  ^
                                            |     |                  |
                                 since: &#39;x-y-z&#39;   |                  |
                                       prev_batch: &#39;d-e-f&#39;       next_batch: &#39;u-v-w&#39;
</code></pre><p>The limited response includes a state delta which describes how the state
of the room changes over the gap. This delta explains how to build the state
prior to returned timeline (i.e. at <code>E7</code>) from the state the client knows
(i.e. at <code>E6</code>). To close the gap, the client should make a request to
<a href="/client-server-api/#get_matrixclientv3roomsroomidmessages"><code>/rooms/&lt;room_id&gt;/messages</code></a>
with the query parameters <code>from=x-y-z</code> and <code>to=d-e-f</code>.</p>
<div class="alert warning " role="alert">
Events are ordered in this API according to the arrival time of the
event on the homeserver. This can conflict with other APIs which order
events based on their partial ordering in the event graph. This can
result in duplicate events being received (once per distinct API
called). Clients SHOULD de-duplicate events based on the event ID when
this happens.
</div>
<div class="alert note " role="alert">
<p>The <code>/sync</code> API returns a <code>state</code> list which is separate from the
<code>timeline</code>. This <code>state</code> list allows clients to keep their model of the
room state in sync with that on the server. In the case of an initial
(<code>since</code>-less) sync, the <code>state</code> list represents the complete state of
the room at the <strong>start</strong> of the returned timeline (so in the case of a
recently-created room whose state fits entirely in the <code>timeline</code>, the
<code>state</code> list will be empty).</p>
<p>In the case of an incremental sync, the <code>state</code> list gives a delta
between the state of the room at the <code>since</code> parameter and that at the
start of the returned <code>timeline</code>. (It will therefore be empty unless the
timeline was <code>limited</code>.)</p>
<p>In both cases, it should be noted that the events returned in the
<code>state</code> list did <strong>not</strong> necessarily take place just before the returned
<code>timeline</code>, so clients should not display them to the user in the
timeline.</p>
</div>
<div class="alert rationale " role="alert">
<p>An early design of this specification made the <code>state</code> list represent
the room state at the end of the returned timeline, instead of the
start. This was unsatisfactory because it led to duplication of events
between the <code>state</code> list and the <code>timeline</code>, but more importantly, it
made it difficult for clients to show the timeline correctly.</p>
<p>In particular, consider a returned timeline [M0, S1, M2], where M0 and
M2 are both messages sent by the same user, and S1 is a state event
where that user changes their displayname. If the <code>state</code> list
represents the room state at the end of the timeline, the client must
take a copy of the state dictionary, and <em>rewind</em> S1, in order to
correctly calculate the display name for M0.</p>
</div>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3sync">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/sync</span>
  </h1>
</summary>
  <hr/>
<p><p>Synchronise the client&rsquo;s state with the latest state on the server.
Clients use this API when they first log in to get an initial snapshot
of the state on the server, and then continue to call this API to get
incremental deltas to the state, and to receive new messages.</p>
<p><em>Note</em>: This endpoint supports lazy-loading. See <a href="/client-server-api/#filtering">Filtering</a>
for more information. Lazy-loading members is only supported on a <code>StateFilter</code>
for this endpoint. When lazy-loading is enabled, servers MUST include the
syncing user&rsquo;s own membership event when they join a room, or when the
full state of rooms is requested, to aid discovering the user&rsquo;s avatar &amp;
displayname.</p>
<p>Further, like other members, the user&rsquo;s own membership event is eligible
for being considered redundant by the server. When a sync is <code>limited</code>,
the server MUST return membership events for events in the gap
(between <code>since</code> and the start of the returned timeline), regardless
as to whether or not they are redundant. This ensures that joins/leaves
and profile changes which occur during the gap are not lost.</p>
<p>Note that the default behaviour of <code>state</code> is to include all membership
events, alongside other state, when lazy-loading is not enabled.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>filter</code></td>
  <td><code>string</code></td>
  <td>
    <p>The ID of a filter created using the filter API or a filter JSON
object encoded as a string. The server will detect whether it is
an ID or a JSON object by whether the first character is a <code>&quot;{&quot;</code>
open brace. Passing the JSON inline is best suited to one off
requests. Creating a filter using the filter API is recommended for
clients that reuse the same filter multiple times, for example in
long poll requests.</p>
<p>See <a href="/client-server-api/#filtering">Filtering</a> for more information.</p>
</td>
 </tr>
 <tr>
  <td><code>full_state</code></td>
  <td><code>boolean</code></td>
  <td>
    <p>Controls whether to include the full state for all rooms the user
is a member of.</p>
<p>If this is set to <code>true</code>, then all state events will be returned,
even if <code>since</code> is non-empty. The timeline will still be limited
by the <code>since</code> parameter. In this case, the <code>timeout</code> parameter
will be ignored and the query will return immediately, possibly with
an empty timeline.</p>
<p>If <code>false</code>, and <code>since</code> is non-empty, only state which has
changed since the point indicated by <code>since</code> will be returned.</p>
<p>By default, this is <code>false</code>.</p>
</td>
 </tr>
 <tr>
  <td><code>set_presence</code></td>
  <td><code>string</code></td>
  <td>
    Controls whether the client is automatically marked as online by
polling this API. If this parameter is omitted then the client is
automatically marked as online when it uses this API. Otherwise if
the parameter is set to &ldquo;offline&rdquo; then the client is not marked as
being online when it uses this API. When set to &ldquo;unavailable&rdquo;, the
client is marked as being idle.<p>One of: <code>[offline, online, unavailable]</code>.</p></td>
 </tr>
 <tr>
  <td><code>since</code></td>
  <td><code>string</code></td>
  <td>
    A point in time to continue a sync from. This should be the
<code>next_batch</code> token returned by an earlier call to this endpoint.</td>
 </tr>
 <tr>
  <td><code>timeout</code></td>
  <td><code>integer</code></td>
  <td>
    <p>The maximum time to wait, in milliseconds, before returning this
request. If no events (or other data) become available before this
time elapses, the server will return a response with empty fields.</p>
<p>By default, this is <code>0</code>, so the server will return immediately
even if the response is empty.</p>
</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The initial snapshot or delta for the client to use to update their state.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>account_data</code></td>
  <td><code>Account Data</code></td>
  <td>
    The global private data created by this user.</td>
 </tr>
 <tr>
  <td><code>device_lists</code></td>
  <td><code>DeviceLists</code></td>
  <td>
    Information on end-to-end device updates, as specified in
<a href="/client-server-api/#e2e-extensions-to-sync">End-to-end encryption</a>.</td>
 </tr>
 <tr>
  <td><code>device_one_time_keys_count</code></td>
  <td><code>One-time keys count</code></td>
  <td>
    Information on end-to-end encryption keys, as specified
in <a href="/client-server-api/#e2e-extensions-to-sync">End-to-end encryption</a>.</td>
 </tr>
 <tr>
  <td><code>next_batch</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The batch token to supply in the <code>since</code> param of the next
<code>/sync</code> request.</td>
 </tr>
 <tr>
  <td><code>presence</code></td>
  <td><code>Presence</code></td>
  <td>
    The updates to the presence status of other users.</td>
 </tr>
 <tr>
  <td><code>rooms</code></td>
  <td><code>Rooms</code></td>
  <td>
    Updates to rooms.</td>
 </tr>
 <tr>
  <td><code>to_device</code></td>
  <td><code>ToDevice</code></td>
  <td>
    Information on the send-to-device messages for the client
device, as defined in <a href="/client-server-api/#extensions-to-sync">Send-to-Device messaging</a>.</td>
 </tr>
</table>
<table id="_matrixclientv3sync_account-data" class="object-table">
 <caption>Account Data</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>events</code></td>
  <td><code>[Event]</code></td>
  <td>
    List of events.</td>
 </tr>
</table>
<table id="_matrixclientv3sync_event" class="object-table">
 <caption>Event</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The fields in this object will vary depending on the type of event. When interacting with the REST API, this is the HTTP body.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of event. This SHOULD be namespaced similar to Java package naming conventions e.g. &lsquo;com.example.subdomain.event.type&rsquo;</td>
 </tr>
</table>
<table id="_matrixclientv3sync_presence" class="object-table">
 <caption>Presence</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>events</code></td>
  <td><code>[Event]</code></td>
  <td>
    List of events.</td>
 </tr>
</table>
<table id="_matrixclientv3sync_rooms" class="object-table">
 <caption>Rooms</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>invite</code></td>
  <td><code>Invited Rooms</code></td>
  <td>
    The rooms that the user has been invited to, mapped as room ID to
room information.</td>
 </tr>
 <tr>
  <td><code>join</code></td>
  <td><code>Joined Rooms</code></td>
  <td>
    The rooms that the user has joined, mapped as room ID to
room information.</td>
 </tr>
 <tr>
  <td><code>knock</code></td>
  <td><code>Knocked rooms</code></td>
  <td>
    The rooms that the user has knocked upon, mapped as room ID to room information.</td>
 </tr>
 <tr>
  <td><code>leave</code></td>
  <td><code>Left rooms</code></td>
  <td>
    The rooms that the user has left or been banned from, mapped as room ID to
room information.</td>
 </tr>
</table>
<table id="_matrixclientv3sync_invited-room" class="object-table">
 <caption>Invited Room</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>invite_state</code></td>
  <td><code>InviteState</code></td>
  <td>
    The <a href="#stripped-state">stripped state</a> of a room that the user has been invited
to.</td>
 </tr>
</table>
<table id="_matrixclientv3sync_invitestate" class="object-table">
 <caption>InviteState</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>events</code></td>
  <td><code>[StrippedStateEvent]</code></td>
  <td>
    The <a href="#stripped-state">stripped state events</a> that form the invite state.</td>
 </tr>
</table>
<table id="_matrixclientv3sync_strippedstateevent" class="object-table">
 <caption>StrippedStateEvent</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>EventContent</code></td>
  <td>
    <strong>Required: </strong>The <code>content</code> for the event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>sender</code> for the event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>state_key</code> for the event.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>type</code> for the event.</td>
 </tr>
</table>
<table id="_matrixclientv3sync_joined-room" class="object-table">
 <caption>Joined Room</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>account_data</code></td>
  <td><code>Account Data</code></td>
  <td>
    The private data that this user has attached to
this room.</td>
 </tr>
 <tr>
  <td><code>ephemeral</code></td>
  <td><code>Ephemeral</code></td>
  <td>
    The new ephemeral events in the room (events that
aren&rsquo;t recorded in the timeline or state of the
room). In this version of the spec, these are
<a href="#typing-notifications">typing notification</a> and
<a href="#receipts">read receipt</a> events.</td>
 </tr>
 <tr>
  <td><code>state</code></td>
  <td><code>State</code></td>
  <td>
    <p>Updates to the state, between the time indicated by
the <code>since</code> parameter, and the start of the
<code>timeline</code> (or all state up to the start of the
<code>timeline</code>, if <code>since</code> is not given, or
<code>full_state</code> is true).</p>
<p>N.B. state updates for <code>m.room.member</code> events will
be incomplete if <code>lazy_load_members</code> is enabled in
the <code>/sync</code> filter, and only return the member events
required to display the senders of the timeline events
in this response.</p>
</td>
 </tr>
 <tr>
  <td><code>summary</code></td>
  <td><code>RoomSummary</code></td>
  <td>
    Information about the room which clients may need to
correctly render it to users.</td>
 </tr>
 <tr>
  <td><code>timeline</code></td>
  <td><code>Timeline</code></td>
  <td>
    The timeline of messages and state changes in the
room.</td>
 </tr>
 <tr>
  <td><code>unread_notifications</code></td>
  <td><code>Unread Notification Counts</code></td>
  <td>
    <p>Counts of unread notifications for this room. See the
<a href="/client-server-api/#receiving-notifications">Receiving notifications</a> section
for more information on how these are calculated.</p>
<p>If <code>unread_thread_notifications</code> was specified as <code>true</code> on the <code>RoomEventFilter</code>,
these counts will only be for the main timeline rather than all events in the room.
See the <a href="#threading">threading module</a> for more information.</p>
<br><br>
    <strong>
      Changed in <code>v1.4</code>:
    </strong>
    Updated to reflect behaviour of having <code>unread_thread_notifications</code> as <code>true</code> in
the <code>RoomEventFilter</code> for <code>/sync</code>.
</td>
 </tr>
 <tr>
  <td><code>unread_thread_notifications</code></td>
  <td><code>Unread Thread Notification Counts</code></td>
  <td>
    <p>If <code>unread_thread_notifications</code> was specified as <code>true</code> on the <code>RoomEventFilter</code>,
the notification counts for each <a href="#threading">thread</a> in this room. The object is
keyed by thread root ID, with values matching <code>unread_notifications</code>.</p>
<p>If a thread does not have any notifications it can be omitted from this object. If
no threads have notification counts, this whole object can be omitted.</p>
<p><strong>Added in <code>v1.4</code></strong></p>
</td>
 </tr>
</table>
<table id="_matrixclientv3sync_ephemeral" class="object-table">
 <caption>Ephemeral</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>events</code></td>
  <td><code>[Event]</code></td>
  <td>
    List of events.</td>
 </tr>
</table>
<table id="_matrixclientv3sync_state" class="object-table">
 <caption>State</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>events</code></td>
  <td><code>[ClientEventWithoutRoomID]</code></td>
  <td>
    List of events.</td>
 </tr>
</table>
<table id="_matrixclientv3sync_clienteventwithoutroomid" class="object-table">
 <caption>ClientEventWithoutRoomID</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The body of this event, as created by the client which sent it.</td>
 </tr>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The globally unique identifier for this event.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>Timestamp (in milliseconds since the unix epoch) on originating homeserver
when this event was sent.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Contains the fully-qualified ID of the user who sent this event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <p>Present if, and only if, this event is a <em>state</em> event. The key making
this piece of state unique in the room. Note that it is often an empty
string.</p>
<p>State keys starting with an <code>@</code> are reserved for referencing user IDs, such
as room members. With the exception of a few events, state events set with a
given user&rsquo;s ID as the state key MUST only be set by that user.</p>
</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of the event.</td>
 </tr>
 <tr>
  <td><code>unsigned</code></td>
  <td><code>UnsignedData</code></td>
  <td>
    Contains optional extra information about the event.</td>
 </tr>
</table>
<table id="_matrixclientv3sync_unsigneddata" class="object-table">
 <caption>UnsignedData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>age</code></td>
  <td><code>integer</code></td>
  <td>
    The time in milliseconds that has elapsed since the event was sent. This field is generated by the local homeserver, and may be incorrect if the local time on at least one of the two servers is out of sync, which can cause the age to either be negative or greater than it actually is.</td>
 </tr>
 <tr>
  <td><code>prev_content</code></td>
  <td><code>EventContent</code></td>
  <td>
    The previous <code>content</code> for this event. This field is generated
by the local homeserver, and is only returned if the event is a state event,
and the client has permission to see the previous content.<br><br>
    <strong>
      Changed in <code>v1.2</code>:
    </strong>
    Previously, this field was specified at the top level of returned
events rather than in <code>unsigned</code> (with the exception of the <a href="/client-server-api/#get_matrixclientv3notifications"><code>GET .../notifications</code></a>
endpoint), though in practice no known server implementations honoured
this.
</td>
 </tr>
 <tr>
  <td><code>redacted_because</code></td>
  <td><code>ClientEventWithoutRoomID</code></td>
  <td>
    The event that redacted this event, if any.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    The client-supplied <a href="/client-server-api/#transaction-identifiers">transaction ID</a>, for example, provided via
<code>PUT /_matrix/client/v3/rooms/{roomId}/send/{eventType}/{txnId}</code>,
if the client being given the event is the same one which sent it.</td>
 </tr>
</table>
<table id="_matrixclientv3sync_roomsummary" class="object-table">
 <caption>RoomSummary</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>m.heroes</code></td>
  <td><code>[string]</code></td>
  <td>
    <p>The users which can be used to generate a room name
if the room does not have one. Required if the room&rsquo;s
<code>m.room.name</code> or <code>m.room.canonical_alias</code> state events
are unset or empty.</p>
<p>This should be the first 5 members of the room, ordered
by stream ordering, which are joined or invited. The
list must never include the client&rsquo;s own user ID. When
no joined or invited members are available, this should
consist of the banned and left users. More than 5 members
may be provided, however less than 5 should only be provided
when there are less than 5 members to represent.</p>
<p>When lazy-loading room members is enabled, the membership
events for the heroes MUST be included in the <code>state</code>,
unless they are redundant. When the list of users changes,
the server notifies the client by sending a fresh list of
heroes. If there are no changes since the last sync, this
field may be omitted.</p>
</td>
 </tr>
 <tr>
  <td><code>m.invited_member_count</code></td>
  <td><code>integer</code></td>
  <td>
    The number of users with <code>membership</code> of <code>invite</code>.
If this field has not changed since the last sync, it
may be omitted. Required otherwise.</td>
 </tr>
 <tr>
  <td><code>m.joined_member_count</code></td>
  <td><code>integer</code></td>
  <td>
    The number of users with <code>membership</code> of <code>join</code>,
including the client&rsquo;s own user ID. If this field has
not changed since the last sync, it may be omitted.
Required otherwise.</td>
 </tr>
</table>
<table id="_matrixclientv3sync_timeline" class="object-table">
 <caption>Timeline</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>events</code></td>
  <td><code>[ClientEventWithoutRoomID]</code></td>
  <td>
    <strong>Required: </strong>List of events.</td>
 </tr>
 <tr>
  <td><code>limited</code></td>
  <td><code>boolean</code></td>
  <td>
    True if the number of events returned was limited by the <code>limit</code> on the filter.</td>
 </tr>
 <tr>
  <td><code>prev_batch</code></td>
  <td><code>string</code></td>
  <td>
    A token that can be supplied to the <code>from</code> parameter of the <a href="#get_matrixclientv3roomsroomidmessages"><code>/rooms/&lt;room_id&gt;/messages</code></a> endpoint in order to retrieve earlier events.
If no earlier events are available, this property may be omitted from the response.</td>
 </tr>
</table>
<table id="_matrixclientv3sync_unread-notification-counts" class="object-table">
 <caption>Unread Notification Counts</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>highlight_count</code></td>
  <td><code>integer</code></td>
  <td>
    The number of unread notifications for this room with the highlight flag set.</td>
 </tr>
 <tr>
  <td><code>notification_count</code></td>
  <td><code>integer</code></td>
  <td>
    The total number of unread notifications for this room.</td>
 </tr>
</table>
<table id="_matrixclientv3sync_threadnotificationcounts" class="object-table">
 <caption>ThreadNotificationCounts</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>highlight_count</code></td>
  <td><code>integer</code></td>
  <td>
    The number of unread notifications for this <em>thread</em> with the highlight flag set.</td>
 </tr>
 <tr>
  <td><code>notification_count</code></td>
  <td><code>integer</code></td>
  <td>
    The total number of unread notifications for this <em>thread</em>.</td>
 </tr>
</table>
<table id="_matrixclientv3sync_knocked-room" class="object-table">
 <caption>Knocked Room</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>knock_state</code></td>
  <td><code>KnockState</code></td>
  <td>
    The <a href="#stripped-state">stripped state</a> of a room that the user has knocked upon.</td>
 </tr>
</table>
<table id="_matrixclientv3sync_knockstate" class="object-table">
 <caption>KnockState</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>events</code></td>
  <td><code>[StrippedStateEvent]</code></td>
  <td>
    The <a href="#stripped-state">stripped state events</a> that form the knock state.</td>
 </tr>
</table>
<table id="_matrixclientv3sync_left-room" class="object-table">
 <caption>Left Room</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>account_data</code></td>
  <td><code>Account Data</code></td>
  <td>
    The private data that this user has attached to
this room.</td>
 </tr>
 <tr>
  <td><code>state</code></td>
  <td><code>State</code></td>
  <td>
    The state updates for the room up to the start of the timeline.</td>
 </tr>
 <tr>
  <td><code>timeline</code></td>
  <td><code>Timeline</code></td>
  <td>
    The timeline of messages and state changes in the
room up to the point when the user left.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;account_data&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;events&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;custom_config_key&#34;</span><span class="p">:</span> <span class="s2">&#34;custom_config_value&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;org.example.custom.config&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;next_batch&#34;</span><span class="p">:</span> <span class="s2">&#34;s72595_4483_1934&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;presence&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;events&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://localhost/wefuiwegh8742w&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;currently_active&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;last_active_ago&#34;</span><span class="p">:</span> <span class="mi">2478593</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;presence&#34;</span><span class="p">:</span> <span class="s2">&#34;online&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;status_msg&#34;</span><span class="p">:</span> <span class="s2">&#34;Making cupcakes&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.presence&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;rooms&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;invite&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;!696r7674:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;invite_state&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;events&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;My Room Name&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="p">},</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.name&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;invite&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="p">},</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@bob:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;join&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;!726s6s6q:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;account_data&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;events&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;tags&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="nt">&#34;u.work&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;order&#34;</span><span class="p">:</span> <span class="mf">0.9</span>
</span></span><span class="line"><span class="cl">                  <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">              <span class="p">},</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.tag&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;custom_config_key&#34;</span><span class="p">:</span> <span class="s2">&#34;custom_config_value&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="p">},</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;org.example.custom.room.config&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ephemeral&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;events&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;user_ids&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                  <span class="s2">&#34;@alice:matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="s2">&#34;@bob:example.com&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">]</span>
</span></span><span class="line"><span class="cl">              <span class="p">},</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.typing&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;$1435641916114394fHBLK:matrix.org&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="nt">&#34;m.read&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;@rikj:jki.re&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                      <span class="nt">&#34;ts&#34;</span><span class="p">:</span> <span class="mi">1436451550453</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                  <span class="p">},</span>
</span></span><span class="line"><span class="cl">                  <span class="nt">&#34;m.read.private&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;@self:example.org&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                      <span class="nt">&#34;ts&#34;</span><span class="p">:</span> <span class="mi">1661384801651</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                  <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">              <span class="p">},</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.receipt&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;state&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;events&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/SEsfnsuifSDFSSEF&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;displayname&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice Margatroid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;join&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;Looking for support&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="p">},</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;summary&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;m.heroes&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;@alice:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;@bob:example.com&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;m.invited_member_count&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;m.joined_member_count&#34;</span><span class="p">:</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;timeline&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;events&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/SEsfnsuifSDFSSEF&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;displayname&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice Margatroid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;join&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;Looking for support&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="p">},</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;This is an example text message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;org.matrix.custom.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;formatted_body&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;b&gt;This is an example text message&lt;/b&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="p">},</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;limited&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;prev_batch&#34;</span><span class="p">:</span> <span class="s2">&#34;t34-23535_0_0&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;unread_notifications&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;highlight_count&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;notification_count&#34;</span><span class="p">:</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;unread_thread_notifications&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;$threadroot&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;highlight_count&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;notification_count&#34;</span><span class="p">:</span> <span class="mi">6</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;knock&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;!223asd456:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;knock_state&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;events&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;My Room Name&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="p">},</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.name&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;knock&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="p">},</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@bob:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@bob:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;leave&#34;</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3events">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint deprecated-inline">/_matrix/client/v3/events</span>
  </h1>
</summary>
  <hr/>
<div class="alert warning omit-title" role="alert">
This API is deprecated and will be removed from a future release.
</div>
<p><p>This will listen for new events and return them to the caller. This will
block until an event is received, or until the <code>timeout</code> is reached.</p>
<p>This endpoint was deprecated in r0 of this specification. Clients
should instead call the <a href="/client-server-api/#get_matrixclientv3sync"><code>/sync</code></a>
endpoint with a <code>since</code> parameter. See
the <a href="https://matrix.org/docs/guides/migrating-from-client-server-api-v-1#deprecated-endpoints">migration guide</a>.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>from</code></td>
  <td><code>string</code></td>
  <td>
    The token to stream from. This token is either from a previous
request to this API or from the initial sync API.</td>
 </tr>
 <tr>
  <td><code>timeout</code></td>
  <td><code>integer</code></td>
  <td>
    The maximum time in milliseconds to wait for an event.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The events received, which may be none.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td>Bad pagination <code>from</code> parameter.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>chunk</code></td>
  <td><code>[ClientEvent]</code></td>
  <td>
    An array of events.</td>
 </tr>
 <tr>
  <td><code>end</code></td>
  <td><code>string</code></td>
  <td>
    A token which correlates to the end of <code>chunk</code>. This
token should be used in the next request to <code>/events</code>.</td>
 </tr>
 <tr>
  <td><code>start</code></td>
  <td><code>string</code></td>
  <td>
    A token which correlates to the start of <code>chunk</code>. This
is usually the same token supplied to <code>from=</code>.</td>
 </tr>
</table>
<table id="_matrixclientv3events_clientevent" class="object-table">
 <caption>ClientEvent</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The body of this event, as created by the client which sent it.</td>
 </tr>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The globally unique identifier for this event.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>Timestamp (in milliseconds since the unix epoch) on originating homeserver
when this event was sent.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room associated with this event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Contains the fully-qualified ID of the user who sent this event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <p>Present if, and only if, this event is a <em>state</em> event. The key making
this piece of state unique in the room. Note that it is often an empty
string.</p>
<p>State keys starting with an <code>@</code> are reserved for referencing user IDs, such
as room members. With the exception of a few events, state events set with a
given user&rsquo;s ID as the state key MUST only be set by that user.</p>
</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of the event.</td>
 </tr>
 <tr>
  <td><code>unsigned</code></td>
  <td><code>UnsignedData</code></td>
  <td>
    Contains optional extra information about the event.</td>
 </tr>
</table>
<table id="_matrixclientv3events_unsigneddata" class="object-table">
 <caption>UnsignedData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>age</code></td>
  <td><code>integer</code></td>
  <td>
    The time in milliseconds that has elapsed since the event was sent. This field is generated by the local homeserver, and may be incorrect if the local time on at least one of the two servers is out of sync, which can cause the age to either be negative or greater than it actually is.</td>
 </tr>
 <tr>
  <td><code>prev_content</code></td>
  <td><code>EventContent</code></td>
  <td>
    The previous <code>content</code> for this event. This field is generated
by the local homeserver, and is only returned if the event is a state event,
and the client has permission to see the previous content.<br><br>
    <strong>
      Changed in <code>v1.2</code>:
    </strong>
    Previously, this field was specified at the top level of returned
events rather than in <code>unsigned</code> (with the exception of the <a href="/client-server-api/#get_matrixclientv3notifications"><code>GET .../notifications</code></a>
endpoint), though in practice no known server implementations honoured
this.
</td>
 </tr>
 <tr>
  <td><code>redacted_because</code></td>
  <td><code>ClientEvent</code></td>
  <td>
    The event that redacted this event, if any.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    The client-supplied <a href="/client-server-api/#transaction-identifiers">transaction ID</a>, for example, provided via
<code>PUT /_matrix/client/v3/rooms/{roomId}/send/{eventType}/{txnId}</code>,
if the client being given the event is the same one which sent it.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;chunk&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;This is an example text message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;org.matrix.custom.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;formatted_body&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;b&gt;This is an example text message&lt;/b&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;end&#34;</span><span class="p">:</span> <span class="s2">&#34;s3457_9_0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;start&#34;</span><span class="p">:</span> <span class="s2">&#34;s3456_9_0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3eventseventid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint deprecated-inline">/_matrix/client/v3/events/{eventId}</span>
  </h1>
</summary>
  <hr/>
<div class="alert warning omit-title" role="alert">
This API is deprecated and will be removed from a future release.
</div>
<p><p>Get a single event based on <code>event_id</code>. You must have permission to
retrieve this event e.g. by being a member in the room for this event.</p>
<p>This endpoint was deprecated in r0 of this specification. Clients
should instead call the
<a href="/client-server-api/#get_matrixclientv3roomsroomideventeventid">/rooms/{roomId}/event/{eventId}</a> API
or the <a href="/client-server-api/#get_matrixclientv3roomsroomidcontexteventid">/rooms/{roomId}/context/{eventId</a> API.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>eventId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The event ID to get.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The full event.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The event was not found or you do not have permission to read this event.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="_matrixclientv3eventseventid_clientevent" class="object-table">
 <caption>ClientEvent</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The body of this event, as created by the client which sent it.</td>
 </tr>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The globally unique identifier for this event.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>Timestamp (in milliseconds since the unix epoch) on originating homeserver
when this event was sent.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room associated with this event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Contains the fully-qualified ID of the user who sent this event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <p>Present if, and only if, this event is a <em>state</em> event. The key making
this piece of state unique in the room. Note that it is often an empty
string.</p>
<p>State keys starting with an <code>@</code> are reserved for referencing user IDs, such
as room members. With the exception of a few events, state events set with a
given user&rsquo;s ID as the state key MUST only be set by that user.</p>
</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of the event.</td>
 </tr>
 <tr>
  <td><code>unsigned</code></td>
  <td><code>UnsignedData</code></td>
  <td>
    Contains optional extra information about the event.</td>
 </tr>
</table>
<table id="_matrixclientv3eventseventid_unsigneddata" class="object-table">
 <caption>UnsignedData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>age</code></td>
  <td><code>integer</code></td>
  <td>
    The time in milliseconds that has elapsed since the event was sent. This field is generated by the local homeserver, and may be incorrect if the local time on at least one of the two servers is out of sync, which can cause the age to either be negative or greater than it actually is.</td>
 </tr>
 <tr>
  <td><code>prev_content</code></td>
  <td><code>EventContent</code></td>
  <td>
    The previous <code>content</code> for this event. This field is generated
by the local homeserver, and is only returned if the event is a state event,
and the client has permission to see the previous content.<br><br>
    <strong>
      Changed in <code>v1.2</code>:
    </strong>
    Previously, this field was specified at the top level of returned
events rather than in <code>unsigned</code> (with the exception of the <a href="/client-server-api/#get_matrixclientv3notifications"><code>GET .../notifications</code></a>
endpoint), though in practice no known server implementations honoured
this.
</td>
 </tr>
 <tr>
  <td><code>redacted_because</code></td>
  <td><code>ClientEvent</code></td>
  <td>
    The event that redacted this event, if any.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    The client-supplied <a href="/client-server-api/#transaction-identifiers">transaction ID</a>, for example, provided via
<code>PUT /_matrix/client/v3/rooms/{roomId}/send/{eventType}/{txnId}</code>,
if the client being given the event is the same one which sent it.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;This is an example text message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;org.matrix.custom.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;formatted_body&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;b&gt;This is an example text message&lt;/b&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3initialsync">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint deprecated-inline">/_matrix/client/v3/initialSync</span>
  </h1>
</summary>
  <hr/>
<div class="alert warning omit-title" role="alert">
This API is deprecated and will be removed from a future release.
</div>
<p><p>This returns the full state for this user, with an optional limit on the
number of messages per room to return.</p>
<p>This endpoint was deprecated in r0 of this specification. Clients
should instead call the <a href="/client-server-api/#get_matrixclientv3sync"><code>/sync</code></a>
endpoint with no <code>since</code> parameter. See
the <a href="https://matrix.org/docs/guides/migrating-from-client-server-api-v-1#deprecated-endpoints">migration guide</a>.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>archived</code></td>
  <td><code>boolean</code></td>
  <td>
    Whether to include rooms that the user has left. If <code>false</code> then
only rooms that the user has been invited to or has joined are
included. If set to <code>true</code> then rooms that the user has left are
included as well. By default this is <code>false</code>.</td>
 </tr>
 <tr>
  <td><code>limit</code></td>
  <td><code>integer</code></td>
  <td>
    The maximum number of messages to return for each room.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The user&rsquo;s current state.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>There is no avatar URL for this user or this user does not exist.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>account_data</code></td>
  <td><code>[Event]</code></td>
  <td>
    The global private data created by this user.</td>
 </tr>
 <tr>
  <td><code>end</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A token which correlates to the end of the timelines returned. This
token should be used with the <code>/events</code> endpoint to listen for new
events.</td>
 </tr>
 <tr>
  <td><code>presence</code></td>
  <td><code>[Event]</code></td>
  <td>
    <strong>Required: </strong>A list of presence events.</td>
 </tr>
 <tr>
  <td><code>rooms</code></td>
  <td><code>[RoomInfo]</code></td>
  <td>
    <strong>Required: </strong></td>
 </tr>
</table>
<table id="_matrixclientv3initialsync_event" class="object-table">
 <caption>Event</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The fields in this object will vary depending on the type of event. When interacting with the REST API, this is the HTTP body.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of event. This SHOULD be namespaced similar to Java package naming conventions e.g. &lsquo;com.example.subdomain.event.type&rsquo;</td>
 </tr>
</table>
<table id="_matrixclientv3initialsync_roominfo" class="object-table">
 <caption>RoomInfo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>account_data</code></td>
  <td><code>[Event]</code></td>
  <td>
    The private data that this user has attached to
this room.</td>
 </tr>
 <tr>
  <td><code>invite</code></td>
  <td><code>InviteEvent</code></td>
  <td>
    The invite event if <code>membership</code> is <code>invite</code></td>
 </tr>
 <tr>
  <td><code>membership</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user&rsquo;s membership state in this room.<p>One of: <code>[invite, join, leave, ban]</code>.</p></td>
 </tr>
 <tr>
  <td><code>messages</code></td>
  <td><code>PaginationChunk</code></td>
  <td>
    The pagination chunk for this room.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of this room.</td>
 </tr>
 <tr>
  <td><code>state</code></td>
  <td><code>[ClientEvent]</code></td>
  <td>
    If the user is a member of the room this will be the
current state of the room as a list of events. If the
user has left the room this will be the state of the
room when they left it.</td>
 </tr>
 <tr>
  <td><code>visibility</code></td>
  <td><code>string</code></td>
  <td>
    Whether this room is visible to the <code>/publicRooms</code> API
or not.&quot;<p>One of: <code>[private, public]</code>.</p></td>
 </tr>
</table>
<table id="_matrixclientv3initialsync_inviteevent" class="object-table">
 <caption>InviteEvent</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The body of this event, as created by the client which sent it.</td>
 </tr>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The globally unique identifier for this event.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>Timestamp (in milliseconds since the unix epoch) on originating homeserver
when this event was sent.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room associated with this event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Contains the fully-qualified ID of the user who sent this event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <p>Present if, and only if, this event is a <em>state</em> event. The key making
this piece of state unique in the room. Note that it is often an empty
string.</p>
<p>State keys starting with an <code>@</code> are reserved for referencing user IDs, such
as room members. With the exception of a few events, state events set with a
given user&rsquo;s ID as the state key MUST only be set by that user.</p>
</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of the event.</td>
 </tr>
 <tr>
  <td><code>unsigned</code></td>
  <td><code>UnsignedData</code></td>
  <td>
    Contains optional extra information about the event.</td>
 </tr>
</table>
<table id="_matrixclientv3initialsync_unsigneddata" class="object-table">
 <caption>UnsignedData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>age</code></td>
  <td><code>integer</code></td>
  <td>
    The time in milliseconds that has elapsed since the event was sent. This field is generated by the local homeserver, and may be incorrect if the local time on at least one of the two servers is out of sync, which can cause the age to either be negative or greater than it actually is.</td>
 </tr>
 <tr>
  <td><code>prev_content</code></td>
  <td><code>EventContent</code></td>
  <td>
    The previous <code>content</code> for this event. This field is generated
by the local homeserver, and is only returned if the event is a state event,
and the client has permission to see the previous content.<br><br>
    <strong>
      Changed in <code>v1.2</code>:
    </strong>
    Previously, this field was specified at the top level of returned
events rather than in <code>unsigned</code> (with the exception of the <a href="/client-server-api/#get_matrixclientv3notifications"><code>GET .../notifications</code></a>
endpoint), though in practice no known server implementations honoured
this.
</td>
 </tr>
 <tr>
  <td><code>redacted_because</code></td>
  <td><code>ClientEvent</code></td>
  <td>
    The event that redacted this event, if any.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    The client-supplied <a href="/client-server-api/#transaction-identifiers">transaction ID</a>, for example, provided via
<code>PUT /_matrix/client/v3/rooms/{roomId}/send/{eventType}/{txnId}</code>,
if the client being given the event is the same one which sent it.</td>
 </tr>
</table>
<table id="_matrixclientv3initialsync_paginationchunk" class="object-table">
 <caption>PaginationChunk</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>chunk</code></td>
  <td><code>[ClientEvent]</code></td>
  <td>
    <strong>Required: </strong>If the user is a member of the room this will be a
list of the most recent messages for this room. If
the user has left the room this will be the
messages that preceded them leaving. This array
will consist of at most <code>limit</code> elements.</td>
 </tr>
 <tr>
  <td><code>end</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A token which correlates to the end of <code>chunk</code>.
Can be passed to
<a href="#get_matrixclientv3roomsroomidmessages"><code>/rooms/&lt;room_id&gt;/messages</code></a>
to retrieve later events.</td>
 </tr>
 <tr>
  <td><code>start</code></td>
  <td><code>string</code></td>
  <td>
    <p>A token which correlates to the start of <code>chunk</code>.
Can be passed to
<a href="#get_matrixclientv3roomsroomidmessages"><code>/rooms/&lt;room_id&gt;/messages</code></a>
to retrieve earlier events.</p>
<p>If no earlier events are available, this property may be omitted from
the response.</p>
</td>
 </tr>
</table>
<table id="_matrixclientv3initialsync_clientevent" class="object-table">
 <caption>ClientEvent</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The body of this event, as created by the client which sent it.</td>
 </tr>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The globally unique identifier for this event.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>Timestamp (in milliseconds since the unix epoch) on originating homeserver
when this event was sent.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room associated with this event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Contains the fully-qualified ID of the user who sent this event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <p>Present if, and only if, this event is a <em>state</em> event. The key making
this piece of state unique in the room. Note that it is often an empty
string.</p>
<p>State keys starting with an <code>@</code> are reserved for referencing user IDs, such
as room members. With the exception of a few events, state events set with a
given user&rsquo;s ID as the state key MUST only be set by that user.</p>
</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of the event.</td>
 </tr>
 <tr>
  <td><code>unsigned</code></td>
  <td><code>UnsignedData</code></td>
  <td>
    Contains optional extra information about the event.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;account_data&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;custom_config_key&#34;</span><span class="p">:</span> <span class="s2">&#34;custom_config_value&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;org.example.custom.config&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;end&#34;</span><span class="p">:</span> <span class="s2">&#34;s3456_9_0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;presence&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://localhost/wefuiwegh8742w&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;currently_active&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;last_active_ago&#34;</span><span class="p">:</span> <span class="mi">2478593</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;presence&#34;</span><span class="p">:</span> <span class="s2">&#34;online&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;status_msg&#34;</span><span class="p">:</span> <span class="s2">&#34;Making cupcakes&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.presence&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;rooms&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;account_data&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;tags&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;work&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;order&#34;</span><span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.tag&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;custom_config_key&#34;</span><span class="p">:</span> <span class="s2">&#34;custom_config_value&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;org.example.custom.room.config&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;join&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;messages&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;chunk&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;This is an example text message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;org.matrix.custom.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;formatted_body&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;b&gt;This is an example text message&lt;/b&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!TmaZBKYIFrIPVGoUYp:localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;Gangnam Style&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;info&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;duration&#34;</span><span class="p">:</span> <span class="mi">2140786</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;h&#34;</span><span class="p">:</span> <span class="mi">320</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;mimetype&#34;</span><span class="p">:</span> <span class="s2">&#34;video/mp4&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">1563685</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;thumbnail_info&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="nt">&#34;h&#34;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="nt">&#34;mimetype&#34;</span><span class="p">:</span> <span class="s2">&#34;image/jpeg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">46144</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="nt">&#34;w&#34;</span><span class="p">:</span> <span class="mi">300</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;thumbnail_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/FHyPlCeYUSFFxlgbQYZmoEoe&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;w&#34;</span><span class="p">:</span> <span class="mi">480</span>
</span></span><span class="line"><span class="cl">              <span class="p">},</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.video&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/a526eYUSFFxlgbQYZmo442&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!TmaZBKYIFrIPVGoUYp:localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;end&#34;</span><span class="p">:</span> <span class="s2">&#34;s3456_9_0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;start&#34;</span><span class="p">:</span> <span class="s2">&#34;t44-3453_9_0&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!TmaZBKYIFrIPVGoUYp:localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;state&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;join_rule&#34;</span><span class="p">:</span> <span class="s2">&#34;public&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!TmaZBKYIFrIPVGoUYp:localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.join_rules&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/SEsfnsuifSDFSSEF&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;displayname&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice Margatroid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;join&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;Looking for support&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!TmaZBKYIFrIPVGoUYp:localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;m.federate&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;predecessor&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$something:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!oldroom:example.org&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;room_version&#34;</span><span class="p">:</span> <span class="s2">&#34;11&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!TmaZBKYIFrIPVGoUYp:localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.create&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;ban&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;events&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;m.room.name&#34;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;m.room.power_levels&#34;</span><span class="p">:</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;events_default&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;invite&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kick&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;notifications&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;room&#34;</span><span class="p">:</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;redact&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;state_default&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;users&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;@example:localhost&#34;</span><span class="p">:</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;users_default&#34;</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!TmaZBKYIFrIPVGoUYp:localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.power_levels&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;visibility&#34;</span><span class="p">:</span> <span class="s2">&#34;private&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h3 id="getting-events-for-a-room">Getting events for a room</h3>
<p>There are several APIs provided to <code>GET</code> events for a room:</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3roomsroomideventeventid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/rooms/{roomId}/event/{eventId}</span>
  </h1>
</summary>
  <hr/>
<p>Get a single event based on <code>roomId/eventId</code>. You must have permission to
retrieve this event e.g. by being a member in the room for this event.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>eventId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The event ID to get.</td>
 </tr>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room the event is in.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The full event.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The event was not found or you do not have permission to read this event.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="_matrixclientv3roomsroomideventeventid_clientevent" class="object-table">
 <caption>ClientEvent</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The body of this event, as created by the client which sent it.</td>
 </tr>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The globally unique identifier for this event.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>Timestamp (in milliseconds since the unix epoch) on originating homeserver
when this event was sent.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room associated with this event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Contains the fully-qualified ID of the user who sent this event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <p>Present if, and only if, this event is a <em>state</em> event. The key making
this piece of state unique in the room. Note that it is often an empty
string.</p>
<p>State keys starting with an <code>@</code> are reserved for referencing user IDs, such
as room members. With the exception of a few events, state events set with a
given user&rsquo;s ID as the state key MUST only be set by that user.</p>
</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of the event.</td>
 </tr>
 <tr>
  <td><code>unsigned</code></td>
  <td><code>UnsignedData</code></td>
  <td>
    Contains optional extra information about the event.</td>
 </tr>
</table>
<table id="_matrixclientv3roomsroomideventeventid_unsigneddata" class="object-table">
 <caption>UnsignedData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>age</code></td>
  <td><code>integer</code></td>
  <td>
    The time in milliseconds that has elapsed since the event was sent. This field is generated by the local homeserver, and may be incorrect if the local time on at least one of the two servers is out of sync, which can cause the age to either be negative or greater than it actually is.</td>
 </tr>
 <tr>
  <td><code>prev_content</code></td>
  <td><code>EventContent</code></td>
  <td>
    The previous <code>content</code> for this event. This field is generated
by the local homeserver, and is only returned if the event is a state event,
and the client has permission to see the previous content.<br><br>
    <strong>
      Changed in <code>v1.2</code>:
    </strong>
    Previously, this field was specified at the top level of returned
events rather than in <code>unsigned</code> (with the exception of the <a href="/client-server-api/#get_matrixclientv3notifications"><code>GET .../notifications</code></a>
endpoint), though in practice no known server implementations honoured
this.
</td>
 </tr>
 <tr>
  <td><code>redacted_because</code></td>
  <td><code>ClientEvent</code></td>
  <td>
    The event that redacted this event, if any.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    The client-supplied <a href="/client-server-api/#transaction-identifiers">transaction ID</a>, for example, provided via
<code>PUT /_matrix/client/v3/rooms/{roomId}/send/{eventType}/{txnId}</code>,
if the client being given the event is the same one which sent it.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;This is an example text message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;org.matrix.custom.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;formatted_body&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;b&gt;This is an example text message&lt;/b&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3roomsroomideventeventid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Event not found.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3roomsroomidjoined_members">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/rooms/{roomId}/joined_members</span>
  </h1>
</summary>
  <hr/>
<p>This API returns a map of MXIDs to member info objects for members of the room. The current user must be in the room for it to work, unless it is an Application Service in which case any of the AS&rsquo;s users must be in the room. This API is primarily for Application Services and should be faster to respond than <code>/members</code> as it can be implemented more efficiently on the server.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room to get the members of.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>A map of MXID to room member objects.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>You aren&rsquo;t a member of the room.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>joined</code></td>
  <td><code>{string: RoomMember}</code></td>
  <td>
    A map from user ID to a RoomMember object.</td>
 </tr>
</table>
<table id="_matrixclientv3roomsroomidjoined_members_roommember" class="object-table">
 <caption>RoomMember</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>avatar_url</code></td>
  <td><code>string</code></td>
  <td>
    The avatar of the user this object is representing, as an <a href="/client-server-api/#matrix-content-mxc-uris"><code>mxc://</code> URI</a>.</td>
 </tr>
 <tr>
  <td><code>display_name</code></td>
  <td><code>string</code></td>
  <td>
    The display name of the user this object is representing.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;joined&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@bar:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://riot.ovh/printErCATzZijQsSDWorRaK&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;display_name&#34;</span><span class="p">:</span> <span class="s2">&#34;Bar&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3roomsroomidmembers">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/rooms/{roomId}/members</span>
  </h1>
</summary>
  <hr/>
<p>Get the list of members for this room.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room to get the member events for.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>at</code></td>
  <td><code>string</code></td>
  <td>
    The point in time (pagination token) to return members for in the room.
This token can be obtained from a <code>prev_batch</code> token returned for
each room by the sync API. Defaults to the current state of the room,
as determined by the server.</td>
 </tr>
 <tr>
  <td><code>membership</code></td>
  <td><code>string</code></td>
  <td>
    The kind of membership to filter for. Defaults to no filtering if
unspecified. When specified alongside <code>not_membership</code>, the two
parameters create an &lsquo;or&rsquo; condition: either the membership <em>is</em>
the same as <code>membership</code> <strong>or</strong> <em>is not</em> the same as <code>not_membership</code>.<p>One of: <code>[join, invite, knock, leave, ban]</code>.</p></td>
 </tr>
 <tr>
  <td><code>not_membership</code></td>
  <td><code>string</code></td>
  <td>
    The kind of membership to exclude from the results. Defaults to no
filtering if unspecified.<p>One of: <code>[join, invite, knock, leave, ban]</code>.</p></td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>A list of members of the room. If you are joined to the room then
this will be the current members of the room. If you have left the
room then this will be the members of the room when you left.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>You aren&rsquo;t a member of the room and weren&rsquo;t previously a member of the room.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>chunk</code></td>
  <td><code>[ClientEvent]</code></td>
  <td>
    </td>
 </tr>
</table>
<table id="_matrixclientv3roomsroomidmembers_clientevent" class="object-table">
 <caption>ClientEvent</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The body of this event, as created by the client which sent it.</td>
 </tr>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The globally unique identifier for this event.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>Timestamp (in milliseconds since the unix epoch) on originating homeserver
when this event was sent.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room associated with this event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Contains the fully-qualified ID of the user who sent this event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <p>Present if, and only if, this event is a <em>state</em> event. The key making
this piece of state unique in the room. Note that it is often an empty
string.</p>
<p>State keys starting with an <code>@</code> are reserved for referencing user IDs, such
as room members. With the exception of a few events, state events set with a
given user&rsquo;s ID as the state key MUST only be set by that user.</p>
</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of the event.</td>
 </tr>
 <tr>
  <td><code>unsigned</code></td>
  <td><code>UnsignedData</code></td>
  <td>
    Contains optional extra information about the event.</td>
 </tr>
</table>
<table id="_matrixclientv3roomsroomidmembers_unsigneddata" class="object-table">
 <caption>UnsignedData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>age</code></td>
  <td><code>integer</code></td>
  <td>
    The time in milliseconds that has elapsed since the event was sent. This field is generated by the local homeserver, and may be incorrect if the local time on at least one of the two servers is out of sync, which can cause the age to either be negative or greater than it actually is.</td>
 </tr>
 <tr>
  <td><code>prev_content</code></td>
  <td><code>EventContent</code></td>
  <td>
    The previous <code>content</code> for this event. This field is generated
by the local homeserver, and is only returned if the event is a state event,
and the client has permission to see the previous content.<br><br>
    <strong>
      Changed in <code>v1.2</code>:
    </strong>
    Previously, this field was specified at the top level of returned
events rather than in <code>unsigned</code> (with the exception of the <a href="/client-server-api/#get_matrixclientv3notifications"><code>GET .../notifications</code></a>
endpoint), though in practice no known server implementations honoured
this.
</td>
 </tr>
 <tr>
  <td><code>redacted_because</code></td>
  <td><code>ClientEvent</code></td>
  <td>
    The event that redacted this event, if any.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    The client-supplied <a href="/client-server-api/#transaction-identifiers">transaction ID</a>, for example, provided via
<code>PUT /_matrix/client/v3/rooms/{roomId}/send/{eventType}/{txnId}</code>,
if the client being given the event is the same one which sent it.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;chunk&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/SEsfnsuifSDFSSEF&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;displayname&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice Margatroid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;join&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;Looking for support&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3roomsroomidstate">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/rooms/{roomId}/state</span>
  </h1>
</summary>
  <hr/>
<p>Get the state events for the current state of a room.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room to look up the state for.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The current state of the room</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>You aren&rsquo;t a member of the room and weren&rsquo;t previously a member of the room.</td>
 </tr>
</table>
<h3>200 response</h3>
<p>Array of <code>ClientEvent</code>.</p>
<table id="_matrixclientv3roomsroomidstate_clientevent" class="object-table">
 <caption>ClientEvent</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The body of this event, as created by the client which sent it.</td>
 </tr>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The globally unique identifier for this event.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>Timestamp (in milliseconds since the unix epoch) on originating homeserver
when this event was sent.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room associated with this event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Contains the fully-qualified ID of the user who sent this event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <p>Present if, and only if, this event is a <em>state</em> event. The key making
this piece of state unique in the room. Note that it is often an empty
string.</p>
<p>State keys starting with an <code>@</code> are reserved for referencing user IDs, such
as room members. With the exception of a few events, state events set with a
given user&rsquo;s ID as the state key MUST only be set by that user.</p>
</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of the event.</td>
 </tr>
 <tr>
  <td><code>unsigned</code></td>
  <td><code>UnsignedData</code></td>
  <td>
    Contains optional extra information about the event.</td>
 </tr>
</table>
<table id="_matrixclientv3roomsroomidstate_unsigneddata" class="object-table">
 <caption>UnsignedData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>age</code></td>
  <td><code>integer</code></td>
  <td>
    The time in milliseconds that has elapsed since the event was sent. This field is generated by the local homeserver, and may be incorrect if the local time on at least one of the two servers is out of sync, which can cause the age to either be negative or greater than it actually is.</td>
 </tr>
 <tr>
  <td><code>prev_content</code></td>
  <td><code>EventContent</code></td>
  <td>
    The previous <code>content</code> for this event. This field is generated
by the local homeserver, and is only returned if the event is a state event,
and the client has permission to see the previous content.<br><br>
    <strong>
      Changed in <code>v1.2</code>:
    </strong>
    Previously, this field was specified at the top level of returned
events rather than in <code>unsigned</code> (with the exception of the <a href="/client-server-api/#get_matrixclientv3notifications"><code>GET .../notifications</code></a>
endpoint), though in practice no known server implementations honoured
this.
</td>
 </tr>
 <tr>
  <td><code>redacted_because</code></td>
  <td><code>ClientEvent</code></td>
  <td>
    The event that redacted this event, if any.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    The client-supplied <a href="/client-server-api/#transaction-identifiers">transaction ID</a>, for example, provided via
<code>PUT /_matrix/client/v3/rooms/{roomId}/send/{eventType}/{txnId}</code>,
if the client being given the event is the same one which sent it.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;join_rule&#34;</span><span class="p">:</span> <span class="s2">&#34;public&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.join_rules&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/SEsfnsuifSDFSSEF&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;displayname&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice Margatroid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;join&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;Looking for support&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;m.federate&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;predecessor&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$something:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!oldroom:example.org&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_version&#34;</span><span class="p">:</span> <span class="s2">&#34;11&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.create&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;ban&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;events&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;m.room.name&#34;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;m.room.power_levels&#34;</span><span class="p">:</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;events_default&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;invite&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;kick&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;notifications&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;room&#34;</span><span class="p">:</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;redact&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;state_default&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;users&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;@example:localhost&#34;</span><span class="p">:</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;users_default&#34;</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.power_levels&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3roomsroomidstateeventtypestatekey">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/rooms/{roomId}/state/{eventType}/{stateKey}</span>
  </h1>
</summary>
  <hr/>
<p>Looks up the contents of a state event in a room. If the user is
joined to the room then the state is taken from the current
state of the room. If the user has left the room then the state is
taken from the state of the room when they left.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>eventType</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of state to look up.</td>
 </tr>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room to look up the state in.</td>
 </tr>
 <tr>
  <td><code>stateKey</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The key of the state to look up. Defaults to an empty string. When
an empty string, the trailing slash on this endpoint is optional.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The content of the state event.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>You aren&rsquo;t a member of the room and weren&rsquo;t previously a member of the room.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The room has no state with the given type or key.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Example room name&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3roomsroomidmessages">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/rooms/{roomId}/messages</span>
  </h1>
</summary>
  <hr/>
<p><p>This API returns a list of message and state events for a room. It uses
pagination query parameters to paginate history in the room.</p>
<p><em>Note</em>: This endpoint supports lazy-loading of room member events. See
<a href="/client-server-api/#lazy-loading-room-members">Lazy-loading room members</a> for more information.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room to get events from.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>dir</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The direction to return events from. If this is set to <code>f</code>, events
will be returned in chronological order starting at <code>from</code>. If it
is set to <code>b</code>, events will be returned in <em>reverse</em> chronological
order, again starting at <code>from</code>.<p>One of: <code>[b, f]</code>.</p></td>
 </tr>
 <tr>
  <td><code>filter</code></td>
  <td><code>string</code></td>
  <td>
    A JSON RoomEventFilter to filter returned events with.</td>
 </tr>
 <tr>
  <td><code>from</code></td>
  <td><code>string</code></td>
  <td>
    <p>The token to start returning events from. This token can be obtained
from a <code>prev_batch</code> or <code>next_batch</code> token returned by the <code>/sync</code> endpoint,
or from an <code>end</code> token returned by a previous request to this endpoint.</p>
<p>This endpoint can also accept a value returned as a <code>start</code> token
by a previous request to this endpoint, though servers are not
required to support this. Clients should not rely on the behaviour.</p>
<p>If it is not provided, the homeserver shall return a list of messages
from the first or last (per the value of the <code>dir</code> parameter) visible
event in the room history for the requesting user.</p>
<br><br>
    <strong>
      Changed in <code>v1.3</code>:
    </strong>
    Previously, this field was required and paginating from the first or
last visible event in the room history wasn&rsquo;t supported.
</td>
 </tr>
 <tr>
  <td><code>limit</code></td>
  <td><code>integer</code></td>
  <td>
    The maximum number of events to return. Default: 10.</td>
 </tr>
 <tr>
  <td><code>to</code></td>
  <td><code>string</code></td>
  <td>
    The token to stop returning events at. This token can be obtained from
a <code>prev_batch</code> or <code>next_batch</code> token returned by the <code>/sync</code> endpoint,
or from an <code>end</code> token returned by a previous request to this endpoint.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>A list of messages with a new token to request more.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>You aren&rsquo;t a member of the room.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>chunk</code></td>
  <td><code>[ClientEvent]</code></td>
  <td>
    <strong>Required: </strong><p>A list of room events. The order depends on the <code>dir</code> parameter.
For <code>dir=b</code> events will be in reverse-chronological order,
for <code>dir=f</code> in chronological order. (The exact definition of <code>chronological</code>
is dependent on the server implementation.)</p>
<p>Note that an empty <code>chunk</code> does not <em>necessarily</em> imply that no more events
are available. Clients should continue to paginate until no <code>end</code> property
is returned.</p>
</td>
 </tr>
 <tr>
  <td><code>end</code></td>
  <td><code>string</code></td>
  <td>
    <p>A token corresponding to the end of <code>chunk</code>. This token can be passed
back to this endpoint to request further events.</p>
<p>If no further events are available (either because we have
reached the start of the timeline, or because the user does
not have permission to see any more events), this property
is omitted from the response.</p>
</td>
 </tr>
 <tr>
  <td><code>start</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A token corresponding to the start of <code>chunk</code>. This will be the same as
the value given in <code>from</code>.</td>
 </tr>
 <tr>
  <td><code>state</code></td>
  <td><code>[ClientEvent]</code></td>
  <td>
    <p>A list of state events relevant to showing the <code>chunk</code>. For example, if
<code>lazy_load_members</code> is enabled in the filter then this may contain
the membership events for the senders of events in the <code>chunk</code>.</p>
<p>Unless <code>include_redundant_members</code> is <code>true</code>, the server
may remove membership events which would have already been
sent to the client in prior calls to this endpoint, assuming
the membership of those members has not changed.</p>
</td>
 </tr>
</table>
<table id="_matrixclientv3roomsroomidmessages_clientevent" class="object-table">
 <caption>ClientEvent</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The body of this event, as created by the client which sent it.</td>
 </tr>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The globally unique identifier for this event.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>Timestamp (in milliseconds since the unix epoch) on originating homeserver
when this event was sent.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room associated with this event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Contains the fully-qualified ID of the user who sent this event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <p>Present if, and only if, this event is a <em>state</em> event. The key making
this piece of state unique in the room. Note that it is often an empty
string.</p>
<p>State keys starting with an <code>@</code> are reserved for referencing user IDs, such
as room members. With the exception of a few events, state events set with a
given user&rsquo;s ID as the state key MUST only be set by that user.</p>
</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of the event.</td>
 </tr>
 <tr>
  <td><code>unsigned</code></td>
  <td><code>UnsignedData</code></td>
  <td>
    Contains optional extra information about the event.</td>
 </tr>
</table>
<table id="_matrixclientv3roomsroomidmessages_unsigneddata" class="object-table">
 <caption>UnsignedData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>age</code></td>
  <td><code>integer</code></td>
  <td>
    The time in milliseconds that has elapsed since the event was sent. This field is generated by the local homeserver, and may be incorrect if the local time on at least one of the two servers is out of sync, which can cause the age to either be negative or greater than it actually is.</td>
 </tr>
 <tr>
  <td><code>prev_content</code></td>
  <td><code>EventContent</code></td>
  <td>
    The previous <code>content</code> for this event. This field is generated
by the local homeserver, and is only returned if the event is a state event,
and the client has permission to see the previous content.<br><br>
    <strong>
      Changed in <code>v1.2</code>:
    </strong>
    Previously, this field was specified at the top level of returned
events rather than in <code>unsigned</code> (with the exception of the <a href="/client-server-api/#get_matrixclientv3notifications"><code>GET .../notifications</code></a>
endpoint), though in practice no known server implementations honoured
this.
</td>
 </tr>
 <tr>
  <td><code>redacted_because</code></td>
  <td><code>ClientEvent</code></td>
  <td>
    The event that redacted this event, if any.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    The client-supplied <a href="/client-server-api/#transaction-identifiers">transaction ID</a>, for example, provided via
<code>PUT /_matrix/client/v3/rooms/{roomId}/send/{eventType}/{txnId}</code>,
if the client being given the event is the same one which sent it.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;chunk&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;This is an example text message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;org.matrix.custom.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;formatted_body&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;b&gt;This is an example text message&lt;/b&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;The room name&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.name&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;Gangnam Style&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;info&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;duration&#34;</span><span class="p">:</span> <span class="mi">2140786</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;h&#34;</span><span class="p">:</span> <span class="mi">320</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;mimetype&#34;</span><span class="p">:</span> <span class="s2">&#34;video/mp4&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">1563685</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;thumbnail_info&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;h&#34;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;mimetype&#34;</span><span class="p">:</span> <span class="s2">&#34;image/jpeg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">46144</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;w&#34;</span><span class="p">:</span> <span class="mi">300</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;thumbnail_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/FHyPlCeYUSFFxlgbQYZmoEoe&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;w&#34;</span><span class="p">:</span> <span class="mi">480</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.video&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/a526eYUSFFxlgbQYZmo442&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;end&#34;</span><span class="p">:</span> <span class="s2">&#34;t47409-4357353_219380_26003_2265&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;start&#34;</span><span class="p">:</span> <span class="s2">&#34;t47429-4392820_219380_26003_2265&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv1roomsroomidtimestamp_to_event">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v1/rooms/{roomId}/timestamp_to_event</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.6</code></strong></p>
<p><p>Get the ID of the event closest to the given timestamp, in the
direction specified by the <code>dir</code> parameter.</p>
<p>If the server does not have all of the room history and does not have
an event suitably close to the requested timestamp, it can use the
corresponding <a href="/server-server-api/#get_matrixfederationv1timestamp_to_eventroomid">federation endpoint</a>
to ask other servers for a suitable event.</p>
<p>After calling this endpoint, clients can call
<a href="#get_matrixclientv3roomsroomidcontexteventid"><code>/rooms/{roomId}/context/{eventId}</code></a>
to obtain a pagination token to retrieve the events around the returned event.</p>
<p>The event returned by this endpoint could be an event that the client
cannot render, and so may need to paginate in order to locate an event
that it can display, which may end up being outside of the client&rsquo;s
suitable range.  Clients can employ different strategies to display
something reasonable to the user.  For example, the client could try
paginating in one direction for a while, while looking at the
timestamps of the events that it is paginating through, and if it
exceeds a certain difference from the target timestamp, it can try
paginating in the opposite direction.  The client could also simply
paginate in one direction and inform the user that the closest event
found in that direction is outside of the expected range.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room to search</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>dir</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The direction in which to search.  <code>f</code> for forwards, <code>b</code> for backwards.<p>One of: <code>[f, b]</code>.</p></td>
 </tr>
 <tr>
  <td><code>ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The timestamp to search from, as given in milliseconds
since the Unix epoch.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>An event was found matching the search parameters.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>No event was found.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the event found</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The event&rsquo;s timestamp, in milliseconds since the Unix epoch.
This makes it easy to do a quick comparison to see if the
<code>event_id</code> fetched is too far out of range to be useful for your
use case.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv1roomsroomidtimestamp_to_event_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Unable to find event from 1432684800000 in forward direction&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv1roomsroomidtimestamp_to_event_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3roomsroomidinitialsync">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint deprecated-inline">/_matrix/client/v3/rooms/{roomId}/initialSync</span>
  </h1>
</summary>
  <hr/>
<div class="alert warning omit-title" role="alert">
This API is deprecated and will be removed from a future release.
</div>
<p><p>Get a copy of the current state and the most recent messages in a room.</p>
<p>This endpoint was deprecated in r0 of this specification. There is no
direct replacement; the relevant information is returned by the
<a href="/client-server-api/#get_matrixclientv3sync"><code>/sync</code></a> API. See the
<a href="https://matrix.org/docs/guides/migrating-from-client-server-api-v-1#deprecated-endpoints">migration guide</a>.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room to get the data.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The current state of the room</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>You aren&rsquo;t a member of the room and weren&rsquo;t previously a member of the room.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="_matrixclientv3roomsroomidinitialsync_roominfo" class="object-table">
 <caption>RoomInfo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>account_data</code></td>
  <td><code>[Event]</code></td>
  <td>
    The private data that this user has attached to this room.</td>
 </tr>
 <tr>
  <td><code>membership</code></td>
  <td><code>string</code></td>
  <td>
    The user&rsquo;s membership state in this room.<p>One of: <code>[invite, join, leave, ban]</code>.</p></td>
 </tr>
 <tr>
  <td><code>messages</code></td>
  <td><code>PaginationChunk</code></td>
  <td>
    The pagination chunk for this room.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of this room.</td>
 </tr>
 <tr>
  <td><code>state</code></td>
  <td><code>[ClientEvent]</code></td>
  <td>
    If the user is a member of the room this will be the
current state of the room as a list of events. If the
user has left the room this will be the state of the
room when they left it.</td>
 </tr>
 <tr>
  <td><code>visibility</code></td>
  <td><code>string</code></td>
  <td>
    Whether this room is visible to the <code>/publicRooms</code> API
or not.&quot;<p>One of: <code>[private, public]</code>.</p></td>
 </tr>
</table>
<table id="_matrixclientv3roomsroomidinitialsync_event" class="object-table">
 <caption>Event</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The fields in this object will vary depending on the type of event. When interacting with the REST API, this is the HTTP body.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of event. This SHOULD be namespaced similar to Java package naming conventions e.g. &lsquo;com.example.subdomain.event.type&rsquo;</td>
 </tr>
</table>
<table id="_matrixclientv3roomsroomidinitialsync_paginationchunk" class="object-table">
 <caption>PaginationChunk</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>chunk</code></td>
  <td><code>[ClientEvent]</code></td>
  <td>
    <strong>Required: </strong>If the user is a member of the room this will be a
list of the most recent messages for this room. If
the user has left the room this will be the
messages that preceded them leaving. This array
will consist of at most <code>limit</code> elements.</td>
 </tr>
 <tr>
  <td><code>end</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A token which correlates to the end of <code>chunk</code>. Can be passed to
<a href="#get_matrixclientv3roomsroomidmessages"><code>/rooms/&lt;room_id&gt;/messages</code></a>
to retrieve later events.</td>
 </tr>
 <tr>
  <td><code>start</code></td>
  <td><code>string</code></td>
  <td>
    <p>A token which correlates to the start of <code>chunk</code>. Can be passed to
<a href="#get_matrixclientv3roomsroomidmessages"><code>/rooms/&lt;room_id&gt;/messages</code></a>
to retrieve earlier events.</p>
<p>If no earlier events are available, this property may be omitted from
the response.</p>
</td>
 </tr>
</table>
<table id="_matrixclientv3roomsroomidinitialsync_clientevent" class="object-table">
 <caption>ClientEvent</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The body of this event, as created by the client which sent it.</td>
 </tr>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The globally unique identifier for this event.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>Timestamp (in milliseconds since the unix epoch) on originating homeserver
when this event was sent.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room associated with this event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Contains the fully-qualified ID of the user who sent this event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <p>Present if, and only if, this event is a <em>state</em> event. The key making
this piece of state unique in the room. Note that it is often an empty
string.</p>
<p>State keys starting with an <code>@</code> are reserved for referencing user IDs, such
as room members. With the exception of a few events, state events set with a
given user&rsquo;s ID as the state key MUST only be set by that user.</p>
</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of the event.</td>
 </tr>
 <tr>
  <td><code>unsigned</code></td>
  <td><code>UnsignedData</code></td>
  <td>
    Contains optional extra information about the event.</td>
 </tr>
</table>
<table id="_matrixclientv3roomsroomidinitialsync_unsigneddata" class="object-table">
 <caption>UnsignedData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>age</code></td>
  <td><code>integer</code></td>
  <td>
    The time in milliseconds that has elapsed since the event was sent. This field is generated by the local homeserver, and may be incorrect if the local time on at least one of the two servers is out of sync, which can cause the age to either be negative or greater than it actually is.</td>
 </tr>
 <tr>
  <td><code>prev_content</code></td>
  <td><code>EventContent</code></td>
  <td>
    The previous <code>content</code> for this event. This field is generated
by the local homeserver, and is only returned if the event is a state event,
and the client has permission to see the previous content.<br><br>
    <strong>
      Changed in <code>v1.2</code>:
    </strong>
    Previously, this field was specified at the top level of returned
events rather than in <code>unsigned</code> (with the exception of the <a href="/client-server-api/#get_matrixclientv3notifications"><code>GET .../notifications</code></a>
endpoint), though in practice no known server implementations honoured
this.
</td>
 </tr>
 <tr>
  <td><code>redacted_because</code></td>
  <td><code>ClientEvent</code></td>
  <td>
    The event that redacted this event, if any.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    The client-supplied <a href="/client-server-api/#transaction-identifiers">transaction ID</a>, for example, provided via
<code>PUT /_matrix/client/v3/rooms/{roomId}/send/{eventType}/{txnId}</code>,
if the client being given the event is the same one which sent it.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;account_data&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;tags&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;work&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;order&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.tag&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;join&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;messages&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;chunk&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;This is an example text message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;org.matrix.custom.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;formatted_body&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;b&gt;This is an example text message&lt;/b&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;something-important.doc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;filename&#34;</span><span class="p">:</span> <span class="s2">&#34;something-important.doc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;info&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;mimetype&#34;</span><span class="p">:</span> <span class="s2">&#34;application/msword&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">46144</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.file&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/FHyPlCeYUSFFxlgbQYZmoEoe&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;end&#34;</span><span class="p">:</span> <span class="s2">&#34;s3456_9_0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;start&#34;</span><span class="p">:</span> <span class="s2">&#34;t44-3453_9_0&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;join_rule&#34;</span><span class="p">:</span> <span class="s2">&#34;public&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.join_rules&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/SEsfnsuifSDFSSEF&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;displayname&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice Margatroid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;join&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;Looking for support&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;m.federate&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;predecessor&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$something:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!oldroom:example.org&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;room_version&#34;</span><span class="p">:</span> <span class="s2">&#34;11&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.create&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ban&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;events&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;m.room.name&#34;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;m.room.power_levels&#34;</span><span class="p">:</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;events_default&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;invite&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;kick&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;notifications&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;room&#34;</span><span class="p">:</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;redact&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;state_default&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;users&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;@example:localhost&#34;</span><span class="p">:</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;users_default&#34;</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.power_levels&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;visibility&#34;</span><span class="p">:</span> <span class="s2">&#34;private&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h3 id="sending-events-to-a-room">Sending events to a room</h3>
<div class="alert note " role="alert">
<p><span><strong>[Added in <code>v1.3</code>]</strong></span></p>
<p>Servers might need to post-process some events if they
<a href="#forming-relationships-between-events">relate to</a> another event. The event&rsquo;s
relationship type (<code>rel_type</code>) determines any restrictions which might apply,
such as the user only being able to send one event of a given type in relation
to another.</p>
</div>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixclientv3roomsroomidstateeventtypestatekey">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/client/v3/rooms/{roomId}/state/{eventType}/{stateKey}</span>
  </h1>
</summary>
  <hr/>
<p><p>State events can be sent using this endpoint.  These events will be
overwritten if <code>&lt;room id&gt;</code>, <code>&lt;event type&gt;</code> and <code>&lt;state key&gt;</code> all
match.</p>
<p>Requests to this endpoint <strong>cannot use transaction IDs</strong>
like other <code>PUT</code> paths because they cannot be differentiated from the
<code>state_key</code>. Furthermore, <code>POST</code> is unsupported on state paths.</p>
<p>The body of the request should be the content object of the event; the
fields in this object will vary depending on the type of event. See
<a href="/client-server-api/#room-events">Room Events</a> for the <code>m.</code> event specification.</p>
<p>If the event type being sent is <code>m.room.canonical_alias</code> servers
SHOULD ensure that any new aliases being listed in the event are valid
per their grammar/syntax and that they point to the room ID where the
state event is to be sent. Servers do not validate aliases which are
being removed or are already present in the state event.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>eventType</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of event to send.</td>
 </tr>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room to set the state in</td>
 </tr>
 <tr>
  <td><code>stateKey</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The state_key for the state to send. Defaults to the empty string. When
an empty string, the trailing slash on this endpoint is optional.</td>
 </tr>
</table>
<h3>Request body</h3>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://localhost/SEsfnsuifSDFSSEF&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;displayname&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice Margatroid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;join&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>An ID for the sent event.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td><p>The sender&rsquo;s request is malformed.</p>
<p>Some example error codes include:</p>
<ul>
<li>
<p><code>M_INVALID_PARAM</code>: One or more aliases within the <code>m.room.canonical_alias</code>
event have invalid syntax.</p>
</li>
<li>
<p><code>M_BAD_ALIAS</code>: One or more aliases within the <code>m.room.canonical_alias</code> event
do not point to the room ID for which the state event is to be sent to.</p>
</li>
</ul>
</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The sender doesn&rsquo;t have permission to send the event into the room.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A unique identifier for the event.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$YUwRidLecu:example.com&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3roomsroomidstateeventtypestatekey_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_BAD_ALIAS&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;The alias &#39;#hello:example.org&#39; does not point to this room.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3roomsroomidstateeventtypestatekey_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;You do not have permission to send the event.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<p><strong>Examples</strong></p>
<p>Valid requests look like:</p>
<pre tabindex="0"><code>PUT /rooms/!roomid:domain/state/m.example.event
{ &#34;key&#34; : &#34;without a state key&#34; }
</code></pre><pre tabindex="0"><code>PUT /rooms/!roomid:domain/state/m.another.example.event/foo
{ &#34;key&#34; : &#34;with &#39;foo&#39; as the state key&#34; }
</code></pre><p>In contrast, these requests are invalid:</p>
<pre tabindex="0"><code>POST /rooms/!roomid:domain/state/m.example.event/
{ &#34;key&#34; : &#34;cannot use POST here&#34; }
</code></pre><pre tabindex="0"><code>PUT /rooms/!roomid:domain/state/m.another.example.event/foo/11
{ &#34;key&#34; : &#34;txnIds are not supported&#34; }
</code></pre><p>Care should be taken to avoid setting the wrong <code>state key</code>:</p>
<pre tabindex="0"><code>PUT /rooms/!roomid:domain/state/m.another.example.event/11
{ &#34;key&#34; : &#34;with &#39;11&#39; as the state key, but was probably intended to be a txnId&#34; }
</code></pre><p>The <code>state_key</code> is often used to store state about individual users, by
using the user ID as the <code>state_key</code> value. For example:</p>
<pre tabindex="0"><code>PUT /rooms/!roomid:domain/state/m.favorite.animal.event/%40my_user%3Aexample.org
{ &#34;animal&#34; : &#34;cat&#34;, &#34;reason&#34;: &#34;fluffy&#34; }
</code></pre><p>In some cases, there may be no need for a <code>state_key</code>, so it can be
omitted:</p>
<pre tabindex="0"><code>PUT /rooms/!roomid:domain/state/m.room.bgd.color
{ &#34;color&#34;: &#34;red&#34;, &#34;hex&#34;: &#34;#ff0000&#34; }
</code></pre><section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixclientv3roomsroomidsendeventtypetxnid">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/client/v3/rooms/{roomId}/send/{eventType}/{txnId}</span>
  </h1>
</summary>
  <hr/>
<p><p>This endpoint is used to send a message event to a room. Message events
allow access to historical events and pagination, making them suited
for &ldquo;once-off&rdquo; activity in a room.</p>
<p>The body of the request should be the content object of the event; the
fields in this object will vary depending on the type of event. See
<a href="/client-server-api/#room-events">Room Events</a> for the m. event specification.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>eventType</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of event to send.</td>
 </tr>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room to send the event to.</td>
 </tr>
 <tr>
  <td><code>txnId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <a href="/client-server-api/#transaction-identifiers">transaction ID</a> for this event. Clients should generate an
ID unique across requests with the same access token; it will be
used by the server to ensure idempotency of requests.</td>
 </tr>
</table>
<h3>Request body</h3>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;hello&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>An ID for the sent event.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td><p>The request is invalid. A <a href="/client-server-api/#standard-error-response">standard error response</a>
will be returned. As well as the normal common error codes, other reasons for rejection include:</p>
<ul>
<li><code>M_DUPLICATE_ANNOTATION</code>: The request is an attempt to send a <a href="/client-server-api/#avoiding-duplicate-annotations">duplicate annotation</a>.</li>
</ul>
</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A unique identifier for the event.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$YUwRidLecu:example.com&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3roomsroomidsendeventtypetxnid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_UNKNOWN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;An unknown error occurred&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h3 id="redactions">Redactions</h3>
<p>Since events are extensible it is possible for malicious users and/or
servers to add keys that are, for example offensive or illegal. Since
some events cannot be simply deleted, e.g. membership events, we instead
&lsquo;redact&rsquo; events. This involves removing all keys from an event that are
not required by the protocol. This stripped down event is thereafter
returned anytime a client or remote server requests it. Redacting an
event cannot be undone, allowing server owners to delete the offending
content from the databases. Servers should include a copy of the
<code>m.room.redaction</code> event under <code>unsigned</code> as <code>redacted_because</code>
when serving the redacted event to clients.</p>
<p>The exact algorithm to apply against an event is defined in the <a href="/rooms">room
version specification</a>, as are the criteria homeservers should
use when deciding whether to accept a redaction event from a remote
homeserver.</p>
<p>When a client receives an <code>m.room.redaction</code> event, it should change
the affected event in the same way a server does.</p>
<div class="alert note " role="alert">
Redacted events can still affect the state of the room. When redacted,
state events behave as though their properties were simply not
specified, except those protected by the redaction algorithm. For
example, a redacted <code>join</code> event will still result in the user being
considered joined. Similarly, a redacted topic does not necessarily
cause the topic to revert to what it was prior to the event - it causes
the topic to be removed from the room.
</div>
<h4 id="events-1">Events</h4>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mroomredaction">
   <code>m.room.redaction</code>
  </h1>
</summary>
  <hr/>
<p>This event is created by the server to describe which event has been redacted, by whom, and optionally why. The event that has been redacted is specified in the <code>redacts</code> event level key. Redacting an event means that all keys not required by the protocol are stripped off, allowing messages to be hidden or allowing admins to remove offensive or illegal content.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>reason</code></td>
  <td><code>string</code></td>
  <td>
    The reason for the redaction, if any.</td>
 </tr>
 <tr>
  <td><code>redacts</code></td>
  <td><code>string</code></td>
  <td>
    The event ID that was redacted. Required for, and present starting in, room version 11.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;Spamming&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;redacts&#34;</span><span class="p">:</span> <span class="s2">&#34;$fukweghifu23:localhost&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.redaction&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h4 id="client-behaviour">Client behaviour</h4>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixclientv3roomsroomidredacteventidtxnid">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/client/v3/rooms/{roomId}/redact/{eventId}/{txnId}</span>
  </h1>
</summary>
  <hr/>
<p><p>Strips all information out of an event which isn&rsquo;t critical to the
integrity of the server-side representation of the room.</p>
<p>This cannot be undone.</p>
<p>Any user with a power level greater than or equal to the <code>m.room.redaction</code>
event power level may send redaction events in the room. If the user&rsquo;s power
level greater is also greater than or equal to the <code>redact</code> power level
of the room, the user may redact events sent by other users.</p>
<p>Server administrators may redact events sent by users on their server.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>eventId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the event to redact</td>
 </tr>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room from which to redact the event.</td>
 </tr>
 <tr>
  <td><code>txnId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <a href="/client-server-api/#transaction-identifiers">transaction ID</a> for this event. Clients should generate a
unique ID; it will be used by the server to ensure idempotency of requests.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>reason</code></td>
  <td><code>string</code></td>
  <td>
    The reason for the event being redacted.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;Indecent material&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>An ID for the redaction event.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    A unique identifier for the event.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$YUwQidLecu:example.com&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h3 id="forming-relationships-between-events">Forming relationships between events</h3>
<p><span><strong>[Changed in <code>v1.3</code>]</strong></span></p>
<p>In some cases it is desirable to logically associate one event&rsquo;s contents with
another event&rsquo;s contents  for example, when replying to a message, editing an
event, or simply looking to add context for an event&rsquo;s purpose.</p>
<p>Events are related to each other in a parent/child structure, where any event can
become a parent by simply having a child event point at it. Parent events do not
define their children, instead relying on the children to describe their parent.</p>
<p>The relationship between a child and its parent event is described in the child
event&rsquo;s <code>content</code> as <code>m.relates_to</code> (defined below). A child event can point at
any other event, including another child event, to build the relationship so long
as both events are in the same room, however additional restrictions might be imposed
by the type of the relationship (the <code>rel_type</code>).</p>
<div class="alert note " role="alert">
Child events can point at other child events, forming a chain of events. These chains
can naturally take the shape of a tree if two independent children point at a single
parent event, for example.
</div>
<p>To allow the server to aggregate and find child events for a parent, the <code>m.relates_to</code>
key of an event MUST be included in the cleartext portion of the event. It cannot be
exclusively recorded in the encrypted payload as the server cannot decrypt the event
for processing.</p>
<div class="alert warning " role="alert">
If an encrypted event contains an <code>m.relates_to</code> in its payload, it should be
ignored and instead favour the cleartext <code>m.relates_to</code> copy (including when there
is no cleartext copy). This is to ensure the client&rsquo;s behaviour matches the server&rsquo;s
capability to handle relationships.
</div>
<p>Relationships which don&rsquo;t match the schema, or which break the rules of a relationship,
are simply ignored. An example might be the parent and child being in different
rooms, or the relationship missing properties required by the schema below. Clients
handling such invalid relationships should show the events independently of each
other, optionally with an error message.</p>
<p><code>m.relates_to</code> is defined as follows:</p>
<section class="rendered-data definition" id="definition-mrelates_to">
<details open>
<summary>
<h1>
 <code>m.relates_to</code>
</h1>
</summary>
<hr/>
<p>Describes the relationship of an event to its parent. This is contained
within the events <code>content</code> alongside other fields for the relevant event type.</p>
<table class="object-table">
 <caption>m.relates_to</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The event ID of the event that this event relates to.</td>
 </tr>
 <tr>
  <td><code>rel_type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><p>The namespaced relationship type. Values must use the
<a href="/appendices/#common-namespaced-identifier-grammar">Common Namespaced Identifier Grammar</a>.</p>
<p>The relationship type determines how clients should perceive the event, and in what
context. Some relationship types are processed server-side for &ldquo;bundling&rdquo;, though not
all relationships require such behaviour. For example, an <a href="/client-server-api/#threading"><code>m.thread</code> relationship type</a>
denotes that the event is part of a &ldquo;thread&rdquo; of messages and should be rendered as
such.</p>
</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;m.relates_to&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$an_event&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;rel_type&#34;</span><span class="p">:</span> <span class="s2">&#34;org.example.relationship&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h4 id="relationship-types">Relationship types</h4>
<p>This specification describes the following relationship types:</p>
<ul>
<li><a href="#rich-replies">Rich replies</a> (<strong>Note</strong>: does not use <code>rel_type</code>).</li>
<li><a href="#event-replacements">Event replacements</a>.</li>
<li><a href="#event-annotations-and-reactions">Event annotations</a>.</li>
<li><a href="#threading">Threads</a>.</li>
<li><a href="#reference-relations">References</a></li>
</ul>
<h4 id="aggregations-of-child-events">Aggregations of child events</h4>
<p><span><strong>[Added in <code>v1.3</code>]</strong></span></p>
<p>Some child events can be &ldquo;aggregated&rdquo; by the server, depending on their
<code>rel_type</code>. This can allow a set of child events to be summarised to the client without
the client needing the child events themselves.</p>
<p>An example of this might be that a <code>rel_type</code> requires an extra <code>key</code> field which, when
appropriately specified, would mean that the client receives a total count for the number
of times that <code>key</code> was used by child events.</p>
<p>The actual aggregation format depends on the <code>rel_type</code>.</p>
<p>When an event is served to the client through the APIs listed below, a
<code>m.relations</code> property is included under <code>unsigned</code> if the event has child
events which can be aggregated and point at it. The <code>m.relations</code> property is
an object keyed by <code>rel_type</code> and value being the type-specific aggregated
format for that <code>rel_type</code>. This <code>m.relations</code> property is known as a &ldquo;bundled
aggregation&rdquo;.</p>
<p>For example (unimportant fields not included):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$my_event&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.relations&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;org.example.possible_annotations&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1562763768320</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;count&#34;</span><span class="p">:</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1562763768320</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;count&#34;</span><span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;org.example.possible_thread&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;current_server_participated&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;count&#34;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;latest_event&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$another_event&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;Hello world&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Note how the <code>org.example.possible_annotations</code> aggregation is an array, while in the
<code>org.example.possible_thread</code> aggregation where the server is summarising the state of
the relationship in a single object. Both are valid ways to aggregate: the format of an
aggregation depends on the <code>rel_type</code>.</p>
<div class="alert warning " role="alert">
State events do not currently receive bundled aggregations. This is not
necessarily a deliberate design decision, and MSCs which aim to fix this are welcome.
</div>
<p>The endpoints where the server <em>should</em> include bundled aggregations are:</p>
<ul>
<li><a href="#get_matrixclientv3roomsroomidmessages"><code>GET /rooms/{roomId}/messages</code></a></li>
<li><a href="#get_matrixclientv3roomsroomidcontexteventid"><code>GET /rooms/{roomId}/context/{eventId}</code></a></li>
<li><a href="#get_matrixclientv3roomsroomideventeventid"><code>GET /rooms/{roomId}/event/{eventId}</code></a></li>
<li><a href="#get_matrixclientv1roomsroomidrelationseventid"><code>GET /rooms/{roomId}/relations/{eventId}</code></a></li>
<li><a href="#get_matrixclientv1roomsroomidrelationseventidreltype"><code>GET /rooms/{roomId}/relations/{eventId}/{relType}</code></a></li>
<li><a href="#get_matrixclientv1roomsroomidrelationseventidreltypeeventtype"><code>GET /rooms/{roomId}/relations/{eventId}/{relType}/{eventType}</code></a></li>
<li><a href="#get_matrixclientv3sync"><code>GET /sync</code></a> when the relevant section has a <code>limited</code> value
of <code>true</code>.</li>
<li><a href="#post_matrixclientv3search"><code>POST /search</code></a> for any matching events under <code>room_events</code>.</li>
<li>



  <span><strong>[Added in <code>v1.4</code>]</strong></span>
 
 <a href="#get_matrixclientv1roomsroomidthreads"><code>GET /rooms/{roomId}/threads</code></a></li>
</ul>
<div class="alert note " role="alert">
The server is <strong>not</strong> required to return bundled aggregations on deprecated endpoints
such as <code>/initialSync</code>.
</div>
<p>While this functionality allows the client to see what was known to the server at the
time of handling, the client should continue to aggregate locally if it is aware of
the relationship type&rsquo;s behaviour. For example, a client might internally increment a <code>count</code>
in a parent event&rsquo;s aggregation data if it saw a new child event which referenced that parent.</p>
<p>The aggregation provided by the server only includes child events which were known at the
time the client would receive the aggregation. For example, in a single <code>/sync</code> response
with the parent and multiple child events the child events would have already been
included on the parent&rsquo;s <code>m.relations</code> field. Events received in future syncs would
need to be aggregated manually by the client.</p>
<div class="alert note " role="alert">
Events from <a href="#ignoring-users">ignored users</a> do not appear in the aggregation
from the server, however clients might still have events from ignored users cached. Like
with normal events, clients will need to de-aggregate child events sent by ignored users to
avoid them being considered in counts. Servers must additionally ensure they do not
consider child events from ignored users when preparing an aggregation for the client.
</div>
<p>When a parent event is redacted, the child events which pointed to that parent remain, however
when a child event is redacted then the relationship is broken. Therefore, the server needs
to de-aggregate or disassociate the event once the relationship is lost. Clients with local
aggregation or which handle redactions locally should do the same.</p>
<p>It is suggested that clients perform local echo on aggregations  for instance, aggregating
a new child event into a parent event optimistically until the server returns a failure or the client
gives up on sending the event, at which point the event should be de-aggregated and an
error or similar shown. The client should be cautious to not aggregate an event twice if
it has already optimistically aggregated the event. Clients are encouraged to take this
a step further to additionally track child events which target unsent/pending events,
likely using the transaction ID as a temporary event ID until a proper event ID is known.</p>
<div class="alert warning " role="alert">
<p>Due to history visibility restrictions, child events might not be visible to the user
if they are in a section of history the user cannot see. This means any aggregations which would
normally include those events will be lacking them and the client will not be able to
locally aggregate the events either  relating events of importance (such as votes) should
take into consideration history visibility.</p>
<p>Additionally, if the server is missing portions of the room history then it may not be
able to accurately aggregate the events.</p>
</div>
<h4 id="relationships-api">Relationships API</h4>
<p><span><strong>[Added in <code>v1.3</code>]</strong></span></p>
<p>To retrieve the child events for a parent from the server, the client can call the
following endpoint.</p>
<p>This endpoint is particularly useful if the client has lost context on the aggregation for
a parent event and needs to rebuild/verify it.</p>
<div class="alert note " role="alert">
Because replies do not use <code>rel_type</code>, they will not be accessible via this API.
</div>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv1roomsroomidrelationseventid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v1/rooms/{roomId}/relations/{eventId}</span>
  </h1>
</summary>
  <hr/>
<p><p>Retrieve all of the child events for a given parent event.</p>
<p>Note that when paginating the <code>from</code> token should be &ldquo;after&rdquo; the <code>to</code> token in
terms of topological ordering, because it is only possible to paginate &ldquo;backwards&rdquo;
through events, starting at <code>from</code>.</p>
<p>For example, passing a <code>from</code> token from page 2 of the results, and a <code>to</code> token
from page 1, would return the empty set. The caller can use a <code>from</code> token from
page 1 and a <code>to</code> token from page 2 to paginate over the same range, however.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>eventId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the parent event whose child events are to be returned.</td>
 </tr>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room containing the parent event.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>dir</code></td>
  <td><code>string</code></td>
  <td>
    Optional (default <code>b</code>) direction to return events from. If this is set to <code>f</code>, events
will be returned in chronological order starting at <code>from</code>. If it
is set to <code>b</code>, events will be returned in <em>reverse</em> chronological
order, again starting at <code>from</code>.<p>One of: <code>[b, f]</code>.</p>
<p><strong>Added in <code>v1.4</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>from</code></td>
  <td><code>string</code></td>
  <td>
    <p>The pagination token to start returning results from. If not supplied, results
start at the most recent topological event known to the server.</p>
<p>Can be a <code>next_batch</code> or <code>prev_batch</code> token from a previous call, or a returned
<code>start</code> token from <a href="/client-server-api/#get_matrixclientv3roomsroomidmessages"><code>/messages</code></a>,
or a <code>next_batch</code> token from <a href="/client-server-api/#get_matrixclientv3sync"><code>/sync</code></a>.</p>
</td>
 </tr>
 <tr>
  <td><code>limit</code></td>
  <td><code>integer</code></td>
  <td>
    <p>The maximum number of results to return in a single <code>chunk</code>. The server can
and should apply a maximum value to this parameter to avoid large responses.</p>
<p>Similarly, the server should apply a default value when not supplied.</p>
</td>
 </tr>
 <tr>
  <td><code>to</code></td>
  <td><code>string</code></td>
  <td>
    <p>The pagination token to stop returning results at. If not supplied, results
continue up to <code>limit</code> or until there are no more events.</p>
<p>Like <code>from</code>, this can be a previous token from a prior call to this endpoint
or from <code>/messages</code> or <code>/sync</code>.</p>
</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The paginated child events which point to the parent. If no events are
pointing to the parent or the pagination yields no results, an empty <code>chunk</code>
is returned.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The parent event was not found or the user does not have permission to read
this event (it might be contained in history that is not accessible to the user).</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>chunk</code></td>
  <td><code>[ClientEvent]</code></td>
  <td>
    <strong>Required: </strong>The child events of the requested event, ordered topologically most-recent first.</td>
 </tr>
 <tr>
  <td><code>next_batch</code></td>
  <td><code>string</code></td>
  <td>
    An opaque string representing a pagination token. The absence of this token
means there are no more results to fetch and the client should stop paginating.</td>
 </tr>
 <tr>
  <td><code>prev_batch</code></td>
  <td><code>string</code></td>
  <td>
    An opaque string representing a pagination token. The absence of this token
means this is the start of the result set, i.e. this is the first batch/page.</td>
 </tr>
</table>
<table id="_matrixclientv1roomsroomidrelationseventid_clientevent" class="object-table">
 <caption>ClientEvent</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The body of this event, as created by the client which sent it.</td>
 </tr>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The globally unique identifier for this event.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>Timestamp (in milliseconds since the unix epoch) on originating homeserver
when this event was sent.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room associated with this event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Contains the fully-qualified ID of the user who sent this event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <p>Present if, and only if, this event is a <em>state</em> event. The key making
this piece of state unique in the room. Note that it is often an empty
string.</p>
<p>State keys starting with an <code>@</code> are reserved for referencing user IDs, such
as room members. With the exception of a few events, state events set with a
given user&rsquo;s ID as the state key MUST only be set by that user.</p>
</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of the event.</td>
 </tr>
 <tr>
  <td><code>unsigned</code></td>
  <td><code>UnsignedData</code></td>
  <td>
    Contains optional extra information about the event.</td>
 </tr>
</table>
<table id="_matrixclientv1roomsroomidrelationseventid_unsigneddata" class="object-table">
 <caption>UnsignedData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>age</code></td>
  <td><code>integer</code></td>
  <td>
    The time in milliseconds that has elapsed since the event was sent. This field is generated by the local homeserver, and may be incorrect if the local time on at least one of the two servers is out of sync, which can cause the age to either be negative or greater than it actually is.</td>
 </tr>
 <tr>
  <td><code>prev_content</code></td>
  <td><code>EventContent</code></td>
  <td>
    The previous <code>content</code> for this event. This field is generated
by the local homeserver, and is only returned if the event is a state event,
and the client has permission to see the previous content.<br><br>
    <strong>
      Changed in <code>v1.2</code>:
    </strong>
    Previously, this field was specified at the top level of returned
events rather than in <code>unsigned</code> (with the exception of the <a href="/client-server-api/#get_matrixclientv3notifications"><code>GET .../notifications</code></a>
endpoint), though in practice no known server implementations honoured
this.
</td>
 </tr>
 <tr>
  <td><code>redacted_because</code></td>
  <td><code>ClientEvent</code></td>
  <td>
    The event that redacted this event, if any.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    The client-supplied <a href="/client-server-api/#transaction-identifiers">transaction ID</a>, for example, provided via
<code>PUT /_matrix/client/v3/rooms/{roomId}/send/{eventType}/{txnId}</code>,
if the client being given the event is the same one which sent it.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;chunk&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;m.relates_to&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$asfDuShaf7Gafaw&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;rel_type&#34;</span><span class="p">:</span> <span class="s2">&#34;org.example.my_relation&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;next_batch&#34;</span><span class="p">:</span> <span class="s2">&#34;page2_token&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;prev_batch&#34;</span><span class="p">:</span> <span class="s2">&#34;page1_token&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv1roomsroomidrelationseventid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Event not found.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv1roomsroomidrelationseventidreltype">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v1/rooms/{roomId}/relations/{eventId}/{relType}</span>
  </h1>
</summary>
  <hr/>
<p><p>Retrieve all of the child events for a given parent event which relate to the parent
using the given <code>relType</code>.</p>
<p>Note that when paginating the <code>from</code> token should be &ldquo;after&rdquo; the <code>to</code> token in
terms of topological ordering, because it is only possible to paginate &ldquo;backwards&rdquo;
through events, starting at <code>from</code>.</p>
<p>For example, passing a <code>from</code> token from page 2 of the results, and a <code>to</code> token
from page 1, would return the empty set. The caller can use a <code>from</code> token from
page 1 and a <code>to</code> token from page 2 to paginate over the same range, however.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>eventId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the parent event whose child events are to be returned.</td>
 </tr>
 <tr>
  <td><code>relType</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <a href="/client-server-api/#relationship-types">relationship type</a> to search for.</td>
 </tr>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room containing the parent event.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>dir</code></td>
  <td><code>string</code></td>
  <td>
    Optional (default <code>b</code>) direction to return events from. If this is set to <code>f</code>, events
will be returned in chronological order starting at <code>from</code>. If it
is set to <code>b</code>, events will be returned in <em>reverse</em> chronological
order, again starting at <code>from</code>.<p>One of: <code>[b, f]</code>.</p>
<p><strong>Added in <code>v1.4</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>from</code></td>
  <td><code>string</code></td>
  <td>
    <p>The pagination token to start returning results from. If not supplied, results
start at the most recent topological event known to the server.</p>
<p>Can be a <code>next_batch</code> or <code>prev_batch</code> token from a previous call, or a returned
<code>start</code> token from <a href="/client-server-api/#get_matrixclientv3roomsroomidmessages"><code>/messages</code></a>,
or a <code>next_batch</code> token from <a href="/client-server-api/#get_matrixclientv3sync"><code>/sync</code></a>.</p>
</td>
 </tr>
 <tr>
  <td><code>limit</code></td>
  <td><code>integer</code></td>
  <td>
    <p>The maximum number of results to return in a single <code>chunk</code>. The server can
and should apply a maximum value to this parameter to avoid large responses.</p>
<p>Similarly, the server should apply a default value when not supplied.</p>
</td>
 </tr>
 <tr>
  <td><code>to</code></td>
  <td><code>string</code></td>
  <td>
    <p>The pagination token to stop returning results at. If not supplied, results
continue up to <code>limit</code> or until there are no more events.</p>
<p>Like <code>from</code>, this can be a previous token from a prior call to this endpoint
or from <code>/messages</code> or <code>/sync</code>.</p>
</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The paginated child events which point to the parent. If no events are
pointing to the parent or the pagination yields no results, an empty <code>chunk</code>
is returned.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The parent event was not found or the user does not have permission to read
this event (it might be contained in history that is not accessible to the user).</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>chunk</code></td>
  <td><code>[ClientEvent]</code></td>
  <td>
    <strong>Required: </strong>The child events of the requested event, ordered topologically
most-recent first. The events returned will match the <code>relType</code>
supplied in the URL.</td>
 </tr>
 <tr>
  <td><code>next_batch</code></td>
  <td><code>string</code></td>
  <td>
    An opaque string representing a pagination token. The absence of this token
means there are no more results to fetch and the client should stop paginating.</td>
 </tr>
 <tr>
  <td><code>prev_batch</code></td>
  <td><code>string</code></td>
  <td>
    An opaque string representing a pagination token. The absence of this token
means this is the start of the result set, i.e. this is the first batch/page.</td>
 </tr>
</table>
<table id="_matrixclientv1roomsroomidrelationseventidreltype_clientevent" class="object-table">
 <caption>ClientEvent</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The body of this event, as created by the client which sent it.</td>
 </tr>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The globally unique identifier for this event.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>Timestamp (in milliseconds since the unix epoch) on originating homeserver
when this event was sent.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room associated with this event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Contains the fully-qualified ID of the user who sent this event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <p>Present if, and only if, this event is a <em>state</em> event. The key making
this piece of state unique in the room. Note that it is often an empty
string.</p>
<p>State keys starting with an <code>@</code> are reserved for referencing user IDs, such
as room members. With the exception of a few events, state events set with a
given user&rsquo;s ID as the state key MUST only be set by that user.</p>
</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of the event.</td>
 </tr>
 <tr>
  <td><code>unsigned</code></td>
  <td><code>UnsignedData</code></td>
  <td>
    Contains optional extra information about the event.</td>
 </tr>
</table>
<table id="_matrixclientv1roomsroomidrelationseventidreltype_unsigneddata" class="object-table">
 <caption>UnsignedData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>age</code></td>
  <td><code>integer</code></td>
  <td>
    The time in milliseconds that has elapsed since the event was sent. This field is generated by the local homeserver, and may be incorrect if the local time on at least one of the two servers is out of sync, which can cause the age to either be negative or greater than it actually is.</td>
 </tr>
 <tr>
  <td><code>prev_content</code></td>
  <td><code>EventContent</code></td>
  <td>
    The previous <code>content</code> for this event. This field is generated
by the local homeserver, and is only returned if the event is a state event,
and the client has permission to see the previous content.<br><br>
    <strong>
      Changed in <code>v1.2</code>:
    </strong>
    Previously, this field was specified at the top level of returned
events rather than in <code>unsigned</code> (with the exception of the <a href="/client-server-api/#get_matrixclientv3notifications"><code>GET .../notifications</code></a>
endpoint), though in practice no known server implementations honoured
this.
</td>
 </tr>
 <tr>
  <td><code>redacted_because</code></td>
  <td><code>ClientEvent</code></td>
  <td>
    The event that redacted this event, if any.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    The client-supplied <a href="/client-server-api/#transaction-identifiers">transaction ID</a>, for example, provided via
<code>PUT /_matrix/client/v3/rooms/{roomId}/send/{eventType}/{txnId}</code>,
if the client being given the event is the same one which sent it.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;chunk&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;m.relates_to&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$asfDuShaf7Gafaw&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;rel_type&#34;</span><span class="p">:</span> <span class="s2">&#34;org.example.my_relation&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;next_batch&#34;</span><span class="p">:</span> <span class="s2">&#34;page2_token&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;prev_batch&#34;</span><span class="p">:</span> <span class="s2">&#34;page1_token&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv1roomsroomidrelationseventidreltype_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Event not found.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv1roomsroomidrelationseventidreltypeeventtype">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v1/rooms/{roomId}/relations/{eventId}/{relType}/{eventType}</span>
  </h1>
</summary>
  <hr/>
<p><p>Retrieve all of the child events for a given parent event which relate to the parent
using the given <code>relType</code> and have the given <code>eventType</code>.</p>
<p>Note that when paginating the <code>from</code> token should be &ldquo;after&rdquo; the <code>to</code> token in
terms of topological ordering, because it is only possible to paginate &ldquo;backwards&rdquo;
through events, starting at <code>from</code>.</p>
<p>For example, passing a <code>from</code> token from page 2 of the results, and a <code>to</code> token
from page 1, would return the empty set. The caller can use a <code>from</code> token from
page 1 and a <code>to</code> token from page 2 to paginate over the same range, however.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>eventId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the parent event whose child events are to be returned.</td>
 </tr>
 <tr>
  <td><code>eventType</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><p>The event type of child events to search for.</p>
<p>Note that in encrypted rooms this will typically always be <code>m.room.encrypted</code>
regardless of the event type contained within the encrypted payload.</p>
</td>
 </tr>
 <tr>
  <td><code>relType</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <a href="/client-server-api/#relationship-types">relationship type</a> to search for.</td>
 </tr>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room containing the parent event.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>dir</code></td>
  <td><code>string</code></td>
  <td>
    Optional (default <code>b</code>) direction to return events from. If this is set to <code>f</code>, events
will be returned in chronological order starting at <code>from</code>. If it
is set to <code>b</code>, events will be returned in <em>reverse</em> chronological
order, again starting at <code>from</code>.<p>One of: <code>[b, f]</code>.</p>
<p><strong>Added in <code>v1.4</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>from</code></td>
  <td><code>string</code></td>
  <td>
    <p>The pagination token to start returning results from. If not supplied, results
start at the most recent topological event known to the server.</p>
<p>Can be a <code>next_batch</code> or <code>prev_batch</code> token from a previous call, or a returned
<code>start</code> token from <a href="/client-server-api/#get_matrixclientv3roomsroomidmessages"><code>/messages</code></a>,
or a <code>next_batch</code> token from <a href="/client-server-api/#get_matrixclientv3sync"><code>/sync</code></a>.</p>
</td>
 </tr>
 <tr>
  <td><code>limit</code></td>
  <td><code>integer</code></td>
  <td>
    <p>The maximum number of results to return in a single <code>chunk</code>. The server can
and should apply a maximum value to this parameter to avoid large responses.</p>
<p>Similarly, the server should apply a default value when not supplied.</p>
</td>
 </tr>
 <tr>
  <td><code>to</code></td>
  <td><code>string</code></td>
  <td>
    <p>The pagination token to stop returning results at. If not supplied, results
continue up to <code>limit</code> or until there are no more events.</p>
<p>Like <code>from</code>, this can be a previous token from a prior call to this endpoint
or from <code>/messages</code> or <code>/sync</code>.</p>
</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The paginated child events which point to the parent. If no events are
pointing to the parent or the pagination yields no results, an empty <code>chunk</code>
is returned.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The parent event was not found or the user does not have permission to read
this event (it might be contained in history that is not accessible to the user).</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>chunk</code></td>
  <td><code>[ClientEvent]</code></td>
  <td>
    <strong>Required: </strong>The child events of the requested event, ordered topologically most-recent
first. The events returned will match the <code>relType</code> and <code>eventType</code> supplied
in the URL.</td>
 </tr>
 <tr>
  <td><code>next_batch</code></td>
  <td><code>string</code></td>
  <td>
    An opaque string representing a pagination token. The absence of this token
means there are no more results to fetch and the client should stop paginating.</td>
 </tr>
 <tr>
  <td><code>prev_batch</code></td>
  <td><code>string</code></td>
  <td>
    An opaque string representing a pagination token. The absence of this token
means this is the start of the result set, i.e. this is the first batch/page.</td>
 </tr>
</table>
<table id="_matrixclientv1roomsroomidrelationseventidreltypeeventtype_clientevent" class="object-table">
 <caption>ClientEvent</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The body of this event, as created by the client which sent it.</td>
 </tr>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The globally unique identifier for this event.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>Timestamp (in milliseconds since the unix epoch) on originating homeserver
when this event was sent.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room associated with this event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Contains the fully-qualified ID of the user who sent this event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <p>Present if, and only if, this event is a <em>state</em> event. The key making
this piece of state unique in the room. Note that it is often an empty
string.</p>
<p>State keys starting with an <code>@</code> are reserved for referencing user IDs, such
as room members. With the exception of a few events, state events set with a
given user&rsquo;s ID as the state key MUST only be set by that user.</p>
</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of the event.</td>
 </tr>
 <tr>
  <td><code>unsigned</code></td>
  <td><code>UnsignedData</code></td>
  <td>
    Contains optional extra information about the event.</td>
 </tr>
</table>
<table id="_matrixclientv1roomsroomidrelationseventidreltypeeventtype_unsigneddata" class="object-table">
 <caption>UnsignedData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>age</code></td>
  <td><code>integer</code></td>
  <td>
    The time in milliseconds that has elapsed since the event was sent. This field is generated by the local homeserver, and may be incorrect if the local time on at least one of the two servers is out of sync, which can cause the age to either be negative or greater than it actually is.</td>
 </tr>
 <tr>
  <td><code>prev_content</code></td>
  <td><code>EventContent</code></td>
  <td>
    The previous <code>content</code> for this event. This field is generated
by the local homeserver, and is only returned if the event is a state event,
and the client has permission to see the previous content.<br><br>
    <strong>
      Changed in <code>v1.2</code>:
    </strong>
    Previously, this field was specified at the top level of returned
events rather than in <code>unsigned</code> (with the exception of the <a href="/client-server-api/#get_matrixclientv3notifications"><code>GET .../notifications</code></a>
endpoint), though in practice no known server implementations honoured
this.
</td>
 </tr>
 <tr>
  <td><code>redacted_because</code></td>
  <td><code>ClientEvent</code></td>
  <td>
    The event that redacted this event, if any.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    The client-supplied <a href="/client-server-api/#transaction-identifiers">transaction ID</a>, for example, provided via
<code>PUT /_matrix/client/v3/rooms/{roomId}/send/{eventType}/{txnId}</code>,
if the client being given the event is the same one which sent it.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;chunk&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;m.relates_to&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$asfDuShaf7Gafaw&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;rel_type&#34;</span><span class="p">:</span> <span class="s2">&#34;org.example.my_relation&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;next_batch&#34;</span><span class="p">:</span> <span class="s2">&#34;page2_token&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;prev_batch&#34;</span><span class="p">:</span> <span class="s2">&#34;page1_token&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv1roomsroomidrelationseventidreltypeeventtype_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Event not found.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h2 id="rooms">Rooms</h2>
<h3 id="types">Types</h3>
<p><span><strong>[Added in <code>v1.2</code>]</strong></span></p>
<p>Optionally, rooms can have types to denote their intended function. A room
without a type does not necessarily mean it has a specific default function,
though commonly these rooms will be for conversational purposes.</p>
<p>Room types are best applied when a client might need to differentiate between
two different rooms, such as conversation-holding and data-holding. If a room
has a type, it is specified in the <code>type</code> key of an <a href="#mroomcreate"><code>m.room.create</code></a>
event. To specify a room&rsquo;s type, provide it as part of <code>creation_content</code> on
the create room request.</p>
<p>In this specification the following room types are specified:</p>
<ul>
<li><a href="#spaces"><code>m.space</code></a></li>
</ul>
<p>Unspecified room types are permitted through the use of
<a href="/appendices/#common-namespaced-identifier-grammar">Namespaced Identifiers</a>.</p>
<h3 id="creation">Creation</h3>
<p>The homeserver will create an <code>m.room.create</code> event when a room is
created, which serves as the root of the event graph for this room. This
event also has a <code>creator</code> key which contains the user ID of the room
creator. It will also generate several other events in order to manage
permissions in this room. This includes:</p>
<ul>
<li>
<p><code>m.room.power_levels</code> : Sets the power levels of users and required power
levels for various actions within the room such as sending events.</p>
</li>
<li>
<p><code>m.room.join_rules</code> : Whether the room is &ldquo;invite-only&rdquo; or not.</p>
</li>
</ul>
<p>See <a href="#room-events">Room Events</a> for more information on these events. To
create a room, a client has to use the following API.</p>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3createroom">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/createRoom</span>
  </h1>
</summary>
  <hr/>
<p><p>Create a new room with various configuration options.</p>
<p>The server MUST apply the normal state resolution rules when creating
the new room, including checking power levels for each event. It MUST
apply the events implied by the request in the following order:</p>
<ol>
<li>
<p>The <code>m.room.create</code> event itself. Must be the first event in the
room.</p>
</li>
<li>
<p>An <code>m.room.member</code> event for the creator to join the room. This is
needed so the remaining events can be sent.</p>
</li>
<li>
<p>A default <code>m.room.power_levels</code> event, giving the room creator
(and not other members) permission to send state events. Overridden
by the <code>power_level_content_override</code> parameter.</p>
</li>
<li>
<p>An <code>m.room.canonical_alias</code> event if <code>room_alias_name</code> is given.</p>
</li>
<li>
<p>Events set by the <code>preset</code>. Currently these are the <code>m.room.join_rules</code>,
<code>m.room.history_visibility</code>, and <code>m.room.guest_access</code> state events.</p>
</li>
<li>
<p>Events listed in <code>initial_state</code>, in the order that they are
listed.</p>
</li>
<li>
<p>Events implied by <code>name</code> and <code>topic</code> (<code>m.room.name</code> and <code>m.room.topic</code>
state events).</p>
</li>
<li>
<p>Invite events implied by <code>invite</code> and <code>invite_3pid</code> (<code>m.room.member</code> with
<code>membership: invite</code> and <code>m.room.third_party_invite</code>).</p>
</li>
</ol>
<p>The available presets do the following with respect to room state:</p>
<table>
<thead>
<tr>
<th>Preset</th>
<th><code>join_rules</code></th>
<th><code>history_visibility</code></th>
<th><code>guest_access</code></th>
<th>Other</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>private_chat</code></td>
<td><code>invite</code></td>
<td><code>shared</code></td>
<td><code>can_join</code></td>
<td></td>
</tr>
<tr>
<td><code>trusted_private_chat</code></td>
<td><code>invite</code></td>
<td><code>shared</code></td>
<td><code>can_join</code></td>
<td>All invitees are given the same power level as the room creator.</td>
</tr>
<tr>
<td><code>public_chat</code></td>
<td><code>public</code></td>
<td><code>shared</code></td>
<td><code>forbidden</code></td>
<td></td>
</tr>
</tbody>
</table>
<p>The server will create a <code>m.room.create</code> event in the room with the
requesting user as the creator, alongside other keys provided in the
<code>creation_content</code>.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>creation_content</code></td>
  <td><code>CreationContent</code></td>
  <td>
    Extra keys, such as <code>m.federate</code>, to be added to the content
of the <a href="/client-server-api/#mroomcreate"><code>m.room.create</code></a> event. The server will overwrite the following
keys: <code>creator</code>, <code>room_version</code>. Future versions of the specification
may allow the server to overwrite other keys.</td>
 </tr>
 <tr>
  <td><code>initial_state</code></td>
  <td><code>[StateEvent]</code></td>
  <td>
    <p>A list of state events to set in the new room. This allows
the user to override the default state events set in the new
room. The expected format of the state events are an object
with type, state_key and content keys set.</p>
<p>Takes precedence over events set by <code>preset</code>, but gets
overridden by <code>name</code> and <code>topic</code> keys.</p>
</td>
 </tr>
 <tr>
  <td><code>invite</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of user IDs to invite to the room. This will tell the
server to invite everyone in the list to the newly created room.</td>
 </tr>
 <tr>
  <td><code>invite_3pid</code></td>
  <td><code>[Invite3pid]</code></td>
  <td>
    A list of objects representing third-party IDs to invite into
the room.</td>
 </tr>
 <tr>
  <td><code>is_direct</code></td>
  <td><code>boolean</code></td>
  <td>
    This flag makes the server set the <code>is_direct</code> flag on the
<code>m.room.member</code> events sent to the users in <code>invite</code> and
<code>invite_3pid</code>. See <a href="/client-server-api/#direct-messaging">Direct Messaging</a> for more information.</td>
 </tr>
 <tr>
  <td><code>name</code></td>
  <td><code>string</code></td>
  <td>
    If this is included, an <code>m.room.name</code> event will be sent
into the room to indicate the name of the room. See Room
Events for more information on <code>m.room.name</code>.</td>
 </tr>
 <tr>
  <td><code>power_level_content_override</code></td>
  <td><code>Power Level Event Content</code></td>
  <td>
    The power level content to override in the default power level
event. This object is applied on top of the generated
<a href="/client-server-api/#mroompower_levels"><code>m.room.power_levels</code></a>
event content prior to it being sent to the room. Defaults to
overriding nothing.</td>
 </tr>
 <tr>
  <td><code>preset</code></td>
  <td><code>string</code></td>
  <td>
    <p>Convenience parameter for setting various default state events
based on a preset.</p>
<p>If unspecified, the server should use the <code>visibility</code> to determine
which preset to use. A visibility of <code>public</code> equates to a preset of
<code>public_chat</code> and <code>private</code> visibility equates to a preset of
<code>private_chat</code>.</p>
<p>One of: <code>[private_chat, public_chat, trusted_private_chat]</code>.</p></td>
 </tr>
 <tr>
  <td><code>room_alias_name</code></td>
  <td><code>string</code></td>
  <td>
    <p>The desired room alias <strong>local part</strong>. If this is included, a
room alias will be created and mapped to the newly created
room. The alias will belong on the <em>same</em> homeserver which
created the room. For example, if this was set to &ldquo;foo&rdquo; and
sent to the homeserver &ldquo;example.com&rdquo; the complete room alias
would be <code>#foo:example.com</code>.</p>
<p>The complete room alias will become the canonical alias for
the room and an <code>m.room.canonical_alias</code> event will be sent
into the room.</p>
</td>
 </tr>
 <tr>
  <td><code>room_version</code></td>
  <td><code>string</code></td>
  <td>
    The room version to set for the room. If not provided, the homeserver is
to use its configured default. If provided, the homeserver will return a
400 error with the errcode <code>M_UNSUPPORTED_ROOM_VERSION</code> if it does not
support the room version.</td>
 </tr>
 <tr>
  <td><code>topic</code></td>
  <td><code>string</code></td>
  <td>
    If this is included, an <code>m.room.topic</code> event will be sent
into the room to indicate the topic for the room. See Room
Events for more information on <code>m.room.topic</code>.</td>
 </tr>
 <tr>
  <td><code>visibility</code></td>
  <td><code>string</code></td>
  <td>
    A <code>public</code> visibility indicates that the room will be shown
in the published room list. A <code>private</code> visibility will hide
the room from the published room list. Rooms default to
<code>private</code> visibility if this key is not included. NB: This
should not be confused with <code>join_rules</code> which also uses the
word <code>public</code>.<p>One of: <code>[public, private]</code>.</p></td>
 </tr>
</table>
<table id="_matrixclientv3createroom_stateevent" class="object-table">
 <caption>StateEvent</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The content of the event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    The state_key of the state event. Defaults to an empty string.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of event to send.</td>
 </tr>
</table>
<table id="_matrixclientv3createroom_invite3pid" class="object-table">
 <caption>Invite3pid</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>address</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The invitee&rsquo;s third-party identifier.</td>
 </tr>
 <tr>
  <td><code>id_access_token</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An access token previously registered with the identity server. Servers
can treat this as optional to distinguish between r0.5-compatible clients
and this specification version.</td>
 </tr>
 <tr>
  <td><code>id_server</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The hostname+port of the identity server which should be used for third-party identifier lookups.</td>
 </tr>
 <tr>
  <td><code>medium</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The kind of address being passed in the address field, for example <code>email</code>
(see <a href="/appendices/#3pid-types">the list of recognised values</a>).</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;creation_content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.federate&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;The Grand Duke Pub&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;preset&#34;</span><span class="p">:</span> <span class="s2">&#34;public_chat&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_alias_name&#34;</span><span class="p">:</span> <span class="s2">&#34;thepub&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;topic&#34;</span><span class="p">:</span> <span class="s2">&#34;All about happy hour&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>Information about the newly created room.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td><p>The request is invalid. A meaningful <code>errcode</code> and description
error text will be returned. Example reasons for rejection include:</p>
<ul>
<li>
<p>The request body is malformed (<code>errcode</code> set to <code>M_BAD_JSON</code>
or <code>M_NOT_JSON</code>).</p>
</li>
<li>
<p>The room alias specified is already taken (<code>errcode</code> set to
<code>M_ROOM_IN_USE</code>).</p>
</li>
<li>
<p>The initial state implied by the parameters to the request is
invalid: for example, the user&rsquo;s <code>power_level</code> is set below
that necessary to set the room name (<code>errcode</code> set to
<code>M_INVALID_ROOM_STATE</code>).</p>
</li>
<li>
<p>The homeserver doesn&rsquo;t support the requested room version, or
one or more users being invited to the new room are residents
of a homeserver which does not support the requested room version.
The <code>errcode</code> will be <code>M_UNSUPPORTED_ROOM_VERSION</code> in these
cases.</p>
</li>
</ul>
</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The created room&rsquo;s ID.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!sefiuhWgwghwWgh:example.com&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3createroom_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_UNKNOWN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;An unknown error occurred&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h3 id="room-aliases">Room aliases</h3>
<p>Servers may host aliases for rooms with human-friendly names. Aliases
take the form <code>#friendlyname:server.name</code>.</p>
<p>As room aliases are scoped to a particular homeserver domain name, it is
likely that a homeserver will reject attempts to maintain aliases on
other domain names. This specification does not provide a way for
homeservers to send update requests to other servers. However,
homeservers MUST handle <code>GET</code> requests to resolve aliases on other
servers; they should do this using the federation API if necessary.</p>
<p>Rooms do not store a list of all aliases present on a room, though
members of the room with relevant permissions may publish preferred
aliases through the <code>m.room.canonical_alias</code> state event. The aliases in
the state event should point to the room ID they are published within,
however room aliases can and do drift to other room IDs over time.
Clients SHOULD NOT treat the aliases as accurate. They SHOULD be checked
before they are used or shared with another user. If a room appears to
have a room alias of <code>#alias:example.com</code>, this SHOULD be checked to
make sure that the room&rsquo;s ID matches the <code>room_id</code> returned from the
request.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3directoryroomroomalias">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/directory/room/{roomAlias}</span>
  </h1>
</summary>
  <hr/>
<p><p>Requests that the server resolve a room alias to a room ID.</p>
<p>The server will use the federation API to resolve the alias if the
domain part of the alias does not correspond to the server&rsquo;s own
domain.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomAlias</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room alias. Its format is defined
<a href="/appendices/#room-aliases">in the appendices</a>.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The room ID and other information for this alias.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td>The given <code>roomAlias</code> is not a valid room alias.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>There is no mapped room ID for this room alias.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    The room ID for this room alias.</td>
 </tr>
 <tr>
  <td><code>servers</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of servers that are aware of this room alias.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!abnjk1jdasj98:capuchins.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;servers&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;capuchins.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;another.com&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3directoryroomroomalias_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_INVALID_PARAM&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Room alias invalid&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3directoryroomroomalias_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Room alias #monkeys:matrix.org not found.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixclientv3directoryroomroomalias">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/client/v3/directory/room/{roomAlias}</span>
  </h1>
</summary>
  <hr/>
<p></p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomAlias</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room alias to set. Its format is defined
<a href="/appendices/#room-aliases">in the appendices</a>.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID to set.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!abnjk1jdasj98:capuchins.com&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The mapping was created.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td>The given <code>roomAlias</code> is not a valid room alias.</td>
 </tr>
 <tr>
  <td><code>409</code></td>
  <td>A room alias with that name already exists.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3directoryroomroomalias_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_INVALID_PARAM&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Room alias invalid&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>409 response</h3>
<table id="_matrixclientv3directoryroomroomalias_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_UNKNOWN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Room alias #monkeys:matrix.org already exists.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api DELETE">
<details open>
<summary>
  <h1 id="delete_matrixclientv3directoryroomroomalias">
   <span class="http-api-method DELETE">DELETE</span>
   <span class="endpoint">/_matrix/client/v3/directory/room/{roomAlias}</span>
  </h1>
</summary>
  <hr/>
<p><p>Remove a mapping of room alias to room ID.</p>
<p>Servers may choose to implement additional access control checks here, for instance that
room aliases can only be deleted by their creator or a server administrator.</p>
<p><strong>Note:</strong>
Servers may choose to update the <code>alt_aliases</code> for the <code>m.room.canonical_alias</code>
state event in the room when an alias is removed. Servers which choose to update the
canonical alias event are recommended to, in addition to their other relevant permission
checks, delete the alias and return a successful response even if the user does not
have permission to update the <code>m.room.canonical_alias</code> event.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomAlias</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room alias to remove. Its format is defined
<a href="/appendices/#room-aliases">in the appendices</a>.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The mapping was deleted.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>There is no mapped room ID for this room alias.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3directoryroomroomalias_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Room alias #monkeys:example.org not found.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3roomsroomidaliases">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/rooms/{roomId}/aliases</span>
  </h1>
</summary>
  <hr/>
<p><p>Get a list of aliases maintained by the local server for the
given room.</p>
<p>This endpoint can be called by users who are in the room (external
users receive an <code>M_FORBIDDEN</code> error response). If the room&rsquo;s
<code>m.room.history_visibility</code> maps to <code>world_readable</code>, any
user can call this endpoint.</p>
<p>Servers may choose to implement additional access control checks here,
such as allowing server administrators to view aliases regardless of
membership.</p>
<p><strong>Note:</strong>
Clients are recommended not to display this list of aliases prominently
as they are not curated, unlike those listed in the <code>m.room.canonical_alias</code>
state event.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID to find local aliases of.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The list of local aliases for the room.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td>The given <code>roomAlias</code> is not a valid room alias.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The user is not permitted to retrieve the list of local aliases for the room.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>aliases</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The server&rsquo;s local aliases on the room. Can be empty.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;aliases&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;#somewhere:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;#another:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;#hat_trick:example.com&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3roomsroomidaliases_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_INVALID_PARAM&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Room alias invalid&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3roomsroomidaliases_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;You are not a member of the room.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3roomsroomidaliases_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h3 id="permissions">Permissions</h3>
<div class="alert note " role="alert">
This section is a work in progress.
</div>
<p>Permissions for rooms are done via the concept of power levels - to do
any action in a room a user must have a suitable power level. Power
levels are stored as state events in a given room. The power levels
required for operations and the power levels for users are defined in
<code>m.room.power_levels</code>, where both a default and specific users&rsquo; power
levels can be set. By default all users have a power level of 0, other
than the room creator whose power level defaults to 100. Users can grant
other users increased power levels up to their own power level. For
example, user A with a power level of 50 could increase the power level
of user B to a maximum of level 50. Power levels for users are tracked
per-room even if the user is not present in the room. The keys contained
in <code>m.room.power_levels</code> determine the levels required for certain
operations such as kicking, banning and sending state events. See
<a href="#room-events">m.room.power_levels</a> for more information.</p>
<p>Clients may wish to assign names to particular power levels. A suggested
mapping is as follows: - 0 User - 50 Moderator - 100 Admin</p>
<h3 id="room-membership">Room membership</h3>
<p>Users need to be a member of a room in order to send and receive events
in that room. There are several states in which a user may be, in
relation to a room:</p>
<ul>
<li>Unrelated (the user cannot send or receive events in the room)</li>
<li>Knocking (the user has requested to participate in the room, but has
not yet been allowed to)</li>
<li>Invited (the user has been invited to participate in the room, but
is not yet participating)</li>
<li>Joined (the user can send and receive events in the room)</li>
<li>Banned (the user is not allowed to join the room)</li>
</ul>
<p>There are a few notable exceptions which allow non-joined members of the
room to send events in the room:</p>
<ul>
<li>
<p>Users wishing to reject an invite would send <code>m.room.member</code> events with
<code>content.membership</code> of <code>leave</code>. They must have been invited first.</p>
</li>
<li>
<p>If the room allows, users can send <code>m.room.member</code> events with <code>content.membership</code>
of <code>knock</code> to knock on the room. This is a request for an invite by the user.</p>
</li>
<li>
<p>To retract a previous knock, a user would send a <code>leave</code> event similar to
rejecting an invite.</p>
</li>
</ul>
<p>Some rooms require that users be invited to it before they can join;
others allow anyone to join. Whether a given room is an &ldquo;invite-only&rdquo;
room is determined by the room config key <code>m.room.join_rules</code>. It can
have one of the following values:</p>
<p><code>public</code>
This room is free for anyone to join without an invite.</p>
<p><code>invite</code>
This room can only be joined if you were invited.</p>
<p><code>knock</code>
This room can only be joined if you were invited, and allows anyone to
request an invite to the room. Note that this join rule is only available
in room versions <a href="/rooms/#feature-matrix">which support knocking</a>.</p>
<p><span><strong>[Added in <code>v1.2</code>]</strong></span></p>
<p><code>restricted</code>
This room can be joined if you were invited or if you are a member of another
room listed in the join rules. If the server cannot verify membership for any
of the listed rooms then you can only join with an invite. Note that this rule
is only expected to work in room versions <a href="/rooms/#feature-matrix">which support it</a>.</p>
<p><span><strong>[Added in <code>v1.3</code>]</strong></span></p>
<p><code>knock_restricted</code>
This room can be joined as though it was <code>restricted</code> <em>or</em> <code>knock</code>. If you
interact with the room using knocking, the <code>knock</code> rule takes effect whereas
trying to join the room without an invite applies the <code>restricted</code> join rule.
Note that this rule is only expected to work in room versions
<a href="/rooms/#feature-matrix">which support it</a>.</p>
<p>The allowable state transitions of membership are:</p>
<p><img src="/diagrams/membership.png" alt="membership-flow-diagram"></p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3joined_rooms">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/joined_rooms</span>
  </h1>
</summary>
  <hr/>
<p>This API returns a list of the user&rsquo;s current rooms.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<p>No request parameters or request body.</p>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>A list of the rooms the user is in.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>joined_rooms</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The ID of each room in which the user has <code>joined</code> membership.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;joined_rooms&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;!foo:example.com&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h4 id="joining-rooms">Joining rooms</h4>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3roomsroomidinvite">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/rooms/{roomId}/invite </span>
  </h1>
</summary>
  <hr/>
<p><p><em>Note that there are two forms of this API, which are documented separately.
This version of the API requires that the inviter knows the Matrix
identifier of the invitee. The other is documented in the
<a href="/client-server-api/#third-party-invites">third-party invites</a> section.</em></p>
<p>This API invites a user to participate in a particular room.
They do not start participating in the room until they actually join the
room.</p>
<p>Only users currently in a particular room can invite other users to
join that room.</p>
<p>If the user was invited to the room, the homeserver will append a
<code>m.room.member</code> event to the room.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room identifier (not alias) to which to invite the user.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>reason</code></td>
  <td><code>string</code></td>
  <td>
    Optional reason to be included as the <code>reason</code> on the subsequent
membership event.
<p><strong>Added in <code>v1.1</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The fully qualified user ID of the invitee.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;Welcome to the team!&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@cheeky_monkey:matrix.org&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The user has been invited to join the room, or was already invited to the room.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td><p>The request is invalid. A meaningful <code>errcode</code> and description
error text will be returned. Example reasons for rejection include:</p>
<ul>
<li>
<p>The request body is malformed (<code>errcode</code> set to <code>M_BAD_JSON</code>
or <code>M_NOT_JSON</code>).</p>
</li>
<li>
<p>One or more users being invited to the room are residents of a
homeserver which does not support the requested room version. The
<code>errcode</code> will be <code>M_UNSUPPORTED_ROOM_VERSION</code> in these cases.</p>
</li>
</ul>
</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td><p>You do not have permission to invite the user to the room. A meaningful <code>errcode</code> and description error text will be returned. Example reasons for rejections are:</p>
<ul>
<li>The invitee has been banned from the room.</li>
<li>The invitee is already a member of the room.</li>
<li>The inviter is not currently in the room.</li>
<li>The inviter&rsquo;s power level is insufficient to invite users to the room.</li>
</ul>
</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3roomsroomidinvite_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_UNKNOWN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;An unknown error occurred&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3roomsroomidinvite_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;@cheeky_monkey:matrix.org is banned from the room&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3roomsroomidinvite_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3joinroomidoralias">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/join/{roomIdOrAlias}</span>
  </h1>
</summary>
  <hr/>
<p><p><em>Note that this API takes either a room ID or alias, unlike</em> <code>/rooms/{roomId}/join</code>.</p>
<p>This API starts a user participating in a particular room, if that user
is allowed to participate in that room. After this call, the client is
allowed to see all current state events in the room, and all subsequent
events associated with the room until the user leaves the room.</p>
<p>After a user has joined a room, the room will appear as an entry in the
response of the <a href="/client-server-api/#get_matrixclientv3initialsync"><code>/initialSync</code></a>
and <a href="/client-server-api/#get_matrixclientv3sync"><code>/sync</code></a> APIs.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomIdOrAlias</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room identifier or alias to join.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>server_name</code></td>
  <td><code>[string]</code></td>
  <td>
    The servers to attempt to join the room through. One of the servers
must be participating in the room.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>reason</code></td>
  <td><code>string</code></td>
  <td>
    Optional reason to be included as the <code>reason</code> on the subsequent
membership event.
<p><strong>Added in <code>v1.1</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>third_party_signed</code></td>
  <td><code>Third-party Signed</code></td>
  <td>
    If a <code>third_party_signed</code> was supplied, the homeserver must verify
that it matches a pending <code>m.room.third_party_invite</code> event in the
room, and perform key validity checking if required by the event.</td>
 </tr>
</table>
<table id="_matrixclientv3joinroomidoralias_third-party-signed" class="object-table">
 <caption>Third-party Signed</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>mxid</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The Matrix ID of the invitee.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The Matrix ID of the user who issued the invite.</td>
 </tr>
 <tr>
  <td><code>signatures</code></td>
  <td><code>Signatures</code></td>
  <td>
    <strong>Required: </strong>A signatures object containing a signature of the entire signed object.</td>
 </tr>
 <tr>
  <td><code>token</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The state key of the m.third_party_invite event.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;Looking for support&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;third_party_signed&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;mxid&#34;</span><span class="p">:</span> <span class="s2">&#34;@bob:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;example.org&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:0&#34;</span><span class="p">:</span> <span class="s2">&#34;some9signature&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;token&#34;</span><span class="p">:</span> <span class="s2">&#34;random8nonce&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td><p>The room has been joined.</p>
<p>The joined room ID must be returned in the <code>room_id</code> field.</p>
</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td><p>You do not have permission to join the room. A meaningful <code>errcode</code>
and description error text will be returned. Example reasons for rejection are:</p>
<ul>
<li>The room is invite-only and the user was not invited.</li>
<li>The user has been banned from the room.</li>
<li>The room is restricted and the user failed to satisfy any of the conditions.</li>
</ul>
</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The joined room ID.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!d41d8cd:matrix.org&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3joinroomidoralias_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;You are not invited to this room.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3joinroomidoralias_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3roomsroomidjoin">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/rooms/{roomId}/join</span>
  </h1>
</summary>
  <hr/>
<p><p><em>Note that this API requires a room ID, not alias.</em>
<code>/join/{roomIdOrAlias}</code> <em>exists if you have a room alias.</em></p>
<p>This API starts a user participating in a particular room, if that user
is allowed to participate in that room. After this call, the client is
allowed to see all current state events in the room, and all subsequent
events associated with the room until the user leaves the room.</p>
<p>After a user has joined a room, the room will appear as an entry in the
response of the <a href="/client-server-api/#get_matrixclientv3initialsync"><code>/initialSync</code></a>
and <a href="/client-server-api/#get_matrixclientv3sync"><code>/sync</code></a> APIs.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room identifier (not alias) to join.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>reason</code></td>
  <td><code>string</code></td>
  <td>
    Optional reason to be included as the <code>reason</code> on the subsequent
membership event.
<p><strong>Added in <code>v1.1</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>third_party_signed</code></td>
  <td><code>Third-party Signed</code></td>
  <td>
    If supplied, the homeserver must verify that it matches a pending
<code>m.room.third_party_invite</code> event in the room, and perform
key validity checking if required by the event.</td>
 </tr>
</table>
<table id="_matrixclientv3roomsroomidjoin_third-party-signed" class="object-table">
 <caption>Third-party Signed</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>mxid</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The Matrix ID of the invitee.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The Matrix ID of the user who issued the invite.</td>
 </tr>
 <tr>
  <td><code>signatures</code></td>
  <td><code>Signatures</code></td>
  <td>
    <strong>Required: </strong>A signatures object containing a signature of the entire signed object.</td>
 </tr>
 <tr>
  <td><code>token</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The state key of the m.third_party_invite event.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;Looking for support&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;third_party_signed&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;mxid&#34;</span><span class="p">:</span> <span class="s2">&#34;@bob:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;example.org&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:0&#34;</span><span class="p">:</span> <span class="s2">&#34;some9signature&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;token&#34;</span><span class="p">:</span> <span class="s2">&#34;random8nonce&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td><p>The room has been joined.</p>
<p>The joined room ID must be returned in the <code>room_id</code> field.</p>
</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td><p>You do not have permission to join the room. A meaningful <code>errcode</code>
and description error text will be returned. Example reasons for rejection are:</p>
<ul>
<li>The room is invite-only and the user was not invited.</li>
<li>The user has been banned from the room.</li>
<li>The room is restricted and the user failed to satisfy any of the conditions.</li>
</ul>
</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The joined room ID.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!d41d8cd:matrix.org&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3roomsroomidjoin_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;You are not invited to this room.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3roomsroomidjoin_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h5 id="knocking-on-rooms">Knocking on rooms</h5>
<p><span><strong>[Added in <code>v1.1</code>]</strong></span></p>
<p><span><strong>[Changed in <code>v1.3</code>]</strong></span></p>
<div class="alert note " role="alert">
<p>As of <code>v1.3</code>, it is possible to knock on a <a href="#restricted-rooms">restricted room</a>
if the room supports and is using the <code>knock_restricted</code> join rule.</p>
<p>Note that <code>knock_restricted</code> is only expected to work in room versions
<a href="/rooms/#feature-matrix">which support it</a>.</p>
</div>
<!--
This section is here because it's most similar to being invited/joining a
room, though has added complexity which needs to be explained. Otherwise
this will have been just the API definition and nothing more (like invites).
-->
<p>If the join rules allow, external users to the room can <code>/knock</code> on it to
request permission to join. Users with appropriate permissions within the
room can then approve (<code>/invite</code>) or deny (<code>/kick</code>, <code>/ban</code>, or otherwise
set membership to <code>leave</code>) the knock. Knocks can be retracted by calling
<code>/leave</code> or otherwise setting membership to <code>leave</code>.</p>
<p>Users who are currently in the room, already invited, or banned cannot
knock on the room.</p>
<p>To accept another user&rsquo;s knock, the user must have permission to invite
users to the room. To reject another user&rsquo;s knock, the user must have
permission to either kick or ban users (whichever is being performed).
Note that setting another user&rsquo;s membership to <code>leave</code> is kicking them.</p>
<p>The knocking homeserver should assume that an invite to the room means
that the knock was accepted, even if the invite is not explicitly related
to the knock.</p>
<p>Homeservers are permitted to automatically accept invites as a result of
knocks as they should be aware of the user&rsquo;s intent to join the room. If
the homeserver is not auto-accepting invites (or there was an unrecoverable
problem with accepting it), the invite is expected to be passed down normally
to the client to handle. Clients can expect to see the join event if the
server chose to auto-accept.</p>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3knockroomidoralias">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/knock/{roomIdOrAlias}</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.1</code></strong></p>
<p><p><em>Note that this API takes either a room ID or alias, unlike other membership APIs.</em></p>
<p>This API &ldquo;knocks&rdquo; on the room to ask for permission to join, if the user
is allowed to knock on the room. Acceptance of the knock happens out of
band from this API, meaning that the client will have to watch for updates
regarding the acceptance/rejection of the knock.</p>
<p>If the room history settings allow, the user will still be able to see
history of the room while being in the &ldquo;knock&rdquo; state. The user will have
to accept the invitation to join the room (acceptance of knock) to see
messages reliably. See the <code>/join</code> endpoints for more information about
history visibility to the user.</p>
<p>The knock will appear as an entry in the response of the
<a href="/client-server-api/#get_matrixclientv3sync"><code>/sync</code></a> API.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomIdOrAlias</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room identifier or alias to knock upon.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>server_name</code></td>
  <td><code>[string]</code></td>
  <td>
    The servers to attempt to knock on the room through. One of the servers
must be participating in the room.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>reason</code></td>
  <td><code>string</code></td>
  <td>
    Optional reason to be included as the <code>reason</code> on the subsequent
membership event.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;Looking for support&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td><p>The room has been knocked upon.</p>
<p>The knocked room ID must be returned in the <code>room_id</code> field.</p>
</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td><p>You do not have permission to knock on the room. A meaningful <code>errcode</code>
and description error text will be returned. Example reasons for rejection are:</p>
<ul>
<li>The room is not set up for knocking.</li>
<li>The user has been banned from the room.</li>
</ul>
</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The room could not be found or resolved to a room ID.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The knocked room ID.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!d41d8cd:matrix.org&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3knockroomidoralias_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;You are not allowed to knock on this room.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3knockroomidoralias_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;That room does not appear to exist.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3knockroomidoralias_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h5 id="restricted-rooms">Restricted rooms</h5>
<p><span><strong>[Added in <code>v1.2</code>]</strong></span></p>
<p><span><strong>[Changed in <code>v1.3</code>]</strong></span></p>
<div class="alert note " role="alert">
<p>As of <code>v1.3</code>, it is possible to <a href="#knocking-on-rooms">knock</a> on a restricted
room if the room supports and is using the <code>knock_restricted</code> join rule.</p>
<p>Note that <code>knock_restricted</code> is only expected to work in room versions
<a href="/rooms/#feature-matrix">which support it</a>.</p>
</div>
<p>Restricted rooms are rooms with a <code>join_rule</code> of <code>restricted</code>. These rooms
are accompanied by &ldquo;allow conditions&rdquo; as described in the
<a href="#mroomjoin_rules"><code>m.room.join_rules</code></a> state event.</p>
<p>If the user has an invite to the room then the restrictions will not affect
them. They should be able to join by simply accepting the invite.</p>
<p>When joining without an invite, the server MUST verify that the requesting
user meets at least one of the conditions. If no conditions can be verified
or no conditions are satisfied, the user will not be able to join. When the
join is happening over federation, the remote server will check the conditions
before accepting the join. See the <a href="/server-server-api/#restricted-rooms">Server-Server Spec</a>
for more information.</p>
<p>If the room is <code>restricted</code> but no valid conditions are presented then the
room is effectively invite only.</p>
<p>The user does not need to maintain the conditions in order to stay a member
of the room: the conditions are only checked/evaluated during the join process.</p>
<h6 id="conditions">Conditions</h6>
<p>Currently there is only one condition available: <code>m.room_membership</code>. This
condition requires the user trying to join the room to be a <em>joined</em> member
of another room (specifically, the <code>room_id</code> accompanying the condition). For
example, if <code>!restricted:example.org</code> wanted to allow joined members of
<code>!other:example.org</code> to join, <code>!restricted:example.org</code> would have the following
<code>content</code> for <a href="#mroomjoin_rules"><code>m.room.join_rules</code></a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;join_rule&#34;</span><span class="p">:</span> <span class="s2">&#34;restricted&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;allow&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!other:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room_membership&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="leaving-rooms">Leaving rooms</h4>
<p>A user can leave a room to stop receiving events for that room. A user
must have been invited to or have joined the room before they are
eligible to leave the room. Leaving a room to which the user has been
invited rejects the invite, and can retract a knock. Once a user leaves
a room, it will no longer appear in the response to the
<a href="/client-server-api/#get_matrixclientv3sync"><code>/sync</code></a> API unless it is
explicitly requested via a filter with the <code>include_leave</code> field set
to <code>true</code>.</p>
<p>Whether or not they actually joined the room, if the room is an
&ldquo;invite-only&rdquo; room the user will need to be re-invited before they can
re-join the room.</p>
<p>A user can also forget a room which they have left. Rooms which have
been forgotten will never appear the response to the <a href="/client-server-api/#get_matrixclientv3sync"><code>/sync</code></a> API,
until the user re-joins, is re-invited, or knocks.</p>
<p>A user may wish to force another user to leave a room. This can be done
by &lsquo;kicking&rsquo; the other user. To do so, the user performing the kick MUST
have the required power level. Once a user has been kicked, the
behaviour is the same as if they had left of their own accord. In
particular, the user is free to re-join if the room is not
&ldquo;invite-only&rdquo;.</p>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3roomsroomidforget">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/rooms/{roomId}/forget</span>
  </h1>
</summary>
  <hr/>
<p><p>This API stops a user remembering about a particular room.</p>
<p>In general, history is a first class citizen in Matrix. After this API
is called, however, a user will no longer be able to retrieve history
for this room. If all users on a homeserver forget a room, the room is
eligible for deletion from that homeserver.</p>
<p>If the user is currently joined to the room, they must leave the room
before calling this API.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room identifier to forget.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The room has been forgotten.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td>The user has not left the room</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3roomsroomidforget_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_UNKNOWN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;User @example:matrix.org is in room !au1ba7o:matrix.org&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3roomsroomidforget_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3roomsroomidleave">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/rooms/{roomId}/leave</span>
  </h1>
</summary>
  <hr/>
<p><p>This API stops a user participating in a particular room.</p>
<p>If the user was already in the room, they will no longer be able to see
new events in the room. If the room requires an invite to join, they
will need to be re-invited before they can re-join.</p>
<p>If the user was invited to the room, but had not joined, this call
serves to reject the invite.</p>
<p>The user will still be allowed to retrieve history from the room which
they were previously allowed to see.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room identifier to leave.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>reason</code></td>
  <td><code>string</code></td>
  <td>
    Optional reason to be included as the <code>reason</code> on the subsequent
membership event.
<p><strong>Added in <code>v1.1</code></strong></p>
</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;Saying farewell - thanks for the support!&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The room has been left.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3roomsroomidleave_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3roomsroomidkick">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/rooms/{roomId}/kick</span>
  </h1>
</summary>
  <hr/>
<p><p>Kick a user from the room.</p>
<p>The caller must have the required power level in order to perform this operation.</p>
<p>Kicking a user adjusts the target member&rsquo;s membership state to be <code>leave</code> with an
optional <code>reason</code>. Like with other membership changes, a user can directly adjust
the target member&rsquo;s state by making a request to <code>/rooms/&lt;room id&gt;/state/m.room.member/&lt;user id&gt;</code>.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room identifier (not alias) from which the user should be kicked.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>reason</code></td>
  <td><code>string</code></td>
  <td>
    The reason the user has been kicked. This will be supplied as the
<code>reason</code> on the target&rsquo;s updated <a href="/client-server-api/#mroommember"><code>m.room.member</code></a> event.</td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The fully qualified user ID of the user being kicked.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;Telling unfunny jokes&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@cheeky_monkey:matrix.org&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The user has been kicked from the room.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td><p>You do not have permission to kick the user from the room. A meaningful <code>errcode</code> and
description error text will be returned. Example reasons for rejections are:</p>
<ul>
<li>The kicker is not currently in the room.</li>
<li>The kickee is not currently in the room.</li>
<li>The kicker&rsquo;s power level is insufficient to kick users from the room.</li>
</ul>
</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3roomsroomidkick_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;You do not have a high enough power level to kick from this room.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h5 id="banning-users-in-a-room">Banning users in a room</h5>
<p>A user may decide to ban another user in a room. &lsquo;Banning&rsquo; forces the
target user to leave the room and prevents them from re-joining the
room. A banned user will not be treated as a joined user, and so will
not be able to send or receive events in the room. In order to ban
someone, the user performing the ban MUST have the required power level.
To ban a user, a request should be made to <a href="/client-server-api/#post_matrixclientv3roomsroomidban"><code>/rooms/&lt;room_id&gt;/ban</code></a>
with:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;user id to ban&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;string: &lt;reason for the ban&gt;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Banning a user adjusts the banned member&rsquo;s membership state to <code>ban</code>.
Like with other membership changes, a user can directly adjust the
target member&rsquo;s state, by making a request to
<code>/rooms/&lt;room id&gt;/state/m.room.member/&lt;user id&gt;</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;ban&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>A user must be explicitly unbanned with a request to
<a href="/client-server-api/#post_matrixclientv3roomsroomidunban"><code>/rooms/&lt;room_id&gt;/unban</code></a> before they can re-join the room or be
re-invited.</p>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3roomsroomidban">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/rooms/{roomId}/ban</span>
  </h1>
</summary>
  <hr/>
<p><p>Ban a user in the room. If the user is currently in the room, also kick them.</p>
<p>When a user is banned from a room, they may not join it or be invited to it until they are unbanned.</p>
<p>The caller must have the required power level in order to perform this operation.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room identifier (not alias) from which the user should be banned.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>reason</code></td>
  <td><code>string</code></td>
  <td>
    The reason the user has been banned. This will be supplied as the <code>reason</code> on the target&rsquo;s updated <a href="/client-server-api/#mroommember"><code>m.room.member</code></a> event.
<p><strong>Added in <code>v1.1</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The fully qualified user ID of the user being banned.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;Telling unfunny jokes&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@cheeky_monkey:matrix.org&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The user has been kicked and banned from the room.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td><p>You do not have permission to ban the user from the room. A meaningful <code>errcode</code> and description error text will be returned. Example reasons for rejections are:</p>
<ul>
<li>The banner is not currently in the room.</li>
<li>The banner&rsquo;s power level is insufficient to ban users from the room.</li>
</ul>
</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3roomsroomidban_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;You do not have a high enough power level to ban from this room.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3roomsroomidunban">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/rooms/{roomId}/unban</span>
  </h1>
</summary>
  <hr/>
<p><p>Unban a user from the room. This allows them to be invited to the room,
and join if they would otherwise be allowed to join according to its join rules.</p>
<p>The caller must have the required power level in order to perform this operation.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room identifier (not alias) from which the user should be unbanned.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>reason</code></td>
  <td><code>string</code></td>
  <td>
    Optional reason to be included as the <code>reason</code> on the subsequent
membership event.
<p><strong>Added in <code>v1.1</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The fully qualified user ID of the user being unbanned.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;They&#39;ve been banned long enough&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@cheeky_monkey:matrix.org&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The user has been unbanned from the room.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td><p>You do not have permission to unban the user from the room. A meaningful <code>errcode</code> and description error text will be returned. Example reasons for rejections are:</p>
<ul>
<li>The unbanner&rsquo;s power level is insufficient to unban users from the room.</li>
</ul>
</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3roomsroomidunban_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;You do not have a high enough power level to unban from this room.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h3 id="listing-rooms">Listing rooms</h3>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3directorylistroomroomid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/directory/list/room/{roomId}</span>
  </h1>
</summary>
  <hr/>
<p>Gets the visibility of a given room on the server&rsquo;s public room directory.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The visibility of the room in the directory</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The room is not known to the server</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>visibility</code></td>
  <td><code>string</code></td>
  <td>
    The visibility of the room in the directory.<p>One of: <code>[private, public]</code>.</p></td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;visibility&#34;</span><span class="p">:</span> <span class="s2">&#34;public&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3directorylistroomroomid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Room not found&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixclientv3directorylistroomroomid">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/client/v3/directory/list/room/{roomId}</span>
  </h1>
</summary>
  <hr/>
<p><p>Sets the visibility of a given room in the server&rsquo;s public room
directory.</p>
<p>Servers may choose to implement additional access control checks
here, for instance that room visibility can only be changed by
the room creator or a server administrator.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>visibility</code></td>
  <td><code>string</code></td>
  <td>
    The new visibility setting for the room.
Defaults to &lsquo;public&rsquo;.<p>One of: <code>[private, public]</code>.</p></td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;visibility&#34;</span><span class="p">:</span> <span class="s2">&#34;public&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The visibility was updated, or no change was needed.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The room is not known to the server</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3directorylistroomroomid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Room not found&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3publicrooms">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/publicRooms</span>
  </h1>
</summary>
  <hr/>
<p><p>Lists the public rooms on the server.</p>
<p>This API returns paginated responses. The rooms are ordered by the number
of joined members, with the largest rooms first.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>limit</code></td>
  <td><code>integer</code></td>
  <td>
    Limit the number of results returned.</td>
 </tr>
 <tr>
  <td><code>server</code></td>
  <td><code>string</code></td>
  <td>
    The server to fetch the public room lists from. Defaults to the
local server. Case sensitive.</td>
 </tr>
 <tr>
  <td><code>since</code></td>
  <td><code>string</code></td>
  <td>
    A pagination token from a previous request, allowing clients to
get the next (or previous) batch of rooms.
The direction of pagination is specified solely by which token
is supplied, rather than via an explicit flag.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>A list of the rooms on the server.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>chunk</code></td>
  <td><code>[PublicRoomsChunk]</code></td>
  <td>
    <strong>Required: </strong>A paginated chunk of public rooms.</td>
 </tr>
 <tr>
  <td><code>next_batch</code></td>
  <td><code>string</code></td>
  <td>
    A pagination token for the response. The absence of this token
means there are no more results to fetch and the client should
stop paginating.</td>
 </tr>
 <tr>
  <td><code>prev_batch</code></td>
  <td><code>string</code></td>
  <td>
    A pagination token that allows fetching previous results. The
absence of this token means there are no results before this
batch, i.e. this is the first batch.</td>
 </tr>
 <tr>
  <td><code>total_room_count_estimate</code></td>
  <td><code>integer</code></td>
  <td>
    An estimate on the total number of public rooms, if the
server has an estimate.</td>
 </tr>
</table>
<table id="_matrixclientv3publicrooms_publicroomschunk" class="object-table">
 <caption>PublicRoomsChunk</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>avatar_url</code></td>
  <td><code>string</code></td>
  <td>
    The URL for the room&rsquo;s avatar, if one is set.</td>
 </tr>
 <tr>
  <td><code>canonical_alias</code></td>
  <td><code>string</code></td>
  <td>
    The canonical alias of the room, if any.</td>
 </tr>
 <tr>
  <td><code>guest_can_join</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether guest users may join the room and participate in it.
If they can, they will be subject to ordinary power level
rules like any other user.</td>
 </tr>
 <tr>
  <td><code>join_rule</code></td>
  <td><code>string</code></td>
  <td>
    The room&rsquo;s join rule. When not present, the room is assumed to
be <code>public</code>. Note that rooms with <code>invite</code> join rules are not
expected here, but rooms with <code>knock</code> rules are given their
near-public nature.</td>
 </tr>
 <tr>
  <td><code>name</code></td>
  <td><code>string</code></td>
  <td>
    The name of the room, if any.</td>
 </tr>
 <tr>
  <td><code>num_joined_members</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The number of members joined to the room.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room.</td>
 </tr>
 <tr>
  <td><code>room_type</code></td>
  <td><code>string</code></td>
  <td>
    The <code>type</code> of room (from <a href="/client-server-api/#mroomcreate"><code>m.room.create</code></a>), if any.
<p><strong>Added in <code>v1.4</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>topic</code></td>
  <td><code>string</code></td>
  <td>
    The topic of the room, if any.</td>
 </tr>
 <tr>
  <td><code>world_readable</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether the room may be viewed by guest users without joining.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;chunk&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://bleecker.street/CHEDDARandBRIE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;guest_can_join&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;join_rule&#34;</span><span class="p">:</span> <span class="s2">&#34;public&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;CHEESE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;num_joined_members&#34;</span><span class="p">:</span> <span class="mi">37</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!ol19s:bleecker.street&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.space&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;topic&#34;</span><span class="p">:</span> <span class="s2">&#34;Tasty tasty cheese&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;world_readable&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;next_batch&#34;</span><span class="p">:</span> <span class="s2">&#34;p190q&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;prev_batch&#34;</span><span class="p">:</span> <span class="s2">&#34;p1902&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;total_room_count_estimate&#34;</span><span class="p">:</span> <span class="mi">115</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3publicrooms">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/publicRooms</span>
  </h1>
</summary>
  <hr/>
<p><p>Lists the public rooms on the server, with optional filter.</p>
<p>This API returns paginated responses. The rooms are ordered by the number
of joined members, with the largest rooms first.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>server</code></td>
  <td><code>string</code></td>
  <td>
    The server to fetch the public room lists from. Defaults to the
local server. Case sensitive.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>filter</code></td>
  <td><code>Filter</code></td>
  <td>
    Filter to apply to the results.</td>
 </tr>
 <tr>
  <td><code>include_all_networks</code></td>
  <td><code>boolean</code></td>
  <td>
    Whether or not to include all known networks/protocols from
application services on the homeserver. Defaults to false.</td>
 </tr>
 <tr>
  <td><code>limit</code></td>
  <td><code>integer</code></td>
  <td>
    Limit the number of results returned.</td>
 </tr>
 <tr>
  <td><code>since</code></td>
  <td><code>string</code></td>
  <td>
    A pagination token from a previous request, allowing clients
to get the next (or previous) batch of rooms.  The direction
of pagination is specified solely by which token is supplied,
rather than via an explicit flag.</td>
 </tr>
 <tr>
  <td><code>third_party_instance_id</code></td>
  <td><code>string</code></td>
  <td>
    The specific third-party network/protocol to request from the
homeserver. Can only be used if <code>include_all_networks</code> is false.</td>
 </tr>
</table>
<table id="_matrixclientv3publicrooms_filter" class="object-table">
 <caption>Filter</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>generic_search_term</code></td>
  <td><code>string</code></td>
  <td>
    An optional string to search for in the room metadata, e.g. name,
topic, canonical alias, etc.</td>
 </tr>
 <tr>
  <td><code>room_types</code></td>
  <td><code>[string|null]</code></td>
  <td>
    An optional list of <a href="/client-server-api/#types">room types</a> to search
for. To include rooms without a room type, specify <code>null</code> within this
list. When not specified, all applicable rooms (regardless of type)
are returned.
<p><strong>Added in <code>v1.4</code></strong></p>
</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;filter&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;generic_search_term&#34;</span><span class="p">:</span> <span class="s2">&#34;foo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;room_types&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;m.space&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;include_all_networks&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;limit&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;third_party_instance_id&#34;</span><span class="p">:</span> <span class="s2">&#34;irc&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>A list of the rooms on the server.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>chunk</code></td>
  <td><code>[PublicRoomsChunk]</code></td>
  <td>
    <strong>Required: </strong>A paginated chunk of public rooms.</td>
 </tr>
 <tr>
  <td><code>next_batch</code></td>
  <td><code>string</code></td>
  <td>
    A pagination token for the response. The absence of this token
means there are no more results to fetch and the client should
stop paginating.</td>
 </tr>
 <tr>
  <td><code>prev_batch</code></td>
  <td><code>string</code></td>
  <td>
    A pagination token that allows fetching previous results. The
absence of this token means there are no results before this
batch, i.e. this is the first batch.</td>
 </tr>
 <tr>
  <td><code>total_room_count_estimate</code></td>
  <td><code>integer</code></td>
  <td>
    An estimate on the total number of public rooms, if the
server has an estimate.</td>
 </tr>
</table>
<table id="_matrixclientv3publicrooms_publicroomschunk" class="object-table">
 <caption>PublicRoomsChunk</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>avatar_url</code></td>
  <td><code>string</code></td>
  <td>
    The URL for the room&rsquo;s avatar, if one is set.</td>
 </tr>
 <tr>
  <td><code>canonical_alias</code></td>
  <td><code>string</code></td>
  <td>
    The canonical alias of the room, if any.</td>
 </tr>
 <tr>
  <td><code>guest_can_join</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether guest users may join the room and participate in it.
If they can, they will be subject to ordinary power level
rules like any other user.</td>
 </tr>
 <tr>
  <td><code>join_rule</code></td>
  <td><code>string</code></td>
  <td>
    The room&rsquo;s join rule. When not present, the room is assumed to
be <code>public</code>. Note that rooms with <code>invite</code> join rules are not
expected here, but rooms with <code>knock</code> rules are given their
near-public nature.</td>
 </tr>
 <tr>
  <td><code>name</code></td>
  <td><code>string</code></td>
  <td>
    The name of the room, if any.</td>
 </tr>
 <tr>
  <td><code>num_joined_members</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The number of members joined to the room.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room.</td>
 </tr>
 <tr>
  <td><code>room_type</code></td>
  <td><code>string</code></td>
  <td>
    The <code>type</code> of room (from <a href="/client-server-api/#mroomcreate"><code>m.room.create</code></a>), if any.
<p><strong>Added in <code>v1.4</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>topic</code></td>
  <td><code>string</code></td>
  <td>
    The topic of the room, if any.</td>
 </tr>
 <tr>
  <td><code>world_readable</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether the room may be viewed by guest users without joining.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;chunk&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://bleecker.street/CHEDDARandBRIE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;guest_can_join&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;join_rule&#34;</span><span class="p">:</span> <span class="s2">&#34;public&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;CHEESE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;num_joined_members&#34;</span><span class="p">:</span> <span class="mi">37</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!ol19s:bleecker.street&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.space&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;topic&#34;</span><span class="p">:</span> <span class="s2">&#34;Tasty tasty cheese&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;world_readable&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;next_batch&#34;</span><span class="p">:</span> <span class="s2">&#34;p190q&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;prev_batch&#34;</span><span class="p">:</span> <span class="s2">&#34;p1902&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;total_room_count_estimate&#34;</span><span class="p">:</span> <span class="mi">115</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h2 id="user-data">User Data</h2>
<h3 id="user-directory">User Directory</h3>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3user_directorysearch">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/user_directory/search</span>
  </h1>
</summary>
  <hr/>
<p><p>Performs a search for users. The homeserver may
determine which subset of users are searched, however the homeserver
MUST at a minimum consider the users the requesting user shares a
room with and those who reside in public rooms (known to the homeserver).
The search MUST consider local users to the homeserver, and SHOULD
query remote users as part of the search.</p>
<p>The search is performed case-insensitively on user IDs and display
names preferably using a collation determined based upon the
<code>Accept-Language</code> header provided in the request, if present.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>limit</code></td>
  <td><code>integer</code></td>
  <td>
    The maximum number of results to return. Defaults to 10.</td>
 </tr>
 <tr>
  <td><code>search_term</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The term to search for</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;limit&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;search_term&#34;</span><span class="p">:</span> <span class="s2">&#34;foo&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The results of the search.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>limited</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Indicates if the result list has been truncated by the limit.</td>
 </tr>
 <tr>
  <td><code>results</code></td>
  <td><code>[User]</code></td>
  <td>
    <strong>Required: </strong>Ordered by rank and then whether or not profile info is available.</td>
 </tr>
</table>
<table id="_matrixclientv3user_directorysearch_user" class="object-table">
 <caption>User</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>avatar_url</code></td>
  <td><code>string</code></td>
  <td>
    The avatar url, as an <a href="/client-server-api/#matrix-content-mxc-uris"><code>mxc://</code> URI</a>, if one exists.</td>
 </tr>
 <tr>
  <td><code>display_name</code></td>
  <td><code>string</code></td>
  <td>
    The display name of the user, if one exists.</td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user&rsquo;s matrix user ID.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;limited&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;results&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://bar.com/foo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;display_name&#34;</span><span class="p">:</span> <span class="s2">&#34;Foo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@foo:bar.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3user_directorysearch_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h3 id="profiles">Profiles</h3>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3profileuserid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/profile/{userId}</span>
  </h1>
</summary>
  <hr/>
<p>Get the combined profile information for this user. This API may be used
to fetch the user&rsquo;s own profile information or other users; either
locally or on remote homeservers. This API may return keys which are not
limited to <code>displayname</code> or <code>avatar_url</code>.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>userId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user whose profile information to get.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The profile information for this user.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The server is unwilling to disclose whether the user exists and/or has profile information.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>There is no profile information for this user or this user does not exist.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>avatar_url</code></td>
  <td><code>string</code></td>
  <td>
    The user&rsquo;s avatar URL if they have set one, otherwise not present.</td>
 </tr>
 <tr>
  <td><code>displayname</code></td>
  <td><code>string</code></td>
  <td>
    The user&rsquo;s display name if they have set one, otherwise not present.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://matrix.org/SDGdghriugerRg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;displayname&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice Margatroid&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3profileuserid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Profile lookup over federation is disabled on this homeserver&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3profileuserid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Profile not found&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3profileuseridavatar_url">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/profile/{userId}/avatar_url</span>
  </h1>
</summary>
  <hr/>
<p>Get the user&rsquo;s avatar URL. This API may be used to fetch the user&rsquo;s
own avatar URL or to query the URL of other users; either locally or
on remote homeservers.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>userId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user whose avatar URL to get.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The avatar URL for this user.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>There is no avatar URL for this user or this user does not exist.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>avatar_url</code></td>
  <td><code>string</code></td>
  <td>
    The user&rsquo;s avatar URL if they have set one, otherwise not present.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://matrix.org/SDGdghriugerRg&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixclientv3profileuseridavatar_url">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/client/v3/profile/{userId}/avatar_url</span>
  </h1>
</summary>
  <hr/>
<p>This API sets the given user&rsquo;s avatar URL. You must have permission to
set this user&rsquo;s avatar URL, e.g. you need to have their <code>access_token</code>.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>userId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user whose avatar URL to set.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>avatar_url</code></td>
  <td><code>string</code></td>
  <td>
    The new avatar URL for this user.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://matrix.org/wefh34uihSDRGhw34&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The avatar URL was set.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3profileuseridavatar_url_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3profileuseriddisplayname">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/profile/{userId}/displayname</span>
  </h1>
</summary>
  <hr/>
<p>Get the user&rsquo;s display name. This API may be used to fetch the user&rsquo;s
own displayname or to query the name of other users; either locally or
on remote homeservers.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>userId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user whose display name to get.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The display name for this user.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>There is no display name for this user or this user does not exist.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>displayname</code></td>
  <td><code>string</code></td>
  <td>
    The user&rsquo;s display name if they have set one, otherwise not present.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;displayname&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice Margatroid&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixclientv3profileuseriddisplayname">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/client/v3/profile/{userId}/displayname</span>
  </h1>
</summary>
  <hr/>
<p>This API sets the given user&rsquo;s display name. You must have permission to
set this user&rsquo;s display name, e.g. you need to have their <code>access_token</code>.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>userId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user whose display name to set.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>displayname</code></td>
  <td><code>string</code></td>
  <td>
    The new display name for this user.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;displayname&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice Margatroid&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The display name was set.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3profileuseriddisplayname_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h4 id="events-on-change-of-profile-information">Events on Change of Profile Information</h4>
<p>Because the profile display name and avatar information are likely to be
used in many places of a client&rsquo;s display, changes to these fields cause
an automatic propagation event to occur, informing likely-interested
parties of the new values. This change is conveyed using two separate
mechanisms:</p>
<ul>
<li>an <code>m.room.member</code> event (with a <code>join</code> membership) is sent to every
room the user is a member of, to update the <code>displayname</code> and
<code>avatar_url</code>.</li>
<li>an <code>m.presence</code> presence status update is sent, again containing the
new values of the <code>displayname</code> and <code>avatar_url</code> keys, in addition
to the required <code>presence</code> key containing the current presence state
of the user.</li>
</ul>
<p>Both of these should be done automatically by the homeserver when a user
successfully changes their display name or avatar URL fields.</p>
<p>Additionally, when homeservers emit room membership events for their own
users, they should include the display name and avatar URL fields in
these events so that clients already have these details to hand, and do
not have to perform extra round trips to query it.</p>
<h2 id="security">Security</h2>
<h3 id="rate-limiting">Rate limiting</h3>
<p>Homeservers SHOULD implement rate limiting to reduce the risk of being
overloaded. If a request is refused due to rate limiting, it should
return a standard error response of the form:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="err">integer</span> <span class="err">(optional)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The <code>retry_after_ms</code> key SHOULD be included to tell the client how long
they have to wait in milliseconds before they can try again.</p>
<h2 id="modules">Modules</h2>
<p>Modules are parts of the Client-Server API which are not universal to
all endpoints. Modules are strictly defined within this specification
and should not be mistaken for experimental extensions or optional
features. A compliant server implementation MUST support all modules and
supporting specification (unless the implementation only targets clients
of certain profiles, in which case only the required modules for those
feature profiles MUST be implemented). A compliant client implementation
MUST support all the required modules and supporting specification for
the <a href="#feature-profiles">Feature Profile</a> it targets.</p>
<h3 id="feature-profiles">Feature Profiles</h3>
<p>Matrix supports many different kinds of clients: from embedded IoT
devices to desktop clients. Not all clients can provide the same feature
sets as other clients e.g. due to lack of physical hardware such as not
having a screen. Clients can fall into one of several profiles and each
profile contains a set of features that the client MUST support. This
section details a set of &ldquo;feature profiles&rdquo;. Clients are expected to
implement a profile in its entirety in order for it to be classified as
that profile.</p>
<h4 id="summary">Summary</h4>
<table>
<thead>
<tr>
<th>Module / Profile</th>
<th>Web</th>
<th>Mobile</th>
<th>Desktop</th>
<th>CLI</th>
<th>Embedded</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="#instant-messaging">Instant Messaging</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#rich-replies">Rich replies</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#direct-messaging">Direct Messaging</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#user-and-room-mentions">Mentions</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#presence">Presence</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#push-notifications">Push Notifications</a></td>
<td>Optional</td>
<td>Required</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#receipts">Receipts</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#fully-read-markers">Fully read markers</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#typing-notifications">Typing Notifications</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#voice-over-ip">VoIP</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#ignoring-users">Ignoring Users</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#reporting-content">Reporting Content</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#content-repository">Content Repository</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#room-history-visibility">Managing History Visibility</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#server-side-search">Server Side Search</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#room-upgrades">Room Upgrades</a></td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Required</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#server-administration">Server Administration</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#event-context">Event Context</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#third-party-networks">Third-party Networks</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#send-to-device-messaging">Send-to-Device Messaging</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#device-management">Device Management</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#end-to-end-encryption">End-to-End Encryption</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#guest-access">Guest Accounts</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#room-previews">Room Previews</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#client-config">Client Config</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#sso-client-loginauthentication">SSO Login</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#openid">OpenID</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#sticker-messages">Stickers</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#server-access-control-lists-acls-for-rooms">Server ACLs</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#server-notices">Server Notices</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#moderation-policy-lists">Moderation policies</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#spaces">Spaces</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#event-replacements">Event Replacements</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#event-annotations-and-reactions">Event Annotations and reactions</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#threading">Threading</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
<tr>
<td><a href="#reference-relations">Reference Relations</a></td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
<td>Optional</td>
</tr>
</tbody>
</table>
<p><em>Please see each module for more details on what clients need to
implement.</em></p>
<h4 id="clients">Clients</h4>
<h5 id="stand-alone-web-web">Stand-alone web (<code>Web</code>)</h5>
<p>This is a web page which heavily uses Matrix for communication.
Single-page web apps would be classified as a stand-alone web client, as
would multi-page web apps which use Matrix on nearly every page.</p>
<h5 id="mobile-mobile">Mobile (<code>Mobile</code>)</h5>
<p>This is a Matrix client specifically designed for consumption on mobile
devices. This is typically a mobile app but need not be so provided the
feature set can be reached (e.g. if a mobile site could display push
notifications it could be classified as a mobile client).</p>
<h5 id="desktop-desktop">Desktop (<code>Desktop</code>)</h5>
<p>This is a native GUI application which can run in its own environment
outside a browser.</p>
<h5 id="command-line-interface-cli">Command Line Interface (<code>CLI</code>)</h5>
<p>This is a client which is used via a text-based terminal.</p>
<h5 id="embedded-embedded">Embedded (<code>Embedded</code>)</h5>
<p>This is a client which is embedded into another application or an
embedded device.</p>
<h6 id="application">Application</h6>
<p>This is a Matrix client which is embedded in another website, e.g. using
iframes. These embedded clients are typically for a single purpose
related to the website in question, and are not intended to be
fully-fledged communication apps.</p>
<h6 id="device">Device</h6>
<p>This is a client which is typically running on an embedded device such
as a kettle, fridge or car. These clients tend to perform a few
operations and run in a resource constrained environment. Like embedded
applications, they are not intended to be fully-fledged communication
systems.</p>
<p>




    
<h3 id="instant-messaging">Instant Messaging</h3>
<p>This module adds support for sending human-readable messages to a room.
It also adds support for associating human-readable information with the
room itself such as a room name and topic.</p>
<h4 id="events">Events</h4>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mroommessage">
   <code>m.room.message</code>
  </h1>
</summary>
  <hr/>
<p>This event is used when sending messages in a room. Messages are not limited to be text. The <code>msgtype</code> key outlines the type of message, e.g. text, audio, image, video, etc. The <code>body</code> key is text and MUST be used with every kind of <code>msgtype</code> as a fallback mechanism for when a client cannot render a message. This allows clients to display <em>something</em> even if it is just plain text.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>body</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The textual representation of this message.</td>
 </tr>
 <tr>
  <td><code>msgtype</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of message, e.g. <code>m.image</code>, <code>m.text</code></td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;This is an example text message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;org.matrix.custom.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;formatted_body&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;b&gt;This is an example text message&lt;/b&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mroomname">
   <code>m.room.name</code>
  </h1>
</summary>
  <hr/>
<p>A room has an opaque room ID which is not human-friendly to read. A room
alias is human-friendly, but not all rooms have room aliases. The room name
is a human-friendly string designed to be displayed to the end-user. The
room name is not unique, as multiple rooms can have the same room name set.</p>
<p>If a room has an <code>m.room.name</code> event with an absent, null, or empty <code>name</code>
field, it should be treated the same as a room with no <code>m.room.name</code> event.</p>
<p>An event of this type is automatically created when creating a room using
<code>/createRoom</code> with the <code>name</code> key.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>State event</td>
  </tr>
  <tr>
   <th>State key</th>
   <td>A zero-length string.</td>
 </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>name</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The name of the room.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;The room name&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.name&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mroomtopic">
   <code>m.room.topic</code>
  </h1>
</summary>
  <hr/>
<p>A topic is a short message detailing what is currently being discussed in the room.  It can also be used as a way to display extra information about the room, which may not be suitable for the room name. The room topic can also be set when creating a room using <code>/createRoom</code> with the <code>topic</code> key.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>State event</td>
  </tr>
  <tr>
   <th>State key</th>
   <td>A zero-length string.</td>
 </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>topic</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The topic text.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;topic&#34;</span><span class="p">:</span> <span class="s2">&#34;A room topic&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.topic&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mroomavatar">
   <code>m.room.avatar</code>
  </h1>
</summary>
  <hr/>
<p>A picture that is associated with the room. This can be displayed alongside the room information.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>State event</td>
  </tr>
  <tr>
   <th>State key</th>
   <td>A zero-length string.</td>
 </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>info</code></td>
  <td><code>ImageInfo</code></td>
  <td>
    Metadata about the image referred to in <code>url</code>.</td>
 </tr>
 <tr>
  <td><code>url</code></td>
  <td><code>string</code></td>
  <td>
    The URL to the image. If this property is not present, the room has no avatar. This can be useful
to remove a previous room avatar.</td>
 </tr>
</table>
<table id="mroomavatar_imageinfo" class="object-table">
 <caption>ImageInfo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>h</code></td>
  <td><code>integer</code></td>
  <td>
    The intended display height of the image in pixels. This may
differ from the intrinsic dimensions of the image file.</td>
 </tr>
 <tr>
  <td><code>mimetype</code></td>
  <td><code>string</code></td>
  <td>
    The mimetype of the image, e.g. <code>image/jpeg</code>.</td>
 </tr>
 <tr>
  <td><code>size</code></td>
  <td><code>integer</code></td>
  <td>
    Size of the image in bytes.</td>
 </tr>
 <tr>
  <td><code>thumbnail_file</code></td>
  <td><code>EncryptedFile</code></td>
  <td>
    Information on the encrypted thumbnail file, as specified in
<a href="/client-server-api/#sending-encrypted-attachments">End-to-end encryption</a>.
Only present if the thumbnail is encrypted.</td>
 </tr>
 <tr>
  <td><code>thumbnail_info</code></td>
  <td><code>ThumbnailInfo</code></td>
  <td>
    Metadata about the image referred to in <code>thumbnail_url</code>.</td>
 </tr>
 <tr>
  <td><code>thumbnail_url</code></td>
  <td><code>string</code></td>
  <td>
    The URL (typically <a href="/client-server-api/#matrix-content-mxc-uris"><code>mxc://</code> URI</a>) to a thumbnail of the image.
Only present if the thumbnail is unencrypted.</td>
 </tr>
 <tr>
  <td><code>w</code></td>
  <td><code>integer</code></td>
  <td>
    The intended display width of the image in pixels. This may
differ from the intrinsic dimensions of the image file.</td>
 </tr>
</table>
<table id="mroomavatar_thumbnailinfo" class="object-table">
 <caption>ThumbnailInfo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>h</code></td>
  <td><code>integer</code></td>
  <td>
    The intended display height of the image in pixels. This may
differ from the intrinsic dimensions of the image file.</td>
 </tr>
 <tr>
  <td><code>mimetype</code></td>
  <td><code>string</code></td>
  <td>
    The mimetype of the image, e.g. <code>image/jpeg</code>.</td>
 </tr>
 <tr>
  <td><code>size</code></td>
  <td><code>integer</code></td>
  <td>
    Size of the image in bytes.</td>
 </tr>
 <tr>
  <td><code>w</code></td>
  <td><code>integer</code></td>
  <td>
    The intended display width of the image in pixels. This may
differ from the intrinsic dimensions of the image file.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;info&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;h&#34;</span><span class="p">:</span> <span class="mi">398</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;mimetype&#34;</span><span class="p">:</span> <span class="s2">&#34;image/jpeg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">31037</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;w&#34;</span><span class="p">:</span> <span class="mi">394</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/JWEIFJgwEIhweiWJE&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.avatar&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mroompinned_events">
   <code>m.room.pinned_events</code>
  </h1>
</summary>
  <hr/>
<p>This event is used to pin particular events in a room for other participants to review later. The order of the pinned events is guaranteed and based upon the order supplied in the event. Clients should be aware that the current user may not be able to see some of the events pinned due to visibility settings in the room. Clients are responsible for determining if a particular event in the pinned list is displayable, and have the option to not display it if it cannot be pinned in the client.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>State event</td>
  </tr>
  <tr>
   <th>State key</th>
   <td>A zero-length string.</td>
 </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>pinned</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>An ordered list of event IDs to pin.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;pinned&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;$someevent:example.org&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.pinned_events&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h5 id="mroommessage-msgtypes">m.room.message msgtypes</h5>
<p>Each <a href="#mroommessage">m.room.message</a> MUST have a <code>msgtype</code> key which identifies the
type of message being sent. Each type has their own required and
optional keys, as outlined below. If a client cannot display the given
<code>msgtype</code> then it SHOULD display the fallback plain text <code>body</code> key
instead.</p>
<p>Some message types support HTML in the event content that clients should
prefer to display if available. Currently <code>m.text</code>, <code>m.emote</code>, <code>m.notice</code>,
and <code>m.key.verification.request</code> support an additional <code>format</code> parameter of
<code>org.matrix.custom.html</code>. When this field is present, a <code>formatted_body</code>
with the HTML must be provided. The plain text version of the HTML
should be provided in the <code>body</code>.</p>
<p>Clients should limit the HTML they render to avoid Cross-Site Scripting,
HTML injection, and similar attacks. The strongly suggested set of HTML
tags to permit, denying the use and rendering of anything else, is:
<code>font</code>, <code>del</code>, <code>h1</code>, <code>h2</code>, <code>h3</code>, <code>h4</code>, <code>h5</code>, <code>h6</code>, <code>blockquote</code>, <code>p</code>,
<code>a</code>, <code>ul</code>, <code>ol</code>, <code>sup</code>, <code>sub</code>, <code>li</code>, <code>b</code>, <code>i</code>, <code>u</code>, <code>strong</code>, <code>em</code>,
<code>strike</code>, <code>code</code>, <code>hr</code>, <code>br</code>, <code>div</code>, <code>table</code>, <code>thead</code>, <code>tbody</code>, <code>tr</code>,
<code>th</code>, <code>td</code>, <code>caption</code>, <code>pre</code>, <code>span</code>, <code>img</code>, <code>details</code>, <code>summary</code>.</p>
<p>Not all attributes on those tags should be permitted as they may be
avenues for other disruption attempts, such as adding <code>onclick</code> handlers
or excessively large text. Clients should only permit the attributes
listed for the tags below. Where <code>data-mx-bg-color</code> and <code>data-mx-color</code>
are listed, clients should translate the value (a <code>#</code> character followed
by a 6-character hex color code) to the appropriate CSS/attributes for
the tag.</p>
<table>
<thead>
<tr>
<th>Tag</th>
<th>Permitted Attributes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>font</code></td>
<td><code>data-mx-bg-color</code>, <code>data-mx-color</code>, <code>color</code></td>
</tr>
<tr>
<td><code>span</code></td>
<td><code>data-mx-bg-color</code>, <code>data-mx-color</code>, <code>data-mx-spoiler</code> (see <a href="#spoiler-messages">spoiler messages</a>)</td>
</tr>
<tr>
<td><code>a</code></td>
<td><code>name</code>, <code>target</code>, <code>href</code> (provided the value is not relative and has a scheme matching one of: <code>https</code>, <code>http</code>, <code>ftp</code>, <code>mailto</code>, <code>magnet</code>)</td>
</tr>
<tr>
<td><code>img</code></td>
<td><code>width</code>, <code>height</code>, <code>alt</code>, <code>title</code>, <code>src</code> (provided it is a <a href="#matrix-content-mxc-uris">Matrix Content (<code>mxc://</code>) URI</a>)</td>
</tr>
<tr>
<td><code>ol</code></td>
<td><code>start</code></td>
</tr>
<tr>
<td><code>code</code></td>
<td><code>class</code> (only classes which start with <code>language-</code> for syntax highlighting)</td>
</tr>
</tbody>
</table>
<p>Additionally, web clients should ensure that <em>all</em> <code>a</code> tags get a
<code>rel=&quot;noopener&quot;</code> to prevent the target page from referencing the
client&rsquo;s tab/window.</p>
<p>Tags must not be nested more than 100 levels deep. Clients should only
support the subset of tags they can render, falling back to other
representations of the tags where possible. For example, a client may
not be able to render tables correctly and instead could fall back to
rendering tab-delimited text.</p>
<p>In addition to not rendering unsafe HTML, clients should not emit unsafe
HTML in events. Likewise, clients should not generate HTML that is not
needed, such as extra paragraph tags surrounding text due to Rich Text
Editors. HTML included in events should otherwise be valid, such as
having appropriate closing tags, appropriate attributes (considering the
custom ones defined in this specification), and generally valid
structure.</p>
<p>A special tag, <code>mx-reply</code>, may appear on rich replies (described below)
and should be allowed if, and only if, the tag appears as the very first
tag in the <code>formatted_body</code>. The tag cannot be nested and cannot be
located after another tag in the tree. Because the tag contains HTML, an
<code>mx-reply</code> is expected to have a partner closing tag and should be
treated similar to a <code>div</code>. Clients that support rich replies will end
up stripping the tag and its contents and therefore may wish to exclude
the tag entirely.</p>
<div class="alert note " role="alert">
A future iteration of the specification will support more powerful and
extensible message formatting options, such as the proposal
<a href="https://github.com/matrix-org/matrix-spec-proposals/pull/1767">MSC1767</a>.
</div>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mtext">
   <code>m.text</code>
  </h1>
</summary>
  <hr/>
<p>This message is the most basic message and is used to represent text.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>body</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The body of the message.</td>
 </tr>
 <tr>
  <td><code>format</code></td>
  <td><code>string</code></td>
  <td>
    The format used in the <code>formatted_body</code>. Currently only
<code>org.matrix.custom.html</code> is supported.</td>
 </tr>
 <tr>
  <td><code>formatted_body</code></td>
  <td><code>string</code></td>
  <td>
    The formatted version of the <code>body</code>. This is required if <code>format</code>
is specified.</td>
 </tr>
 <tr>
  <td><code>msgtype</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><p>One of: <code>[m.text]</code>.</p></td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;This is an example text message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;org.matrix.custom.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;formatted_body&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;b&gt;This is an example text message&lt;/b&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="memote">
   <code>m.emote</code>
  </h1>
</summary>
  <hr/>
<p>This message is similar to <code>m.text</code> except that the sender is performing the action contained in the <code>body</code> key, similar to <code>/me</code> in IRC. This message should be prefixed by the name of the sender. This message could also be represented in a different colour to distinguish it from regular <code>m.text</code> messages.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>body</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The emote action to perform.</td>
 </tr>
 <tr>
  <td><code>format</code></td>
  <td><code>string</code></td>
  <td>
    The format used in the <code>formatted_body</code>. Currently only
<code>org.matrix.custom.html</code> is supported.</td>
 </tr>
 <tr>
  <td><code>formatted_body</code></td>
  <td><code>string</code></td>
  <td>
    The formatted version of the <code>body</code>. This is required if <code>format</code>
is specified.</td>
 </tr>
 <tr>
  <td><code>msgtype</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><p>One of: <code>[m.emote]</code>.</p></td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;thinks this is an example emote&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;org.matrix.custom.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;formatted_body&#34;</span><span class="p">:</span> <span class="s2">&#34;thinks &lt;b&gt;this&lt;/b&gt; is an example emote&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.emote&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mnotice">
   <code>m.notice</code>
  </h1>
</summary>
  <hr/>
<p>The <code>m.notice</code> type is primarily intended for responses from automated clients. An <code>m.notice</code> message must be treated the same way as a regular <code>m.text</code> message with two exceptions. Firstly, clients should present <code>m.notice</code> messages to users in a distinct manner, and secondly, <code>m.notice</code> messages must never be automatically responded to. This helps to prevent infinite-loop situations where two automated clients continuously exchange messages.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>body</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The notice text to send.</td>
 </tr>
 <tr>
  <td><code>format</code></td>
  <td><code>string</code></td>
  <td>
    The format used in the <code>formatted_body</code>. Currently only
<code>org.matrix.custom.html</code> is supported.</td>
 </tr>
 <tr>
  <td><code>formatted_body</code></td>
  <td><code>string</code></td>
  <td>
    The formatted version of the <code>body</code>. This is required if <code>format</code>
is specified.</td>
 </tr>
 <tr>
  <td><code>msgtype</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><p>One of: <code>[m.notice]</code>.</p></td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;This is an example notice&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;org.matrix.custom.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;formatted_body&#34;</span><span class="p">:</span> <span class="s2">&#34;This is an &lt;strong&gt;example&lt;/strong&gt; notice&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.notice&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mimage">
   <code>m.image</code>
  </h1>
</summary>
  <hr/>
<p>This message represents a single image and an optional thumbnail.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>body</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A textual representation of the image. This could be the alt text of the image, the filename of the image, or some kind of content description for accessibility e.g. &lsquo;image attachment&rsquo;.</td>
 </tr>
 <tr>
  <td><code>file</code></td>
  <td><code>EncryptedFile</code></td>
  <td>
    Required if the file is encrypted. Information on the encrypted
file, as specified in
<a href="/client-server-api/#sending-encrypted-attachments">End-to-end encryption</a>.</td>
 </tr>
 <tr>
  <td><code>info</code></td>
  <td><code>ImageInfo</code></td>
  <td>
    Metadata about the image referred to in <code>url</code>.</td>
 </tr>
 <tr>
  <td><code>msgtype</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><p>One of: <code>[m.image]</code>.</p></td>
 </tr>
 <tr>
  <td><code>url</code></td>
  <td><code>string</code></td>
  <td>
    Required if the file is unencrypted. The URL (typically <a href="/client-server-api/#matrix-content-mxc-uris"><code>mxc://</code> URI</a>)
to the image.</td>
 </tr>
</table>
<table id="mimage_imageinfo" class="object-table">
 <caption>ImageInfo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>h</code></td>
  <td><code>integer</code></td>
  <td>
    The intended display height of the image in pixels. This may
differ from the intrinsic dimensions of the image file.</td>
 </tr>
 <tr>
  <td><code>mimetype</code></td>
  <td><code>string</code></td>
  <td>
    The mimetype of the image, e.g. <code>image/jpeg</code>.</td>
 </tr>
 <tr>
  <td><code>size</code></td>
  <td><code>integer</code></td>
  <td>
    Size of the image in bytes.</td>
 </tr>
 <tr>
  <td><code>thumbnail_file</code></td>
  <td><code>EncryptedFile</code></td>
  <td>
    Information on the encrypted thumbnail file, as specified in
<a href="/client-server-api/#sending-encrypted-attachments">End-to-end encryption</a>.
Only present if the thumbnail is encrypted.</td>
 </tr>
 <tr>
  <td><code>thumbnail_info</code></td>
  <td><code>ThumbnailInfo</code></td>
  <td>
    Metadata about the image referred to in <code>thumbnail_url</code>.</td>
 </tr>
 <tr>
  <td><code>thumbnail_url</code></td>
  <td><code>string</code></td>
  <td>
    The URL (typically <a href="/client-server-api/#matrix-content-mxc-uris"><code>mxc://</code> URI</a>) to a thumbnail of the image.
Only present if the thumbnail is unencrypted.</td>
 </tr>
 <tr>
  <td><code>w</code></td>
  <td><code>integer</code></td>
  <td>
    The intended display width of the image in pixels. This may
differ from the intrinsic dimensions of the image file.</td>
 </tr>
</table>
<table id="mimage_thumbnailinfo" class="object-table">
 <caption>ThumbnailInfo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>h</code></td>
  <td><code>integer</code></td>
  <td>
    The intended display height of the image in pixels. This may
differ from the intrinsic dimensions of the image file.</td>
 </tr>
 <tr>
  <td><code>mimetype</code></td>
  <td><code>string</code></td>
  <td>
    The mimetype of the image, e.g. <code>image/jpeg</code>.</td>
 </tr>
 <tr>
  <td><code>size</code></td>
  <td><code>integer</code></td>
  <td>
    Size of the image in bytes.</td>
 </tr>
 <tr>
  <td><code>w</code></td>
  <td><code>integer</code></td>
  <td>
    The intended display width of the image in pixels. This may
differ from the intrinsic dimensions of the image file.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;filename.jpg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;info&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;h&#34;</span><span class="p">:</span> <span class="mi">398</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;mimetype&#34;</span><span class="p">:</span> <span class="s2">&#34;image/jpeg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">31037</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;w&#34;</span><span class="p">:</span> <span class="mi">394</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.image&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/JWEIFJgwEIhweiWJE&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mfile">
   <code>m.file</code>
  </h1>
</summary>
  <hr/>
<p>This message represents a generic file.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>body</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A human-readable description of the file. This is recommended to be the filename of the original upload.</td>
 </tr>
 <tr>
  <td><code>file</code></td>
  <td><code>EncryptedFile</code></td>
  <td>
    Required if the file is encrypted. Information on the encrypted
file, as specified in
<a href="/client-server-api/#sending-encrypted-attachments">End-to-end encryption</a>.</td>
 </tr>
 <tr>
  <td><code>filename</code></td>
  <td><code>string</code></td>
  <td>
    The original filename of the uploaded file.</td>
 </tr>
 <tr>
  <td><code>info</code></td>
  <td><code>FileInfo</code></td>
  <td>
    Information about the file referred to in <code>url</code>.</td>
 </tr>
 <tr>
  <td><code>msgtype</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><p>One of: <code>[m.file]</code>.</p></td>
 </tr>
 <tr>
  <td><code>url</code></td>
  <td><code>string</code></td>
  <td>
    Required if the file is unencrypted. The URL (typically <a href="/client-server-api/#matrix-content-mxc-uris"><code>mxc://</code> URI</a>)
to the file.</td>
 </tr>
</table>
<table id="mfile_fileinfo" class="object-table">
 <caption>FileInfo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>mimetype</code></td>
  <td><code>string</code></td>
  <td>
    The mimetype of the file e.g. <code>application/msword</code>.</td>
 </tr>
 <tr>
  <td><code>size</code></td>
  <td><code>integer</code></td>
  <td>
    The size of the file in bytes.</td>
 </tr>
 <tr>
  <td><code>thumbnail_file</code></td>
  <td><code>EncryptedFile</code></td>
  <td>
    Information on the encrypted thumbnail file, as specified in
<a href="/client-server-api/#sending-encrypted-attachments">End-to-end encryption</a>.
Only present if the thumbnail is encrypted.</td>
 </tr>
 <tr>
  <td><code>thumbnail_info</code></td>
  <td><code>ThumbnailInfo</code></td>
  <td>
    Metadata about the image referred to in <code>thumbnail_url</code>.</td>
 </tr>
 <tr>
  <td><code>thumbnail_url</code></td>
  <td><code>string</code></td>
  <td>
    The URL to the thumbnail of the file. Only present if the
thumbnail is unencrypted.</td>
 </tr>
</table>
<table id="mfile_thumbnailinfo" class="object-table">
 <caption>ThumbnailInfo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>h</code></td>
  <td><code>integer</code></td>
  <td>
    The intended display height of the image in pixels. This may
differ from the intrinsic dimensions of the image file.</td>
 </tr>
 <tr>
  <td><code>mimetype</code></td>
  <td><code>string</code></td>
  <td>
    The mimetype of the image, e.g. <code>image/jpeg</code>.</td>
 </tr>
 <tr>
  <td><code>size</code></td>
  <td><code>integer</code></td>
  <td>
    Size of the image in bytes.</td>
 </tr>
 <tr>
  <td><code>w</code></td>
  <td><code>integer</code></td>
  <td>
    The intended display width of the image in pixels. This may
differ from the intrinsic dimensions of the image file.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;something-important.doc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;filename&#34;</span><span class="p">:</span> <span class="s2">&#34;something-important.doc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;info&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;mimetype&#34;</span><span class="p">:</span> <span class="s2">&#34;application/msword&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">46144</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.file&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/FHyPlCeYUSFFxlgbQYZmoEoe&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="maudio">
   <code>m.audio</code>
  </h1>
</summary>
  <hr/>
<p>This message represents a single audio clip.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>body</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A description of the audio e.g. &lsquo;Bee Gees - Stayin&rsquo; Alive&rsquo;, or some kind of content description for accessibility e.g. &lsquo;audio attachment&rsquo;.</td>
 </tr>
 <tr>
  <td><code>file</code></td>
  <td><code>EncryptedFile</code></td>
  <td>
    Required if the file is encrypted. Information on the encrypted
file, as specified in
<a href="/client-server-api/#sending-encrypted-attachments">End-to-end encryption</a>.</td>
 </tr>
 <tr>
  <td><code>info</code></td>
  <td><code>AudioInfo</code></td>
  <td>
    Metadata for the audio clip referred to in <code>url</code>.</td>
 </tr>
 <tr>
  <td><code>msgtype</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><p>One of: <code>[m.audio]</code>.</p></td>
 </tr>
 <tr>
  <td><code>url</code></td>
  <td><code>string</code></td>
  <td>
    Required if the file is unencrypted. The URL (typically <a href="/client-server-api/#matrix-content-mxc-uris"><code>mxc://</code> URI</a>)
to the audio clip.</td>
 </tr>
</table>
<table id="maudio_audioinfo" class="object-table">
 <caption>AudioInfo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>duration</code></td>
  <td><code>integer</code></td>
  <td>
    The duration of the audio in milliseconds.</td>
 </tr>
 <tr>
  <td><code>mimetype</code></td>
  <td><code>string</code></td>
  <td>
    The mimetype of the audio e.g. <code>audio/aac</code>.</td>
 </tr>
 <tr>
  <td><code>size</code></td>
  <td><code>integer</code></td>
  <td>
    The size of the audio clip in bytes.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;Bee Gees - Stayin&#39; Alive&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;info&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;duration&#34;</span><span class="p">:</span> <span class="mi">2140786</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;mimetype&#34;</span><span class="p">:</span> <span class="s2">&#34;audio/mpeg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">1563685</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.audio&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/ffed755USFFxlgbQYZGtryd&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mlocation">
   <code>m.location</code>
  </h1>
</summary>
  <hr/>
<p>This message represents a real-world location.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>body</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A description of the location e.g. &lsquo;Big Ben, London, UK&rsquo;, or some kind of content description for accessibility e.g. &rsquo;location attachment&rsquo;.</td>
 </tr>
 <tr>
  <td><code>geo_uri</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A <a href="https://datatracker.ietf.org/doc/html/rfc5870">geo URI (RFC5870)</a> representing this location.</td>
 </tr>
 <tr>
  <td><code>info</code></td>
  <td><code>LocationInfo</code></td>
  <td>
    </td>
 </tr>
 <tr>
  <td><code>msgtype</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><p>One of: <code>[m.location]</code>.</p></td>
 </tr>
</table>
<table id="mlocation_locationinfo" class="object-table">
 <caption>LocationInfo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>thumbnail_file</code></td>
  <td><code>EncryptedFile</code></td>
  <td>
    Information on the encrypted thumbnail file, as specified in
<a href="/client-server-api/#sending-encrypted-attachments">End-to-end encryption</a>.
Only present if the thumbnail is encrypted.</td>
 </tr>
 <tr>
  <td><code>thumbnail_info</code></td>
  <td><code>ThumbnailInfo</code></td>
  <td>
    Metadata about the image referred to in <code>thumbnail_url</code>.</td>
 </tr>
 <tr>
  <td><code>thumbnail_url</code></td>
  <td><code>string</code></td>
  <td>
    The URL to a thumbnail of the location being represented.
Only present if the thumbnail is unencrypted.</td>
 </tr>
</table>
<table id="mlocation_thumbnailinfo" class="object-table">
 <caption>ThumbnailInfo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>h</code></td>
  <td><code>integer</code></td>
  <td>
    The intended display height of the image in pixels. This may
differ from the intrinsic dimensions of the image file.</td>
 </tr>
 <tr>
  <td><code>mimetype</code></td>
  <td><code>string</code></td>
  <td>
    The mimetype of the image, e.g. <code>image/jpeg</code>.</td>
 </tr>
 <tr>
  <td><code>size</code></td>
  <td><code>integer</code></td>
  <td>
    Size of the image in bytes.</td>
 </tr>
 <tr>
  <td><code>w</code></td>
  <td><code>integer</code></td>
  <td>
    The intended display width of the image in pixels. This may
differ from the intrinsic dimensions of the image file.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;Big Ben, London, UK&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;geo_uri&#34;</span><span class="p">:</span> <span class="s2">&#34;geo:51.5008,0.1247&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;info&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;thumbnail_info&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;h&#34;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;mimetype&#34;</span><span class="p">:</span> <span class="s2">&#34;image/jpeg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">46144</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;w&#34;</span><span class="p">:</span> <span class="mi">300</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;thumbnail_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/FHyPlCeYUSFFxlgbQYZmoEoe&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.location&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mvideo">
   <code>m.video</code>
  </h1>
</summary>
  <hr/>
<p>This message represents a single video clip.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>body</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A description of the video e.g. &lsquo;Gangnam style&rsquo;, or some kind of content description for accessibility e.g. &lsquo;video attachment&rsquo;.</td>
 </tr>
 <tr>
  <td><code>file</code></td>
  <td><code>EncryptedFile</code></td>
  <td>
    Required if the file is encrypted. Information on the encrypted
file, as specified in
<a href="/client-server-api/#sending-encrypted-attachments">End-to-end encryption</a>.</td>
 </tr>
 <tr>
  <td><code>info</code></td>
  <td><code>VideoInfo</code></td>
  <td>
    Metadata about the video clip referred to in <code>url</code>.</td>
 </tr>
 <tr>
  <td><code>msgtype</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><p>One of: <code>[m.video]</code>.</p></td>
 </tr>
 <tr>
  <td><code>url</code></td>
  <td><code>string</code></td>
  <td>
    Required if the file is unencrypted. The URL (typically <a href="/client-server-api/#matrix-content-mxc-uris"><code>mxc://</code> URI</a>)
to the video clip.</td>
 </tr>
</table>
<table id="mvideo_videoinfo" class="object-table">
 <caption>VideoInfo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>duration</code></td>
  <td><code>integer</code></td>
  <td>
    The duration of the video in milliseconds.</td>
 </tr>
 <tr>
  <td><code>h</code></td>
  <td><code>integer</code></td>
  <td>
    The height of the video in pixels.</td>
 </tr>
 <tr>
  <td><code>mimetype</code></td>
  <td><code>string</code></td>
  <td>
    The mimetype of the video e.g. <code>video/mp4</code>.</td>
 </tr>
 <tr>
  <td><code>size</code></td>
  <td><code>integer</code></td>
  <td>
    The size of the video in bytes.</td>
 </tr>
 <tr>
  <td><code>thumbnail_file</code></td>
  <td><code>EncryptedFile</code></td>
  <td>
    Information on the encrypted thumbnail file, as specified in
<a href="/client-server-api/#sending-encrypted-attachments">End-to-end encryption</a>.
Only present if the thumbnail is encrypted.</td>
 </tr>
 <tr>
  <td><code>thumbnail_info</code></td>
  <td><code>ThumbnailInfo</code></td>
  <td>
    Metadata about the image referred to in <code>thumbnail_url</code>.</td>
 </tr>
 <tr>
  <td><code>thumbnail_url</code></td>
  <td><code>string</code></td>
  <td>
    The URL (typically <a href="/client-server-api/#matrix-content-mxc-uris"><code>mxc://</code> URI</a>) to an image thumbnail of
the video clip. Only present if the thumbnail is unencrypted.</td>
 </tr>
 <tr>
  <td><code>w</code></td>
  <td><code>integer</code></td>
  <td>
    The width of the video in pixels.</td>
 </tr>
</table>
<table id="mvideo_thumbnailinfo" class="object-table">
 <caption>ThumbnailInfo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>h</code></td>
  <td><code>integer</code></td>
  <td>
    The intended display height of the image in pixels. This may
differ from the intrinsic dimensions of the image file.</td>
 </tr>
 <tr>
  <td><code>mimetype</code></td>
  <td><code>string</code></td>
  <td>
    The mimetype of the image, e.g. <code>image/jpeg</code>.</td>
 </tr>
 <tr>
  <td><code>size</code></td>
  <td><code>integer</code></td>
  <td>
    Size of the image in bytes.</td>
 </tr>
 <tr>
  <td><code>w</code></td>
  <td><code>integer</code></td>
  <td>
    The intended display width of the image in pixels. This may
differ from the intrinsic dimensions of the image file.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;Gangnam Style&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;info&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;duration&#34;</span><span class="p">:</span> <span class="mi">2140786</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;h&#34;</span><span class="p">:</span> <span class="mi">320</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;mimetype&#34;</span><span class="p">:</span> <span class="s2">&#34;video/mp4&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">1563685</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;thumbnail_info&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;h&#34;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;mimetype&#34;</span><span class="p">:</span> <span class="s2">&#34;image/jpeg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">46144</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;w&#34;</span><span class="p">:</span> <span class="mi">300</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;thumbnail_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/FHyPlCeYUSFFxlgbQYZmoEoe&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;w&#34;</span><span class="p">:</span> <span class="mi">480</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.video&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/a526eYUSFFxlgbQYZmo442&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h4 id="client-behaviour">Client behaviour</h4>
<p>Clients SHOULD verify the structure of incoming events to ensure that
the expected keys exist and that they are of the right type. Clients can
discard malformed events or display a placeholder message to the user.
Redacted <code>m.room.message</code> events MUST be removed from the client. This
can either be replaced with placeholder text (e.g. &ldquo;[REDACTED]&rdquo;) or
the redacted message can be removed entirely from the messages view.</p>
<p>Events which have attachments (e.g. <code>m.image</code>, <code>m.file</code>) SHOULD be
uploaded using the <a href="#content-repository">content repository module</a>
where available. The resulting <code>mxc://</code> URI can then be used in the <code>url</code>
key.</p>
<p>Clients MAY include a client generated thumbnail image for an attachment
under a <code>info.thumbnail_url</code> key. The thumbnail SHOULD also be a
<code>mxc://</code> URI. Clients displaying events with attachments can either use
the client generated thumbnail or ask its homeserver to generate a
thumbnail from the original attachment using the <a href="#content-repository">content repository
module</a>.</p>
<h5 id="recommendations-when-sending-messages">Recommendations when sending messages</h5>
<p>In the event of send failure, clients SHOULD retry requests using an
exponential-backoff algorithm for a certain amount of time T. It is
recommended that T is no longer than 5 minutes. After this time, the
client should stop retrying and mark the message as &ldquo;unsent&rdquo;. Users
should be able to manually resend unsent messages.</p>
<p>Users may type several messages at once and send them all in quick
succession. Clients SHOULD preserve the order in which they were sent by
the user. This means that clients should wait for the response to the
previous request before sending the next request. This can lead to
head-of-line blocking. In order to reduce the impact of head-of-line
blocking, clients should use a queue per room rather than a global
queue, as ordering is only relevant within a single room rather than
between rooms.</p>
<h5 id="local-echo">Local echo</h5>
<p>Messages SHOULD appear immediately in the message view when a user
presses the &ldquo;send&rdquo; button. This should occur even if the message is
still sending. This is referred to as &ldquo;local echo&rdquo;. Clients SHOULD
implement &ldquo;local echo&rdquo; of messages. Clients MAY display messages in a
different format to indicate that the server has not processed the
message. This format should be removed when the server responds.</p>
<p>Clients need to be able to match the message they are sending with the
same message which they receive from the event stream. The echo of the
same message from the event stream is referred to as &ldquo;remote echo&rdquo;. Both
echoes need to be identified as the same message in order to prevent
duplicate messages being displayed. Ideally this pairing would occur
transparently to the user: the UI would not flicker as it transitions
from local to remote. Flickering can be reduced through clients making
use of the transaction ID they used to send a particular event. The
transaction ID used will be included in the event&rsquo;s <code>unsigned</code> data as
<code>transaction_id</code> when it arrives through the event stream.</p>
<p>Clients unable to make use of the transaction ID are likely to
experience flickering when the remote echo arrives on the event stream
<em>before</em> the request to send the message completes. In that case the
event arrives before the client has obtained an event ID, making it
impossible to identify it as a remote echo. This results in the client
displaying the message twice for some time (depending on the server
responsiveness) before the original request to send the message
completes. Once it completes, the client can take remedial actions to
remove the duplicate event by looking for duplicate event IDs.</p>
<h5 id="calculating-the-display-name-for-a-user">Calculating the display name for a user</h5>
<p>Clients may wish to show the human-readable display name of a room
member as part of a membership list, or when they send a message.
However, different members may have conflicting display names. Display
names MUST be disambiguated before showing them to the user, in order to
prevent spoofing of other users.</p>
<p>To ensure this is done consistently across clients, clients SHOULD use
the following algorithm to calculate a disambiguated display name for a
given user:</p>
<ol>
<li>Inspect the <code>m.room.member</code> state event for the relevant user id.</li>
<li>If the <code>m.room.member</code> state event has no <code>displayname</code> field, or if
that field has a <code>null</code> value, use the raw user id as the display
name. Otherwise:</li>
<li>If the <code>m.room.member</code> event has a <code>displayname</code> which is unique
among members of the room with <code>membership: join</code> or
<code>membership: invite</code>, use the given <code>displayname</code> as the
user-visible display name. Otherwise:</li>
<li>The <code>m.room.member</code> event has a non-unique <code>displayname</code>. This
should be disambiguated using the user id, for example &ldquo;display name
(@id:homeserver.org)&rdquo;.</li>
</ol>
<p>Developers should take note of the following when implementing the above
algorithm:</p>
<ul>
<li>The user-visible display name of one member can be affected by
changes in the state of another member. For example, if
<code>@user1:matrix.org</code> is present in a room, with <code>displayname: Alice</code>,
then when <code>@user2:example.com</code> joins the room, also with
<code>displayname: Alice</code>, <em>both</em> users must be given disambiguated
display names. Similarly, when one of the users then changes their
display name, there is no longer a clash, and <em>both</em> users can be
given their chosen display name. Clients should be alert to this
possibility and ensure that all affected users are correctly
renamed.</li>
<li>The display name of a room may also be affected by changes in the
membership list. This is due to the room name sometimes being based
on user display names (see <a href="#calculating-the-display-name-for-a-room">Calculating the display name for a
room</a>).</li>
<li>If the entire membership list is searched for clashing display
names, this leads to an O(N^2) implementation for building the list
of room members. This will be very inefficient for rooms with large
numbers of members. It is recommended that client implementations
maintain a hash table mapping from <code>displayname</code> to a list of room
members using that name. Such a table can then be used for efficient
calculation of whether disambiguation is needed.</li>
</ul>
<h5 id="displaying-membership-information-with-messages">Displaying membership information with messages</h5>
<p>Clients may wish to show the display name and avatar URL of the room
member who sent a message. This can be achieved by inspecting the
<code>m.room.member</code> state event for that user ID (see <a href="#calculating-the-display-name-for-a-user">Calculating the
display name for a user</a>).</p>
<p>When a user paginates the message history, clients may wish to show the
<strong>historical</strong> display name and avatar URL for a room member. This is
possible because older <code>m.room.member</code> events are returned when
paginating. This can be implemented efficiently by keeping two sets of
room state: old and current. As new events arrive and/or the user
paginates back in time, these two sets of state diverge from each other.
New events update the current state and paginated events update the old
state. When paginated events are processed sequentially, the old state
represents the state of the room <em>at the time the event was sent</em>. This
can then be used to set the historical display name and avatar URL.</p>
<h5 id="calculating-the-display-name-for-a-room">Calculating the display name for a room</h5>
<p>Clients may wish to show a human-readable name for a room. There are a
number of possibilities for choosing a useful name. To ensure that rooms
are named consistently across clients, clients SHOULD use the following
algorithm to choose a name:</p>
<ol>
<li>If the room has an <a href="#mroomname">m.room.name</a> state event with a non-empty
<code>name</code> field, use the name given by that field.</li>
<li>If the room has an <a href="#mroomcanonical_alias">m.room.canonical_alias</a> state event with a
valid <code>alias</code> field, use the alias given by that field as the name.
Note that clients should avoid using <code>alt_aliases</code> when calculating
the room name.</li>
<li>If none of the above conditions are met, a name should be composed
based on the members of the room. Clients should consider
<a href="#mroommember">m.room.member</a> events for users other than the logged-in user, as
defined below.
<ol>
<li>If the number of <code>m.heroes</code> for the room are greater or equal to
<code>m.joined_member_count + m.invited_member_count - 1</code>, then use
the membership events for the heroes to calculate display names
for the users (<a href="#calculating-the-display-name-for-a-user">disambiguating them if
required</a>) and
concatenating them. For example, the client may choose to show
&ldquo;Alice, Bob, and Charlie (@charlie:example.org)&rdquo; as the room
name. The client may optionally limit the number of users it
uses to generate a room name.</li>
<li>If there are fewer heroes than
<code>m.joined_member_count + m.invited_member_count - 1</code>, and
<code>m.joined_member_count + m.invited_member_count</code> is greater than
1, the client should use the heroes to calculate display names
for the users (<a href="#calculating-the-display-name-for-a-user">disambiguating them if
required</a>) and
concatenating them alongside a count of the remaining users. For
example, &ldquo;Alice, Bob, and 1234 others&rdquo;.</li>
<li>If <code>m.joined_member_count + m.invited_member_count</code> is less than
or equal to 1 (indicating the member is alone), the client
should use the rules above to indicate that the room was empty.
For example, &ldquo;Empty Room (was Alice)&rdquo;, &ldquo;Empty Room (was Alice
and 1234 others)&rdquo;, or &ldquo;Empty Room&rdquo; if there are no heroes.</li>
</ol>
</li>
</ol>
<p>Clients SHOULD internationalise the room name to the user&rsquo;s language
when using the <code>m.heroes</code> to calculate the name. Clients SHOULD use
minimum 5 heroes to calculate room names where possible, but may use
more or less to fit better with their user experience.</p>
<h5 id="spoiler-messages">Spoiler messages</h5>
<p><span><strong>[Added in <code>v1.1</code>]</strong></span></p>
<p>Parts of a message can be hidden visually from the user through use of spoilers.
This does not affect the server&rsquo;s representation of the event content - it
is simply a visual cue to the user that the message may reveal important
information about something, spoiling any relevant surprise.</p>
<p>To send spoilers clients MUST use the <code>formatted_body</code> and therefore the
<code>org.matrix.custom.html</code> format, described above. This makes spoilers valid on
any <code>msgtype</code> which can support this format appropriately.</p>
<p>Spoilers themselves are contained with <code>span</code> tags, with the reason (optionally)
being in the <code>data-mx-spoiler</code> attribute. Spoilers without a reason must at least
specify the attribute, though the value may be empty/undefined.</p>
<p>An example of a spoiler is:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;org.matrix.custom.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice [Spoiler](mxc://example.org/abc123) in the movie.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;formatted_body&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice &lt;span data-mx-spoiler&gt;lived happily ever after&lt;/span&gt; in the movie.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>If a reason were to be supplied, it would look like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;org.matrix.custom.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice [Spoiler for health of Alice](mxc://example.org/abc123) in the movie.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;formatted_body&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice &lt;span data-mx-spoiler=&#39;health of alice&#39;&gt;lived happily ever after&lt;/span&gt; in the movie.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>When sending a spoiler, clients SHOULD provide the fallback in the <code>body</code> as shown above
(including the reason). The fallback SHOULD NOT include the text containing spoilers since
<code>body</code> might show up in text-only clients or in notifications. To prevent spoilers showing up in
such situations, clients are strongly encouraged to first upload the text containing spoilers
to the media repository, then reference the <code>mxc://</code> URI in a markdown-style link, as shown above.</p>
<p>Clients SHOULD render spoilers differently with some sort of disclosure. For example, the
client could blur the actual text and ask the user to click on it for it to be revealed.</p>
<h4 id="server-behaviour">Server behaviour</h4>
<p>Homeservers SHOULD reject <code>m.room.message</code> events which don&rsquo;t have a
<code>msgtype</code> key, or which don&rsquo;t have a textual <code>body</code> key, with an HTTP
status code of 400.</p>
<h4 id="security-considerations">Security considerations</h4>
<p>Messages sent using this module are not encrypted, although end to end
encryption is in development (see <a href="#end-to-end-encryption">E2E module</a>).</p>
<p>Clients should sanitise <strong>all displayed keys</strong> for unsafe HTML to
prevent Cross-Site Scripting (XSS) attacks. This includes room names and
topics.</p>

    







    
<h3 id="rich-replies">Rich replies</h3>
<p><span><strong>[Changed in <code>v1.3</code>]</strong></span></p>
<p>Rich replies are a
special kind of <a href="#forming-relationships-between-events">relationship</a> which
effectively quotes the referenced event for the client to render/process how
it wishes. They are normally used with <a href="#mroommessage"><code>m.room.message</code></a> events.</p>
<div class="alert note " role="alert">
<p>Until v1.3 of the spec, rich replies were limited to <code>m.room.message</code> events
which could represent an HTML-formatted body. As of v1.3 this is now expanded
to <em>all</em> event types by dropping the requirement that an HTML-formatted body
be included.</p>
<p>Additionally, a rich reply can reference any other event type as of v1.3.
Previously, a rich reply could only reference another <code>m.room.message</code> event.</p>
</div>
<p>When possible, events SHOULD include a <a href="#fallbacks-for-rich-replies">fallback representation</a>
to allow clients which do not render rich replies to still see something which
appears to be a quoted reply.</p>
<p>Though rich replies form a relationship to another event, they do not
use <code>rel_type</code> to create this relationship. Instead, a subkey named <code>m.in_reply_to</code>
is used to describe the reply&rsquo;s relationship, leaving the other properties of
<code>m.relates_to</code> to describe the primary relationship of the event. This means
that if an event is simply in reply to another event, without further relationship,
the <code>rel_type</code> and <code>event_id</code> properties of <code>m.relates_to</code> become <em>optional</em>.</p>
<p>An example reply would be:</p>
<pre tabindex="0"><code class="language-json5" data-lang="json5">{
  &#34;content&#34;: {
    &#34;m.relates_to&#34;: {
      &#34;m.in_reply_to&#34;: {
        &#34;event_id&#34;: &#34;$another_event&#34;
      }
    },
    &#34;body&#34;: &#34;That sounds like a great idea!&#34;
  },
  // other fields as required by events
}
</code></pre><p>Note that the <code>event_id</code> of the <code>m.in_reply_to</code> object has the same requirements
as if it were to be under <code>m.relates_to</code> directly instead.</p>
<h4 id="fallbacks-for-rich-replies">Fallbacks for rich replies</h4>
<p>Some clients may not have support for rich replies and therefore need a
fallback to use instead. Clients that do not support rich replies should
render the event as if rich replies were not special.</p>
<p>Clients that do support rich replies SHOULD provide the fallback format on
replies, and MUST strip the fallback before rendering the reply. The
specific fallback text is different for each <code>msgtype</code>, however the
general format for the <code>body</code> is:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">&gt; &lt;@alice:example.org&gt; This is the original body
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">This is where the reply goes
</span></span></code></pre></div><p>The <code>formatted_body</code>, if present and using an associated <code>format</code> of
<code>org.matrix.custom.html</code>, should use the following template:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">mx-reply</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">blockquote</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;https://matrix.to/#/!somewhere:example.org/$event:example.org&#34;</span><span class="p">&gt;</span>In reply to<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;https://matrix.to/#/@alice:example.org&#34;</span><span class="p">&gt;</span>@alice:example.org<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- This is where the related event&#39;s HTML would be. --&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">blockquote</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">mx-reply</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">This is where the reply goes.
</span></span></code></pre></div><p>If the related event does not have a <code>formatted_body</code>, the event&rsquo;s
<code>body</code> should be considered after encoding any HTML special characters.
Note that the <code>href</code> in both of the anchors use a <a href="/appendices#matrixto-navigation">matrix.to
URI</a>.</p>
<h5 id="stripping-the-fallback">Stripping the fallback</h5>
<p>Clients which support rich replies MUST strip the fallback from the
event before rendering the event. This is because the text provided in
the fallback cannot be trusted to be an accurate representation of the
event. After removing the fallback, clients are recommended to represent
the event referenced by <code>m.in_reply_to</code> similar to the fallback&rsquo;s
representation, although clients do have creative freedom for their user
interface. Clients should prefer the <code>formatted_body</code> over the <code>body</code>,
just like with other <code>m.room.message</code> events.</p>
<p>To strip the fallback on the <code>body</code>, the client should iterate over each
line of the string, removing any lines that start with the fallback
prefix (&quot;&gt; &ldquo;, including the space, without quotes) and stopping when
a line is encountered without the prefix. This prefix is known as the
&ldquo;fallback prefix sequence&rdquo;.</p>
<p>To strip the fallback on the <code>formatted_body</code>, the client should remove
the entirety of the <code>mx-reply</code> tag.</p>
<h5 id="fallback-for-mtext-mnotice-and-unrecognised-message-types">Fallback for <code>m.text</code>, <code>m.notice</code>, and unrecognised message types</h5>
<p>Using the prefix sequence, the first line of the related event&rsquo;s <code>body</code>
should be prefixed with the user&rsquo;s ID, followed by each line being
prefixed with the fallback prefix sequence. For example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">&gt; &lt;@alice:example.org&gt; This is the first line
</span></span><span class="line"><span class="cl">&gt; This is the second line
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">This is the reply
</span></span></code></pre></div><p>The <code>formatted_body</code> uses the template defined earlier in this section.</p>
<h5 id="fallback-for-memote">Fallback for <code>m.emote</code></h5>
<p>Similar to the fallback for <code>m.text</code>, each line gets prefixed with the
fallback prefix sequence. However an asterisk should be inserted before
the user&rsquo;s ID, like so:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">&gt; * &lt;@alice:example.org&gt; feels like today is going to be a great day
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">This is the reply
</span></span></code></pre></div><p>The <code>formatted_body</code> has a subtle difference for the template where the
asterisk is also inserted ahead of the user&rsquo;s ID:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">mx-reply</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">blockquote</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;https://matrix.to/#/!somewhere:example.org/$event:example.org&#34;</span><span class="p">&gt;</span>In reply to<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    * <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;https://matrix.to/#/@alice:example.org&#34;</span><span class="p">&gt;</span>@alice:example.org<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- This is where the related event&#39;s HTML would be. --&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">blockquote</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">mx-reply</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">This is where the reply goes.
</span></span></code></pre></div><h5 id="fallback-for-mimage-mvideo-maudio-and-mfile">Fallback for <code>m.image</code>, <code>m.video</code>, <code>m.audio</code>, and <code>m.file</code></h5>
<p>The related event&rsquo;s <code>body</code> would be a file name, which may not be very
descriptive. The related event should additionally not have a <code>format</code>
or <code>formatted_body</code> in the <code>content</code> - if the event does have a <code>format</code>
and/or <code>formatted_body</code>, those fields should be ignored. Because the
filename alone may not be descriptive, the related event&rsquo;s <code>body</code> should
be considered to be <code>&quot;sent a file.&quot;</code> such that the output looks similar
to the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">&gt; &lt;@alice:example.org&gt; sent a file.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">This is the reply
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">mx-reply</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">blockquote</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;https://matrix.to/#/!somewhere:example.org/$event:example.org&#34;</span><span class="p">&gt;</span>In reply to<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;https://matrix.to/#/@alice:example.org&#34;</span><span class="p">&gt;</span>@alice:example.org<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">    sent a file.
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">blockquote</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">mx-reply</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">This is where the reply goes.
</span></span></code></pre></div><p>For <code>m.image</code>, the text should be <code>&quot;sent an image.&quot;</code>. For <code>m.video</code>, the
text should be <code>&quot;sent a video.&quot;</code>. For <code>m.audio</code>, the text should be
<code>&quot;sent an audio file&quot;</code>.</p>
<h4 id="mentioning-the-replied-to-user">Mentioning the replied to user</h4>
<p>In order to notify users of the reply, it may be desirable to include the <code>sender</code>
of the replied to event and any users mentioned in that event. See
<a href="#user-and-room-mentions">user and room mentions</a> for additional information.</p>
<p>An example including mentioning the original sender and other users:</p>
<pre tabindex="0"><code class="language-json5" data-lang="json5">{
  &#34;content&#34;: {
    &#34;m.relates_to&#34;: {
      &#34;m.in_reply_to&#34;: {
        &#34;event_id&#34;: &#34;$another_event&#34;
      }
    },
    &#34;body&#34;: &#34;That sounds like a great idea!&#34;,
    &#34;m.mentions&#34;: {
      &#34;user_ids&#34;: [
        // The sender of $another_event.
        &#34;@alice:example.org&#34;,
        // Another Matrix ID copied from the m.mentions property of $another_event.
        &#34;@bob:example.org&#34;
      ]
    }
  },
  // other fields as required by events
}
</code></pre>
    







    
<h3 id="voice-over-ip">Voice over IP</h3>
<p>This module outlines how two users in a room can set up a Voice over IP
(VoIP) call to each other. Voice and video calls are built upon the
WebRTC 1.0 standard. Call signalling is achieved by sending <a href="#events">message
events</a> to the room. In this version of the spec, only two-party
communication is supported (e.g. between two peers, or between a peer
and a multi-point conferencing unit). Calls can take place in rooms with
multiple members, but only two devices can take part in the call.</p>
<p>All VoIP events have a <code>version</code> field. This is used to determine whether
devices support this new version of the protocol. For example, clients can use
this field to know whether to expect an <code>m.call.select_answer</code> event from their
opponent. If clients see events with <code>version</code> other than <code>0</code> or <code>&quot;1&quot;</code>
(including, for example, the numeric value <code>1</code>), they should treat these the
same as if they had <code>version</code> == <code>&quot;1&quot;</code>.</p>
<p>Note that this implies any and all future versions of VoIP events should be
backwards-compatible.  If it does become necessary to introduce a non
backwards-compatible VoIP spec, the intention would be for it to simply use a
separate set of event types.</p>
<h4 id="party-identifiers">Party Identifiers</h4>
<p>Whenever a client first participates in a new call, it generates a <code>party_id</code> for itself to use for the
duration of the call. This needs to be long enough that the chance of a collision between multiple devices
both generating an answer at the same time generating the same party ID is vanishingly small: 8 uppercase +
lowercase alphanumeric characters is recommended. Parties in the call are identified by the tuple of
<code>(user_id, party_id)</code>.</p>
<p>The client  adds a <code>party_id</code> field containing this ID to the top-level of the content of all VoIP events
it sends on the call, including <code>m.call.invite</code>. Clients use this to identify remote echo of their own
events: since a user may call themselves, they cannot simply ignore events from their own user. This
field also identifies different answers sent by different clients to an invite, and matches <code>m.call.candidates</code>
events to their respective answer/invite.</p>
<p>A client implementation may choose to use the device ID used in end-to-end cryptography for this purpose,
or it may choose, for example, to use a different one for each call to avoid leaking information on which
devices were used in a call (in an unencrypted room) or if a single device (ie. access token) were used to
send signalling for more than one call party.</p>
<p>A grammar for <code>party_id</code> is defined <a href="#grammar-for-voip-ids">below</a>.</p>
<h4 id="politeness">Politeness</h4>
<p>In line with <a href="https://w3c.github.io/webrtc-pc/#perfect-negotiation-example">WebRTC perfect negotiation</a>
there are rules to establish which party is polite in the process of renegotiation. The callee is
always the polite party. In a glare situation, the politeness of a party is therefore determined by
whether the inbound or outbound call is used: if a client discards its outbound call in favour of
an inbound call, it becomes the polite party.</p>
<h4 id="call-event-liveness">Call Event Liveness</h4>
<p><code>m.call.invite</code> contains a <code>lifetime</code> field that indicates how long the offer is valid for. When
a client receives an invite, it should use the event&rsquo;s <code>age</code> field in the sync response plus the
time since it received the event from the homeserver to determine whether the invite is still valid.
The use of the <code>age</code> field ensures that incorrect clocks on client devices don&rsquo;t break calls.</p>
<p>If the invite is still valid <em>and will remain valid for long enough for the user to accept the call</em>,
it should signal an incoming call. The amount of time allowed for the user to accept the call may
vary between clients. For example, it may be longer on a locked mobile device than on an unlocked
desktop device.</p>
<p>The client should only signal an incoming call in a given room once it has completed processing the
entire sync response and, for encrypted rooms, attempted to decrypt all encrypted events in the
sync response for that room. This ensures that if the sync response contains subsequent events that
indicate the call has been hung up, rejected, or answered elsewhere, the client does not signal it.</p>
<p>If on startup, after processing locally stored events, the client determines that there is an invite
that is still valid, it should still signal it but only after it has completed a sync from the homeserver.</p>
<p>The minimal recommended lifetime is 90 seconds - this should give the user enough time to actually pick
up the call.</p>
<h4 id="ice-candidate-batching">ICE Candidate Batching</h4>
<p>Clients should aim to send a small number of candidate events, with guidelines:</p>
<ul>
<li>ICE candidates which can be discovered immediately or almost immediately in the invite/answer
event itself (eg. host candidates). If server reflexive or relay candidates can be gathered in
a sufficiently short period of time, these should be sent here too. A delay of around 200ms is
suggested as a starting point.</li>
<li>The client should then allow some time for further candidates to be gathered in order to batch them,
rather than sending each candidate as it arrives. A starting point of 2 seconds after sending the
invite or 500ms after sending the answer is suggested as a starting point (since a delay is natural
anyway after the invite whilst the client waits for the user to accept it).</li>
</ul>
<h4 id="end-of-candidates">End-of-candidates</h4>
<p>An ICE candidate whose value is the empty string means that no more ICE candidates will
be sent. Clients must send such a candidate in an <code>m.call.candidates</code> message.
The WebRTC spec requires browsers to generate such a candidate, however note that at time of writing,
not all browsers do (Chrome does not, but does generate an <code>icegatheringstatechange</code> event). The
client should send any remaining candidates once candidate generation finishes, ignoring timeouts above.
This allows bridges to batch the candidates together when bridging to protocols that don&rsquo;t support
trickle ICE.</p>
<h4 id="dtmf">DTMF</h4>
<p>Matrix clients can send DTMF as specified by WebRTC. The WebRTC standard as of August
2020 does not support receiving DTMF but a Matrix client can receive and interpret the DTMF sent
in the RTP payload.</p>
<h4 id="grammar-for-voip-ids">Grammar for VoIP IDs</h4>
<p><code>call_id</code>s and <code>party_id</code> are explicitly defined to be between 1 and 255 characters long, consisting
of the characters <code>[0-9a-zA-Z._~-]</code>.</p>
<p>(Note that this matches the grammar of &lsquo;opaque IDs&rsquo; from
<a href="https://github.com/matrix-org/matrix-spec-proposals/blob/rav/proposals/id_grammar/proposals/1597-id-grammar.md#opaque-ids">MSC1597</a>,
and that of the <code>id</code> property of the
<a href="#definition-mloginsso-flow-schema"><code>m.login.sso</code> flow schema</a>.)</p>
<h4 id="behaviour-on-room-leave">Behaviour on Room Leave</h4>
<p>If the client sees the user it is in a call with leave the room, the client should treat this
as a hangup event for any calls that are in progress. No specific requirement is given for the
situation where a client has sent an invite and the invitee leaves the room, but the client may
wish to treat it as a rejection if there are no more users in the room who could answer the call
(eg. the user is now alone or the <code>invitee</code> field was set on the invite).</p>
<p>The same behaviour applies when a client is looking at historic calls.</p>
<h4 id="supported-codecs">Supported Codecs</h4>
<p>The Matrix spec does not mandate particular audio or video codecs, but instead defers to the
WebRTC spec. A compliant Matrix VoIP client will behave in the same way as a supported &lsquo;browser&rsquo;
in terms of what codecs it supports and what variants thereof. The latest WebRTC specification
applies, so clients should keep up to date with new versions of the WebRTC specification whether
or not there have been any changes to the Matrix spec.</p>
<h4 id="events">Events</h4>
<h5 id="common-fields">Common Fields</h5>
<section class="rendered-data event">
<details open>
<summary>
<h1>
 <code>Call event</code>
</h1>
</summary>
<hr/>
<p>The content of all call events shares a set of common fields: those of room events and some additional VoIP specific fields.</p>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>call_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the call this event relates to.</td>
 </tr>
 <tr>
  <td><code>party_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>This identifies the party that sent this event. A client may choose to re-use the device ID from end-to-end cryptography for the value of this field.
<p><strong>Added in <code>v1.7</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>version</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The version of the VoIP specification this message adheres to. This specification is version 1. This field is a string such that experimental implementations can use non-integer versions. This field was an integer in the previous spec version and implementations must accept an integer 0.</td>
 </tr>
</table>
</details>
</section>
<h5 id="events-1">Events</h5>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mcallanswer">
   <code>m.call.answer</code>
  </h1>
</summary>
  <hr/>
<p>This event is sent by the callee when they wish to answer the call.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>answer</code></td>
  <td><code>Answer</code></td>
  <td>
    <strong>Required: </strong>The session description object</td>
 </tr>
</table>
<table id="mcallanswer_answer" class="object-table">
 <caption>Answer</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>sdp</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The SDP text of the session description.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of session description.<p>One of: <code>[answer]</code>.</p></td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;answer&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sdp&#34;</span><span class="p">:</span> <span class="s2">&#34;v=0\r\no=- 6584580628695956864 2 IN IP4 127.0.0.1[...]&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;answer&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;call_id&#34;</span><span class="p">:</span> <span class="s2">&#34;12345&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;party_id&#34;</span><span class="p">:</span> <span class="s2">&#34;67890&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.call.answer&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mcallcandidates">
   <code>m.call.candidates</code>
  </h1>
</summary>
  <hr/>
<p>This event is sent by callers after sending an invite and by the callee after answering. Its purpose is to give the other party additional ICE candidates to try using to communicate.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>candidates</code></td>
  <td><code>[Candidate]</code></td>
  <td>
    <strong>Required: </strong>Array of objects describing the candidates.</td>
 </tr>
</table>
<table id="mcallcandidates_candidate" class="object-table">
 <caption>Candidate</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>candidate</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The SDP &lsquo;a&rsquo; line of the candidate.</td>
 </tr>
 <tr>
  <td><code>sdpMLineIndex</code></td>
  <td><code>number</code></td>
  <td>
    <strong>Required: </strong>The index of the SDP &rsquo;m&rsquo; line this candidate is intended for.</td>
 </tr>
 <tr>
  <td><code>sdpMid</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The SDP media type this candidate is intended for.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;call_id&#34;</span><span class="p">:</span> <span class="s2">&#34;12345&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;candidates&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;candidate&#34;</span><span class="p">:</span> <span class="s2">&#34;candidate:863018703 1 udp 2122260223 10.9.64.156 43670 typ host generation 0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sdpMLineIndex&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sdpMid&#34;</span><span class="p">:</span> <span class="s2">&#34;audio&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;party_id&#34;</span><span class="p">:</span> <span class="s2">&#34;67890&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.call.candidates&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mcallhangup">
   <code>m.call.hangup</code>
  </h1>
</summary>
  <hr/>
<p>Sent by either party to signal their termination of the call. This can
be sent either once the call has has been established or before to abort the call.</p>
<p>The meanings of the <code>reason</code> field are as follows:</p>
<ul>
<li><code>ice_failed</code>: ICE negotiation has failed and a media connection could not be established.</li>
<li><code>ice_timeout</code>: The connection failed after some media was exchanged (as opposed to <code>ice_failed</code>
which means no media connection could be established). Note that, in the case of an ICE
renegotiation, a client should be sure to send <code>ice_timeout</code> rather than <code>ice_failed</code> if media
had previously been received successfully, even if the ICE renegotiation itself failed.</li>
<li><code>invite_timeout</code>: The other party did not answer in time.</li>
<li><code>user_hangup</code>: Clients must now send this code when the user chooses to end the call, although
for backwards compatibility with version 0, a clients should treat an absence of the <code>reason</code>
field as <code>user_hangup</code>.</li>
<li><code>user_media_failed</code>: The client was unable to start capturing media in such a way that it is unable
to continue the call.</li>
<li><code>user_busy</code>: The user is busy. Note that this exists primarily for bridging to other networks such
as the PSTN. A Matrix client that receives a call whilst already in a call would not generally reject
the new call unless the user had specifically chosen to do so.</li>
<li><code>unknown_error</code>: Some other failure occurred that meant the client was unable to continue the call
rather than the user choosing to end it.</li>
</ul>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>reason</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Reason for the hangup. Note that this was optional in previous previous versions of the spec, so a missing value should be treated as <code>user_hangup</code>.<p>One of: <code>[ice_timeout, ice_failed, invite_timeout, user_hangup, user_media_failed, user_busy, unknown_error]</code>.</p><br><br>
    <strong>
      Changed in <code>v1.7</code>:
    </strong>
    Additional values were added.
</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;call_id&#34;</span><span class="p">:</span> <span class="s2">&#34;12345&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;party_id&#34;</span><span class="p">:</span> <span class="s2">&#34;67890&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;user_hangup&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.call.hangup&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mcallinvite">
   <code>m.call.invite</code>
  </h1>
</summary>
  <hr/>
<p>This event is sent by the caller when they wish to establish a call.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>invitee</code></td>
  <td><code>string</code></td>
  <td>
    The ID of the user being called. If omitted, any user in the room can answer.
<p><strong>Added in <code>v1.7</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>lifetime</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The time in milliseconds that the invite is valid for. Once the invite age exceeds this value, clients should discard it. They should also no longer show the call as awaiting an answer in the UI.</td>
 </tr>
 <tr>
  <td><code>offer</code></td>
  <td><code>Offer</code></td>
  <td>
    <strong>Required: </strong>The session description object</td>
 </tr>
</table>
<table id="mcallinvite_offer" class="object-table">
 <caption>Offer</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>sdp</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The SDP text of the session description.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of session description.<p>One of: <code>[offer]</code>.</p></td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;call_id&#34;</span><span class="p">:</span> <span class="s2">&#34;12345&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;lifetime&#34;</span><span class="p">:</span> <span class="mi">60000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;offer&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sdp&#34;</span><span class="p">:</span> <span class="s2">&#34;v=0\r\no=- 6584580628695956864 2 IN IP4 127.0.0.1[...]&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;offer&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;party_id&#34;</span><span class="p">:</span> <span class="s2">&#34;67890&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.call.invite&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mcallnegotiate">
   <code>m.call.negotiate</code>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.7</code></strong></p>
<p>Provides SDP negotiation semantics for media pause, hold/resume, ICE restarts
and voice/video call up/downgrading. Clients should implement and honour hold
functionality as per <a href="https://www.w3.org/TR/webrtc/#hold-functionality">WebRTC&rsquo;s recommendation</a>.</p>
<p>If both the invite event and the accepted answer event have <code>version</code> equal
to <code>&quot;1&quot;</code>, either party may send <code>m.call.negotiate</code> with a <code>description</code> field
to offer new SDP to the other party. This event has <code>call_id</code> with the ID of
the call and <code>party_id</code> equal to the client&rsquo;s party ID for that call.  The
caller ignores any negotiate events with <code>party_id</code> + <code>user_id</code> tuple not
equal to that of the answer it accepted and the callee ignores any negotiate
events with <code>party_id</code> + <code>user_id</code> tuple not equal to that of the caller.
Clients should use the <code>party_id</code> field to ignore the remote echo of their
own negotiate events.</p>
<p>This has a <code>lifetime</code> field as in <code>m.call.invite</code>, after which the sender of
the negotiate event should consider the negotiation failed (timed out) and
the recipient should ignore it.</p>
<p>The <code>description</code> field is the same as the <code>offer</code> field in <code>m.call.invite</code>
and <code>answer</code> field in <code>m.call.answer</code> and is an <code>RTCSessionDescriptionInit</code>
object as per <a href="https://www.w3.org/TR/webrtc/#dom-rtcsessiondescriptioninit">https://www.w3.org/TR/webrtc/#dom-rtcsessiondescriptioninit</a>.</p>
<p>Once an <code>m.call.negotiate</code> event is received, the client must respond with
another <code>m.call.negotiate</code> event, with the SDP answer (with <code>&quot;type&quot;: &quot;answer&quot;</code>)
in the <code>description</code> property.</p>
<p>In the <code>m.call.invite</code> and <code>m.call.answer</code> events, the <code>offer</code> and <code>answer</code>
fields respectively are objects of type <code>RTCSessionDescriptionInit</code>.  Hence
the <code>type</code> field, whilst redundant in these events, is included for ease of
working with the WebRTC API and is mandatory. Receiving clients should not
attempt to validate the <code>type</code> field, but simply pass the object into the
WebRTC API.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>description</code></td>
  <td><code>Description</code></td>
  <td>
    <strong>Required: </strong>The session description object</td>
 </tr>
 <tr>
  <td><code>lifetime</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The time in milliseconds that the negotiation is valid for. Once the negotiation age exceeds this value, clients should discard it.</td>
 </tr>
</table>
<table id="mcallnegotiate_description" class="object-table">
 <caption>Description</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>sdp</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The SDP text of the session description.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of session description.<p>One of: <code>[offer, answer]</code>.</p></td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;call_id&#34;</span><span class="p">:</span> <span class="s2">&#34;12345&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sdp&#34;</span><span class="p">:</span> <span class="s2">&#34;v=0\r\no=- 6584580628695956864 2 IN IP4 127.0.0.1[...]&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;offer&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;lifetime&#34;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;party_id&#34;</span><span class="p">:</span> <span class="s2">&#34;67890&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.call.negotiate&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mcallreject">
   <code>m.call.reject</code>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.7</code></strong></p>
<p>If the <code>m.call.invite</code> event has <code>version</code> <code>&quot;1&quot;</code>, a client wishing to
reject the call sends an <code>m.call.reject</code> event. This rejects the call on all devices,
but if the calling device sees an <code>answer</code> before the <code>reject</code>, it disregards the
reject event and carries on. The reject has a <code>party_id</code> just like an answer, and
the caller sends a <code>select_answer</code> for it just like an answer. If another client
had already sent an answer and sees the caller select the reject response instead
of its answer, it ends the call. If the <code>m.call.invite</code> event has <code>version</code> <code>0</code>,
the callee sends an <code>m.call.hangup</code> event. If the calling user chooses to end the
call before setup is complete, the client sends <code>m.call.hangup</code> as previously.</p>
<p>Note that, unlike <code>m.call.hangup</code>, this event has no <code>reason</code> field: the rejection of
a call is always implicitly because the user chose not to answer it.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;call_id&#34;</span><span class="p">:</span> <span class="s2">&#34;12345&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;party_id&#34;</span><span class="p">:</span> <span class="s2">&#34;67890&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.call.reject&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mcallselect_answer">
   <code>m.call.select_answer</code>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.7</code></strong></p>
<p>This event is sent by the callers client once it has decided which other client to talk to, by selecting one of multiple possible incoming <code>m.call.answer</code> events. Its <code>selected_party_id</code> field indicates the answer its chosen. The <code>call_id</code> and <code>party_id</code> of the caller is also included. If the callees client sees a <code>select_answer</code> for an answer with party ID other than the one it sent, it ends the call and informs the user the call was answered elsewhere. It does not send any events. Media can start flowing before this event is seen or even sent.  Clients that implement previous versions of this specification will ignore this event and behave as they did before.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>selected_party_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>party_id</code> field from the answer event that the caller chose.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;call_id&#34;</span><span class="p">:</span> <span class="s2">&#34;12345&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;party_id&#34;</span><span class="p">:</span> <span class="s2">&#34;67890&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;selected_party_id&#34;</span><span class="p">:</span> <span class="s2">&#34;111213&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.call.select_answer&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h4 id="client-behaviour">Client behaviour</h4>
<p>A call is set up with message events exchanged as follows:</p>
<pre tabindex="0"><code>    Caller                    Callee
    [Place Call]
    m.call.invite -----------&gt;
    m.call.candidate --------&gt;
    [..candidates..] --------&gt;
                            [Answers call]
           &lt;--------------- m.call.answer
    m.call.select_answer -----------&gt;
     [Call is active and ongoing]
           &lt;--------------- m.call.hangup
</code></pre><p>Or a rejected call:</p>
<pre tabindex="0"><code>    Caller                      Callee
    m.call.invite ------------&gt;
    m.call.candidate ---------&gt;
    [..candidates..] ---------&gt;
                             [Rejects call]
             &lt;-------------- m.call.hangup
</code></pre><p>Calls are negotiated according to the WebRTC specification.</p>
<p>In response to an incoming invite, a client may do one of several things:</p>
<ul>
<li>Attempt to accept the call by sending an <code>m.call.answer</code>.</li>
<li>Actively reject the call everywhere: send an <code>m.call.reject</code> as per above, which will stop the call from
ringing on all the user&rsquo;s devices and the caller&rsquo;s client will inform them that the user has
rejected their call.</li>
<li>Ignore the call: send no events, but stop alerting the user about the call. The user&rsquo;s other
devices will continue to ring, and the caller&rsquo;s device will continue to indicate that the call
is ringing, and will time the call out in the normal way if no other device responds.</li>
</ul>
<h5 id="streams">Streams</h5>
<p>Clients are expected to send one stream with one track of kind <code>audio</code> (creating a
voice call). They can optionally send a second track in the same stream of kind
<code>video</code> (creating a video call).</p>
<p>Clients implementing this specification use the first stream and will ignore
any streamless tracks. Note that in the JavaScript WebRTC API, this means
<code>addTrack()</code> must be passed two parameters: a track and a stream, not just a
track, and in a video call the stream must be the same for both audio and video
track.</p>
<p>A client may send other streams and tracks but the behaviour of the other party
with respect to presenting such streams and tracks is undefined.</p>
<h5 id="invitees">Invitees</h5>
<p>The <code>invitee</code> field should be added whenever the call is intended for one
specific user, and should be set to the Matrix user ID of that user. Invites
without an <code>invitee</code> field are defined to be intended for any member of the
room other than the sender of the event.</p>
<p>Clients should consider an incoming call if they see a non-expired invite event where the <code>invitee</code> field is either
absent or equal to their user&rsquo;s Matrix ID, however they should evaluate whether or not to ring based on their
user&rsquo;s trust relationship with the callers and/or where the call was placed. As a starting point, it is
suggested that clients ignore call invites from users in public rooms. It is strongly recommended that
when clients do not ring for an incoming call invite, they still display the call invite in the room and
annotate that it was ignored.</p>
<h5 id="glare">Glare</h5>
<p>&ldquo;Glare&rdquo; is a problem which occurs when two users call each other at
roughly the same time. This results in the call failing to set up as
there already is an incoming/outgoing call. A glare resolution algorithm
can be used to determine which call to hangup and which call to answer.
If both clients implement the same algorithm then they will both select
the same call and the call will be successfully connected.</p>
<p>As calls are &ldquo;placed&rdquo; to rooms rather than users, the glare resolution
algorithm outlined below is only considered for calls which are to the
same room. The algorithm is as follows:</p>
<ul>
<li>If an <code>m.call.invite</code> to a room is received whilst the client is
<strong>preparing to send</strong> an <code>m.call.invite</code> to the same room:
<ul>
<li>the client should cancel its outgoing call and instead
automatically accept the incoming call on behalf of the user.</li>
</ul>
</li>
<li>If an <code>m.call.invite</code> to a room is received <strong>after the client has
sent</strong> an <code>m.call.invite</code> to the same room and is waiting for a
response:
<ul>
<li>the client should perform a lexicographical comparison of the
call IDs of the two calls and use the <em>lesser</em> of the two calls,
aborting the greater. If the incoming call is the lesser, the
client should accept this call on behalf of the user.</li>
</ul>
</li>
</ul>
<p>The call setup should appear seamless to the user as if they had simply
placed a call and the other party had accepted. This means any media
stream that had been setup for use on a call should be transferred and
used for the call that replaces it.</p>
<h4 id="server-behaviour">Server behaviour</h4>
<p>The homeserver MAY provide a TURN server which clients can use to
contact the remote party. The following HTTP API endpoints will be used
by clients in order to get information about the TURN server.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3voipturnserver">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/voip/turnServer</span>
  </h1>
</summary>
  <hr/>
<p>This API provides credentials for the client to use when initiating
calls.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<p>No request parameters or request body.</p>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The TURN server credentials.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>password</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The password to use.</td>
 </tr>
 <tr>
  <td><code>ttl</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The time-to-live in seconds</td>
 </tr>
 <tr>
  <td><code>uris</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>A list of TURN URIs</td>
 </tr>
 <tr>
  <td><code>username</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The username to use.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;password&#34;</span><span class="p">:</span> <span class="s2">&#34;JlKfBy1QwLrO20385QyAtEyIv0=&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;ttl&#34;</span><span class="p">:</span> <span class="mi">86400</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;uris&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;turn:turn.example.com:3478?transport=udp&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;turn:10.20.30.40:3478?transport=tcp&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;turns:10.20.30.40:443?transport=tcp&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;username&#34;</span><span class="p">:</span> <span class="s2">&#34;1443779631:@user:example.com&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3voipturnserver_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h4 id="security-considerations">Security considerations</h4>
<p>Calls should only be placed to rooms with one other user in them. If
they are placed to group chat rooms it is possible that another user
will intercept and answer the call.</p>

    







    
<h3 id="typing-notifications">Typing Notifications</h3>
<p>Users may wish to be informed when another user is typing in a room.
This can be achieved using typing notifications. These are ephemeral
events, so they do not form part of the
<a href="/#event-graphs">Event Graph</a>. Typing notifications are scoped
to a room.</p>
<h4 id="events">Events</h4>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mtyping">
   <code>m.typing</code>
  </h1>
</summary>
  <hr/>
<p>Informs the client of the list of users currently typing.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>user_ids</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The list of user IDs typing in this room, if any.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;user_ids&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;@alice:matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;@bob:example.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.typing&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h4 id="client-behaviour">Client behaviour</h4>
<p>When a client receives an <code>m.typing</code> event, it MUST use the user ID list
to <strong>REPLACE</strong> its knowledge of every user who is currently typing. The
reason for this is that the server <em>does not remember</em> users who are not
currently typing as that list gets big quickly. The client should mark
as not typing any user ID who is not in that list.</p>
<p>It is recommended that clients store a <code>boolean</code> indicating whether the
user is typing or not. Whilst this value is <code>true</code> a timer should fire
periodically every N seconds to send a typing HTTP request. The value of
N is recommended to be no more than 20-30 seconds. This request should
be re-sent by the client to continue informing the server the user is
still typing. As subsequent requests will replace older requests, a
safety margin of 5 seconds before the expected timeout runs out is
recommended. When the user stops typing, the state change of the
<code>boolean</code> to <code>false</code> should trigger another HTTP request to inform the
server that the user has stopped typing.</p>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixclientv3roomsroomidtypinguserid">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/client/v3/rooms/{roomId}/typing/{userId}</span>
  </h1>
</summary>
  <hr/>
<p>This tells the server that the user is typing for the next N
milliseconds where N is the value specified in the <code>timeout</code> key.
Alternatively, if <code>typing</code> is <code>false</code>, it tells the server that the
user has stopped typing.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room in which the user is typing.</td>
 </tr>
 <tr>
  <td><code>userId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user who has started to type.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>timeout</code></td>
  <td><code>integer</code></td>
  <td>
    The length of time in milliseconds to mark this user as typing.</td>
 </tr>
 <tr>
  <td><code>typing</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether the user is typing or not. If <code>false</code>, the <code>timeout</code>
key can be omitted.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;timeout&#34;</span><span class="p">:</span> <span class="mi">30000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;typing&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The new typing state was set.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3roomsroomidtypinguserid_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h4 id="security-considerations">Security considerations</h4>
<p>Clients may not wish to inform everyone in a room that they are typing
and instead only specific users in the room.</p>

    







    
<h3 id="receipts">Receipts</h3>
<p>



  <span><strong>[Changed in <code>v1.4</code>]</strong></span>
 
 Added private read receipts.</p>
<p>This module adds in support for receipts. These receipts are a form of
acknowledgement of an event. This module defines the <code>m.read</code> receipt
for indicating that the user has read up to a given event, and <code>m.read.private</code>
to achieve the same purpose without any other user being aware. Primarily,
<code>m.read.private</code> is intended to clear <a href="#receiving-notifications">notifications</a>
without advertising read-up-to status to others.</p>
<p>Sending a receipt for each event can result in sending large amounts of
traffic to a homeserver. To prevent this from becoming a problem,
receipts are implemented using &ldquo;up to&rdquo; markers. This marker indicates
that the acknowledgement applies to all events &ldquo;up to and including&rdquo; the
event specified. For example, marking an event as &ldquo;read&rdquo; would indicate
that the user had read all events <em>up to</em> the referenced event. See the
<a href="#receiving-notifications">Receiving notifications</a> section for more
information on how read receipts affect notification counts.</p>
<p>



  <span><strong>[Added in <code>v1.4</code>]</strong></span>
 
 Read receipts exist in three major forms:</p>
<ul>
<li>Unthreaded: Denotes a read-up-to receipt regardless of threads. This is how
pre-threading read receipts worked.</li>
<li>Threaded, main timeline: Denotes a read-up-to receipt for events not in a
particular thread. Identified by the thread ID <code>main</code>.</li>
<li>Threaded, in a thread: Denotes a read-up-to receipt within a particular
thread. Identified by the event ID of the thread root.</li>
</ul>
<p>Threaded read receipts are discussed in further detail <a href="#threaded-read-receipts">below</a>.</p>
<h4 id="events">Events</h4>
<p>



  <span><strong>[Changed in <code>v1.4</code>]</strong></span>
 
 Each <code>user_id</code>, <code>receipt_type</code>, and categorisation
(unthreaded, or <code>thread_id</code>) tuple must be associated with only a single
<code>event_id</code>.</p>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mreceipt">
   <code>m.receipt</code>
  </h1>
</summary>
  <hr/>
<p><br><br>
<strong>
Changed in <code>v1.4</code>:
</strong>
Added <code>m.read.private</code> receipts to the events <code>content</code>.</p>
<p>Informs the client of new receipts.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>{string: Event Receipts}</code></td>
  <td>
    The mapping of event ID to a collection of receipts for this
event ID. The event ID is the ID of the event being acknowledged
and <em>not</em> an ID for the receipt itself.</td>
 </tr>
</table>
<table id="mreceipt_event-receipts" class="object-table">
 <caption>Event Receipts</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>m.read</code></td>
  <td><code>{string: Receipt}</code></td>
  <td>
    A collection of users who have sent <code>m.read</code> receipts for
this event. The string key is the user ID the receipt
belongs to.</td>
 </tr>
 <tr>
  <td><code>m.read.private</code></td>
  <td><code>{string: Receipt}</code></td>
  <td>
    Similar to <code>m.read</code>, the users who have sent <code>m.read.private</code>
receipts for this event. Due to the nature of private read
receipts, this should only ever have the current user&rsquo;s ID.</td>
 </tr>
</table>
<table id="mreceipt_receipt" class="object-table">
 <caption>Receipt</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>thread_id</code></td>
  <td><code>string</code></td>
  <td>
    The root thread event&rsquo;s ID (or <code>main</code>) for which
thread this receipt is intended to be under. If
not specified, the read receipt is <em>unthreaded</em>
(default).
<p><strong>Added in <code>v1.4</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>ts</code></td>
  <td><code>integer</code></td>
  <td>
    The timestamp the receipt was sent at.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;$1435641916114394fHBLK:matrix.org&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;m.read&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;@rikj:jki.re&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ts&#34;</span><span class="p">:</span> <span class="mi">1436451550453</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;m.read.private&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;@self:example.org&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ts&#34;</span><span class="p">:</span> <span class="mi">1661384801651</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.receipt&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h4 id="client-behaviour">Client behaviour</h4>
<p>



  <span><strong>[Changed in <code>v1.4</code>]</strong></span>
 
 Altered to support threaded read receipts.</p>
<p>In <code>/sync</code>, receipts are listed under the <code>ephemeral</code> array of events
for a given room. New receipts that come down the event streams are
deltas which update existing mappings. Clients should replace older
receipt acknowledgements based on <code>user_id</code>, <code>receipt_type</code>, and the
<code>thread_id</code> (if present).
For example:</p>
<pre><code>Client receives m.receipt:
  user = @alice:example.com
  receipt_type = m.read
  event_id = $aaa:example.com
  thread_id = undefined

Client receives another m.receipt:
  user = @alice:example.com
  receipt_type = m.read
  event_id = $bbb:example.com
  thread_id = main

The client does not replace any acknowledgements, yet.

Client receives yet another m.receipt:
  user = @alice:example.com
  receipt_type = m.read
  event_id = $ccc:example.com
  thread_id = undefined

The client replaces the older acknowledgement for $aaa:example.com
with this new one for $ccc:example.com, but does not replace the
acknowledgement for $bbb:example.com because it belongs to a thread.

Client receives yet another m.receipt:
  user = @alice:example.com
  receipt_type = m.read
  event_id = $ddd:example.com
  thread_id = main

Now the client replaces the older $bbb:example.com acknowledgement with
this new $ddd:example.com acknowledgement. The client does NOT replace the
older acknowledgement for $ccc:example.com as it is unthreaded.
</code></pre>
<p>Clients should send read receipts when there is some certainty that the
event in question has been <strong>displayed</strong> to the user. Simply receiving
an event does not provide enough certainty that the user has seen the
event. The user SHOULD need to <em>take some action</em> such as viewing the
room that the event was sent to or dismissing a notification in order
for the event to count as &ldquo;read&rdquo;. Clients SHOULD NOT send read receipts
for events sent by their own user.</p>
<p>Similar to the rules for sending receipts, threaded receipts should appear
in the context of the thread. If a thread is rendered behind a disclosure,
the client hasn&rsquo;t yet shown the event (or any applicable read receipts)
to the user. Once they expand the thread though, a threaded read receipt
would be sent and per-thread receipts from other users shown.</p>
<p>A client can update the markers for its user by interacting with the
following HTTP APIs.</p>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3roomsroomidreceiptreceipttypeeventid">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/rooms/{roomId}/receipt/{receiptType}/{eventId}</span>
  </h1>
</summary>
  <hr/>
<p>This API updates the marker for the given receipt type to the event ID
specified.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>eventId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The event ID to acknowledge up to.</td>
 </tr>
 <tr>
  <td><code>receiptType</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><p>The type of receipt to send. This can also be <code>m.fully_read</code> as an
alternative to <a href="/client-server-api/#post_matrixclientv3roomsroomidread_markers"><code>/read_markers</code></a>.</p>
<p>Note that <code>m.fully_read</code> does not appear under <code>m.receipt</code>: this endpoint
effectively calls <code>/read_markers</code> internally when presented with a receipt
type of <code>m.fully_read</code>.</p>
<p>One of: <code>[m.read, m.read.private, m.fully_read]</code>.</p><br><br>
    <strong>
      Changed in <code>v1.4</code>:
    </strong>
    Allow <code>m.read.private</code> receipts and <code>m.fully_read</code> markers to be set.
</td>
 </tr>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room in which to send the event.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>thread_id</code></td>
  <td><code>string</code></td>
  <td>
    The root thread event&rsquo;s ID (or <code>main</code>) for which
thread this receipt is intended to be under. If
not specified, the read receipt is <em>unthreaded</em>
(default).
<p><strong>Added in <code>v1.4</code></strong></p>
</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;thread_id&#34;</span><span class="p">:</span> <span class="s2">&#34;main&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The receipt was sent.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td><p>The <code>thread_id</code> is invalid in some way. For example:</p>
<ul>
<li>It is not a string.</li>
<li>It is empty.</li>
<li>It is provided for an incompatible receipt type.</li>
<li>The <code>event_id</code> is not related to the <code>thread_id</code>.</li>
</ul>
</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3roomsroomidreceiptreceipttypeeventid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_INVALID_PARAM&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;thread_id field must be a non-empty string&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3roomsroomidreceiptreceipttypeeventid_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h5 id="private-read-receipts">Private read receipts</h5>
<p><span><strong>[Added in <code>v1.4</code>]</strong></span></p>
<p>Some users would like to mark a room as read, clearing their <a href="#receiving-notifications">notification counts</a>,
but not give away the fact that they&rsquo;ve read a particular message yet. To
achieve this, clients can send <code>m.read.private</code> receipts instead of <code>m.read</code>
to do exactly that: clear notifications and not broadcast the receipt to
other users.</p>
<p>Servers MUST NOT send the <code>m.read.private</code> receipt to any other user than the
one which originally sent it.</p>
<p>Between <code>m.read</code> and <code>m.read.private</code>, the receipt which is more &ldquo;ahead&rdquo; or
&ldquo;recent&rdquo; is used when determining the highest read-up-to mark. See the
<a href="#receiving-notifications">notifications</a> section for more information on
how this affects notification counts.</p>
<p>If a client sends an <code>m.read</code> receipt which is &ldquo;behind&rdquo; the <code>m.read.private</code>
receipt, other users will see that change happen but the sending user will
not have their notification counts rewound to that point in time. While
uncommon, it is considered valid to have an <code>m.read</code> (public) receipt lag
several messages behind the <code>m.read.private</code> receipt, for example.</p>
<h5 id="threaded-read-receipts">Threaded read receipts</h5>
<p><span><strong>[Added in <code>v1.4</code>]</strong></span></p>
<p>If a client does not use <a href="#threading">threading</a>, then they will simply only
send &ldquo;unthreaded&rdquo; read receipts which affect the whole room regardless of threads.</p>
<p>A threaded read receipt is simply one which has a <code>thread_id</code> on it, targeting
either a thread root&rsquo;s event ID or <code>main</code> for the main timeline.</p>
<p>Threading introduces a concept of multiple conversations being held in the same
room and thus deserve their own read receipts and notification counts. An event is
considered to be &ldquo;in a thread&rdquo; if it meets any of the following criteria:</p>
<ul>
<li>It has a <code>rel_type</code> of <code>m.thread</code>.</li>
<li>It has child events with a <code>rel_type</code> of <code>m.thread</code> (in which case it&rsquo;d be the
thread root).</li>
<li>Following the event relationships, it has a parent event which qualifies for
one of the above. Implementations should not recurse infinitely, though: a
maximum of 3 hops is recommended to cover indirect relationships.</li>
</ul>
<p>Events not in a thread but still in the room are considered to be part of the
&ldquo;main timeline&rdquo;, or a special thread with an ID of <code>main</code>.</p>
<p>The following is an example DAG for a room, with dotted lines showing event
relationships and solid lines showing topological ordering.</p>
<p><img src="/diagrams/threaded-dag.png" alt="threaded-dag"></p>
<p>This DAG can be represented as 3 threaded timelines, with <code>A</code> and <code>B</code> being thread
roots:</p>
<p><img src="/diagrams/threaded-dag-threads.png" alt="threaded-dag-threads"></p>
<p>With this, we can demonstrate that:</p>
<ul>
<li>A threaded read receipt on <code>I</code> would mark <code>A</code>, <code>B</code>, and <code>I</code> as read.</li>
<li>A threaded read receipt on <code>E</code> would mark <code>C</code> and <code>E</code> as read.</li>
<li>An unthreaded read receipt on <code>D</code> would mark <code>A</code>, <code>B</code>, <code>C</code>, and <code>D</code> as read.</li>
</ul>
<p>Note that marking <code>A</code> as read with a threaded read receipt would not mean
that <code>C</code>, <code>E</code>, <code>G</code>, or <code>H</code> get marked as read: Thread A&rsquo;s timeline would need
its own threaded read receipt at <code>H</code> to accomplish that.</p>
<p>The read receipts for the above 3 examples would be:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;$I&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.read&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;@user:example.org&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ts&#34;</span><span class="p">:</span> <span class="mi">1661384801651</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;thread_id&#34;</span><span class="p">:</span> <span class="s2">&#34;main&#34;</span> <span class="c1">// because `I` is not in a thread, but is a threaded receipt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;$E&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.read&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;@user:example.org&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ts&#34;</span><span class="p">:</span> <span class="mi">1661384801651</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;thread_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$A&#34;</span> <span class="c1">// because `E` is in Thread `A`
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;$D&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.read&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;@user:example.org&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ts&#34;</span><span class="p">:</span> <span class="mi">1661384801651</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// no `thread_id` because the receipt is *unthreaded*
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Conditions on sending read receipts apply similarly to threaded and unthreaded read
receipts. For example, a client might send a private read receipt for a threaded
event when the user expands that thread.</p>
<h4 id="server-behaviour">Server behaviour</h4>
<p>For efficiency, receipts SHOULD be batched into one event per room
before delivering them to clients.</p>
<p>Some receipts are sent across federation as EDUs with type <code>m.receipt</code>. The
format of the EDUs are:</p>
<pre tabindex="0"><code>{
    &lt;room_id&gt;: {
        &lt;receipt_type&gt;: {
            &lt;user_id&gt;: { &lt;content (ts &amp; thread_id, currently)&gt; }
        },
        ...
    },
    ...
}
</code></pre><p>These are always sent as deltas to previously sent receipts. Currently
only a single <code>&lt;receipt_type&gt;</code> should be used: <code>m.read</code>. <code>m.read.private</code>
MUST NOT appear in this federated <code>m.receipt</code> EDU.</p>
<h4 id="security-considerations">Security considerations</h4>
<p>As receipts are sent outside the context of the event graph, there are
no integrity checks performed on the contents of <code>m.receipt</code> events.</p>

    







    
<h3 id="fully-read-markers">Fully read markers</h3>
<p>The history for a given room may be split into three sections: messages
the user has read (or indicated they aren&rsquo;t interested in them),
messages the user might have read some but not others, and messages the
user hasn&rsquo;t seen yet. The &ldquo;fully read marker&rdquo; (also known as a &ldquo;read
marker&rdquo;) marks the last event of the first section, whereas the user&rsquo;s
read receipt marks the last event of the second section.</p>
<h4 id="events">Events</h4>
<p>The user&rsquo;s fully read marker is kept as an event in the room&rsquo;s <a href="#client-config">account
data</a>. The event may be read to determine the user&rsquo;s
current fully read marker location in the room, and just like other
account data events the event will be pushed down the event stream when
updated.</p>
<p>The fully read marker is kept under an <code>m.fully_read</code> event. If the
event does not exist on the user&rsquo;s account data, the fully read marker
should be considered to be the user&rsquo;s read receipt location.</p>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mfully_read">
   <code>m.fully_read</code>
  </h1>
</summary>
  <hr/>
<p>The current location of the users read marker in a room. This event appears in the users room account data for the room the marker is applicable for.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The event the user&rsquo;s read marker is located at in the room.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$someplace:example.org&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.fully_read&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h4 id="client-behaviour">Client behaviour</h4>
<p>The client cannot update fully read markers by directly modifying the
<code>m.fully_read</code> account data event. Instead, the client must make use of
the read markers API to change the values.</p>
<p>



  <span><strong>[Changed in <code>v1.4</code>]</strong></span>
 
 <code>m.read.private</code> receipts can now be sent from
<code>/read_markers</code>.</p>
<p>The read markers API can additionally update the user&rsquo;s read receipt
(<code>m.read</code> or <code>m.read.private</code>) location in the same operation as setting
the fully read marker location. This is because read receipts and read
markers are commonly updated at the same time, and therefore the client
might wish to save an extra HTTP call. Providing <code>m.read</code> and/or
<code>m.read.private</code> performs the same task as a request to
<a href="#post_matrixclientv3roomsroomidreceiptreceipttypeeventid"><code>/receipt/{receiptType}/{eventId}</code></a>.</p>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3roomsroomidread_markers">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/rooms/{roomId}/read_markers</span>
  </h1>
</summary>
  <hr/>
<p>Sets the position of the read marker for a given room, and optionally
the read receipt&rsquo;s location.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID to set the read marker in for the user.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>m.fully_read</code></td>
  <td><code>string</code></td>
  <td>
    The event ID the read marker should be located at. The
event MUST belong to the room.<br><br>
    <strong>
      Changed in <code>v1.4</code>:
    </strong>
    This property is no longer required.
</td>
 </tr>
 <tr>
  <td><code>m.read</code></td>
  <td><code>string</code></td>
  <td>
    The event ID to set the read receipt location at. This is
equivalent to calling <code>/receipt/m.read/$elsewhere:example.org</code>
and is provided here to save that extra call.</td>
 </tr>
 <tr>
  <td><code>m.read.private</code></td>
  <td><code>string</code></td>
  <td>
    The event ID to set the <em>private</em> read receipt location at. This
equivalent to calling <code>/receipt/m.read.private/$elsewhere:example.org</code>
and is provided here to save that extra call.
<p><strong>Added in <code>v1.4</code></strong></p>
</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;m.fully_read&#34;</span><span class="p">:</span> <span class="s2">&#34;$somewhere:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;m.read&#34;</span><span class="p">:</span> <span class="s2">&#34;$elsewhere:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;m.read.private&#34;</span><span class="p">:</span> <span class="s2">&#34;$elsewhere:example.org&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The read marker, and read receipt(s) if provided, have been updated.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3roomsroomidread_markers_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h4 id="server-behaviour">Server behaviour</h4>
<p>The server MUST prevent clients from setting <code>m.fully_read</code> directly in
room account data. The server must additionally ensure that it treats
the presence of <code>m.read</code> and <code>m.read.private</code> in the <code>/read_markers</code>
request the same as how it would for a request to
<a href="#post_matrixclientv3roomsroomidreceiptreceipttypeeventid"><code>/receipt/{receiptType}/{eventId}</code></a>.</p>
<p>Upon updating the <code>m.fully_read</code> event due to a request to
<code>/read_markers</code>, the server MUST send the updated account data event
through to the client via the event stream (eg: <code>/sync</code>), provided any
applicable filters are also satisfied.</p>

    







    
<h3 id="presence">Presence</h3>
<p>Each user has the concept of presence information. This encodes:</p>
<ul>
<li>Whether the user is currently online</li>
<li>How recently the user was last active (as seen by the server)</li>
<li>Whether a given client considers the user to be currently idle</li>
<li>Arbitrary information about the user&rsquo;s current status (e.g. &ldquo;in a
meeting&rdquo;).</li>
</ul>
<p>This information is collated from both per-device (<code>online</code>, <code>idle</code>,
<code>last_active</code>) and per-user (status) data, aggregated by the user&rsquo;s
homeserver and transmitted as an <code>m.presence</code> event. Presence events are
sent to interested parties where users share a room membership.</p>
<p>User&rsquo;s presence state is represented by the <code>presence</code> key, which is an
enum of one of the following:</p>
<ul>
<li><code>online</code> : The default state when the user is connected to an event
stream.</li>
<li><code>unavailable</code> : The user is not reachable at this time e.g. they are
idle.</li>
<li><code>offline</code> : The user is not connected to an event stream or is
explicitly suppressing their profile information from being sent.</li>
</ul>
<h4 id="events">Events</h4>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mpresence">
   <code>m.presence</code>
  </h1>
</summary>
  <hr/>
<p>Informs the client of a users presence state change.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>avatar_url</code></td>
  <td><code>string</code></td>
  <td>
    The current avatar URL for this user, if any.</td>
 </tr>
 <tr>
  <td><code>currently_active</code></td>
  <td><code>boolean</code></td>
  <td>
    Whether the user is currently active</td>
 </tr>
 <tr>
  <td><code>displayname</code></td>
  <td><code>string</code></td>
  <td>
    The current display name for this user, if any.</td>
 </tr>
 <tr>
  <td><code>last_active_ago</code></td>
  <td><code>number</code></td>
  <td>
    The last time since this used performed some action, in milliseconds.</td>
 </tr>
 <tr>
  <td><code>presence</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The presence state for this user.<p>One of: <code>[online, offline, unavailable]</code>.</p></td>
 </tr>
 <tr>
  <td><code>status_msg</code></td>
  <td><code>string</code></td>
  <td>
    An optional description to accompany the presence.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://localhost/wefuiwegh8742w&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;currently_active&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;last_active_ago&#34;</span><span class="p">:</span> <span class="mi">2478593</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;presence&#34;</span><span class="p">:</span> <span class="s2">&#34;online&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;status_msg&#34;</span><span class="p">:</span> <span class="s2">&#34;Making cupcakes&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.presence&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h4 id="client-behaviour">Client behaviour</h4>
<p>Clients can manually set/get their presence using the HTTP APIs listed
below.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3presenceuseridstatus">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/presence/{userId}/status</span>
  </h1>
</summary>
  <hr/>
<p>Get the given user&rsquo;s presence state.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>userId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user whose presence state to get.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The presence state for this user.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>You are not allowed to see this user&rsquo;s presence status.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>There is no presence state for this user. This user may not exist or
isn&rsquo;t exposing presence information to you.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>currently_active</code></td>
  <td><code>boolean</code></td>
  <td>
    Whether the user is currently active</td>
 </tr>
 <tr>
  <td><code>last_active_ago</code></td>
  <td><code>integer</code></td>
  <td>
    The length of time in milliseconds since an action was performed
by this user.</td>
 </tr>
 <tr>
  <td><code>presence</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>This user&rsquo;s presence.<p>One of: <code>[online, offline, unavailable]</code>.</p></td>
 </tr>
 <tr>
  <td><code>status_msg</code></td>
  <td><code>[string null]</code></td>
  <td>
    The state message for this user if one was set.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;last_active_ago&#34;</span><span class="p">:</span> <span class="mi">420845</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;presence&#34;</span><span class="p">:</span> <span class="s2">&#34;unavailable&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3presenceuseridstatus_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;You are not allowed to see their presence&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3presenceuseridstatus_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_UNKNOWN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;An unknown error occurred&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixclientv3presenceuseridstatus">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/client/v3/presence/{userId}/status</span>
  </h1>
</summary>
  <hr/>
<p>This API sets the given user&rsquo;s presence state. When setting the status,
the activity time is updated to reflect that activity; the client does
not need to specify the <code>last_active_ago</code> field. You cannot set the
presence state of another user.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>userId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user whose presence state to update.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>presence</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The new presence state.<p>One of: <code>[online, offline, unavailable]</code>.</p></td>
 </tr>
 <tr>
  <td><code>status_msg</code></td>
  <td><code>string</code></td>
  <td>
    The status message to attach to this state.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;presence&#34;</span><span class="p">:</span> <span class="s2">&#34;online&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;status_msg&#34;</span><span class="p">:</span> <span class="s2">&#34;I am here.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The new presence state was set.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3presenceuseridstatus_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h5 id="last-active-ago">Last active ago</h5>
<p>The server maintains a timestamp of the last time it saw a pro-active
event from the user. A pro-active event may be sending a message to a
room or changing presence state to <code>online</code>. This timestamp is presented
via a key called <code>last_active_ago</code> which gives the relative number of
milliseconds since the pro-active event.</p>
<p>To reduce the number of presence updates sent to clients the server may
include a <code>currently_active</code> boolean field when the presence state is
<code>online</code>. When true, the server will not send further updates to the
last active time until an update is sent to the client with either a)
<code>currently_active</code> set to false or b) a presence state other than
<code>online</code>. During this period clients must consider the user to be
currently active, irrespective of the last active time.</p>
<p>The last active time must be up to date whenever the server gives a
presence event to the client. The <code>currently_active</code> mechanism should
purely be used by servers to stop sending continuous presence updates,
as opposed to disabling last active tracking entirely. Thus clients can
fetch up to date last active times by explicitly requesting the presence
for a given user.</p>
<h5 id="idle-timeout">Idle timeout</h5>
<p>The server will automatically set a user&rsquo;s presence to <code>unavailable</code> if
their last active time was over a threshold value (e.g. 5 minutes).
Clients can manually set a user&rsquo;s presence to <code>unavailable</code>. Any
activity that bumps the last active time on any of the user&rsquo;s clients
will cause the server to automatically set their presence to <code>online</code>.</p>
<h4 id="security-considerations">Security considerations</h4>
<p>Presence information is shared with all users who share a room with the
target user. In large public rooms this could be undesirable.</p>

    







    
<h3 id="content-repository">Content repository</h3>
<p>The content repository (or &ldquo;media repository&rdquo;) allows users to upload
files to their homeserver for later use. For example, files which the
user wants to send to a room would be uploaded here, as would an avatar
the user wants to use.</p>
<p>Uploads are POSTed to a resource on the user&rsquo;s local homeserver which
returns an <code>mxc://</code> URI which can later be used to GET the download. Content
is downloaded from the recipient&rsquo;s local homeserver, which must first
transfer the content from the origin homeserver using the same API
(unless the origin and destination homeservers are the same).</p>
<p>When serving content, the server SHOULD provide a
<code>Content-Security-Policy</code> header. The recommended policy is
<code>sandbox; default-src 'none'; script-src 'none'; plugin-types application/pdf; style-src 'unsafe-inline'; object-src 'self';</code>.</p>
<div class="alert added-in-paragraph " role="alert">
<p><span><strong>[Added in <code>v1.4</code>]</strong></span></p>
<p>The server SHOULD additionally provide
<code>Cross-Origin-Resource-Policy: cross-origin</code> when serving content to allow
(web) clients to access restricted APIs such as <code>SharedArrayBuffer</code> when
interacting with the media repository.</p>
</div>
<h4 id="matrix-content-mxc-uris">Matrix Content (<code>mxc://</code>) URIs</h4>
<p>Content locations are represented as Matrix Content (<code>mxc://</code>) URIs. They
look like:</p>
<pre><code>mxc://&lt;server-name&gt;/&lt;media-id&gt;

&lt;server-name&gt; : The name of the homeserver where this content originated, e.g. matrix.org
&lt;media-id&gt; : An opaque ID which identifies the content.
</code></pre>
<h4 id="client-behaviour">Client behaviour</h4>
<p>Clients can upload and download content using the following HTTP APIs.</p>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixmediav1create">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/media/v1/create</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.7</code></strong></p>
<p><p>Creates a new <code>mxc://</code> URI, independently of the content being uploaded. The content must be provided later
via <a href="/client-server-api/#put_matrixmediav3uploadservernamemediaid"><code>PUT /_matrix/media/v3/upload/{serverName}/{mediaId}</code></a>.</p>
<p>The server may optionally enforce a maximum age for unused IDs,
and delete media IDs when the client doesn&rsquo;t start the upload in time,
or when the upload was interrupted and not resumed in time. The server
should include the maximum POSIX millisecond timestamp to complete the
upload in the <code>unused_expires_at</code> field in the response JSON. The
recommended default expiration is 24 hours which should be enough time
to accommodate users on poor connection who find a better connection to
complete the upload.</p>
<p>As well as limiting the rate of requests to create <code>mxc://</code> URIs, the server
should limit the number of concurrent <em>pending media uploads</em> a given
user can have. A pending media upload is a created <code>mxc://</code> URI where (a)
the media has not yet been uploaded, and (b) has not yet expired (the
<code>unused_expires_at</code> timestamp has not yet passed). In both cases, the
server should respond with an HTTP 429 error with an errcode of
<code>M_LIMIT_EXCEEDED</code>.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<p>No request parameters or request body.</p>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The <a href="/client-server-api/#matrix-content-mxc-uris"><code>mxc://</code> URI</a> for the uploaded content.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The user does not have permission to upload the content.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content_uri</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <a href="/client-server-api/#matrix-content-mxc-uris"><code>mxc://</code> URI</a> at
which the content will be available, once it is uploaded.</td>
 </tr>
 <tr>
  <td><code>unused_expires_at</code></td>
  <td><code>integer</code></td>
  <td>
    The timestamp (in milliseconds since the unix epoch) when the
generated media id will expire, if media is not uploaded.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content_uri&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.com/AQwafuaFswefuhsfAFAgsw&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unused_expires_at&#34;</span><span class="p">:</span> <span class="mi">1647257217083</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixmediav1create_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Cannot upload this content&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixmediav1create_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixmediav3config">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/media/v3/config</span>
  </h1>
</summary>
  <hr/>
<p><p>This endpoint allows clients to retrieve the configuration of the content
repository, such as upload limitations.
Clients SHOULD use this as a guide when using content repository endpoints.
All values are intentionally left optional. Clients SHOULD follow
the advice given in the field description when the field is not available.</p>
<p><strong>NOTE:</strong> Both clients and server administrators should be aware that proxies
between the client and the server may affect the apparent behaviour of content
repository APIs, for example, proxies may enforce a lower upload size limit
than is advertised by the server on this endpoint.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<p>No request parameters or request body.</p>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The public content repository configuration for the matrix server.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>m.upload.size</code></td>
  <td><code>integer</code></td>
  <td>
    The maximum size an upload can be in bytes.
Clients SHOULD use this as a guide when uploading content.
If not listed or null, the size limit should be treated as unknown.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;m.upload.size&#34;</span><span class="p">:</span> <span class="mi">50000000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixmediav3config_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_UNKNOWN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;An unknown error occurred&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixmediav3downloadservernamemediaid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/media/v3/download/{serverName}/{mediaId}</span>
  </h1>
</summary>
  <hr/>
<p></p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>mediaId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The media ID from the <code>mxc://</code> URI (the path component)</td>
 </tr>
 <tr>
  <td><code>serverName</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The server name from the <code>mxc://</code> URI (the authoritory component)</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>allow_redirect</code></td>
  <td><code>boolean</code></td>
  <td>
    Indicates to the server that it may return a 307 or 308 redirect response that points
at the relevant media content. When not explicitly set to true the server must return
the media content itself.
<p><strong>Added in <code>v1.7</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>allow_remote</code></td>
  <td><code>boolean</code></td>
  <td>
    Indicates to the server that it should not attempt to fetch the media if it is deemed
remote. This is to prevent routing loops where the server contacts itself. Defaults to
true if not provided.</td>
 </tr>
 <tr>
  <td><code>timeout_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The maximum number of milliseconds that the client is willing to
wait to start receiving data, in the case that the content has not
yet been uploaded. The default value is 20000 (20 seconds). The
content repository can and should impose a maximum value for this
parameter. The content repository may also choose to respond before
the timeout.
<p><strong>Added in <code>v1.7</code></strong></p>
</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The content that was previously uploaded.</td>
 </tr>
 <tr>
  <td><code>307</code></td>
  <td>A redirect to the thumbnail of the requested content.</td>
 </tr>
 <tr>
  <td><code>308</code></td>
  <td>A redirect to the thumbnail of the requested content.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
 <tr>
  <td><code>502</code></td>
  <td>The content is too large for the server to serve.</td>
 </tr>
 <tr>
  <td><code>504</code></td>
  <td>The content is not yet available. A <a href="/client-server-api/#standard-error-response">standard error response</a>
will be returned with the <code>errcode</code> <code>M_NOT_YET_UPLOADED</code>.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="content-type-table">
 <thead>
  <th class="col-name">Content-Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>application/octet-stream</code></td>
  <td><strong>Required.</strong> The bytes for the uploaded file.</td>
 </tr>
</table>
<h3>429 response</h3>
<table id="_matrixmediav3downloadservernamemediaid_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>502 response</h3>
<table id="_matrixmediav3downloadservernamemediaid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_TOO_LARGE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Content is too large to serve&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>504 response</h3>
<table id="_matrixmediav3downloadservernamemediaid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_YET_UPLOADED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Content has not yet been uploaded&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixmediav3downloadservernamemediaidfilename">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/media/v3/download/{serverName}/{mediaId}/{fileName}</span>
  </h1>
</summary>
  <hr/>
<p>This will download content from the content repository (same as
the previous endpoint) but replace the target file name with the one
provided by the caller.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>fileName</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A filename to give in the <code>Content-Disposition</code> header.</td>
 </tr>
 <tr>
  <td><code>mediaId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The media ID from the <code>mxc://</code> URI (the path component)</td>
 </tr>
 <tr>
  <td><code>serverName</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The server name from the <code>mxc://</code> URI (the authoritory component)</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>allow_redirect</code></td>
  <td><code>boolean</code></td>
  <td>
    Indicates to the server that it may return a 307 or 308 redirect response that points
at the relevant media content. When not explicitly set to true the server must return
the media content itself.
<p><strong>Added in <code>v1.7</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>allow_remote</code></td>
  <td><code>boolean</code></td>
  <td>
    Indicates to the server that it should not attempt to fetch the media if it is deemed
remote. This is to prevent routing loops where the server contacts itself. Defaults to
true if not provided.</td>
 </tr>
 <tr>
  <td><code>timeout_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The maximum number of milliseconds that the client is willing to
wait to start receiving data, in the case that the content has not
yet been uploaded. The default value is 20000 (20 seconds). The
content repository can and should impose a maximum value for this
parameter. The content repository may also choose to respond before
the timeout.
<p><strong>Added in <code>v1.7</code></strong></p>
</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The content that was previously uploaded.</td>
 </tr>
 <tr>
  <td><code>307</code></td>
  <td>A redirect to the thumbnail of the requested content.</td>
 </tr>
 <tr>
  <td><code>308</code></td>
  <td>A redirect to the thumbnail of the requested content.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
 <tr>
  <td><code>502</code></td>
  <td>The content is too large for the server to serve.</td>
 </tr>
 <tr>
  <td><code>504</code></td>
  <td>The content is not yet available. A <a href="/client-server-api/#standard-error-response">standard error response</a>
will be returned with the <code>errcode</code> <code>M_NOT_YET_UPLOADED</code>.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="content-type-table">
 <thead>
  <th class="col-name">Content-Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>application/octet-stream</code></td>
  <td><strong>Required.</strong> The bytes for the uploaded file.</td>
 </tr>
</table>
<h3>429 response</h3>
<table id="_matrixmediav3downloadservernamemediaidfilename_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>502 response</h3>
<table id="_matrixmediav3downloadservernamemediaidfilename_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_TOO_LARGE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Content is too large to serve&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>504 response</h3>
<table id="_matrixmediav3downloadservernamemediaidfilename_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_YET_UPLOADED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Content has not yet been uploaded&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixmediav3preview_url">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/media/v3/preview_url</span>
  </h1>
</summary>
  <hr/>
<p><p>Get information about a URL for the client. Typically this is called when a
client sees a URL in a message and wants to render a preview for the user.</p>
<p><strong>Note:</strong>
Clients should consider avoiding this endpoint for URLs posted in encrypted
rooms. Encrypted rooms often contain more sensitive information the users
do not want to share with the homeserver, and this can mean that the URLs
being shared should also not be shared with the homeserver.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>ts</code></td>
  <td><code>integer</code></td>
  <td>
    The preferred point in time to return a preview for. The server may
return a newer version if it does not have the requested version
available.</td>
 </tr>
 <tr>
  <td><code>url</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The URL to get a preview of.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The OpenGraph data for the URL, which may be empty. Some values are
replaced with matrix equivalents if they are provided in the response.
The differences from the OpenGraph protocol are described here.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>matrix:image:size</code></td>
  <td><code>integer</code></td>
  <td>
    The byte-size of the image. Omitted if there is no image attached.</td>
 </tr>
 <tr>
  <td><code>og:image</code></td>
  <td><code>string</code></td>
  <td>
    An <a href="/client-server-api/#matrix-content-mxc-uris"><code>mxc://</code> URI</a> to the image. Omitted if there is no image.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;matrix:image:size&#34;</span><span class="p">:</span> <span class="mi">102400</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;og:description&#34;</span><span class="p">:</span> <span class="s2">&#34;This is a really cool blog post from matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;og:image&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.com/ascERGshawAWawugaAcauga&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;og:image:height&#34;</span><span class="p">:</span> <span class="mi">48</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;og:image:type&#34;</span><span class="p">:</span> <span class="s2">&#34;image/png&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;og:image:width&#34;</span><span class="p">:</span> <span class="mi">48</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;og:title&#34;</span><span class="p">:</span> <span class="s2">&#34;Matrix Blog Post&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixmediav3preview_url_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixmediav3thumbnailservernamemediaid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/media/v3/thumbnail/{serverName}/{mediaId}</span>
  </h1>
</summary>
  <hr/>
<p>Download a thumbnail of content from the content repository.
See the <a href="/client-server-api/#thumbnails">Thumbnails</a> section for more information.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>mediaId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The media ID from the <code>mxc://</code> URI (the path component)</td>
 </tr>
 <tr>
  <td><code>serverName</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The server name from the <code>mxc://</code> URI (the authoritory component)</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>allow_redirect</code></td>
  <td><code>boolean</code></td>
  <td>
    Indicates to the server that it may return a 307 or 308 redirect response that points
at the relevant media content. When not explicitly set to true the server must return
the media content itself.
<p><strong>Added in <code>v1.7</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>allow_remote</code></td>
  <td><code>boolean</code></td>
  <td>
    Indicates to the server that it should not attempt to fetch
the media if it is deemed remote. This is to prevent routing loops
where the server contacts itself. Defaults to true if not provided.</td>
 </tr>
 <tr>
  <td><code>height</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The <em>desired</em> height of the thumbnail. The actual thumbnail may be
larger than the size specified.</td>
 </tr>
 <tr>
  <td><code>method</code></td>
  <td><code>string</code></td>
  <td>
    The desired resizing method. See the <a href="/client-server-api/#thumbnails">Thumbnails</a>
section for more information.<p>One of: <code>[crop, scale]</code>.</p></td>
 </tr>
 <tr>
  <td><code>timeout_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The maximum number of milliseconds that the client is willing to
wait to start receiving data, in the case that the content has not
yet been uploaded. The default value is 20000 (20 seconds). The
content repository can and should impose a maximum value for this
parameter. The content repository may also choose to respond before
the timeout.
<p><strong>Added in <code>v1.7</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>width</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The <em>desired</em> width of the thumbnail. The actual thumbnail may be
larger than the size specified.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>A thumbnail of the requested content.</td>
 </tr>
 <tr>
  <td><code>307</code></td>
  <td>A redirect to the thumbnail of the requested content.</td>
 </tr>
 <tr>
  <td><code>308</code></td>
  <td>A redirect to the thumbnail of the requested content.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td>The request does not make sense to the server, or the server cannot thumbnail
the content. For example, the client requested non-integer dimensions or asked
for negatively-sized images.</td>
 </tr>
 <tr>
  <td><code>413</code></td>
  <td>The local content is too large for the server to thumbnail.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
 <tr>
  <td><code>502</code></td>
  <td>The remote content is too large for the server to thumbnail.</td>
 </tr>
 <tr>
  <td><code>504</code></td>
  <td>The content is not yet available. A <a href="/client-server-api/#standard-error-response">standard error response</a>
will be returned with the <code>errcode</code> <code>M_NOT_YET_UPLOADED</code>.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="content-type-table">
 <thead>
  <th class="col-name">Content-Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>image/jpeg|image/png</code></td>
  <td><strong>Required.</strong> The bytes for the thumbnail.</td>
 </tr>
</table>
<h3>400 response</h3>
<table id="_matrixmediav3thumbnailservernamemediaid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_UNKNOWN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Cannot generate thumbnails for the requested content&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>413 response</h3>
<table id="_matrixmediav3thumbnailservernamemediaid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_TOO_LARGE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Content is too large to thumbnail&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixmediav3thumbnailservernamemediaid_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>502 response</h3>
<table id="_matrixmediav3thumbnailservernamemediaid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_TOO_LARGE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Content is too large to thumbnail&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>504 response</h3>
<table id="_matrixmediav3thumbnailservernamemediaid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_YET_UPLOADED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Content has not yet been uploaded&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixmediav3upload">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/media/v3/upload</span>
  </h1>
</summary>
  <hr/>
<p></p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>header parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>Content-Type</code></td>
  <td><code>string</code></td>
  <td>
    The content type of the file being uploaded</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>filename</code></td>
  <td><code>string</code></td>
  <td>
    The name of the file being uploaded</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="content-type-table">
 <thead>
  <th class="col-name">Content-Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>application/octet-stream</code></td>
  <td>The content to be uploaded.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">&lt;bytes&gt;</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The <a href="/client-server-api/#matrix-content-mxc-uris"><code>mxc://</code> URI</a> for the uploaded content.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td><p>The user does not have permission to upload the content. Some reasons for this error include:</p>
<ul>
<li>The server does not permit the file type.</li>
<li>The user has reached a quota for uploaded content.</li>
</ul>
</td>
 </tr>
 <tr>
  <td><code>413</code></td>
  <td>The uploaded content is too large for the server.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content_uri</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <a href="/client-server-api/#matrix-content-mxc-uris"><code>mxc://</code> URI</a> to the uploaded content.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content_uri&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.com/AQwafuaFswefuhsfAFAgsw&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixmediav3upload_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Cannot upload this content&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>413 response</h3>
<table id="_matrixmediav3upload_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_TOO_LARGE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Cannot upload files larger than 100mb&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixmediav3upload_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixmediav3uploadservernamemediaid">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/media/v3/upload/{serverName}/{mediaId}</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.7</code></strong></p>
<p>This endpoint permits uploading content to an <code>mxc://</code> URI that was created
earlier via <a href="/client-server-api/#post_matrixmediav1create">POST /_matrix/media/v1/create</a>.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>header parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>Content-Type</code></td>
  <td><code>string</code></td>
  <td>
    The content type of the file being uploaded</td>
 </tr>
</table>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>mediaId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The media ID from the <code>mxc://</code> URI returned by <code>POST /_matrix/media/v1/create</code> (the path component).</td>
 </tr>
 <tr>
  <td><code>serverName</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The server name from the <code>mxc://</code> URI returned by <code>POST /_matrix/media/v1/create</code> (the authoritory component).</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>filename</code></td>
  <td><code>string</code></td>
  <td>
    The name of the file being uploaded</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="content-type-table">
 <thead>
  <th class="col-name">Content-Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>application/octet-stream</code></td>
  <td>The content to be uploaded.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">&lt;bytes&gt;</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The upload was successful.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td><p>The user does not have permission to upload the content. Some reasons for this error include:</p>
<ul>
<li>The server does not permit the file type.</li>
<li>The user has reached a quota for uploaded content.</li>
<li>The request comes from a different user than the one that called
<a href="/client-server-api/#post_matrixmediav1create">POST /_matrix/media/v1/create</a>.</li>
</ul>
<p>A <a href="/client-server-api/#standard-error-response">standard error response</a>
will be returned with the <code>errcode</code> <code>M_FORBIDDEN</code>.</p>
</td>
 </tr>
 <tr>
  <td><code>409</code></td>
  <td>The endpoint was called with a media ID that already has content. A
<a href="/client-server-api/#standard-error-response">standard error response</a>
will be returned with the <code>errcode</code> <code>M_CANNOT_OVERWRITE_MEDIA</code>.</td>
 </tr>
 <tr>
  <td><code>413</code></td>
  <td>The uploaded content is too large for the server.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixmediav3uploadservernamemediaid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Cannot upload this content&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>409 response</h3>
<table id="_matrixmediav3uploadservernamemediaid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_CANNOT_OVERWRITE_MEDIA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Media already uploaded&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>413 response</h3>
<table id="_matrixmediav3uploadservernamemediaid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_TOO_LARGE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Cannot upload files larger than 100mb&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixmediav3uploadservernamemediaid_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h5 id="thumbnails">Thumbnails</h5>
<p>The homeserver SHOULD be able to supply thumbnails for uploaded images
and videos. The exact file types which can be thumbnailed are not
currently specified - see <a href="https://github.com/matrix-org/matrix-doc/issues/1938">Issue
#1938</a> for more
information.</p>
<p>The thumbnail methods are &ldquo;crop&rdquo; and &ldquo;scale&rdquo;. &ldquo;scale&rdquo; tries to return an
image where either the width or the height is smaller than the requested
size. The client should then scale and letterbox the image if it needs
to fit within a given rectangle. &ldquo;crop&rdquo; tries to return an image where
the width and height are close to the requested size and the aspect
matches the requested size. The client should scale the image if it
needs to fit within a given rectangle.</p>
<p>The dimensions given to the thumbnail API are the minimum size the
client would prefer. Servers must never return thumbnails smaller than
the client&rsquo;s requested dimensions, unless the content being thumbnailed
is smaller than the dimensions. When the content is smaller than the
requested dimensions, servers should return the original content rather
than thumbnail it.</p>
<p>Servers SHOULD produce thumbnails with the following dimensions and
methods:</p>
<ul>
<li>32x32, crop</li>
<li>96x96, crop</li>
<li>320x240, scale</li>
<li>640x480, scale</li>
<li>800x600, scale</li>
</ul>
<p>In summary:</p>
<ul>
<li>&ldquo;scale&rdquo; maintains the original aspect ratio of the image</li>
<li>&ldquo;crop&rdquo; provides an image in the aspect ratio of the sizes given in
the request</li>
<li>The server will return an image larger than or equal to the
dimensions requested where possible.</li>
</ul>
<p>Servers MUST NOT upscale thumbnails under any circumstance. Servers MUST
NOT return a smaller thumbnail than requested, unless the original
content makes that impossible.</p>
<h4 id="security-considerations">Security considerations</h4>
<p>The HTTP GET endpoint does not require any authentication. Knowing the
URL of the content is sufficient to retrieve the content, even if the
entity isn&rsquo;t in the room.</p>
<p><code>mxc://</code> URIs are vulnerable to directory traversal attacks such as
<code>mxc://127.0.0.1/../../../some_service/etc/passwd</code>. This would cause the
target homeserver to try to access and return this file. As such,
homeservers MUST sanitise <code>mxc://</code> URIs by allowing only alphanumeric
(<code>A-Za-z0-9</code>), <code>_</code> and <code>-</code> characters in the <code>server-name</code> and
<code>media-id</code> values. This set of whitelisted characters allows URL-safe
base64 encodings specified in RFC 4648. Applying this character
whitelist is preferable to blacklisting <code>.</code> and <code>/</code> as there are
techniques around blacklisted characters (percent-encoded characters,
UTF-8 encoded traversals, etc).</p>
<p>Homeservers have additional content-specific concerns:</p>
<ul>
<li>Clients may try to upload very large files. Homeservers should not
store files that are too large and should not serve them to clients,
returning a HTTP 413 error with the <code>M_TOO_LARGE</code> code.</li>
<li>Clients may try to upload very large images. Homeservers should not
attempt to generate thumbnails for images that are too large,
returning a HTTP 413 error with the <code>M_TOO_LARGE</code> code.</li>
<li>Remote homeservers may host very large files or images. Homeservers
should not proxy or thumbnail large files or images from remote
homeservers, returning a HTTP 502 error with the <code>M_TOO_LARGE</code> code.</li>
<li>Clients may try to upload a large number of files. Homeservers
should limit the number and total size of media that can be uploaded
by clients, returning a HTTP 403 error with the <code>M_FORBIDDEN</code> code.</li>
<li>Clients may try to access a large number of remote files through a
homeserver. Homeservers should restrict the number and size of
remote files that it caches.</li>
<li>Clients or remote homeservers may try to upload malicious files
targeting vulnerabilities in either the homeserver thumbnailing or
the client decoders.</li>
</ul>

    







    
<h3 id="send-to-device-messaging">Send-to-Device messaging</h3>
<p>This module provides a means by which clients can exchange signalling
messages without them being stored permanently as part of a shared
communication history. A message is delivered exactly once to each
client device.</p>
<p>The primary motivation for this API is exchanging data that is
meaningless or undesirable to persist in the room DAG - for example,
one-time authentication tokens or key data. It is not intended for
conversational data, which should be sent using the normal <a href="/client-server-api/#put_matrixclientv3roomsroomidsendeventtypetxnid"><code>/rooms/&lt;room_id&gt;/send</code></a> API for
consistency throughout Matrix.</p>
<h4 id="client-behaviour">Client behaviour</h4>
<p>To send a message to other devices, a client should call
<a href="/client-server-api/#put_matrixclientv3sendtodeviceeventtypetxnid"><code>/sendToDevice</code></a>. Only one message can be sent to each device per
transaction, and they must all have the same event type. The device ID
in the request body can be set to <code>*</code> to request that the message be
sent to all known devices.</p>
<p>If there are send-to-device messages waiting for a client, they will be
returned by <a href="/client-server-api/#get_matrixclientv3sync"><code>/sync</code></a>, as detailed in <a href="/client-server-api/#extensions-to-sync">Extensions to /sync</a>. Clients should
inspect the <code>type</code> of each returned event, and ignore any they do not
understand.</p>
<h4 id="server-behaviour">Server behaviour</h4>
<p>Servers should store pending messages for local users until they are
successfully delivered to the destination device. When a client calls
<a href="/client-server-api/#get_matrixclientv3sync"><code>/sync</code></a>
with an access token which corresponds to a device with pending
messages, the server should list the pending messages, in order of
arrival, in the response body.</p>
<p>When the client calls <code>/sync</code> again with the <code>next_batch</code> token from the
first response, the server should infer that any send-to-device messages
in that response have been delivered successfully, and delete them from
the store.</p>
<p>If there is a large queue of send-to-device messages, the server should
limit the number sent in each <code>/sync</code> response. 100 messages is
recommended as a reasonable limit.</p>
<p>If the client sends messages to users on remote domains, those messages
should be sent on to the remote servers via
<a href="/server-server-api#send-to-device-messaging">federation</a>.</p>
<h4 id="protocol-definitions">Protocol definitions</h4>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixclientv3sendtodeviceeventtypetxnid">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/client/v3/sendToDevice/{eventType}/{txnId}</span>
  </h1>
</summary>
  <hr/>
<p>This endpoint is used to send send-to-device events to a set of
client devices.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>eventType</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of event to send.</td>
 </tr>
 <tr>
  <td><code>txnId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <a href="/client-server-api/#transaction-identifiers">transaction ID</a> for this event. Clients should generate an
ID unique across requests with the same access token; it will be
used by the server to ensure idempotency of requests.</td>
 </tr>
</table>
<h3>Request body</h3>
<table id="_matrixclientv3sendtodeviceeventtypetxnid_body" class="object-table">
 <caption>body</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>messages</code></td>
  <td><code>{string: {string: EventContent}}</code></td>
  <td>
    <strong>Required: </strong>The messages to send. A map from user ID, to a map from
device ID to message body. The device ID may also be <code>*</code>,
meaning all known devices for the user.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;messages&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;TLLBEANAAG&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;example_content_key&#34;</span><span class="p">:</span> <span class="s2">&#34;value&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The message was successfully sent.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div></details>
</section>
<h5 id="extensions-to-sync">Extensions to /sync</h5>
<p>This module adds the following properties to the <a href="/client-server-api/#get_matrixclientv3sync"><code>/sync</code></a> response:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>to_device</td>
<td>ToDevice</td>
<td>Optional. Information on the send-to-device messages for the client device.</td>
</tr>
</tbody>
</table>
<p><code>ToDevice</code></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>events</td>
<td>[Event]</td>
<td>List of send-to-device messages.</td>
</tr>
</tbody>
</table>
<p><code>Event</code></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>content</td>
<td>EventContent</td>
<td>The content of this event. The fields in this object will vary depending on the type of event.</td>
</tr>
<tr>
<td>sender</td>
<td>string</td>
<td>The Matrix user ID of the user who sent this event.</td>
</tr>
<tr>
<td>type</td>
<td>string</td>
<td>The type of event.</td>
</tr>
</tbody>
</table>
<p>Example response:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;next_batch&#34;</span><span class="p">:</span> <span class="s2">&#34;s72595_4483_1934&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;rooms&#34;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&#34;leave&#34;</span><span class="p">:</span> <span class="p">{},</span> <span class="nt">&#34;join&#34;</span><span class="p">:</span> <span class="p">{},</span> <span class="nt">&#34;invite&#34;</span><span class="p">:</span> <span class="p">{}},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;to_device&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;events&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.new_device&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;device_id&#34;</span><span class="p">:</span> <span class="s2">&#34;XYZABCDE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;rooms&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;!726s6s6q:example.com&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
    







    
<h3 id="device-management">Device Management</h3>
<p>This module provides a means for a user to manage their <a href="/#devices">devices</a>.</p>
<h4 id="client-behaviour">Client behaviour</h4>
<p>Clients that implement this module should offer the user a list of
registered devices, as well as the means to update their display names.
Clients should also allow users to delete disused devices.</p>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3delete_devices">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/delete_devices</span>
  </h1>
</summary>
  <hr/>
<p><p>This API endpoint uses the <a href="/client-server-api/#user-interactive-authentication-api">User-Interactive Authentication API</a>.</p>
<p>Deletes the given devices, and invalidates any access token associated with them.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>auth</code></td>
  <td><code>Authentication Data</code></td>
  <td>
    Additional authentication information for the
user-interactive authentication API.</td>
 </tr>
 <tr>
  <td><code>devices</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The list of device IDs to delete.</td>
 </tr>
</table>
<table id="_matrixclientv3delete_devices_authentication-data" class="object-table">
 <caption>Authentication Data</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>session</code></td>
  <td><code>string</code></td>
  <td>
    The value of the session key given by the homeserver.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    The authentication type that the client is attempting to complete.
May be omitted if <code>session</code> is given, and the client is reissuing a
request which it believes has been completed out-of-band (for example,
via the <a href="#fallback">fallback mechanism</a>).</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;auth&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;example_credential&#34;</span><span class="p">:</span> <span class="s2">&#34;verypoorsharedsecret&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;xxxxx&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;example.type.foo&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;devices&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;QBUAZIFURK&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;AUIECTSRND&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The devices were successfully removed, or had been removed
previously.</td>
 </tr>
 <tr>
  <td><code>401</code></td>
  <td>The homeserver requires additional authentication information.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>401 response</h3>
<table id="_matrixclientv3delete_devices_authentication-response" class="object-table">
 <caption>Authentication response</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>completed</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of the stages the client has completed successfully</td>
 </tr>
 <tr>
  <td><code>flows</code></td>
  <td><code>[Flow information]</code></td>
  <td>
    <strong>Required: </strong>A list of the login flows supported by the server for this API.</td>
 </tr>
 <tr>
  <td><code>params</code></td>
  <td><code>{string: object}</code></td>
  <td>
    Contains any information that the client will need to know in order to
use a given type of authentication. For each login type presented,
that type may be present as a key in this dictionary. For example, the
public part of an OAuth client ID could be given here.</td>
 </tr>
 <tr>
  <td><code>session</code></td>
  <td><code>string</code></td>
  <td>
    This is a session identifier that the client must pass back to the home
server, if one is provided, in subsequent attempts to authenticate in the
same API call.</td>
 </tr>
</table>
<table id="_matrixclientv3delete_devices_flow-information" class="object-table">
 <caption>Flow information</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>stages</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The login type of each of the stages required to complete this
authentication flow</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;completed&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;example.type.foo&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;flows&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;stages&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;example.type.foo&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;params&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;example.type.baz&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;example_key&#34;</span><span class="p">:</span> <span class="s2">&#34;foobar&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;xxxxxxyz&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3devices">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/devices</span>
  </h1>
</summary>
  <hr/>
<p>Gets information about all devices for the current user.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<p>No request parameters or request body.</p>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>Device information</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>devices</code></td>
  <td><code>[Device]</code></td>
  <td>
    A list of all registered devices for this user.</td>
 </tr>
</table>
<table id="_matrixclientv3devices_device" class="object-table">
 <caption>Device</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>device_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Identifier of this device.</td>
 </tr>
 <tr>
  <td><code>display_name</code></td>
  <td><code>string</code></td>
  <td>
    Display name set by the user for this device. Absent if no name has been
set.</td>
 </tr>
 <tr>
  <td><code>last_seen_ip</code></td>
  <td><code>string</code></td>
  <td>
    The IP address where this device was last seen. (May be a few minutes out
of date, for efficiency reasons).</td>
 </tr>
 <tr>
  <td><code>last_seen_ts</code></td>
  <td><code>integer</code></td>
  <td>
    The timestamp (in milliseconds since the unix epoch) when this devices
was last seen. (May be a few minutes out of date, for efficiency
reasons).</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;devices&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;device_id&#34;</span><span class="p">:</span> <span class="s2">&#34;QBUAZIFURK&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;display_name&#34;</span><span class="p">:</span> <span class="s2">&#34;android&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;last_seen_ip&#34;</span><span class="p">:</span> <span class="s2">&#34;1.2.3.4&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;last_seen_ts&#34;</span><span class="p">:</span> <span class="mi">1474491775024</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3devicesdeviceid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/devices/{deviceId}</span>
  </h1>
</summary>
  <hr/>
<p>Gets information on a single device, by device id.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>deviceId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The device to retrieve.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>Device information</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The current user has no device with the given ID.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="_matrixclientv3devicesdeviceid_device" class="object-table">
 <caption>Device</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>device_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Identifier of this device.</td>
 </tr>
 <tr>
  <td><code>display_name</code></td>
  <td><code>string</code></td>
  <td>
    Display name set by the user for this device. Absent if no name has been
set.</td>
 </tr>
 <tr>
  <td><code>last_seen_ip</code></td>
  <td><code>string</code></td>
  <td>
    The IP address where this device was last seen. (May be a few minutes out
of date, for efficiency reasons).</td>
 </tr>
 <tr>
  <td><code>last_seen_ts</code></td>
  <td><code>integer</code></td>
  <td>
    The timestamp (in milliseconds since the unix epoch) when this devices
was last seen. (May be a few minutes out of date, for efficiency
reasons).</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;device_id&#34;</span><span class="p">:</span> <span class="s2">&#34;QBUAZIFURK&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;display_name&#34;</span><span class="p">:</span> <span class="s2">&#34;android&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;last_seen_ip&#34;</span><span class="p">:</span> <span class="s2">&#34;1.2.3.4&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;last_seen_ts&#34;</span><span class="p">:</span> <span class="mi">1474491775024</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixclientv3devicesdeviceid">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/client/v3/devices/{deviceId}</span>
  </h1>
</summary>
  <hr/>
<p>Updates the metadata on the given device.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>deviceId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The device to update.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>display_name</code></td>
  <td><code>string</code></td>
  <td>
    The new display name for this device. If not given, the
display name is unchanged.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;display_name&#34;</span><span class="p">:</span> <span class="s2">&#34;My other phone&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The device was successfully updated.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The current user has no device with the given ID.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api DELETE">
<details open>
<summary>
  <h1 id="delete_matrixclientv3devicesdeviceid">
   <span class="http-api-method DELETE">DELETE</span>
   <span class="endpoint">/_matrix/client/v3/devices/{deviceId}</span>
  </h1>
</summary>
  <hr/>
<p><p>This API endpoint uses the <a href="/client-server-api/#user-interactive-authentication-api">User-Interactive Authentication API</a>.</p>
<p>Deletes the given device, and invalidates any access token associated with it.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>deviceId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The device to delete.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>auth</code></td>
  <td><code>Authentication Data</code></td>
  <td>
    Additional authentication information for the
user-interactive authentication API.</td>
 </tr>
</table>
<table id="_matrixclientv3devicesdeviceid_authentication-data" class="object-table">
 <caption>Authentication Data</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>session</code></td>
  <td><code>string</code></td>
  <td>
    The value of the session key given by the homeserver.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    The authentication type that the client is attempting to complete.
May be omitted if <code>session</code> is given, and the client is reissuing a
request which it believes has been completed out-of-band (for example,
via the <a href="#fallback">fallback mechanism</a>).</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;auth&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;example_credential&#34;</span><span class="p">:</span> <span class="s2">&#34;verypoorsharedsecret&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;xxxxx&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;example.type.foo&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The device was successfully removed, or had been removed
previously.</td>
 </tr>
 <tr>
  <td><code>401</code></td>
  <td>The homeserver requires additional authentication information.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>401 response</h3>
<table id="_matrixclientv3devicesdeviceid_authentication-response" class="object-table">
 <caption>Authentication response</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>completed</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of the stages the client has completed successfully</td>
 </tr>
 <tr>
  <td><code>flows</code></td>
  <td><code>[Flow information]</code></td>
  <td>
    <strong>Required: </strong>A list of the login flows supported by the server for this API.</td>
 </tr>
 <tr>
  <td><code>params</code></td>
  <td><code>{string: object}</code></td>
  <td>
    Contains any information that the client will need to know in order to
use a given type of authentication. For each login type presented,
that type may be present as a key in this dictionary. For example, the
public part of an OAuth client ID could be given here.</td>
 </tr>
 <tr>
  <td><code>session</code></td>
  <td><code>string</code></td>
  <td>
    This is a session identifier that the client must pass back to the home
server, if one is provided, in subsequent attempts to authenticate in the
same API call.</td>
 </tr>
</table>
<table id="_matrixclientv3devicesdeviceid_flow-information" class="object-table">
 <caption>Flow information</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>stages</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The login type of each of the stages required to complete this
authentication flow</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;completed&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;example.type.foo&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;flows&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;stages&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;example.type.foo&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;params&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;example.type.baz&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;example_key&#34;</span><span class="p">:</span> <span class="s2">&#34;foobar&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;xxxxxxyz&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h4 id="security-considerations">Security considerations</h4>
<p>Deleting devices has security implications: it invalidates the
access_token assigned to the device, so an attacker could use it to log
out the real user (and do it repeatedly every time the real user tries
to log in to block the attacker). Servers should require additional
authentication beyond the access token when deleting devices (for
example, requiring that the user resubmit their password).</p>
<p>The display names of devices are publicly visible. Clients should
consider advising the user of this.</p>

    







    
<h3 id="end-to-end-encryption">End-to-End Encryption</h3>
<p>Matrix optionally supports end-to-end encryption, allowing rooms to be
created whose conversation contents are not decryptable or interceptable
on any of the participating homeservers.</p>
<h4 id="key-distribution">Key Distribution</h4>
<p>Encryption and Authentication in Matrix is based around public-key
cryptography. The Matrix protocol provides a basic mechanism for
exchange of public keys, though an out-of-band channel is required to
exchange fingerprints between users to build a web of trust.</p>
<h5 id="overview">Overview</h5>
<ol>
<li>Bob publishes the public keys and supported algorithms for his
device. This may include long-term identity keys, and/or one-time
keys.</li>
</ol>
<pre tabindex="0"><code>      +----------+  +--------------+
      | Bob&#39;s HS |  | Bob&#39;s Device |
      +----------+  +--------------+
            |              |
            |&lt;=============|
              /keys/upload
</code></pre><ol start="2">
<li>Alice requests Bob&rsquo;s public identity keys and supported algorithms.</li>
</ol>
<pre tabindex="0"><code>      +----------------+  +------------+  +----------+
      | Alice&#39;s Device |  | Alice&#39;s HS |  | Bob&#39;s HS |
      +----------------+  +------------+  +----------+
             |                  |               |
             |=================&gt;|==============&gt;|
               /keys/query        &lt;federation&gt;
</code></pre><ol start="3">
<li>Alice selects an algorithm and claims any one-time keys needed.</li>
</ol>
<pre tabindex="0"><code>      +----------------+  +------------+  +----------+
      | Alice&#39;s Device |  | Alice&#39;s HS |  | Bob&#39;s HS |
      +----------------+  +------------+  +----------+
             |                  |               |
             |=================&gt;|==============&gt;|
               /keys/claim         &lt;federation&gt;
</code></pre><h5 id="key-algorithms">Key algorithms</h5>
<p>Different key algorithms are used for different purposes.  Each key algorithm
is identified by a name and is represented in a specific way.</p>
<p>The name <code>ed25519</code> corresponds to the
<a href="http://ed25519.cr.yp.to/">Ed25519</a> signature algorithm. The key is a
32-byte Ed25519 public key, encoded using <a href="/appendices/#unpadded-base64">unpadded Base64</a>. Example:</p>
<pre><code>&quot;SogYyrkTldLz0BXP+GYWs0qaYacUI0RleEqNT8J3riQ&quot;
</code></pre>
<p>The name <code>curve25519</code> corresponds to the
<a href="https://cr.yp.to/ecdh.html">Curve25519</a> ECDH algorithm. The key is a
32-byte Curve25519 public key, encoded using <a href="/appendices/#unpadded-base64">unpadded Base64</a>.
Example:</p>
<pre><code>&quot;JGLn/yafz74HB2AbPLYJWIVGnKAtqECOBf11yyXac2Y&quot;
</code></pre>
<p>The name <code>signed_curve25519</code> also corresponds to the Curve25519 ECDH algorithm,
but the key is signed so that it can be authenticated. A key using this
algorithm is represented by an object with the following properties:</p>
<p><code>KeyObject</code></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>key</td>
<td>string</td>
<td><strong>Required.</strong> The unpadded Base64-encoded 32-byte Curve25519 public key.</td>
</tr>
<tr>
<td>signatures</td>
<td>Signatures</td>
<td><strong>Required.</strong> Signatures of the key object. The signature is calculated using the process described at <a href="/appendices/#signing-json">Signing JSON</a>.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;key&#34;</span><span class="p">:</span><span class="s2">&#34;06UzBknVHFMwgi7AVloY7ylC+xhOhEX4PkNge14Grl8&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@user:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;ed25519:EGURVBUNJP&#34;</span><span class="p">:</span> <span class="s2">&#34;YbJva03ihSj5mPk+CHMJKUKlCXCPFXjXOK6VqBnN9nA2evksQcTGn6hwQfrgRHIDDXO2le49x7jnWJHMJrJoBQ&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>ed25519</code> and <code>curve25519</code> keys are used for <a href="#device-keys">device keys</a>.
Additionally, <code>ed25519</code> keys are used for <a href="#cross-signing">cross-signing keys</a>.</p>
<p><code>signed_curve25519</code> keys are used for <a href="#one-time-and-fallback-keys">one-time and fallback keys</a>.</p>
<h5 id="device-keys">Device keys</h5>
<p>Each device should have one Ed25519 signing key. This key should be
generated on the device from a cryptographically secure source, and the
private part of the key should never be exported from the device. This
key is used as the fingerprint for a device by other clients, and signs the
device&rsquo;s other keys.</p>
<p>A device will generally need to generate a number of additional keys.
Details of these will vary depending on the messaging algorithm in use.</p>
<p>For Olm version 1, each device also requires a single Curve25519 identity
key.</p>
<h5 id="one-time-and-fallback-keys">One-time and fallback keys</h5>
<p>In addition to the device keys, which are long-lived, some encryption
algorithms require that devices may also have a number of one-time keys, which
are only used once and discarded after use. For Olm version 1, devices use
<code>signed_curve25519</code> one-time keys, signed by the device&rsquo;s Ed25519 key.</p>
<p>Devices will generate one-time keys and upload them to the server; these will
later be <a href="#post_matrixclientv3keysclaim">claimed</a> by other users. Servers must
ensure that each one-time key is only claimed once: a homeserver should discard
the one time key once it has been given to another user.</p>
<p><span><strong>[Added in <code>v1.2</code>]</strong></span></p>
<p>Fallback keys are similar to one-time keys, but are
not consumed once used. If a fallback key has been uploaded, it will be
returned by the server when the device has run out of one-time keys and a user
tries to claim a key. Fallback keys should be replaced with new fallback keys
as soon as possible after they have been used.</p>
<div class="alert warning " role="alert">
Fallback keys are used to prevent one-time key exhaustion when devices
are offline/unable to upload additional keys, though sessions started using
fallback keys could be vulnerable to replay attacks.
</div>
<p>Devices will be informed, <a href="#e2e-extensions-to-sync">via <code>/sync</code></a>, about the number of
one-time keys remaining that can be claimed, as well as whether the fallback
keys have been used. The device can thus ensure that, while it is online, there
is a sufficient supply of one-time keys available, and that the fallback keys
get replaced if they have been used.</p>
<h5 id="uploading-keys">Uploading keys</h5>
<p>A device uploads the public parts of identity keys to their homeserver
as a signed JSON object, using the <a href="/client-server-api/#post_matrixclientv3keysupload"><code>/keys/upload</code></a> API. The JSON object
must include the public part of the device&rsquo;s Ed25519 key, and must be
signed by that key, as described in <a href="/appendices/#signing-json">Signing
JSON</a>.</p>
<p>One-time and fallback keys are also uploaded to the homeserver using the
<a href="/client-server-api/#post_matrixclientv3keysupload"><code>/keys/upload</code></a> API. New
one-time and fallback keys are uploaded as needed.</p>
<p>Devices must store the private part of each key they upload. They can
discard the private part of a one-time key when they receive a message
using that key. However it&rsquo;s possible that a one-time key given out by a
homeserver will never be used, so the device that generates the key will
never know that it can discard the key. Therefore a device could end up
trying to store too many private keys. A device that is trying to store
too many private keys may discard keys starting with the oldest.</p>
<div class="alert warning " role="alert">
<p>Clients should not store the private half of fallback keys indefinitely
to avoid situations where attackers can decrypt past messages sent using
that fallback key.</p>
<p>Instead, clients should keep the private keys for at most 2 fallback keys:
the current, unused, fallback key and the key immediately preceding it.
Once the client is reasonably certain it has received all messages that
used the old fallback key, such as after an hour since the first message,
it should remove that fallback key.</p>
</div>
<h5 id="tracking-the-device-list-for-a-user">Tracking the device list for a user</h5>
<p>Before Alice can send an encrypted message to Bob, she needs a list of
each of his devices and the associated identity keys, so that she can
establish an encryption session with each device. This list can be
obtained by calling <a href="/client-server-api/#post_matrixclientv3keysquery"><code>/keys/query</code></a>, passing Bob&rsquo;s user ID in the
<code>device_keys</code> parameter.</p>
<p>From time to time, Bob may add new devices, and Alice will need to know
this so that she can include his new devices for later encrypted
messages. A naive solution to this would be to call <a href="/client-server-api/#post_matrixclientv3keysquery"><code>/keys/query</code></a>
before sending each message -however, the number of users and devices
may be large and this would be inefficient.</p>
<p>It is therefore expected that each client will maintain a list of
devices for a number of users (in practice, typically each user with
whom we share an encrypted room). Furthermore, it is likely that this
list will need to be persisted between invocations of the client
application (to preserve device verification data and to alert Alice if
Bob suddenly gets a new device).</p>
<p>Alice&rsquo;s client can maintain a list of Bob&rsquo;s devices via the following
process:</p>
<ol>
<li>It first sets a flag to record that it is now tracking Bob&rsquo;s device
list, and a separate flag to indicate that its list of Bob&rsquo;s devices
is outdated. Both flags should be in storage which persists over
client restarts.</li>
<li>It then makes a request to <a href="/client-server-api/#post_matrixclientv3keysquery"><code>/keys/query</code></a>, passing Bob&rsquo;s user ID in
the <code>device_keys</code> parameter. When the request completes, it stores
the resulting list of devices in persistent storage, and clears the
&lsquo;outdated&rsquo; flag.</li>
<li>During its normal processing of responses to <a href="/client-server-api/#get_matrixclientv3sync"><code>/sync</code></a>, Alice&rsquo;s client
inspects the <code>changed</code> property of the <a href="#e2e-extensions-to-sync"><code>device_lists</code></a> field. If it
is tracking the device lists of any of the listed users, then it
marks the device lists for those users outdated, and initiates
another request to <a href="/client-server-api/#post_matrixclientv3keysquery"><code>/keys/query</code></a> for them.</li>
<li>Periodically, Alice&rsquo;s client stores the <code>next_batch</code> field of the
result from <a href="/client-server-api/#get_matrixclientv3sync"><code>/sync</code></a> in persistent storage. If Alice later restarts her
client, it can obtain a list of the users who have updated their
device list while it was offline by calling <a href="/client-server-api/#get_matrixclientv3keyschanges"><code>/keys/changes</code></a>,
passing the recorded <code>next_batch</code> field as the <code>from</code> parameter. If
the client is tracking the device list of any of the users listed in
the response, it marks them as outdated. It combines this list with
those already flagged as outdated, and initiates a <a href="/client-server-api/#post_matrixclientv3keysquery"><code>/keys/query</code></a>
request for all of them.</li>
</ol>
<div class="alert warning " role="alert">
<p>Bob may update one of his devices while Alice has a request to
<code>/keys/query</code> in flight. Alice&rsquo;s client may therefore see Bob&rsquo;s user ID
in the <code>device_lists</code> field of the <code>/sync</code> response while the first
request is in flight, and initiate a second request to <code>/keys/query</code>.
This may lead to either of two related problems.</p>
<p>The first problem is that, when the first request completes, the client
will clear the &lsquo;outdated&rsquo; flag for Bob&rsquo;s devices. If the second request
fails, or the client is shut down before it completes, this could lead
to Alice using an outdated list of Bob&rsquo;s devices.</p>
<p>The second possibility is that, under certain conditions, the second
request may complete <em>before</em> the first one. When the first request
completes, the client could overwrite the later results from the second
request with those from the first request.</p>
<p>Clients MUST guard against these situations. For example, a client could
ensure that only one request to <code>/keys/query</code> is in flight at a time for
each user, by queuing additional requests until the first completes.
Alternatively, the client could make a new request immediately, but
ensure that the first request&rsquo;s results are ignored (possibly by
cancelling the request).</p>
</div>
<div class="alert note " role="alert">
When Bob and Alice share a room, with Bob tracking Alice&rsquo;s devices, she
may leave the room and then add a new device. Bob will not be notified
of this change, as he doesn&rsquo;t share a room anymore with Alice. When they
start sharing a room again, Bob has an out-of-date list of Alice&rsquo;s
devices. In order to address this issue, Bob&rsquo;s homeserver will add
Alice&rsquo;s user ID to the <code>changed</code> property of the <code>device_lists</code> field,
thus Bob will update his list of Alice&rsquo;s devices as part of his normal
processing. Note that Bob can also be notified when he stops sharing any
room with Alice by inspecting the <code>left</code> property of the <code>device_lists</code>
field, and as a result should remove her from its list of tracked users.
</div>
<h5 id="sending-encrypted-attachments">Sending encrypted attachments</h5>
<p>When encryption is enabled in a room, files should be uploaded encrypted
on the homeserver.</p>
<p>In order to achieve this, a client should generate a single-use 256-bit
AES key, and encrypt the file using AES-CTR. The counter should be
64-bit long, starting at 0 and prefixed by a random 64-bit
Initialization Vector (IV), which together form a 128-bit unique counter
block.</p>
<div class="alert warning " role="alert">
An IV must never be used multiple times with the same key. This implies
that if there are multiple files to encrypt in the same message,
typically an image and its thumbnail, the files must not share both the
same key and IV.
</div>
<p>Then, the encrypted file can be uploaded to the homeserver. The key and
the IV must be included in the room event along with the resulting
<code>mxc://</code> in order to allow recipients to decrypt the file. As the event
containing those will be Megolm encrypted, the server will never have
access to the decrypted file.</p>
<p>A hash of the ciphertext must also be included, in order to prevent the
homeserver from changing the file content.</p>
<p>A client should send the data as an encrypted <code>m.room.message</code> event,
using either <code>m.file</code> as the msgtype, or the appropriate msgtype for the
file type. The key is sent using the <a href="https://tools.ietf.org/html/rfc7517#appendix-A.3">JSON Web
Key</a> format, with a
<a href="https://w3c.github.io/webcrypto/#iana-section-jwk">W3C extension</a>.</p>
<h6 id="extensions-to-mroommessage-msgtypes">Extensions to <code>m.room.message</code> msgtypes</h6>
<p>This module adds <code>file</code> and <code>thumbnail_file</code> properties, of type
<code>EncryptedFile</code>, to <code>m.room.message</code> msgtypes that reference files, such
as <a href="#mfile">m.file</a> and <a href="#mimage">m.image</a>, replacing the <code>url</code> and <code>thumbnail_url</code>
properties.</p>
<p><code>EncryptedFile</code></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>url</td>
<td>string</td>
<td><strong>Required.</strong> The URL to the file.</td>
</tr>
<tr>
<td>key</td>
<td>JWK</td>
<td><strong>Required.</strong> A <a href="https://tools.ietf.org/html/rfc7517#appendix-A.3">JSON Web Key</a> object.</td>
</tr>
<tr>
<td>iv</td>
<td>string</td>
<td><strong>Required.</strong> The 128-bit unique counter block used by AES-CTR, encoded as unpadded base64.</td>
</tr>
<tr>
<td>hashes</td>
<td>{string: string}</td>
<td><strong>Required.</strong> A map from an algorithm name to a hash of the ciphertext, encoded as unpadded base64. Clients should support the SHA-256 hash, which uses the key <code>sha256</code>.</td>
</tr>
<tr>
<td>v</td>
<td>string</td>
<td><strong>Required.</strong> Version of the encrypted attachment&rsquo;s protocol. Must be <code>v2</code>.</td>
</tr>
</tbody>
</table>
<p><code>JWK</code></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>kty</td>
<td>string</td>
<td><strong>Required.</strong> Key type. Must be <code>oct</code>.</td>
</tr>
<tr>
<td>key_ops</td>
<td>[string]</td>
<td><strong>Required.</strong> Key operations. Must at least contain <code>encrypt</code> and <code>decrypt</code>.</td>
</tr>
<tr>
<td>alg</td>
<td>string</td>
<td><strong>Required.</strong> Algorithm. Must be <code>A256CTR</code>.</td>
</tr>
<tr>
<td>k</td>
<td>string</td>
<td><strong>Required.</strong> The key, encoded as urlsafe unpadded base64.</td>
</tr>
<tr>
<td>ext</td>
<td>boolean</td>
<td><strong>Required.</strong> Extractable. Must be <code>true</code>. This is a <a href="https://w3c.github.io/webcrypto/#iana-section-jwk">W3C extension</a>.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;something-important.jpg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;file&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/FHyPlCeYUSFFxlgbQYZmoEoe&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;v&#34;</span><span class="p">:</span> <span class="s2">&#34;v2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;alg&#34;</span><span class="p">:</span> <span class="s2">&#34;A256CTR&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ext&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;k&#34;</span><span class="p">:</span> <span class="s2">&#34;aWF6-32KGYaC3A_FEUCk1Bt0JA37zP0wrStgmdCaW-0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;key_ops&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;encrypt&#34;</span><span class="p">,</span><span class="s2">&#34;decrypt&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;kty&#34;</span><span class="p">:</span> <span class="s2">&#34;oct&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;iv&#34;</span><span class="p">:</span> <span class="s2">&#34;w+sE15fzSc0AAAAAAAAAAA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;hashes&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sha256&#34;</span><span class="p">:</span> <span class="s2">&#34;fdSLu/YkRx3Wyh3KQabP3rd6+SFiKg5lsJZQHtkSAYA&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;info&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;mimetype&#34;</span><span class="p">:</span> <span class="s2">&#34;image/jpeg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;h&#34;</span><span class="p">:</span> <span class="mi">1536</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">422018</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;thumbnail_file&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;hashes&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;sha256&#34;</span><span class="p">:</span> <span class="s2">&#34;/NogKqW5bz/m8xHgFiH5haFGjCNVmUIPLzfvOhHdrxY&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;iv&#34;</span><span class="p">:</span> <span class="s2">&#34;U+k7PfwLr6UAAAAAAAAAAA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;alg&#34;</span><span class="p">:</span> <span class="s2">&#34;A256CTR&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ext&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;k&#34;</span><span class="p">:</span> <span class="s2">&#34;RMyd6zhlbifsACM1DXkCbioZ2u0SywGljTH8JmGcylg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;key_ops&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;encrypt&#34;</span><span class="p">,</span> <span class="s2">&#34;decrypt&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;kty&#34;</span><span class="p">:</span> <span class="s2">&#34;oct&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/pmVJxyxGlmxHposwVSlOaEOv&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;v&#34;</span><span class="p">:</span> <span class="s2">&#34;v2&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;thumbnail_info&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;h&#34;</span><span class="p">:</span> <span class="mi">768</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;mimetype&#34;</span><span class="p">:</span> <span class="s2">&#34;image/jpeg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">211009</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;w&#34;</span><span class="p">:</span> <span class="mi">432</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;w&#34;</span><span class="p">:</span> <span class="mi">864</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.image&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="device-verification">Device verification</h4>
<p>Before Alice sends Bob encrypted data, or trusts data received from him,
she may want to verify that she is actually communicating with him,
rather than a man-in-the-middle. This verification process requires an
out-of-band channel: there is no way to do it within Matrix without
trusting the administrators of the homeservers.</p>
<p>In Matrix, verification works by Alice meeting Bob in person, or
contacting him via some other trusted medium, and using one of the
verification methods defined below to interactively verify Bob&rsquo;s devices.
Alice and Bob may also read aloud their unpadded base64 encoded Ed25519
public key, as returned by <code>/keys/query</code>.</p>
<p>Device verification may reach one of several conclusions. For example:</p>
<ul>
<li>Alice may &ldquo;accept&rdquo; the device. This means that she is satisfied that
the device belongs to Bob. She can then encrypt sensitive material
for that device, and knows that messages received were sent from
that device.</li>
<li>Alice may &ldquo;reject&rdquo; the device. She will do this if she knows or
suspects that Bob does not control that device (or equivalently,
does not trust Bob). She will not send sensitive material to that
device, and cannot trust messages apparently received from it.</li>
<li>Alice may choose to skip the device verification process. She is not
able to verify that the device actually belongs to Bob, but has no
reason to suspect otherwise. The encryption protocol continues to
protect against passive eavesdroppers.</li>
</ul>
<div class="alert note " role="alert">
Once the signing key has been verified, it is then up to the encryption
protocol to verify that a given message was sent from a device holding
that Ed25519 private key, or to encrypt a message so that it may only be
decrypted by such a device. For the Olm protocol, this is documented at
<a href="https://matrix.org/docs/olm_signing.html">https://matrix.org/docs/olm_signing.html</a>.
</div>
<h5 id="key-verification-framework">Key verification framework</h5>
<p>Verifying keys manually by reading out the Ed25519 key is not very
user-friendly, and can lead to errors. In order to help mitigate errors,
and to make the process easier for users, some verification methods are
supported by the specification and use messages exchanged by the user&rsquo;s devices
to assist in the verification. The methods all use a common framework
for negotiating the key verification.</p>
<p>Verification messages can be sent either in a room shared by the two parties,
which should be a <a href="#direct-messaging">direct messaging</a> room between the two
parties, or by using <a href="#send-to-device-messaging">to-device</a> messages sent
directly between the two devices involved.  In both cases, the messages
exchanged are similar, with minor differences as detailed below. Verifying
between two different users should be performed using in-room messages, whereas
verifying two devices belonging to the same user should be performed using
to-device messages.</p>
<p>A key verification session is identified by an ID that is established by the
first message sent in that session. For verifications using in-room messages,
the ID is the event ID of the initial message, and for verifications using
to-device messages, the first message contains a <code>transaction_id</code> field that is
shared by the other messages of that session.</p>
<p>In general, verification operates as follows:</p>
<ul>
<li>Alice requests a key verification with Bob by sending a key verification
request event.  If the verification is being requested in a room, this will
be an event with type <a href="#mroommessagemkeyverificationrequest"><code>m.room.message</code> and <code>msgtype: m.key.verification.request</code></a>; if the verification is being requested using
to-device messaging, this will be an event with type
<a href="#mkeyverificationrequest"><code>m.key.verification.request</code></a>.  This event indicates the verification methods
that Alice&rsquo;s client supports. (Note that &ldquo;Alice&rdquo; and &ldquo;Bob&rdquo; may in fact be the
same user, in the case where a user is verifying their own devices.)</li>
<li>Bob&rsquo;s client prompts Bob to accept the key verification. When Bob accepts
the verification, Bob&rsquo;s client sends an <a href="#mkeyverificationready"><code>m.key.verification.ready</code></a> event.
This event indicates the verification methods, corresponding to the
verification methods supported by Alice&rsquo;s client, that Bob&rsquo;s client supports.</li>
<li>Alice&rsquo;s or Bob&rsquo;s devices allow their users to select one of the verification
methods supported by both devices to use for verification. When Alice or Bob
selects a verification method, their device begins the verification by
sending an <a href="#mkeyverificationstart"><code>m.key.verification.start</code></a> event, indicating the selected
verification method. Note that if there is only one verification method in
common between the devices then the receiver&rsquo;s device (Bob) can auto-select
it.</li>
<li>Alice and Bob complete the verification as defined by the selected
verification method. This could involve their clients exchanging messages,
Alice and Bob exchanging information out-of-band, and/or Alice and Bob
interacting with their devices.</li>
<li>Alice&rsquo;s and Bob&rsquo;s clients send <a href="#mkeyverificationdone"><code>m.key.verification.done</code></a> events to indicate
that the verification was successful.</li>
</ul>
<p>Verifications can be cancelled by either device at any time by sending an
<a href="#mkeyverificationcancel"><code>m.key.verification.cancel</code></a> event with a <code>code</code> field that indicates the reason
it was cancelled.</p>
<p>When using to-device messages, Alice may not know which of Bob&rsquo;s devices to
verify, or may not want to choose a specific device. In this case, Alice will
send <code>m.key.verification.request</code> events to all of Bob&rsquo;s devices. All of these
events will use the same transaction ID. When Bob accepts or declines the
verification on one of his devices (sending either an
<code>m.key.verification.ready</code> or <code>m.key.verification.cancel</code> event), Alice will
send an <code>m.key.verification.cancel</code> event to Bob&rsquo;s other devices with a <code>code</code>
of <code>m.accepted</code> in the case where Bob accepted the verification, or <code>m.user</code> in
the case where Bob rejected the verification. This yields the following
handshake when using to-device messages, assuming both Alice and Bob each have
2 devices, Bob&rsquo;s first device accepts the key verification request, and Alice&rsquo;s
second device initiates the request. Note how Alice&rsquo;s first device is not
involved in the request or verification process. Also note that, although in
this example, Bob&rsquo;s device sends the <code>m.key.verification.start</code>, Alice&rsquo;s device
could also send that message. As well, the order of the
<code>m.key.verification.done</code> messages could be reversed.</p>
<pre tabindex="0"><code>    +---------------+ +---------------+                    +-------------+ +-------------+
    | AliceDevice1  | | AliceDevice2  |                    | BobDevice1  | | BobDevice2  |
    +---------------+ +---------------+                    +-------------+ +-------------+
            |                 |                                   |               |
            |                 | m.key.verification.request        |               |
            |                 |----------------------------------&gt;|               |
            |                 |                                   |               |
            |                 | m.key.verification.request        |               |
            |                 |--------------------------------------------------&gt;|
            |                 |                                   |               |
            |                 |          m.key.verification.ready |               |
            |                 |&lt;----------------------------------|               |
            |                 |                                   |               |
            |                 | m.key.verification.cancel         |               |
            |                 |--------------------------------------------------&gt;|
            |                 |                                   |               |
            |                 |          m.key.verification.start |               |
            |                 |&lt;----------------------------------|               |
            |                 |                                   |               |
            .
            .                       (verification messages)
            .
            |                 |                                   |               |
            |                 |           m.key.verification.done |               |
            |                 |&lt;----------------------------------|               |
            |                 |                                   |               |
            |                 | m.key.verification.done           |               |
            |                 |----------------------------------&gt;|               |
            |                 |                                   |               |
</code></pre><p>In contrast with the case of using to-devices messages, when using in-room
messages, Alice only sends one request event (an event with type
<code>m.room.message</code> with <code>msgtype: m.key.verification.request</code>, rather than an
event with type <code>m.key.verification.request</code>), to the room. In addition, Alice
does not send an <code>m.key.verification.cancel</code> event to tell Bob&rsquo;s other devices
that the request as already been accepted; instead, when Bob&rsquo;s other devices
see his <code>m.key.verification.ready</code> event, they will know that the request has
already been accepted, and that they should ignore the request.</p>
<p>When using in-room messages and the room has encryption enabled, clients should
ensure that encryption does not hinder the verification. For example, if the
verification messages are encrypted, clients must ensure that all the
recipient&rsquo;s unverified devices receive the keys necessary to decrypt the
messages, even if they would normally not be given the keys to decrypt messages
in the room. Alternatively, verification messages may be sent unencrypted,
though this is not encouraged.</p>
<p>Upon receipt of Alice&rsquo;s <code>m.key.verification.request</code> message, if Bob&rsquo;s device
does not understand any of the methods, it should not cancel the request as one
of his other devices may support the request. Instead, Bob&rsquo;s device should tell
Bob that no supported method was found, and allow him to manually reject the
request.</p>
<p>The prompt for Bob to accept/reject Alice&rsquo;s request (or the unsupported method
prompt) should be automatically dismissed 10 minutes after the <code>timestamp</code> (in
the case of to-device messages) or <code>origin_ts</code> (in the case of in-room
messages) field or 2 minutes after Bob&rsquo;s client receives the message, whichever
comes first, if Bob does not interact with the prompt. The prompt should
additionally be hidden if an appropriate <code>m.key.verification.cancel</code> message is
received.</p>
<p>If Bob rejects the request, Bob&rsquo;s client must send an
<code>m.key.verification.cancel</code> event with <code>code</code> set to <code>m.user</code>. Upon receipt,
Alice&rsquo;s device should tell her that Bob does not want to verify her device and,
if the request was sent as a to-device message, send
<code>m.key.verification.cancel</code> messages to all of Bob&rsquo;s devices to notify them
that the request was rejected.</p>
<p>If Alice&rsquo;s and Bob&rsquo;s clients both send an <code>m.key.verification.start</code> message,
and both specify the same verification method, then the
<code>m.key.verification.start</code> message sent by the user whose ID is the
lexicographically largest user ID should be ignored, and the situation should
be treated the same as if only the user with the lexicographically smallest
user ID had sent the <code>m.key.verification.start</code> message.  In the case where the
user IDs are the same (that is, when a user is verifying their own device),
then the device IDs should be compared instead.  If the two
<code>m.key.verification.start</code> messages do not specify the same verification
method, then the verification should be cancelled with a <code>code</code> of
<code>m.unexpected_message</code>.</p>
<p>When verifying using to-device messages, an <code>m.key.verification.start</code>
message can also be sent independently of any
request, specifying the verification method to use. This behaviour is
deprecated, and new clients should not begin verifications in this way.
However, clients should handle such verifications started by other clients.</p>
<p>Individual verification methods may add additional steps, events, and
properties to the verification messages. Event types for methods defined
in this specification must be under the <code>m.key.verification</code> namespace
and any other event types must be namespaced according to the Java
package naming convention.</p>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mroommessagemkeyverificationrequest">
   <code>m.room.message</code> with <code>msgtype: m.key.verification.request</code>
  </h1>
</summary>
  <hr/>
<p>Requests a key verification in a room.  When requesting a key verification using to-device messaging, an event with type <a href="#mkeyverificationrequest"><code>m.key.verification.request</code></a> should be used.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>body</code></td>
  <td><code>string</code></td>
  <td>
    <p>A fallback message to alert users that their client does not support
the key verification framework, and that they should use a different method
to verify keys.  For example, &ldquo;Alice is requesting to verify keys with you.
However, your client does not support this method, so you will need to use
the legacy method of key verification.&rdquo;</p>
<p>Clients that do support the key verification framework should hide the body
and instead present the user with an interface to accept or reject the key
verification.</p>
</td>
 </tr>
 <tr>
  <td><code>format</code></td>
  <td><code>string</code></td>
  <td>
    The format used in the <code>formatted_body</code>. Currently only
<code>org.matrix.custom.html</code> is supported.</td>
 </tr>
 <tr>
  <td><code>formatted_body</code></td>
  <td><code>string</code></td>
  <td>
    The formatted version of the <code>body</code>. This is required if <code>format</code> is
specified.  As with the <code>body</code>, clients that do support the key
verification framework should hide the formatted body and instead
present the user with an interface to accept or reject the key
verification.</td>
 </tr>
 <tr>
  <td><code>from_device</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The device ID which is initiating the request.</td>
 </tr>
 <tr>
  <td><code>methods</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The verification methods supported by the sender.</td>
 </tr>
 <tr>
  <td><code>msgtype</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><p>One of: <code>[m.key.verification.request]</code>.</p></td>
 </tr>
 <tr>
  <td><code>to</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user that the verification request is intended for.  Users who
are not named in this field and who did not send this event should
ignore all other events that have an <code>m.reference</code> relationship with
this event.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice is requesting to verify your device, but your client does not support verification, so you may need to use a different verification method.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;from_device&#34;</span><span class="p">:</span> <span class="s2">&#34;AliceDevice2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;methods&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;m.sas.v1&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.key.verification.request&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;to&#34;</span><span class="p">:</span> <span class="s2">&#34;@bob:example.org&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mkeyverificationrequest">
   <code>m.key.verification.request</code>
  </h1>
</summary>
  <hr/>
<p>Requests a key verification using to-device messaging.  When requesting a key
verification in a room, a <code>m.room.message</code> should be used, with
<a href="#mroommessagemkeyverificationrequest"><code>m.key.verification.request</code></a> as msgtype.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>from_device</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The device ID which is initiating the request.</td>
 </tr>
 <tr>
  <td><code>methods</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The verification methods supported by the sender.</td>
 </tr>
 <tr>
  <td><code>timestamp</code></td>
  <td><code>integer</code></td>
  <td>
    Required when sent as a to-device message. The POSIX timestamp in
milliseconds for when the request was made. If the request is in the
future by more than 5 minutes or more than 10 minutes in the past,
the message should be ignored by the receiver.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    Required when sent as a to-device message. An opaque identifier for
the verification request. Must be unique with respect to the devices
involved.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;from_device&#34;</span><span class="p">:</span> <span class="s2">&#34;AliceDevice2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;methods&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;m.sas.v1&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;timestamp&#34;</span><span class="p">:</span> <span class="mi">1559598944869</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;transaction_id&#34;</span><span class="p">:</span> <span class="s2">&#34;S0meUniqueAndOpaqueString&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.key.verification.request&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mkeyverificationready">
   <code>m.key.verification.ready</code>
  </h1>
</summary>
  <hr/>
<p>Accepts a key verification request. Sent in response to an
<code>m.key.verification.request</code> event.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>from_device</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The device ID which is accepting the request.</td>
 </tr>
 <tr>
  <td><code>m.relates_to</code></td>
  <td><code>VerificationRelatesTo</code></td>
  <td>
    Required when sent as an in-room message. Indicates the
<code>m.key.verification.request</code> that this message is related to. Note that for
encrypted messages, this property should be in the unencrypted portion of the
event.</td>
 </tr>
 <tr>
  <td><code>methods</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The verification methods supported by the sender, corresponding to
the verification methods indicated in the
<code>m.key.verification.request</code> message.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    Required when sent as a to-device message. The transaction ID of the
verification request, as given in the <code>m.key.verification.request</code>
message.</td>
 </tr>
</table>
<table id="mkeyverificationready_verificationrelatesto" class="object-table">
 <caption>VerificationRelatesTo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    The event ID of the <code>m.key.verification.request</code> that this message is
related to.</td>
 </tr>
 <tr>
  <td><code>rel_type</code></td>
  <td><code>string</code></td>
  <td>
    The relationship type. Currently, this can only be an
<a href="/client-server-api/#reference-relations"><code>m.reference</code></a> relationship type.<p>One of: <code>[m.reference]</code>.</p></td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;from_device&#34;</span><span class="p">:</span> <span class="s2">&#34;BobDevice1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;methods&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;m.sas.v1&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;transaction_id&#34;</span><span class="p">:</span> <span class="s2">&#34;S0meUniqueAndOpaqueString&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.key.verification.ready&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mkeyverificationstart">
   <code>m.key.verification.start</code>
  </h1>
</summary>
  <hr/>
<p>Begins a key verification process. Typically sent as a <a href="/client-server-api/#send-to-device-messaging">to-device</a> event. The <code>method</code>
field determines the type of verification. The fields in the event will differ depending
on the <code>method</code>. This definition includes fields that are in common among all variants.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>from_device</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The device ID which is initiating the process.</td>
 </tr>
 <tr>
  <td><code>m.relates_to</code></td>
  <td><code>VerificationRelatesTo</code></td>
  <td>
    Required when sent as an in-room message. Indicates the
<code>m.key.verification.request</code> that this message is related to. Note that for
encrypted messages, this property should be in the unencrypted portion of the
event.</td>
 </tr>
 <tr>
  <td><code>method</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The verification method to use.</td>
 </tr>
 <tr>
  <td><code>next_method</code></td>
  <td><code>string</code></td>
  <td>
    Optional method to use to verify the other user&rsquo;s key with. Applicable
when the <code>method</code> chosen only verifies one user&rsquo;s key. This field will
never be present if the <code>method</code> verifies keys both ways.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    Required when sent as a to-device message. An opaque identifier for
the verification process. Must be unique with respect to the devices
involved. Must be the same as the <code>transaction_id</code> given in the
<code>m.key.verification.request</code> if this process is originating from a
request.</td>
 </tr>
</table>
<table id="mkeyverificationstart_verificationrelatesto" class="object-table">
 <caption>VerificationRelatesTo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    The event ID of the <code>m.key.verification.request</code> that this message is
related to.</td>
 </tr>
 <tr>
  <td><code>rel_type</code></td>
  <td><code>string</code></td>
  <td>
    The relationship type. Currently, this can only be an
<a href="/client-server-api/#reference-relations"><code>m.reference</code></a> relationship type.<p>One of: <code>[m.reference]</code>.</p></td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;from_device&#34;</span><span class="p">:</span> <span class="s2">&#34;BobDevice1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;method&#34;</span><span class="p">:</span> <span class="s2">&#34;m.sas.v1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;transaction_id&#34;</span><span class="p">:</span> <span class="s2">&#34;S0meUniqueAndOpaqueString&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.key.verification.start&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;from_device&#34;</span><span class="p">:</span> <span class="s2">&#34;BobDevice1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;hashes&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;sha256&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;key_agreement_protocols&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;curve25519&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;message_authentication_codes&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;hkdf-hmac-sha256.v2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;hkdf-hmac-sha256&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;method&#34;</span><span class="p">:</span> <span class="s2">&#34;m.sas.v1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;short_authentication_string&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;decimal&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;emoji&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;transaction_id&#34;</span><span class="p">:</span> <span class="s2">&#34;S0meUniqueAndOpaqueString&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.key.verification.start&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mkeyverificationdone">
   <code>m.key.verification.done</code>
  </h1>
</summary>
  <hr/>
<p>Indicates that a verification process/request has completed successfully.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>m.relates_to</code></td>
  <td><code>VerificationRelatesTo</code></td>
  <td>
    Required when sent as an in-room message. Indicates the
<code>m.key.verification.request</code> that this message is related to. Note that for
encrypted messages, this property should be in the unencrypted portion of the
event.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    Required when sent as a to-device message. The opaque identifier for
the verification process/request.</td>
 </tr>
</table>
<table id="mkeyverificationdone_verificationrelatesto" class="object-table">
 <caption>VerificationRelatesTo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    The event ID of the <code>m.key.verification.request</code> that this message is
related to.</td>
 </tr>
 <tr>
  <td><code>rel_type</code></td>
  <td><code>string</code></td>
  <td>
    The relationship type. Currently, this can only be an
<a href="/client-server-api/#reference-relations"><code>m.reference</code></a> relationship type.<p>One of: <code>[m.reference]</code>.</p></td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;transaction_id&#34;</span><span class="p">:</span> <span class="s2">&#34;S0meUniqueAndOpaqueString&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.key.verification.done&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mkeyverificationcancel">
   <code>m.key.verification.cancel</code>
  </h1>
</summary>
  <hr/>
<p>Cancels a key verification process/request.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>code</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><p>The error code for why the process/request was cancelled by the user. Error
codes should use the Java package naming convention if not in the following
list:</p>
<ul>
<li>
<p><code>m.user</code>: The user cancelled the verification.</p>
</li>
<li>
<p><code>m.timeout</code>: The verification process timed out. Verification processes
can define their own timeout parameters.</p>
</li>
<li>
<p><code>m.unknown_transaction</code>: The device does not know about the given transaction
ID.</p>
</li>
<li>
<p><code>m.unknown_method</code>: The device does not know how to handle the requested
method. This should be sent for <code>m.key.verification.start</code> messages and
messages defined by individual verification processes.</p>
</li>
<li>
<p><code>m.unexpected_message</code>: The device received an unexpected message. Typically
raised when one of the parties is handling the verification out of order.</p>
</li>
<li>
<p><code>m.key_mismatch</code>: The key was not verified.</p>
</li>
<li>
<p><code>m.user_mismatch</code>: The expected user did not match the user verified.</p>
</li>
<li>
<p><code>m.invalid_message</code>: The message received was invalid.</p>
</li>
<li>
<p><code>m.accepted</code>: A <code>m.key.verification.request</code> was accepted by a different
device. The device receiving this error can ignore the verification request.</p>
</li>
</ul>
<p>Clients should be careful to avoid error loops. For example, if a device sends
an incorrect message and the client returns <code>m.invalid_message</code> to which it
gets an unexpected response with <code>m.unexpected_message</code>, the client should not
respond again with <code>m.unexpected_message</code> to avoid the other device potentially
sending another error response.</p>
</td>
 </tr>
 <tr>
  <td><code>m.relates_to</code></td>
  <td><code>VerificationRelatesTo</code></td>
  <td>
    Required when sent as an in-room message. Indicates the
<code>m.key.verification.request</code> that this message is related to. Note that for
encrypted messages, this property should be in the unencrypted portion of the
event.</td>
 </tr>
 <tr>
  <td><code>reason</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A human readable description of the <code>code</code>. The client should only rely on this
string if it does not understand the <code>code</code>.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    Required when sent as a to-device message. The opaque identifier for
the verification process/request.</td>
 </tr>
</table>
<table id="mkeyverificationcancel_verificationrelatesto" class="object-table">
 <caption>VerificationRelatesTo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    The event ID of the <code>m.key.verification.request</code> that this message is
related to.</td>
 </tr>
 <tr>
  <td><code>rel_type</code></td>
  <td><code>string</code></td>
  <td>
    The relationship type. Currently, this can only be an
<a href="/client-server-api/#reference-relations"><code>m.reference</code></a> relationship type.<p>One of: <code>[m.reference]</code>.</p></td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;code&#34;</span><span class="p">:</span> <span class="s2">&#34;m.user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;User rejected the key verification request&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;transaction_id&#34;</span><span class="p">:</span> <span class="s2">&#34;S0meUniqueAndOpaqueString&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.key.verification.cancel&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h5 id="short-authentication-string-sas-verification">Short Authentication String (SAS) verification</h5>
<p>SAS verification is a user-friendly key verification process built off
the common framework outlined above. SAS verification is intended to be
a highly interactive process for users, and as such exposes verification
methods which are easier for users to use.</p>
<p>The verification process is heavily inspired by Phil Zimmermann&rsquo;s ZRTP
key agreement handshake. A key part of key agreement in ZRTP is the hash
commitment: the party that begins the Diffie-Hellman key sharing sends a
hash of their part of the Diffie-Hellman exchange, and does not send
their part of the Diffie-Hellman exchange until they have received the
other party&rsquo;s part. Thus an attacker essentially only has one attempt to
attack the Diffie-Hellman exchange, and hence we can verify fewer bits
while still achieving a high degree of security: if we verify n bits,
then an attacker has a 1 in 2<sup>n</sup> chance of success. For
example, if we verify 40 bits, then an attacker has a 1 in
1,099,511,627,776 chance (or less than 1 in 10<sup>12</sup> chance) of
success. A failed attack would result in a mismatched Short
Authentication String, alerting users to the attack.</p>
<p>To advertise support for this method, clients use the name <code>m.sas.v1</code> in the
<code>methods</code> fields of the <code>m.key.verification.request</code> and
<code>m.key.verification.ready</code> events.</p>
<p>The verification process takes place in two phases:</p>
<ol>
<li>Key agreement phase (based on <a href="https://tools.ietf.org/html/rfc6189#section-4.4.1">ZRTP key
agreement</a>).</li>
<li>Key verification phase (based on HMAC).</li>
</ol>
<p>The process between Alice and Bob verifying each other would be:</p>
<ol>
<li>
<p>Alice and Bob establish a secure out-of-band connection, such as
meeting in-person or a video call. &ldquo;Secure&rdquo; here means that either
party cannot be impersonated, not explicit secrecy.</p>
</li>
<li>
<p>Alice and Bob begin a key verification using the key verification
framework as described above.</p>
</li>
<li>
<p>Alice&rsquo;s device sends Bob&rsquo;s device an <code>m.key.verification.start</code>
message. Alice&rsquo;s device ensures it has a copy of Bob&rsquo;s device key.</p>
</li>
<li>
<p>Bob&rsquo;s device receives the message and selects a key agreement
protocol, hash algorithm, message authentication code, and SAS
method supported by Alice&rsquo;s device.</p>
</li>
<li>
<p>Bob&rsquo;s device ensures it has a copy of Alice&rsquo;s device key.</p>
</li>
<li>
<p>Bob&rsquo;s device creates an ephemeral Curve25519 key pair
(<em>K<sub>B</sub><sup>private</sup></em>,<em>K<sub>B</sub><sup>public</sup></em>),
and calculates the hash (using the chosen algorithm) of the public
key <em>K<sub>B</sub><sup>public</sup></em>.</p>
</li>
<li>
<p>Bob&rsquo;s device replies to Alice&rsquo;s device with an
<code>m.key.verification.accept</code> message.</p>
</li>
<li>
<p>Alice&rsquo;s device receives Bob&rsquo;s message and stores the commitment hash
for later use.</p>
</li>
<li>
<p>Alice&rsquo;s device creates an ephemeral Curve25519 key pair
(<em>K<sub>A</sub><sup>private</sup></em>,<em>K<sub>A</sub><sup>public</sup></em>)
and replies to Bob&rsquo;s device with an <code>m.key.verification.key</code>,
sending only the public key
<em>K<sub>A</sub><sup>public</sup></em>.</p>
</li>
<li>
<p>Bob&rsquo;s device receives Alice&rsquo;s message and replies with its own
<code>m.key.verification.key</code> message containing its public key
<em>K<sub>B</sub><sup>public</sup></em>.</p>
</li>
<li>
<p>Alice&rsquo;s device receives Bob&rsquo;s message and verifies the commitment
hash from earlier matches the hash of the key Bob&rsquo;s device just sent
and the content of Alice&rsquo;s <code>m.key.verification.start</code> message.</p>
</li>
<li>
<p>Both Alice and Bob&rsquo;s devices perform an Elliptic-curve
Diffie-Hellman
(<em>ECDH(K<sub>A</sub><sup>private</sup></em>,<em>K<sub>B</sub><sup>public</sup></em>)),
using the result as the shared secret.</p>
</li>
<li>
<p>Both Alice and Bob&rsquo;s devices display a SAS to their users, which is
derived from the shared key using one of the methods in this
section. If multiple SAS methods are available, clients should allow
the users to select a method.</p>
</li>
<li>
<p>Alice and Bob compare the strings shown by their devices, and tell
their devices if they match or not.</p>
</li>
<li>
<p>Assuming they match, Alice and Bob&rsquo;s devices each calculate Message
Authentication Codes (MACs) for:</p>
<ul>
<li>Each of the keys that they wish the other user to verify (usually their
device ed25519 key and their master cross-signing key).</li>
<li>The complete list of key IDs that they wish the other user to verify.</li>
</ul>
<p>The MAC calculation is defined <a href="#mac-calculation">below</a>.</p>
</li>
<li>
<p>Alice&rsquo;s device sends Bob&rsquo;s device an <code>m.key.verification.mac</code>
message containing the MAC of Alice&rsquo;s device keys and the MAC of her
key IDs to be verified. Bob&rsquo;s device does the same for Bob&rsquo;s device
keys and key IDs concurrently with Alice.</p>
</li>
<li>
<p>When the other device receives the <code>m.key.verification.mac</code> message,
the device calculates the MACs of its copies of the other device&rsquo;s
keys given in the message, as well as the MAC of the
comma-separated, sorted, list of key IDs in the message. The device
compares these with the MAC values given in the message, and if
everything matches then the device keys are verified.</p>
</li>
<li>
<p>Alice and Bob&rsquo;s devices send <code>m.key.verification.done</code> messages to complete
the verification.</p>
</li>
</ol>
<p>The wire protocol looks like the following between Alice and Bob&rsquo;s
devices:</p>
<pre tabindex="0"><code>    +-------------+                    +-----------+
    | AliceDevice |                    | BobDevice |
    +-------------+                    +-----------+
          |                                 |
          | m.key.verification.start        |
          |--------------------------------&gt;|
          |                                 |
          |       m.key.verification.accept |
          |&lt;--------------------------------|
          |                                 |
          | m.key.verification.key          |
          |--------------------------------&gt;|
          |                                 |
          |          m.key.verification.key |
          |&lt;--------------------------------|
          |                                 |
          | m.key.verification.mac          |
          |--------------------------------&gt;|
          |                                 |
          |          m.key.verification.mac |
          |&lt;--------------------------------|
          |                                 |
</code></pre><h6 id="error-and-exception-handling">Error and exception handling</h6>
<p>At any point the interactive verification can go wrong. The following
describes what to do when an error happens:</p>
<ul>
<li>Alice or Bob can cancel the verification at any time. An
<code>m.key.verification.cancel</code> message must be sent to signify the
cancellation.</li>
<li>The verification can time out. Clients should time out a
verification that does not complete within 10 minutes. Additionally,
clients should expire a <code>transaction_id</code> which goes unused for 10
minutes after having last sent/received it. The client should inform
the user that the verification timed out, and send an appropriate
<code>m.key.verification.cancel</code> message to the other device.</li>
<li>When the same device attempts to initiate multiple verification
attempts, the recipient should cancel all attempts with that device.</li>
<li>When a device receives an unknown <code>transaction_id</code>, it should send
an appropriate <code>m.key.verification.cancel</code> message to the other
device indicating as such. This does not apply for inbound
<code>m.key.verification.start</code> or <code>m.key.verification.cancel</code> messages.</li>
<li>If the two devices do not share a common key share, hash, HMAC, or
SAS method then the device should notify the other device with an
appropriate <code>m.key.verification.cancel</code> message.</li>
<li>If the user claims the Short Authentication Strings do not match,
the device should send an appropriate <code>m.key.verification.cancel</code>
message to the other device.</li>
<li>If the device receives a message out of sequence or that it was not
expecting, it should notify the other device with an appropriate
<code>m.key.verification.cancel</code> message.</li>
</ul>
<h6 id="verification-messages-specific-to-sas">Verification messages specific to SAS</h6>
<p>Building off the common framework, the following events are involved in
SAS verification.</p>
<p>The <code>m.key.verification.cancel</code> event is unchanged, however the
following error codes are used in addition to those already specified:</p>
<ul>
<li><code>m.unknown_method</code>: The devices are unable to agree on the key
agreement, hash, MAC, or SAS method.</li>
<li><code>m.mismatched_commitment</code>: The hash commitment did not match.</li>
<li><code>m.mismatched_sas</code>: The SAS did not match.</li>
</ul>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mkeyverificationstartmsasv1">
   <code>m.key.verification.start</code> with <code>method: m.sas.v1</code>
  </h1>
</summary>
  <hr/>
<p>Begins a SAS key verification process using the <code>m.sas.v1</code> method.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>from_device</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The device ID which is initiating the process.</td>
 </tr>
 <tr>
  <td><code>hashes</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The hash methods the sending device understands. Must include at least
<code>sha256</code>.</td>
 </tr>
 <tr>
  <td><code>key_agreement_protocols</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The key agreement protocols the sending device understands. Should
include at least <code>curve25519-hkdf-sha256</code>.</td>
 </tr>
 <tr>
  <td><code>m.relates_to</code></td>
  <td><code>VerificationRelatesTo</code></td>
  <td>
    Required when sent as an in-room message. Indicates the
<code>m.key.verification.request</code> that this message is related to. Note that for
encrypted messages, this property should be in the unencrypted portion of the
event.</td>
 </tr>
 <tr>
  <td><code>message_authentication_codes</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The message authentication code methods that the sending device understands.
Must include at least <code>hkdf-hmac-sha256.v2</code>.  Should also include
<code>hkdf-hmac-sha256</code> for compatibility with older clients, though this
identifier is deprecated and will be removed in a future version of
the spec.</td>
 </tr>
 <tr>
  <td><code>method</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The verification method to use.<p>One of: <code>[m.sas.v1]</code>.</p></td>
 </tr>
 <tr>
  <td><code>short_authentication_string</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The SAS methods the sending device (and the sending device&rsquo;s user)
understands. Must include at least <code>decimal</code>. Optionally can include
<code>emoji</code>.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    Required when sent as a to-device message. An opaque identifier for
the verification process. Must be unique with respect to the devices
involved. Must be the same as the <code>transaction_id</code> given in the
<code>m.key.verification.request</code> if this process is originating from a
request.</td>
 </tr>
</table>
<table id="mkeyverificationstartmsasv1_verificationrelatesto" class="object-table">
 <caption>VerificationRelatesTo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    The event ID of the <code>m.key.verification.request</code> that this message is
related to.</td>
 </tr>
 <tr>
  <td><code>rel_type</code></td>
  <td><code>string</code></td>
  <td>
    The relationship type. Currently, this can only be an
<a href="/client-server-api/#reference-relations"><code>m.reference</code></a> relationship type.<p>One of: <code>[m.reference]</code>.</p></td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;from_device&#34;</span><span class="p">:</span> <span class="s2">&#34;BobDevice1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;hashes&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;sha256&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;key_agreement_protocols&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;curve25519&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;message_authentication_codes&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;hkdf-hmac-sha256.v2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;hkdf-hmac-sha256&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;method&#34;</span><span class="p">:</span> <span class="s2">&#34;m.sas.v1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;short_authentication_string&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;decimal&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;emoji&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;transaction_id&#34;</span><span class="p">:</span> <span class="s2">&#34;S0meUniqueAndOpaqueString&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.key.verification.start&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mkeyverificationaccept">
   <code>m.key.verification.accept</code>
  </h1>
</summary>
  <hr/>
<p>Accepts a previously sent <code>m.key.verification.start</code> message.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>commitment</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The hash (encoded as unpadded base64) of the concatenation of the device&rsquo;s
ephemeral public key (encoded as unpadded base64) and the canonical JSON
representation of the <code>m.key.verification.start</code> message.</td>
 </tr>
 <tr>
  <td><code>hash</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The hash method the device is choosing to use, out of the options in
the <code>m.key.verification.start</code> message.</td>
 </tr>
 <tr>
  <td><code>key_agreement_protocol</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The key agreement protocol the device is choosing to use, out of the
options in the <code>m.key.verification.start</code> message.</td>
 </tr>
 <tr>
  <td><code>m.relates_to</code></td>
  <td><code>VerificationRelatesTo</code></td>
  <td>
    Required when sent as an in-room message. Indicates the
<code>m.key.verification.request</code> that this message is related to. Note that for
encrypted messages, this property should be in the unencrypted portion of the
event.</td>
 </tr>
 <tr>
  <td><code>message_authentication_code</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The message authentication code method the device is choosing to use, out of
the options in the <code>m.key.verification.start</code> message.</td>
 </tr>
 <tr>
  <td><code>short_authentication_string</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The SAS methods both devices involved in the verification process
understand. Must be a subset of the options in the <code>m.key.verification.start</code>
message.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    Required when sent as a to-device message. An opaque identifier for
the verification process. Must be the same as the one used for the
<code>m.key.verification.start</code> message.</td>
 </tr>
</table>
<table id="mkeyverificationaccept_verificationrelatesto" class="object-table">
 <caption>VerificationRelatesTo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    The event ID of the <code>m.key.verification.request</code> that this message is
related to.</td>
 </tr>
 <tr>
  <td><code>rel_type</code></td>
  <td><code>string</code></td>
  <td>
    The relationship type. Currently, this can only be an
<a href="/client-server-api/#reference-relations"><code>m.reference</code></a> relationship type.<p>One of: <code>[m.reference]</code>.</p></td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;commitment&#34;</span><span class="p">:</span> <span class="s2">&#34;fQpGIW1Snz+pwLZu6sTy2aHy/DYWWTspTJRPyNp0PKkymfIsNffysMl6ObMMFdIJhk6g6pwlIqZ54rxo8SLmAg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;hash&#34;</span><span class="p">:</span> <span class="s2">&#34;sha256&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;key_agreement_protocol&#34;</span><span class="p">:</span> <span class="s2">&#34;curve25519&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;message_authentication_code&#34;</span><span class="p">:</span> <span class="s2">&#34;hkdf-hmac-sha256.v2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;method&#34;</span><span class="p">:</span> <span class="s2">&#34;m.sas.v1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;short_authentication_string&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;decimal&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;emoji&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;transaction_id&#34;</span><span class="p">:</span> <span class="s2">&#34;S0meUniqueAndOpaqueString&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.key.verification.accept&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mkeyverificationkey">
   <code>m.key.verification.key</code>
  </h1>
</summary>
  <hr/>
<p>Sends the ephemeral public key for a device to the partner device.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The device&rsquo;s ephemeral public key, encoded as unpadded base64.</td>
 </tr>
 <tr>
  <td><code>m.relates_to</code></td>
  <td><code>VerificationRelatesTo</code></td>
  <td>
    Required when sent as an in-room message. Indicates the
<code>m.key.verification.request</code> that this message is related to. Note that for
encrypted messages, this property should be in the unencrypted portion of the
event.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    Required when sent as a to-device message. An opaque identifier for
the verification process. Must be the same as the one used for the
<code>m.key.verification.start</code> message.</td>
 </tr>
</table>
<table id="mkeyverificationkey_verificationrelatesto" class="object-table">
 <caption>VerificationRelatesTo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    The event ID of the <code>m.key.verification.request</code> that this message is
related to.</td>
 </tr>
 <tr>
  <td><code>rel_type</code></td>
  <td><code>string</code></td>
  <td>
    The relationship type. Currently, this can only be an
<a href="/client-server-api/#reference-relations"><code>m.reference</code></a> relationship type.<p>One of: <code>[m.reference]</code>.</p></td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;fQpGIW1Snz+pwLZu6sTy2aHy/DYWWTspTJRPyNp0PKkymfIsNffysMl6ObMMFdIJhk6g6pwlIqZ54rxo8SLmAg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;transaction_id&#34;</span><span class="p">:</span> <span class="s2">&#34;S0meUniqueAndOpaqueString&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.key.verification.key&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mkeyverificationmac">
   <code>m.key.verification.mac</code>
  </h1>
</summary>
  <hr/>
<p>Sends the MAC of a devices key to the partner device.  The MAC is calculated
using the method given in <code>message_authentication_code</code> property of the
<code>m.key.verification.accept</code> message.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>keys</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The MAC of the comma-separated, sorted, list of key IDs given in the <code>mac</code>
property, encoded as unpadded base64.</td>
 </tr>
 <tr>
  <td><code>m.relates_to</code></td>
  <td><code>VerificationRelatesTo</code></td>
  <td>
    Required when sent as an in-room message. Indicates the
<code>m.key.verification.request</code> that this message is related to. Note that for
encrypted messages, this property should be in the unencrypted portion of the
event.</td>
 </tr>
 <tr>
  <td><code>mac</code></td>
  <td><code>{string: string}</code></td>
  <td>
    <strong>Required: </strong>A map of the key ID to the MAC of the key, using the algorithm in the
verification process. The MAC is encoded as unpadded base64.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    Required when sent as a to-device message. An opaque identifier for
the verification process. Must be the same as the one used for the
<code>m.key.verification.start</code> message.</td>
 </tr>
</table>
<table id="mkeyverificationmac_verificationrelatesto" class="object-table">
 <caption>VerificationRelatesTo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    The event ID of the <code>m.key.verification.request</code> that this message is
related to.</td>
 </tr>
 <tr>
  <td><code>rel_type</code></td>
  <td><code>string</code></td>
  <td>
    The relationship type. Currently, this can only be an
<a href="/client-server-api/#reference-relations"><code>m.reference</code></a> relationship type.<p>One of: <code>[m.reference]</code>.</p></td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="s2">&#34;2Wptgo4CwmLo/Y8B8qinxApKaCkBG2fjTWB7AbP5Uy+aIbygsSdLOFzvdDjww8zUVKCmI02eP9xtyJxc/cLiBA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;mac&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;ed25519:ABCDEF&#34;</span><span class="p">:</span> <span class="s2">&#34;fQpGIW1Snz+pwLZu6sTy2aHy/DYWWTspTJRPyNp0PKkymfIsNffysMl6ObMMFdIJhk6g6pwlIqZ54rxo8SLmAg&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;transaction_id&#34;</span><span class="p">:</span> <span class="s2">&#34;S0meUniqueAndOpaqueString&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.key.verification.mac&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h6 id="mac-calculation">MAC calculation</h6>
<p>During the verification process, Message Authentication Codes (MACs) are calculated
for keys and lists of key IDs.</p>
<p>The method used to calculate these MACs depends upon the value of the
<code>message_authentication_code</code> property in the <a href="#mkeyverificationaccept"><code>m.key.verification.accept</code></a>
message. All current implementations should use the <code>hkdf-hmac-sha256.v2</code> method which is
defined as follows:</p>
<ol>
<li>
<p>An HMAC key is generated using HKDF, as defined in <a href="https://tools.ietf.org/html/rfc5869">RFC
5869</a>, using SHA-256 as the hash
function. The shared secret is supplied as the input keying material. No salt
is used, and in the info parameter is the concatenation of:</p>
<ul>
<li>The string <code>MATRIX_KEY_VERIFICATION_MAC</code>.</li>
<li>The Matrix ID of the user whose key is being MAC-ed.</li>
<li>The Device ID of the device sending the MAC.</li>
<li>The Matrix ID of the other user.</li>
<li>The Device ID of the device receiving the MAC.</li>
<li>The <code>transaction_id</code> being used.</li>
<li>The Key ID of the key being MAC-ed, or the string <code>KEY_IDS</code> if the
item being MAC-ed is the list of key IDs.</li>
</ul>
</li>
<li>
<p>A MAC is then generated using HMAC as defined in <a href="https://tools.ietf.org/html/rfc2104">RFC
2104</a> with the key generated above and
using SHA-256 as the hash function.</p>
<p>If a key is being MACed, the MAC is performed on the public key as encoded
according to the <a href="#key-algorithms">key algorithm</a>.  For example, for <code>ed25519</code>
keys, it is the unpadded base64-encoded key.</p>
<p>If the key list is being MACed, the list is sorted lexicographically and
comma-separated with no extra whitespace added, with each key written in the
form <code>{algorithm}:{keyId}</code>. For example, the key list could look like:
<code>ed25519:Cross+Signing+Key,ed25519:DEVICEID</code>. In this way, the recipient can
reconstruct the list from the names in the <code>mac</code> property of the
<code>m.key.verification.mac</code> message and ensure that no keys were added or removed.</p>
</li>
<li>
<p>The MAC values are base64-encoded and sent in a
<a href="#mkeyverificationmac"><code>m.key.verification.mac</code></a> message.</p>
</li>
</ol>
<div class="alert note " role="alert">
The MAC method <code>hkdf-hmac-sha256</code> used an incorrect base64 encoding, due to a
bug in the original implementation in libolm.  To remedy this,
<code>hkdf-hmac-sha256.v2</code> was introduced, which calculates the MAC in the same way,
but uses a correct base64 encoding. <code>hkdf-hmac-sha256</code> is deprecated and will
be removed in a future version of the spec. Use of <code>hkdf-hmac-sha256</code> should
be avoided whenever possible: if both parties support <code>hkdf-hmac-sha256.v2</code>,
then <code>hkdf-hmac-sha256</code> MUST not be used.
</div>
<h6 id="sas-hkdf-calculation">SAS HKDF calculation</h6>
<p>In all of the SAS methods, HKDF is as defined in <a href="https://tools.ietf.org/html/rfc5869">RFC
5869</a> and uses the previously
agreed-upon hash function for the hash function. The shared secret is
supplied as the input keying material. No salt is used. When the
<code>key_agreement_protocol</code> is <code>curve25519-hkdf-sha256</code>, the info parameter
is the concatenation of:</p>
<ul>
<li>The string <code>MATRIX_KEY_VERIFICATION_SAS|</code>.</li>
<li>The Matrix ID of the user who sent the <code>m.key.verification.start</code>
message, followed by <code>|</code>.</li>
<li>The Device ID of the device which sent the
<code>m.key.verification.start</code> message, followed by <code>|</code>.</li>
<li>The public key from the <code>m.key.verification.key</code> message sent by
the device which sent the <code>m.key.verification.start</code> message,
followed by <code>|</code>.</li>
<li>The Matrix ID of the user who sent the <code>m.key.verification.accept</code>
message, followed by <code>|</code>.</li>
<li>The Device ID of the device which sent the
<code>m.key.verification.accept</code> message, followed by <code>|</code>.</li>
<li>The public key from the <code>m.key.verification.key</code> message sent by
the device which sent the <code>m.key.verification.accept</code> message,
followed by <code>|</code>.</li>
<li>The <code>transaction_id</code> being used.</li>
</ul>
<p>When the <code>key_agreement_protocol</code> is the deprecated method <code>curve25519</code>,
the info parameter is the concatenation of:</p>
<ul>
<li>The string <code>MATRIX_KEY_VERIFICATION_SAS</code>.</li>
<li>The Matrix ID of the user who sent the <code>m.key.verification.start</code>
message.</li>
<li>The Device ID of the device which sent the
<code>m.key.verification.start</code> message.</li>
<li>The Matrix ID of the user who sent the <code>m.key.verification.accept</code>
message.</li>
<li>The Device ID of the device which sent the
<code>m.key.verification.accept</code> message.</li>
<li>The <code>transaction_id</code> being used.</li>
</ul>
<p>New implementations are discouraged from implementing the <code>curve25519</code>
method.</p>
<div class="alert rationale " role="alert">
HKDF is used over the plain shared secret as it results in a harder
attack as well as more uniform data to work with.
</div>
<h6 id="sas-method-decimal">SAS method: <code>decimal</code></h6>
<p>Generate 5 bytes using <a href="#sas-hkdf-calculation">HKDF</a> then take sequences of 13 bits
to convert to decimal numbers (resulting in 3 numbers between 0 and 8191
inclusive each). Add 1000 to each calculated number.</p>
<p>The bitwise operations to get the numbers given the 5 bytes
<em>B<sub>0</sub></em>,<em>B<sub>1</sub></em>,<em>B<sub>2</sub></em>,<em>B<sub>3</sub></em>,<em>B<sub>4</sub></em>
would be:</p>
<ul>
<li>First: (<em>B<sub>0</sub></em>5|<em>B<sub>1</sub></em>3)+1000</li>
<li>Second:
((<em>B<sub>1</sub></em>&amp;0x7)10|<em>B<sub>2</sub></em>2|<em>B<sub>3</sub></em>6)+1000</li>
<li>Third: ((<em>B<sub>3</sub></em>&amp;0x3F)7|<em>B<sub>4</sub></em>1)+1000</li>
</ul>
<p>The digits are displayed to the user either with an appropriate
separator, such as dashes, or with the numbers on individual lines.</p>
<h6 id="sas-method-emoji">SAS method: <code>emoji</code></h6>
<p>Generate 6 bytes using <a href="#sas-hkdf-calculation">HKDF</a> then split the first 42 bits
into 7 groups of 6 bits, similar to how one would base64 encode
something. Convert each group of 6 bits to a number and use the
following table to get the corresponding emoji:</p>
<table>
  <tr>
    <th>Number</th>
    <th>Emoji</th>
    <th>Unicode</th>
    <th>Description</th>
  </tr>
  <tr>
    <td>0</td>
    <td></td>
    <td>U&#43;1F436</td>
    <td>Dog</td>
  </tr>
  <tr>
    <td>1</td>
    <td></td>
    <td>U&#43;1F431</td>
    <td>Cat</td>
  </tr>
  <tr>
    <td>2</td>
    <td></td>
    <td>U&#43;1F981</td>
    <td>Lion</td>
  </tr>
  <tr>
    <td>3</td>
    <td></td>
    <td>U&#43;1F40E</td>
    <td>Horse</td>
  </tr>
  <tr>
    <td>4</td>
    <td></td>
    <td>U&#43;1F984</td>
    <td>Unicorn</td>
  </tr>
  <tr>
    <td>5</td>
    <td></td>
    <td>U&#43;1F437</td>
    <td>Pig</td>
  </tr>
  <tr>
    <td>6</td>
    <td></td>
    <td>U&#43;1F418</td>
    <td>Elephant</td>
  </tr>
  <tr>
    <td>7</td>
    <td></td>
    <td>U&#43;1F430</td>
    <td>Rabbit</td>
  </tr>
  <tr>
    <td>8</td>
    <td></td>
    <td>U&#43;1F43C</td>
    <td>Panda</td>
  </tr>
  <tr>
    <td>9</td>
    <td></td>
    <td>U&#43;1F413</td>
    <td>Rooster</td>
  </tr>
  <tr>
    <td>10</td>
    <td></td>
    <td>U&#43;1F427</td>
    <td>Penguin</td>
  </tr>
  <tr>
    <td>11</td>
    <td></td>
    <td>U&#43;1F422</td>
    <td>Turtle</td>
  </tr>
  <tr>
    <td>12</td>
    <td></td>
    <td>U&#43;1F41F</td>
    <td>Fish</td>
  </tr>
  <tr>
    <td>13</td>
    <td></td>
    <td>U&#43;1F419</td>
    <td>Octopus</td>
  </tr>
  <tr>
    <td>14</td>
    <td></td>
    <td>U&#43;1F98B</td>
    <td>Butterfly</td>
  </tr>
  <tr>
    <td>15</td>
    <td></td>
    <td>U&#43;1F337</td>
    <td>Flower</td>
  </tr>
  <tr>
    <td>16</td>
    <td></td>
    <td>U&#43;1F333</td>
    <td>Tree</td>
  </tr>
  <tr>
    <td>17</td>
    <td></td>
    <td>U&#43;1F335</td>
    <td>Cactus</td>
  </tr>
  <tr>
    <td>18</td>
    <td></td>
    <td>U&#43;1F344</td>
    <td>Mushroom</td>
  </tr>
  <tr>
    <td>19</td>
    <td></td>
    <td>U&#43;1F30F</td>
    <td>Globe</td>
  </tr>
  <tr>
    <td>20</td>
    <td></td>
    <td>U&#43;1F319</td>
    <td>Moon</td>
  </tr>
  <tr>
    <td>21</td>
    <td></td>
    <td>U&#43;2601U&#43;FE0F</td>
    <td>Cloud</td>
  </tr>
  <tr>
    <td>22</td>
    <td></td>
    <td>U&#43;1F525</td>
    <td>Fire</td>
  </tr>
  <tr>
    <td>23</td>
    <td></td>
    <td>U&#43;1F34C</td>
    <td>Banana</td>
  </tr>
  <tr>
    <td>24</td>
    <td></td>
    <td>U&#43;1F34E</td>
    <td>Apple</td>
  </tr>
  <tr>
    <td>25</td>
    <td></td>
    <td>U&#43;1F353</td>
    <td>Strawberry</td>
  </tr>
  <tr>
    <td>26</td>
    <td></td>
    <td>U&#43;1F33D</td>
    <td>Corn</td>
  </tr>
  <tr>
    <td>27</td>
    <td></td>
    <td>U&#43;1F355</td>
    <td>Pizza</td>
  </tr>
  <tr>
    <td>28</td>
    <td></td>
    <td>U&#43;1F382</td>
    <td>Cake</td>
  </tr>
  <tr>
    <td>29</td>
    <td></td>
    <td>U&#43;2764U&#43;FE0F</td>
    <td>Heart</td>
  </tr>
  <tr>
    <td>30</td>
    <td></td>
    <td>U&#43;1F600</td>
    <td>Smiley</td>
  </tr>
  <tr>
    <td>31</td>
    <td></td>
    <td>U&#43;1F916</td>
    <td>Robot</td>
  </tr>
  <tr>
    <td>32</td>
    <td></td>
    <td>U&#43;1F3A9</td>
    <td>Hat</td>
  </tr>
  <tr>
    <td>33</td>
    <td></td>
    <td>U&#43;1F453</td>
    <td>Glasses</td>
  </tr>
  <tr>
    <td>34</td>
    <td></td>
    <td>U&#43;1F527</td>
    <td>Spanner</td>
  </tr>
  <tr>
    <td>35</td>
    <td></td>
    <td>U&#43;1F385</td>
    <td>Santa</td>
  </tr>
  <tr>
    <td>36</td>
    <td></td>
    <td>U&#43;1F44D</td>
    <td>Thumbs Up</td>
  </tr>
  <tr>
    <td>37</td>
    <td></td>
    <td>U&#43;2602U&#43;FE0F</td>
    <td>Umbrella</td>
  </tr>
  <tr>
    <td>38</td>
    <td></td>
    <td>U&#43;231B</td>
    <td>Hourglass</td>
  </tr>
  <tr>
    <td>39</td>
    <td></td>
    <td>U&#43;23F0</td>
    <td>Clock</td>
  </tr>
  <tr>
    <td>40</td>
    <td></td>
    <td>U&#43;1F381</td>
    <td>Gift</td>
  </tr>
  <tr>
    <td>41</td>
    <td></td>
    <td>U&#43;1F4A1</td>
    <td>Light Bulb</td>
  </tr>
  <tr>
    <td>42</td>
    <td></td>
    <td>U&#43;1F4D5</td>
    <td>Book</td>
  </tr>
  <tr>
    <td>43</td>
    <td></td>
    <td>U&#43;270FU&#43;FE0F</td>
    <td>Pencil</td>
  </tr>
  <tr>
    <td>44</td>
    <td></td>
    <td>U&#43;1F4CE</td>
    <td>Paperclip</td>
  </tr>
  <tr>
    <td>45</td>
    <td></td>
    <td>U&#43;2702U&#43;FE0F</td>
    <td>Scissors</td>
  </tr>
  <tr>
    <td>46</td>
    <td></td>
    <td>U&#43;1F512</td>
    <td>Lock</td>
  </tr>
  <tr>
    <td>47</td>
    <td></td>
    <td>U&#43;1F511</td>
    <td>Key</td>
  </tr>
  <tr>
    <td>48</td>
    <td></td>
    <td>U&#43;1F528</td>
    <td>Hammer</td>
  </tr>
  <tr>
    <td>49</td>
    <td></td>
    <td>U&#43;260EU&#43;FE0F</td>
    <td>Telephone</td>
  </tr>
  <tr>
    <td>50</td>
    <td></td>
    <td>U&#43;1F3C1</td>
    <td>Flag</td>
  </tr>
  <tr>
    <td>51</td>
    <td></td>
    <td>U&#43;1F682</td>
    <td>Train</td>
  </tr>
  <tr>
    <td>52</td>
    <td></td>
    <td>U&#43;1F6B2</td>
    <td>Bicycle</td>
  </tr>
  <tr>
    <td>53</td>
    <td></td>
    <td>U&#43;2708U&#43;FE0F</td>
    <td>Aeroplane</td>
  </tr>
  <tr>
    <td>54</td>
    <td></td>
    <td>U&#43;1F680</td>
    <td>Rocket</td>
  </tr>
  <tr>
    <td>55</td>
    <td></td>
    <td>U&#43;1F3C6</td>
    <td>Trophy</td>
  </tr>
  <tr>
    <td>56</td>
    <td></td>
    <td>U&#43;26BD</td>
    <td>Ball</td>
  </tr>
  <tr>
    <td>57</td>
    <td></td>
    <td>U&#43;1F3B8</td>
    <td>Guitar</td>
  </tr>
  <tr>
    <td>58</td>
    <td></td>
    <td>U&#43;1F3BA</td>
    <td>Trumpet</td>
  </tr>
  <tr>
    <td>59</td>
    <td></td>
    <td>U&#43;1F514</td>
    <td>Bell</td>
  </tr>
  <tr>
    <td>60</td>
    <td></td>
    <td>U&#43;2693</td>
    <td>Anchor</td>
  </tr>
  <tr>
    <td>61</td>
    <td></td>
    <td>U&#43;1F3A7</td>
    <td>Headphones</td>
  </tr>
  <tr>
    <td>62</td>
    <td></td>
    <td>U&#43;1F4C1</td>
    <td>Folder</td>
  </tr>
  <tr>
    <td>63</td>
    <td></td>
    <td>U&#43;1F4CC</td>
    <td>Pin</td>
  </tr>
</table>
<div class="alert note " role="alert">
This table is available as JSON at
<a href="https://github.com/matrix-org/matrix-spec/blob/main/data-definitions/sas-emoji.json">https://github.com/matrix-org/matrix-spec/blob/main/data-definitions/sas-emoji.json</a>.
</div>
<div class="alert rationale " role="alert">
<p>The emoji above were chosen to:</p>
<ul>
<li>Be recognisable without colour.</li>
<li>Be recognisable at a small size.</li>
<li>Be recognisable by most cultures.</li>
<li>Be distinguishable from each other.</li>
<li>Easily described by a few words.</li>
<li>Avoid symbols with negative connotations.</li>
<li>Be likely similar across multiple platforms.</li>
</ul>
</div>
<p>Clients SHOULD show the emoji with the descriptions from the table, or
appropriate translation of those descriptions. Client authors SHOULD
collaborate to create a common set of translations for all languages.</p>
<div class="alert note " role="alert">
Known translations for the emoji are available from
<a href="https://github.com/matrix-org/matrix-doc/blob/master/data-definitions/">https://github.com/matrix-org/matrix-doc/blob/master/data-definitions/</a>
and can be translated online:
<a href="https://translate.riot.im/projects/matrix-doc/sas-emoji-v1">https://translate.riot.im/projects/matrix-doc/sas-emoji-v1</a>
</div>
<h5 id="cross-signing">Cross-signing</h5>
<p>Rather than requiring Alice to verify each of Bob&rsquo;s devices with each of
her own devices and vice versa, the cross-signing feature allows users
to sign their device keys such that Alice and Bob only need to verify
once. With cross-signing, each user has a set of cross-signing keys that
are used to sign their own device keys and other users&rsquo; keys, and can be
used to trust device keys that were not verified directly.</p>
<p>Each user has three ed25519 key pairs for cross-signing:</p>
<ul>
<li>a master key (MSK) that serves as the user&rsquo;s identity in
cross-signing and signs their other cross-signing keys;</li>
<li>a user-signing key (USK) &ndash; only visible to the user that it belongs
to &ndash;that signs other users&rsquo; master keys; and</li>
<li>a self-signing key (SSK) that signs the user&rsquo;s own device keys.</li>
</ul>
<p>The master key may also be used to sign other items such as the backup
key. The master key may also be signed by the user&rsquo;s own device keys to
aid in migrating from device verifications: if Alice&rsquo;s device had
previously verified Bob&rsquo;s device and Bob&rsquo;s device has signed his master
key, then Alice&rsquo;s device can trust Bob&rsquo;s master key, and she can sign it
with her user-signing key.</p>
<p>Users upload their cross-signing keys to the server using <a href="/client-server-api/#post_matrixclientv3keysdevice_signingupload">POST
/_matrix/client/v3/keys/device_signing/upload</a>. When Alice uploads
new cross-signing keys, her user ID will appear in the <code>changed</code>
property of the <code>device_lists</code> field of the <code>/sync</code> of response of all
users who share an encrypted room with her. When Bob sees Alice&rsquo;s user
ID in his <code>/sync</code>, he will call <a href="/client-server-api/#post_matrixclientv3keysquery">POST /_matrix/client/v3/keys/query</a>
to retrieve Alice&rsquo;s device and cross-signing keys.</p>
<p>If Alice has a device and wishes to send an encrypted message to Bob,
she can trust Bob&rsquo;s device if:</p>
<ul>
<li>Alice&rsquo;s device is using a master key that has signed her
user-signing key,</li>
<li>Alice&rsquo;s user-signing key has signed Bob&rsquo;s master key,</li>
<li>Bob&rsquo;s master key has signed Bob&rsquo;s self-signing key, and</li>
<li>Bob&rsquo;s self-signing key has signed Bob&rsquo;s device key.</li>
</ul>
<p>The following diagram illustrates how keys are signed:</p>
<pre tabindex="0"><code>    +------------------+                ..................   +----------------+
    | +--------------+ |   ..................            :   | +------------+ |
    | |              v v   v            :   :            v   v v            | |
    | |           +-----------+         :   :         +-----------+         | |
    | |           | Alice MSK |         :   :         |  Bob MSK  |         | |
    | |           +-----------+         :   :         +-----------+         | |
    | |             |       :           :   :           :       |           | |
    | |          +--+       :...        :   :        ...:       +--+        | |
    | |          v             v        :   :        v             v        | |
    | |    +-----------+ .............  :   :  ............. +-----------+  | |
    | |    | Alice SSK | : Alice USK :  :   :  :  Bob USK  : |  Bob SSK  |  | |
    | |    +-----------+ :...........:  :   :  :...........: +-----------+  | |
    | |      |  ...  |         :        :   :        :         |  ...  |    | |
    | |      V       V         :........:   :........:         V       V    | |
    | | +---------+   -+                                  +---------+   -+  | |
    | | | Devices | ...|                                  | Devices | ...|  | |
    | | +---------+   -+                                  +---------+   -+  | |
    | |      |  ...  |                                         |  ...  |    | |
    | +------+       |                                         |       +----+ |
    +----------------+                                         +--------------+
</code></pre><p>In the diagram, boxes represent keys and lines represent signatures with
the arrows pointing from the signing key to the key being signed. Dotted
boxes and lines represent keys and signatures that are only visible to
the user who created them.</p>
<p>The following diagram illustrates Alice&rsquo;s view, hiding the keys and
signatures that she cannot see:</p>
<pre tabindex="0"><code>    +------------------+                +----------------+   +----------------+
    | +--------------+ |                |                |   | +------------+ |
    | |              v v                |                v   v v            | |
    | |           +-----------+         |             +-----------+         | |
    | |           | Alice MSK |         |             |  Bob MSK  |         | |
    | |           +-----------+         |             +-----------+         | |
    | |             |       |           |                       |           | |
    | |          +--+       +--+        |                       +--+        | |
    | |          v             v        |                          v        | |
    | |    +-----------+ +-----------+  |                    +-----------+  | |
    | |    | Alice SSK | | Alice USK |  |                    |  Bob SSK  |  | |
    | |    +-----------+ +-----------+  |                    +-----------+  | |
    | |      |  ...  |         |        |                      |  ...  |    | |
    | |      V       V         +--------+                      V       V    | |
    | | +---------+   -+                                  +---------+   -+  | |
    | | | Devices | ...|                                  | Devices | ...|  | |
    | | +---------+   -+                                  +---------+   -+  | |
    | |      |  ...  |                                         |  ...  |    | |
    | +------+       |                                         |       +----+ |
    +----------------+                                         +--------------+
</code></pre><p><a href="#device-verification">Verification methods</a> can be used to verify a
user&rsquo;s master key by using the master public key, encoded using unpadded
base64, as the device ID, and treating it as a normal device. For
example, if Alice and Bob verify each other using SAS, Alice&rsquo;s
<code>m.key.verification.mac</code> message to Bob may include
<code>&quot;ed25519:alices+master+public+key&quot;: &quot;alices+master+public+key&quot;</code> in the
<code>mac</code> property. Servers therefore must ensure that device IDs will not
collide with cross-signing public keys.</p>
<p>The cross-signing private keys can be stored on the server or shared with other
devices using the <a href="#secrets">Secrets</a> module.  When doing so, the master,
user-signing, and self-signing keys are identified using the names
<code>m.cross_signing.master</code>, <code>m.cross_signing.user_signing</code>, and
<code>m.cross_signing.self_signing</code>, respectively, and the keys are base64-encoded
before being encrypted.</p>
<h6 id="key-and-signature-security">Key and signature security</h6>
<p>A user&rsquo;s master key could allow an attacker to impersonate that user to
other users, or other users to that user. Thus clients must ensure that
the private part of the master key is treated securely. If clients do
not have a secure means of storing the master key (such as a secret
storage system provided by the operating system), then clients must not
store the private part.</p>
<p>If a user&rsquo;s client sees that any other user has changed their master
key, that client must notify the user about the change before allowing
communication between the users to continue.</p>
<p>Since device key IDs (<code>ed25519:DEVICE_ID</code>) and cross-signing key IDs
(<code>ed25519:PUBLIC_KEY</code>) occupy the same namespace, clients must ensure that they
use the correct keys when verifying.</p>
<p>While servers MUST not allow devices to have the same IDs as cross-signing
keys, a malicious server could construct such a situation, so clients must not
rely on the server being well-behaved and should take the following precautions
against this.</p>
<ol>
<li>Clients MUST refer to keys by their public keys during the verification
process, rather than only by the key ID.</li>
<li>Clients MUST fix the keys that are being verified at the beginning of the
verification process, and ensure that they do not change in the course of
verification.</li>
<li>Clients SHOULD also display a warning and MUST refuse to verify a user when
they detect that the user has a device with the same ID as a cross-signing key.</li>
</ol>
<p>A user&rsquo;s user-signing and self-signing keys are intended to be easily
replaceable if they are compromised by re-issuing a new key signed by
the user&rsquo;s master key and possibly by re-verifying devices or users.
However, doing so relies on the user being able to notice when their
keys have been compromised, and it involves extra work for the user, and
so although clients do not have to treat the private parts as
sensitively as the master key, clients should still make efforts to
store the private part securely, or not store it at all. Clients will
need to balance the security of the keys with the usability of signing
users and devices when performing key verification.</p>
<p>To avoid leaking of social graphs, servers will only allow users to see:</p>
<ul>
<li>signatures made by the user&rsquo;s own master, self-signing or
user-signing keys,</li>
<li>signatures made by the user&rsquo;s own devices about their own master
key,</li>
<li>signatures made by other users&rsquo; self-signing keys about their
respective devices,</li>
<li>signatures made by other users&rsquo; master keys about their respective
self-signing key, or</li>
<li>signatures made by other users&rsquo; devices about their respective
master keys.</li>
</ul>
<p>Users will not be able to see signatures made by other users&rsquo;
user-signing keys.</p>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3keysdevice_signingupload">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/keys/device_signing/upload</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.1</code></strong></p>
<p><p>Publishes cross-signing keys for the user.</p>
<p>This API endpoint uses the <a href="/client-server-api/#user-interactive-authentication-api">User-Interactive Authentication API</a>.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>auth</code></td>
  <td><code>Authentication Data</code></td>
  <td>
    Additional authentication information for the
user-interactive authentication API.</td>
 </tr>
 <tr>
  <td><code>master_key</code></td>
  <td><code>CrossSigningKey</code></td>
  <td>
    Optional. The user's master key.</td>
 </tr>
 <tr>
  <td><code>self_signing_key</code></td>
  <td><code>CrossSigningKey</code></td>
  <td>
    Optional. The user's self-signing key. Must be signed by
the accompanying master key, or by the user's most recently
uploaded master key if no master key is included in the
request.</td>
 </tr>
 <tr>
  <td><code>user_signing_key</code></td>
  <td><code>CrossSigningKey</code></td>
  <td>
    Optional. The user's user-signing key. Must be signed by
the accompanying master key, or by the user's most recently
uploaded master key if no master key is included in the
request.</td>
 </tr>
</table>
<table id="_matrixclientv3keysdevice_signingupload_authentication-data" class="object-table">
 <caption>Authentication Data</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>session</code></td>
  <td><code>string</code></td>
  <td>
    The value of the session key given by the homeserver.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    The authentication type that the client is attempting to complete.
May be omitted if <code>session</code> is given, and the client is reissuing a
request which it believes has been completed out-of-band (for example,
via the <a href="#fallback">fallback mechanism</a>).</td>
 </tr>
</table>
<table id="_matrixclientv3keysdevice_signingupload_crosssigningkey" class="object-table">
 <caption>CrossSigningKey</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>keys</code></td>
  <td><code>{string: string}</code></td>
  <td>
    <strong>Required: </strong>The public key.  The object must have exactly one property, whose name is
in the form <code>&lt;algorithm&gt;:&lt;unpadded_base64_public_key&gt;</code>, and whose value
is the unpadded base64 public key.</td>
 </tr>
 <tr>
  <td><code>signatures</code></td>
  <td><code>Signatures</code></td>
  <td>
    Signatures of the key, calculated using the process described at <a href="/appendices/#signing-json">Signing JSON</a>.
Optional for the master key. Other keys must be signed by the
user's master key.</td>
 </tr>
 <tr>
  <td><code>usage</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>What the key is used for.</td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the user the key belongs to.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;auth&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;example_credential&#34;</span><span class="p">:</span> <span class="s2">&#34;verypoorsharedsecret&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;session&#34;</span><span class="p">:</span> <span class="s2">&#34;xxxxx&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;example.type.foo&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;master_key&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;ed25519:base64+master+public+key&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+master+public+key&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;usage&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;master&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;self_signing_key&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;ed25519:base64+self+signing+public+key&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+self+signing+master+public+key&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:base64+master+public+key&#34;</span><span class="p">:</span> <span class="s2">&#34;signature+of+self+signing+key&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;usage&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;self_signing&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;user_signing_key&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;ed25519:base64+user+signing+public+key&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+user+signing+master+public+key&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:base64+master+public+key&#34;</span><span class="p">:</span> <span class="s2">&#34;signature+of+user+signing+key&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;usage&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;user_signing&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The provided keys were successfully uploaded.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td><p>The input was invalid in some way. This can include one of the
following error codes:</p>
<ul>
<li><code>M_INVALID_SIGNATURE</code>: For example, the self-signing or
user-signing key had an incorrect signature.</li>
<li><code>M_MISSING_PARAM</code>: No master key is available.</li>
</ul>
</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The public key of one of the keys is the same as one of the user's
device IDs, or the request is not authorized for any other reason.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>400 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_INVALID_SIGNATURE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Invalid signature&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Key ID in use&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3keyssignaturesupload">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/keys/signatures/upload</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.1</code></strong></p>
<p><p>Publishes cross-signing signatures for the user.</p>
<p>The signed JSON object must match the key previously uploaded or
retrieved for the given key ID, with the exception of the <code>signatures</code>
property, which contains the new signature(s) to add.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>{string: {string: object}}</code></td>
  <td>
    A map of user ID to a map of key ID to signed JSON object.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;HIJKLMN&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;algorithms&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;m.olm.v1.curve25519-aes-sha256&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;m.megolm.v1.aes-sha&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;device_id&#34;</span><span class="p">:</span> <span class="s2">&#34;HIJKLMN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;curve25519:HIJKLMN&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+curve25519+key&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:HIJKLMN&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+ed25519+key&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ed25519:base64+self+signing+public+key&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+signature+of+HIJKLMN&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;base64+master+public+key&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:base64+master+public+key&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+master+public+key&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ed25519:HIJKLMN&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+signature+of+master+key&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;usage&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;master&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;@bob:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;bobs+base64+master+public+key&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:bobs+base64+master+public+key&#34;</span><span class="p">:</span> <span class="s2">&#34;bobs+base64+master+public+key&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ed25519:base64+user+signing+public+key&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+signature+of+bobs+master+key&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;usage&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;master&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@bob:example.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The provided signatures were processed.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>failures</code></td>
  <td><code>{string: {string: Error}}</code></td>
  <td>
    A map from user ID to key ID to an error for any signatures
that failed.  If a signature was invalid, the <code>errcode</code> will
be set to <code>M_INVALID_SIGNATURE</code>.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;failures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;HIJKLMN&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_INVALID_SIGNATURE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Invalid signature&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h5 id="qr-codes">QR codes</h5>
<p><span><strong>[Added in <code>v1.1</code>]</strong></span></p>
<p>Verifying by QR codes provides a quick way to verify when one of the parties
has a device capable of scanning a QR code. The QR code encodes both parties'
master signing keys as well as a random shared secret that is used to allow
bi-directional verification from a single scan.</p>
<p>To advertise the ability to show a QR code, clients use the names
<code>m.qr_code.show.v1</code> and <code>m.reciprocate.v1</code> in the <code>methods</code> fields of the
<code>m.key.verification.request</code> and <code>m.key.verification.ready</code> events. To
advertise the ability to scan a QR code, clients use the names
<code>m.qr_code.scan.v1</code> and <code>m.reciprocate.v1</code> in the <code>methods</code> fields of the
<code>m.key.verification.request</code> and <code>m.key.verification.ready</code> events.
Clients that support both showing and scanning QR codes would advertise
<code>m.qr_code.show.v1</code>, <code>m.qr_code.scan.v1</code>, and <code>m.reciprocate.v1</code> as
methods.</p>
<p>The process between Alice and Bob verifying each other would be:</p>
<ol>
<li>
<p>Alice and Bob meet in person, and want to verify each other&rsquo;s keys.</p>
</li>
<li>
<p>Alice and Bob begin a key verification using the key verification
framework as described above.</p>
</li>
<li>
<p>Alice&rsquo;s client displays a QR code that Bob is able to scan if Bob&rsquo;s client
indicated the ability to scan, an option to scan Bob&rsquo;s QR code if her client
is able to scan.  Bob&rsquo;s client prompts displays a QR code that Alice can
scan if Alice&rsquo;s client indicated the ability to scan, and an option to scan
Alice&rsquo;s QR code if his client is able to scan. The format for the QR code
is described below. Other options, like starting SAS Emoji verification,
can be presented alongside the QR code if the devices have appropriate
support.</p>
</li>
<li>
<p>Alice scans Bob&rsquo;s QR code.</p>
</li>
<li>
<p>Alice&rsquo;s device ensures that the keys encoded in the QR code match the
expected values for the keys. If not, Alice&rsquo;s device displays an error
message indicating that the code is incorrect, and sends a
<code>m.key.verification.cancel</code> message to Bob&rsquo;s device.</p>
<p>Otherwise, at this point:</p>
<ul>
<li>Alice&rsquo;s device has now verified Bob&rsquo;s key, and</li>
<li>Alice&rsquo;s device knows that Bob has the correct key for her.</li>
</ul>
<p>Thus for Bob to verify Alice&rsquo;s key, Alice needs to tell Bob that he has the
right key.</p>
</li>
<li>
<p>Alice&rsquo;s device displays a message saying that the verification was
successful because the QR code&rsquo;s keys will have matched the keys
expected for Bob. Bob&rsquo;s device hasn&rsquo;t had a chance to verify Alice&rsquo;s
keys yet so wouldn&rsquo;t show the same message. Bob will know that
he has the right key for Alice because Alice&rsquo;s device will have shown
this message, as otherwise the verification would be cancelled.</p>
</li>
<li>
<p>Alice&rsquo;s device sends an <code>m.key.verification.start</code> message with <code>method</code> set
to <code>m.reciprocate.v1</code> to Bob (see below).  The message includes the shared
secret from the QR code.  This signals to Bob&rsquo;s device that Alice has
scanned Bob&rsquo;s QR code.</p>
<p>This message is merely a signal for Bob&rsquo;s device to proceed to the next
step, and is not used for verification purposes.</p>
</li>
<li>
<p>Upon receipt of the <code>m.key.verification.start</code> message, Bob&rsquo;s device ensures
that the shared secret matches.</p>
<p>If the shared secret does not match, it should display an error message
indicating that an attack was attempted.  (This does not affect Alice&rsquo;s
verification of Bob&rsquo;s keys.)</p>
<p>If the shared secret does match, it asks Bob to confirm that Alice
has scanned the QR code.</p>
</li>
<li>
<p>Bob sees Alice&rsquo;s device confirm that the key matches, and presses the button
on his device to indicate that Alice&rsquo;s key is verified.</p>
<p>Bob&rsquo;s verification of Alice&rsquo;s key hinges on Alice telling Bob the result of
her scan.  Since the QR code includes what Bob thinks Alice&rsquo;s key is,
Alice&rsquo;s device can check whether Bob has the right key for her.  Alice has
no motivation to lie about the result, as getting Bob to trust an incorrect
key would only affect communications between herself and Bob.  Thus Alice
telling Bob that the code was scanned successfully is sufficient for Bob to
trust Alice&rsquo;s key, under the assumption that this communication is done
over a trusted medium (such as in-person).</p>
</li>
<li>
<p>Both devices send an <code>m.key.verification.done</code> message.</p>
</li>
</ol>
<h6 id="qr-code-format">QR code format</h6>
<p>The QR codes to be displayed and scanned using this format will encode binary
strings in the general form:</p>
<ul>
<li>the ASCII string <code>MATRIX</code></li>
<li>one byte indicating the QR code version (must be <code>0x02</code>)</li>
<li>one byte indicating the QR code verification mode.  Should be one of the
following values:
<ul>
<li><code>0x00</code> verifying another user with cross-signing</li>
<li><code>0x01</code> self-verifying in which the current device does trust the master key</li>
<li><code>0x02</code> self-verifying in which the current device does not yet trust the
master key</li>
</ul>
</li>
<li>the event ID or <code>transaction_id</code> of the associated verification
request event, encoded as:
<ul>
<li>two bytes in network byte order (big-endian) indicating the length in
bytes of the ID as a UTF-8 string</li>
<li>the ID as a UTF-8 string</li>
</ul>
</li>
<li>the first key, as 32 bytes.  The key to use depends on the mode field:
<ul>
<li>if <code>0x00</code> or <code>0x01</code>, then the current user&rsquo;s own master cross-signing public key</li>
<li>if <code>0x02</code>, then the current device&rsquo;s device key</li>
</ul>
</li>
<li>the second key, as 32 bytes.  The key to use depends on the mode field:
<ul>
<li>if <code>0x00</code>, then what the device thinks the other user&rsquo;s master
cross-signing key is</li>
<li>if <code>0x01</code>, then what the device thinks the other device&rsquo;s device key is</li>
<li>if <code>0x02</code>, then what the device thinks the user&rsquo;s master cross-signing key
is</li>
</ul>
</li>
<li>a random shared secret, as a byte string.  It is suggested to use a secret
that is about 8 bytes long.  Note: as we do not share the length of the
secret, and it is not a fixed size, clients will just use the remainder of
binary string as the shared secret.</li>
</ul>
<p>For example, if Alice displays a QR code encoding the following binary string:</p>
<pre tabindex="0"><code>      &#34;MATRIX&#34;    |ver|mode| len   | event ID
 4D 41 54 52 49 58  02  00   00 2D   21 41 42 43 44 ...
| user&#39;s cross-signing key    | other user&#39;s cross-signing key | shared secret
  00 01 02 03 04 05 06 07 ...   10 11 12 13 14 15 16 17 ...      20 21 22 23 24 25 26 27
</code></pre><p>this indicates that Alice is verifying another user (say Bob), in response to
the request from event &ldquo;$ABCD&hellip;&rdquo;, her cross-signing key is
<code>0001020304050607...</code> (which is &ldquo;AAECAwQFBg&hellip;&rdquo; in base64), she thinks that
Bob&rsquo;s cross-signing key is <code>1011121314151617...</code> (which is &ldquo;EBESExQVFh&hellip;&rdquo; in
base64), and the shared secret is <code>2021222324252627</code> (which is &ldquo;ICEiIyQlJic&rdquo; in
base64).</p>
<h6 id="verification-messages-specific-to-qr-codes">Verification messages specific to QR codes</h6>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mkeyverificationstartmreciprocatev1">
   <code>m.key.verification.start</code> with <code>method: m.reciprocate.v1</code>
  </h1>
</summary>
  <hr/>
<p>Begins a key verification process using the <code>m.reciprocate.v1</code> method, after
scanning a QR code.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>from_device</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The device ID which is initiating the process.</td>
 </tr>
 <tr>
  <td><code>m.relates_to</code></td>
  <td><code>VerificationRelatesTo</code></td>
  <td>
    Required when sent as an in-room message. Indicates the
<code>m.key.verification.request</code> that this message is related to. Note that for
encrypted messages, this property should be in the unencrypted portion of the
event.</td>
 </tr>
 <tr>
  <td><code>method</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The verification method to use.<p>One of: <code>[m.reciprocate.v1]</code>.</p></td>
 </tr>
 <tr>
  <td><code>secret</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The shared secret from the QR code, encoded using unpadded base64.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    Required when sent as a to-device message. An opaque identifier for
the verification process. Must be unique with respect to the devices
involved. Must be the same as the <code>transaction_id</code> given in the
<code>m.key.verification.request</code> if this process is originating from a
request.</td>
 </tr>
</table>
<table id="mkeyverificationstartmreciprocatev1_verificationrelatesto" class="object-table">
 <caption>VerificationRelatesTo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    The event ID of the <code>m.key.verification.request</code> that this message is
related to.</td>
 </tr>
 <tr>
  <td><code>rel_type</code></td>
  <td><code>string</code></td>
  <td>
    The relationship type. Currently, this can only be an
<a href="/client-server-api/#reference-relations"><code>m.reference</code></a> relationship type.<p>One of: <code>[m.reference]</code>.</p></td>
 </tr>
</table>
<h2>Examples</h2>
</section>
<h4 id="sharing-keys-between-devices">Sharing keys between devices</h4>
<p>If Bob has an encrypted conversation with Alice on his computer, and
then logs in through his phone for the first time, he may want to have
access to the previously exchanged messages. To address this issue,
several methods are provided to allow users to transfer keys from one
device to another.</p>
<h5 id="key-requests">Key requests</h5>
<p>When a device is missing keys to decrypt messages, it can request the
keys by sending <a href="#mroom_key_request">m.room_key_request</a> to-device messages to other
devices with <code>action</code> set to <code>request</code>.</p>
<p>If a device wishes to share the keys with that device, it can forward
the keys to the first device by sending an encrypted
<a href="#mforwarded_room_key">m.forwarded_room_key</a> to-device message. The first device should
then send an <a href="#mroom_key_request">m.room_key_request</a> to-device message with <code>action</code>
set to <code>request_cancellation</code> to the other devices that it had
originally sent the key request to; a device that receives a
<code>request_cancellation</code> should disregard any previously-received
<code>request</code> message with the same <code>request_id</code> and <code>requesting_device_id</code>.</p>
<p>If a device does not wish to share keys with that device, it can
indicate this by sending an <a href="#mroom_keywithheld">m.room_key.withheld</a> to-device message,
as described in <a href="#reporting-that-decryption-keys-are-withheld">Reporting that decryption keys are
withheld</a>.</p>
<div class="alert note " role="alert">
Key sharing can be a big attack vector, thus it must be done very
carefully. Clients should only send keys requested by the verified devices
of the same user, and should only request and accept forwarded keys from
verified devices of the same user.
</div>
<h5 id="server-side-key-backups">Server-side key backups</h5>
<p>Devices may upload encrypted copies of keys to the server. When a device
tries to read a message that it does not have keys for, it may request
the key from the server and decrypt it. Backups are per-user, and users
may replace backups with new backups.</p>
<p>In contrast with <a href="#key-requests">Key requests</a>, Server-side key backups
do not require another device to be online from which to request keys.
However, as the session keys are stored on the server encrypted, it
requires users to enter a decryption key to decrypt the session keys.</p>
<p>To create a backup, a client will call <a href="#post_matrixclientv3room_keysversion">POST
/_matrix/client/v3/room_keys/version</a> and define how the keys are to
be encrypted through the backup&rsquo;s <code>auth_data</code>; other clients can
discover the backup by calling <a href="#get_matrixclientv3room_keysversion">GET
/_matrix/client/v3/room_keys/version</a>. Keys are encrypted according
to the backup&rsquo;s <code>auth_data</code> and added to the backup by calling <a href="#put_matrixclientv3room_keyskeys">PUT
/_matrix/client/v3/room_keys/keys</a> or one of its variants, and can
be retrieved by calling <a href="#get_matrixclientv3room_keyskeys">GET /_matrix/client/v3/room_keys/keys</a> or
one of its variants. Keys can only be written to the most recently
created version of the backup. Backups can also be deleted using <a href="#delete_matrixclientv3room_keysversionversion">DELETE
/_matrix/client/v3/room_keys/version/{version}</a>, or individual keys
can be deleted using <a href="#delete_matrixclientv3room_keyskeys">DELETE /_matrix/client/v3/room_keys/keys</a> or
one of its variants.</p>
<p>Clients must only store keys in backups after they have ensured that the
<code>auth_data</code> is trusted. This can be done either by:</p>
<ul>
<li>checking that it is signed by the user&rsquo;s <a href="#cross-signing">master cross-signing
key</a> or by a verified device belonging to the same user, or</li>
<li>by deriving the public key from a private key that it obtained from a trusted
source. Trusted sources for the private key include the user entering the
key, retrieving the key stored in <a href="#secret-storage">secret storage</a>, or
obtaining the key via <a href="#sharing">secret sharing</a> from a verified device
belonging to the same user.</li>
</ul>
<p>When a client uploads a key for a session that the server already has a
key for, the server will choose to either keep the existing key or
replace it with the new key based on the key metadata as follows:</p>
<ul>
<li>if the keys have different values for <code>is_verified</code>, then it will
keep the key that has <code>is_verified</code> set to <code>true</code>;</li>
<li>if they have the same values for <code>is_verified</code>, then it will keep
the key with a lower <code>first_message_index</code>;</li>
<li>and finally, if <code>is_verified</code> and <code>first_message_index</code> are equal,
then it will keep the key with a lower <code>forwarded_count</code>.</li>
</ul>
<h6 id="recovery-key">Recovery key</h6>
<p>If the recovery key (the private half of the backup encryption key) is
presented to the user to save, it is presented as a string constructed
as follows:</p>
<ol>
<li>The 256-bit curve25519 private key is prepended by the bytes <code>0x8B</code>
and <code>0x01</code></li>
<li>All the bytes in the string above, including the two header bytes,
are XORed together to form a parity byte. This parity byte is
appended to the byte string.</li>
<li>The byte string is encoded using base58, using the same <a href="https://en.bitcoin.it/wiki/Base58Check_encoding#Base58_symbol_chart">mapping as
is used for Bitcoin
addresses</a>,
that is, using the alphabet
<code>123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz</code>.</li>
<li>A space should be added after every 4th character.</li>
</ol>
<p>When reading in a recovery key, clients must disregard whitespace, and
perform the reverse of steps 1 through 3.</p>
<p>The recovery key can also be stored on the server or shared with other devices
using the <a href="#secrets">Secrets</a> module. When doing so, it is identified using the
name <code>m.megolm_backup.v1</code>, and the key is base64-encoded before being
encrypted.</p>
<h6 id="backup-algorithm-mmegolm_backupv1curve25519-aes-sha2">Backup algorithm: <code>m.megolm_backup.v1.curve25519-aes-sha2</code></h6>
<p>When a backup is created with the <code>algorithm</code> set to
<code>m.megolm_backup.v1.curve25519-aes-sha2</code>, the <code>auth_data</code> should have
the following format:</p>
<section class="rendered-data definition" id="definition-authdata">
<details open>
<summary>
<h1>
 <code>AuthData</code>
</h1>
</summary>
<hr/>
<p>The format of the <code>auth_data</code> when a key backup is created with the
<code>algorithm</code> set to <code>m.megolm_backup.v1.curve25519-aes-sha2</code>.</p>
<table class="object-table">
 <caption>AuthData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>public_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The curve25519 public key used to encrypt the backups, encoded in unpadded base64.</td>
 </tr>
 <tr>
  <td><code>signatures</code></td>
  <td><code>object</code></td>
  <td>
    Signatures of the <code>auth_data</code>, as Signed JSON</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;public_key&#34;</span><span class="p">:</span> <span class="s2">&#34;abcdefg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;something&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;ed25519:something&#34;</span><span class="p">:</span> <span class="s2">&#34;hijklmnop&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<p>The <code>session_data</code> field in the backups is constructed as follows:</p>
<ol>
<li>
<p>Encode the session key to be backed up as a JSON object using the
<code>SessionData</code> format defined below.</p>
</li>
<li>
<p>Generate an ephemeral curve25519 key, and perform an ECDH with the
ephemeral key and the backup&rsquo;s public key to generate a shared
secret. The public half of the ephemeral key, encoded using unpadded
base64, becomes the <code>ephemeral</code> property of the <code>session_data</code>.</p>
</li>
<li>
<p>Using the shared secret, generate 80 bytes by performing an HKDF
using SHA-256 as the hash, with a salt of 32 bytes of 0, and with
the empty string as the info. The first 32 bytes are used as the AES
key, the next 32 bytes are used as the MAC key, and the last 16
bytes are used as the AES initialization vector.</p>
</li>
<li>
<p>Stringify the JSON object, and encrypt it using AES-CBC-256 with
PKCS#7 padding. This encrypted data, encoded using unpadded base64,
becomes the <code>ciphertext</code> property of the <code>session_data</code>.</p>
</li>
<li>
<p>Pass the raw encrypted data (prior to base64 encoding) through
HMAC-SHA-256 using the MAC key generated above. The first 8 bytes of
the resulting MAC are base64-encoded, and become the <code>mac</code> property
of the <code>session_data</code>.</p>
</li>
</ol>
<section class="rendered-data definition" id="definition-sessiondata">
<details open>
<summary>
<h1>
 <code>SessionData</code>
</h1>
</summary>
<hr/>
<p>The format of a backed-up session key, prior to encryption, when using the
<code>m.megolm_backup.v1.curve25519-aes-sha2</code> algorithm.</p>
<table class="object-table">
 <caption>SessionData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>algorithm</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The end-to-end message encryption algorithm that the key is for. Must be <code>m.megolm.v1.aes-sha2</code>.</td>
 </tr>
 <tr>
  <td><code>forwarding_curve25519_key_chain</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>Chain of Curve25519 keys through which this session was forwarded, via <a href="#mforwarded_room_key">m.forwarded_room_key</a> events.</td>
 </tr>
 <tr>
  <td><code>sender_claimed_keys</code></td>
  <td><code>{string: string}</code></td>
  <td>
    <strong>Required: </strong>A map from algorithm name (<code>ed25519</code>) to the Ed25519 signing key of the sending device.</td>
 </tr>
 <tr>
  <td><code>sender_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Unpadded base64-encoded device Curve25519 key.</td>
 </tr>
 <tr>
  <td><code>session_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Unpadded base64-encoded session key in <a href="https://gitlab.matrix.org/matrix-org/olm/blob/master/docs/megolm.md#session-export-format">session-export format</a>.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;algorithm&#34;</span><span class="p">:</span> <span class="s2">&#34;m.megolm.v1.aes-sha2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;forwarding_curve25519_key_chain&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;hPQNcabIABgGnx3/ACv/jmMmiQHoeFfuLB17tzWp6Hw&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender_claimed_keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ed25519&#34;</span><span class="p">:</span> <span class="s2">&#34;aj40p+aw64yPIdsxoog8jhPu9i7l7NcFRecuOQblE3Y&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender_key&#34;</span><span class="p">:</span> <span class="s2">&#34;RF3s+E7RkTQTGF2d8Deol0FkQvgII2aJDf3/Jp5mxVU&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;session_key&#34;</span><span class="p">:</span> <span class="s2">&#34;AgAAAADxKHa9uFxcXzwYoNueL5Xqi69IkD4sni8Llf...&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3room_keyskeys">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/room_keys/keys</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.1</code></strong></p>
<p>Retrieve the keys from the backup.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>version</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The backup from which to retrieve the keys.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The key data.  If no keys are found, then an object with an empty
<code>rooms</code> property will be returned (<code>{&quot;rooms&quot;: {}}</code>).</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The backup was not found.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>rooms</code></td>
  <td><code>{string: RoomKeyBackup}</code></td>
  <td>
    <strong>Required: </strong>A map of room IDs to room key backup data.</td>
 </tr>
</table>
<table id="_matrixclientv3room_keyskeys_roomkeybackup" class="object-table">
 <caption>RoomKeyBackup</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>sessions</code></td>
  <td><code>{string: KeyBackupData}</code></td>
  <td>
    <strong>Required: </strong>A map of session IDs to key data.</td>
 </tr>
</table>
<table id="_matrixclientv3room_keyskeys_keybackupdata" class="object-table">
 <caption>KeyBackupData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>first_message_index</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The index of the first message in the session that the key can decrypt.</td>
 </tr>
 <tr>
  <td><code>forwarded_count</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The number of times this key has been forwarded via key-sharing between devices.</td>
 </tr>
 <tr>
  <td><code>is_verified</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether the device backing up the key verified the device that the key
is from.</td>
 </tr>
 <tr>
  <td><code>session_data</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>Algorithm-dependent data.  See the documentation for the backup
algorithms in <a href="/client-server-api/#server-side-key-backups">Server-side key backups</a> for more information on the
expected format of the data.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;rooms&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;!room:example.org&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sessions&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sessionid1&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;first_message_index&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;forwarded_count&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;is_verified&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;session_data&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;ciphertext&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+ciphertext+of+JSON+data&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;ephemeral&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+ephemeral+key&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;mac&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+mac+of+ciphertext&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3room_keyskeys_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Unknown backup version.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3room_keyskeys_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixclientv3room_keyskeys">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/client/v3/room_keys/keys</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.1</code></strong></p>
<p>Store several keys in the backup.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>version</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The backup in which to store the keys. Must be the current backup.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>rooms</code></td>
  <td><code>{string: RoomKeyBackup}</code></td>
  <td>
    <strong>Required: </strong>A map of room IDs to room key backup data.</td>
 </tr>
</table>
<table id="_matrixclientv3room_keyskeys_roomkeybackup" class="object-table">
 <caption>RoomKeyBackup</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>sessions</code></td>
  <td><code>{string: KeyBackupData}</code></td>
  <td>
    <strong>Required: </strong>A map of session IDs to key data.</td>
 </tr>
</table>
<table id="_matrixclientv3room_keyskeys_keybackupdata" class="object-table">
 <caption>KeyBackupData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>first_message_index</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The index of the first message in the session that the key can decrypt.</td>
 </tr>
 <tr>
  <td><code>forwarded_count</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The number of times this key has been forwarded via key-sharing between devices.</td>
 </tr>
 <tr>
  <td><code>is_verified</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether the device backing up the key verified the device that the key
is from.</td>
 </tr>
 <tr>
  <td><code>session_data</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>Algorithm-dependent data.  See the documentation for the backup
algorithms in <a href="/client-server-api/#server-side-key-backups">Server-side key backups</a> for more information on the
expected format of the data.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;rooms&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;!room:example.org&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sessions&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sessionid1&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;first_message_index&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;forwarded_count&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;is_verified&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;session_data&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;ciphertext&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+ciphertext+of+JSON+data&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;ephemeral&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+ephemeral+key&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;mac&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+mac+of+ciphertext&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The update succeeded</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The version specified does not match the current backup version.
The current version will be included in the <code>current_version</code>
field.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The backup was not found.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="_matrixclientv3room_keyskeys_roomkeysupdateresponse" class="object-table">
 <caption>RoomKeysUpdateResponse</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>count</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The number of keys stored in the backup</td>
 </tr>
 <tr>
  <td><code>etag</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The new etag value representing stored keys in the backup.
See <code>GET /room_keys/version/{version}</code> for more details.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;count&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;etag&#34;</span><span class="p">:</span> <span class="s2">&#34;abcdefg&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3room_keyskeys_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;current_version&#34;</span><span class="p">:</span> <span class="s2">&#34;42&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_WRONG_ROOM_KEYS_VERSION&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Wrong backup version.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3room_keyskeys_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Unknown backup version&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3room_keyskeys_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api DELETE">
<details open>
<summary>
  <h1 id="delete_matrixclientv3room_keyskeys">
   <span class="http-api-method DELETE">DELETE</span>
   <span class="endpoint">/_matrix/client/v3/room_keys/keys</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.1</code></strong></p>
<p>Delete the keys from the backup.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>version</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The backup from which to delete the key</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The update succeeded</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The backup was not found.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="_matrixclientv3room_keyskeys_roomkeysupdateresponse" class="object-table">
 <caption>RoomKeysUpdateResponse</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>count</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The number of keys stored in the backup</td>
 </tr>
 <tr>
  <td><code>etag</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The new etag value representing stored keys in the backup.
See <code>GET /room_keys/version/{version}</code> for more details.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;count&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;etag&#34;</span><span class="p">:</span> <span class="s2">&#34;abcdefg&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3room_keyskeys_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Unknown backup version&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3room_keyskeys_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3room_keyskeysroomid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/room_keys/keys/{roomId}</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.1</code></strong></p>
<p>Retrieve the keys from the backup for a given room.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room that the requested key is for.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>version</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The backup from which to retrieve the key.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The key data.  If no keys are found, then an object with an empty
<code>sessions</code> property will be returned (<code>{&quot;sessions&quot;: {}}</code>).</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The backup was not found.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="_matrixclientv3room_keyskeysroomid_roomkeybackup" class="object-table">
 <caption>RoomKeyBackup</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>sessions</code></td>
  <td><code>{string: KeyBackupData}</code></td>
  <td>
    <strong>Required: </strong>A map of session IDs to key data.</td>
 </tr>
</table>
<table id="_matrixclientv3room_keyskeysroomid_keybackupdata" class="object-table">
 <caption>KeyBackupData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>first_message_index</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The index of the first message in the session that the key can decrypt.</td>
 </tr>
 <tr>
  <td><code>forwarded_count</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The number of times this key has been forwarded via key-sharing between devices.</td>
 </tr>
 <tr>
  <td><code>is_verified</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether the device backing up the key verified the device that the key
is from.</td>
 </tr>
 <tr>
  <td><code>session_data</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>Algorithm-dependent data.  See the documentation for the backup
algorithms in <a href="/client-server-api/#server-side-key-backups">Server-side key backups</a> for more information on the
expected format of the data.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sessions&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sessionid1&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;first_message_index&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;forwarded_count&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;is_verified&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;session_data&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ciphertext&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+ciphertext+of+JSON+data&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ephemeral&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+ephemeral+key&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;mac&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+mac+of+ciphertext&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3room_keyskeysroomid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Unknown backup version&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3room_keyskeysroomid_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixclientv3room_keyskeysroomid">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/client/v3/room_keys/keys/{roomId}</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.1</code></strong></p>
<p>Store several keys in the backup for a given room.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room that the keys are for.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>version</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The backup in which to store the keys. Must be the current backup.</td>
 </tr>
</table>
<h3>Request body</h3>
<table id="_matrixclientv3room_keyskeysroomid_roomkeybackup" class="object-table">
 <caption>RoomKeyBackup</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>sessions</code></td>
  <td><code>{string: KeyBackupData}</code></td>
  <td>
    <strong>Required: </strong>A map of session IDs to key data.</td>
 </tr>
</table>
<table id="_matrixclientv3room_keyskeysroomid_keybackupdata" class="object-table">
 <caption>KeyBackupData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>first_message_index</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The index of the first message in the session that the key can decrypt.</td>
 </tr>
 <tr>
  <td><code>forwarded_count</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The number of times this key has been forwarded via key-sharing between devices.</td>
 </tr>
 <tr>
  <td><code>is_verified</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether the device backing up the key verified the device that the key
is from.</td>
 </tr>
 <tr>
  <td><code>session_data</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>Algorithm-dependent data.  See the documentation for the backup
algorithms in <a href="/client-server-api/#server-side-key-backups">Server-side key backups</a> for more information on the
expected format of the data.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sessions&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sessionid1&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;first_message_index&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;forwarded_count&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;is_verified&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;session_data&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ciphertext&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+ciphertext+of+JSON+data&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ephemeral&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+ephemeral+key&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;mac&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+mac+of+ciphertext&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The update succeeded</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The version specified does not match the current backup version.
The current version will be included in the <code>current_version</code>
field.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The backup was not found.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="_matrixclientv3room_keyskeysroomid_roomkeysupdateresponse" class="object-table">
 <caption>RoomKeysUpdateResponse</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>count</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The number of keys stored in the backup</td>
 </tr>
 <tr>
  <td><code>etag</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The new etag value representing stored keys in the backup.
See <code>GET /room_keys/version/{version}</code> for more details.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;count&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;etag&#34;</span><span class="p">:</span> <span class="s2">&#34;abcdefg&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3room_keyskeysroomid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;current_version&#34;</span><span class="p">:</span> <span class="s2">&#34;42&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_WRONG_ROOM_KEYS_VERSION&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Wrong backup version.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3room_keyskeysroomid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Unknown backup version&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3room_keyskeysroomid_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api DELETE">
<details open>
<summary>
  <h1 id="delete_matrixclientv3room_keyskeysroomid">
   <span class="http-api-method DELETE">DELETE</span>
   <span class="endpoint">/_matrix/client/v3/room_keys/keys/{roomId}</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.1</code></strong></p>
<p>Delete the keys from the backup for a given room.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room that the specified key is for.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>version</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The backup from which to delete the key.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The update succeeded</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The backup was not found.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="_matrixclientv3room_keyskeysroomid_roomkeysupdateresponse" class="object-table">
 <caption>RoomKeysUpdateResponse</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>count</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The number of keys stored in the backup</td>
 </tr>
 <tr>
  <td><code>etag</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The new etag value representing stored keys in the backup.
See <code>GET /room_keys/version/{version}</code> for more details.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;count&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;etag&#34;</span><span class="p">:</span> <span class="s2">&#34;abcdefg&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3room_keyskeysroomid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Unknown backup version&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3room_keyskeysroomid_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3room_keyskeysroomidsessionid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/room_keys/keys/{roomId}/{sessionId}</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.1</code></strong></p>
<p>Retrieve a key from the backup.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room that the requested key is for.</td>
 </tr>
 <tr>
  <td><code>sessionId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the megolm session whose key is requested.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>version</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The backup from which to retrieve the key.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The key data</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The key or backup was not found.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="_matrixclientv3room_keyskeysroomidsessionid_keybackupdata" class="object-table">
 <caption>KeyBackupData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>first_message_index</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The index of the first message in the session that the key can decrypt.</td>
 </tr>
 <tr>
  <td><code>forwarded_count</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The number of times this key has been forwarded via key-sharing between devices.</td>
 </tr>
 <tr>
  <td><code>is_verified</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether the device backing up the key verified the device that the key
is from.</td>
 </tr>
 <tr>
  <td><code>session_data</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>Algorithm-dependent data.  See the documentation for the backup
algorithms in <a href="/client-server-api/#server-side-key-backups">Server-side key backups</a> for more information on the
expected format of the data.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;first_message_index&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;session_data&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ciphertext&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+ciphertext+of+JSON+data&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ephemeral&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+ephemeral+key&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;mac&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+mac+of+ciphertext&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3room_keyskeysroomidsessionid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Key not found.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3room_keyskeysroomidsessionid_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixclientv3room_keyskeysroomidsessionid">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/client/v3/room_keys/keys/{roomId}/{sessionId}</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.1</code></strong></p>
<p>Store a key in the backup.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room that the key is for.</td>
 </tr>
 <tr>
  <td><code>sessionId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the megolm session that the key is for.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>version</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The backup in which to store the key. Must be the current backup.</td>
 </tr>
</table>
<h3>Request body</h3>
<table id="_matrixclientv3room_keyskeysroomidsessionid_keybackupdata" class="object-table">
 <caption>KeyBackupData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>first_message_index</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The index of the first message in the session that the key can decrypt.</td>
 </tr>
 <tr>
  <td><code>forwarded_count</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The number of times this key has been forwarded via key-sharing between devices.</td>
 </tr>
 <tr>
  <td><code>is_verified</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether the device backing up the key verified the device that the key
is from.</td>
 </tr>
 <tr>
  <td><code>session_data</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>Algorithm-dependent data.  See the documentation for the backup
algorithms in <a href="/client-server-api/#server-side-key-backups">Server-side key backups</a> for more information on the
expected format of the data.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;first_message_index&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;session_data&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ciphertext&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+ciphertext+of+JSON+data&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ephemeral&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+ephemeral+key&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;mac&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+mac+of+ciphertext&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The update succeeded.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The version specified does not match the current backup version.
The current version will be included in the <code>current_version</code>
field.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="_matrixclientv3room_keyskeysroomidsessionid_roomkeysupdateresponse" class="object-table">
 <caption>RoomKeysUpdateResponse</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>count</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The number of keys stored in the backup</td>
 </tr>
 <tr>
  <td><code>etag</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The new etag value representing stored keys in the backup.
See <code>GET /room_keys/version/{version}</code> for more details.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;count&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;etag&#34;</span><span class="p">:</span> <span class="s2">&#34;abcdefg&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3room_keyskeysroomidsessionid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;current_version&#34;</span><span class="p">:</span> <span class="s2">&#34;42&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_WRONG_ROOM_KEYS_VERSION&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Wrong backup version.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3room_keyskeysroomidsessionid_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api DELETE">
<details open>
<summary>
  <h1 id="delete_matrixclientv3room_keyskeysroomidsessionid">
   <span class="http-api-method DELETE">DELETE</span>
   <span class="endpoint">/_matrix/client/v3/room_keys/keys/{roomId}/{sessionId}</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.1</code></strong></p>
<p>Delete a key from the backup.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room that the specified key is for.</td>
 </tr>
 <tr>
  <td><code>sessionId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the megolm session whose key is to be deleted.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>version</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The backup from which to delete the key</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The update succeeded</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The backup was not found.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="_matrixclientv3room_keyskeysroomidsessionid_roomkeysupdateresponse" class="object-table">
 <caption>RoomKeysUpdateResponse</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>count</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The number of keys stored in the backup</td>
 </tr>
 <tr>
  <td><code>etag</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The new etag value representing stored keys in the backup.
See <code>GET /room_keys/version/{version}</code> for more details.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;count&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;etag&#34;</span><span class="p">:</span> <span class="s2">&#34;abcdefg&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3room_keyskeysroomidsessionid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Unknown backup version&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3room_keyskeysroomidsessionid_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3room_keysversion">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/room_keys/version</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.1</code></strong></p>
<p>Get information about the latest backup version.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<p>No request parameters or request body.</p>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The information about the backup.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>No backup exists.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>algorithm</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The algorithm used for storing backups.<p>One of: <code>[m.megolm_backup.v1.curve25519-aes-sha2]</code>.</p></td>
 </tr>
 <tr>
  <td><code>auth_data</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>Algorithm-dependent data. See the documentation for the backup
algorithms in <a href="/client-server-api/#server-side-key-backups">Server-side key backups</a> for more information on the
expected format of the data.</td>
 </tr>
 <tr>
  <td><code>count</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The number of keys stored in the backup.</td>
 </tr>
 <tr>
  <td><code>etag</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An opaque string representing stored keys in the backup.
Clients can compare it with the <code>etag</code> value they received
in the request of their last key storage request.  If not
equal, another client has modified the backup.</td>
 </tr>
 <tr>
  <td><code>version</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The backup version.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;algorithm&#34;</span><span class="p">:</span> <span class="s2">&#34;m.megolm_backup.v1.curve25519-aes-sha2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;auth_data&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;public_key&#34;</span><span class="p">:</span> <span class="s2">&#34;abcdefg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;@alice:example.org&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:deviceid&#34;</span><span class="p">:</span> <span class="s2">&#34;signature&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;count&#34;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;etag&#34;</span><span class="p">:</span> <span class="s2">&#34;anopaquestring&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3room_keysversion_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;No current backup version&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3room_keysversion_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3room_keysversion">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/room_keys/version</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.1</code></strong></p>
<p>Creates a new backup.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>algorithm</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The algorithm used for storing backups.<p>One of: <code>[m.megolm_backup.v1.curve25519-aes-sha2]</code>.</p></td>
 </tr>
 <tr>
  <td><code>auth_data</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>Algorithm-dependent data. See the documentation for the backup
algorithms in <a href="/client-server-api/#server-side-key-backups">Server-side key backups</a> for more information on the
expected format of the data.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;algorithm&#34;</span><span class="p">:</span> <span class="s2">&#34;m.megolm_backup.v1.curve25519-aes-sha2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;auth_data&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;public_key&#34;</span><span class="p">:</span> <span class="s2">&#34;abcdefg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;@alice:example.org&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:deviceid&#34;</span><span class="p">:</span> <span class="s2">&#34;signature&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The version id of the new backup.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>version</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The backup version. This is an opaque string.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3room_keysversion_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3room_keysversionversion">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/room_keys/version/{version}</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.1</code></strong></p>
<p>Get information about an existing backup.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>version</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The backup version to get, as returned in the <code>version</code> parameter
of the response in
<a href="/client-server-api/#post_matrixclientv3room_keysversion"><code>POST /_matrix/client/v3/room_keys/version</code></a>
or this endpoint.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The information about the requested backup.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The backup specified does not exist.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>algorithm</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The algorithm used for storing backups.<p>One of: <code>[m.megolm_backup.v1.curve25519-aes-sha2]</code>.</p></td>
 </tr>
 <tr>
  <td><code>auth_data</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>Algorithm-dependent data. See the documentation for the backup
algorithms in <a href="/client-server-api/#server-side-key-backups">Server-side key backups</a> for more information on the
expected format of the data.</td>
 </tr>
 <tr>
  <td><code>count</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The number of keys stored in the backup.</td>
 </tr>
 <tr>
  <td><code>etag</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An opaque string representing stored keys in the backup.
Clients can compare it with the <code>etag</code> value they received
in the request of their last key storage request.  If not
equal, another client has modified the backup.</td>
 </tr>
 <tr>
  <td><code>version</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The backup version.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;algorithm&#34;</span><span class="p">:</span> <span class="s2">&#34;m.megolm_backup.v1.curve25519-aes-sha2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;auth_data&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;public_key&#34;</span><span class="p">:</span> <span class="s2">&#34;abcdefg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;@alice:example.org&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:deviceid&#34;</span><span class="p">:</span> <span class="s2">&#34;signature&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;count&#34;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;etag&#34;</span><span class="p">:</span> <span class="s2">&#34;anopaquestring&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3room_keysversionversion_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Unknown backup version&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3room_keysversionversion_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixclientv3room_keysversionversion">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/client/v3/room_keys/version/{version}</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.1</code></strong></p>
<p>Update information about an existing backup.  Only <code>auth_data</code> can be modified.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>version</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The backup version to update, as returned in the <code>version</code>
parameter in the response of
<a href="/client-server-api/#post_matrixclientv3room_keysversion"><code>POST /_matrix/client/v3/room_keys/version</code></a>
or <a href="/client-server-api/#get_matrixclientv3room_keysversionversion"><code>GET /_matrix/client/v3/room_keys/version/{version}</code></a>.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>algorithm</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The algorithm used for storing backups.  Must be the same as
the algorithm currently used by the backup.<p>One of: <code>[m.megolm_backup.v1.curve25519-aes-sha2]</code>.</p></td>
 </tr>
 <tr>
  <td><code>auth_data</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>Algorithm-dependent data. See the documentation for the backup
algorithms in <a href="/client-server-api/#server-side-key-backups">Server-side key backups</a> for more information on the
expected format of the data.</td>
 </tr>
 <tr>
  <td><code>version</code></td>
  <td><code>string</code></td>
  <td>
    The backup version.  If present, must be the same as the
version in the path parameter.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;algorithm&#34;</span><span class="p">:</span> <span class="s2">&#34;m.megolm_backup.v1.curve25519-aes-sha2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;auth_data&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;public_key&#34;</span><span class="p">:</span> <span class="s2">&#34;abcdefg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;@alice:example.org&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:deviceid&#34;</span><span class="p">:</span> <span class="s2">&#34;signature&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The update succeeded.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td>A parameter was incorrect.  For example, the <code>algorithm</code> does not
match the current backup algorithm, or the <code>version</code> in the body
does not match the <code>version</code> in the path.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The backup specified does not exist.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3room_keysversionversion_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_INVALID_PARAM&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Algorithm does not match&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3room_keysversionversion_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Unknown backup version&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3room_keysversionversion_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api DELETE">
<details open>
<summary>
  <h1 id="delete_matrixclientv3room_keysversionversion">
   <span class="http-api-method DELETE">DELETE</span>
   <span class="endpoint">/_matrix/client/v3/room_keys/version/{version}</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.1</code></strong></p>
<p>Delete an existing key backup. Both the information about the backup,
as well as all key data related to the backup will be deleted.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>version</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The backup version to delete, as returned in the <code>version</code>
parameter in the response of
<a href="/client-server-api/#post_matrixclientv3room_keysversion"><code>POST /_matrix/client/v3/room_keys/version</code></a>
or <a href="/client-server-api/#get_matrixclientv3room_keysversionversion"><code>GET /_matrix/client/v3/room_keys/version/{version}</code></a>.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The delete succeeded, or the specified backup was previously
deleted.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The backup specified does not exist. If the backup was previously
deleted, the call should succeed rather than returning an error.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3room_keysversionversion_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Unknown backup version&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3room_keysversionversion_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h5 id="key-exports">Key exports</h5>
<p>Keys can be manually exported from one device to an encrypted file,
copied to another device, and imported. The file is encrypted using a
user-supplied passphrase, and is created as follows:</p>
<ol>
<li>
<p>Encode the sessions as a JSON object, formatted as described in <a href="#key-export-format">Key
export format</a>.</p>
</li>
<li>
<p>Generate a 512-bit key from the user-entered passphrase by computing
<a href="https://tools.ietf.org/html/rfc2898#section-5.2">PBKDF2</a>(HMAC-SHA-512,
passphrase, S, N, 512), where S is a 128-bit
cryptographically-random salt and N is the number of rounds. N
should be at least 100,000. The keys K and K&rsquo; are set to the first
and last 256 bits of this generated key, respectively. K is used as
an AES-256 key, and K&rsquo; is used as an HMAC-SHA-256 key.</p>
</li>
<li>
<p>Serialize the JSON object as a UTF-8 string, and encrypt it using
AES-CTR-256 with the key K generated above, and with a 128-bit
cryptographically-random initialization vector, IV, that has bit 63
set to zero. (Setting bit 63 to zero in IV is needed to work around
differences in implementations of AES-CTR.)</p>
</li>
<li>
<p>Concatenate the following data:</p>
</li>
</ol>
<table>
<thead>
<tr>
<th>Size (bytes)</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Export format version, which must be <code>0x01</code>.</td>
</tr>
<tr>
<td>16</td>
<td>The salt S.</td>
</tr>
<tr>
<td>16</td>
<td>The initialization vector IV.</td>
</tr>
<tr>
<td>4</td>
<td>The number of rounds N, as a big-endian unsigned 32-bit integer.</td>
</tr>
<tr>
<td>variable</td>
<td>The encrypted JSON object.</td>
</tr>
<tr>
<td>32</td>
<td>The HMAC-SHA-256 of all the above string concatenated together, using K&rsquo; as the key.</td>
</tr>
</tbody>
</table>
<ol start="5">
<li>
<p>Base64-encode the string above. Newlines may be added to avoid
overly long lines.</p>
</li>
<li>
<p>Prepend the resulting string with
<code>-----BEGIN MEGOLM SESSION DATA-----</code>, with a trailing newline, and
append <code>-----END MEGOLM SESSION DATA-----</code>, with a leading and
trailing newline.</p>
</li>
</ol>
<h6 id="key-export-format">Key export format</h6>
<p>The exported sessions are formatted as a JSON array of <code>SessionData</code>
objects described as follows:</p>
<section class="rendered-data definition" id="definition-sessiondata">
<details open>
<summary>
<h1>
 <code>SessionData</code>
</h1>
</summary>
<hr/>
<p>The format used to encode a Megolm session key for export.</p>
<p>This is similar to the format before encryption used for the session keys
in <a href="#server-side-key-backups">Server-side key backups</a> but adds the
<code>room_id</code> and <code>session_id</code> fields.</p>
<table class="object-table">
 <caption>SessionData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>algorithm</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The end-to-end message encryption algorithm that the key is for. Must be <code>m.megolm.v1.aes-sha2</code>.</td>
 </tr>
 <tr>
  <td><code>forwarding_curve25519_key_chain</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>Chain of Curve25519 keys through which this session was forwarded, via <a href="#mforwarded_room_key">m.forwarded_room_key</a> events.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room where the session is used.</td>
 </tr>
 <tr>
  <td><code>sender_claimed_keys</code></td>
  <td><code>{string: string}</code></td>
  <td>
    <strong>Required: </strong>A map from algorithm name (<code>ed25519</code>) to the Ed25519 signing key of the sending device.</td>
 </tr>
 <tr>
  <td><code>sender_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Unpadded base64-encoded device Curve25519 key.</td>
 </tr>
 <tr>
  <td><code>session_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The Megolm session ID.</td>
 </tr>
 <tr>
  <td><code>session_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Unpadded base64-encoded session key in <a href="https://gitlab.matrix.org/matrix-org/olm/blob/master/docs/megolm.md#session-export-format">session-export format</a>.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;algorithm&#34;</span><span class="p">:</span> <span class="s2">&#34;m.megolm.v1.aes-sha2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;forwarding_curve25519_key_chain&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;hPQNcabIABgGnx3/ACv/jmMmiQHoeFfuLB17tzWp6Hw&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender_claimed_keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ed25519&#34;</span><span class="p">:</span> <span class="s2">&#34;aj40p+aw64yPIdsxoog8jhPu9i7l7NcFRecuOQblE3Y&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender_key&#34;</span><span class="p">:</span> <span class="s2">&#34;RF3s+E7RkTQTGF2d8Deol0FkQvgII2aJDf3/Jp5mxVU&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;session_key&#34;</span><span class="p">:</span> <span class="s2">&#34;AgAAAADxKHa9uFxcXzwYoNueL5Xqi69IkD4sni8Llf...&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h4 id="messaging-algorithms">Messaging Algorithms</h4>
<h5 id="messaging-algorithm-names">Messaging Algorithm Names</h5>
<p>Messaging algorithm names use the extensible naming scheme used
throughout this specification. Algorithm names that start with <code>m.</code> are
reserved for algorithms defined by this specification. Implementations
wanting to experiment with new algorithms must be uniquely globally
namespaced following Java&rsquo;s package naming conventions.</p>
<p>Algorithm names should be short and meaningful, and should list the
primitives used by the algorithm so that it is easier to see if the
algorithm is using a broken primitive.</p>
<p>A name of <code>m.olm.v1</code> is too short: it gives no information about the
primitives in use, and is difficult to extend for different primitives.
However a name of
<code>m.olm.v1.ecdh-curve25519-hdkfsha256.hmacsha256.hkdfsha256-aes256-cbc-hmac64sha256</code>
is too long despite giving a more precise description of the algorithm:
it adds to the data transfer overhead and sacrifices clarity for human
readers without adding any useful extra information.</p>
<h5 id="molmv1curve25519-aes-sha2"><code>m.olm.v1.curve25519-aes-sha2</code></h5>
<p>The name <code>m.olm.v1.curve25519-aes-sha2</code> corresponds to version 1 of the
Olm ratchet, as defined by the <a href="http://matrix.org/docs/spec/olm.html">Olm
specification</a>. This uses:</p>
<ul>
<li>Curve25519 for the initial key agreement.</li>
<li>HKDF-SHA-256 for ratchet key derivation.</li>
<li>Curve25519 for the root key ratchet.</li>
<li>HMAC-SHA-256 for the chain key ratchet.</li>
<li>HKDF-SHA-256, AES-256 in CBC mode, and 8 byte truncated HMAC-SHA-256
for authenticated encryption.</li>
</ul>
<p>Devices that support Olm must include &ldquo;m.olm.v1.curve25519-aes-sha2&rdquo; in
their list of supported messaging algorithms, must list a Curve25519
device key, and must publish Curve25519 one-time keys.</p>
<p>An event encrypted using Olm has the following format:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.encrypted&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;algorithm&#34;</span><span class="p">:</span> <span class="s2">&#34;m.olm.v1.curve25519-aes-sha2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sender_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;sender_curve25519_key&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ciphertext&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;&lt;device_curve25519_key&gt;&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;encrypted_payload_base_64&gt;&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>ciphertext</code> is a mapping from device Curve25519 key to an encrypted
payload for that device. <code>body</code> is a Base64-encoded Olm message body.
<code>type</code> is an integer indicating the type of the message body: 0 for the
initial pre-key message, 1 for ordinary messages.</p>
<p>Olm sessions will generate messages with a type of 0 until they receive
a message. Once a session has decrypted a message it will produce
messages with a type of 1.</p>
<p>When a client receives a message with a type of 0 it must first check if
it already has a matching session. If it does then it will use that
session to try to decrypt the message. If there is no existing session
then the client must create a new session and use the new session to
decrypt the message. A client must not persist a session or remove
one-time keys used by a session until it has successfully decrypted a
message using that session.</p>
<p>Messages with type 1 can only be decrypted with an existing session. If
there is no matching session, the client must treat this as an invalid
message.</p>
<p>The plaintext payload is of the form:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;type of the plaintext event&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;content for the plaintext event&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;sender_user_id&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;recipient&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;recipient_user_id&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;recipient_keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ed25519&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;our_ed25519_key&gt;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ed25519&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;sender_ed25519_key&gt;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The type and content of the plaintext message event are given in the
payload.</p>
<p>Other properties are included in order to prevent an attacker from
publishing someone else&rsquo;s curve25519 keys as their own and subsequently
claiming to have sent messages which they didn&rsquo;t. <code>sender</code> must
correspond to the user who sent the event, <code>recipient</code> to the local
user, and <code>recipient_keys</code> to the local ed25519 key.</p>
<p>Clients must confirm that the <code>sender_key</code> and the <code>ed25519</code> field value
under the <code>keys</code> property match the keys returned by <a href="/client-server-api/#post_matrixclientv3keysquery"><code>/keys/query</code></a> for
the given user, and must also verify the signature of the keys from the
<code>/keys/query</code> response. Without this check, a client cannot be sure that
the sender device owns the private part of the ed25519 key it claims to
have in the Olm payload. This is crucial when the ed25519 key corresponds
to a verified device.</p>
<p>If a client has multiple sessions established with another device, it
should use the session from which it last received and successfully
decrypted a message. For these purposes, a session that has not received
any messages should use its creation time as the time that it last
received a message. A client may expire old sessions by defining a
maximum number of olm sessions that it will maintain for each device,
and expiring sessions on a Least Recently Used basis. The maximum number
of olm sessions maintained per device should be at least 4.</p>
<h6 id="recovering-from-undecryptable-messages">Recovering from undecryptable messages</h6>
<p>Occasionally messages may be undecryptable by clients due to a variety
of reasons. When this happens to an Olm-encrypted message, the client
should assume that the Olm session has become corrupted and create a new
one to replace it.</p>
<div class="alert note " role="alert">
Megolm-encrypted messages generally do not have the same problem.
Usually the key for an undecryptable Megolm-encrypted message will come
later, allowing the client to decrypt it successfully. Olm does not have
a way to recover from the failure, making this session replacement
process required.
</div>
<p>To establish a new session, the client sends an <a href="#mdummy">m.dummy</a>
to-device event to the other party to notify them of the new session
details.</p>
<p>Clients should rate-limit the number of sessions it creates per device
that it receives a message from. Clients should not create a new session
with another device if it has already created one for that given device
in the past 1 hour.</p>
<p>Clients should attempt to mitigate loss of the undecryptable messages.
For example, Megolm sessions that were sent using the old session would
have been lost. The client can attempt to retrieve the lost sessions
through <code>m.room_key_request</code> messages.</p>
<div class="alert note " role="alert">
<p>Clients should send key requests for unknown sessions to all devices for
the user which used the session rather than just the <code>device_id</code> or
<code>sender_key</code> denoted on the event.</p>
<p>This is due to a deprecation of the fields. See
<a href="#mmegolmv1aes-sha2"><code>m.megolm.v1.aes-sha2</code></a> for more information.</p>
</div>
<h5 id="mmegolmv1aes-sha2"><code>m.megolm.v1.aes-sha2</code></h5>
<p><span><strong>[Changed in <code>v1.3</code>]</strong></span></p>
<p>The name <code>m.megolm.v1.aes-sha2</code> corresponds to version 1 of the Megolm
ratchet, as defined by the <a href="http://matrix.org/docs/spec/megolm.html">Megolm
specification</a>. This uses:</p>
<ul>
<li>HMAC-SHA-256 for the hash ratchet.</li>
<li>HKDF-SHA-256, AES-256 in CBC mode, and 8 byte truncated HMAC-SHA-256
for authenticated encryption.</li>
<li>Ed25519 for message authenticity.</li>
</ul>
<p>Devices that support Megolm must support Olm, and include
&ldquo;m.megolm.v1.aes-sha2&rdquo; in their list of supported messaging algorithms.</p>
<p>An event encrypted using Megolm has the following format:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.encrypted&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;algorithm&#34;</span><span class="p">:</span> <span class="s2">&#34;m.megolm.v1.aes-sha2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sender_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;sender_curve25519_key&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;device_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;sender_device_id&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;session_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;outbound_group_session_id&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ciphertext&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;encrypted_payload_base_64&gt;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The encrypted payload can contain any message event. The plaintext is of
the form:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;event_type&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;event_content&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;the room_id&gt;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>We include the room ID in the payload, because otherwise the homeserver
would be able to change the room a message was sent in.</p>
<p>Clients must guard against replay attacks by keeping track of the
ratchet indices of Megolm sessions. They should reject messages with a
ratchet index that they have already decrypted. Care should be taken in
order to avoid false positives, as a client may decrypt the same event
twice as part of its normal processing.</p>
<p>Similar to Olm events, clients should confirm that the user who sent the
message corresponds to the user the message was expected to come from.
For room events, this means ensuring the event&rsquo;s <code>sender</code>, <code>room_id</code>, and
the recorded <code>session_id</code> match a trusted session (eg: the <code>session_id</code>
is already known and validated to the client).</p>
<div class="alert note " role="alert">
<p>As of <code>v1.3</code>, the <code>sender_key</code> and <code>device_id</code> keys are <strong>deprecated</strong>. They
SHOULD continue to be sent, however they MUST NOT be used to verify the
message&rsquo;s source.</p>
<p>Clients MUST NOT store or lookup sessions using the <code>sender_key</code> or <code>device_id</code>.</p>
<p>In a future version of the specification the keys can be removed completely,
including for sending new messages.</p>
</div>
<div class="alert rationale " role="alert">
<p>Removing the fields (eventually) improves privacy and security by masking the
device which sent the encrypted message as well as reducing the client&rsquo;s
dependence on untrusted data: a malicious server (or similar attacker) could
change these values, and other devices/users can simply lie about them too.</p>
<p>We can remove the fields, particularly the <code>sender_key</code>, because the <code>session_id</code>
is already globally unique, therefore making storage and lookup possible without
the need for added context from the <code>sender_key</code> or <code>device_id</code>.</p>
<p>Removing the dependence on the fields gives a privacy gain while also increasing
the security of messages transmitted over Matrix.</p>
</div>
<p>In order to enable end-to-end encryption in a room, clients can send an
<code>m.room.encryption</code> state event specifying <code>m.megolm.v1.aes-sha2</code> as its
<code>algorithm</code> property.</p>
<p>When creating a Megolm session in a room, clients must share the
corresponding session key using Olm with the intended recipients, so
that they can decrypt future messages encrypted using this session. An
<code>m.room_key</code> event is used to do this. Clients must also handle
<code>m.room_key</code> events sent by other devices in order to decrypt their
messages.</p>
<p>When a client receives a Megolm session, the client MUST ensure that the
session was received via an Olm channel, in order to ensure the authenticity of
the messages.</p>
<p>When a client is updating a Megolm session in its store, the client MUST ensure:</p>
<ul>
<li>that the updated session data comes from a trusted source, such as via a
<code>m.forwarded_room_key</code> event from a verified device belonging to the same
user, or from a <code>m.room_key</code> event.</li>
<li>that the new session key has a lower message index than the existing session key.</li>
</ul>
<h4 id="protocol-definitions">Protocol definitions</h4>
<h5 id="events">Events</h5>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mroomencryption">
   <code>m.room.encryption</code>
  </h1>
</summary>
  <hr/>
<p>Defines how messages sent in this room should be encrypted.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>State event</td>
  </tr>
  <tr>
   <th>State key</th>
   <td>A zero-length string.</td>
 </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>algorithm</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The encryption algorithm to be used to encrypt messages sent in this
room.<p>One of: <code>[m.megolm.v1.aes-sha2]</code>.</p></td>
 </tr>
 <tr>
  <td><code>rotation_period_ms</code></td>
  <td><code>integer</code></td>
  <td>
    How long the session should be used before changing it. <code>604800000</code>
(a week) is the recommended default.</td>
 </tr>
 <tr>
  <td><code>rotation_period_msgs</code></td>
  <td><code>integer</code></td>
  <td>
    How many messages should be sent before changing the session. <code>100</code> is the
recommended default.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;algorithm&#34;</span><span class="p">:</span> <span class="s2">&#34;m.megolm.v1.aes-sha2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;rotation_period_ms&#34;</span><span class="p">:</span> <span class="mi">604800000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;rotation_period_msgs&#34;</span><span class="p">:</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.encryption&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mroomencrypted">
   <code>m.room.encrypted</code>
  </h1>
</summary>
  <hr/>
<p>This event type is used when sending encrypted events. It can be used either
within a room (in which case it will have all of the normal properties in
<a href="/client-server-api/#room-event-format">Room events</a>), or
as a <a href="/client-server-api/#send-to-device-messaging">to-device</a> event.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>algorithm</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The encryption algorithm used to encrypt this event. The
value of this field determines which other properties will be
present.<p>One of: <code>[m.olm.v1.curve25519-aes-sha2, m.megolm.v1.aes-sha2]</code>.</p></td>
 </tr>
 <tr>
  <td><code>ciphertext</code></td>
  <td><code>string|{string: CiphertextInfo}</code></td>
  <td>
    <strong>Required: </strong>The encrypted content of the event. Either the encrypted payload
itself, in the case of a Megolm event, or a map from the recipient
Curve25519 identity key to ciphertext information, in the case of an
Olm event. For more details, see <a href="/client-server-api/#messaging-algorithms">Messaging Algorithms</a>.</td>
 </tr>
 <tr>
  <td><code>device_id</code></td>
  <td><code>string</code></td>
  <td>
    <p>The ID of the sending device.</p>
<p><strong>Deprecated</strong>: This field provides no additional security or privacy benefit
for Megolm messages and must not be read from if the encrypted event is using
Megolm. It should still be included on outgoing messages, however must not be
used to find the corresponding session. See <a href="#mmegolmv1aes-sha2"><code>m.megolm.v1.aes-sha2</code></a>
for more information.</p>
<br><br>
    <strong>
      Changed in <code>v1.3</code>:
    </strong>
    Previously this field was required for Megolm messages, however given it
offers no additional security or privacy benefit it has been deprecated
for Megolm messages. See <a href="#mmegolmv1aes-sha2"><code>m.megolm.v1.aes-sha2</code></a> for
more information.
</td>
 </tr>
 <tr>
  <td><code>sender_key</code></td>
  <td><code>string</code></td>
  <td>
    <p>The Curve25519 key of the sender. Required (not deprecated) if not using Megolm.</p>
<p><strong>Deprecated</strong>: This field provides no additional security or privacy benefit
for Megolm messages and must not be read from if the encrypted event is using
Megolm. It should still be included on outgoing messages, however must not be
used to find the corresponding session. See <a href="#mmegolmv1aes-sha2"><code>m.megolm.v1.aes-sha2</code></a>
for more information.</p>
<br><br>
    <strong>
      Changed in <code>v1.3</code>:
    </strong>
    Previously this field was required, however given it offers no additional
security or privacy benefit it has been deprecated for Megolm messages.
See <a href="#mmegolmv1aes-sha2"><code>m.megolm.v1.aes-sha2</code></a> for more information.
</td>
 </tr>
 <tr>
  <td><code>session_id</code></td>
  <td><code>string</code></td>
  <td>
    The ID of the session used to encrypt the message. Required with
Megolm.</td>
 </tr>
</table>
<table id="mroomencrypted_ciphertextinfo" class="object-table">
 <caption>CiphertextInfo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>body</code></td>
  <td><code>string</code></td>
  <td>
    The encrypted payload.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>integer</code></td>
  <td>
    The Olm message type.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;algorithm&#34;</span><span class="p">:</span> <span class="s2">&#34;m.megolm.v1.aes-sha2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ciphertext&#34;</span><span class="p">:</span> <span class="s2">&#34;AwgAEnACgAkLmt6qF84IK++J7UDH2Za1YVchHyprqTqsg...&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;device_id&#34;</span><span class="p">:</span> <span class="s2">&#34;RJYKSTBOIE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sender_key&#34;</span><span class="p">:</span> <span class="s2">&#34;IlRMeOPX2e0MurIyfWEucYBRVOEEUMrOHqn/8mLqMjA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;session_id&#34;</span><span class="p">:</span> <span class="s2">&#34;X3lUlvLELLYxeTx4yOVu6UDpasGEVO0Jbu+QFnm0cKQ&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.encrypted&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;algorithm&#34;</span><span class="p">:</span> <span class="s2">&#34;m.olm.v1.curve25519-aes-sha2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ciphertext&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;7qZcfnBmbEGzxxaWfBjElJuvn7BZx+lSz/SvFrDF/z8&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;AwogGJJzMhf/S3GQFXAOrCZ3iKyGU5ZScVtjI0KypTYrW...&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sender_key&#34;</span><span class="p">:</span> <span class="s2">&#34;Szl29ksW/L8yZGWAX+8dY1XyFi+i5wm+DRhTGkbMiwU&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.encrypted&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mroom_key">
   <code>m.room_key</code>
  </h1>
</summary>
  <hr/>
<p>This event type is used to exchange keys for end-to-end encryption.
It is encrypted as an <code>m.room.encrypted</code> event using <a href="#molmv1curve25519-aes-sha2">Olm</a>,
then sent as a <a href="/client-server-api/#send-to-device-messaging">to-device</a> event.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>algorithm</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The encryption algorithm the key in this event is to be used with.<p>One of: <code>[m.megolm.v1.aes-sha2]</code>.</p></td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room where the key is used.</td>
 </tr>
 <tr>
  <td><code>session_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the session that the key is for.</td>
 </tr>
 <tr>
  <td><code>session_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The key to be exchanged.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;algorithm&#34;</span><span class="p">:</span> <span class="s2">&#34;m.megolm.v1.aes-sha2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!Cuyf34gef24t:localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;session_id&#34;</span><span class="p">:</span> <span class="s2">&#34;X3lUlvLELLYxeTx4yOVu6UDpasGEVO0Jbu+QFnm0cKQ&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;session_key&#34;</span><span class="p">:</span> <span class="s2">&#34;AgAAAADxKHa9uFxcXzwYoNueL5Xqi69IkD4sni8LlfJL7qNBEY...&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room_key&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mroom_key_request">
   <code>m.room_key_request</code>
  </h1>
</summary>
  <hr/>
<p>This event type is used to request keys for end-to-end encryption. It is sent as an
unencrypted <a href="/client-server-api/#send-to-device-messaging">to-device</a> event.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>action</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><p>One of: <code>[request, request_cancellation]</code>.</p></td>
 </tr>
 <tr>
  <td><code>body</code></td>
  <td><code>RequestedKeyInfo</code></td>
  <td>
    Information about the requested key. Required when <code>action</code> is
<code>request</code>.</td>
 </tr>
 <tr>
  <td><code>request_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A random string uniquely identifying the request for a key. If the key is
requested multiple times, it should be reused. It should also reused in order
to cancel a request.</td>
 </tr>
 <tr>
  <td><code>requesting_device_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>ID of the device requesting the key.</td>
 </tr>
</table>
<table id="mroom_key_request_requestedkeyinfo" class="object-table">
 <caption>RequestedKeyInfo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>algorithm</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The encryption algorithm the requested key in this event is to be used
with.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room where the key is used.</td>
 </tr>
 <tr>
  <td><code>sender_key</code></td>
  <td><code>string</code></td>
  <td>
    <p>The Curve25519 key of the device which initiated the session originally.</p>
<p><strong>Deprecated</strong>: This field provides no additional security or privacy benefit
and must not be read from. It should still be included on outgoing messages
(if the event for which keys are being requested for <em>also</em> has a <code>sender_key</code>),
however must not be used to find the corresponding session. See <a href="#mmegolmv1aes-sha2"><code>m.megolm.v1.aes-sha2</code></a>
for more information.</p>
<br><br>
    <strong>
      Changed in <code>v1.3</code>:
    </strong>
    Previously this field was required, however given it offers no additional
security or privacy benefit it has been deprecated. See <a href="#mmegolmv1aes-sha2"><code>m.megolm.v1.aes-sha2</code></a>
for more information.
</td>
 </tr>
 <tr>
  <td><code>session_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the session that the key is for.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;action&#34;</span><span class="p">:</span> <span class="s2">&#34;request_cancellation&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;request_id&#34;</span><span class="p">:</span> <span class="s2">&#34;1495474790150.19&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;requesting_device_id&#34;</span><span class="p">:</span> <span class="s2">&#34;RJYKSTBOIE&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room_key_request&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;action&#34;</span><span class="p">:</span> <span class="s2">&#34;request&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;algorithm&#34;</span><span class="p">:</span> <span class="s2">&#34;m.megolm.v1.aes-sha2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!Cuyf34gef24t:localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender_key&#34;</span><span class="p">:</span> <span class="s2">&#34;RF3s+E7RkTQTGF2d8Deol0FkQvgII2aJDf3/Jp5mxVU&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;session_id&#34;</span><span class="p">:</span> <span class="s2">&#34;X3lUlvLELLYxeTx4yOVu6UDpasGEVO0Jbu+QFnm0cKQ&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;request_id&#34;</span><span class="p">:</span> <span class="s2">&#34;1495474790150.19&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;requesting_device_id&#34;</span><span class="p">:</span> <span class="s2">&#34;RJYKSTBOIE&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room_key_request&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mforwarded_room_key">
   <code>m.forwarded_room_key</code>
  </h1>
</summary>
  <hr/>
<p>This event type is used to forward keys for end-to-end encryption.
It is encrypted as an <code>m.room.encrypted</code> event using <a href="#molmv1curve25519-aes-sha2">Olm</a>,
then sent as a <a href="/client-server-api/#send-to-device-messaging">to-device</a> event.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>algorithm</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The encryption algorithm the key in this event is to be used with.</td>
 </tr>
 <tr>
  <td><code>forwarding_curve25519_key_chain</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>Chain of Curve25519 keys. It starts out empty, but each time the
key is forwarded to another device, the previous sender in the chain is added
to the end of the list. For example, if the key is forwarded from A to B to
C, this field is empty between A and B, and contains A&rsquo;s Curve25519 key between
B and C.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room where the key is used.</td>
 </tr>
 <tr>
  <td><code>sender_claimed_ed25519_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The Ed25519 key of the device which initiated the session originally.
It is &lsquo;claimed&rsquo; because the receiving device has no way to tell that the
original room_key actually came from a device which owns the private part of
this key unless they have done device verification.</td>
 </tr>
 <tr>
  <td><code>sender_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The Curve25519 key of the device which initiated the session originally.</td>
 </tr>
 <tr>
  <td><code>session_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the session that the key is for.</td>
 </tr>
 <tr>
  <td><code>session_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The key to be exchanged.</td>
 </tr>
 <tr>
  <td><code>withheld</code></td>
  <td><code>object</code></td>
  <td>
    Indicates that the key cannot be used to decrypt all the messages
from the session because a portion of the session was withheld as
described in <a href="/client-server-api/#reporting-that-decryption-keys-are-withheld">Reporting that decryption keys are withheld</a>. This
object must include the <code>code</code> and <code>reason</code> properties from the
<code>m.room_key.withheld</code> message that was received by the sender of
this message.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;algorithm&#34;</span><span class="p">:</span> <span class="s2">&#34;m.megolm.v1.aes-sha2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;forwarding_curve25519_key_chain&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;hPQNcabIABgGnx3/ACv/jmMmiQHoeFfuLB17tzWp6Hw&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!Cuyf34gef24t:localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sender_claimed_ed25519_key&#34;</span><span class="p">:</span> <span class="s2">&#34;aj40p+aw64yPIdsxoog8jhPu9i7l7NcFRecuOQblE3Y&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sender_key&#34;</span><span class="p">:</span> <span class="s2">&#34;RF3s+E7RkTQTGF2d8Deol0FkQvgII2aJDf3/Jp5mxVU&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;session_id&#34;</span><span class="p">:</span> <span class="s2">&#34;X3lUlvLELLYxeTx4yOVu6UDpasGEVO0Jbu+QFnm0cKQ&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;session_key&#34;</span><span class="p">:</span> <span class="s2">&#34;AgAAAADxKHa9uFxcXzwYoNueL5Xqi69IkD4sni8Llf...&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.forwarded_room_key&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mdummy">
   <code>m.dummy</code>
  </h1>
</summary>
  <hr/>
<p>This event type is used to indicate new Olm sessions for end-to-end encryption.
Typically it is encrypted as an <code>m.room.encrypted</code> event, then sent as a <a href="/client-server-api/#send-to-device-messaging">to-device</a>
event.</p>
<p>The event does not have any content associated with it. The sending client is expected
to send a key share request shortly after this message, causing the receiving client to
process this <code>m.dummy</code> event as the most recent event and using the keyshare request
to set up the session. The keyshare request and <code>m.dummy</code> combination should result
in the original sending client receiving keys over the newly established session.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.dummy&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h5 id="key-management-api">Key management API</h5>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3keyschanges">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/keys/changes</span>
  </h1>
</summary>
  <hr/>
<p><p>Gets a list of users who have updated their device identity keys since a
previous sync token.</p>
<p>The server should include in the results any users who:</p>
<ul>
<li>currently share a room with the calling user (ie, both users have
membership state <code>join</code>); <em>and</em></li>
<li>added new device identity keys or removed an existing device with
identity keys, between <code>from</code> and <code>to</code>.</li>
</ul>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>from</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The desired start point of the list. Should be the <code>next_batch</code> field
from a response to an earlier call to <a href="/client-server-api/#get_matrixclientv3sync"><code>/sync</code></a>. Users who have not
uploaded new device identity keys since this point, nor deleted
existing devices with identity keys since then, will be excluded
from the results.</td>
 </tr>
 <tr>
  <td><code>to</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The desired end point of the list. Should be the <code>next_batch</code>
field from a recent call to <a href="/client-server-api/#get_matrixclientv3sync"><code>/sync</code></a> - typically the most recent
such call. This may be used by the server as a hint to check its
caches are up to date.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The list of users who updated their devices.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>changed</code></td>
  <td><code>[string]</code></td>
  <td>
    The Matrix User IDs of all users who updated their device
identity keys.</td>
 </tr>
 <tr>
  <td><code>left</code></td>
  <td><code>[string]</code></td>
  <td>
    The Matrix User IDs of all users who may have left all
the end-to-end encrypted rooms they previously shared
with the user.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;changed&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;@alice:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;@bob:example.org&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;left&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;@clara:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;@doug:example.org&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3keysclaim">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/keys/claim</span>
  </h1>
</summary>
  <hr/>
<p>Claims one-time keys for use in pre-key messages.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>one_time_keys</code></td>
  <td><code>{string: {string: string}}</code></td>
  <td>
    <strong>Required: </strong>The keys to be claimed. A map from user ID, to a map from
device ID to algorithm name.</td>
 </tr>
 <tr>
  <td><code>timeout</code></td>
  <td><code>integer</code></td>
  <td>
    The time (in milliseconds) to wait when downloading keys from
remote servers. 10 seconds is the recommended default.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;one_time_keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="s2">&#34;signed_curve25519&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;timeout&#34;</span><span class="p">:</span> <span class="mi">10000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The claimed keys.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>failures</code></td>
  <td><code>{string: object}</code></td>
  <td>
    <p>If any remote homeservers could not be reached, they are
recorded here. The names of the properties are the names of
the unreachable servers.</p>
<p>If the homeserver could be reached, but the user or device
was unknown, no failure is recorded. Instead, the corresponding
user or device is missing from the <code>one_time_keys</code> result.</p>
</td>
 </tr>
 <tr>
  <td><code>one_time_keys</code></td>
  <td><code>{string: {string: OneTimeKeys}}</code></td>
  <td>
    <strong>Required: </strong><p>One-time keys for the queried devices. A map from user ID, to a
map from devices to a map from <code>&lt;algorithm&gt;:&lt;key_id&gt;</code> to the key object.</p>
<p>See the <a href="/client-server-api/#key-algorithms">key algorithms</a> section for information
on the Key Object format.</p>
<p>If necessary, the claimed key might be a fallback key. Fallback
keys are re-used by the server until replaced by the device.</p>
</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;one_time_keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;signed_curve25519:AAAAHg&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;zKbLg+NrIjpnagy+pIY6uPL4ZwEG2v+8F9lmgsnlZzs&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;ed25519:JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="s2">&#34;FLWxXqGbwrb8SM3Y795eB6OA8bwBcoMZFXBqnTn58AYWZSqiD45tlBVcDa2L7RwdKXebW/VzDlnfVJ+9jok1Bw&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3keysquery">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/keys/query</span>
  </h1>
</summary>
  <hr/>
<p>Returns the current devices and identity keys for the given users.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>device_keys</code></td>
  <td><code>{string: [string]}</code></td>
  <td>
    <strong>Required: </strong>The keys to be downloaded. A map from user ID, to a list of
device IDs, or to an empty list to indicate all devices for the
corresponding user.</td>
 </tr>
 <tr>
  <td><code>timeout</code></td>
  <td><code>integer</code></td>
  <td>
    The time (in milliseconds) to wait when downloading keys from
remote servers. 10 seconds is the recommended default.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;device_keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;timeout&#34;</span><span class="p">:</span> <span class="mi">10000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The device information</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>device_keys</code></td>
  <td><code>{string: {string: DeviceInformation}}</code></td>
  <td>
    Information on the queried devices. A map from user ID, to a
map from device ID to device information.  For each device,
the information returned will be the same as uploaded via
<code>/keys/upload</code>, with the addition of an <code>unsigned</code>
property.</td>
 </tr>
 <tr>
  <td><code>failures</code></td>
  <td><code>{string: object}</code></td>
  <td>
    <p>If any remote homeservers could not be reached, they are
recorded here. The names of the properties are the names of
the unreachable servers.</p>
<p>If the homeserver could be reached, but the user or device
was unknown, no failure is recorded. Instead, the corresponding
user or device is missing from the <code>device_keys</code> result.</p>
</td>
 </tr>
 <tr>
  <td><code>master_keys</code></td>
  <td><code>{string: CrossSigningKey}</code></td>
  <td>
    Information on the master cross-signing keys of the queried users.
A map from user ID, to master key information.  For each key, the
information returned will be the same as uploaded via
<code>/keys/device_signing/upload</code>, along with the signatures
uploaded via <code>/keys/signatures/upload</code> that the requesting user
is allowed to see.
<p><strong>Added in <code>v1.1</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>self_signing_keys</code></td>
  <td><code>{string: CrossSigningKey}</code></td>
  <td>
    Information on the self-signing keys of the queried users. A map
from user ID, to self-signing key information.  For each key, the
information returned will be the same as uploaded via
<code>/keys/device_signing/upload</code>.
<p><strong>Added in <code>v1.1</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>user_signing_keys</code></td>
  <td><code>{string: CrossSigningKey}</code></td>
  <td>
    Information on the user-signing key of the user making the
request, if they queried their own device information. A map
from user ID, to user-signing key information.  The
information returned will be the same as uploaded via
<code>/keys/device_signing/upload</code>.</td>
 </tr>
</table>
<table id="_matrixclientv3keysquery_deviceinformation" class="object-table">
 <caption>DeviceInformation</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>algorithms</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The encryption algorithms supported by this device.</td>
 </tr>
 <tr>
  <td><code>device_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the device these keys belong to. Must match the device ID used
when logging in.</td>
 </tr>
 <tr>
  <td><code>keys</code></td>
  <td><code>{string: string}</code></td>
  <td>
    <strong>Required: </strong>Public identity keys. The names of the properties should be in the
format <code>&lt;algorithm&gt;:&lt;device_id&gt;</code>. The keys themselves should be
encoded as specified by the key algorithm.</td>
 </tr>
 <tr>
  <td><code>signatures</code></td>
  <td><code>Signatures</code></td>
  <td>
    <strong>Required: </strong><p>Signatures for the device key object. A map from user ID, to a map from
<code>&lt;algorithm&gt;:&lt;device_id&gt;</code> to the signature.</p>
<p>The signature is calculated using the process described at <a href="/appendices/#signing-json">Signing JSON</a>.</p>
</td>
 </tr>
 <tr>
  <td><code>unsigned</code></td>
  <td><code>UnsignedDeviceInfo</code></td>
  <td>
    Additional data added to the device key information
by intermediate servers, and not covered by the
signatures.</td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the user the device belongs to. Must match the user ID used
when logging in.</td>
 </tr>
</table>
<table id="_matrixclientv3keysquery_unsigneddeviceinfo" class="object-table">
 <caption>UnsignedDeviceInfo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>device_display_name</code></td>
  <td><code>string</code></td>
  <td>
    The display name which the user set on the device.</td>
 </tr>
</table>
<table id="_matrixclientv3keysquery_crosssigningkey" class="object-table">
 <caption>CrossSigningKey</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>keys</code></td>
  <td><code>{string: string}</code></td>
  <td>
    <strong>Required: </strong>The public key.  The object must have exactly one property, whose name is
in the form <code>&lt;algorithm&gt;:&lt;unpadded_base64_public_key&gt;</code>, and whose value
is the unpadded base64 public key.</td>
 </tr>
 <tr>
  <td><code>signatures</code></td>
  <td><code>Signatures</code></td>
  <td>
    Signatures of the key, calculated using the process described at <a href="/appendices/#signing-json">Signing JSON</a>.
Optional for the master key. Other keys must be signed by the
user's master key.</td>
 </tr>
 <tr>
  <td><code>usage</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>What the key is used for.</td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the user the key belongs to.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;device_keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;algorithms&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;m.olm.v1.curve25519-aes-sha2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;m.megolm.v1.aes-sha2&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;device_id&#34;</span><span class="p">:</span> <span class="s2">&#34;JLAFKJWSCS&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;curve25519:JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="s2">&#34;3C5BFWi2Y8MaVvjM8M22DBmh24PmgR0nPvJOIArzgyI&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ed25519:JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="s2">&#34;lEuiRJBit0IG6nUf5pUzWTUEsRVVe/HJkoKuEww9ULI&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;ed25519:JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="s2">&#34;dSO80A01XiigH3uBiDVx/EjzaoycHcjq9lfQX0uWsqxl2giMIiSPR8a4d291W1ihKJL/a+myXS367WT6NAIcBA&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;device_display_name&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice&#39;s mobile phone&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;master_keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:base64+master+public+key&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+master+public+key&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;usage&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;master&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;self_signing_keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:base64+self+signing+public+key&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+self+signing+master+public+key&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ed25519:base64+master+public+key&#34;</span><span class="p">:</span> <span class="s2">&#34;signature+of+self+signing+key&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;usage&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;self_signing&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;user_signing_keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:base64+user+signing+public+key&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+user+signing+master+public+key&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ed25519:base64+master+public+key&#34;</span><span class="p">:</span> <span class="s2">&#34;signature+of+user+signing+key&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;usage&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;user_signing&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3keysupload">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/keys/upload</span>
  </h1>
</summary>
  <hr/>
<p>Publishes end-to-end encryption keys for the device.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>device_keys</code></td>
  <td><code>DeviceKeys</code></td>
  <td>
    Identity keys for the device. May be absent if no new
identity keys are required.</td>
 </tr>
 <tr>
  <td><code>fallback_keys</code></td>
  <td><code>OneTimeKeys</code></td>
  <td>
    <p>The public key which should be used if the device&rsquo;s one-time keys
are exhausted. The fallback key is not deleted once used, but should
be replaced when additional one-time keys are being uploaded. The
server will notify the client of the fallback key being used through
<code>/sync</code>.</p>
<p>There can only be at most one key per algorithm uploaded, and the server
will only persist one key per algorithm.</p>
<p>When uploading a signed key, an additional <code>fallback: true</code> key should
be included to denote that the key is a fallback key.</p>
<p>May be absent if a new fallback key is not required.</p>
<p><strong>Added in <code>v1.2</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>one_time_keys</code></td>
  <td><code>OneTimeKeys</code></td>
  <td>
    <p>One-time public keys for &ldquo;pre-key&rdquo; messages.  The names of
the properties should be in the format
<code>&lt;algorithm&gt;:&lt;key_id&gt;</code>. The format of the key is determined
by the <a href="/client-server-api/#key-algorithms">key algorithm</a>.</p>
<p>May be absent if no new one-time keys are required.</p>
</td>
 </tr>
</table>
<table id="_matrixclientv3keysupload_devicekeys" class="object-table">
 <caption>DeviceKeys</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>algorithms</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The encryption algorithms supported by this device.</td>
 </tr>
 <tr>
  <td><code>device_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the device these keys belong to. Must match the device ID used
when logging in.</td>
 </tr>
 <tr>
  <td><code>keys</code></td>
  <td><code>{string: string}</code></td>
  <td>
    <strong>Required: </strong>Public identity keys. The names of the properties should be in the
format <code>&lt;algorithm&gt;:&lt;device_id&gt;</code>. The keys themselves should be
encoded as specified by the key algorithm.</td>
 </tr>
 <tr>
  <td><code>signatures</code></td>
  <td><code>Signatures</code></td>
  <td>
    <strong>Required: </strong><p>Signatures for the device key object. A map from user ID, to a map from
<code>&lt;algorithm&gt;:&lt;device_id&gt;</code> to the signature.</p>
<p>The signature is calculated using the process described at <a href="/appendices/#signing-json">Signing JSON</a>.</p>
</td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the user the device belongs to. Must match the user ID used
when logging in.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;device_keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;algorithms&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;m.olm.v1.curve25519-aes-sha2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;m.megolm.v1.aes-sha2&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;device_id&#34;</span><span class="p">:</span> <span class="s2">&#34;JLAFKJWSCS&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;curve25519:JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="s2">&#34;3C5BFWi2Y8MaVvjM8M22DBmh24PmgR0nPvJOIArzgyI&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;ed25519:JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="s2">&#34;lEuiRJBit0IG6nUf5pUzWTUEsRVVe/HJkoKuEww9ULI&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="s2">&#34;dSO80A01XiigH3uBiDVx/EjzaoycHcjq9lfQX0uWsqxl2giMIiSPR8a4d291W1ihKJL/a+myXS367WT6NAIcBA&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;fallback_keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;curve25519:AAAAAG&#34;</span><span class="p">:</span> <span class="s2">&#34;/qyvZvwjiTxGdGU0RCguDCLeR+nmsb3FfNG3/Ve4vU8&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;signed_curve25519:AAAAGj&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;fallback&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;zKbLg+NrIjpnagy+pIY6uPL4ZwEG2v+8F9lmgsnlZzs&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ed25519:JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="s2">&#34;FLWxXqGbwrb8SM3Y795eB6OA8bwBcoMZFXBqnTn58AYWZSqiD45tlBVcDa2L7RwdKXebW/VzDlnfVJ+9jok1Bw&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;one_time_keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;curve25519:AAAAAQ&#34;</span><span class="p">:</span> <span class="s2">&#34;/qyvZvwjiTxGdGU0RCguDCLeR+nmsb3FfNG3/Ve4vU8&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;signed_curve25519:AAAAHQ&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;j3fR3HemM16M7CWhoI4Sk5ZsdmdfQHsKL1xuSft6MSw&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ed25519:JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="s2">&#34;IQeCEPb9HFk217cU9kw9EOiusC6kMIkoIRnbnfOh5Oc63S1ghgyjShBGpu34blQomoalCyXWyhaaT3MrLZYQAA&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;signed_curve25519:AAAAHg&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;zKbLg+NrIjpnagy+pIY6uPL4ZwEG2v+8F9lmgsnlZzs&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ed25519:JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="s2">&#34;FLWxXqGbwrb8SM3Y795eB6OA8bwBcoMZFXBqnTn58AYWZSqiD45tlBVcDa2L7RwdKXebW/VzDlnfVJ+9jok1Bw&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The provided keys were successfully uploaded.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>one_time_key_counts</code></td>
  <td><code>{string: integer}</code></td>
  <td>
    <strong>Required: </strong>For each key algorithm, the number of unclaimed one-time keys
of that type currently held on the server for this device.
If an algorithm is not listed, the count for that algorithm
is to be assumed zero.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;one_time_key_counts&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;curve25519&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;signed_curve25519&#34;</span><span class="p">:</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h5 id="e2e-extensions-to-sync">Extensions to /sync</h5>
<p>This module adds an optional <code>device_lists</code> property to the <a href="/client-server-api/#get_matrixclientv3sync"><code>/sync</code></a>  response,
as specified below. The server need only populate this property for an
incremental <code>/sync</code> (i.e., one where the <code>since</code> parameter was
specified). The client is expected to use <a href="/client-server-api/#post_matrixclientv3keysquery"><code>/keys/query</code></a> or
<a href="/client-server-api/#get_matrixclientv3keyschanges"><code>/keys/changes</code></a> for the equivalent functionality after an initial
sync, as documented in <a href="#tracking-the-device-list-for-a-user">Tracking the device list for a
user</a>.</p>
<p>It also adds a <code>device_one_time_keys_count</code> property. Note the spelling
difference with the <code>one_time_key_counts</code> property in the
<a href="/client-server-api/#post_matrixclientv3keysupload"><code>/keys/upload</code></a> response.</p>
<p><span><strong>[Added in <code>v1.2</code>]</strong></span></p>
<p>Finally, a <code>device_unused_fallback_key_types</code> property
is added to list the key algorithms where the device has a fallback key that
<em>has not</em> been used in a <a href="/client-server-api/#post_matrixclientv3keysclaim"><code>/keys/claim</code></a>
response. When a previously uploaded fallback key&rsquo;s algorithm is missing
from this list, the device should upload a replacement key alongside any
necessary one-time keys to avoid the fallback key&rsquo;s further usage. This
property is required for inclusion, though previous versions of the
specification did not have it. In addition to <code>/versions</code>, this can be
a way to identify the server&rsquo;s support for fallback keys.</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>device_lists</td>
<td>DeviceLists</td>
<td>Optional. Information on e2e device updates. Note: only present on an incremental sync.</td>
</tr>
<tr>
<td>device_one_time_keys_count</td>
<td>{string: integer}</td>
<td>Optional. For each key algorithm, the number of unclaimed one-time keys currently held on the server for this device.  If an algorithm is unlisted, the count for that algorithm is assumed to be zero.  If this entire parameter is missing, the count for all algorithms is assumed to be zero.</td>
</tr>
<tr>
<td>device_unused_fallback_key_types</td>
<td>[string]</td>
<td><strong>Required.</strong> The unused fallback key algorithms.</td>
</tr>
</tbody>
</table>
<p><code>DeviceLists</code></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>changed</td>
<td>[string]</td>
<td>List of users who have updated their device identity or cross-signing keys, or who now share an encrypted room with the client since the previous sync response.</td>
</tr>
<tr>
<td>left</td>
<td>[string]</td>
<td>List of users with whom we do not share any encrypted rooms anymore since the previous sync response.</td>
</tr>
</tbody>
</table>
<div class="alert note " role="alert">
For optimal performance, Alice should be added to <code>changed</code> in Bob&rsquo;s
sync only when she updates her devices or cross-signing keys, or when
Alice and Bob now share a room but didn&rsquo;t share any room previously.
However, for the sake of simpler logic, a server may add Alice to
<code>changed</code> when Alice and Bob share a new room, even if they previously
already shared a room.
</div>
<p>Example response:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;next_batch&#34;</span><span class="p">:</span> <span class="s2">&#34;s72595_4483_1934&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;rooms&#34;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&#34;leave&#34;</span><span class="p">:</span> <span class="p">{},</span> <span class="nt">&#34;join&#34;</span><span class="p">:</span> <span class="p">{},</span> <span class="nt">&#34;invite&#34;</span><span class="p">:</span> <span class="p">{}},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;device_lists&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;changed&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">       <span class="s2">&#34;@alice:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;left&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">       <span class="s2">&#34;@bob:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;device_one_time_keys_count&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;curve25519&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;signed_curve25519&#34;</span><span class="p">:</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="reporting-that-decryption-keys-are-withheld">Reporting that decryption keys are withheld</h4>
<p>When sending an encrypted event to a room, a client can optionally
signal to other devices in that room that it is not sending them the
keys needed to decrypt the event. In this way, the receiving client can
indicate to the user why it cannot decrypt the event, rather than just
showing a generic error message.</p>
<p>In the same way, when one device requests keys from another using <a href="#key-requests">Key
requests</a>, the device from which the key is being
requested may want to tell the requester that it is purposely not
sharing the key.</p>
<p>If Alice withholds a megolm session from Bob for some messages in a
room, and then later on decides to allow Bob to decrypt later messages,
she can send Bob the megolm session, ratcheted up to the point at which
she allows Bob to decrypt the messages. If Bob logs into a new device
and uses key sharing to obtain the decryption keys, the new device will
be sent the megolm sessions that have been ratcheted up. Bob&rsquo;s old
device can include the reason that the session was initially not shared
by including a <code>withheld</code> property in the <code>m.forwarded_room_key</code> message
that is an object with the <code>code</code> and <code>reason</code> properties from the
<code>m.room_key.withheld</code> message.</p>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mroom_keywithheld">
   <code>m.room_key.withheld</code>
  </h1>
</summary>
  <hr/>
<p>This event type is used to indicate that the sender is not sharing room keys
with the recipient. It is sent as a to-device event.</p>
<p>Possible values for <code>code</code> include:</p>
<ul>
<li><code>m.blacklisted</code>: the user/device was blacklisted.</li>
<li><code>m.unverified</code>: the user/device was not verified, and the sender is only
sharing keys with verified users/devices.</li>
<li><code>m.unauthorised</code>: the user/device is not allowed to have the key. For
example, this could be sent in response to a key request if the user/device
was not in the room when the original message was sent.</li>
<li><code>m.unavailable</code>: sent in reply to a key request if the device that the
key is requested from does not have the requested key.</li>
<li><code>m.no_olm</code>: an olm session could not be established.</li>
</ul>
<p>In most cases, this event refers to a specific room key. The one exception to
this is when the sender is unable to establish an olm session with the
recipient. When this happens, multiple sessions will be affected.  In order
to avoid filling the recipient's device mailbox, the sender should only send
one <code>m.room_key.withheld</code> message with no <code>room_id</code> nor <code>session_id</code>
set.  If the sender retries and fails to create an olm session again in the
future, it should not send another <code>m.room_key.withheld</code> message with a
<code>code</code> of <code>m.no_olm</code>, unless another olm session was previously
established successfully.  In response to receiving an
<code>m.room_key.withheld</code> message with a <code>code</code> of <code>m.no_olm</code>, the
recipient may start an olm session with the sender and send an <code>m.dummy</code>
message to notify the sender of the new olm session.  The recipient may
assume that this <code>m.room_key.withheld</code> message applies to all encrypted
room messages sent before it receives the message.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>algorithm</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The encryption algorithm for the key that this event is about.<p>One of: <code>[m.megolm.v1.aes-sha2]</code>.</p></td>
 </tr>
 <tr>
  <td><code>code</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A machine-readable code for why the key was not sent. Codes beginning
with <code>m.</code> are reserved for codes defined in the Matrix
specification. Custom codes must use the Java package naming
convention.<p>One of: <code>[m.blacklisted, m.unverified, m.unauthorised, m.unavailable, m.no_olm]</code>.</p></td>
 </tr>
 <tr>
  <td><code>reason</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable reason for why the key was not sent. The receiving
client should only use this string if it does not understand the
<code>code</code>.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    Required if <code>code</code> is not <code>m.no_olm</code>.  The room for the key that
this event is about.</td>
 </tr>
 <tr>
  <td><code>sender_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The unpadded base64-encoded device curve25519 key of the event's
sender.</td>
 </tr>
 <tr>
  <td><code>session_id</code></td>
  <td><code>string</code></td>
  <td>
    Required of <code>code</code> is not <code>m.no_olm</code>.  The session ID of the key
that this event is aboutis for.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;algorithm&#34;</span><span class="p">:</span> <span class="s2">&#34;m.megolm.v1.aes-sha2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;code&#34;</span><span class="p">:</span> <span class="s2">&#34;m.unverified&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;Device not verified&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!Cuyf34gef24t:localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sender_key&#34;</span><span class="p">:</span> <span class="s2">&#34;RF3s+E7RkTQTGF2d8Deol0FkQvgII2aJDf3/Jp5mxVU&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;session_id&#34;</span><span class="p">:</span> <span class="s2">&#34;X3lUlvLELLYxeTx4yOVu6UDpasGEVO0Jbu+QFnm0cKQ&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room_key.withheld&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>

    







    
<h3 id="secrets">Secrets</h3>
<p><span><strong>[Added in <code>v1.1</code>]</strong></span></p>
<p>Clients may have secret information that they wish to be made available
to other authorised clients, but that the server should not be able to
see, so the information must be encrypted as it passes through the
server. This can be done either asynchronously, by storing encrypted
data on the server for later retrieval, or synchronously, by sending
messages to each other.</p>
<p>Each secret has an identifier that is used by clients to refer to the
secret when storing, fetching, requesting, or sharing the secret.
Secrets are plain strings; structured data can be stored by encoding it
as a string.</p>
<h4 id="storage">Storage</h4>
<p>When secrets are stored on the server, they are stored in the user&rsquo;s
<a href="#client-config">account-data</a>, using an event type equal to the
secret&rsquo;s identifier. The keys that secrets are encrypted with are
described by data that is also stored in the user&rsquo;s account-data. Users
can have multiple keys, allowing them to control what sets of secrets
clients can access, depending on what keys are given to them.</p>
<h5 id="key-storage">Key storage</h5>
<p>Each key has an ID, and the description of the key is stored in the
user&rsquo;s account data using the event type
<code>m.secret_storage.key.[key ID]</code>. The contents of the account data for
the key will include an <code>algorithm</code> property, which indicates the
encryption algorithm used, as well as a <code>name</code> property, which is a
human-readable name. Key descriptions may also have a <code>passphrase</code>
property for generating the key from a user-entered passphrase, as
described in <a href="#deriving-keys-from-passphrases">deriving keys from
passphrases</a>.</p>
<p><code>KeyDescription</code></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>string</td>
<td>Optional. The name of the key. If not given, the client may use a generic name such as &ldquo;Unnamed key&rdquo;, or &ldquo;Default key&rdquo; if the key is marked as the default key (see below).</td>
</tr>
<tr>
<td>algorithm</td>
<td>string</td>
<td><strong>Required.</strong> The encryption algorithm to be used for this key. Currently, only <code>m.secret_storage.v1.aes-hmac-sha2</code> is supported.</td>
</tr>
<tr>
<td>passphrase</td>
<td>string</td>
<td>See <a href="#deriving-keys-from-passphrases">deriving keys from passphrases</a> section for a description of this property.</td>
</tr>
</tbody>
</table>
<p>Other properties depend on the encryption algorithm, and are described
below.</p>
<p>A key can be marked as the &ldquo;default&rdquo; key by setting the user&rsquo;s
account data with event type <code>m.secret_storage.default_key</code> to an
object that has the ID of the key as its <code>key</code> property. The default key
will be used to encrypt all secrets that the user would expect to be
available on all their clients. Unless the user specifies otherwise,
clients will try to use the default key to decrypt secrets.</p>
<p>Clients that want to present a simplified interface to users by not supporting
multiple keys should use the default key if one is specified. If not default
key is specified, the client may behave as if there is no key is present at
all. When such a client creates a key, it should mark that key as being the
default key.</p>
<p><code>DefaultKey</code></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>key</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the default key.</td>
</tr>
</tbody>
</table>
<h5 id="secret-storage">Secret storage</h5>
<p>Encrypted data is stored in the user&rsquo;s account data using the event
type defined by the feature that uses the data. The account data will
have an <code>encrypted</code> property that is a map from key ID to an object. The
algorithm from the <code>m.secret_storage.key.[key ID]</code> data for the given
key defines how the other properties are interpreted, though it&rsquo;s
expected that most encryption schemes would have <code>ciphertext</code> and <code>mac</code>
properties, where the <code>ciphertext</code> property is the unpadded
base64-encoded ciphertext, and the <code>mac</code> is used to ensure the integrity
of the data.</p>
<p><code>Secret</code></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>encrypted</td>
<td>{string: object}</td>
<td><strong>Required.</strong> Map from key ID the encrypted data. The exact format for the encrypted data is dependent on the key algorithm. See the definition of <code>AesHmacSha2EncryptedData</code> in the <a href="#msecret_storagev1aes-hmac-sha2">m.secret_storage.v1.aes-hmac-sha2</a> section.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<p>Some secret is encrypted using keys with ID <code>key_id_1</code> and <code>key_id_2</code>:</p>
<p><code>org.example.some.secret</code>:</p>
<pre tabindex="0"><code>{
  &#34;encrypted&#34;: {
    &#34;key_id_1&#34;: {
      &#34;ciphertext&#34;: &#34;base64+encoded+encrypted+data&#34;,
      &#34;mac&#34;: &#34;base64+encoded+mac&#34;,
      // ... other properties according to algorithm property in
      // m.secret_storage.key.key_id_1
    },
    &#34;key_id_2&#34;: {
      // ...
    }
  }
}
</code></pre><p>and the key descriptions for the keys would be:</p>
<p><code>m.secret_storage.key.key_id_1</code>:</p>
<pre tabindex="0"><code>{
  &#34;name&#34;: &#34;Some key&#34;,
  &#34;algorithm&#34;: &#34;m.secret_storage.v1.aes-hmac-sha2&#34;,
  // ... other properties according to algorithm
}
</code></pre><p><code>m.secret_storage.key.key_id_2</code>:</p>
<pre tabindex="0"><code>{
  &#34;name&#34;: &#34;Some other key&#34;,
  &#34;algorithm&#34;: &#34;m.secret_storage.v1.aes-hmac-sha2&#34;,
  // ... other properties according to algorithm
}
</code></pre><p>If <code>key_id_1</code> is the default key, then we also have:</p>
<p><code>m.secret_storage.default_key</code>:</p>
<pre tabindex="0"><code>{
  &#34;key&#34;: &#34;key_id_1&#34;
}
</code></pre><h6 id="msecret_storagev1aes-hmac-sha2"><code>m.secret_storage.v1.aes-hmac-sha2</code></h6>
<p>Secrets encrypted using the <code>m.secret_storage.v1.aes-hmac-sha2</code>
algorithm are encrypted using AES-CTR-256, and authenticated using
HMAC-SHA-256. The secret is encrypted as follows:</p>
<ol>
<li>Given the secret storage key, generate 64 bytes by performing an
HKDF with SHA-256 as the hash, a salt of 32 bytes of 0, and with the
secret name as the info. The first 32 bytes are used as the AES key,
and the next 32 bytes are used as the MAC key</li>
<li>Generate 16 random bytes, set bit 63 to 0 (in order to work around
differences in AES-CTR implementations), and use this as the AES
initialization vector. This becomes the <code>iv</code> property, encoded using
base64.</li>
<li>Encrypt the data using AES-CTR-256 using the AES key generated
above. This encrypted data, encoded using base64, becomes the
<code>ciphertext</code> property.</li>
<li>Pass the raw encrypted data (prior to base64 encoding) through
HMAC-SHA-256 using the MAC key generated above. The resulting MAC is
base64-encoded and becomes the <code>mac</code> property.</li>
</ol>
<p><code>AesHmacSha2EncryptedData</code></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>iv</td>
<td>string</td>
<td><strong>Required.</strong> The 16-byte initialization vector, encoded as base64.</td>
</tr>
<tr>
<td>ciphertext</td>
<td>string</td>
<td><strong>Required.</strong> The AES-CTR-encrypted data, encoded as base64.</td>
</tr>
<tr>
<td>mac</td>
<td>string</td>
<td><strong>Required.</strong> The MAC, encoded as base64.</td>
</tr>
</tbody>
</table>
<p>For the purposes of allowing clients to check whether a user has
correctly entered the key, clients should:</p>
<ol>
<li>encrypt and MAC a message consisting of 32 bytes of 0 as described
above, using the empty string as the info parameter to the HKDF in
step 1.</li>
<li>store the <code>iv</code> and <code>mac</code> in the <code>m.secret_storage.key.[key ID]</code>
account-data.</li>
</ol>
<p><code>AesHmacSha2KeyDescription</code></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>string</td>
<td>Optional. The name of the key.</td>
</tr>
<tr>
<td>algorithm</td>
<td>string</td>
<td><strong>Required.</strong> The encryption algorithm to be used for this key. Currently, only <code>m.secret_storage.v1.aes-hmac-sha2</code> is supported.</td>
</tr>
<tr>
<td>passphrase</td>
<td>object</td>
<td>See <a href="#deriving-keys-from-passphrases">deriving keys from passphrases</a> section for a description of this property.</td>
</tr>
<tr>
<td>iv</td>
<td>string</td>
<td>The 16-byte initialization vector, encoded as base64.</td>
</tr>
<tr>
<td>mac</td>
<td>string</td>
<td>The MAC of the result of encrypting 32 bytes of 0, encoded as base64.</td>
</tr>
</tbody>
</table>
<p>For example, the <code>m.secret_storage.key.key_id</code> for a key using this
algorithm could look like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;m.default&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;algorithm&#34;</span><span class="p">:</span> <span class="s2">&#34;m.secret_storage.v1.aes-hmac-sha2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;iv&#34;</span><span class="p">:</span> <span class="s2">&#34;random+data&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;mac&#34;</span><span class="p">:</span> <span class="s2">&#34;mac+of+encrypted+zeros&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>and data encrypted using this algorithm could look like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;encrypted&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;key_id&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;iv&#34;</span><span class="p">:</span> <span class="s2">&#34;16+bytes+base64&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ciphertext&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+encoded+encrypted+data&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;mac&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+encoded+mac&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h6 id="key-representation">Key representation</h6>
<p>When a user is given a raw key for <code>m.secret_storage.v1.aes-hmac-sha2</code>,
it will be presented as a string constructed as follows:</p>
<ol>
<li>The key is prepended by the two bytes <code>0x8b</code> and <code>0x01</code></li>
<li>All the bytes in the string above, including the two header bytes,
are XORed together to form a parity byte. This parity byte is
appended to the byte string.</li>
<li>The byte string is encoded using base58, using the same <a href="https://en.bitcoin.it/wiki/Base58Check_encoding#Base58_symbol_chart">mapping as
is used for Bitcoin
addresses</a>,
that is, using the alphabet
<code>123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz</code>.</li>
<li>The string is formatted into groups of four characters separated by
spaces.</li>
</ol>
<p>When decoding a raw key, the process should be reversed, with the
exception that whitespace is insignificant in the user&rsquo;s input.</p>
<h6 id="deriving-keys-from-passphrases">Deriving keys from passphrases</h6>
<p>A user may wish to use a chosen passphrase rather than a randomly
generated key. In this case, information on how to generate the key from
a passphrase will be stored in the <code>passphrase</code> property of the
<code>m.secret_storage.key.[key ID]</code> account-data. The <code>passphrase</code> property
has an <code>algorithm</code> property that indicates how to generate the key from
the passphrase. Other properties of the <code>passphrase</code> property are
defined by the <code>algorithm</code> specified.</p>
<p>Currently, the only algorithm defined is <code>m.pbkdf2</code>. For the <code>m.pbkdf2</code> algorithm, the <code>passphrase</code> property has the
following properties:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>algorithm</td>
<td>string</td>
<td><strong>Required.</strong> Must be <code>m.pbkdf2</code></td>
</tr>
<tr>
<td>salt</td>
<td>string</td>
<td><strong>Required.</strong> The salt used in PBKDF2.</td>
</tr>
<tr>
<td>iterations</td>
<td>integer</td>
<td><strong>Required.</strong> The number of iterations to use in PBKDF2.</td>
</tr>
<tr>
<td>bits</td>
<td>integer</td>
<td>Optional. The number of bits to generate for the key. Defaults to 256.</td>
</tr>
</tbody>
</table>
<p>The key is generated using PBKDF2 with SHA-512 as the hash, using the
salt given in the <code>salt</code> parameter, and the number of iterations given
in the <code>iterations</code> parameter.</p>
<p>Example:</p>
<pre tabindex="0"><code>{
    &#34;passphrase&#34;: {
        &#34;algorithm&#34;: &#34;m.pbkdf2&#34;,
        &#34;salt&#34;: &#34;MmMsAlty&#34;,
        &#34;iterations&#34;: 100000,
        &#34;bits&#34;: 256
    },
    ...
}
</code></pre><h4 id="sharing">Sharing</h4>
<p>To request a secret from other devices, a client sends an
<code>m.secret.request</code> device event with <code>action</code> set to <code>request</code> and
<code>name</code> set to the identifier of the secret. A device that wishes to
share the secret will reply with an <code>m.secret.send</code> event, encrypted
using olm. When the original client obtains the secret, it sends an
<code>m.secret.request</code> event with <code>action</code> set to <code>request_cancellation</code> to
all devices other than the one that it received the secret from. Clients
should ignore <code>m.secret.send</code> events received from devices that it did
not send an <code>m.secret.request</code> event to.</p>
<p>Clients must ensure that they only share secrets with other devices that
are allowed to see them. For example, clients should only share secrets
with the users own devices that are verified and may prompt the user to
confirm sharing the secret.</p>
<h5 id="event-definitions">Event definitions</h5>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="msecretrequest">
   <code>m.secret.request</code>
  </h1>
</summary>
  <hr/>
<p>Sent by a client to request a secret from another device or to cancel a
previous request. It is sent as an unencrypted to-device event.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>action</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><p>One of: <code>[request, request_cancellation]</code>.</p></td>
 </tr>
 <tr>
  <td><code>name</code></td>
  <td><code>string</code></td>
  <td>
    Required if <code>action</code> is <code>request</code>. The name of the secret that is
being requested.</td>
 </tr>
 <tr>
  <td><code>request_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A random string uniquely identifying (with respect to the requester
and the target) the target for a secret. If the secret is requested
from multiple devices at the same time, the same ID MAY be used for
every target. The same ID is also used in order to cancel a previous
request.</td>
 </tr>
 <tr>
  <td><code>requesting_device_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the device requesting the secret.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;action&#34;</span><span class="p">:</span> <span class="s2">&#34;request&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;org.example.some.secret&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;request_id&#34;</span><span class="p">:</span> <span class="s2">&#34;randomly_generated_id_9573&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;requesting_device_id&#34;</span><span class="p">:</span> <span class="s2">&#34;ABCDEFG&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.secret.request&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="msecretsend">
   <code>m.secret.send</code>
  </h1>
</summary>
  <hr/>
<p>Sent by a client to share a secret with another device, in response to an
<code>m.secret.request</code> event. It must be encrypted as an <code>m.room.encrypted</code> event
using <a href="#molmv1curve25519-aes-sha2">Olm</a>, then sent as a to-device event.</p>
<p>The <code>request_id</code> must match the ID previously given in an <code>m.secret.request</code>
event. The recipient must ensure that this event comes from a device that the
<code>m.secret.request</code> event was originally sent to, and that the device is
a verified device owned by the recipient. This should be done by checking the
sender key of the Olm session that the event was sent over.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>request_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the request that this is a response to.</td>
 </tr>
 <tr>
  <td><code>secret</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The contents of the secret</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;request_id&#34;</span><span class="p">:</span> <span class="s2">&#34;randomly_generated_id_9573&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;secret&#34;</span><span class="p">:</span> <span class="s2">&#34;ThisIsASecretDon&#39;tTellAnyone&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.secret.send&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>

    







    
<h3 id="room-history-visibility">Room History Visibility</h3>
<p>This module adds support for controlling the visibility of previous
events in a room.</p>
<p>In all cases except <code>world_readable</code>, a user needs to join a room to
view events in that room. Once they have joined a room, they will gain
access to a subset of events in the room. How this subset is chosen is
controlled by the <code>m.room.history_visibility</code> event outlined below.
After a user has left a room, they may see any events which they were
allowed to see before they left the room, but no events received after
they left.</p>
<p>The four options for the <code>m.room.history_visibility</code> event are:</p>
<ul>
<li><code>world_readable</code> - All events while this is the
<code>m.room.history_visibility</code> value may be shared by any participating
homeserver with anyone, regardless of whether they have ever joined
the room.</li>
<li><code>shared</code> - Previous events are always accessible to newly joined
members. All events in the room are accessible, even those sent when
the member was not a part of the room.</li>
<li><code>invited</code> - Events are accessible to newly joined members from the
point they were invited onwards. Events stop being accessible when
the member&rsquo;s state changes to something other than <code>invite</code> or
<code>join</code>.</li>
<li><code>joined</code> - Events are accessible to newly joined members from the
point they joined the room onwards. Events stop being accessible
when the member&rsquo;s state changes to something other than <code>join</code>.</li>
</ul>
<div class="alert warning " role="alert">
These options are applied at the point an event is <em>sent</em>. Checks are
performed with the state of the <code>m.room.history_visibility</code> event when
the event in question is added to the DAG. This means clients cannot
retrospectively choose to show or hide history to new users if the
setting at that time was more restrictive.
</div>
<h4 id="events">Events</h4>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mroomhistory_visibility">
   <code>m.room.history_visibility</code>
  </h1>
</summary>
  <hr/>
<p>This event controls whether a user can see the events that happened in a room from before they joined.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>State event</td>
  </tr>
  <tr>
   <th>State key</th>
   <td>A zero-length string.</td>
 </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>history_visibility</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Who can see the room history.<p>One of: <code>[invited, joined, shared, world_readable]</code>.</p></td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;history_visibility&#34;</span><span class="p">:</span> <span class="s2">&#34;shared&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.history_visibility&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h4 id="client-behaviour">Client behaviour</h4>
<p>Clients that implement this module MUST present to the user the possible
options for setting history visibility when creating a room.</p>
<p>Clients may want to display a notice that their events may be read by
non-joined people if the value is set to <code>world_readable</code>.</p>
<h4 id="server-behaviour">Server behaviour</h4>
<p>By default if no <code>history_visibility</code> is set, or if the value is not
understood, the visibility is assumed to be <code>shared</code>. The rules
governing whether a user is allowed to see an event depend on the state
of the room <em>at that event</em>.</p>
<ol>
<li>If the <code>history_visibility</code> was set to <code>world_readable</code>, allow.</li>
<li>If the user&rsquo;s <code>membership</code> was <code>join</code>, allow.</li>
<li>If <code>history_visibility</code> was set to <code>shared</code>, and the user joined the
room at any point after the event was sent, allow.</li>
<li>If the user&rsquo;s <code>membership</code> was <code>invite</code>, and the
<code>history_visibility</code> was set to <code>invited</code>, allow.</li>
<li>Otherwise, deny.</li>
</ol>
<p>For <code>m.room.history_visibility</code> events themselves, the user should be
allowed to see the event if the <code>history_visibility</code> before <em>or</em> after
the event would allow them to see it. (For example, a user should be
able to see <code>m.room.history_visibility</code> events which change the
<code>history_visibility</code> from <code>world_readable</code> to <code>joined</code> <em>or</em> from
<code>joined</code> to <code>world_readable</code>, even if that user was not a member of the
room.)</p>
<p>Likewise, for the user&rsquo;s own <code>m.room.member</code> events, the user should be
allowed to see the event if their <code>membership</code> before <em>or</em> after the
event would allow them to see it. (For example, a user can always see
<code>m.room.member</code> events which set their membership to <code>join</code>, or which
change their membership from <code>join</code> to any other value, even if
<code>history_visibility</code> is <code>joined</code>.)</p>
<h4 id="security-considerations">Security considerations</h4>
<p>The default value for <code>history_visibility</code> is <code>shared</code> for
backwards-compatibility reasons. Clients need to be aware that by not
setting this event they are exposing all of their room history to anyone
in the room.</p>

    







    
<h3 id="push-notifications">Push Notifications</h3>
<pre tabindex="0"><code>                                   +--------------------+  +-------------------+
                  Matrix HTTP      |                    |  |                   |
             Notification Protocol |   App Developer    |  |   Device Vendor   |
                                   |                    |  |                   |
           +-------------------+   | +----------------+ |  | +---------------+ |
           |                   |   | |                | |  | |               | |
           | Matrix homeserver +-----&gt;  Push Gateway  +------&gt; Push Provider | |
           |                   |   | |                | |  | |               | |
           +-^-----------------+   | +----------------+ |  | +----+----------+ |
             |                     |                    |  |      |            |
    Matrix   |                     |                    |  |      |            |
 Client/Server API  +              |                    |  |      |            |
             |      |              +--------------------+  +-------------------+
             |   +--+-+                                           |
             |   |    &lt;-------------------------------------------+
             +---+    |
                 |    |          Provider Push Protocol
                 +----+
          Mobile Device or Client
</code></pre><p>This module adds support for push notifications. Homeservers send
notifications of events to user-configured HTTP endpoints. Users may
also configure a number of rules that determine which events generate
notifications. These are all stored and managed by the user&rsquo;s
homeserver. This allows user-specific push settings to be reused between
client applications.</p>
<p>The above diagram shows the flow of push notifications being sent to a
handset where push notifications are submitted via the handset vendor,
such as Apple&rsquo;s APNS or Google&rsquo;s GCM. This happens as follows:</p>
<ol>
<li>The client app signs in to a homeserver.</li>
<li>The client app registers with its vendor&rsquo;s Push Provider and obtains
a routing token of some kind.</li>
<li>The mobile app uses the Client/Server API to add a &lsquo;pusher&rsquo;,
providing the URL of a specific Push Gateway which is configured for
that application. It also provides the routing token it has acquired
from the Push Provider.</li>
<li>The homeserver starts sending HTTP requests to the Push Gateway
using the supplied URL. The Push Gateway relays this notification to
the Push Provider, passing the routing token along with any
necessary private credentials the provider requires to send push
notifications.</li>
<li>The Push Provider sends the notification to the device.</li>
</ol>
<p>Definitions for terms used in this section are below:</p>
<dl>
<dt>Push Provider</dt>
<dd>
<p>A push provider is a service managed by the device vendor which can send
notifications directly to the device. Google Cloud Messaging (GCM) and
Apple Push Notification Service (APNS) are two examples of push
providers.</p>
</dd>
<dt>Push Gateway</dt>
<dd>
<p>A push gateway is a server that receives HTTP event notifications from
homeservers and passes them on to a different protocol such as APNS for
iOS devices or GCM for Android devices. Clients inform the homeserver
which Push Gateway to send notifications to when it sets up a Pusher.</p>
</dd>
<dt>Pusher</dt>
<dd>
<p>A pusher is a worker on the homeserver that manages the sending of HTTP
notifications for a user. A user can have multiple pushers: one per
device.</p>
</dd>
<dt>Push Rule</dt>
<dd>
<p>A push rule is a single rule that states under what <em>conditions</em> an
event should be passed onto a push gateway and <em>how</em> the notification
should be presented. These rules are stored on the user&rsquo;s homeserver.
They are manually configured by the user, who can create and view them
via the Client/Server API.</p>
</dd>
<dt>Push Ruleset</dt>
<dd>
<p>A push ruleset <em>scopes a set of rules according to some criteria</em>. For
example, some rules may only be applied for messages from a particular
sender, a particular room, or by default. The push ruleset contains the
entire set of scopes and rules.</p>
</dd>
</dl>
<h4 id="push-rules">Push Rules</h4>
<p>A push rule is a single rule that states under what <em>conditions</em> an
event should be passed onto a push gateway and <em>how</em> the notification
should be presented. There are different &ldquo;kinds&rdquo; of push rules and each
rule has an associated priority. Every push rule MUST have a <code>kind</code> and
<code>rule_id</code>. The <code>rule_id</code> is a unique string within the kind of rule and
its&rsquo; scope: <code>rule_ids</code> do not need to be unique between rules of the
same kind on different devices. Rules may have extra keys depending on
the value of <code>kind</code>.</p>
<p>The different <code>kind</code>s of rule, in the order that they are checked, are:</p>
<ol>
<li>
<p><strong>Override rules (<code>override</code>).</strong>
The highest priority rules are user-configured overrides.</p>
</li>
<li>
<p><strong>Content-specific rules (<code>content</code>).</strong>
These configure behaviour for messages that match certain patterns. Content
rules take one parameter: <code>pattern</code>, that gives the
<a href="/appendices#glob-style-matching">glob-style pattern</a> to match against.
The match is performed case-insensitively, and must match any substring of
the <code>content.body</code> property which starts and ends at a word boundary. A word
boundary is defined as the start or end of the value, or any character not
in the sets <code>[A-Z]</code>, <code>[a-z]</code>, <code>[0-9]</code> or <code>_</code>.The exact meaning of
&ldquo;case insensitive&rdquo; is defined by the implementation of the homeserver.</p>
</li>
<li>
<p><strong>Room-specific rules (<code>room</code>).</strong>
These rules change the behaviour of all messages for a given room. The
<code>rule_id</code> of a room rule is always the ID of the room that it affects.</p>
</li>
<li>
<p><strong>Sender-specific rules (<code>sender</code>).</strong>
These rules configure notification behaviour for messages from a
specific Matrix user ID. The <code>rule_id</code> of Sender rules is always the
Matrix user ID of the user whose messages they&rsquo;d apply to.</p>
</li>
<li>
<p><strong>Underride rules (<code>underride</code>).</strong>
These are identical to <code>override</code> rules, but have a lower priority than
<code>content</code>, <code>room</code> and <code>sender</code> rules.</p>
</li>
</ol>
<p>Rules with the same <code>kind</code> can specify an ordering priority. This
determines which rule is selected in the event of multiple matches. For
example, a rule matching &ldquo;tea&rdquo; and a separate rule matching &ldquo;time&rdquo; would
both match the sentence &ldquo;It&rsquo;s time for tea&rdquo;. The ordering of the rules
would then resolve the tiebreak to determine which rule is executed.
Only <code>actions</code> for highest priority rule will be sent to the Push
Gateway.</p>
<p>Each rule can be enabled or disabled. Disabled rules never match. If no
rules match an event, the homeserver MUST NOT notify the Push Gateway
for that event. Homeservers MUST NOT notify the Push Gateway for events
that the user has sent themselves.</p>
<h5 id="actions">Actions</h5>
<p>All rules have an associated list of <code>actions</code>. An action affects if and
how a notification is delivered for a matching event. The following
actions are defined:</p>
<dl>
<dt><code>notify</code></dt>
<dd>
<p>This causes each matching event to generate a notification.</p>
</dd>
<dt><code>set_tweak</code></dt>
<dd>
<p>Sets an entry in the <code>tweaks</code> dictionary key that is sent in the
notification request to the Push Gateway. This takes the form of a
dictionary with a <code>set_tweak</code> key whose value is the name of the tweak
to set. It may also have a <code>value</code> key which is the value to which it
should be set.</p>
<p>The following tweaks are defined:</p>
<dl>
<dt><code>sound</code></dt>
<dd>
<p>A string representing the sound to be played when this notification
arrives. A value of <code>default</code> means to play a default sound. A device
may choose to alert the user by some other means if appropriate, eg.
vibration.</p>
</dd>
<dt><code>highlight</code></dt>
<dd>
<p>A boolean representing whether or not this message should be highlighted
in the UI. This will normally take the form of presenting the message in
a different colour and/or style. The UI might also be adjusted to draw
particular attention to the room in which the event occurred. If a
<code>highlight</code> tweak is given with no value, its value is defined to be
<code>true</code>. If no highlight tweak is given at all then the value of
<code>highlight</code> is defined to be false.</p>
</dd>
</dl>
<p>Tweaks are passed transparently through the homeserver so client
applications and Push Gateways may agree on additional tweaks. For
example, a tweak may be added to specify how to flash the notification
light on a mobile device.</p>
</dd>
</dl>
<p>Actions that have no parameters are represented as a string. Otherwise,
they are represented as a dictionary with a key equal to their name and
other keys as their parameters, e.g.
<code>{ &quot;set_tweak&quot;: &quot;sound&quot;, &quot;value&quot;: &quot;default&quot; }</code>.</p>
<div class="alert note " role="alert">
Older versions of the Matrix specification included the <code>dont_notify</code> and
<code>coalesce</code> actions. These should both be considered no-ops (ignored, not
rejected) if received from a client.
</div>
<h5 id="conditions">Conditions</h5>
<p><code>override</code> and <code>underride</code> rules MAY have a list of &lsquo;conditions&rsquo;. All
conditions must hold true for an event in order for the rule to match. A
rule with no conditions always matches.</p>
<p>Unrecognised conditions MUST NOT match any events, effectively making
the push rule disabled.</p>
<p><code>room</code>, <code>sender</code> and <code>content</code> rules do not have conditions in the same
way, but instead have predefined conditions. In the cases of <code>room</code> and
<code>sender</code> rules, the <code>rule_id</code> of the rule determines its behaviour.</p>
<p>The following conditions are defined:</p>
<p><strong><code>event_match</code></strong></p>
<p>This is a glob pattern match on a property of the event. Parameters:</p>
<ul>
<li>
<p><code>key</code>: The <a href="/appendices#dot-separated-property-paths">dot-separated path of the property</a>
of the event to match, e.g. <code>content.body</code>.</p>
</li>
<li>
<p><code>pattern</code>: The <a href="/appendices#glob-style-matching">glob-style pattern</a> to match against.</p>
</li>
</ul>
<p>The match is performed case-insensitively, and must match the entire value of
the event property given by <code>key</code> (though see below regarding <code>content.body</code>). The
exact meaning of &ldquo;case insensitive&rdquo; is defined by the implementation of the
homeserver.</p>
<p>If the property specified by <code>key</code> is completely absent from the event, or does
not have a string value, then the condition will not match, even if <code>pattern</code>
is <code>*</code>.</p>
<div class="alert note " role="alert">
<p>For example, if <code>key</code> is <code>content.topic</code>, and <code>pattern</code> is <code>lunc?*</code>, then
the following event will match:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;topic&#34;</span><span class="p">:</span> <span class="s2">&#34;Lunch plans&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.topic&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Other <code>topic</code> values which will match are:</p>
<ul>
<li><code>&quot;LUNCH&quot;</code> (case-insensitive; <code>*</code> may match zero characters)</li>
</ul>
<p>The following <code>topic</code> values will NOT match:</p>
<ul>
<li><code>&quot; lunch&quot;</code> (note leading space)</li>
<li><code>&quot;lunc&quot;</code> (<code>?</code> must match a character)</li>
<li><code>null</code> (not a string)</li>
</ul>
</div>
<p>As a special case, if <code>key</code> is <code>content.body</code>, then <code>pattern</code> must instead
match any substring of the value of the property which starts and ends at a
word boundary. A word boundary is defined as the start or end of the value, or
any character not in the sets <code>[A-Z]</code>, <code>[a-z]</code>, <code>[0-9]</code> or <code>_</code>.</p>
<div class="alert note " role="alert">
<p>For example, if <code>key</code> is <code>content.body</code> and <code>pattern</code> is <code>ex*ple</code>, the
following event will match:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;An example event.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273976499sgjks:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Other <code>body</code> values which will match are:</p>
<ul>
<li><code>&quot;exple&quot;</code> (the pattern can match at the start and end of the body.)</li>
<li><code>&quot;An exciting triple-whammy&quot;</code> (the pattern can span multiple words, and <code>-</code>
acts as a word separator.)</li>
</ul>
</div>
<div class="alert warning " role="alert">
<p>Note that there is no implicit condition for <code>state_key</code>. In other words, push
rules which should match only state events must include an explicit condition
for <code>state_key</code>.</p>
<p>For an example of this, see the default rule
<a href="#mruletombstone"><code>.m.rule.tombstone</code></a> below.</p>
</div>
<p><strong><code>event_property_is</code></strong></p>
<p>This is an exact value match on a property of the event. Parameters:</p>
<ul>
<li>
<p><code>key</code>: The <a href="/appendices#dot-separated-property-paths">dot-separated path of the property</a>
of the event to match, e.g. <code>content.body</code>.</p>
</li>
<li>
<p><code>value</code>: The value to match against.</p>
</li>
</ul>
<p>The match is performed exactly and only supports non-compound <a href="/appendices#canonical-json">canonical JSON</a>
values: strings, integers in the range of <code>[-(2**53)+1, (2**53)-1]</code>, booleans, and
<code>null</code>.</p>
<p>If the property specified by <code>key</code> is completely absent from the event, or does
not have a string, integer, boolean, or <code>null</code> value, then the condition will not
match.</p>
<div class="alert note " role="alert">
<p>For example, if <code>key</code> is <code>content.m\.federate</code>, and <code>value</code> is <code>true</code>, then
the following event will match:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;creator&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.federate&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;predecessor&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$something:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!oldroom:example.org&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;room_version&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.create&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The following <code>m.federate</code> values will NOT match:</p>
<ul>
<li><code>&quot;true&quot;</code> (note the string value)</li>
<li><code>1</code> (do not cast types)</li>
</ul>
</div>
<p><strong><code>event_property_contains</code></strong></p>
<p>This matches if an array property of an event exactly contains a value. Parameters:</p>
<ul>
<li>
<p><code>key</code>: The <a href="/appendices#dot-separated-property-paths">dot-separated path of the property</a>
of the event to match, e.g. <code>content.body</code>.</p>
</li>
<li>
<p><code>value</code>: The value to match against.</p>
</li>
</ul>
<p>The array values are matched exactly and only supports non-compound <a href="/appendices#canonical-json">canonical JSON</a>
values: strings, integers in the range of <code>[-(2**53)+1, (2**53)-1]</code>, booleans,
and <code>null</code>. Array values not of those types are ignored.</p>
<p>If the property specified by <code>key</code> is completely absent from the event, or is not
an array, then the condition will not match.</p>
<div class="alert note " role="alert">
<p>For example, if <code>key</code> is <code>content.alt_aliases</code>, and <code>value</code> is <code>&quot;#myroom:example.com&quot;</code>,
then the following event will match:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;alias&#34;</span><span class="p">:</span> <span class="s2">&#34;#somewhere:localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;alt_aliases&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;#somewhere:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;#myroom:example.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.canonical_alias&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The following <code>alt_aliases</code> values will NOT match:</p>
<ul>
<li><code>&quot;:example.com&quot;</code> (partial values do not match)</li>
</ul>
</div>
<p><strong><code>contains_display_name</code></strong></p>
<p>This matches messages where <code>content.body</code> contains the owner&rsquo;s display name in
that room. This is a separate condition because display names may change and as such
it would be hard to maintain a rule that matched the user&rsquo;s display name. This
condition has no parameters.</p>
<p><strong><code>room_member_count</code></strong></p>
<p>This matches the current number of members in the room. Parameters:</p>
<ul>
<li><code>is</code>: A decimal integer optionally prefixed by one of, <code>==</code>, <code>&lt;</code>,
<code>&gt;</code>, <code>&gt;=</code> or <code>&lt;=</code>. A prefix of <code>&lt;</code> matches rooms where the member
count is strictly less than the given number and so forth. If no
prefix is present, this parameter defaults to <code>==</code>.</li>
</ul>
<p><strong><code>sender_notification_permission</code></strong></p>
<p>This takes into account the current power levels in the room, ensuring
the sender of the event has high enough power to trigger the
notification.</p>
<p>Parameters:</p>
<ul>
<li><code>key</code>: A string that determines the power level the sender must have
to trigger notifications of a given type, such as <code>room</code>. Refer to
the <a href="#mroompower_levels">m.room.power_levels</a> event schema for information about what
the defaults are and how to interpret the event. The <code>key</code> is used
to look up the power level required to send a notification type from
the <code>notifications</code> object in the power level event content.</li>
</ul>
<h4 id="predefined-rules">Predefined Rules</h4>
<p>Homeservers can specify &ldquo;server-default rules&rdquo;. They operate at a lower
priority than &ldquo;user-defined rules&rdquo;, except for the <code>.m.rule.master</code> rule
which has always a higher priority than any other rule. The <code>rule_id</code>
for all server-default rules MUST start with a dot (&quot;.&quot;) to identify
them as &ldquo;server-default&rdquo;. The following server-default rules are
specified:</p>
<h5 id="default-override-rules">Default Override Rules</h5>
<p><strong><code>.m.rule.master</code></strong></p>
<p>Matches all events. This can be enabled to turn off all push
notifications. Unlike other server-default rules, this one has always a
higher priority than other rules, even user defined ones. By default this
rule is disabled.</p>
<p>Definition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.master&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong><code>.m.rule.suppress_notices</code></strong></p>
<p>Matches messages with a <code>msgtype</code> of <code>notice</code>.</p>
<p>Definition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.suppress_notices&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;content.msgtype&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;m.notice&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong><code>.m.rule.invite_for_me</code></strong></p>
<p>Matches any invites to a new room for this user.</p>
<p>Definition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.invite_for_me&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;type&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;content.membership&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;invite&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;state_key&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;[the user&#39;s Matrix ID]&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">       <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;sound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong><code>.m.rule.member_event</code></strong></p>
<p>Matches any <code>m.room.member_event</code>.</p>
<p>Definition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.member_event&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;type&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><a id="_m_rule_is_user_mention"/> <strong><code>.m.rule.is_user_mention</code></strong></p>




  <span><strong>[Added in <code>v1.7</code>]</strong></span>
 

<p>Matches any message which contains the user&rsquo;s Matrix ID in the list of <code>user_ids</code>
under the <code>m.mentions</code> property.</p>
<p>Definition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.is_user_mention&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_property_contains&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;content.m\\.mentions.user_ids&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;[the user&#39;s Matrix ID]&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;sound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;highlight&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><a id="_m_rule_contains_display_name"/> <strong><code>.m.rule.contains_display_name</code></strong></p>
<p><span><strong>[Changed in <code>v1.7</code>]</strong></span></p>
<p>As of <code>v1.7</code>, this rule is deprecated and <strong>should only be enabled if the event
does not have an <a href="#definition-mmentions"><code>m.mentions</code> property</a></strong>.</p>
<p>Matches any message whose content contains the user&rsquo;s current display name
in the room in which it was sent.</p>
<p>Definition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.contains_display_name&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;contains_display_name&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;sound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;highlight&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><a id="_m_rule_is_room_mention"/> <strong><code>.m.rule.is_room_mention</code></strong></p>




  <span><strong>[Added in <code>v1.7</code>]</strong></span>
 

<p>Matches any message from a sender with the proper power level with the <code>room</code>
property of the <code>m.mentions</code> property set to <code>true</code>.</p>
<p>Definition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.is_room_mention&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_property_is&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;content.m\\.mentions.room&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;sender_notification_permission&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;room&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;highlight&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><a id="_m_rule_roomnotif"/> <strong><code>.m.rule.roomnotif</code></strong></p>
<p><span><strong>[Changed in <code>v1.7</code>]</strong></span></p>
<p>As of <code>v1.7</code>, this rule is deprecated and <strong>should only be enabled if the event
does not have an <a href="#definition-mmentions"><code>m.mentions</code> property</a></strong>.</p>
<p>Matches any message from a sender with the proper power level whose content
contains the text <code>@room</code>, signifying the whole room should be notified of
the event.</p>
<p>Definition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.roomnotif&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;content.body&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;@room&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;sender_notification_permission&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;room&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;highlight&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong><a name="mruletombstone"></a><code>.m.rule.tombstone</code></strong></p>
<p>Matches any state event whose type is <code>m.room.tombstone</code>. This is
intended to notify users of a room when it is upgraded, similar to what
an <code>@room</code> notification would accomplish.</p>
<p>Definition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.tombstone&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;type&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.tombstone&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;state_key&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;highlight&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong><a name="mrulereaction"></a><code>.m.rule.reaction</code></strong></p>
<p><span><strong>[Added in <code>v1.7</code>]</strong></span></p>
<p>Matches any event whose type is <code>m.reaction</code>. This suppresses notifications for <a href="#mreaction"><code>m.reaction</code></a> events.</p>
<p>Definition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.reaction&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;type&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;m.reaction&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong><code>.m.rule.room.server_acl</code></strong></p>
<p><span><strong>[Added in <code>v1.4</code>]</strong></span></p>
<p>Suppresses notifications for <a href="#mroomserver_acl"><code>m.room.server_acl</code></a> events.</p>
<p>Definition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.room.server_acl&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;type&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.server_acl&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;state_key&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong><code>.m.rule.suppress_edits</code></strong></p>
<p><span><strong>[Added in <code>v1.9</code>]</strong></span></p>
<p>Suppresses notifications related to <a href="#event-replacements">event replacements</a>.</p>
<p>Definition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.suppress_edits&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_property_is&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;content.m\\.relates_to.rel_type&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;m.replace&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h5 id="default-content-rules">Default Content Rules</h5>
<p><a id="_m_rule_contains_user_name"/> <strong><code>.m.rule.contains_user_name</code></strong></p>
<p><span><strong>[Changed in <code>v1.7</code>]</strong></span></p>
<p>As of <code>v1.7</code>, this rule is deprecated and <strong>should only be enabled if the event
does not have an <a href="#definition-mmentions"><code>m.mentions</code> property</a></strong>.</p>
<p>Matches any message whose content contains the local part of the user&rsquo;s
Matrix ID, separated by word boundaries.</p>
<p>Definition (as a <code>content</code> rule):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.contains_user_name&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;[the local part of the user&#39;s Matrix ID]&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;sound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;highlight&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h5 id="default-underride-rules">Default Underride Rules</h5>
<p><strong><code>.m.rule.call</code></strong></p>
<p>Matches any incoming VOIP call.</p>
<p>Definition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.call&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;type&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;m.call.invite&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;sound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;ring&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong><code>.m.rule.encrypted_room_one_to_one</code></strong></p>
<p>Matches any encrypted event sent in a room with exactly two members.
Unlike other push rules, this rule cannot be matched against the content
of the event by nature of it being encrypted. This causes the rule to be
an &ldquo;all or nothing&rdquo; match where it either matches <em>all</em> events that are
encrypted (in 1:1 rooms) or none.</p>
<p>Definition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.encrypted_room_one_to_one&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;room_member_count&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;is&#34;</span><span class="p">:</span> <span class="s2">&#34;2&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;type&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.encrypted&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;sound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong><code>.m.rule.room_one_to_one</code></strong></p>
<p>Matches any message sent in a room with exactly two members.</p>
<p>Definition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.room_one_to_one&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;room_member_count&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;is&#34;</span><span class="p">:</span> <span class="s2">&#34;2&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;type&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;sound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong><code>.m.rule.message</code></strong></p>
<p>Matches all chat messages.</p>
<p>Definition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">         <span class="p">{</span>
</span></span><span class="line"><span class="cl">             <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;type&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">],</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;notify&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong><code>.m.rule.encrypted</code></strong></p>
<p>Matches all encrypted events. Unlike other push rules, this rule cannot
be matched against the content of the event by nature of it being
encrypted. This causes the rule to be an &ldquo;all or nothing&rdquo; match where it
either matches <em>all</em> events that are encrypted (in group rooms) or none.</p>
<p>Definition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.encrypted&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">         <span class="p">{</span>
</span></span><span class="line"><span class="cl">             <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;type&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.encrypted&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">],</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;notify&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="push-rules-api">Push Rules: API</h4>
<p>Clients can retrieve, add, modify and remove push rules globally or
per-device using the APIs below.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3pushrules">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/pushrules/</span>
  </h1>
</summary>
  <hr/>
<p>Retrieve all push rulesets for this user. Clients can &ldquo;drill-down&rdquo; on
the rulesets by suffixing a <code>scope</code> to this path e.g.
<code>/pushrules/global/</code>. This will return a subset of this data under the
specified key e.g. the <code>global</code> key.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<p>No request parameters or request body.</p>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>All the push rulesets for this user.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>global</code></td>
  <td><code>Ruleset</code></td>
  <td>
    <strong>Required: </strong>The global ruleset.</td>
 </tr>
</table>
<table id="_matrixclientv3pushrules_ruleset" class="object-table">
 <caption>Ruleset</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>[PushRule]</code></td>
  <td>
    </td>
 </tr>
 <tr>
  <td><code>override</code></td>
  <td><code>[PushRule]</code></td>
  <td>
    </td>
 </tr>
 <tr>
  <td><code>room</code></td>
  <td><code>[PushRule]</code></td>
  <td>
    </td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>[PushRule]</code></td>
  <td>
    </td>
 </tr>
 <tr>
  <td><code>underride</code></td>
  <td><code>[PushRule]</code></td>
  <td>
    </td>
 </tr>
</table>
<table id="_matrixclientv3pushrules_pushrule" class="object-table">
 <caption>PushRule</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>actions</code></td>
  <td><code>[string|object]</code></td>
  <td>
    <strong>Required: </strong>The actions to perform when this rule is matched.</td>
 </tr>
 <tr>
  <td><code>conditions</code></td>
  <td><code>[PushCondition]</code></td>
  <td>
    The conditions that must hold true for an event in order for a rule to be
applied to an event. A rule with no conditions always matches. Only
applicable to <code>underride</code> and <code>override</code> rules.</td>
 </tr>
 <tr>
  <td><code>default</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether this is a default rule, or has been set explicitly.</td>
 </tr>
 <tr>
  <td><code>enabled</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether the push rule is enabled or not.</td>
 </tr>
 <tr>
  <td><code>pattern</code></td>
  <td><code>string</code></td>
  <td>
    The <a href="/appendices#glob-style-matching">glob-style pattern</a> to match against.
Only applicable to <code>content</code> rules.</td>
 </tr>
 <tr>
  <td><code>rule_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of this rule.</td>
 </tr>
</table>
<table id="_matrixclientv3pushrules_pushcondition" class="object-table">
 <caption>PushCondition</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>is</code></td>
  <td><code>string</code></td>
  <td>
    Required for <code>room_member_count</code> conditions. A decimal integer
optionally prefixed by one of, ==, &lt;, &gt;, &gt;= or &lt;=. A prefix of &lt; matches
rooms where the member count is strictly less than the given number and
so forth. If no prefix is present, this parameter defaults to ==.</td>
 </tr>
 <tr>
  <td><code>key</code></td>
  <td><code>string</code></td>
  <td>
    <p>Required for <code>event_match</code> conditions. The dot-separated field of the
event to match.</p>
<p>Required for <code>sender_notification_permission</code> conditions. The field in
the power level event the user needs a minimum power level for. Fields
must be specified under the <code>notifications</code> property in the power level
event&rsquo;s <code>content</code>.</p>
</td>
 </tr>
 <tr>
  <td><code>kind</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The kind of condition to apply. See <a href="/client-server-api/#conditions">conditions</a> for
more information on the allowed kinds and how they work.</td>
 </tr>
 <tr>
  <td><code>pattern</code></td>
  <td><code>string</code></td>
  <td>
    Required for <code>event_match</code> conditions. The <a href="/appendices#glob-style-matching">glob-style pattern</a>
to match against.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;global&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;sound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;highlight&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;alice&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.contains_user_name&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;override&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.master&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;content.msgtype&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;m.notice&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.suppress_notices&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;room&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;underride&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;sound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;ring&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;highlight&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;type&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;m.call.invite&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.call&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;sound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;highlight&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;contains_display_name&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.contains_display_name&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;sound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;highlight&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;is&#34;</span><span class="p">:</span> <span class="s2">&#34;2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;room_member_count&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;type&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.room_one_to_one&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;sound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;highlight&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;type&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;content.membership&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;invite&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;state_key&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.invite_for_me&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;highlight&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;type&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.member_event&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;highlight&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;type&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.message&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3pushrulesscopekindruleid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/pushrules/{scope}/{kind}/{ruleId}</span>
  </h1>
</summary>
  <hr/>
<p>Retrieve a single specified push rule.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>kind</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The kind of rule<p>One of: <code>[override, underride, sender, room, content]</code>.</p></td>
 </tr>
 <tr>
  <td><code>ruleId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The identifier for the rule.</td>
 </tr>
 <tr>
  <td><code>scope</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><code>global</code> to specify global rules.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The specific push rule. This will also include keys specific to the
rule itself such as the rule&rsquo;s <code>actions</code> and <code>conditions</code> if set.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The push rule does not exist.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="_matrixclientv3pushrulesscopekindruleid_pushrule" class="object-table">
 <caption>PushRule</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>actions</code></td>
  <td><code>[string|object]</code></td>
  <td>
    <strong>Required: </strong>The actions to perform when this rule is matched.</td>
 </tr>
 <tr>
  <td><code>conditions</code></td>
  <td><code>[PushCondition]</code></td>
  <td>
    The conditions that must hold true for an event in order for a rule to be
applied to an event. A rule with no conditions always matches. Only
applicable to <code>underride</code> and <code>override</code> rules.</td>
 </tr>
 <tr>
  <td><code>default</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether this is a default rule, or has been set explicitly.</td>
 </tr>
 <tr>
  <td><code>enabled</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether the push rule is enabled or not.</td>
 </tr>
 <tr>
  <td><code>pattern</code></td>
  <td><code>string</code></td>
  <td>
    The <a href="/appendices#glob-style-matching">glob-style pattern</a> to match against.
Only applicable to <code>content</code> rules.</td>
 </tr>
 <tr>
  <td><code>rule_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of this rule.</td>
 </tr>
</table>
<table id="_matrixclientv3pushrulesscopekindruleid_pushcondition" class="object-table">
 <caption>PushCondition</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>is</code></td>
  <td><code>string</code></td>
  <td>
    Required for <code>room_member_count</code> conditions. A decimal integer
optionally prefixed by one of, ==, &lt;, &gt;, &gt;= or &lt;=. A prefix of &lt; matches
rooms where the member count is strictly less than the given number and
so forth. If no prefix is present, this parameter defaults to ==.</td>
 </tr>
 <tr>
  <td><code>key</code></td>
  <td><code>string</code></td>
  <td>
    <p>Required for <code>event_match</code> conditions. The dot-separated field of the
event to match.</p>
<p>Required for <code>sender_notification_permission</code> conditions. The field in
the power level event the user needs a minimum power level for. Fields
must be specified under the <code>notifications</code> property in the power level
event&rsquo;s <code>content</code>.</p>
</td>
 </tr>
 <tr>
  <td><code>kind</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The kind of condition to apply. See <a href="/client-server-api/#conditions">conditions</a> for
more information on the allowed kinds and how they work.</td>
 </tr>
 <tr>
  <td><code>pattern</code></td>
  <td><code>string</code></td>
  <td>
    Required for <code>event_match</code> conditions. The <a href="/appendices#glob-style-matching">glob-style pattern</a>
to match against.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;cake*lie&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;nocake&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3pushrulesscopekindruleid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;The push rule was not found.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixclientv3pushrulesscopekindruleid">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/client/v3/pushrules/{scope}/{kind}/{ruleId}</span>
  </h1>
</summary>
  <hr/>
<p><p>This endpoint allows the creation and modification of user defined push
rules.</p>
<p>If a rule with the same <code>rule_id</code> already exists among rules of the same
kind, it is updated with the new parameters, otherwise a new rule is
created.</p>
<p>If both <code>after</code> and <code>before</code> are provided, the new or updated rule must
be the next most important rule with respect to the rule identified by
<code>before</code>.</p>
<p>If neither <code>after</code> nor <code>before</code> are provided and the rule is created, it
should be added as the most important user defined rule among rules of
the same kind.</p>
<p>When creating push rules, they MUST be enabled by default.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>kind</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The kind of rule<p>One of: <code>[override, underride, sender, room, content]</code>.</p></td>
 </tr>
 <tr>
  <td><code>ruleId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The identifier for the rule. If the string starts with a dot (&quot;.&quot;),
the request MUST be rejected as this is reserved for server-default
rules. Slashes (&quot;/&quot;) and backslashes (&quot;\&quot;) are also not allowed.</td>
 </tr>
 <tr>
  <td><code>scope</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><code>global</code> to specify global rules.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>after</code></td>
  <td><code>string</code></td>
  <td>
    This makes the new rule the next-less important rule relative to the
given user defined rule. It is not possible to add a rule relative
to a predefined server rule.</td>
 </tr>
 <tr>
  <td><code>before</code></td>
  <td><code>string</code></td>
  <td>
    Use &lsquo;before&rsquo; with a <code>rule_id</code> as its value to make the new rule the
next-most important rule with respect to the given user defined rule.
It is not possible to add a rule relative to a predefined server rule.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>actions</code></td>
  <td><code>[string|object]</code></td>
  <td>
    <strong>Required: </strong>The action(s) to perform when the conditions for this rule are met.</td>
 </tr>
 <tr>
  <td><code>conditions</code></td>
  <td><code>[PushCondition]</code></td>
  <td>
    The conditions that must hold true for an event in order for a
rule to be applied to an event. A rule with no conditions
always matches. Only applicable to <code>underride</code> and <code>override</code> rules.</td>
 </tr>
 <tr>
  <td><code>pattern</code></td>
  <td><code>string</code></td>
  <td>
    Only applicable to <code>content</code> rules. The glob-style pattern to match against.</td>
 </tr>
</table>
<table id="_matrixclientv3pushrulesscopekindruleid_pushcondition" class="object-table">
 <caption>PushCondition</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>is</code></td>
  <td><code>string</code></td>
  <td>
    Required for <code>room_member_count</code> conditions. A decimal integer
optionally prefixed by one of, ==, &lt;, &gt;, &gt;= or &lt;=. A prefix of &lt; matches
rooms where the member count is strictly less than the given number and
so forth. If no prefix is present, this parameter defaults to ==.</td>
 </tr>
 <tr>
  <td><code>key</code></td>
  <td><code>string</code></td>
  <td>
    <p>Required for <code>event_match</code> conditions. The dot-separated field of the
event to match.</p>
<p>Required for <code>sender_notification_permission</code> conditions. The field in
the power level event the user needs a minimum power level for. Fields
must be specified under the <code>notifications</code> property in the power level
event&rsquo;s <code>content</code>.</p>
</td>
 </tr>
 <tr>
  <td><code>kind</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The kind of condition to apply. See <a href="/client-server-api/#conditions">conditions</a> for
more information on the allowed kinds and how they work.</td>
 </tr>
 <tr>
  <td><code>pattern</code></td>
  <td><code>string</code></td>
  <td>
    Required for <code>event_match</code> conditions. The <a href="/appendices#glob-style-matching">glob-style pattern</a>
to match against.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;notify&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;cake*lie&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The push rule was created/updated.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td>There was a problem configuring this push rule.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The push rule does not exist (when updating a push rule).</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3pushrulesscopekindruleid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_UNKNOWN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;before/after rule not found: someRuleId&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3pushrulesscopekindruleid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;The push rule was not found.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3pushrulesscopekindruleid_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api DELETE">
<details open>
<summary>
  <h1 id="delete_matrixclientv3pushrulesscopekindruleid">
   <span class="http-api-method DELETE">DELETE</span>
   <span class="endpoint">/_matrix/client/v3/pushrules/{scope}/{kind}/{ruleId}</span>
  </h1>
</summary>
  <hr/>
<p>This endpoint removes the push rule defined in the path.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>kind</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The kind of rule<p>One of: <code>[override, underride, sender, room, content]</code>.</p></td>
 </tr>
 <tr>
  <td><code>ruleId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The identifier for the rule.</td>
 </tr>
 <tr>
  <td><code>scope</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><code>global</code> to specify global rules.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The push rule was deleted.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The push rule does not exist.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3pushrulesscopekindruleid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;The push rule was not found.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3pushrulesscopekindruleidactions">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/pushrules/{scope}/{kind}/{ruleId}/actions</span>
  </h1>
</summary>
  <hr/>
<p>This endpoint get the actions for the specified push rule.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>kind</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The kind of rule<p>One of: <code>[override, underride, sender, room, content]</code>.</p></td>
 </tr>
 <tr>
  <td><code>ruleId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The identifier for the rule.</td>
 </tr>
 <tr>
  <td><code>scope</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Either <code>global</code> or <code>device/&lt;profile_tag&gt;</code> to specify global
rules or device rules for the given <code>profile_tag</code>.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The actions for this push rule.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The push rule does not exist.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>actions</code></td>
  <td><code>[string|object]</code></td>
  <td>
    <strong>Required: </strong>The action(s) to perform for this rule.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;sound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;bing&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3pushrulesscopekindruleidactions_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;The push rule was not found.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixclientv3pushrulesscopekindruleidactions">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/client/v3/pushrules/{scope}/{kind}/{ruleId}/actions</span>
  </h1>
</summary>
  <hr/>
<p>This endpoint allows clients to change the actions of a push rule.
This can be used to change the actions of builtin rules.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>kind</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The kind of rule<p>One of: <code>[override, underride, sender, room, content]</code>.</p></td>
 </tr>
 <tr>
  <td><code>ruleId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The identifier for the rule.</td>
 </tr>
 <tr>
  <td><code>scope</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><code>global</code> to specify global rules.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>actions</code></td>
  <td><code>[string|object]</code></td>
  <td>
    <strong>Required: </strong>The action(s) to perform for this rule.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;highlight&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The actions for the push rule were set.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The push rule does not exist.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3pushrulesscopekindruleidactions_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;The push rule was not found.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3pushrulesscopekindruleidenabled">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/pushrules/{scope}/{kind}/{ruleId}/enabled</span>
  </h1>
</summary>
  <hr/>
<p>This endpoint gets whether the specified push rule is enabled.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>kind</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The kind of rule<p>One of: <code>[override, underride, sender, room, content]</code>.</p></td>
 </tr>
 <tr>
  <td><code>ruleId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The identifier for the rule.</td>
 </tr>
 <tr>
  <td><code>scope</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Either <code>global</code> or <code>device/&lt;profile_tag&gt;</code> to specify global
rules or device rules for the given <code>profile_tag</code>.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>Whether the push rule is enabled.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The push rule does not exist.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>enabled</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether the push rule is enabled or not.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3pushrulesscopekindruleidenabled_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;The push rule was not found.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixclientv3pushrulesscopekindruleidenabled">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/client/v3/pushrules/{scope}/{kind}/{ruleId}/enabled</span>
  </h1>
</summary>
  <hr/>
<p>This endpoint allows clients to enable or disable the specified push rule.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>kind</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The kind of rule<p>One of: <code>[override, underride, sender, room, content]</code>.</p></td>
 </tr>
 <tr>
  <td><code>ruleId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The identifier for the rule.</td>
 </tr>
 <tr>
  <td><code>scope</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><code>global</code> to specify global rules.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>enabled</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether the push rule is enabled or not.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The push rule was enabled or disabled.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The push rule does not exist.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3pushrulesscopekindruleidenabled_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;The push rule was not found.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h4 id="push-rules-events">Push Rules: Events</h4>
<p>When a user changes their push rules a <code>m.push_rules</code> event is sent to
all clients in the <code>account_data</code> section of their next <a href="#get_matrixclientv3sync"><code>/sync</code></a> request.
The content of the event is the current push rules for the user.</p>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mpush_rules">
   <code>m.push_rules</code>
  </h1>
</summary>
  <hr/>
<p>Describes all push rules for this user.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>global</code></td>
  <td><code>Ruleset</code></td>
  <td>
    The global ruleset</td>
 </tr>
</table>
<table id="mpush_rules_ruleset" class="object-table">
 <caption>Ruleset</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>[PushRule]</code></td>
  <td>
    </td>
 </tr>
 <tr>
  <td><code>override</code></td>
  <td><code>[PushRule]</code></td>
  <td>
    </td>
 </tr>
 <tr>
  <td><code>room</code></td>
  <td><code>[PushRule]</code></td>
  <td>
    </td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>[PushRule]</code></td>
  <td>
    </td>
 </tr>
 <tr>
  <td><code>underride</code></td>
  <td><code>[PushRule]</code></td>
  <td>
    </td>
 </tr>
</table>
<table id="mpush_rules_pushrule" class="object-table">
 <caption>PushRule</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>actions</code></td>
  <td><code>[string|object]</code></td>
  <td>
    <strong>Required: </strong>The actions to perform when this rule is matched.</td>
 </tr>
 <tr>
  <td><code>conditions</code></td>
  <td><code>[PushCondition]</code></td>
  <td>
    The conditions that must hold true for an event in order for a rule to be
applied to an event. A rule with no conditions always matches. Only
applicable to <code>underride</code> and <code>override</code> rules.</td>
 </tr>
 <tr>
  <td><code>default</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether this is a default rule, or has been set explicitly.</td>
 </tr>
 <tr>
  <td><code>enabled</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether the push rule is enabled or not.</td>
 </tr>
 <tr>
  <td><code>pattern</code></td>
  <td><code>string</code></td>
  <td>
    The <a href="/appendices#glob-style-matching">glob-style pattern</a> to match against.
Only applicable to <code>content</code> rules.</td>
 </tr>
 <tr>
  <td><code>rule_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of this rule.</td>
 </tr>
</table>
<table id="mpush_rules_pushcondition" class="object-table">
 <caption>PushCondition</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>is</code></td>
  <td><code>string</code></td>
  <td>
    Required for <code>room_member_count</code> conditions. A decimal integer
optionally prefixed by one of, ==, &lt;, &gt;, &gt;= or &lt;=. A prefix of &lt; matches
rooms where the member count is strictly less than the given number and
so forth. If no prefix is present, this parameter defaults to ==.</td>
 </tr>
 <tr>
  <td><code>key</code></td>
  <td><code>string</code></td>
  <td>
    <p>Required for <code>event_match</code> conditions. The dot-separated field of the
event to match.</p>
<p>Required for <code>sender_notification_permission</code> conditions. The field in
the power level event the user needs a minimum power level for. Fields
must be specified under the <code>notifications</code> property in the power level
event&rsquo;s <code>content</code>.</p>
</td>
 </tr>
 <tr>
  <td><code>kind</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The kind of condition to apply. See <a href="/client-server-api/#conditions">conditions</a> for
more information on the allowed kinds and how they work.</td>
 </tr>
 <tr>
  <td><code>pattern</code></td>
  <td><code>string</code></td>
  <td>
    Required for <code>event_match</code> conditions. The <a href="/appendices#glob-style-matching">glob-style pattern</a>
to match against.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;global&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;sound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;highlight&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;alice&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.contains_user_name&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;override&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.master&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;content.msgtype&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;m.notice&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.suppress_notices&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;underride&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;sound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;ring&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;highlight&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;type&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;m.call.invite&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.call&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;sound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;highlight&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;contains_display_name&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.contains_display_name&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;sound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;highlight&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;is&#34;</span><span class="p">:</span> <span class="s2">&#34;2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;room_member_count&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;type&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.room_one_to_one&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;sound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;highlight&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;type&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;content.membership&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;invite&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;state_key&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.invite_for_me&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;highlight&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;type&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.member_event&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;notify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;set_tweak&#34;</span><span class="p">:</span> <span class="s2">&#34;highlight&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;conditions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;type&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;event_match&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;rule_id&#34;</span><span class="p">:</span> <span class="s2">&#34;.m.rule.message&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.push_rules&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h5 id="examples">Examples</h5>
<p>To create a rule that suppresses notifications for the room with ID
<code>!dj234r78wl45Gh4D:matrix.org</code>:</p>
<pre><code>curl -X PUT -H &quot;Content-Type: application/json&quot; &quot;https://example.com/_matrix/client/v3/pushrules/global/room/%21dj234r78wl45Gh4D%3Amatrix.org?access_token=123456&quot; -d \
'{
   &quot;actions&quot; : []
 }'
</code></pre>
<p>To suppress notifications for the user <code>@spambot:matrix.org</code>:</p>
<pre><code>curl -X PUT -H &quot;Content-Type: application/json&quot; &quot;https://example.com/_matrix/client/v3/pushrules/global/sender/%40spambot%3Amatrix.org?access_token=123456&quot; -d \
'{
   &quot;actions&quot; : []
 }'
</code></pre>
<p>To always notify for messages that contain the work &lsquo;cake&rsquo; and set a
specific sound (with a rule_id of <code>SSByZWFsbHkgbGlrZSBjYWtl</code>):</p>
<pre><code>curl -X PUT -H &quot;Content-Type: application/json&quot; &quot;https://example.com/_matrix/client/v3/pushrules/global/content/SSByZWFsbHkgbGlrZSBjYWtl?access_token=123456&quot; -d \
'{
   &quot;pattern&quot;: &quot;cake&quot;,
   &quot;actions&quot; : [&quot;notify&quot;, {&quot;set_tweak&quot;:&quot;sound&quot;, &quot;value&quot;:&quot;cakealarm.wav&quot;}]
 }'
</code></pre>
<p>To add a rule suppressing notifications for messages starting with
&lsquo;cake&rsquo; but ending with &rsquo;lie&rsquo;, superseding the previous rule:</p>
<pre><code>curl -X PUT -H &quot;Content-Type: application/json&quot; &quot;https://example.com/_matrix/client/v3/pushrules/global/content/U3BvbmdlIGNha2UgaXMgYmVzdA?access_token=123456&amp;before=SSByZWFsbHkgbGlrZSBjYWtl&quot; -d \
'{
   &quot;pattern&quot;: &quot;cake*lie&quot;,
   &quot;actions&quot; : [&quot;notify&quot;]
 }'
</code></pre>
<p>To add a custom sound for notifications messages containing the word
&lsquo;beer&rsquo; in any rooms with 10 members or fewer (with greater importance
than the room, sender and content rules):</p>
<pre><code>curl -X PUT -H &quot;Content-Type: application/json&quot; &quot;https://example.com/_matrix/client/v3/pushrules/global/override/U2VlIHlvdSBpbiBUaGUgRHVrZQ?access_token=123456&quot; -d \
'{
   &quot;conditions&quot;: [
     {&quot;kind&quot;: &quot;event_match&quot;, &quot;key&quot;: &quot;content.body&quot;, &quot;pattern&quot;: &quot;beer&quot; },
     {&quot;kind&quot;: &quot;room_member_count&quot;, &quot;is&quot;: &quot;&lt;=10&quot;}
   ],
   &quot;actions&quot; : [
     &quot;notify&quot;,
     {&quot;set_tweak&quot;:&quot;sound&quot;, &quot;value&quot;:&quot;beeroclock.wav&quot;}
   ]
 }'
</code></pre>
<h4 id="client-behaviour">Client behaviour</h4>
<p>Clients MUST configure a Pusher before they will receive push
notifications. There is a single API endpoint for this, as described
below.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3pushers">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/pushers</span>
  </h1>
</summary>
  <hr/>
<p>Gets all currently active pushers for the authenticated user.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<p>No request parameters or request body.</p>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The pushers for this user.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>pushers</code></td>
  <td><code>[Pusher]</code></td>
  <td>
    An array containing the current pushers for the user</td>
 </tr>
</table>
<table id="_matrixclientv3pushers_pusher" class="object-table">
 <caption>Pusher</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>app_display_name</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A string that will allow the user to identify what application
owns this pusher.</td>
 </tr>
 <tr>
  <td><code>app_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>This is a reverse-DNS style identifier for the application.
Max length, 64 chars.</td>
 </tr>
 <tr>
  <td><code>data</code></td>
  <td><code>PusherData</code></td>
  <td>
    <strong>Required: </strong>A dictionary of information for the pusher implementation
itself.</td>
 </tr>
 <tr>
  <td><code>device_display_name</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A string that will allow the user to identify what device owns
this pusher.</td>
 </tr>
 <tr>
  <td><code>kind</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The kind of pusher. <code>&quot;http&quot;</code> is a pusher that
sends HTTP pokes.</td>
 </tr>
 <tr>
  <td><code>lang</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The preferred language for receiving notifications (e.g. &rsquo;en'
or &rsquo;en-US')</td>
 </tr>
 <tr>
  <td><code>profile_tag</code></td>
  <td><code>string</code></td>
  <td>
    This string determines which set of device specific rules this
pusher executes.</td>
 </tr>
 <tr>
  <td><code>pushkey</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>This is a unique identifier for this pusher. See <code>/set</code> for
more detail.
Max length, 512 bytes.</td>
 </tr>
</table>
<table id="_matrixclientv3pushers_pusherdata" class="object-table">
 <caption>PusherData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>format</code></td>
  <td><code>string</code></td>
  <td>
    The format to use when sending notifications to the Push
Gateway.</td>
 </tr>
 <tr>
  <td><code>url</code></td>
  <td><code>string</code></td>
  <td>
    Required if <code>kind</code> is <code>http</code>. The URL to use to send
notifications to.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;pushers&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;app_display_name&#34;</span><span class="p">:</span> <span class="s2">&#34;Appy McAppface&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;app_id&#34;</span><span class="p">:</span> <span class="s2">&#34;face.mcapp.appy.prod&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;data&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://example.com/_matrix/push/v1/notify&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;device_display_name&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice&#39;s Phone&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;http&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;lang&#34;</span><span class="p">:</span> <span class="s2">&#34;en-US&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;profile_tag&#34;</span><span class="p">:</span> <span class="s2">&#34;xyz&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;pushkey&#34;</span><span class="p">:</span> <span class="s2">&#34;Xp/MzCt8/9DcSNE9cuiaoT5Ac55job3TdLSSmtmYl4A=&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3pushersset">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/pushers/set</span>
  </h1>
</summary>
  <hr/>
<p><p>This endpoint allows the creation, modification and deletion of <a href="/client-server-api/#push-notifications">pushers</a>
for this user ID. The behaviour of this endpoint varies depending on the
values in the JSON body.</p>
<p>If <code>kind</code> is not <code>null</code>, the pusher with this <code>app_id</code> and <code>pushkey</code>
for this user is updated, or it is created if it doesn&rsquo;t exist. If
<code>kind</code> is <code>null</code>, the pusher with this <code>app_id</code> and <code>pushkey</code> for this
user is deleted.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>app_display_name</code></td>
  <td><code>string</code></td>
  <td>
    Required if <code>kind</code> is not <code>null</code>. A string that will allow the
user to identify what application owns this pusher.</td>
 </tr>
 <tr>
  <td><code>app_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><p>This is a reverse-DNS style identifier for the application.
It is recommended that this end with the platform, such that
different platform versions get different app identifiers.
Max length, 64 chars.</p>
<p>If the <code>kind</code> is <code>&quot;email&quot;</code>, this is <code>&quot;m.email&quot;</code>.</p>
</td>
 </tr>
 <tr>
  <td><code>append</code></td>
  <td><code>boolean</code></td>
  <td>
    If true, the homeserver should add another pusher with the
given pushkey and App ID in addition to any others with
different user IDs. Otherwise, the homeserver must remove any
other pushers with the same App ID and pushkey for different
users. The default is <code>false</code>.</td>
 </tr>
 <tr>
  <td><code>data</code></td>
  <td><code>PusherData</code></td>
  <td>
    Required if <code>kind</code> is not <code>null</code>. A dictionary of information
for the pusher implementation itself. If <code>kind</code> is <code>http</code>,
this should contain <code>url</code> which is the URL to use to send
notifications to.</td>
 </tr>
 <tr>
  <td><code>device_display_name</code></td>
  <td><code>string</code></td>
  <td>
    Required if <code>kind</code> is not <code>null</code>. A string that will allow the
user to identify what device owns this pusher.</td>
 </tr>
 <tr>
  <td><code>kind</code></td>
  <td><code>[string null]</code></td>
  <td>
    <strong>Required: </strong>The kind of pusher to configure. <code>&quot;http&quot;</code> makes a pusher that
sends HTTP pokes. <code>&quot;email&quot;</code> makes a pusher that emails the
user with unread notifications. <code>null</code> deletes the pusher.</td>
 </tr>
 <tr>
  <td><code>lang</code></td>
  <td><code>string</code></td>
  <td>
    Required if <code>kind</code> is not <code>null</code>. The preferred language for
receiving notifications (e.g. &rsquo;en&rsquo; or &rsquo;en-US&rsquo;).</td>
 </tr>
 <tr>
  <td><code>profile_tag</code></td>
  <td><code>string</code></td>
  <td>
    This string determines which set of device specific rules this
pusher executes.</td>
 </tr>
 <tr>
  <td><code>pushkey</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><p>This is a unique identifier for this pusher. The value you
should use for this is the routing or destination address
information for the notification, for example, the APNS token
for APNS or the Registration ID for GCM. If your notification
client has no such concept, use any unique identifier.
Max length, 512 bytes.</p>
<p>If the <code>kind</code> is <code>&quot;email&quot;</code>, this is the email address to
send notifications to.</p>
</td>
 </tr>
</table>
<table id="_matrixclientv3pushersset_pusherdata" class="object-table">
 <caption>PusherData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>format</code></td>
  <td><code>string</code></td>
  <td>
    The format to send notifications in to Push Gateways if the
<code>kind</code> is <code>http</code>. The details about what fields the
homeserver should send to the push gateway are defined in the
<a href="/push-gateway-api/">Push Gateway Specification</a>. Currently the only format
available is &rsquo;event_id_only'.</td>
 </tr>
 <tr>
  <td><code>url</code></td>
  <td><code>string</code></td>
  <td>
    Required if <code>kind</code> is <code>http</code>. The URL to use to send
notifications to. MUST be an HTTPS URL with a path of
<code>/_matrix/push/v1/notify</code>.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;app_display_name&#34;</span><span class="p">:</span> <span class="s2">&#34;Mat Rix&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;app_id&#34;</span><span class="p">:</span> <span class="s2">&#34;com.example.app.ios&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;append&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;data&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;event_id_only&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://push-gateway.location.here/_matrix/push/v1/notify&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;device_display_name&#34;</span><span class="p">:</span> <span class="s2">&#34;iPhone 9&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;http&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;lang&#34;</span><span class="p">:</span> <span class="s2">&#34;en&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;profile_tag&#34;</span><span class="p">:</span> <span class="s2">&#34;xxyyzz&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;pushkey&#34;</span><span class="p">:</span> <span class="s2">&#34;APA91bHPRgkF3JUikC4ENAHEeMrd41Zxv3hVZjC9KtT8OvPVGJ-hQMRKRrZuJAEcl7B338qju59zJMjw2DELjzEvxwYv7hH5Ynpc1ODQ0aT4U4OFEeco8ohsN5PjL1iC2dNtk2BAokeMCg2ZXKqpc8FXKmhX94kIxQ&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The pusher was set.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td>One or more of the pusher values were invalid.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3pushersset_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_MISSING_PARAM&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Missing parameters: lang, data&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3pushersset_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h5 id="listing-notifications">Listing Notifications</h5>
<p>A client can retrieve a list of events that it has been notified about.
This may be useful so that users can see a summary of what important
messages they have received.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3notifications">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/notifications</span>
  </h1>
</summary>
  <hr/>
<p>This API is used to paginate through the list of events that the
user has been, or would have been notified about.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>from</code></td>
  <td><code>string</code></td>
  <td>
    Pagination token to continue from. This should be the <code>next_token</code>
returned from an earlier call to this endpoint.</td>
 </tr>
 <tr>
  <td><code>limit</code></td>
  <td><code>integer</code></td>
  <td>
    Limit on the number of events to return in this request.</td>
 </tr>
 <tr>
  <td><code>only</code></td>
  <td><code>string</code></td>
  <td>
    Allows basic filtering of events returned. Supply <code>highlight</code>
to return only events where the notification had the highlight
tweak set.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>A batch of events is being returned</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>next_token</code></td>
  <td><code>string</code></td>
  <td>
    The token to supply in the <code>from</code> param of the next
<code>/notifications</code> request in order to request more
events. If this is absent, there are no more results.</td>
 </tr>
 <tr>
  <td><code>notifications</code></td>
  <td><code>[Notification]</code></td>
  <td>
    <strong>Required: </strong>The list of events that triggered notifications.</td>
 </tr>
</table>
<table id="_matrixclientv3notifications_notification" class="object-table">
 <caption>Notification</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>actions</code></td>
  <td><code>[object|string]</code></td>
  <td>
    <strong>Required: </strong>The action(s) to perform when the conditions for this rule are met.
See <a href="/client-server-api/#push-rules-api">Push Rules: API</a>.</td>
 </tr>
 <tr>
  <td><code>event</code></td>
  <td><code>Event</code></td>
  <td>
    <strong>Required: </strong>The Event object for the event that triggered the notification.</td>
 </tr>
 <tr>
  <td><code>profile_tag</code></td>
  <td><code>string</code></td>
  <td>
    The profile tag of the rule that matched this event.</td>
 </tr>
 <tr>
  <td><code>read</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Indicates whether the user has sent a read receipt indicating
that they have read this message.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room in which the event was posted.</td>
 </tr>
 <tr>
  <td><code>ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The unix timestamp at which the event notification was sent,
in milliseconds.</td>
 </tr>
</table>
<table id="_matrixclientv3notifications_event" class="object-table">
 <caption>Event</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The body of this event, as created by the client which sent it.</td>
 </tr>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The globally unique identifier for this event.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>Timestamp (in milliseconds since the unix epoch) on originating homeserver
when this event was sent.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Contains the fully-qualified ID of the user who sent this event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <p>Present if, and only if, this event is a <em>state</em> event. The key making
this piece of state unique in the room. Note that it is often an empty
string.</p>
<p>State keys starting with an <code>@</code> are reserved for referencing user IDs, such
as room members. With the exception of a few events, state events set with a
given user&rsquo;s ID as the state key MUST only be set by that user.</p>
</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of the event.</td>
 </tr>
 <tr>
  <td><code>unsigned</code></td>
  <td><code>UnsignedData</code></td>
  <td>
    Contains optional extra information about the event.</td>
 </tr>
</table>
<table id="_matrixclientv3notifications_unsigneddata" class="object-table">
 <caption>UnsignedData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>age</code></td>
  <td><code>integer</code></td>
  <td>
    The time in milliseconds that has elapsed since the event was sent. This field is generated by the local homeserver, and may be incorrect if the local time on at least one of the two servers is out of sync, which can cause the age to either be negative or greater than it actually is.</td>
 </tr>
 <tr>
  <td><code>prev_content</code></td>
  <td><code>EventContent</code></td>
  <td>
    The previous <code>content</code> for this event. This field is generated
by the local homeserver, and is only returned if the event is a state event,
and the client has permission to see the previous content.<br><br>
    <strong>
      Changed in <code>v1.2</code>:
    </strong>
    Previously, this field was specified at the top level of returned
events rather than in <code>unsigned</code> (with the exception of the <a href="/client-server-api/#get_matrixclientv3notifications"><code>GET .../notifications</code></a>
endpoint), though in practice no known server implementations honoured
this.
</td>
 </tr>
 <tr>
  <td><code>redacted_because</code></td>
  <td><code>ClientEventWithoutRoomID</code></td>
  <td>
    The event that redacted this event, if any.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    The client-supplied <a href="/client-server-api/#transaction-identifiers">transaction ID</a>, for example, provided via
<code>PUT /_matrix/client/v3/rooms/{roomId}/send/{eventType}/{txnId}</code>,
if the client being given the event is the same one which sent it.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;next_token&#34;</span><span class="p">:</span> <span class="s2">&#34;abcdef&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;notifications&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;notify&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;This is an example text message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;org.matrix.custom.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;formatted_body&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;b&gt;This is an example text message&lt;/b&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;profile_tag&#34;</span><span class="p">:</span> <span class="s2">&#34;hcbvkzxhcvb&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;read&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!abcdefg:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;ts&#34;</span><span class="p">:</span> <span class="mi">1475508881945</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h5 id="receiving-notifications">Receiving notifications</h5>
<p>Servers MUST include the number of unread notifications in a client&rsquo;s
<code>/sync</code> stream, and MUST update it as it changes. Notifications are
determined by the push rules which apply to an event.</p>
<p>For encrypted events, the homeserver has limited access to the event content
and properly processing push rules falls on the client. Clients should process
push rules for each incoming event <em>after decrypting</em> them. This may result in
needing to modify the number of unread notifications received from the homeserver.</p>
<h5 id="marking-notifications-as-read">Marking notifications as read</h5>
<p>When the user updates their read receipt (either by using the API or by
sending an event), notifications prior to and including that event MUST
be marked as read. Which specific events are affected can vary depending
on whether a <a href="#threaded-read-receipts">threaded read receipt</a> was used.
Note that users can send both an <code>m.read</code> and <code>m.read.private</code> receipt,
both of which are capable of clearing notifications.</p>
<p>If the user has both <code>m.read</code> and <code>m.read.private</code> set in the room then
the receipt which is more recent/ahead must be used to determine where
the user has read up to. For example, given an oldest-first set of events A,
B, C, and D the <code>m.read</code> receipt could be at event C and <code>m.read.private</code>
at event A - the user is considered to have read up to event C. If the
<code>m.read.private</code> receipt is then updated to point to B or C, the user&rsquo;s
notification state doesn&rsquo;t change (the <code>m.read</code> receipt is still more
ahead), however if the <code>m.read.private</code> receipt were to be updated to
event D then the user has read up to D (the <code>m.read</code> receipt is now
behind the <code>m.read.private</code> receipt).</p>
<p>



  <span><strong>[Added in <code>v1.4</code>]</strong></span>
 
 When handling threaded read receipts, the server
is to partition the notification count to each thread (with the main timeline
being its own thread). To determine if an event is part of a thread the
server follows the <a href="#forming-relationships-between-events">event relationship</a>
until it finds a thread root (as specified by the <a href="#threading">threading module</a>),
however it is not recommended that the server traverse infinitely. Instead,
implementations are encouraged to do a maximum of 3 hops to find a thread
before deciding that the event does not belong to a thread. This is primarily
to ensure that future events, like <code>m.reaction</code>, are correctly considered
&ldquo;part of&rdquo; a given thread.</p>
<h4 id="server-behaviour">Server behaviour</h4>
<p>When receiving a new event homeservers process push rules for each of the local
users in the room (excluding the sender). This may result in:</p>
<ul>
<li>Generating a new number of unread notifications for the user.</li>
<li>Making a request to the configured push gateway.</li>
</ul>
<p>The updated notification count from a new event MUST appear in the same <code>/sync</code>
response as the event itself.</p>
<h4 id="push-gateway-behaviour">Push Gateway behaviour</h4>
<h5 id="recommendations-for-apns">Recommendations for APNS</h5>
<p>The exact format for sending APNS notifications is flexible and up to
the client app and its push gateway to agree on. As APNS requires that
the sender has a private key owned by the app developer, each app must
have its own push gateway. It is recommended that:</p>
<ul>
<li>The APNS token be base64 encoded and used as the pushkey.</li>
<li>A different app_id be used for apps on the production and sandbox
APS environments.</li>
<li>APNS push gateways do not attempt to wait for errors from the APNS
gateway before returning and instead to store failures and return
&lsquo;rejected&rsquo; responses next time that pushkey is used.</li>
</ul>
<h4 id="security-considerations">Security considerations</h4>
<p>Clients specify the Push Gateway URL to use to send event notifications
to. This URL should be over HTTPS and <em>never</em> over HTTP.</p>
<p>As push notifications will pass through a Push Provider, message content
shouldn&rsquo;t be sent in the push itself where possible. Instead, Push
Gateways should send a &ldquo;sync&rdquo; command to instruct the client to get new
events from the homeserver directly.</p>

    







    
<h3 id="third-party-invites">Third-party invites</h3>
<p>This module adds in support for inviting new members to a room where
their Matrix user ID is not known, instead addressing them by a third-party
identifier such as an email address. There are two flows here; one
if a Matrix user ID is known for the third-party identifier, and one if
not. Either way, the client calls <code>/invite</code> with the details of the
third-party identifier.</p>
<p>The homeserver asks the identity server whether a Matrix user ID is
known for that identifier:</p>
<ul>
<li>If it is, an invite is simply issued for that user.</li>
<li>If it is not, the homeserver asks the identity server to record the
details of the invitation, and to notify the invitee&rsquo;s homeserver of
this pending invitation if it gets a binding for this identifier in
the future. The identity server returns a token and public key to
the inviting homeserver.</li>
</ul>
<p>When the invitee&rsquo;s homeserver receives the notification of the binding,
it should insert an <code>m.room.member</code> event into the room&rsquo;s graph for that
user, with <code>content.membership</code> = <code>invite</code>, as well as a
<code>content.third_party_invite</code> property which contains proof that the
invitee does indeed own that third-party identifier. See the
<a href="#mroommember">m.room.member</a> schema for more information.</p>
<h4 id="events">Events</h4>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mroomthird_party_invite">
   <code>m.room.third_party_invite</code>
  </h1>
</summary>
  <hr/>
<p>Acts as an <code>m.room.member</code> invite event, where there isnt a target user_id to invite. This event contains a token and a public key whose private key must be used to sign the token. Any user who can present that signature may use this invitation to join the target room.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>State event</td>
  </tr>
  <tr>
   <th>State key</th>
   <td>The token, of which a signature must be produced in order to join the room.</td>
 </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>display_name</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A user-readable string which represents the user who has been invited. This should not contain the user&rsquo;s third-party ID, as otherwise when the invite is accepted it would leak the association between the matrix ID and the third-party ID.</td>
 </tr>
 <tr>
  <td><code>key_validity_url</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A URL which can be fetched, with querystring public_key=public_key, to validate whether the key has been revoked. The URL must return a JSON object containing a boolean property named &lsquo;valid&rsquo;.</td>
 </tr>
 <tr>
  <td><code>public_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A base64-encoded ed25519 key with which token must be signed (though a signature from any entry in public_keys is also sufficient). This exists for backwards compatibility.</td>
 </tr>
 <tr>
  <td><code>public_keys</code></td>
  <td><code>[PublicKeys]</code></td>
  <td>
    Keys with which the token may be signed.</td>
 </tr>
</table>
<table id="mroomthird_party_invite_publickeys" class="object-table">
 <caption>PublicKeys</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>key_validity_url</code></td>
  <td><code>string</code></td>
  <td>
    An optional URL which can be fetched, with querystring public_key=public_key, to validate whether the key has been revoked. The URL must return a JSON object containing a boolean property named &lsquo;valid&rsquo;. If this URL is absent, the key must be considered valid indefinitely.</td>
 </tr>
 <tr>
  <td><code>public_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A base-64 encoded ed25519 key with which token may be signed.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;display_name&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice Margatroid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;key_validity_url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://magic.forest/verifykey&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;public_key&#34;</span><span class="p">:</span> <span class="s2">&#34;abc123&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;public_keys&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;key_validity_url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://magic.forest/verifykey&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;public_key&#34;</span><span class="p">:</span> <span class="s2">&#34;def456&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;pc98&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.third_party_invite&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h4 id="client-behaviour">Client behaviour</h4>
<p>A client asks a server to invite a user by their third-party identifier.</p>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3roomsroomidinvite">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/rooms/{roomId}/invite</span>
  </h1>
</summary>
  <hr/>
<p><p><em>Note that there are two forms of this API, which are documented separately.
This version of the API does not require that the inviter know the Matrix
identifier of the invitee, and instead relies on third-party identifiers.
The homeserver uses an identity server to perform the mapping from
third-party identifier to a Matrix identifier. The other is documented in the</em>
<a href="/client-server-api/#post_matrixclientv3roomsroomidinvite">joining rooms section</a>.</p>
<p>This API invites a user to participate in a particular room.
They do not start participating in the room until they actually join the
room.</p>
<p>Only users currently in a particular room can invite other users to
join that room.</p>
<p>If the identity server did know the Matrix user identifier for the
third-party identifier, the homeserver will append a <code>m.room.member</code>
event to the room.</p>
<p>If the identity server does not know a Matrix user identifier for the
passed third-party identifier, the homeserver will issue an invitation
which can be accepted upon providing proof of ownership of the third-
party identifier. This is achieved by the identity server generating a
token, which it gives to the inviting homeserver. The homeserver will
add an <code>m.room.third_party_invite</code> event into the graph for the room,
containing that token.</p>
<p>When the invitee binds the invited third-party identifier to a Matrix
user ID, the identity server will give the user a list of pending
invitations, each containing:</p>
<ul>
<li>
<p>The room ID to which they were invited</p>
</li>
<li>
<p>The token given to the homeserver</p>
</li>
<li>
<p>A signature of the token, signed with the identity server&rsquo;s private key</p>
</li>
<li>
<p>The matrix user ID who invited them to the room</p>
</li>
</ul>
<p>If a token is requested from the identity server, the homeserver will
append a <code>m.room.third_party_invite</code> event to the room.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room identifier (not alias) to which to invite the user.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>address</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The invitee&rsquo;s third-party identifier.</td>
 </tr>
 <tr>
  <td><code>id_access_token</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An access token previously registered with the identity server. Servers
can treat this as optional to distinguish between r0.5-compatible clients
and this specification version.</td>
 </tr>
 <tr>
  <td><code>id_server</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The hostname+port of the identity server which should be used for third-party identifier lookups.</td>
 </tr>
 <tr>
  <td><code>medium</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The kind of address being passed in the address field, for example
<code>email</code> (see <a href="/appendices/#3pid-types">the list of recognised values</a>).</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;cheeky@monkey.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;id_access_token&#34;</span><span class="p">:</span> <span class="s2">&#34;abc123_OpaqueString&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;id_server&#34;</span><span class="p">:</span> <span class="s2">&#34;matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;medium&#34;</span><span class="p">:</span> <span class="s2">&#34;email&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The user has been invited to join the room.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td><p>You do not have permission to invite the user to the room. A meaningful <code>errcode</code> and description error text will be returned. Example reasons for rejections are:</p>
<ul>
<li>The invitee has been banned from the room.</li>
<li>The invitee is already a member of the room.</li>
<li>The inviter is not currently in the room.</li>
<li>The inviter&rsquo;s power level is insufficient to invite users to the room.</li>
</ul>
</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3roomsroomidinvite_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;@cheeky_monkey:matrix.org is banned from the room&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3roomsroomidinvite_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h4 id="server-behaviour">Server behaviour</h4>
<p>Upon receipt of an <code>/invite</code>, the server is expected to look up the
third-party identifier with the provided identity server. If the lookup
yields a result for a Matrix User ID then the normal invite process can
be initiated. This process ends up looking like this:</p>
<pre tabindex="0"><code>    +---------+                         +-------------+                                    +-----------------+
    | Client  |                         | Homeserver  |                                    | IdentityServer  |
    +---------+                         +-------------+                                    +-----------------+
        |                                     |                                                    |
        | POST /invite                        |                                                    |
        |------------------------------------&gt;|                                                    |
        |                                     |                                                    |
        |                                     | GET /lookup                                        |
        |                                     |---------------------------------------------------&gt;|
        |                                     |                                                    |
        |                                     |                                     User ID result |
        |                                     |&lt;---------------------------------------------------|
        |                                     |                                                    |
        |                                     | Invite process for the discovered User ID          |
        |                                     |------------------------------------------          |
        |                                     |                                         |          |
        |                                     |&lt;-----------------------------------------          |
        |                                     |                                                    |
        |        Complete the /invite request |                                                    |
        |&lt;------------------------------------|                                                    |
        |                                     |                                                    |
</code></pre><p>However, if the lookup does not yield a bound User ID, the homeserver
must store the invite on the identity server and emit a valid
<code>m.room.third_party_invite</code> event to the room. This process ends up
looking like this:</p>
<pre tabindex="0"><code>    +---------+                         +-------------+                                               +-----------------+
    | Client  |                         | Homeserver  |                                               | IdentityServer  |
    +---------+                         +-------------+                                               +-----------------+
        |                                     |                                                               |
        | POST /invite                        |                                                               |
        |------------------------------------&gt;|                                                               |
        |                                     |                                                               |
        |                                     | GET /lookup                                                   |
        |                                     |--------------------------------------------------------------&gt;|
        |                                     |                                                               |
        |                                     |                                             &#34;no users&#34; result |
        |                                     |&lt;--------------------------------------------------------------|
        |                                     |                                                               |
        |                                     | POST /store-invite                                            |
        |                                     |--------------------------------------------------------------&gt;|
        |                                     |                                                               |
        |                                     |          Information needed for the m.room.third_party_invite |
        |                                     |&lt;--------------------------------------------------------------|
        |                                     |                                                               |
        |                                     | Emit m.room.third_party_invite to the room                    |
        |                                     |-------------------------------------------                    |
        |                                     |                                          |                    |
        |                                     |&lt;------------------------------------------                    |
        |                                     |                                                               |
        |        Complete the /invite request |                                                               |
        |&lt;------------------------------------|                                                               |
        |                                     |                                                               |
</code></pre><p>All homeservers MUST verify the signature in the event&rsquo;s
<code>content.third_party_invite.signed</code> object.</p>
<p>The third-party user will then need to verify their identity, which
results in a call from the identity server to the homeserver that bound
the third-party identifier to a user. The homeserver then exchanges the
<code>m.room.third_party_invite</code> event in the room for a complete
<code>m.room.member</code> event for <code>membership: invite</code> for the user that has
bound the third-party identifier.</p>
<p>If a homeserver is joining a room for the first time because of an
<code>m.room.third_party_invite</code>, the server which is already participating
in the room (which is chosen as per the standard server-server
specification) MUST validate that the public key used for signing is
still valid, by checking <code>key_validity_url</code> in the above described way.</p>
<p>No other homeservers may reject the joining of the room on the basis of
<code>key_validity_url</code>, this is so that all homeservers have a consistent
view of the room. They may, however, indicate to their clients that a
member&rsquo;s membership is questionable.</p>
<p>For example, given H1, H2, and H3 as homeservers, UserA as a user of H1,
and an identity server IS, the full sequence for a third-party invite
would look like the following. This diagram assumes H1 and H2 are
residents of the room while H3 is attempting to join.</p>
<pre tabindex="0"><code>    +-------+ +-----------------+         +-----+                                          +-----+           +-----+                      +-----+
    | UserA | | ThirdPartyUser  |         | H1  |                                          | H2  |           | H3  |                      | IS  |
    +-------+ +-----------------+         +-----+                                          +-----+           +-----+                      +-----+
        |              |                     |                                                |                 |                            |
        | POST /invite for ThirdPartyUser    |                                                |                 |                            |
        |-----------------------------------&gt;|                                                |                 |                            |
        |              |                     |                                                |                 |                            |
        |              |                     | GET /lookup                                    |                 |                            |
        |              |                     |----------------------------------------------------------------------------------------------&gt;|
        |              |                     |                                                |                 |                            |
        |              |                     |                                                |                Lookup results (empty object) |
        |              |                     |&lt;----------------------------------------------------------------------------------------------|
        |              |                     |                                                |                 |                            |
        |              |                     | POST /store-invite                             |                 |                            |
        |              |                     |----------------------------------------------------------------------------------------------&gt;|
        |              |                     |                                                |                 |                            |
        |              |                     |                                                |      Token, keys, etc for third-party invite |
        |              |                     |&lt;----------------------------------------------------------------------------------------------|
        |              |                     |                                                |                 |                            |
        |              |                     | (Federation) Emit m.room.third_party_invite    |                 |                            |
        |              |                     |-----------------------------------------------&gt;|                 |                            |
        |              |                     |                                                |                 |                            |
        |           Complete /invite request |                                                |                 |                            |
        |&lt;-----------------------------------|                                                |                 |                            |
        |              |                     |                                                |                 |                            |
        |              | Verify identity     |                                                |                 |                            |
        |              |--------------------------------------------------------------------------------------------------------------------&gt;|
        |              |                     |                                                |                 |                            |
        |              |                     |                                                |                 |          POST /3pid/onbind |
        |              |                     |                                                |                 |&lt;---------------------------|
        |              |                     |                                                |                 |                            |
        |              |                     |                         PUT /exchange_third_party_invite/:roomId |                            |
        |              |                     |&lt;-----------------------------------------------------------------|                            |
        |              |                     |                                                |                 |                            |
        |              |                     | Verify the request                             |                 |                            |
        |              |                     |-------------------                             |                 |                            |
        |              |                     |                  |                             |                 |                            |
        |              |                     |&lt;------------------                             |                 |                            |
        |              |                     |                                                |                 |                            |
        |              |                     | (Federation) Emit m.room.member for invite     |                 |                            |
        |              |                     |-----------------------------------------------&gt;|                 |                            |
        |              |                     |                                                |                 |                            |
        |              |                     |                                                |                 |                            |
        |              |                     | (Federation) Emit the m.room.member event sent to H2             |                            |
        |              |                     |-----------------------------------------------------------------&gt;|                            |
        |              |                     |                                                |                 |                            |
        |              |                     | Complete /exchange_third_party_invite/:roomId request            |                            |
        |              |                     |-----------------------------------------------------------------&gt;|                            |
        |              |                     |                                                |                 |                            |
        |              |                     |                                                |                 | Participate in the room    |
        |              |                     |                                                |                 |------------------------    |
        |              |                     |                                                |                 |                       |    |
        |              |                     |                                                |                 |&lt;-----------------------    |
        |              |                     |                                                |                 |                            |
</code></pre><p>Note that when H1 sends the <code>m.room.member</code> event to H2 and H3 it does
not have to block on either server&rsquo;s receipt of the event. Likewise, H1
may complete the <code>/exchange_third_party_invite/:roomId</code> request at the
same time as sending the <code>m.room.member</code> event to H2 and H3.
Additionally, H3 may complete the <code>/3pid/onbind</code> request it got from IS
at any time - the completion is not shown in the diagram.</p>
<p>H1 MUST verify the request from H3 to ensure the <code>signed</code> property is
correct as well as the <code>key_validity_url</code> as still being valid. This is
done by making a request to the <a href="/identity-service-api/#get_matrixidentityv2pubkeyisvalid">identity server
/isvalid</a>
endpoint, using the provided URL rather than constructing a new one. The
query string and response for the provided URL must match the Identity
Service Specification.</p>
<p>The reason that no other homeserver may reject the event based on
checking <code>key_validity_url</code> is that we must ensure event acceptance is
deterministic. If some other participating server doesn&rsquo;t have a network
path to the keyserver, or if the keyserver were to go offline, or revoke
its keys, that other server would reject the event and cause the
participating servers&rsquo; graphs to diverge. This relies on participating
servers trusting each other, but that trust is already implied by the
server-server protocol. Also, the public key signature verification must
still be performed, so the attack surface here is minimized.</p>
<h4 id="security-considerations">Security considerations</h4>
<p>There are a number of privacy and trust implications to this module.</p>
<p>It is important for user privacy that leaking the mapping between a
matrix user ID and a third-party identifier is hard. In particular,
being able to look up all third-party identifiers from a matrix user ID
(and accordingly, being able to link each third-party identifier) should
be avoided wherever possible. To this end, the third-party identifier is
not put in any event, rather an opaque display name provided by the
identity server is put into the events. Clients should not remember or
display third-party identifiers from invites, other than for the use of
the inviter themself.</p>
<p>Homeservers are not required to trust any particular identity server(s).
It is generally a client&rsquo;s responsibility to decide which identity
servers it trusts, not a homeserver&rsquo;s. Accordingly, this API takes
identity servers as input from end users, and doesn&rsquo;t have any specific
trusted set. It is possible some homeservers may want to supply
defaults, or reject some identity servers for <em>its</em> users, but no
homeserver is allowed to dictate which identity servers <em>other</em>
homeservers&rsquo; users trust.</p>
<p>There is some risk of denial of service attacks by flooding homeservers
or identity servers with many requests, or much state to store.
Defending against these is left to the implementer&rsquo;s discretion.</p>

    







    
<h3 id="server-side-search">Server Side Search</h3>
<p>The search API allows clients to perform full text search across events
in all rooms that the user has been in, including those that they have
left. Only events that the user is allowed to see will be searched, e.g.
it won&rsquo;t include events in rooms that happened after you left.</p>
<h4 id="client-behaviour">Client behaviour</h4>
<p>There is a single HTTP API for performing server-side search, documented
below.</p>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3search">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/search</span>
  </h1>
</summary>
  <hr/>
<p>Performs a full text search across different categories.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>next_batch</code></td>
  <td><code>string</code></td>
  <td>
    The point to return events from. If given, this should be a
<code>next_batch</code> result from a previous call to this endpoint.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>search_categories</code></td>
  <td><code>Categories</code></td>
  <td>
    <strong>Required: </strong>Describes which categories to search in and their criteria.</td>
 </tr>
</table>
<table id="_matrixclientv3search_categories" class="object-table">
 <caption>Categories</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>room_events</code></td>
  <td><code>Room Events Criteria</code></td>
  <td>
    Mapping of category name to search criteria.</td>
 </tr>
</table>
<table id="_matrixclientv3search_room-events-criteria" class="object-table">
 <caption>Room Events Criteria</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>event_context</code></td>
  <td><code>Include Event Context</code></td>
  <td>
    Configures whether any context for the events
returned are included in the response.</td>
 </tr>
 <tr>
  <td><code>filter</code></td>
  <td><code>Filter</code></td>
  <td>
    This takes a <a href="/client-server-api/#filtering">filter</a>.</td>
 </tr>
 <tr>
  <td><code>groupings</code></td>
  <td><code>Groupings</code></td>
  <td>
    Requests that the server partitions the result set
based on the provided list of keys.</td>
 </tr>
 <tr>
  <td><code>include_state</code></td>
  <td><code>boolean</code></td>
  <td>
    Requests the server return the current state for
each room returned.</td>
 </tr>
 <tr>
  <td><code>keys</code></td>
  <td><code>[string]</code></td>
  <td>
    The keys to search. Defaults to all.</td>
 </tr>
 <tr>
  <td><code>order_by</code></td>
  <td><code>string</code></td>
  <td>
    The order in which to search for results.
By default, this is <code>&quot;rank&quot;</code>.<p>One of: <code>[recent, rank]</code>.</p></td>
 </tr>
 <tr>
  <td><code>search_term</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The string to search events for</td>
 </tr>
</table>
<table id="_matrixclientv3search_include-event-context" class="object-table">
 <caption>Include Event Context</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>after_limit</code></td>
  <td><code>integer</code></td>
  <td>
    How many events after the result are
returned. By default, this is <code>5</code>.</td>
 </tr>
 <tr>
  <td><code>before_limit</code></td>
  <td><code>integer</code></td>
  <td>
    How many events before the result are
returned. By default, this is <code>5</code>.</td>
 </tr>
 <tr>
  <td><code>include_profile</code></td>
  <td><code>boolean</code></td>
  <td>
    Requests that the server returns the
historic profile information for the users
that sent the events that were returned.
By default, this is <code>false</code>.</td>
 </tr>
</table>
<table id="_matrixclientv3search_filter" class="object-table">
 <caption>Filter</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>contains_url</code></td>
  <td><code>boolean</code></td>
  <td>
    If <code>true</code>, includes only events with a <code>url</code> key in their content. If <code>false</code>, excludes those events. If omitted, <code>url</code> key is not considered for filtering.</td>
 </tr>
 <tr>
  <td><code>include_redundant_members</code></td>
  <td><code>boolean</code></td>
  <td>
    If <code>true</code>, sends all membership events for all events, even if they have already
been sent to the client. Does not
apply unless <code>lazy_load_members</code> is <code>true</code>. See
<a href="/client-server-api/#lazy-loading-room-members">Lazy-loading room members</a>
for more information. Defaults to <code>false</code>.</td>
 </tr>
 <tr>
  <td><code>lazy_load_members</code></td>
  <td><code>boolean</code></td>
  <td>
    If <code>true</code>, enables lazy-loading of membership events. See
<a href="/client-server-api/#lazy-loading-room-members">Lazy-loading room members</a>
for more information. Defaults to <code>false</code>.</td>
 </tr>
 <tr>
  <td><code>limit</code></td>
  <td><code>integer</code></td>
  <td>
    <p>The maximum number of events to return, must be an integer greater than 0.</p>
<p>Servers should apply a default value, and impose a maximum value to avoid
resource exhaustion.</p>
</td>
 </tr>
 <tr>
  <td><code>not_rooms</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of room IDs to exclude. If this list is absent then no rooms are excluded. A matching room will be excluded even if it is listed in the <code>'rooms'</code> filter.</td>
 </tr>
 <tr>
  <td><code>not_senders</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of sender IDs to exclude. If this list is absent then no senders are excluded. A matching sender will be excluded even if it is listed in the <code>'senders'</code> filter.</td>
 </tr>
 <tr>
  <td><code>not_types</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of event types to exclude. If this list is absent then no event types are excluded. A matching type will be excluded even if it is listed in the <code>'types'</code> filter. A &lsquo;*&rsquo; can be used as a wildcard to match any sequence of characters.</td>
 </tr>
 <tr>
  <td><code>rooms</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of room IDs to include. If this list is absent then all rooms are included.</td>
 </tr>
 <tr>
  <td><code>senders</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of senders IDs to include. If this list is absent then all senders are included.</td>
 </tr>
 <tr>
  <td><code>types</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of event types to include. If this list is absent then all event types are included. A <code>'*'</code> can be used as a wildcard to match any sequence of characters.</td>
 </tr>
 <tr>
  <td><code>unread_thread_notifications</code></td>
  <td><code>boolean</code></td>
  <td>
    If <code>true</code>, enables per-<a href="/client-server-api/#threading">thread</a> notification
counts. Only applies to the <code>/sync</code> endpoint. Defaults to <code>false</code>.
<p><strong>Added in <code>v1.4</code></strong></p>
</td>
 </tr>
</table>
<table id="_matrixclientv3search_groupings" class="object-table">
 <caption>Groupings</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>group_by</code></td>
  <td><code>[Group]</code></td>
  <td>
    List of groups to request.</td>
 </tr>
</table>
<table id="_matrixclientv3search_group" class="object-table">
 <caption>Group</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>key</code></td>
  <td><code>string</code></td>
  <td>
    Key that defines the group.<p>One of: <code>[room_id, sender]</code>.</p></td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;search_categories&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;room_events&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;groupings&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;group_by&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;room_id&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;content.body&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;order_by&#34;</span><span class="p">:</span> <span class="s2">&#34;recent&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;search_term&#34;</span><span class="p">:</span> <span class="s2">&#34;martians and men&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>Results of the search.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td>Part of the request was invalid.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="_matrixclientv3search_results" class="object-table">
 <caption>Results</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>search_categories</code></td>
  <td><code>Result Categories</code></td>
  <td>
    <strong>Required: </strong>Describes which categories to search in and their criteria.</td>
 </tr>
</table>
<table id="_matrixclientv3search_result-categories" class="object-table">
 <caption>Result Categories</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>room_events</code></td>
  <td><code>Result Room Events</code></td>
  <td>
    Mapping of category name to search criteria.</td>
 </tr>
</table>
<table id="_matrixclientv3search_result-room-events" class="object-table">
 <caption>Result Room Events</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>count</code></td>
  <td><code>integer</code></td>
  <td>
    An approximate count of the total number of results found.</td>
 </tr>
 <tr>
  <td><code>groups</code></td>
  <td><code>Groups</code></td>
  <td>
    <p>Any groups that were requested.</p>
<p>The outer <code>string</code> key is the group key requested (eg: <code>room_id</code>
or <code>sender</code>). The inner <code>string</code> key is the grouped value (eg:
a room&rsquo;s ID or a user&rsquo;s ID).</p>
</td>
 </tr>
 <tr>
  <td><code>highlights</code></td>
  <td><code>[string]</code></td>
  <td>
    List of words which should be highlighted, useful for stemming which may change the query terms.</td>
 </tr>
 <tr>
  <td><code>next_batch</code></td>
  <td><code>string</code></td>
  <td>
    Token that can be used to get the next batch of
results, by passing as the <code>next_batch</code> parameter to
the next call. If this field is absent, there are no
more results.</td>
 </tr>
 <tr>
  <td><code>results</code></td>
  <td><code>[Result]</code></td>
  <td>
    List of results in the requested order.</td>
 </tr>
 <tr>
  <td><code>state</code></td>
  <td><code>Current state</code></td>
  <td>
    <p>The current state for every room in the results.
This is included if the request had the
<code>include_state</code> key set with a value of <code>true</code>.</p>
<p>The <code>string</code> key is the room ID for which the <code>State Event</code> array belongs to.</p>
</td>
 </tr>
</table>
<table id="_matrixclientv3search_group-value" class="object-table">
 <caption>Group Value</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>next_batch</code></td>
  <td><code>string</code></td>
  <td>
    Token that can be used to get the next batch
of results in the group, by passing as the
<code>next_batch</code> parameter to the next call. If
this field is absent, there are no more
results in this group.</td>
 </tr>
 <tr>
  <td><code>order</code></td>
  <td><code>integer</code></td>
  <td>
    Key that can be used to order different
groups.</td>
 </tr>
 <tr>
  <td><code>results</code></td>
  <td><code>[Result Event ID]</code></td>
  <td>
    Which results are in this group.</td>
 </tr>
</table>
<table id="_matrixclientv3search_result" class="object-table">
 <caption>Result</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>context</code></td>
  <td><code>Event Context</code></td>
  <td>
    Context for result, if requested.</td>
 </tr>
 <tr>
  <td><code>rank</code></td>
  <td><code>number</code></td>
  <td>
    A number that describes how closely this result matches the search. Higher is closer.</td>
 </tr>
 <tr>
  <td><code>result</code></td>
  <td><code>Event</code></td>
  <td>
    The event that matched.</td>
 </tr>
</table>
<table id="_matrixclientv3search_event-context" class="object-table">
 <caption>Event Context</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>end</code></td>
  <td><code>string</code></td>
  <td>
    Pagination token for the end of the chunk</td>
 </tr>
 <tr>
  <td><code>events_after</code></td>
  <td><code>[Event]</code></td>
  <td>
    Events just after the result.</td>
 </tr>
 <tr>
  <td><code>events_before</code></td>
  <td><code>[Event]</code></td>
  <td>
    Events just before the result.</td>
 </tr>
 <tr>
  <td><code>profile_info</code></td>
  <td><code>Profile Information</code></td>
  <td>
    <p>The historic profile information of the
users that sent the events returned.</p>
<p>The <code>string</code> key is the user ID for which
the profile belongs to.</p>
</td>
 </tr>
 <tr>
  <td><code>start</code></td>
  <td><code>string</code></td>
  <td>
    Pagination token for the start of the chunk</td>
 </tr>
</table>
<table id="_matrixclientv3search_event" class="object-table">
 <caption>Event</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The body of this event, as created by the client which sent it.</td>
 </tr>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The globally unique identifier for this event.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>Timestamp (in milliseconds since the unix epoch) on originating homeserver
when this event was sent.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room associated with this event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Contains the fully-qualified ID of the user who sent this event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <p>Present if, and only if, this event is a <em>state</em> event. The key making
this piece of state unique in the room. Note that it is often an empty
string.</p>
<p>State keys starting with an <code>@</code> are reserved for referencing user IDs, such
as room members. With the exception of a few events, state events set with a
given user&rsquo;s ID as the state key MUST only be set by that user.</p>
</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of the event.</td>
 </tr>
 <tr>
  <td><code>unsigned</code></td>
  <td><code>UnsignedData</code></td>
  <td>
    Contains optional extra information about the event.</td>
 </tr>
</table>
<table id="_matrixclientv3search_unsigneddata" class="object-table">
 <caption>UnsignedData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>age</code></td>
  <td><code>integer</code></td>
  <td>
    The time in milliseconds that has elapsed since the event was sent. This field is generated by the local homeserver, and may be incorrect if the local time on at least one of the two servers is out of sync, which can cause the age to either be negative or greater than it actually is.</td>
 </tr>
 <tr>
  <td><code>prev_content</code></td>
  <td><code>EventContent</code></td>
  <td>
    The previous <code>content</code> for this event. This field is generated
by the local homeserver, and is only returned if the event is a state event,
and the client has permission to see the previous content.<br><br>
    <strong>
      Changed in <code>v1.2</code>:
    </strong>
    Previously, this field was specified at the top level of returned
events rather than in <code>unsigned</code> (with the exception of the <a href="/client-server-api/#get_matrixclientv3notifications"><code>GET .../notifications</code></a>
endpoint), though in practice no known server implementations honoured
this.
</td>
 </tr>
 <tr>
  <td><code>redacted_because</code></td>
  <td><code>ClientEvent</code></td>
  <td>
    The event that redacted this event, if any.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    The client-supplied <a href="/client-server-api/#transaction-identifiers">transaction ID</a>, for example, provided via
<code>PUT /_matrix/client/v3/rooms/{roomId}/send/{eventType}/{txnId}</code>,
if the client being given the event is the same one which sent it.</td>
 </tr>
</table>
<table id="_matrixclientv3search_user-profile" class="object-table">
 <caption>User Profile</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>avatar_url</code></td>
  <td><code>string</code></td>
  <td>
    </td>
 </tr>
 <tr>
  <td><code>displayname</code></td>
  <td><code>string</code></td>
  <td>
    </td>
 </tr>
</table>
<table id="_matrixclientv3search_clientevent" class="object-table">
 <caption>ClientEvent</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The body of this event, as created by the client which sent it.</td>
 </tr>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The globally unique identifier for this event.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>Timestamp (in milliseconds since the unix epoch) on originating homeserver
when this event was sent.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room associated with this event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Contains the fully-qualified ID of the user who sent this event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <p>Present if, and only if, this event is a <em>state</em> event. The key making
this piece of state unique in the room. Note that it is often an empty
string.</p>
<p>State keys starting with an <code>@</code> are reserved for referencing user IDs, such
as room members. With the exception of a few events, state events set with a
given user&rsquo;s ID as the state key MUST only be set by that user.</p>
</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of the event.</td>
 </tr>
 <tr>
  <td><code>unsigned</code></td>
  <td><code>UnsignedData</code></td>
  <td>
    Contains optional extra information about the event.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;search_categories&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;room_events&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;count&#34;</span><span class="p">:</span> <span class="mi">1224</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;groups&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;!qPewotXpIctQySfjSy:localhost&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;next_batch&#34;</span><span class="p">:</span> <span class="s2">&#34;BdgFsdfHSf-dsFD&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;order&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;results&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">              <span class="s2">&#34;$144429830826TWwbB:localhost&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">]</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;highlights&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;martians&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;men&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;next_batch&#34;</span><span class="p">:</span> <span class="s2">&#34;5FdgFsd234dfgsdfFD&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;results&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;rank&#34;</span><span class="p">:</span> <span class="mf">0.00424866</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;result&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;This is an example text message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;org.matrix.custom.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;formatted_body&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;b&gt;This is an example text message&lt;/b&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$144429830826TWwbB:localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!qPewotXpIctQySfjSy:localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3search_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h4 id="search-categories">Search Categories</h4>
<p>The search API allows clients to search in different categories of
items. Currently the only specified category is <code>room_events</code>.</p>
<h5 id="room_events"><code>room_events</code></h5>
<p>This category covers all events that the user is allowed to see,
including events in rooms that they have left. The search is performed
on certain keys of certain event types.</p>
<p>The supported keys to search over are:</p>
<ul>
<li><code>content.body</code> in <code>m.room.message</code></li>
<li><code>content.name</code> in <code>m.room.name</code></li>
<li><code>content.topic</code> in <code>m.room.topic</code></li>
</ul>
<p>The search will <em>not</em> include rooms that are end to end encrypted.</p>
<p>The results include a <code>rank</code> key that can be used to sort the results by
relevancy. The higher the <code>rank</code> the more relevant the result is.</p>
<p>The value of <code>count</code> gives an approximation of the total number of
results. Homeservers may give an estimate rather than an exact value for
this field.</p>
<h4 id="ordering">Ordering</h4>
<p>The client can specify the ordering that the server returns results in.
The two allowed orderings are:</p>
<ul>
<li><code>rank</code>, which returns the most relevant results first.</li>
<li><code>recent</code>, which returns the most recent results first.</li>
</ul>
<p>The default ordering is <code>rank</code>.</p>
<h4 id="groups">Groups</h4>
<p>The client can request that the results are returned along with grouping
information, e.g. grouped by <code>room_id</code>. In this case the response will
contain a group entry for each distinct value of <code>room_id</code>. Each group
entry contains at least a list of the <code>event_ids</code> that are in that
group, as well as potentially other metadata about the group.</p>
<p>The current required supported groupings are:</p>
<ul>
<li><code>room_id</code></li>
<li><code>sender</code></li>
</ul>
<h4 id="pagination">Pagination</h4>
<p>The server may return a <code>next_batch</code> key at various places in the
response. These are used to paginate the results. To fetch more results,
the client should send the <em>same</em> request to the server with a
<code>next_batch</code> query parameter set to that of the token.</p>
<p>The scope of the pagination is defined depending on where the
<code>next_batch</code> token was returned. For example, using a token inside a
group will return more results from within that group.</p>
<p>The currently supported locations for the <code>next_batch</code> token are:</p>
<ul>
<li><code>search_categories.&lt;category&gt;.next_batch</code></li>
<li><code>search_categories.&lt;category&gt;.groups.&lt;group_key&gt;.&lt;group_id&gt;.next_batch</code></li>
</ul>
<p>A server need not support pagination, even if there are more matching
results. In that case, they must not return a <code>next_batch</code> token in the
response.</p>
<h4 id="security-considerations">Security considerations</h4>
<p>The server must only return results that the user has permission to see.</p>

    







    
<h3 id="guest-access">Guest Access</h3>
<p>There are times when it is desirable for clients to be able to interact
with rooms without having to fully register for an account on a
homeserver or join the room. This module specifies how these clients
should interact with servers in order to participate in rooms as guests.</p>
<p>Guest users retrieve access tokens from a homeserver using the ordinary
<a href="#post_matrixclientv3register">register
endpoint</a>,
specifying the <code>kind</code> parameter as <code>guest</code>. They may then interact with
the client-server API as any other user would, but will only have access
to a subset of the API as described the Client behaviour subsection
below. Homeservers may choose not to allow this access at all to their
local users, but have no information about whether users on other
homeservers are guests or not.</p>
<p>Guest users can also upgrade their account by going through the ordinary
<code>register</code> flow, but specifying the additional POST parameter
<code>guest_access_token</code> containing the guest&rsquo;s access token. They are also
required to specify the <code>username</code> parameter to the value of the local
part of their username, which is otherwise optional.</p>
<p>This module does not fully factor in federation; it relies on individual
homeservers properly adhering to the rules set out in this module,
rather than allowing all homeservers to enforce the rules on each other.</p>
<h4 id="events">Events</h4>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mroomguest_access">
   <code>m.room.guest_access</code>
  </h1>
</summary>
  <hr/>
<p>This event controls whether guest users are allowed to join rooms. If this event is absent, servers should act as if it is present and has the guest_access value forbidden.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>State event</td>
  </tr>
  <tr>
   <th>State key</th>
   <td>A zero-length string.</td>
 </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>guest_access</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Whether guests can join the room.<p>One of: <code>[can_join, forbidden]</code>.</p></td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;guest_access&#34;</span><span class="p">:</span> <span class="s2">&#34;can_join&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.guest_access&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h4 id="client-behaviour">Client behaviour</h4>
<p>The following API endpoints are allowed to be accessed by guest accounts
for retrieving events:</p>
<ul>
<li><a href="#get_matrixclientv3roomsroomidstate">GET /rooms/{roomId}/state</a></li>
<li><a href="#get_matrixclientv3roomsroomidcontexteventid">GET /rooms/{roomId}/context/{eventId}</a></li>
<li><a href="#get_matrixclientv3roomsroomideventeventid">GET /rooms/{roomId}/event/{eventId}</a></li>
<li><a href="#get_matrixclientv3roomsroomidstateeventtypestatekey">GET /rooms/{roomId}/state/{eventType}/{stateKey}</a></li>
<li><a href="#get_matrixclientv3roomsroomidmessages">GET /rooms/{roomId}/messages</a></li>
<li>



  <span><strong>[Added in <code>v1.1</code>]</strong></span>
 
 <a href="#get_matrixclientv3roomsroomidmembers">GET /rooms/{roomId}/members</a></li>
<li><a href="#get_matrixclientv3roomsroomidinitialsync">GET /rooms/{roomId}/initialSync</a></li>
<li><a href="#get_matrixclientv3sync">GET /sync</a></li>
<li><a href="#get_matrixclientv3events">GET /events</a> as used for room previews.</li>
</ul>
<p>The following API endpoints are allowed to be accessed by guest accounts
for sending events:</p>
<ul>
<li>
<p><a href="#post_matrixclientv3roomsroomidjoin">POST /rooms/{roomId}/join</a></p>
</li>
<li>
<p><a href="#post_matrixclientv3roomsroomidleave">POST /rooms/{roomId}/leave</a></p>
</li>
<li>
<p><a href="#put_matrixclientv3roomsroomidsendeventtypetxnid">PUT /rooms/{roomId}/send/{eventType}/{txnId}</a></p>
<ul>
<li>



  <span><strong>[Changed in <code>v1.2</code>]</strong></span>
 
 Guests can now send <em>any</em> event type rather than just <code>m.room.message</code> events.</li>
</ul>
</li>
<li>
<p>



  <span><strong>[Added in <code>v1.2</code>]</strong></span>
 
 <a href="#put_matrixclientv3roomsroomidstateeventtypestatekey">PUT /rooms/{roomId}/state/{eventType}/{stateKey}</a></p>
</li>
<li>
<p><a href="#put_matrixclientv3sendtodeviceeventtypetxnid">PUT /sendToDevice/{eventType}/{txnId}</a></p>
</li>
</ul>
<p>The following API endpoints are allowed to be accessed by guest accounts
for their own account maintenance:</p>
<ul>
<li><a href="#put_matrixclientv3profileuseriddisplayname">PUT /profile/{userId}/displayname</a></li>
<li><a href="#get_matrixclientv3devices">GET /devices</a></li>
<li><a href="#get_matrixclientv3devicesdeviceid">GET /devices/{deviceId}</a></li>
<li><a href="#put_matrixclientv3devicesdeviceid">PUT /devices/{deviceId}</a></li>
<li>



  <span><strong>[Added in <code>v1.2</code>]</strong></span>
 
 <a href="#get_matrixclientv3accountwhoami">GET /account/whoami</a></li>
</ul>
<p>The following API endpoints are allowed to be accessed by guest accounts
for end-to-end encryption:</p>
<ul>
<li><a href="#post_matrixclientv3keysupload">POST /keys/upload</a></li>
<li><a href="#post_matrixclientv3keysquery">POST /keys/query</a></li>
<li><a href="#post_matrixclientv3keysclaim">POST /keys/claim</a></li>
</ul>
<h4 id="server-behaviour">Server behaviour</h4>
<p>Servers MUST only allow guest users to join rooms if the
<code>m.room.guest_access</code> state event is present on the room, and has the
<code>guest_access</code> value <code>can_join</code>. If the <code>m.room.guest_access</code> event is
changed to stop this from being the case, the server MUST set those
users&rsquo; <code>m.room.member</code> state to <code>leave</code>.</p>
<h4 id="security-considerations">Security considerations</h4>
<p>Each homeserver manages its own guest accounts itself, and whether an
account is a guest account or not is not information passed from server
to server. Accordingly, any server participating in a room is trusted to
properly enforce the permissions outlined in this section.</p>
<p>Homeservers may want to enable protections such as captchas for guest
registration to prevent spam, denial of service, and similar attacks.</p>
<p>Homeservers may want to put stricter rate limits on guest accounts,
particularly for sending state events.</p>

    







    
<h3 id="room-previews">Room Previews</h3>
<p>It is sometimes desirable to offer a preview of a room, where a user can
&ldquo;lurk&rdquo; and read messages posted to the room, without joining the room.
This can be particularly effective when combined with <a href="#guest-access">Guest Access</a>.</p>
<p>Previews are implemented via the <code>world_readable</code> <a href="#room-history-visibility">Room History
Visibility</a>. setting, along with a special version of the <a href="#get_matrixclientv3events">GET
/events</a> endpoint.</p>
<h4 id="client-behaviour">Client behaviour</h4>
<p>A client wishing to view a room without joining it should call <a href="#get_matrixclientv3roomsroomidinitialsync">GET
/rooms/:room_id/initialSync</a>,
followed by <a href="#get_matrixclientv3events">GET /events</a>. Clients will need to do
this in parallel for each room they wish to view.</p>
<p>Clients can of course also call other endpoints such as <a href="#get_matrixclientv3roomsroomidmessages">GET
/rooms/:room_id/messages</a>
and <a href="#post_matrixclientv3search">GET /search</a> to
access events outside the <code>/events</code> stream.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3events">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/events </span>
  </h1>
</summary>
  <hr/>
<p><p>This will listen for new events related to a particular room and return
them to the caller. This will block until an event is received, or until
the <code>timeout</code> is reached.</p>
<p>This API is the same as the normal <code>/events</code> endpoint, but can be
called by users who have not joined the room.</p>
<p>Note that the normal <code>/events</code> endpoint has been deprecated. This
API will also be deprecated at some point, but its replacement is not
yet known.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>from</code></td>
  <td><code>string</code></td>
  <td>
    The token to stream from. This token is either from a previous
request to this API or from the initial sync API.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    The room ID for which events should be returned.</td>
 </tr>
 <tr>
  <td><code>timeout</code></td>
  <td><code>integer</code></td>
  <td>
    The maximum time in milliseconds to wait for an event.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The events received, which may be none.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td>Bad pagination <code>from</code> parameter.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>chunk</code></td>
  <td><code>[Event]</code></td>
  <td>
    An array of events.</td>
 </tr>
 <tr>
  <td><code>end</code></td>
  <td><code>string</code></td>
  <td>
    A token which correlates to the last value in <code>chunk</code>. This
token should be used in the next request to <code>/events</code>.</td>
 </tr>
 <tr>
  <td><code>start</code></td>
  <td><code>string</code></td>
  <td>
    A token which correlates to the first value in <code>chunk</code>. This
is usually the same token supplied to <code>from=</code>.</td>
 </tr>
</table>
<table id="_matrixclientv3events_event" class="object-table">
 <caption>Event</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The body of this event, as created by the client which sent it.</td>
 </tr>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The globally unique identifier for this event.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>Timestamp (in milliseconds since the unix epoch) on originating homeserver
when this event was sent.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room associated with this event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Contains the fully-qualified ID of the user who sent this event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <p>Present if, and only if, this event is a <em>state</em> event. The key making
this piece of state unique in the room. Note that it is often an empty
string.</p>
<p>State keys starting with an <code>@</code> are reserved for referencing user IDs, such
as room members. With the exception of a few events, state events set with a
given user&rsquo;s ID as the state key MUST only be set by that user.</p>
</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of the event.</td>
 </tr>
 <tr>
  <td><code>unsigned</code></td>
  <td><code>UnsignedData</code></td>
  <td>
    Contains optional extra information about the event.</td>
 </tr>
</table>
<table id="_matrixclientv3events_unsigneddata" class="object-table">
 <caption>UnsignedData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>age</code></td>
  <td><code>integer</code></td>
  <td>
    The time in milliseconds that has elapsed since the event was sent. This field is generated by the local homeserver, and may be incorrect if the local time on at least one of the two servers is out of sync, which can cause the age to either be negative or greater than it actually is.</td>
 </tr>
 <tr>
  <td><code>prev_content</code></td>
  <td><code>EventContent</code></td>
  <td>
    The previous <code>content</code> for this event. This field is generated
by the local homeserver, and is only returned if the event is a state event,
and the client has permission to see the previous content.<br><br>
    <strong>
      Changed in <code>v1.2</code>:
    </strong>
    Previously, this field was specified at the top level of returned
events rather than in <code>unsigned</code> (with the exception of the <a href="/client-server-api/#get_matrixclientv3notifications"><code>GET .../notifications</code></a>
endpoint), though in practice no known server implementations honoured
this.
</td>
 </tr>
 <tr>
  <td><code>redacted_because</code></td>
  <td><code>ClientEvent</code></td>
  <td>
    The event that redacted this event, if any.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    The client-supplied <a href="/client-server-api/#transaction-identifiers">transaction ID</a>, for example, provided via
<code>PUT /_matrix/client/v3/rooms/{roomId}/send/{eventType}/{txnId}</code>,
if the client being given the event is the same one which sent it.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;chunk&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;This is an example text message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;org.matrix.custom.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;formatted_body&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;b&gt;This is an example text message&lt;/b&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!somewhere:over.the.rainbow&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;end&#34;</span><span class="p">:</span> <span class="s2">&#34;s3457_9_0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;start&#34;</span><span class="p">:</span> <span class="s2">&#34;s3456_9_0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h4 id="server-behaviour">Server behaviour</h4>
<p>For clients which have not joined a room, servers are required to only
return events where the room state at the event had the
<code>m.room.history_visibility</code> state event present with
<code>history_visibility</code> value <code>world_readable</code>.</p>
<h4 id="security-considerations">Security considerations</h4>
<p>Clients may wish to display to their users that rooms which are
<code>world_readable</code> <em>may</em> be showing messages to non-joined users. There is
no way using this module to find out whether any non-joined guest users
<em>do</em> see events in the room, or to list or count any lurking users.</p>

    







    
<h3 id="room-tagging">Room Tagging</h3>
<p>Users can add tags to rooms. Tags are namespaced strings used to label
rooms. A room may have multiple tags. Tags are only visible to the user
that set them but are shared across all their devices.</p>
<h4 id="events">Events</h4>
<p>The tags on a room are received as single <code>m.tag</code> event in the
<code>account_data</code> section of a room. The content of the <code>m.tag</code> event is a
<code>tags</code> key whose value is an object mapping the name of each tag to
another object.</p>
<p>The JSON object associated with each tag gives information about the
tag, e.g how to order the rooms with a given tag.</p>
<p>Ordering information is given under the <code>order</code> key as a number between
0 and 1. The numbers are compared such that 0 is displayed first.
Therefore a room with an <code>order</code> of <code>0.2</code> would be displayed before a
room with an <code>order</code> of <code>0.7</code>. If a room has a tag without an <code>order</code>
key then it should appear after the rooms with that tag that have an
<code>order</code> key.</p>
<p>The name of a tag MUST NOT exceed 255 bytes.</p>
<p>The tag namespace is defined as follows:</p>
<ul>
<li>The namespace <code>m.*</code> is reserved for tags defined in the Matrix
specification. Clients must ignore any tags in this namespace they
don&rsquo;t understand.</li>
<li>The namespace <code>u.*</code> is reserved for user-defined tags. The portion
of the string after the <code>u.</code> is defined to be the display name of
this tag. No other semantics should be inferred from tags in this
namespace.</li>
<li>A client or app willing to use special tags for advanced
functionality should namespace them similarly to state keys:
<code>tld.name.*</code></li>
<li>Any tag in the <code>tld.name.*</code> form but not matching the namespace of
the current client should be ignored</li>
<li>Any tag not matching the above rules should be interpreted as a user
tag from the <code>u.*</code> namespace, as if the name had already had <code>u.</code>
stripped from the start (ie. the name of the tag is used as the
display name directly). These non-namespaced tags are supported for
historical reasons. New tags should use one of the defined
namespaces above.</li>
</ul>
<p>Several special names are listed in the specification: The following
tags are defined in the <code>m.*</code> namespace:</p>
<ul>
<li><code>m.favourite</code>: The user&rsquo;s favourite rooms. These should be shown
with higher precedence than other rooms.</li>
<li><code>m.lowpriority</code>: These should be shown with lower precedence than
others.</li>
<li><code>m.server_notice</code>: Used to identify <a href="#server-notices">Server Notice
Rooms</a>.</li>
</ul>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mtag">
   <code>m.tag</code>
  </h1>
</summary>
  <hr/>
<p>Informs the client of tags on a room.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>tags</code></td>
  <td><code>{string: Tag}</code></td>
  <td>
    The tags on the room and their contents.</td>
 </tr>
</table>
<table id="mtag_tag" class="object-table">
 <caption>Tag</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>order</code></td>
  <td><code>number</code></td>
  <td>
    A number in a range <code>[0,1]</code> describing a relative position of the room under the given tag.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;tags&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;u.work&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;order&#34;</span><span class="p">:</span> <span class="mf">0.9</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.tag&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h4 id="client-behaviour">Client Behaviour</h4>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3useruseridroomsroomidtags">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/user/{userId}/rooms/{roomId}/tags</span>
  </h1>
</summary>
  <hr/>
<p>List the tags set by a user on a room.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room to get tags for.</td>
 </tr>
 <tr>
  <td><code>userId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The id of the user to get tags for. The access token must be
authorized to make requests for this user ID.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The list of tags for the user for the room.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>tags</code></td>
  <td><code>{string: Tag}</code></td>
  <td>
    </td>
 </tr>
</table>
<table id="_matrixclientv3useruseridroomsroomidtags_tag" class="object-table">
 <caption>Tag</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>order</code></td>
  <td><code>number</code></td>
  <td>
    A number in a range <code>[0,1]</code> describing a relative
position of the room under the given tag.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;tags&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.favourite&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;order&#34;</span><span class="p">:</span> <span class="mf">0.1</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;u.Customers&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;u.Work&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;order&#34;</span><span class="p">:</span> <span class="mf">0.7</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixclientv3useruseridroomsroomidtagstag">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/client/v3/user/{userId}/rooms/{roomId}/tags/{tag}</span>
  </h1>
</summary>
  <hr/>
<p>Add a tag to the room.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room to add a tag to.</td>
 </tr>
 <tr>
  <td><code>tag</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The tag to add.</td>
 </tr>
 <tr>
  <td><code>userId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The id of the user to add a tag for. The access token must be
authorized to make requests for this user ID.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>order</code></td>
  <td><code>number</code></td>
  <td>
    A number in a range <code>[0,1]</code> describing a relative
position of the room under the given tag.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;order&#34;</span><span class="p">:</span> <span class="mf">0.25</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The tag was successfully added.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api DELETE">
<details open>
<summary>
  <h1 id="delete_matrixclientv3useruseridroomsroomidtagstag">
   <span class="http-api-method DELETE">DELETE</span>
   <span class="endpoint">/_matrix/client/v3/user/{userId}/rooms/{roomId}/tags/{tag}</span>
  </h1>
</summary>
  <hr/>
<p>Remove a tag from the room.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room to remove a tag from.</td>
 </tr>
 <tr>
  <td><code>tag</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The tag to remove.</td>
 </tr>
 <tr>
  <td><code>userId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The id of the user to remove a tag for. The access token must be
authorized to make requests for this user ID.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The tag was successfully removed.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div></details>
</section>

    







    
<h3 id="client-config">Client Config</h3>
<p>Clients can store custom config data for their account on their
homeserver. This account data will be synced between different devices
and can persist across installations on a particular device. Users may
only view the account data for their own account.</p>
<p>The account data may be either global or scoped to a particular room.
There is no inheritance mechanism here: a given <code>type</code> of data missing
from a room&rsquo;s account data does not fall back to the global account
data with the same <code>type</code>.</p>
<h4 id="events">Events</h4>
<p>The client receives the account data as events in the <code>account_data</code>
sections of a <a href="#get_matrixclientv3sync"><code>/sync</code></a> response.</p>
<p>These events can also be received in a <code>/events</code> response or in the
<code>account_data</code> section of a room in a <code>/sync</code> response. <code>m.tag</code> events appearing in
<code>/events</code> will have a <code>room_id</code> with the room the tags are for.</p>
<h4 id="client-behaviour">Client Behaviour</h4>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3useruseridaccount_datatype">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/user/{userId}/account_data/{type}</span>
  </h1>
</summary>
  <hr/>
<p>Get some account data for the client. This config is only visible to the user
that set the account data.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The event type of the account data to get. Custom types should be
namespaced to avoid clashes.</td>
 </tr>
 <tr>
  <td><code>userId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the user to get account data for. The access token must be
authorized to make requests for this user ID.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The account data content for the given type.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The access token provided is not authorized to retrieve this user&rsquo;s account
data. Errcode: <code>M_FORBIDDEN</code>.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>No account data has been provided for this user with the given <code>type</code>.
Errcode: <code>M_NOT_FOUND</code>.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;custom_account_data_key&#34;</span><span class="p">:</span> <span class="s2">&#34;custom_config_value&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3useruseridaccount_datatype_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Cannot add account data for other users.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3useruseridaccount_datatype_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Account data not found.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixclientv3useruseridaccount_datatype">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/client/v3/user/{userId}/account_data/{type}</span>
  </h1>
</summary>
  <hr/>
<p>Set some account data for the client. This config is only visible to the user
that set the account data. The config will be available to clients through the
top-level <code>account_data</code> field in the homeserver response to
<a href="#get_matrixclientv3sync">/sync</a>.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The event type of the account data to set. Custom types should be
namespaced to avoid clashes.</td>
 </tr>
 <tr>
  <td><code>userId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the user to set account data for. The access token must be
authorized to make requests for this user ID.</td>
 </tr>
</table>
<h3>Request body</h3>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;custom_account_data_key&#34;</span><span class="p">:</span> <span class="s2">&#34;custom_config_value&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The account data was successfully added.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td>The request body is not a JSON object. Errcode: <code>M_BAD_JSON</code>
or <code>M_NOT_JSON</code>.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The access token provided is not authorized to modify this user&rsquo;s account
data. Errcode: <code>M_FORBIDDEN</code>.</td>
 </tr>
 <tr>
  <td><code>405</code></td>
  <td>This <code>type</code> of account data is controlled by the server; it cannot be
modified by clients. Errcode: <code>M_BAD_JSON</code>.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3useruseridaccount_datatype_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_JSON&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Content must be a JSON object.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3useruseridaccount_datatype_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Cannot add account data for other users.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>405 response</h3>
<table id="_matrixclientv3useruseridaccount_datatype_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_BAD_JSON&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Cannot set m.fully_read through this API.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3useruseridroomsroomidaccount_datatype">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/user/{userId}/rooms/{roomId}/account_data/{type}</span>
  </h1>
</summary>
  <hr/>
<p>Get some account data for the client on a given room. This config is only
visible to the user that set the account data.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room to get account data for.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The event type of the account data to get. Custom types should be
namespaced to avoid clashes.</td>
 </tr>
 <tr>
  <td><code>userId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the user to get account data for. The access token must be
authorized to make requests for this user ID.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The account data content for the given type.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td>The given <code>roomID</code> is not a valid room ID. Errcode: <code>M_INVALID_PARAM</code>.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The access token provided is not authorized to retrieve this user&rsquo;s account
data. Errcode: <code>M_FORBIDDEN</code>.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>No account data has been provided for this user and this room with the
given <code>type</code>. Errcode: <code>M_NOT_FOUND</code>.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;custom_account_data_key&#34;</span><span class="p">:</span> <span class="s2">&#34;custom_config_value&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3useruseridroomsroomidaccount_datatype_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_INVALID_PARAM&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;@notaroomid:example.org is not a valid room ID.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3useruseridroomsroomidaccount_datatype_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Cannot add account data for other users.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3useruseridroomsroomidaccount_datatype_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Room account data not found.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixclientv3useruseridroomsroomidaccount_datatype">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/client/v3/user/{userId}/rooms/{roomId}/account_data/{type}</span>
  </h1>
</summary>
  <hr/>
<p>Set some account data for the client on a given room. This config is only
visible to the user that set the account data. The config will be delivered to
clients in the per-room entries via <a href="#get_matrixclientv3sync">/sync</a>.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room to set account data on.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The event type of the account data to set. Custom types should be
namespaced to avoid clashes.</td>
 </tr>
 <tr>
  <td><code>userId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the user to set account data for. The access token must be
authorized to make requests for this user ID.</td>
 </tr>
</table>
<h3>Request body</h3>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;custom_account_data_key&#34;</span><span class="p">:</span> <span class="s2">&#34;custom_account_data_value&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The account data was successfully added.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td>The request body is not a JSON object (errcode <code>M_BAD_JSON</code> or
<code>M_NOT_JSON</code>), or the given <code>roomID</code> is not a valid room ID
(errcode <code>M_INVALID_PARAM</code>).</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The access token provided is not authorized to modify this user&rsquo;s account
data. Errcode: <code>M_FORBIDDEN</code>.</td>
 </tr>
 <tr>
  <td><code>405</code></td>
  <td>This <code>type</code> of account data is controlled by the server; it cannot be
modified by clients. Errcode: <code>M_BAD_JSON</code>.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3useruseridroomsroomidaccount_datatype_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_JSON&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Content must be a JSON object.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3useruseridroomsroomidaccount_datatype_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Cannot add account data for other users.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>405 response</h3>
<table id="_matrixclientv3useruseridroomsroomidaccount_datatype_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_BAD_JSON&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Cannot set m.fully_read through this API.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h4 id="server-behaviour">Server Behaviour</h4>
<p>Servers MUST reject clients from setting account data for event types
that the server manages. Currently, this only includes
<a href="#mfully_read">m.fully_read</a>.</p>

    







    
<h3 id="server-administration">Server Administration</h3>
<p>This module adds capabilities for server administrators to inspect
server state and data.</p>
<h4 id="client-behaviour">Client Behaviour</h4>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3adminwhoisuserid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/admin/whois/{userId}</span>
  </h1>
</summary>
  <hr/>
<p><p>Gets information about a particular user.</p>
<p>This API may be restricted to only be called by the user being looked
up, or by a server admin. Server-local administrator privileges are not
specified in this document.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>userId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user to look up.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The lookup was successful.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>devices</code></td>
  <td><code>{string: DeviceInfo}</code></td>
  <td>
    Each key is an identifier for one of the user&rsquo;s devices.</td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    The Matrix user ID of the user.</td>
 </tr>
</table>
<table id="_matrixclientv3adminwhoisuserid_deviceinfo" class="object-table">
 <caption>DeviceInfo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>sessions</code></td>
  <td><code>[SessionInfo]</code></td>
  <td>
    A user&rsquo;s sessions (i.e. what they did with an access token from one login).</td>
 </tr>
</table>
<table id="_matrixclientv3adminwhoisuserid_sessioninfo" class="object-table">
 <caption>SessionInfo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>connections</code></td>
  <td><code>[ConnectionInfo]</code></td>
  <td>
    Information particular connections in the session.</td>
 </tr>
</table>
<table id="_matrixclientv3adminwhoisuserid_connectioninfo" class="object-table">
 <caption>ConnectionInfo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>ip</code></td>
  <td><code>string</code></td>
  <td>
    Most recently seen IP address of the session.</td>
 </tr>
 <tr>
  <td><code>last_seen</code></td>
  <td><code>integer</code></td>
  <td>
    Unix timestamp that the session was last active.</td>
 </tr>
 <tr>
  <td><code>user_agent</code></td>
  <td><code>string</code></td>
  <td>
    User agent string last seen in the session.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;devices&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;teapot&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sessions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;connections&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;ip&#34;</span><span class="p">:</span> <span class="s2">&#34;127.0.0.1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;last_seen&#34;</span><span class="p">:</span> <span class="mi">1411996332123</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;user_agent&#34;</span><span class="p">:</span> <span class="s2">&#34;curl/7.31.0-DEV&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;ip&#34;</span><span class="p">:</span> <span class="s2">&#34;10.0.0.2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;last_seen&#34;</span><span class="p">:</span> <span class="mi">1411996332123</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;user_agent&#34;</span><span class="p">:</span> <span class="s2">&#34;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.120 Safari/537.36&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@peter:rabbit.rocks&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>

    







    
<h3 id="event-context">Event Context</h3>
<p>This API returns a number of events that happened just before and after
the specified event. This allows clients to get the context surrounding
an event.</p>
<h4 id="client-behaviour">Client behaviour</h4>
<p>There is a single HTTP API for retrieving event context, documented
below.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3roomsroomidcontexteventid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/rooms/{roomId}/context/{eventId}</span>
  </h1>
</summary>
  <hr/>
<p><p>This API returns a number of events that happened just before and
after the specified event. This allows clients to get the context
surrounding an event.</p>
<p><em>Note</em>: This endpoint supports lazy-loading of room member events. See
<a href="/client-server-api/#lazy-loading-room-members">Lazy-loading room members</a> for more information.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>eventId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The event to get context around.</td>
 </tr>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room to get events from.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>filter</code></td>
  <td><code>string</code></td>
  <td>
    <p>A JSON <code>RoomEventFilter</code> to filter the returned events with. The
filter is only applied to <code>events_before</code>, <code>events_after</code>, and
<code>state</code>. It is not applied to the <code>event</code> itself. The filter may
be applied before or/and after the <code>limit</code> parameter - whichever the
homeserver prefers.</p>
<p>See <a href="/client-server-api/#filtering">Filtering</a> for more information.</p>
</td>
 </tr>
 <tr>
  <td><code>limit</code></td>
  <td><code>integer</code></td>
  <td>
    The maximum number of context events to return. The limit applies
to the sum of the <code>events_before</code> and <code>events_after</code> arrays. The
requested event ID is always returned in <code>event</code> even if <code>limit</code> is
0. Defaults to 10.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The events and state surrounding the requested event.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>end</code></td>
  <td><code>string</code></td>
  <td>
    A token that can be used to paginate forwards with.</td>
 </tr>
 <tr>
  <td><code>event</code></td>
  <td><code>ClientEvent</code></td>
  <td>
    Details of the requested event.</td>
 </tr>
 <tr>
  <td><code>events_after</code></td>
  <td><code>[ClientEvent]</code></td>
  <td>
    A list of room events that happened just after the
requested event, in chronological order.</td>
 </tr>
 <tr>
  <td><code>events_before</code></td>
  <td><code>[ClientEvent]</code></td>
  <td>
    A list of room events that happened just before the
requested event, in reverse-chronological order.</td>
 </tr>
 <tr>
  <td><code>start</code></td>
  <td><code>string</code></td>
  <td>
    A token that can be used to paginate backwards with.</td>
 </tr>
 <tr>
  <td><code>state</code></td>
  <td><code>[ClientEvent]</code></td>
  <td>
    The state of the room at the last event returned.</td>
 </tr>
</table>
<table id="_matrixclientv3roomsroomidcontexteventid_clientevent" class="object-table">
 <caption>ClientEvent</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The body of this event, as created by the client which sent it.</td>
 </tr>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The globally unique identifier for this event.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>Timestamp (in milliseconds since the unix epoch) on originating homeserver
when this event was sent.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room associated with this event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Contains the fully-qualified ID of the user who sent this event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <p>Present if, and only if, this event is a <em>state</em> event. The key making
this piece of state unique in the room. Note that it is often an empty
string.</p>
<p>State keys starting with an <code>@</code> are reserved for referencing user IDs, such
as room members. With the exception of a few events, state events set with a
given user&rsquo;s ID as the state key MUST only be set by that user.</p>
</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of the event.</td>
 </tr>
 <tr>
  <td><code>unsigned</code></td>
  <td><code>UnsignedData</code></td>
  <td>
    Contains optional extra information about the event.</td>
 </tr>
</table>
<table id="_matrixclientv3roomsroomidcontexteventid_unsigneddata" class="object-table">
 <caption>UnsignedData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>age</code></td>
  <td><code>integer</code></td>
  <td>
    The time in milliseconds that has elapsed since the event was sent. This field is generated by the local homeserver, and may be incorrect if the local time on at least one of the two servers is out of sync, which can cause the age to either be negative or greater than it actually is.</td>
 </tr>
 <tr>
  <td><code>prev_content</code></td>
  <td><code>EventContent</code></td>
  <td>
    The previous <code>content</code> for this event. This field is generated
by the local homeserver, and is only returned if the event is a state event,
and the client has permission to see the previous content.<br><br>
    <strong>
      Changed in <code>v1.2</code>:
    </strong>
    Previously, this field was specified at the top level of returned
events rather than in <code>unsigned</code> (with the exception of the <a href="/client-server-api/#get_matrixclientv3notifications"><code>GET .../notifications</code></a>
endpoint), though in practice no known server implementations honoured
this.
</td>
 </tr>
 <tr>
  <td><code>redacted_because</code></td>
  <td><code>ClientEvent</code></td>
  <td>
    The event that redacted this event, if any.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    The client-supplied <a href="/client-server-api/#transaction-identifiers">transaction ID</a>, for example, provided via
<code>PUT /_matrix/client/v3/rooms/{roomId}/send/{eventType}/{txnId}</code>,
if the client being given the event is the same one which sent it.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;end&#34;</span><span class="p">:</span> <span class="s2">&#34;t29-57_2_0_2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;filename.jpg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;info&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;h&#34;</span><span class="p">:</span> <span class="mi">398</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;mimetype&#34;</span><span class="p">:</span> <span class="s2">&#34;image/jpeg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">31037</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;w&#34;</span><span class="p">:</span> <span class="mi">394</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.image&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/JWEIFJgwEIhweiWJE&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$f3h4d129462ha:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;events_after&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;This is an example text message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;org.matrix.custom.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;formatted_body&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;b&gt;This is an example text message&lt;/b&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;events_before&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;something-important.doc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;filename&#34;</span><span class="p">:</span> <span class="s2">&#34;something-important.doc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;info&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;mimetype&#34;</span><span class="p">:</span> <span class="s2">&#34;application/msword&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">46144</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.file&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/FHyPlCeYUSFFxlgbQYZmoEoe&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;start&#34;</span><span class="p">:</span> <span class="s2">&#34;t27-54_2_0_2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;m.federate&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;predecessor&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$something:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!oldroom:example.org&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;room_version&#34;</span><span class="p">:</span> <span class="s2">&#34;11&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.create&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/SEsfnsuifSDFSSEF&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;displayname&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice Margatroid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;join&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;Looking for support&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!636q39766251:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h4 id="security-considerations">Security considerations</h4>
<p>The server must only return results that the user has permission to see.</p>

    







    
<h3 id="sso-client-loginauthentication">SSO client login/authentication</h3>
<p>Single Sign-On (SSO) is a generic term which refers to protocols which
allow users to log into applications via a single web-based
authentication portal. Examples include OpenID Connect, &ldquo;Central
Authentication Service&rdquo; (CAS) and SAML.</p>
<p>This module allows a Matrix homeserver to delegate user authentication
to an external authentication server supporting one of these protocols.
In this process, there are three systems involved:</p>
<ul>
<li>A Matrix client, using the APIs defined this specification, which
is seeking to authenticate a user to a Matrix homeserver.</li>
<li>A Matrix homeserver, implementing the APIs defined in this
specification, but which is delegating user authentication to the
authentication server.</li>
<li>An &ldquo;authentication server&rdquo;, which is responsible for
authenticating the user.</li>
</ul>
<p>This specification is concerned only with communication between the
Matrix client and the homeserver, and is independent of the SSO protocol
used to communicate with the authentication server. Different Matrix
homeserver implementations might support different SSO protocols.</p>
<p>Clients and homeservers implementing the SSO flow will need to consider
both <a href="#login">login</a> and <a href="#user-interactive-authentication-api">user-interactive authentication</a>. The flow is
similar in both cases, but there are slight differences.</p>
<p>Typically, SSO systems require a single &ldquo;callback&rdquo; URI to be configured
at the authentication server. Once the user is authenticated, their
browser is redirected to that URI. It is up to the Matrix homeserver
implementation to implement a suitable endpoint. For example, for CAS
authentication the homeserver should provide a means for the
administrator to configure where the CAS server is and the REST
endpoints which consume the ticket.</p>
<p>Homeservers may optionally expose multiple possible SSO options for
the user to pursue, typically in the form of several &ldquo;log in with $provider&rdquo;
buttons. These are known as &ldquo;identity providers&rdquo; (IdPs).</p>
<h4 id="client-login-via-sso">Client login via SSO</h4>
<p>An overview of the process is as follows:</p>
<ol>
<li>The Matrix client calls <a href="/client-server-api/#get_matrixclientv3login"><code>GET /login</code></a> to find the supported login
types, and the homeserver includes a flow with
<code>&quot;type&quot;: &quot;m.login.sso&quot;</code> in the response.</li>
<li>To initiate the <code>m.login.sso</code> login type, the Matrix client
instructs the user&rsquo;s browser to navigate to the
<a href="/client-server-api/#get_matrixclientv3loginssoredirect"><code>/login/sso/redirect</code></a> endpoint on the user&rsquo;s homeserver.
Note that this may be the IdP-dependent version of the endpoint if the
user has selected one of the <code>identity_providers</code> from the flow.</li>
<li>The homeserver responds with an HTTP redirect to the SSO user
interface, which the browser follows.</li>
<li>The authentication server and the homeserver interact to verify the
user&rsquo;s identity and other authentication information, potentially
using a number of redirects.</li>
<li>The browser is directed to the <code>redirectUrl</code> provided by the client
with a <code>loginToken</code> query parameter for the client to log in with.</li>
<li>The client exchanges the login token for an access token by calling
the <a href="/client-server-api/#post_matrixclientv3login"><code>/login</code></a> endpoint with a <code>type</code> of <code>m.login.token</code>.</li>
</ol>
<p>For native applications, typically steps 1 to 4 are carried out by
opening an embedded web view.</p>
<p>These steps are illustrated as follows:</p>
<pre tabindex="0"><code>    Matrix Client                        Matrix Homeserver      Auth Server
        |                                       |                   |
        |-------------(0) GET /login-----------&gt;|                   |
        |&lt;-------------login types--------------|                   |
        |                                       |                   |
        |   Webview                             |                   |
        |      |                                |                   |
        |-----&gt;|                                |                   |
        |      |--(1) GET /login/sso/redirect--&gt;|                   |
        |      |&lt;---------(2) 302---------------|                   |
        |      |                                |                   |
        |      |&lt;========(3) Authentication process================&gt;|
        |      |                                |                   |
        |      |&lt;--(4) redirect to redirectUrl--|                   |
        |&lt;-----|                                |                   |
        |                                       |                   |
        |---(5) POST /login with login token---&gt;|                   |
        |&lt;-------------access token-------------|                   |
</code></pre><div class="alert note " role="alert">
In the older <a href="https://matrix.org/docs/spec/client_server/r0.4.0.html#cas-based-client-login">r0.4.0
version</a>
of this specification it was possible to authenticate via CAS when the
homeserver provides a <code>m.login.cas</code> login flow. This specification
deprecates the use of <code>m.login.cas</code> to instead prefer <code>m.login.sso</code>,
which is the same process with the only change being which redirect
endpoint to use: for <code>m.login.cas</code>, use <code>/cas/redirect</code> and for
<code>m.login.sso</code> use <code>/sso/redirect</code> (described below). The endpoints are
otherwise the same.
</div>
<section class="rendered-data definition" id="definition-mloginsso-flow-schema">
<details open>
<summary>
<h1>
 <code>m.login.sso flow schema</code>
</h1>
</summary>
<hr/>
<table class="object-table">
 <caption>m.login.sso flow schema</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>identity_providers</code></td>
  <td><code>[IdP]</code></td>
  <td>
    Optional identity providers (IdPs) to present to the user. These would
appear (typically) as distinct buttons for the user to interact with,
and would map to the appropriate IdP-dependent redirect endpoint for that
IdP.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The string <code>m.login.sso</code><p>One of: <code>[m.login.sso]</code>.</p></td>
 </tr>
</table>
<table class="object-table">
 <caption>IdP</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>brand</code></td>
  <td><code>string</code></td>
  <td>
    <p>Optional UI hint for what kind of common SSO provider is being
described in this IdP. Matrix maintains a registry of identifiers
<a href="https://github.com/matrix-org/matrix-spec/blob/main/informal/idp-brands.md">in the matrix-spec repo</a>
to ensure clients and servers are aligned on major/common brands.</p>
<p>Clients should prefer the <code>brand</code> over the <code>icon</code>, when both are
provided. Clients are not required to support any particular <code>brand</code>,
including those in the registry, though are expected to be able to
present any IdP based off the <code>name</code>/<code>icon</code> to the user regardless.</p>
<p>Unregistered brands are permitted using the <a href="/appendices/#common-namespaced-identifier-grammar">Common Namespaced Identifier Grammar</a>,
though excluding the namespace requirements. For example, <code>examplesso</code>
is a valid brand which is not in the registry but still permitted.
Servers should be mindful that clients might not support their unregistered
brand usage as intended by the server.</p>
</td>
 </tr>
 <tr>
  <td><code>icon</code></td>
  <td><code>string</code></td>
  <td>
    Optional <code>mxc://</code> URI to provide an image/icon representing the IdP.
Intended to be shown alongside the <code>name</code> if provided.</td>
 </tr>
 <tr>
  <td><code>id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Opaque string chosen by the homeserver, uniquely identifying
the IdP from other IdPs the homeserver might support. Should
be between 1 and 255 characters in length, containing unreserved
characters under <a href="http://www.ietf.org/rfc/rfc3986.txt">RFC 3986</a>
(<code>ALPHA  DIGIT  &quot;-&quot; / &quot;.&quot; / &quot;_&quot; / &quot;~&quot;</code>). Clients are not intended
to parse or infer meaning from opaque strings.</td>
 </tr>
 <tr>
  <td><code>name</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Human readable description for the IdP, intended to be shown to
the user.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;identity_providers&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;brand&#34;</span><span class="p">:</span> <span class="s2">&#34;github&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;com.example.idp.github&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;GitHub&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;icon&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.com/abc123&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;com.example.idp.gitlab&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;GitLab&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.login.sso&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h5 id="client-behaviour">Client behaviour</h5>
<p>The client starts the process by instructing the browser to navigate to
<a href="/client-server-api/#get_matrixclientv3loginssoredirect"><code>/login/sso/redirect</code></a>
(or <a href="/client-server-api/#get_matrixclientv3loginssoredirectidpid"><code>/login/sso/redirect/{idpId}</code></a>
when using one of the <code>identity_providers</code>)
with an appropriate <code>redirectUrl</code>. Once
authentication is successful, the browser will be redirected to that
<code>redirectUrl</code>.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3loginssoredirect">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/login/sso/redirect</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.1</code></strong></p>
<p><p>A web-based Matrix client should instruct the user&rsquo;s browser to
navigate to this endpoint in order to log in via SSO.</p>
<p>The server MUST respond with an HTTP redirect to the SSO interface,
or present a page which lets the user select an IdP to continue
with in the event multiple are supported by the server.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>redirectUrl</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>URI to which the user will be redirected after the homeserver has
authenticated the user with SSO.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>302</code></td>
  <td>A redirect to the SSO interface.</td>
 </tr>
</table>
</details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3loginssoredirectidpid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/login/sso/redirect/{idpId}</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.1</code></strong></p>
<p><p>This endpoint is the same as <code>/login/sso/redirect</code>, though with an
IdP ID from the original <code>identity_providers</code> array to inform the
server of which IdP the client/user would like to continue with.</p>
<p>The server MUST respond with an HTTP redirect to the SSO interface
for that IdP.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>idpId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>id</code> of the IdP from the <code>m.login.sso</code> <code>identity_providers</code>
array denoting the user&rsquo;s selection.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>redirectUrl</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>URI to which the user will be redirected after the homeserver has
authenticated the user with SSO.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>302</code></td>
  <td>A redirect to the SSO interface.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The IdP ID was not recognized by the server. The server is encouraged
to provide a user-friendly page explaining the error given the user
will be navigated to it.</td>
 </tr>
</table>
</details>
</section>
<h6 id="security-considerations">Security considerations</h6>
<ol>
<li>
<p>CSRF attacks via manipulation of parameters on the <code>redirectUrl</code></p>
<p>Clients should validate any requests to the <code>redirectUrl</code>. In
particular, it may be possible for attackers to falsify any query
parameters, leading to cross-site request forgery (CSRF) attacks.</p>
<p>For example, consider a web-based client at
<code>https://client.example.com</code>, which wants to initiate SSO login on
the homeserver at <code>server.example.org</code>. It does this by storing the
homeserver name in a query parameter for the <code>redirectUrl</code>: it
redirects to
<code>https://server.example.org/login/sso/redirect?redirectUrl=https://client.example.com?hs=server.example.org</code>.</p>
<p>An attacker could trick a victim into following a link to
<code>https://server.example.org/login/sso/redirect?redirectUrl=https://client.example.com?hs=evil.com</code>,
which would result in the client sending a login token for the
victim&rsquo;s account to the attacker-controlled site <code>evil.com</code>.</p>
<p>To guard against this, clients MUST NOT store state (such as the
address of the homeserver being logged into) anywhere it can be
modified by external processes.</p>
<p>Instead, the state could be stored in
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage">localStorage</a>
or in a cookie.</p>
</li>
<li>
<p>For added security, clients SHOULD include a unique identifier in
the <code>redirectUrl</code> and reject any callbacks that do not contain a
recognised identifier, to guard against unsolicited login attempts
and replay attacks.</p>
</li>
</ol>
<h5 id="server-behaviour">Server behaviour</h5>
<p>Servers should note that <code>identity_providers</code> are optional, and older clients
might not interpret the value correctly. In these cases, the client will use
the generic <code>/redirect</code> endpoint instead of the <code>/redirect/{idpId}</code> endpoint.</p>
<h6 id="redirecting-to-the-authentication-server">Redirecting to the Authentication server</h6>
<p>The server should handle
<code>/_matrix/client/v3/login/sso/redirect</code> as follows:</p>
<ol>
<li>It should build a suitable request for the SSO system.</li>
<li>It should store enough state that the flow can be securely resumed
after the SSO process completes. One way to do this is by storing a
cookie which is stored in the user&rsquo;s browser, by adding a
<code>Set-Cookie</code> header to the response.</li>
<li>It should redirect the user&rsquo;s browser to the SSO login page with the
appropriate parameters.</li>
</ol>
<p>See also the &ldquo;Security considerations&rdquo; below.</p>
<h6 id="handling-the-callback-from-the-authentication-server">Handling the callback from the Authentication server</h6>
<p>Note that there will normally be a single callback URI which is used for
both login and user-interactive authentication: it is up to the
homeserver implementation to distinguish which is taking place.</p>
<p>The homeserver should validate the response from the SSO system: this
may require additional calls to the authentication server, and/or may
require checking a signature on the response.</p>
<p>The homeserver then proceeds as follows:</p>
<ol>
<li>The homeserver MUST map the user details received from the
authentication server to a valid <a href="/appendices#user-identifiers">Matrix user
identifier</a>. The guidance in
<a href="/appendices#mapping-from-other-character-sets">Mapping from other character
sets</a> may be
useful.</li>
<li>If the generated user identifier represents a new user, it should be
registered as a new user.</li>
<li>The homeserver should generate a short-term login token. This is an
opaque token, suitable for use with the <code>m.login.token</code> type of the
<a href="/client-server-api/#post_matrixclientv3login"><code>/login</code></a> API. The lifetime of this token SHOULD be limited to
around five seconds.</li>
<li>The homeserver adds a query parameter of <code>loginToken</code>, with the
value of the generated login token, to the <code>redirectUrl</code> given in
the <code>/_matrix/client/v3/login/sso/redirect</code>
request. (Note: <code>redirectURL</code> may or may not include existing query
parameters. If it already includes one or more <code>loginToken</code>
parameters, they should be removed before adding the new one.)</li>
<li>The homeserver redirects the user&rsquo;s browser to the URI thus built.</li>
</ol>
<h5 id="security-considerations-1">Security considerations</h5>
<ol>
<li>
<p>Homeservers should ensure that login tokens are not sent to
malicious clients.</p>
<p>For example, consider a homeserver at <code>server.example.org</code>. An
attacker tricks a victim into following a link to
<code>https://server.example.org/login/sso/redirect?redirectUrl=https://evil.com</code>,
resulting in a login token being sent to the attacker-controlled
site <code>evil.com</code>. This is a form of cross-site request forgery
(CSRF).</p>
<p>To mitigate this, Homeservers SHOULD confirm with the user that they
are happy to grant access to their matrix account to the site named
in the <code>redirectUrl</code>. This can be done either <em>before</em> redirecting
to the SSO login page when handling the
<code>/_matrix/client/v3/login/sso/redirect</code>
endpoint, or <em>after</em> login when handling the callback from the
authentication server. (If the check is performed before
redirecting, it is particularly important that the homeserver guards
against unsolicited authentication attempts as below).</p>
<p>It may be appropriate to whitelist a set of known-trusted client
URLs in this process. In particular, the homeserver&rsquo;s own <a href="#login-fallback">login
fallback</a> implementation could be excluded.</p>
</li>
<li>
<p>For added security, homeservers SHOULD guard against unsolicited
authentication attempts by tracking pending requests. One way to do
this is to set a cookie when handling
<code>/_matrix/client/v3/login/sso/redirect</code>, which
is checked and cleared when handling the callback from the
authentication server.</p>
</li>
</ol>
<h4 id="sso-during-user-interactive-authentication">SSO during User-Interactive Authentication</h4>
<p><a href="#user-interactive-authentication-api">User-interactive authentication</a> is used by client-server endpoints
which require additional confirmation of the user&rsquo;s identity (beyond
holding an access token). Typically this means that the user must
re-enter their password, but for homeservers which delegate to an SSO
server, this means redirecting to the authentication server during
user-interactive auth.</p>
<p>The implementation of this is based on the <a href="#fallback">Fallback</a> mechanism for
user-interactive auth.</p>
<h4 id="client-behaviour-1">Client behaviour</h4>
<p>Clients do not need to take any particular additional steps beyond
ensuring that the fallback mechanism has been implemented, and treating
the <code>m.login.sso</code> authentication type the same as any other unknown type
(i.e. they should open a browser window for
<code>/_matrix/client/v3/auth/m.login.sso/fallback/web?session=&lt;session_id&gt;</code>.
Once the flow has completed, the client retries the request with the
session only.)</p>
<h4 id="server-behaviour-1">Server behaviour</h4>
<h5 id="redirecting-to-the-authentication-server-1">Redirecting to the Authentication server</h5>
<p>The server should handle
<code>/_matrix/client/v3/auth/m.login.sso/fallback/web</code>
in much the same way as
<code>/_matrix/client/v3/login/sso/redirect</code>, which is to
say:</p>
<ol>
<li>It should build a suitable request for the SSO system.</li>
<li>It should store enough state that the flow can be securely resumed
after the SSO process completes. One way to do this is by storing a
cookie which is stored in the user&rsquo;s browser, by adding a
<code>Set-Cookie</code> header to the response.</li>
<li>It should redirect the user&rsquo;s browser to the SSO login page with the
appropriate parameters.</li>
</ol>
<p>See also the &ldquo;Security considerations&rdquo; below.</p>
<h6 id="handling-the-callback-from-the-authentication-server-1">Handling the callback from the Authentication server</h6>
<p>Note that there will normally be a single callback URI which is used for
both login and user-interactive authentication: it is up to the
homeserver implementation to distinguish which is taking place.</p>
<p>The homeserver should validate the response from the SSO system: this
may require additional calls to the authentication server, and/or may
require checking a signature on the response.</p>
<p>The homeserver then returns the <a href="#fallback">user-interactive authentication
fallback completion</a> page to the user&rsquo;s browser.</p>
<h6 id="security-considerations-2">Security considerations</h6>
<ol>
<li>
<p>Confirming the operation</p>
<p>The homeserver SHOULD confirm that the user is happy for the
operation to go ahead. The goal of the user-interactive
authentication operation is to guard against a compromised
<code>access_token</code> being used to take over the user&rsquo;s account. Simply
redirecting the user to the SSO system is insufficient, since they
may not realise what is being asked of them, or the SSO system may
even confirm the authentication automatically.</p>
<p>For example, the homeserver might serve a page with words to the
effect of:</p>
<blockquote>
<p>A client is trying to remove a device from your account. To
confirm this action, re-authenticate with single sign-on. If you
did not expect this, your account may be compromised!</p>
</blockquote>
<p>This confirmation could take place before redirecting to the SSO
authentication page (when handling the
<code>/_matrix/client/v3/auth/m.login.sso/fallback/web</code>
endpoint), or <em>after</em> authentication when handling the callback from
the authentication server. (If the check is performed before
redirecting, it is particularly important that the homeserver guards
against unsolicited authentication attempts as below).</p>
</li>
<li>
<p>For added security, homeservers SHOULD guard against unsolicited
authentication attempts by tracking pending requests. One way to do
this is to set a cookie when handling
<code>/_matrix/client/v3/auth/m.login.sso/fallback/web</code>,
which is checked and cleared when handling the callback from the
authentication server.</p>
</li>
</ol>

    







    
<h3 id="direct-messaging">Direct Messaging</h3>
<p>All communication over Matrix happens within a room. It is sometimes
desirable to offer users the concept of speaking directly to one
particular person. This module defines a way of marking certain rooms as
&lsquo;direct chats&rsquo; with a given person. This does not restrict the chat to
being between exactly two people since this would preclude the presence
of automated &lsquo;bot&rsquo; users or even a &lsquo;personal assistant&rsquo; who is able to
answer direct messages on behalf of the user in their absence.</p>
<p>A room may not necessarily be considered &lsquo;direct&rsquo; by all members of the
room, but a signalling mechanism exists to propagate the information of
whether a chat is &lsquo;direct&rsquo; to an invitee.</p>
<h4 id="events">Events</h4>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mdirect">
   <code>m.direct</code>
  </h1>
</summary>
  <hr/>
<p>A map of which rooms are considered direct rooms for specific users
is kept in  <code>account_data</code> in an event of type <code>m.direct</code>. The
content of this event is an object where the keys are the user IDs
and values are lists of room ID strings of the direct rooms for
that user ID.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>{string: [string]}</code></td>
  <td>
    The mapping of user ID to a list of room IDs of the &lsquo;direct&rsquo; rooms for
that user ID.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@bob:example.com&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;!abcdefgh:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;!hgfedcba:example.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.direct&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h4 id="client-behaviour">Client behaviour</h4>
<p>To start a direct chat with another user, the inviting user&rsquo;s client
should set the <code>is_direct</code> flag to <a href="/client-server-api/#post_matrixclientv3createroom"><code>/createRoom</code></a>. The client should do this
whenever the flow the user has followed is one where their intention is
to speak directly with another person, as opposed to bringing that
person in to a shared room. For example, clicking on &lsquo;Start Chat&rsquo; beside
a person&rsquo;s profile picture would imply the <code>is_direct</code> flag should be
set.</p>
<p>The invitee&rsquo;s client may use the <code>is_direct</code> flag in the
<a href="#mroommember">m.room.member</a> event to automatically mark the room as a direct chat
but this is not required: it may for example, prompt the user, or ignore
the flag altogether.</p>
<p>Both the inviting client and the invitee&rsquo;s client should record the fact
that the room is a direct chat by storing an <code>m.direct</code> event in the
account data using <a href="/client-server-api/#put_matrixclientv3useruseridaccount_datatype"><code>/user/&lt;user_id&gt;/account_data/&lt;type&gt;</code></a>.</p>
<h4 id="server-behaviour">Server behaviour</h4>
<p>When the <code>is_direct</code> flag is given to <a href="/client-server-api/#post_matrixclientv3createroom"><code>/createRoom</code></a>, the home server must set the
<code>is_direct</code> flag in the invite member event for any users invited in the
<a href="/client-server-api/#post_matrixclientv3createroom"><code>/createRoom</code></a> call.</p>

    







    
<h3 id="ignoring-users">Ignoring Users</h3>
<p>With all the communication through Matrix it may be desirable to ignore
a particular user for whatever reason. This module defines how clients
and servers can implement the ignoring of users.</p>
<h4 id="events">Events</h4>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mignored_user_list">
   <code>m.ignored_user_list</code>
  </h1>
</summary>
  <hr/>
<p>A map of users which are considered ignored is kept in <code>account_data</code>
in an event type of <code>m.ignored_user_list</code>.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>ignored_users</code></td>
  <td><code>{string: object}</code></td>
  <td>
    <strong>Required: </strong>The map of users to ignore. This is a mapping of user ID to empty
object.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ignored_users&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;@someone:example.org&#34;</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.ignored_user_list&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h4 id="client-behaviour">Client behaviour</h4>
<p>To ignore a user, effectively blocking them, the client should add the
target user to the <code>m.ignored_user_list</code> event in their account data
using <a href="/client-server-api/#put_matrixclientv3useruseridaccount_datatype"><code>/user/&lt;user_id&gt;/account_data/&lt;type&gt;</code></a>. Once ignored, the client will no longer receive events sent by
that user, with the exception of state events. The client should either
hide previous content sent by the newly ignored user or perform a new
<code>/sync</code> with no previous token.</p>
<p>Invites to new rooms by ignored users will not be sent to the client.
The server may optionally reject the invite on behalf of the client.</p>
<p>State events will still be sent to the client, even if the user is
ignored. This is to ensure parts, such as the room name, do not appear
different to the user just because they ignored the sender.</p>
<p>To remove a user from the ignored users list, remove them from the
account data event. The server will resume sending events from the
previously ignored user, however it should not send events that were
missed while the user was ignored. To receive the events that were sent
while the user was ignored the client should perform a fresh sync. The
client may also un-hide any events it previously hid due to the user
becoming ignored.</p>
<h4 id="server-behaviour">Server behaviour</h4>
<p>Following an update of the <code>m.ignored_user_list</code>, the sync API for all
clients should immediately start ignoring (or un-ignoring) the user.
Clients are responsible for determining if they should hide previously
sent events or to start a new sync stream.</p>
<p>Servers must still send state events sent by ignored users to clients.</p>
<p>Servers must not send room invites from ignored users to clients.
Servers may optionally decide to reject the invite, however.</p>

    







    
<h3 id="sticker-messages">Sticker Messages</h3>
<p>This module allows users to send sticker messages in to rooms or direct
messaging sessions.</p>
<p>Sticker messages are specialised image messages that are displayed
without controls (e.g. no &ldquo;download&rdquo; link, or light-box view on click,
as would be displayed for for <a href="#mimage">m.image</a> events).</p>
<p>Sticker messages are intended to provide simple &ldquo;reaction&rdquo; events in the
message timeline. The matrix client should provide some mechanism to
display the sticker &ldquo;body&rdquo; e.g. as a tooltip on hover, or in a modal
when the sticker image is clicked.</p>
<h4 id="events">Events</h4>
<p>Sticker events are received as a single <code>m.sticker</code> event in the
<code>timeline</code> section of a room, in a <code>/sync</code>.</p>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="msticker">
   <code>m.sticker</code>
  </h1>
</summary>
  <hr/>
<p>This message represents a single sticker image.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>body</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A textual representation or associated description of the sticker
image. This could be the alt text of the original image, or a message
to accompany and further describe the sticker.</td>
 </tr>
 <tr>
  <td><code>info</code></td>
  <td><code>ImageInfo</code></td>
  <td>
    <strong>Required: </strong>Metadata about the image referred to in <code>url</code> including a thumbnail
representation.</td>
 </tr>
 <tr>
  <td><code>url</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The URL to the sticker image. This must be a valid <code>mxc://</code> URI.</td>
 </tr>
</table>
<table id="msticker_imageinfo" class="object-table">
 <caption>ImageInfo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>h</code></td>
  <td><code>integer</code></td>
  <td>
    The intended display height of the image in pixels. This may
differ from the intrinsic dimensions of the image file.</td>
 </tr>
 <tr>
  <td><code>mimetype</code></td>
  <td><code>string</code></td>
  <td>
    The mimetype of the image, e.g. <code>image/jpeg</code>.</td>
 </tr>
 <tr>
  <td><code>size</code></td>
  <td><code>integer</code></td>
  <td>
    Size of the image in bytes.</td>
 </tr>
 <tr>
  <td><code>thumbnail_file</code></td>
  <td><code>EncryptedFile</code></td>
  <td>
    Information on the encrypted thumbnail file, as specified in
<a href="/client-server-api/#sending-encrypted-attachments">End-to-end encryption</a>.
Only present if the thumbnail is encrypted.</td>
 </tr>
 <tr>
  <td><code>thumbnail_info</code></td>
  <td><code>ThumbnailInfo</code></td>
  <td>
    Metadata about the image referred to in <code>thumbnail_url</code>.</td>
 </tr>
 <tr>
  <td><code>thumbnail_url</code></td>
  <td><code>string</code></td>
  <td>
    The URL (typically <a href="/client-server-api/#matrix-content-mxc-uris"><code>mxc://</code> URI</a>) to a thumbnail of the image.
Only present if the thumbnail is unencrypted.</td>
 </tr>
 <tr>
  <td><code>w</code></td>
  <td><code>integer</code></td>
  <td>
    The intended display width of the image in pixels. This may
differ from the intrinsic dimensions of the image file.</td>
 </tr>
</table>
<table id="msticker_thumbnailinfo" class="object-table">
 <caption>ThumbnailInfo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>h</code></td>
  <td><code>integer</code></td>
  <td>
    The intended display height of the image in pixels. This may
differ from the intrinsic dimensions of the image file.</td>
 </tr>
 <tr>
  <td><code>mimetype</code></td>
  <td><code>string</code></td>
  <td>
    The mimetype of the image, e.g. <code>image/jpeg</code>.</td>
 </tr>
 <tr>
  <td><code>size</code></td>
  <td><code>integer</code></td>
  <td>
    Size of the image in bytes.</td>
 </tr>
 <tr>
  <td><code>w</code></td>
  <td><code>integer</code></td>
  <td>
    The intended display width of the image in pixels. This may
differ from the intrinsic dimensions of the image file.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;Landing&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;info&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;h&#34;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;mimetype&#34;</span><span class="p">:</span> <span class="s2">&#34;image/png&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">73602</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;thumbnail_info&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;h&#34;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;mimetype&#34;</span><span class="p">:</span> <span class="s2">&#34;image/png&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">73602</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;w&#34;</span><span class="p">:</span> <span class="mi">140</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;thumbnail_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://matrix.org/sHhqkFCvSkFwtmvtETOtKnLP&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;w&#34;</span><span class="p">:</span> <span class="mi">140</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://matrix.org/sHhqkFCvSkFwtmvtETOtKnLP&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.sticker&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h4 id="client-behaviour">Client behaviour</h4>
<p>Clients supporting this message type should display the image content
from the event URL directly in the timeline.</p>
<p>A thumbnail image should be provided in the <code>info</code> object. This is
largely intended as a fallback for clients that do not fully support the
<code>m.sticker</code> event type. In most cases it is fine to set the thumbnail
URL to the same URL as the main event content.</p>
<p>It is recommended that sticker image content should be 512x512 pixels in
size or smaller. The dimensions of the image file should be twice the
intended display size specified in the <code>info</code> object in order to assist
rendering sharp images on higher DPI screens.</p>

    







    
<h3 id="reporting-content">Reporting Content</h3>
<p>Users may encounter content which they find inappropriate and should be
able to report it to the server administrators or room moderators for
review. This module defines a way for users to report content.</p>
<p>Content is reported based upon a negative score, where -100 is &ldquo;most
offensive&rdquo; and 0 is &ldquo;inoffensive&rdquo;.</p>
<h4 id="client-behaviour">Client behaviour</h4>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3roomsroomidreporteventid">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/rooms/{roomId}/report/{eventId}</span>
  </h1>
</summary>
  <hr/>
<p><br><br>
<strong>
Changed in <code>v1.8</code>:
</strong>
This endpoint now requires the user to be joined to the room.</p>
<p><p>Reports an event as inappropriate to the server, which may then notify
the appropriate people. The caller must be joined to the room to report
it.</p>
<p>It might be possible for clients to deduce whether an event exists by
timing the response, as only a report for an event that does exist
will require the homeserver to check whether a user is joined to
the room. To combat this, homeserver implementations should add
a random delay when generating a response.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>eventId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The event to report.</td>
 </tr>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room in which the event being reported is located.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>reason</code></td>
  <td><code>string</code></td>
  <td>
    The reason the content is being reported. May be blank.</td>
 </tr>
 <tr>
  <td><code>score</code></td>
  <td><code>integer</code></td>
  <td>
    The score to rate this content as where -100 is most offensive
and 0 is inoffensive.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;this makes me sad&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;score&#34;</span><span class="p">:</span> <span class="mi">-100</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The event has been reported successfully.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td><p>The event was not found or you are not joined to the room where the
event resides.</p>
<p>Homeserver implementations can additionally return this error if the
reported event has been redacted.</p>
</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3roomsroomidreporteventid_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;The event was not found or you are not joined to the room.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h4 id="server-behaviour">Server behaviour</h4>
<p>Servers are free to handle the reported content however they desire.
This may be a dedicated room to alert server administrators to the
reported content or some other mechanism for notifying the appropriate
people.</p>
<p>



  <span><strong>[Changed in <code>v1.8</code>]</strong></span>
 
 The server MUST verify that the user
reporting the event is currently joined to the room the event is
in before accepting a report.</p>

    







    
<h3 id="third-party-networks">Third-party Networks</h3>
<p>Application services can provide access to third-party networks via
bridging. This allows Matrix users to communicate with users on other
communication platforms, with messages ferried back and forth by the
application service. A single application service may bridge multiple
third-party networks, and many individual locations within those
networks. A single third-party network location may be bridged to
multiple Matrix rooms.</p>
<h4 id="third-party-lookups">Third-party Lookups</h4>
<p>A client may wish to provide a rich interface for joining third-party
locations and connecting with third-party users. Information necessary
for such an interface is provided by third-party lookups.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3thirdpartylocation">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/thirdparty/location</span>
  </h1>
</summary>
  <hr/>
<p>Retrieve an array of third-party network locations from a Matrix room
alias.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>alias</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The Matrix room alias to look up.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>All found third-party locations.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The Matrix room alias was not found</td>
 </tr>
</table>
<h3>200 response</h3>
<p>Array of <code>Location</code>.</p>
<table id="_matrixclientv3thirdpartylocation_location" class="object-table">
 <caption>Location</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>alias</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An alias for a matrix room.</td>
 </tr>
 <tr>
  <td><code>fields</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>Information used to identify this third-party location.</td>
 </tr>
 <tr>
  <td><code>protocol</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The protocol ID that the third-party location is a part of.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;alias&#34;</span><span class="p">:</span> <span class="s2">&#34;#freenode_#matrix:matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;fields&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;channel&#34;</span><span class="p">:</span> <span class="s2">&#34;#matrix&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;network&#34;</span><span class="p">:</span> <span class="s2">&#34;freenode&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;protocol&#34;</span><span class="p">:</span> <span class="s2">&#34;irc&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3thirdpartylocation_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3thirdpartylocationprotocol">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/thirdparty/location/{protocol}</span>
  </h1>
</summary>
  <hr/>
<p>Requesting this endpoint with a valid protocol name results in a list
of successful mapping results in a JSON array. Each result contains
objects to represent the Matrix room or rooms that represent a portal
to this third-party network. Each has the Matrix room alias string,
an identifier for the particular third-party network protocol, and an
object containing the network-specific fields that comprise this
identifier. It should attempt to canonicalise the identifier as much
as reasonably possible given the network type.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>protocol</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The protocol used to communicate to the third-party network.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>searchFields</code></td>
  <td><code>string</code></td>
  <td>
    One or more custom fields to help identify the third-party
location.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>At least one portal room was found.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>No portal rooms were found.</td>
 </tr>
</table>
<h3>200 response</h3>
<p>Array of <code>Location</code>.</p>
<table id="_matrixclientv3thirdpartylocationprotocol_location" class="object-table">
 <caption>Location</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>alias</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An alias for a matrix room.</td>
 </tr>
 <tr>
  <td><code>fields</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>Information used to identify this third-party location.</td>
 </tr>
 <tr>
  <td><code>protocol</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The protocol ID that the third-party location is a part of.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;alias&#34;</span><span class="p">:</span> <span class="s2">&#34;#freenode_#matrix:matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;fields&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;channel&#34;</span><span class="p">:</span> <span class="s2">&#34;#matrix&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;network&#34;</span><span class="p">:</span> <span class="s2">&#34;freenode&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;protocol&#34;</span><span class="p">:</span> <span class="s2">&#34;irc&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3thirdpartylocationprotocol_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3thirdpartyprotocolprotocol">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/thirdparty/protocol/{protocol}</span>
  </h1>
</summary>
  <hr/>
<p>Fetches the metadata from the homeserver about a particular third-party protocol.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>protocol</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The name of the protocol.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The protocol was found and metadata returned.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The protocol is unknown.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="_matrixclientv3thirdpartyprotocolprotocol_protocol" class="object-table">
 <caption>Protocol</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>field_types</code></td>
  <td><code>{string: Field Type}</code></td>
  <td>
    <strong>Required: </strong><p>The type definitions for the fields defined in the <code>user_fields</code> and
<code>location_fields</code>. Each entry in those arrays MUST have an entry here. The
<code>string</code> key for this object is field name itself.</p>
<p>May be an empty object if no fields are defined.</p>
</td>
 </tr>
 <tr>
  <td><code>icon</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A content URI representing an icon for the third-party protocol.</td>
 </tr>
 <tr>
  <td><code>instances</code></td>
  <td><code>[Protocol Instance]</code></td>
  <td>
    <strong>Required: </strong>A list of objects representing independent instances of configuration.
For example, multiple networks on IRC if multiple are provided by the
same application service.</td>
 </tr>
 <tr>
  <td><code>location_fields</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>Fields which may be used to identify a third-party location. These should be
ordered to suggest the way that entities may be grouped, where higher
groupings are ordered first. For example, the name of a network should be
searched before the name of a channel.</td>
 </tr>
 <tr>
  <td><code>user_fields</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>Fields which may be used to identify a third-party user. These should be
ordered to suggest the way that entities may be grouped, where higher
groupings are ordered first. For example, the name of a network should be
searched before the nickname of a user.</td>
 </tr>
</table>
<table id="_matrixclientv3thirdpartyprotocolprotocol_field-type" class="object-table">
 <caption>Field Type</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>placeholder</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An placeholder serving as a valid example of the field value.</td>
 </tr>
 <tr>
  <td><code>regexp</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A regular expression for validation of a field&rsquo;s value. This may be relatively
coarse to verify the value as the application service providing this protocol
may apply additional validation or filtering.</td>
 </tr>
</table>
<table id="_matrixclientv3thirdpartyprotocolprotocol_protocol-instance" class="object-table">
 <caption>Protocol Instance</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>desc</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A human-readable description for the protocol, such as the name.</td>
 </tr>
 <tr>
  <td><code>fields</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>Preset values for <code>fields</code> the client may use to search by.</td>
 </tr>
 <tr>
  <td><code>icon</code></td>
  <td><code>string</code></td>
  <td>
    An optional content URI representing the protocol. Overrides the one provided
at the higher level Protocol object.</td>
 </tr>
 <tr>
  <td><code>network_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A unique identifier across all instances.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;field_types&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;channel&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;placeholder&#34;</span><span class="p">:</span> <span class="s2">&#34;#foobar&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;regexp&#34;</span><span class="p">:</span> <span class="s2">&#34;#[^\\s]+&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;network&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;placeholder&#34;</span><span class="p">:</span> <span class="s2">&#34;irc.example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;regexp&#34;</span><span class="p">:</span> <span class="s2">&#34;([a-z0-9]+\\.)*[a-z0-9]+&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;nickname&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;placeholder&#34;</span><span class="p">:</span> <span class="s2">&#34;username&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;regexp&#34;</span><span class="p">:</span> <span class="s2">&#34;[^\\s#]+&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;icon&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/aBcDeFgH&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;instances&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;desc&#34;</span><span class="p">:</span> <span class="s2">&#34;Freenode&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;fields&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;network&#34;</span><span class="p">:</span> <span class="s2">&#34;freenode&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;icon&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/JkLmNoPq&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;network_id&#34;</span><span class="p">:</span> <span class="s2">&#34;freenode&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;location_fields&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;network&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;channel&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;user_fields&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;network&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;nickname&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3thirdpartyprotocolprotocol_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3thirdpartyprotocols">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/thirdparty/protocols</span>
  </h1>
</summary>
  <hr/>
<p>Fetches the overall metadata about protocols supported by the
homeserver. Includes both the available protocols and all fields
required for queries against each protocol.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<p>No request parameters or request body.</p>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The protocols supported by the homeserver.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>{string: Protocol}</code></td>
  <td>
    Dictionary of supported third-party protocols.</td>
 </tr>
</table>
<table id="_matrixclientv3thirdpartyprotocols_protocol" class="object-table">
 <caption>Protocol</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>field_types</code></td>
  <td><code>{string: Field Type}</code></td>
  <td>
    <strong>Required: </strong><p>The type definitions for the fields defined in the <code>user_fields</code> and
<code>location_fields</code>. Each entry in those arrays MUST have an entry here. The
<code>string</code> key for this object is field name itself.</p>
<p>May be an empty object if no fields are defined.</p>
</td>
 </tr>
 <tr>
  <td><code>icon</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A content URI representing an icon for the third-party protocol.</td>
 </tr>
 <tr>
  <td><code>instances</code></td>
  <td><code>[Protocol Instance]</code></td>
  <td>
    <strong>Required: </strong>A list of objects representing independent instances of configuration.
For example, multiple networks on IRC if multiple are provided by the
same application service.</td>
 </tr>
 <tr>
  <td><code>location_fields</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>Fields which may be used to identify a third-party location. These should be
ordered to suggest the way that entities may be grouped, where higher
groupings are ordered first. For example, the name of a network should be
searched before the name of a channel.</td>
 </tr>
 <tr>
  <td><code>user_fields</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>Fields which may be used to identify a third-party user. These should be
ordered to suggest the way that entities may be grouped, where higher
groupings are ordered first. For example, the name of a network should be
searched before the nickname of a user.</td>
 </tr>
</table>
<table id="_matrixclientv3thirdpartyprotocols_field-type" class="object-table">
 <caption>Field Type</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>placeholder</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An placeholder serving as a valid example of the field value.</td>
 </tr>
 <tr>
  <td><code>regexp</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A regular expression for validation of a field&rsquo;s value. This may be relatively
coarse to verify the value as the application service providing this protocol
may apply additional validation or filtering.</td>
 </tr>
</table>
<table id="_matrixclientv3thirdpartyprotocols_protocol-instance" class="object-table">
 <caption>Protocol Instance</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>desc</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A human-readable description for the protocol, such as the name.</td>
 </tr>
 <tr>
  <td><code>fields</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>Preset values for <code>fields</code> the client may use to search by.</td>
 </tr>
 <tr>
  <td><code>icon</code></td>
  <td><code>string</code></td>
  <td>
    An optional content URI representing the protocol. Overrides the one provided
at the higher level Protocol object.</td>
 </tr>
 <tr>
  <td><code>network_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A unique identifier across all instances.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;gitter&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;field_types&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;placeholder&#34;</span><span class="p">:</span> <span class="s2">&#34;matrix-org/matrix-doc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;regexp&#34;</span><span class="p">:</span> <span class="s2">&#34;[^\\s]+\\/[^\\s]+&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;username&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;placeholder&#34;</span><span class="p">:</span> <span class="s2">&#34;@username&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;regexp&#34;</span><span class="p">:</span> <span class="s2">&#34;@[^\\s]+&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;instances&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;desc&#34;</span><span class="p">:</span> <span class="s2">&#34;Gitter&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;fields&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;icon&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/zXyWvUt&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;network_id&#34;</span><span class="p">:</span> <span class="s2">&#34;gitter&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;location_fields&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;room&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;user_fields&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;username&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;irc&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;field_types&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;channel&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;placeholder&#34;</span><span class="p">:</span> <span class="s2">&#34;#foobar&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;regexp&#34;</span><span class="p">:</span> <span class="s2">&#34;#[^\\s]+&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;network&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;placeholder&#34;</span><span class="p">:</span> <span class="s2">&#34;irc.example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;regexp&#34;</span><span class="p">:</span> <span class="s2">&#34;([a-z0-9]+\\.)*[a-z0-9]+&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;nickname&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;placeholder&#34;</span><span class="p">:</span> <span class="s2">&#34;username&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;regexp&#34;</span><span class="p">:</span> <span class="s2">&#34;[^\\s]+&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;icon&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/aBcDeFgH&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;instances&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;desc&#34;</span><span class="p">:</span> <span class="s2">&#34;Freenode&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;fields&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;network&#34;</span><span class="p">:</span> <span class="s2">&#34;freenode.net&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;icon&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/JkLmNoPq&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;network_id&#34;</span><span class="p">:</span> <span class="s2">&#34;freenode&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;location_fields&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;network&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;channel&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;user_fields&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;network&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;nickname&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3thirdpartyuser">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/thirdparty/user</span>
  </h1>
</summary>
  <hr/>
<p>Retrieve an array of third-party users from a Matrix User ID.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>userid</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The Matrix User ID to look up.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>An array of third-party users.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The Matrix User ID was not found</td>
 </tr>
</table>
<h3>200 response</h3>
<p>Array of <code>User</code>.</p>
<table id="_matrixclientv3thirdpartyuser_user" class="object-table">
 <caption>User</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>fields</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>Information used to identify this third-party location.</td>
 </tr>
 <tr>
  <td><code>protocol</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The protocol ID that the third-party location is a part of.</td>
 </tr>
 <tr>
  <td><code>userid</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A Matrix User ID represting a third-party user.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;fields&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;user&#34;</span><span class="p">:</span> <span class="s2">&#34;jim&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;protocol&#34;</span><span class="p">:</span> <span class="s2">&#34;gitter&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;userid&#34;</span><span class="p">:</span> <span class="s2">&#34;@_gitter_jim:matrix.org&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3thirdpartyuser_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv3thirdpartyuserprotocol">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v3/thirdparty/user/{protocol}</span>
  </h1>
</summary>
  <hr/>
<p>Retrieve a Matrix User ID linked to a user on the third-party service, given
a set of user parameters.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>protocol</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The name of the protocol.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>fields</code></td>
  <td><code>{string: string}</code></td>
  <td>
    One or more custom fields that are passed to the AS to help identify the user.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The Matrix User IDs found with the given parameters.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The Matrix User ID was not found</td>
 </tr>
</table>
<h3>200 response</h3>
<p>Array of <code>User</code>.</p>
<table id="_matrixclientv3thirdpartyuserprotocol_user" class="object-table">
 <caption>User</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>fields</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>Information used to identify this third-party location.</td>
 </tr>
 <tr>
  <td><code>protocol</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The protocol ID that the third-party location is a part of.</td>
 </tr>
 <tr>
  <td><code>userid</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A Matrix User ID represting a third-party user.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;fields&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;user&#34;</span><span class="p">:</span> <span class="s2">&#34;jim&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;protocol&#34;</span><span class="p">:</span> <span class="s2">&#34;gitter&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;userid&#34;</span><span class="p">:</span> <span class="s2">&#34;@_gitter_jim:matrix.org&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="_matrixclientv3thirdpartyuserprotocol_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>

    







    
<h3 id="openid">OpenID</h3>
<p>This module allows users to verify their identity with a third-party
service. The third-party service does need to be matrix-aware in that it
will need to know to resolve matrix homeservers to exchange the user&rsquo;s
token for identity information.</p>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3useruseridopenidrequest_token">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/user/{userId}/openid/request_token</span>
  </h1>
</summary>
  <hr/>
<p><p>Gets an OpenID token object that the requester may supply to another
service to verify their identity in Matrix. The generated token is only
valid for exchanging for user information from the federation API for
OpenID.</p>
<p>The access token generated is only valid for the OpenID API. It cannot
be used to request another OpenID access token or call <code>/sync</code>, for
example.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>userId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user to request an OpenID token for. Should be the user who
is authenticated for the request.</td>
 </tr>
</table>
<h3>Request body</h3>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>OpenID token information. This response is nearly compatible with the
response documented in the
<a href="http://openid.net/specs/openid-connect-core-1_0.html#TokenResponse">OpenID Connect 1.0 Specification</a>
with the only difference being the lack of an <code>id_token</code>. Instead,
the Matrix homeserver&rsquo;s name is provided.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="_matrixclientv3useruseridopenidrequest_token_openidcredentials" class="object-table">
 <caption>OpenIdCredentials</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>access_token</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An access token the consumer may use to verify the identity of
the person who generated the token. This is given to the federation
API <code>GET /openid/userinfo</code> to verify the user&rsquo;s identity.</td>
 </tr>
 <tr>
  <td><code>expires_in</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The number of seconds before this token expires and a new one must
be generated.</td>
 </tr>
 <tr>
  <td><code>matrix_server_name</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The homeserver domain the consumer should use when attempting to
verify the user&rsquo;s identity.</td>
 </tr>
 <tr>
  <td><code>token_type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The string <code>Bearer</code>.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;access_token&#34;</span><span class="p">:</span> <span class="s2">&#34;SomeT0kenHere&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;expires_in&#34;</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;matrix_server_name&#34;</span><span class="p">:</span> <span class="s2">&#34;example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;token_type&#34;</span><span class="p">:</span> <span class="s2">&#34;Bearer&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv3useruseridopenidrequest_token_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>

    







    
<h3 id="server-access-control-lists-acls-for-rooms">Server Access Control Lists (ACLs) for rooms</h3>
<p>In some scenarios room operators may wish to prevent a malicious or
untrusted server from participating in their room. Sending an
<a href="#mroomserver_acl">m.room.server_acl</a> state event into a room is an effective way to
prevent the server from participating in the room at the federation
level.</p>
<p>Server ACLs can also be used to make rooms only federate with a limited
set of servers, or retroactively make the room no longer federate with
any other server, similar to setting the <code>m.federate</code> value on the
<a href="#mroomcreate">m.room.create</a> event.</p>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mroomserver_acl">
   <code>m.room.server_acl</code>
  </h1>
</summary>
  <hr/>
<p>An event to indicate which servers are permitted to participate in the
room. Server ACLs may allow or deny groups of hosts. All servers participating
in the room, including those that are denied, are expected to uphold the
server ACL. Servers that do not uphold the ACLs MUST be added to the denied hosts
list in order for the ACLs to remain effective.</p>
<p>The <code>allow</code> and <code>deny</code> lists are lists of <a href="/appendices#glob-style-matching">glob-style patterns</a>.
When comparing against the server ACLs, the suspect server&rsquo;s port
number must not be considered. Therefore <code>evil.com</code>, <code>evil.com:8448</code>, and
<code>evil.com:1234</code> would all match rules that apply to <code>evil.com</code>, for example.</p>
<p>The ACLs are applied to servers when they make requests, and are applied in
the following order:</p>
<ol>
<li>If there is no <code>m.room.server_acl</code> event in the room state, allow.</li>
<li>If the server name is an IP address (v4 or v6) literal, and <code>allow_ip_literals</code>
is present and <code>false</code>, deny.</li>
<li>If the server name matches an entry in the <code>deny</code> list, deny.</li>
<li>If the server name matches an entry in the <code>allow</code> list, allow.</li>
<li>Otherwise, deny.</li>
</ol>
<p><strong>Note:</strong>
Server ACLs do not restrict the events relative to the room DAG via authorisation
rules, but instead act purely at the network layer to determine which servers are
allowed to connect and interact with a given room.</p>
<p><strong>Warning:</strong>
Failing to provide an <code>allow</code> rule of some kind will prevent <strong>all</strong>
servers from participating in the room, including the sender. This renders
the room unusable. A common allow rule is <code>[ &quot;*&quot; ]</code> which would still
permit the use of the <code>deny</code> list without losing the room.</p>
<p><strong>Warning:</strong>
All compliant servers must implement server ACLs.  However, legacy or noncompliant
servers exist which do not uphold ACLs, and these MUST be manually appended to
the denied hosts list when setting an ACL to prevent them from leaking events from
banned servers into a room. Currently, the only way to determine noncompliant hosts is
to check the <code>prev_events</code> of leaked events, therefore detecting servers which
are not upholding the ACLs. Server versions can also be used to try to detect hosts that
will not uphold the ACLs, although this is not comprehensive. Server ACLs were added
in Synapse v0.32.0, although other server implementations and versions exist in the world.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>State event</td>
  </tr>
  <tr>
   <th>State key</th>
   <td>A zero-length string.</td>
 </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>allow</code></td>
  <td><code>[string]</code></td>
  <td>
    <p>The server names to allow in the room, excluding any port information.
Each entry is interpreted as a <a href="/appendices#glob-style-matching">glob-style pattern</a>.</p>
<p><strong>This defaults to an empty list when not provided, effectively disallowing
every server.</strong></p>
</td>
 </tr>
 <tr>
  <td><code>allow_ip_literals</code></td>
  <td><code>boolean</code></td>
  <td>
    <p>True to allow server names that are IP address literals. False to
deny. Defaults to true if missing or otherwise not a boolean.</p>
<p>This is strongly recommended to be set to <code>false</code> as servers running
with IP literal names are strongly discouraged in order to require
legitimate homeservers to be backed by a valid registered domain name.</p>
</td>
 </tr>
 <tr>
  <td><code>deny</code></td>
  <td><code>[string]</code></td>
  <td>
    <p>The server names to disallow in the room, excluding any port information.
Each entry is interpreted as a <a href="/appendices#glob-style-matching">glob-style pattern</a>.</p>
<p>This defaults to an empty list when not provided.</p>
</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;allow&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;*&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;allow_ip_literals&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;deny&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;*.evil.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;evil.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.server_acl&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<div class="alert note " role="alert">
Port numbers are not supported because it is unclear to parsers whether
a port number should be matched or an IP address literal. Additionally,
it is unlikely that one would trust a server running on a particular
domain&rsquo;s port but not a different port, especially considering the
server host can easily change ports.
</div>
<div class="alert note " role="alert">
CIDR notation is not supported for IP addresses because Matrix does not
encourage the use of IPs for identifying servers. Instead, a blanket
<code>allow_ip_literals</code> is provided to cover banning them.
</div>
<h4 id="client-behaviour">Client behaviour</h4>
<p>Clients are not expected to perform any additional duties beyond sending
the event. Clients should describe changes to the server ACLs to the
user in the user interface, such as in the timeline.</p>
<p>Clients may wish to kick affected users from the room prior to denying a
server access to the room to help prevent those servers from
participating and to provide feedback to the users that they have been
excluded from the room.</p>
<h4 id="server-behaviour">Server behaviour</h4>
<p>Servers MUST prevent blacklisted servers from sending events or
participating in the room when an <a href="#mroomserver_acl">m.room.server_acl</a> event is
present in the room state. Which APIs are specifically affected are
described in the Server-Server API specification.</p>
<p>Servers should still send events to denied servers if they are still
residents of the room.</p>
<h4 id="security-considerations">Security considerations</h4>
<p>Server ACLs are only effective if every server in the room honours them.
Servers that do not honour the ACLs may still permit events sent by
denied servers into the room, leaking them to other servers in the room.
To effectively enforce an ACL in a room, the servers that do not honour
the ACLs should be denied in the room as well.</p>

    







    
<h3 id="user-and-room-mentions">User and room mentions</h3>
<p><span><strong>[Changed in <code>v1.7</code>]</strong></span></p>
<p>This module allows users to &ldquo;mention&rdquo; other users and rooms within a room event.
This is primarily used as an indicator that the recipient should receive a notification
about the event.
This is achieved by including metadata in the <code>m.mentions</code> content property of
the event to reference the entity being mentioned.</p>
<p><code>m.mentions</code> is defined as follows:</p>
<section class="rendered-data definition" id="definition-mmentions">
<details open>
<summary>
<h1>
 <code>m.mentions</code>
</h1>
</summary>
<hr/>
<p>Describes whether the event mentions other users or the room. This is contained
within the events <code>content</code> alongside other fields for the relevant event type.</p>
<table class="object-table">
 <caption>m.mentions</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>room</code></td>
  <td><code>boolean</code></td>
  <td>
    A boolean set to <code>true</code> to mention the room, for an <code>@room</code> notification.
(<code>room</code> should otherwise not be included on the event.)</td>
 </tr>
 <tr>
  <td><code>user_ids</code></td>
  <td><code>[string]</code></td>
  <td>
    A list of Matrix IDs of mentioned users.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;user_ids&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;@alice:example.org&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<p>An event&rsquo;s content will then look like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;Hello Alice!&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;org.matrix.custom.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;formatted_body&#34;</span><span class="p">:</span> <span class="s2">&#34;Hello &lt;a href=&#39;https://matrix.to/#/@alice:example.org&#39;&gt;Alice&lt;/a&gt;!&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.mentions&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;user_ids&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;@alice:example.org&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Additionally, see the <a href="#_m_rule_is_user_mention"><code>.m.rule.is_user_mention</code></a> and
<a href="#_m_rule_is_room_mention"><code>.m.rule.is_room_mention</code></a> push rules.
Users should not add their own Matrix ID to the <code>m.mentions</code> property as outgoing
messages cannot self-notify.</p>
<div class="alert warning " role="alert">
If an encrypted event contains an <code>m.mentions</code> in its payload, it should be
encrypted as normal. To properly process mentions in encrypted rooms, events
must be decrypted first. See <a href="#receiving-notifications">receiving notifications</a>.
</div>
<p>Note that, for backwards compatibility, push rules such as <a href="#_m_rule_contains_display_name"><code>.m.rule.contains_display_name</code></a>,
<a href="#_m_rule_contains_user_name"><code>.m.rule.contains_user_name</code></a>, and
<a href="#_m_rule_roomnotif"><code>.m.rule.roomnotif</code></a> continue to  match if the <code>body</code> of
the event contains the user&rsquo;s display name or ID. To avoid unintentional notifications,
<strong>it is recommended that clients include a <code>m.mentions</code> property on each event</strong>.
(If there are no mentions to include it can be an empty object.)</p>
<div class="alert rationale " role="alert">
In previous versions of the specification, mentioning users was done by
including the user&rsquo;s display name or the localpart of their Matrix ID and room
mentions were done by including the string &ldquo;@room&rdquo; in the plaintext <code>body</code> of
the event. This was prone to confusing and buggy behaviour.
</div>
<h4 id="client-behaviour">Client behaviour</h4>
<p>Although it is possible to silently mention users, it is recommended to include a
<a href="/appendices/#uris">Matrix URI</a> in the HTML body of  an <a href="#mroommessage">m.room.message</a>
event. This applies only to <a href="#mroommessage">m.room.message</a> events where the <code>msgtype</code> is
<code>m.text</code>, <code>m.emote</code>, or <code>m.notice</code>. The <code>format</code> for the event must be
<code>org.matrix.custom.html</code> and therefore requires a <code>formatted_body</code>.</p>
<p>Clients should use the following guidelines when adding a <code>Matrix URI</code>
representing a mention to events to be sent:</p>
<ul>
<li>When linking to users, use the user&rsquo;s potentially ambiguous display
name for the anchor&rsquo;s text. If the user does not have a display
name, use the user&rsquo;s ID.</li>
<li>When linking to rooms, use the canonical alias for the room. If the
room does not have a canonical alias, prefer one of the aliases
listed on the room. If no alias can be found, fall back to the room
ID. In all cases, use the alias/room ID being linked to as the
anchor&rsquo;s text.</li>
</ul>
<p>The text component of the anchor should be used in the event&rsquo;s <code>body</code>
where the link would normally be represented, as shown in the example
above.</p>
<p>Clients should display mentions differently from other elements. For
example, this may be done by changing the background color of the
mention to indicate that it is different from a normal link.</p>
<p>If the current user is mentioned in a message, the client should show that
mention differently from other mentions, such as by using a red
background color to signify to the user that they were mentioned. Note that
it is possible for a user to be mentioned without including their <code>Matrix URI</code>
in the event.</p>
<p>When clicked, the mention should navigate the user to the appropriate
user or room information.</p>

    







    
<h3 id="room-upgrades">Room Upgrades</h3>
<p>From time to time, a room may need to be upgraded to a different room
version for a variety of reasons. This module defines a way for rooms
to upgrade to a different room version when needed.</p>
<h4 id="events">Events</h4>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mroomtombstone">
   <code>m.room.tombstone</code>
  </h1>
</summary>
  <hr/>
<p>A state event signifying that a room has been upgraded to a different room version, and that clients should go there.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>State event</td>
  </tr>
  <tr>
   <th>State key</th>
   <td>A zero-length string.</td>
 </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>body</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A server-defined message.</td>
 </tr>
 <tr>
  <td><code>replacement_room</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID of the new room the client should be visiting.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;This room has been replaced&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;replacement_room&#34;</span><span class="p">:</span> <span class="s2">&#34;!newroom:example.org&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.tombstone&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h4 id="client-behaviour">Client behaviour</h4>
<p>Clients which understand <code>m.room.tombstone</code> events and the <code>predecessor</code>
field on <code>m.room.create</code> events should communicate to the user that the
room was upgraded. One way of accomplishing this would be hiding the old
room from the user&rsquo;s room list and showing banners linking between the
old and new room - ensuring that permalinks work when referencing the
old room. Another approach may be to virtually merge the rooms such that
the old room&rsquo;s timeline seamlessly continues into the new timeline
without the user having to jump between the rooms.</p>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixclientv3roomsroomidupgrade">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/client/v3/rooms/{roomId}/upgrade</span>
  </h1>
</summary>
  <hr/>
<p>Upgrades the given room to a particular room version.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room to upgrade.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>new_version</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The new version for the room.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;new_version&#34;</span><span class="p">:</span> <span class="s2">&#34;2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The room was successfully upgraded.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td>The request was invalid. One way this can happen is if the room version
requested is not supported by the homeserver.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The user is not permitted to upgrade the room.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>replacement_room</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the new room.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;replacement_room&#34;</span><span class="p">:</span> <span class="s2">&#34;!newroom:example.org&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv3roomsroomidupgrade_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_UNSUPPORTED_ROOM_VERSION&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;This server does not support that room version&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv3roomsroomidupgrade_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;You cannot upgrade this room&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h4 id="server-behaviour">Server behaviour</h4>
<p>When the client requests to upgrade a known room to a known version, the
server:</p>
<ol>
<li>
<p>Checks that the user has permission to send <code>m.room.tombstone</code>
events in the room.</p>
</li>
<li>
<p>



  <span><strong>[Changed in <code>v1.4</code>]</strong></span>
 
 Creates a replacement room with a <code>m.room.create</code> event containing a
<code>predecessor</code> field, the applicable <code>room_version</code>, and a <code>type</code> field
which is copied from the <code>predecessor</code> room. If no <code>type</code> is set on the
previous room, no <code>type</code> is specified on the new room&rsquo;s create event
either.</p>
</li>
<li>
<p>Replicates transferable state events to the new room. The exact
details for what is transferred is left as an implementation detail,
however the recommended state events to transfer are:</p>
<ul>
<li><code>m.room.server_acl</code></li>
<li><code>m.room.encryption</code></li>
<li><code>m.room.name</code></li>
<li><code>m.room.avatar</code></li>
<li><code>m.room.topic</code></li>
<li><code>m.room.guest_access</code></li>
<li><code>m.room.history_visibility</code></li>
<li><code>m.room.join_rules</code></li>
<li><code>m.room.power_levels</code></li>
</ul>
<p>Membership events should not be transferred to the new room due to
technical limitations of servers not being able to impersonate
people from other homeservers. Additionally, servers should not
transfer state events which are sensitive to who sent them, such as
events outside of the Matrix namespace where clients may rely on the
sender to match certain criteria.</p>
</li>
<li>
<p>Moves any local aliases to the new room.</p>
</li>
<li>
<p>Sends a <code>m.room.tombstone</code> event to the old room to indicate that it
is not intended to be used any further.</p>
</li>
<li>
<p>If possible, the power levels in the old room should also be
modified to prevent sending of events and inviting new users. For
example, setting <code>events_default</code> and <code>invite</code> to the greater of
<code>50</code> and <code>users_default + 1</code>.</p>
</li>
</ol>
<p>When a user joins the new room, the server should automatically
transfer/replicate some of the user&rsquo;s personalized settings such as
notifications, tags, etc.</p>

    







    
<h3 id="server-notices">Server Notices</h3>
<p>Homeserver hosts often want to send messages to users in an official
capacity, or have resource limits which affect a user&rsquo;s ability to use
the homeserver. For example, the homeserver may be limited to a certain
number of active users per month and has exceeded that limit. To
communicate this failure to users, the homeserver would use the Server
Notices room.</p>
<p>The aesthetics of the room (name, topic, avatar, etc) are left as an
implementation detail. It is recommended that the homeserver decorate
the room such that it looks like an official room to users.</p>
<h4 id="events">Events</h4>
<p>Notices are sent to the client as normal <code>m.room.message</code> events with a
<code>msgtype</code> of <code>m.server_notice</code> in the server notices room. Events with a
<code>m.server_notice</code> <code>msgtype</code> outside of the server notice room must be
ignored by clients.</p>
<p>The specified values for <code>server_notice_type</code> are:</p>
<p><code>m.server_notice.usage_limit_reached</code>
The server has exceeded some limit which requires the server
administrator to intervene. The <code>limit_type</code> describes the kind of limit
reached. The specified values for <code>limit_type</code> are:</p>
<p><code>monthly_active_user</code>
The server&rsquo;s number of active users in the last 30 days has exceeded the
maximum. New connections are being refused by the server. What defines
&ldquo;active&rdquo; is left as an implementation detail, however servers are
encouraged to treat syncing users as &ldquo;active&rdquo;.</p>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mroommessagemserver_notice">
   <code>m.room.message</code> with <code>msgtype: m.server_notice</code>
  </h1>
</summary>
  <hr/>
<p>Represents a server notice for a user.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>admin_contact</code></td>
  <td><code>string</code></td>
  <td>
    A URI giving a contact method for the server administrator. Required if the
notice type is <code>m.server_notice.usage_limit_reached</code>.</td>
 </tr>
 <tr>
  <td><code>body</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A human-readable description of the notice.</td>
 </tr>
 <tr>
  <td><code>limit_type</code></td>
  <td><code>string</code></td>
  <td>
    The kind of usage limit the server has exceeded. Required if the notice type is
<code>m.server_notice.usage_limit_reached</code>.</td>
 </tr>
 <tr>
  <td><code>msgtype</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong><p>One of: <code>[m.server_notice]</code>.</p></td>
 </tr>
 <tr>
  <td><code>server_notice_type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of notice being represented.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;admin_contact&#34;</span><span class="p">:</span> <span class="s2">&#34;mailto:server.admin@example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;Human-readable message to explain the notice&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;limit_type&#34;</span><span class="p">:</span> <span class="s2">&#34;monthly_active_user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.server_notice&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;server_notice_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.server_notice.usage_limit_reached&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h4 id="client-behaviour">Client behaviour</h4>
<p>Clients can identify the server notices room by the <code>m.server_notice</code>
tag on the room. Active notices are represented by the <a href="#mroompinned_events">pinned
events</a> in the server notices room. Server notice
events pinned in that room should be shown to the user through special
UI and not through the normal pinned events interface in the client. For
example, clients may show warning banners or bring up dialogs to get the
user&rsquo;s attention. Events which are not server notice events and are
pinned in the server notices room should be shown just like any other
pinned event in a room.</p>
<p>The client must not expect to be able to reject an invite to join the
server notices room. Attempting to reject the invite must result in a
<code>M_CANNOT_LEAVE_SERVER_NOTICE_ROOM</code> error. Servers should not prevent
the user leaving the room after joining the server notices room, however
the same error code must be used if the server will prevent leaving the
room.</p>
<h4 id="server-behaviour">Server behaviour</h4>
<p>Servers should manage exactly 1 server notices room per user. Servers
must identify this room to clients with the <code>m.server_notice</code> tag.
Servers should invite the target user rather than automatically join
them to the server notice room.</p>
<p>How servers send notices to clients, and which user they use to send the
events, is left as an implementation detail for the server.</p>

    







    
<h3 id="moderation-policy-lists">Moderation policy lists</h3>
<p>With Matrix being an open network where anyone can participate, a very
wide range of content exists and it is important that users are
empowered to select which content they wish to see, and which content
they wish to block. By extension, room moderators and server admins
should also be able to select which content they do not wish to host in
their rooms and servers.</p>
<p>The protocol&rsquo;s position on this is one of neutrality: it should not be
deciding what content is undesirable for any particular entity and
should instead be empowering those entities to make their own decisions.
As such, a generic framework for communicating &ldquo;moderation policy lists&rdquo;
or &ldquo;moderation policy rooms&rdquo; is described. Note that this module only
describes the data structures and not how they should be interpreting:
the entity making the decisions on filtering is best positioned to
interpret the rules how it sees fit.</p>
<p>Moderation policy lists are stored as room state events. There are no
restrictions on how the rooms can be configured (they could be public,
private, encrypted, etc).</p>
<p>There are currently 3 kinds of entities which can be affected by rules:
<code>user</code>, <code>server</code>, and <code>room</code>. All 3 are described with
<code>m.policy.rule.&lt;kind&gt;</code> state events. The <code>state_key</code> for a policy rule
is an arbitrary string decided by the sender of the rule.</p>
<p>Rules contain recommendations and reasons for the rule existing. The
<code>reason</code> is a human-readable string which describes the
<code>recommendation</code>. Currently only one recommendation, <code>m.ban</code>, is
specified.</p>
<h4 id="mban-recommendation"><code>m.ban</code> recommendation</h4>
<p>When this recommendation is used, the entities affected by the rule
should be banned from participation where possible. The enforcement of
this is deliberately left as an implementation detail to avoid the
protocol imposing its opinion on how the policy list is to be
interpreted. However, a suggestion for a simple implementation is as
follows:</p>
<ul>
<li>Is a <code>user</code> rule&hellip;
<ul>
<li>Applied to a user: The user should be added to the subscriber&rsquo;s
ignore list.</li>
<li>Applied to a room: The user should be banned from the room
(either on sight or immediately).</li>
<li>Applied to a server: The user should not be allowed to send
invites to users on the server.</li>
</ul>
</li>
<li>Is a <code>room</code> rule&hellip;
<ul>
<li>Applied to a user: The user should leave the room and not join
it
(<a href="https://github.com/matrix-org/matrix-spec-proposals/pull/2270">MSC2270</a>-style
ignore).</li>
<li>Applied to a room: No-op because a room cannot ban itself.</li>
<li>Applied to a server: The server should prevent users from
joining the room and from receiving invites to it.</li>
</ul>
</li>
<li>Is a <code>server</code> rule&hellip;
<ul>
<li>Applied to a user: The user should not receive events or invites
from the server.</li>
<li>Applied to a room: The server is added as a denied server in the
ACLs.</li>
<li>Applied to a server: The subscriber should avoid federating with
the server as much as possible by blocking invites from the
server and not sending traffic unless strictly required (no
outbound invites).</li>
</ul>
</li>
</ul>
<h4 id="subscribing-to-policy-lists">Subscribing to policy lists</h4>
<p>This is deliberately left as an implementation detail. For
implementations using the Client-Server API, this could be as easy as
joining or peeking the room. Joining or peeking is not required,
however: an implementation could poll for updates or use a different
technique for receiving updates to the policy&rsquo;s rules.</p>
<h4 id="events">Events</h4>
<p>The <code>entity</code> described by the state events is interpreted as a
<a href="/appendices#glob-style-matching">glob-style pattern</a>. Note that
rules against rooms can describe a room ID or room alias - the
subscriber is responsible for resolving the alias to a room ID if
desired.</p>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mpolicyruleuser">
   <code>m.policy.rule.user</code>
  </h1>
</summary>
  <hr/>
<p>A moderation policy rule which affects users.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>State event</td>
  </tr>
  <tr>
   <th>State key</th>
   <td>An arbitrary string decided upon by the sender.</td>
 </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>entity</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The entity affected by this rule. Glob characters <code>*</code> and <code>?</code> can be used
to match zero or more characters or exactly one character respectively.</td>
 </tr>
 <tr>
  <td><code>reason</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The human-readable description for the <code>recommendation</code>.</td>
 </tr>
 <tr>
  <td><code>recommendation</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The suggested action to take. Currently only <code>m.ban</code> is specified.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;entity&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice*:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;undesirable behaviour&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;recommendation&#34;</span><span class="p">:</span> <span class="s2">&#34;m.ban&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;rule:@alice*:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.policy.rule.user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mpolicyruleroom">
   <code>m.policy.rule.room</code>
  </h1>
</summary>
  <hr/>
<p>A moderation policy rule which affects room IDs and room aliases.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>State event</td>
  </tr>
  <tr>
   <th>State key</th>
   <td>An arbitrary string decided upon by the sender.</td>
 </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>entity</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The entity affected by this rule. Glob characters <code>*</code> and <code>?</code> can be used
to match zero or more characters or exactly one character respectively.</td>
 </tr>
 <tr>
  <td><code>reason</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The human-readable description for the <code>recommendation</code>.</td>
 </tr>
 <tr>
  <td><code>recommendation</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The suggested action to take. Currently only <code>m.ban</code> is specified.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;entity&#34;</span><span class="p">:</span> <span class="s2">&#34;#*:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;undesirable content&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;recommendation&#34;</span><span class="p">:</span> <span class="s2">&#34;m.ban&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;rule:#*:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.policy.rule.room&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mpolicyruleserver">
   <code>m.policy.rule.server</code>
  </h1>
</summary>
  <hr/>
<p>A moderation policy rule which affects servers.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>State event</td>
  </tr>
  <tr>
   <th>State key</th>
   <td>An arbitrary string decided upon by the sender.</td>
 </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>entity</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The entity affected by this rule. Glob characters <code>*</code> and <code>?</code> can be used
to match zero or more characters or exactly one character respectively.</td>
 </tr>
 <tr>
  <td><code>reason</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The human-readable description for the <code>recommendation</code>.</td>
 </tr>
 <tr>
  <td><code>recommendation</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The suggested action to take. Currently only <code>m.ban</code> is specified.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;entity&#34;</span><span class="p">:</span> <span class="s2">&#34;*.example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;reason&#34;</span><span class="p">:</span> <span class="s2">&#34;undesirable engagement&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;recommendation&#34;</span><span class="p">:</span> <span class="s2">&#34;m.ban&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;rule:*.example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.policy.rule.server&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h4 id="client-behaviour">Client behaviour</h4>
<p>As described above, the client behaviour is deliberately left undefined.</p>
<h4 id="server-behaviour">Server behaviour</h4>
<p>Servers have no additional requirements placed on them by this module.</p>
<h4 id="security-considerations">Security considerations</h4>
<p>This module could be used to build a system of shared blacklists, which
may create a divide within established communities if not carefully
deployed. This may well not be a suitable solution for all communities.</p>
<p>Depending on how implementations handle subscriptions, user IDs may be
linked to policy lists and therefore expose the views of that user. For
example, a client implementation which joins the user to the policy room
would expose the user&rsquo;s ID to observers of the policy room. In future,
<a href="https://github.com/matrix-org/matrix-spec-proposals/pulls/1228">MSC1228</a> and
<a href="https://github.com/matrix-org/matrix-spec-proposals/pulls/1777">MSC1777</a> (or
similar) could help solve this concern.</p>

    







    
<h3 id="spaces">Spaces</h3>
<p><span><strong>[Added in <code>v1.2</code>]</strong></span></p>
<p>Often used to group rooms of similar subject matter (such as a public &ldquo;Official
matrix.org rooms&rdquo; space or personal &ldquo;Work stuff&rdquo; space), spaces are a way to
organise rooms while being represented as rooms themselves.</p>
<p>A space is defined by the <a href="#types"><code>m.space</code> room type</a>, making it known as a
&ldquo;space-room&rdquo;. The space&rsquo;s name, topic, avatar, aliases, etc are all defined through
the existing relevant state events within the space-room.</p>
<p>Sending normal <a href="#mroommessage"><code>m.room.message</code></a> events within the space-room is
discouraged - clients are not generally expected to have a way to render the timeline
of the room. As such, space-rooms should be created with <a href="#mroompower_levels"><code>m.room.power_levels</code></a>
which prohibit normal events by setting <code>events_default</code> to a suitably high number.
In the default power level structure, this would be <code>100</code>. Clients might wish to
go a step further and explicitly ignore notification counts on space-rooms.</p>
<p>Membership of a space is defined and controlled by the existing mechanisms which
govern a room: <a href="#mroommember"><code>m.room.member</code></a>, <a href="#mroomhistory_visibility"><code>m.room.history_visibility</code></a>,
and <a href="#mroomjoin_rules"><code>m.room.join_rules</code></a>. Public spaces are encouraged to have
a similar setup to public rooms: <code>world_readable</code> history visibility, published
canonical alias, and suitably public <code>join_rule</code>. Invites, including third-party
invites, still work just as they do in normal rooms as well.</p>
<p>All other aspects of regular rooms are additionally carried over, such as the
ability to set arbitrary state events, hold room account data, etc. Spaces are
just rooms with extra functionality on top.</p>
<h4 id="managing-roomsspaces-included-in-a-space">Managing rooms/spaces included in a space</h4>
<p>Spaces form a hierarchy of rooms which clients can use to structure their room
list into a tree-like view. The parent/child relationship can be defined in two
ways: with <a href="#mspacechild"><code>m.space.child</code></a> state events in the space-room, or with
<a href="#mspaceparent"><code>m.space.parent</code></a> state events in the child room.</p>
<p>In most cases, both the child and parent relationship should be defined to aid
discovery of the space and its rooms. When only a <code>m.space.child</code> is used, the space
is effectively a curated list of rooms which the rooms themselves might not be aware
of. When only a <code>m.space.parent</code> is used, the rooms are &ldquo;secretly&rdquo; added to spaces
with the effect of not being advertised directly by the space.</p>
<div class="alert warning " role="alert">
<p>Considering spaces are rooms themselves, it is possible to nest spaces within spaces,
and it is possible to create a loop. Though the creation of loops is explicitly disallowed,
implementations might still encounter them and must be careful not to loop infinitely when
this happens.</p>
<p>Clients and servers should additionally be aware of excessively long trees which may
cause performance issues.</p>
</div>
<h5 id="mspacechild-relationship"><code>m.space.child</code> relationship</h5>
<p>When using this approach, the state events get sent into the space-room which is the
parent to the room. The <code>state_key</code> for the event is the child room&rsquo;s ID.</p>
<p>For example, to achieve the following:</p>
<pre tabindex="0"><code>#space:example.org
    #general:example.org (!abcdefg:example.org)
    !private:example.org
</code></pre><p>the state of <code>#space:example.org</code> would consist of:</p>
<p><em>Unimportant fields trimmed for brevity.</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.space.child&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;!abcdefg:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;via&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;example.org&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.space.child&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;!private:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;via&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;example.org&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>No state events in the child rooms themselves would be required (though they
can also be present). This allows for users
to define personal/private spaces to organise their own rooms without needing explicit
permission from the room moderators/admins.</p>
<p>Child rooms can be removed from a space by omitting the <code>via</code> key of <code>content</code> on the
relevant state event, such as through redaction or otherwise clearing the <code>content</code>.</p>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mspacechild">
   <code>m.space.child</code>
  </h1>
</summary>
  <hr/>
<p>Defines the relationship of a child room to a space-room. Has no effect in rooms which are not <a href="#spaces">spaces</a>.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>State event</td>
  </tr>
  <tr>
   <th>State key</th>
   <td>The child room ID being described.</td>
 </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>order</code></td>
  <td><code>string</code></td>
  <td>
    <p>Optional string to define ordering among space children. These are lexicographically
compared against other children&rsquo;s <code>order</code>, if present.</p>
<p>Must consist of ASCII characters within the range <code>\x20</code> (space) and <code>\x7E</code> (<code>~</code>),
inclusive. Must not exceed 50 characters.</p>
<p><code>order</code> values with the wrong type, or otherwise invalid contents, are to be treated
as though the <code>order</code> key was not provided.</p>
<p>See <a href="/client-server-api/#ordering-of-children-within-a-space">Ordering of children within a space</a> for information on how the ordering works.</p>
</td>
 </tr>
 <tr>
  <td><code>suggested</code></td>
  <td><code>boolean</code></td>
  <td>
    Optional (default <code>false</code>) flag to denote whether the child is &ldquo;suggested&rdquo; or of interest
to members of the space. This is primarily intended as a rendering hint for clients to
display the room differently, such as eagerly rendering them in the room list.</td>
 </tr>
 <tr>
  <td><code>via</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong><p>A list of servers to try and join through. See also: <a href="/appendices/#routing">Routing</a>.</p>
<p>When not present or invalid, the child room is not considered to be part of the space.</p>
</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;order&#34;</span><span class="p">:</span> <span class="s2">&#34;lexicographically_compare_me&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;suggested&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;via&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;other.example.org&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;!roomid:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.space.child&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h6 id="ordering-of-children-within-a-space">Ordering of children within a space</h6>
<p>When the client is displaying the children of a space, the children should be ordered
using the algorithm below. In some cases, like a traditional left side room list, the
client may override the ordering to provide better user experience. A theoretical
space summary view would however show the children ordered.</p>
<p>Taking the set of space children, first order the children with a valid <code>order</code> key
lexicographically by Unicode code-points such that <code>\x20</code> (space) is sorted before
<code>\x7E</code> (<code>~</code>). Then, take the remaining children and order them by the <code>origin_server_ts</code>
of their <code>m.space.child</code> event in ascending numeric order, placing them after the
children with a valid <code>order</code> key in the resulting set.</p>
<p>In cases where the <code>order</code> values are the same, the children are ordered by their
timestamps.  If the timestamps are the same, the children are ordered lexicographically
by their room IDs (state keys) in ascending order.</p>
<p>Noting the careful use of ASCII spaces here, the following demonstrates a set of space
children being ordered appropriately:</p>
<p><em>Unimportant fields trimmed for brevity.</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.space.child&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;!b:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1640341000000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;order&#34;</span><span class="p">:</span> <span class="s2">&#34; &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;via&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;example.org&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.space.child&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;!a:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1640141000000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;order&#34;</span><span class="p">:</span> <span class="s2">&#34;aaaa&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;via&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;example.org&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.space.child&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;!c:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1640841000000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;order&#34;</span><span class="p">:</span> <span class="s2">&#34;first&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;via&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;example.org&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.space.child&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;!e:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1640641000000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;via&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;example.org&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.space.child&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;!d:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1640741000000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;via&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;example.org&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><ol>
<li><code>!b:example.org</code> is first because <code>\x20</code> is before <code>aaaa</code> lexically.</li>
<li><code>!a:example.org</code> is next because <code>aaaa</code> is before <code>first</code> lexically.</li>
<li><code>!c:example.org</code> is next because <code>first</code> is the last <code>order</code> value.</li>
<li><code>!e:example.org</code> is next because the event timestamp is smallest.</li>
<li><code>!d:example.org</code> is last because the event timestamp is largest.</li>
</ol>
<h5 id="mspaceparent-relationships"><code>m.space.parent</code> relationships</h5>
<p>Rooms can additionally claim to be part of a space by populating their own state
with a parent event. Similar to child events within spaces, the parent event&rsquo;s
<code>state_key</code> is the room ID of the parent space, and they have a similar <code>via</code> list
within their <code>content</code> to denote both whether or not the link is valid and which
servers might be possible to join through.</p>
<p>To avoid situations where a room falsely claims it is part of a given space,
<code>m.space.parent</code> events should be ignored unless one of the following is true:</p>
<ul>
<li>A corresponding <code>m.space.child</code> event can be found in the supposed parent space.</li>
<li>The sender of the <code>m.space.parent</code> event has sufficient power level in the
supposed parent space to send <code>m.space.child</code> state events (there doesn&rsquo;t need
to be a matching child event).</li>
</ul>
<div class="alert note " role="alert">
Clients might need to peek into a parent space to inspect the room state if they
aren&rsquo;t already joined. If the client is unable to peek the state, the link should
be assumed to be invalid.
</div>
<div class="alert note " role="alert">
A consequence of the second condition is that a room admin being demoted in the
parent space, leaving the parent space, or otherwise being removed from the parent
space can mean that a previously valid <code>m.space.parent</code> event becomes invalid.
</div>
<p><code>m.space.parent</code> events can additionally include a <code>canonical</code> boolean key in their
<code>content</code> to denote that the parent space is the main/primary space for the room.
This can be used to, for example, have the client find other rooms by peeking into
that space and suggesting them to the user. Only one canonical parent should exist,
though this is not enforced. To tiebreak, use the lowest room ID sorted lexicographically
by Unicode code-points.</p>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mspaceparent">
   <code>m.space.parent</code>
  </h1>
</summary>
  <hr/>
<p>Defines the relationship of a room to a parent space-room.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>State event</td>
  </tr>
  <tr>
   <th>State key</th>
   <td>The parent room ID.</td>
 </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>canonical</code></td>
  <td><code>boolean</code></td>
  <td>
    <p>Optional (default <code>false</code>) flag to denote this parent is the primary parent for the room.</p>
<p>When multiple <code>canonical</code> parents are found, the lowest parent when ordering by room ID
lexicographically by Unicode code-points should be used.</p>
</td>
 </tr>
 <tr>
  <td><code>via</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong><p>A list of servers to try and join through. See also: <a href="/appendices/#routing">Routing</a>.</p>
<p>When not present or invalid, the room is not considered to be part of the parent space.</p>
</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;canonical&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;via&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;other.example.org&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;!parent_roomid:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.space.parent&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h4 id="discovering-rooms-within-spaces">Discovering rooms within spaces</h4>
<p>Often the client will want to assist the user in exploring what rooms/spaces are part
of a space. This can be done with crawling <a href="#mspacechild"><code>m.space.child</code></a> state events
in the client and peeking into the rooms to get information like the room name, though
this is impractical for most cases.</p>
<p>Instead, a hierarchy API is provided to walk the space tree and discover the rooms with
their aesthetic details.</p>
<p>The <a href="#get_matrixclientv1roomsroomidhierarchy"><code>GET /hierarchy</code></a> API works in a depth-first
manner: when it encounters another space as a child it recurses into that space before
returning non-space children.</p>
<div class="alert warning " role="alert">
<p>Though prohibited, it is still possible for loops to occur. Servers should gracefully
break loops.</p>
<p>Additionally, a given child room might appear multiple times in the response as a
grandchild (for example).</p>
</div>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv1roomsroomidhierarchy">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v1/rooms/{roomId}/hierarchy</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.2</code></strong></p>
<p><p>Paginates over the space tree in a depth-first manner to locate child rooms of a given space.</p>
<p>Where a child room is unknown to the local server, federation is used to fill in the details.
The servers listed in the <code>via</code> array should be contacted to attempt to fill in missing rooms.</p>
<p>Only <a href="#mspacechild"><code>m.space.child</code></a> state events of the room are considered. Invalid child
rooms and parent events are not covered by this endpoint.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID of the space to get a hierarchy for.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>from</code></td>
  <td><code>string</code></td>
  <td>
    A pagination token from a previous result. If specified, <code>max_depth</code> and <code>suggested_only</code> cannot
be changed from the first request.</td>
 </tr>
 <tr>
  <td><code>limit</code></td>
  <td><code>integer</code></td>
  <td>
    <p>Optional limit for the maximum number of rooms to include per response. Must be an integer
greater than zero.</p>
<p>Servers should apply a default value, and impose a maximum value to avoid resource exhaustion.</p>
</td>
 </tr>
 <tr>
  <td><code>max_depth</code></td>
  <td><code>integer</code></td>
  <td>
    <p>Optional limit for how far to go into the space. Must be a non-negative integer.</p>
<p>When reached, no further child rooms will be returned.</p>
<p>Servers should apply a default value, and impose a maximum value to avoid resource exhaustion.</p>
</td>
 </tr>
 <tr>
  <td><code>suggested_only</code></td>
  <td><code>boolean</code></td>
  <td>
    Optional (default <code>false</code>) flag to indicate whether or not the server should only consider
suggested rooms. Suggested rooms are annotated in their <a href="#mspacechild"><code>m.space.child</code></a> event
contents.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>A portion of the space tree, starting at the provided room ID.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td><p>The request was invalid in some way. A meaningful <code>errcode</code>
and description error text will be returned. Example reasons for rejection are:</p>
<ul>
<li>The <code>from</code> token is unknown to the server.</li>
<li><code>suggested_only</code> or <code>max_depth</code> changed during pagination.</li>
</ul>
</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td><p>The user cannot view or peek on the room. A meaningful <code>errcode</code>
and description error text will be returned. Example reasons for rejection are:</p>
<ul>
<li>The room is not set up for peeking.</li>
<li>The user has been banned from the room.</li>
<li>The room does not exist.</li>
</ul>
</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>next_batch</code></td>
  <td><code>string</code></td>
  <td>
    A token to supply to <code>from</code> to keep paginating the responses. Not present when there are
no further results.</td>
 </tr>
 <tr>
  <td><code>rooms</code></td>
  <td><code>[ChildRoomsChunk]</code></td>
  <td>
    <strong>Required: </strong>The rooms for the current page, with the current filters.</td>
 </tr>
</table>
<table id="_matrixclientv1roomsroomidhierarchy_childroomschunk" class="object-table">
 <caption>ChildRoomsChunk</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>avatar_url</code></td>
  <td><code>string</code></td>
  <td>
    The URL for the room&rsquo;s avatar, if one is set.</td>
 </tr>
 <tr>
  <td><code>canonical_alias</code></td>
  <td><code>string</code></td>
  <td>
    The canonical alias of the room, if any.</td>
 </tr>
 <tr>
  <td><code>children_state</code></td>
  <td><code>[StrippedChildStateEvent]</code></td>
  <td>
    <strong>Required: </strong><p>The <a href="#mspacechild"><code>m.space.child</code></a> events of the space-room, represented
as <a href="#stripped-state">Stripped State Events</a> with an added <code>origin_server_ts</code> key.</p>
<p>If the room is not a space-room, this should be empty.</p>
</td>
 </tr>
 <tr>
  <td><code>guest_can_join</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether guest users may join the room and participate in it.
If they can, they will be subject to ordinary power level
rules like any other user.</td>
 </tr>
 <tr>
  <td><code>join_rule</code></td>
  <td><code>string</code></td>
  <td>
    The room&rsquo;s join rule. When not present, the room is assumed to
be <code>public</code>.</td>
 </tr>
 <tr>
  <td><code>name</code></td>
  <td><code>string</code></td>
  <td>
    The name of the room, if any.</td>
 </tr>
 <tr>
  <td><code>num_joined_members</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The number of members joined to the room.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room.</td>
 </tr>
 <tr>
  <td><code>room_type</code></td>
  <td><code>string</code></td>
  <td>
    The <code>type</code> of room (from <a href="/client-server-api/#mroomcreate"><code>m.room.create</code></a>), if any.
<p><strong>Added in <code>v1.4</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>topic</code></td>
  <td><code>string</code></td>
  <td>
    The topic of the room, if any.</td>
 </tr>
 <tr>
  <td><code>world_readable</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether the room may be viewed by guest users without joining.</td>
 </tr>
</table>
<table id="_matrixclientv1roomsroomidhierarchy_strippedchildstateevent" class="object-table">
 <caption>StrippedChildStateEvent</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>EventContent</code></td>
  <td>
    <strong>Required: </strong>The <code>content</code> for the event.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The <code>origin_server_ts</code> for the event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>sender</code> for the event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>state_key</code> for the event.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>type</code> for the event.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;next_batch&#34;</span><span class="p">:</span> <span class="s2">&#34;next_batch_token&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;rooms&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/abcdef&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;canonical_alias&#34;</span><span class="p">:</span> <span class="s2">&#34;#general:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;children_state&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;via&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">              <span class="s2">&#34;example.org&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">]</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1629413349153</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;!a:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.space.child&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;guest_can_join&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;join_rule&#34;</span><span class="p">:</span> <span class="s2">&#34;public&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;The First Space&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;num_joined_members&#34;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!space:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.space&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;topic&#34;</span><span class="p">:</span> <span class="s2">&#34;No other spaces were created first, ever&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;world_readable&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv1roomsroomidhierarchy_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_INVALID_PARAM&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;suggested_only and max_depth cannot change on paginated requests&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv1roomsroomidhierarchy_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;You are not allowed to view this room.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv1roomsroomidhierarchy_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h5 id="server-behaviour">Server behaviour</h5>
<p>In the case where the server does not have access to the state of a child room, it can
request the information over federation with the
<a href="/server-server-api/#get_matrixfederationv1hierarchyroomid"><code>GET /hierarchy</code></a> API. The
response to this endpoint should be cached for a period of time. The response might
additionally contain information about rooms the requesting user is already a member
of, or that the server is aware of - the local data should be used instead of the remote
server&rsquo;s data.</p>
<p>Note that the response to the client endpoint is contextual based on the user. Servers are
encouraged to cache the data for a period of time, though permission checks may need to
be performed to ensure the response is accurate for that user.</p>

    







    
<h3 id="event-replacements">Event replacements</h3>
<p><span><strong>[Added in <code>v1.4</code>]</strong></span></p>
<p>Event replacements, or &ldquo;message edit events&rdquo;, are events that use an <a href="#forming-relationships-between-events">event
relationship</a>
with a <code>rel_type</code> of <code>m.replace</code>, which indicates that the original event is
intended to be replaced.</p>
<p>An example of a message edit event might look like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;* Hello! My name is bar&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;m.new_content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;Hello! My name is bar&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;m.relates_to&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;rel_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.replace&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$some_event_id&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ... other fields required by events
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>The <code>content</code> of the replacement must contain a <code>m.new_content</code> property which
defines the replacement <code>content</code>. The normal <code>content</code> properties (<code>body</code>,
<code>msgtype</code> etc.) provide a fallback for clients which do not understand
replacement events.</p>
<p><code>m.new_content</code> can include any properties that would normally be found in
an event&rsquo;s content property, such as <code>formatted_body</code> (see <a href="#mroommessage-msgtypes"><code>m.room.message</code>
<code>msgtypes</code></a>).</p>
<h4 id="validity-of-replacement-events">Validity of replacement events</h4>
<p>There are a number of requirements on replacement events, which must be satisfied for the replacement to be considered valid:</p>
<ul>
<li>
<p>As with all event relationships, the original event and replacement event
must have the same <code>room_id</code> (i.e. you cannot send an event in
one room and then an edited version in a different room).</p>
</li>
<li>
<p>The original event and replacement event must have the same <code>sender</code>
(i.e. you cannot edit someone else&rsquo;s messages).</p>
</li>
<li>
<p>The replacement and original events must have the same <code>type</code> (i.e. you
cannot change the original event&rsquo;s type).</p>
</li>
<li>
<p>The replacement and original events must not have a <code>state_key</code> property
(i.e. you cannot edit state events at all).</p>
</li>
<li>
<p>The original event must not, itself, have a <code>rel_type</code> of <code>m.replace</code>
(i.e. you cannot edit an edit  though you can send multiple edits for a
single original event).</p>
</li>
<li>
<p>The replacement event (once decrypted, if appropriate) must have an
<code>m.new_content</code> property.</p>
</li>
</ul>
<p>If any of these criteria are not satisfied, implementations should ignore the
replacement event (the content of the original should not be replaced, and the
edit should not be included in the server-side aggregation).</p>
<p>Note that the <a href="#mroommessage-msgtypes"><code>msgtype</code></a> property of replacement
<code>m.room.message</code> events does <em>not</em> need to be the same as in the original event. For
example, it is legitimate to replace an <code>m.text</code> event with an <code>m.emote</code>.</p>
<h4 id="editing-encrypted-events">Editing encrypted events</h4>
<p>If the original event was <a href="#end-to-end-encryption">encrypted</a>, the replacement
should be too. In that case, <code>m.new_content</code> is placed in the content of the
encrypted payload. As with all event relationships, the <code>m.relates_to</code> property
must be sent in the unencrypted (cleartext) part of the event.</p>
<p>For example, a replacement for an encrypted event might look like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.encrypted&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;m.relates_to&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;rel_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.replace&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$some_event_id&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;algorithm&#34;</span><span class="p">:</span> <span class="s2">&#34;m.megolm.v1.aes-sha2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sender_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;sender_curve25519_key&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;device_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;sender_device_id&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;session_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;outbound_group_session_id&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ciphertext&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;encrypted_payload_base_64&gt;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// irrelevant fields not shown
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>&hellip; and, once decrypted, the payload might look like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.&lt;event_type&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!some_room_id&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;* Hello! My name is bar&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;m.new_content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;Hello! My name is bar&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Note that:</p>
<ul>
<li>There is no <code>m.relates_to</code> property in the encrypted payload. If there was, it would be ignored.</li>
<li>There is no <code>m.new_content</code> property in the cleartext content of the <code>m.room.encrypted</code> event. As above, if there was then it would be ignored.</li>
</ul>
<div class="alert note " role="alert">
The payload of an encrypted replacement event must be encrypted as normal, including
ratcheting any <a href="#mmegolmv1aes-sha2">Megolm</a> session as normal. The original Megolm
ratchet entry should <strong>not</strong> be re-used.
</div>
<h4 id="applying-mnew_content">Applying <code>m.new_content</code></h4>
<p>When applying a replacement, the <code>content</code> of the original event is treated as
being overwritten entirely by <code>m.new_content</code>, with the exception of <code>m.relates_to</code>,
which is left <em>unchanged</em>. Any <code>m.relates_to</code> property within <code>m.new_content</code>
is ignored.</p>
<p>For example, given a pair of events:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$original_event&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;I really like cake&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;formatted_body&#34;</span><span class="p">:</span> <span class="s2">&#34;I really like cake&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$edit_event&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;* I really like *chocolate* cake&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;m.new_content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;I really like *chocolate* cake&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;com.example.extension_property&#34;</span><span class="p">:</span> <span class="s2">&#34;chocolate&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;m.relates_to&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;rel_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.replace&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$original_event_id&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>&hellip; then the end result is an event as shown below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$original_event&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;I really like *chocolate* cake&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;com.example.extension_property&#34;</span><span class="p">:</span> <span class="s2">&#34;chocolate&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Note that <code>formatted_body</code> is now absent, because it was absent in the
replacement event.</p>
<h4 id="server-behaviour">Server behaviour</h4>
<h5 id="server-side-aggregation-of-mreplace-relationships">Server-side aggregation of <code>m.replace</code> relationships</h5>




  <span><strong>[Changed in <code>v1.7</code>]</strong></span>
 

<p>Note that there can be multiple events with an <code>m.replace</code> relationship to a
given event (for example, if an event is edited multiple times). These should
be <a href="#aggregations-of-child-events">aggregated</a> by the homeserver.</p>
<p>The aggregation format of <code>m.replace</code> relationships gives the <strong>most recent</strong>
replacement event, formatted <a href="#room-event-format">as normal</a>.</p>
<p>The most recent event is determined by comparing <code>origin_server_ts</code>; if two or
more replacement events have identical <code>origin_server_ts</code>, the event with the
lexicographically largest <code>event_id</code> is treated as more recent.</p>
<p>As with any other aggregation of child events, the <code>m.replace</code> aggregation is
included under the <code>m.relations</code> property in <code>unsigned</code> for any event that is
the target of an <code>m.replace</code> relationship. For example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$original_event_id&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;I really like cake&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;formatted_body&#34;</span><span class="p">:</span> <span class="s2">&#34;I really like cake&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.relations&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;m.replace&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$latest_edit_event_id&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1649772304313</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@editing_user:localhost&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;* I really like *chocolate* cake&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;m.new_content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;I really like *chocolate* cake&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;m.relates_to&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;rel_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.replace&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$original_event_id&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// irrelevant fields not shown
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>If the original event is <a href="#redactions">redacted</a>, any
<code>m.replace</code> relationship should <strong>not</strong> be bundled with it (whether or not any
subsequent replacements are themselves redacted). Note that this behaviour is
specific to the <code>m.replace</code> relationship. See also <a href="#redactions-of-edited-events">redactions of edited
events</a> below.</p>
<p><strong>Note:</strong> the <code>content</code> of the original event is left intact. In particular servers
should <strong>not</strong> replace the content with that of the replacement event.</p>
<div class="alert rationale " role="alert">
In previous versions of the specification, servers were expected to replace the
content of an edited event whenever it was served to clients (with the
exception of the
<a href="#get_matrixclientv3roomsroomideventeventid"><code>GET /_matrix/client/v3/rooms/{roomId}/event/{eventId}</code></a>
endpoint).  However, that behaviour made reliable client-side implementation
difficult, and servers should no longer make this replacement.
</div>
<h4 id="client-behaviour">Client behaviour</h4>
<p>Since the server will not replace the content of any edited events, clients
should take note of any replacement events they receive, and apply the
replacement whenever possible and appropriate.</p>
<p>Client authors are reminded to take note of the requirements for <a href="#validity-of-replacement-events">Validity of
replacement events</a>, and to ignore any
invalid replacement events that are received.</p>
<h5 id="permalinks">Permalinks</h5>
<p>When creating <a href="/appendices/#uris">links</a> to events (also known as permalinks),
clients build links which reference the event that the creator of the permalink
is viewing at that point (which might be a message edit event).</p>
<p>The client viewing the permalink should resolve this reference to the original
event, and then display the most recent version of that event.</p>
<h4 id="redactions-of-edited-events">Redactions of edited events</h4>
<p>When an event using a <code>rel_type</code> of <code>m.replace</code> is <a href="#redactions">redacted</a>, it
removes that edit revision. This has little effect if there were subsequent
edits. However, if it was the most recent edit, the event is in effect
reverted to its content before the redacted edit.</p>
<p>Redacting the <em>original</em> message in effect removes the message, including all
subsequent edits, from the visible timeline. In this situation, homeservers
will return an empty <code>content</code> for the original event as with any other
redacted event, and as
<a href="#server-side-aggregation-of-mreplace-relationships">above</a> the replacement
events will not be included in the aggregation bundled with the original
event. Note that the subsequent edits are not actually redacted themselves:
they simply serve no purpose within the visible timeline.</p>
<h4 id="edits-of-events-with-mentions">Edits of events with mentions</h4>
<p>When editing an event with <a href="#user-and-room-mentions">user and room mentions</a> the
replacement event will have two <code>m.mentions</code> properties:</p>
<ul>
<li>One at the top-level of the <code>content</code>, which should contain mentions due to
this edit revision.</li>
<li>One inside the <code>m.new_content</code> property, which should contain the resolved mentions
for the final version of the event.</li>
</ul>
<p>The difference between these properties ensures that users will not be notified
for each edit revision of an event, but allows for new users to be mentioned (or
for re-notifying if the sending client feels a large enough revision was made).</p>
<p>For example, if there is an event mentioning Alice:</p>
<pre tabindex="0"><code class="language-json5" data-lang="json5">{
    &#34;event_id&#34;: &#34;$original_event&#34;,
    &#34;type&#34;: &#34;m.room.message&#34;,
    &#34;content&#34;: {
        &#34;body&#34;: &#34;Hello Alice!&#34;,
        &#34;m.mentions&#34;: {
            &#34;user_ids&#34;: [&#34;@alice:example.org&#34;]
        }
    }
}
</code></pre><p>And an edit to also mention Bob:</p>
<pre tabindex="0"><code class="language-json5" data-lang="json5">{
  &#34;content&#34;: {
    &#34;body&#34;: &#34;* Hello Alice &amp; Bob!&#34;,
    &#34;m.mentions&#34;: {
      &#34;user_ids&#34;: [
        // Include only the newly mentioned user.
        &#34;@bob:example.org&#34;
      ]
    },
    &#34;m.new_content&#34;: {
      &#34;body&#34;: &#34;Hello Alice &amp; Bob!&#34;,
      &#34;m.mentions&#34;: {
        &#34;user_ids&#34;: [
          // Include all of the mentioned users.
          &#34;@alice:example.org&#34;,
          &#34;@bob:example.org&#34;
        ]
      },
    },
    &#34;m.relates_to&#34;: {
      &#34;rel_type&#34;: &#34;m.replace&#34;,
      &#34;event_id&#34;: &#34;$original_event&#34;
    }
  },
  // other fields as required by events
}
</code></pre><p>If an edit revision removes a user&rsquo;s mention then that user&rsquo;s Matrix ID should be
included in neither <code>m.mentions</code> property.</p>
<p>Clients may also wish to modify the <a href="#user-and-room-mentions">client behaviour</a> of
determining if an event mentions the current user by checking the <code>m.mentions</code>
property under <code>m.new_content</code>.</p>
<h4 id="edits-of-replies">Edits of replies</h4>
<p>Some particular constraints apply to events which replace a
<a href="#rich-replies">reply</a>. In particular:</p>
<ul>
<li>
<p>In contrast to the original reply, there should be no <code>m.in_reply_to</code>
property in the the <code>m.relates_to</code> object, since it would be redundant (see
<a href="#applying-mnew_content">Applying <code>m.new_content</code></a> above, which notes that
the original event&rsquo;s <code>m.relates_to</code> is preserved), as well as being contrary
to the spirit of the event relationships mechanism which expects only one
&ldquo;parent&rdquo; per event.</p>
</li>
<li>
<p><code>m.new_content</code> should <strong>not</strong> contain any <a href="#fallbacks-for-rich-replies">reply
fallback</a>,
since it is assumed that any client which can handle edits can also display
replies natively. However, the <code>content</code> of the replacement event should provide
fallback content for clients which support neither rich replies nor edits.</p>
</li>
</ul>
<p>An example of an edit to a reply is as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// irrelevant fields not shown
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;&gt; &lt;@alice:example.org&gt; question\n\n* reply&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;org.matrix.custom.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;formatted_body&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;mx-reply&gt;&lt;blockquote&gt;&lt;a href=\&#34;https://matrix.to/#/!somewhere:example.org/$event:example.org\&#34;&gt;In reply to&lt;/a&gt; &lt;a href=\&#34;https://matrix.to/#/@alice:example.org\&#34;&gt;@alice:example.org&lt;/a&gt;&lt;br /&gt;question&lt;/blockquote&gt;&lt;/mx-reply&gt;* reply&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.new_content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;reply&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;org.matrix.custom.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;formatted_body&#34;</span><span class="p">:</span> <span class="s2">&#34;reply&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.relates_to&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;rel_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.replace&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$original_reply_event&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
    







    
<h3 id="event-annotations-and-reactions">Event annotations and reactions</h3>
<p><span><strong>[Added in <code>v1.7</code>]</strong></span></p>
<h4 id="mannotation-relationship-type"><code>m.annotation</code> relationship type</h4>
<p>Annotations are events that use an <a href="#forming-relationships-between-events">event
relationship</a> with a <code>rel_type</code> of
<code>m.annotation</code>.</p>
<p>Annotations are normally used for &ldquo;reactions&rdquo;: for example, if the user wants
to react to an event with a thumbs-up, then the client sends an annotation
event with the corresponding emoji (). Another potential usage is to allow
bots to send an event indicating the success or failure of a command.</p>
<p>Along with the normal properties <code>event_id</code> and <code>rel_type</code>, an <code>m.relates_to</code>
property with <code>rel_type: m.annotation</code> should contain a <code>key</code> that indicates the
annotation being applied. For example, when reacting with emojis, the key
contains the emoji being used.</p>
<p>An example <code>m.annotation</code> relationship is shown below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="s2">&#34;m.relates_to&#34;</span><span class="err">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;rel_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.annotation&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$some_event_id&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="alert note " role="alert">
Any <code>type</code> of event is eligible for an annotation, including state events.
</div>
<h4 id="events">Events</h4>
<section class="rendered-data event">
<details open>
<summary>
  <h1 id="mreaction">
   <code>m.reaction</code>
  </h1>
</summary>
  <hr/>
<p>Indicates a reaction to a previous event.</p>
<p>Has no defined <code>content</code> properties of its own. Its only purpose is to hold an
<a href="/client-server-api/#definition-mrelates_to"><code>m.relates_to</code></a> property.</p>
<p>Since they contain no content other than <code>m.relates_to</code>, <code>m.reaction</code> events
are normally not encrypted, as there would be no benefit in doing so.</p>
<table class="basic-info">
  <tr>
   <th>Event type:</th>
   <td>Message event</td>
  </tr>
</table>
<h2>Content</h2>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>m.relates_to</code></td>
  <td><code>ReactionRelatesTo</code></td>
  <td>
    Indicates the event being reacted to, and the type of reaction.</td>
 </tr>
</table>
<table id="mreaction_reactionrelatesto" class="object-table">
 <caption>ReactionRelatesTo</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    The event ID of the event that this is a reaction to.</td>
 </tr>
 <tr>
  <td><code>key</code></td>
  <td><code>string</code></td>
  <td>
    <p>The reaction being made, usually an emoji.</p>
<p>If this is an emoji, it should include the unicode emoji
presentation selector (<code>\uFE0F</code>) for codepoints which allow it
(see the <a href="https://www.unicode.org/Public/UCD/latest/ucd/emoji/emoji-variation-sequences.txt">emoji variation sequences
list</a>).</p>
</td>
 </tr>
 <tr>
  <td><code>rel_type</code></td>
  <td><code>string</code></td>
  <td>
    <p>One of: <code>[m.annotation]</code>.</p></td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.relates_to&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$some_event_id&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;rel_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.annotation&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.reaction&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h4 id="annotations-client-behaviour">Client behaviour</h4>
<p>The intention of annotations is that they are counted up, rather than being
displayed individually.  Clients must keep count of the number of annotations
with a given event <code>type</code> and annotation <code>key</code> they observe for each event;
these counts are typically presented alongside the event in the timeline.</p>
<p>When performing this count:</p>
<ul>
<li>
<p>Each event <code>type</code> and annotation <code>key</code> should normally be counted
separately, though whether to actually do so is an implementation decision.</p>
</li>
<li>
<p>Annotation events sent by <a href="#ignoring-users">ignored users</a> should be
excluded from the count.</p>
</li>
<li>
<p>Multiple identical annotations (i.e., with the same event <code>type</code> and
annotation <code>key</code>) from the same user (i.e., events with the same <code>sender</code>)
should be treated as a single annotation.</p>
</li>
<li>
<p>Implementations should ignore any annotation event which refers to an event
which itself has an <code>m.relates_to</code> with <code>rel_type: m.annotation</code> or
<code>rel_type: m.replace</code>. In other words, it is not possible to annotate a
<a href="#event-replacements">replacement event</a> or an annotation.  Annotations should
instead refer to the original event.</p>
</li>
<li>
<p>When an annotation is redacted, it is removed from the count.</p>
</li>
</ul>
<div class="alert note " role="alert">
It is not possible to edit a reaction, since replacement events do not change
<code>m.relates_to</code> (see <a href="#applying-mnew_content">Applying <code>m.new_content</code></a>), and
there is no other meaningful content within <code>m.reaction</code>.  If a user wishes to
change their reaction, the original reaction should be redacted and a new one
sent in its place.
</div>
<div class="alert note " role="alert">
The <code>key</code> field in <code>m.reaction</code> can be any string so clients must take care to
render long reactions in a sensible manner. For example, clients can elide
overly-long reactions.
</div>
<h4 id="server-behaviour">Server behaviour</h4>
<h5 id="avoiding-duplicate-annotations">Avoiding duplicate annotations</h5>
<p>Homeservers should prevent users from sending a second annotation for a given
event with identical event <code>type</code> and annotation <code>key</code> (unless the first event
has been redacted).</p>
<p>Attempts to send such an annotation should be rejected with a 400 error and an
error code of <code>M_DUPLICATE_ANNOTATION</code>.</p>
<p>Note that this does not guarantee that duplicate annotations will not arrive
over federation. Clients are responsible for deduplicating received
annotations when <a href="#annotations-client-behaviour">counting annotations</a>.</p>
<h5 id="server-side-aggregation-of-mannotation-relationships">Server-side aggregation of <code>m.annotation</code> relationships</h5>
<p><code>m.annotation</code> relationships are <em>not</em>
<a href="#aggregations-of-child-events">aggregated</a> by the server. In other words,
<code>m.annotation</code> is not included in the <code>m.relations</code> property.</p>

    







    
<h3 id="threading">Threading</h3>
<p><span><strong>[Added in <code>v1.4</code>]</strong></span></p>
<p>Threads allow users to visually branch their conversations in a room. Typically mostly used
when a room is discussing multiple topics, threads provide more organisation of communication
that traditional <a href="#rich-replies">rich replies</a> can&rsquo;t always offer.</p>
<p>Clients SHOULD render threads differently to regular messages or replies in the timeline, such
as by providing some context to what is going on in the thread but keeping the full conversation
history behind a disclosure.</p>
<p>Threads are established using a <code>rel_type</code> of <code>m.thread</code> and reference the
<em>thread root</em> (the first event in a thread). It is not possible to create a
thread from an event which itself is the child of an event relationship (i.e.,
one with an <code>m.relates_to</code> property). It is therefore also not possible to nest
threads. All events in a thread reference the thread root instead of the
most recent message, unlike rich reply chains.</p>
<p>As a worked example, the following represents a thread and how it would be formed:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// irrelevant fields excluded
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$alice_hello&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;Hello world! How are you?&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// irrelevant fields excluded
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$bob_hello&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@bob:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.relates_to&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;rel_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.thread&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$alice_hello&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;I&#39;m doing okay, thank you! How about yourself?&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// irrelevant fields excluded
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$alice_reply&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.relates_to&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;rel_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.thread&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$alice_hello&#34;</span> <span class="c1">// note: always references the *thread root*
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;I&#39;m doing great! Thanks for asking.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>As shown, any event without a <code>rel_type</code> can become a thread root by simply referencing it
using an <code>m.thread</code> relationship.</p>
<h4 id="fallback-for-unthreaded-clients">Fallback for unthreaded clients</h4>
<p>Clients which understand how to work with threads should simply do so, however clients which
might not be aware of threads (due to age or scope) might not be able to helpfully represent
the conversation history to its users.</p>
<p>To work around this, events sent by clients which understand threads SHOULD include <a href="#rich-replies">rich reply</a>
metadata to attempt to form a reply chain representation of the conversation. This representation
is not ideal for heavily threaded rooms, but allows for users to have context as to what is
being discussed with respect to other messages in the room.</p>
<p>This representation is achieved by merging the two relationships and setting a new <code>is_falling_back</code>
flag to <code>true</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="c1">// within an event&#39;s content...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="s2">&#34;m.relates_to&#34;</span><span class="err">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// The m.thread relationship structure
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nt">&#34;rel_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.thread&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$root&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// The rich reply structure
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nt">&#34;m.in_reply_to&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The most recent message known to the client in the thread.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This should be something with a high chance of being rendered by the other client,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// such as an `m.room.message` event.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$target&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// A flag to denote that this is a thread with reply fallback
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nt">&#34;is_falling_back&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>For <code>m.room.message</code> events represented this way, no <a href="#fallbacks-for-rich-replies">reply fallback</a>
is specified. This allows thread-aware clients to discard the <code>m.in_reply_to</code> object entirely
when <code>is_falling_back</code> is <code>true</code>.</p>
<div class="alert note " role="alert">
<p>Clients which are acutely aware of threads (they do not render threads, but are otherwise
aware of the feature existing in the spec) can treat rich replies to an event with a <code>rel_type</code>
of <code>m.thread</code> as a threaded reply, for conversation continuity on the threaded client&rsquo;s side.</p>
<p>To do this, copy the <code>event_id</code> (thread root) from the event being replied to, add the
<code>m.in_reply_to</code> metadata, and add <code>is_falling_back: true</code> to <code>m.relates_to</code>.</p>
</div>
<h4 id="replies-within-threads">Replies within threads</h4>
<p>In the <a href="#fallback-for-unthreaded-clients">fallback for unthreaded clients</a> section, a new
<code>is_falling_back</code> flag is added to <code>m.relates_to</code>. This flag defaults to <code>false</code> when not
provided, which also allows a threaded message to contain a reply itself.</p>
<p>Aside from <code>is_falling_back</code> being <code>false</code> (or not specified), the fallback for unthreaded
clients is used to create a reply within a thread: clients should render the event accordingly.</p>
<h4 id="server-behaviour">Server behaviour</h4>
<h5 id="validation-of-mthread-relationships">Validation of <code>m.thread</code> relationships</h5>
<p>Servers SHOULD reject client requests which attempt to start a thread off an
event with an <code>m.relates_to</code> property. If the client attempts to target an event which itself
has an <code>m.relates_to</code> property, then it should receive a HTTP 400 error
response with appropriate error message, as per the <a href="#standard-error-response">standard error
response</a> structure.</p>
<div class="alert note " role="alert">
A specific error code is not currently available for this case: servers should use <code>M_UNKNOWN</code>
alongside the HTTP 400 status code.
</div>
<h5 id="server-side-aggregation-of-mthread-relationships">Server-side aggregation of <code>m.thread</code> relationships</h5>
<p>Given threads always reference the thread root, an event can have multiple
&ldquo;child&rdquo; events which then form the thread itself. These events should be
<a href="#aggregations-of-child-events">aggregated</a> by the server.</p>
<p>The aggregation for threads includes some information about the user&rsquo;s participation in the thread,
the approximate number of events in the thread (as known to the server), and the most recent event
in the thread (topologically).</p>
<p>As with any other aggregation of child events, the <code>m.thread</code> aggregation is
included under the <code>m.relations</code> property in <code>unsigned</code> for the thread root. For example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$root_event&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// irrelevant fields not shown
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.relations&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;m.thread&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;latest_event&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// A serialized copy of the latest event in the thread.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="c1">// Some fields are not shown here for brevity.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!room:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;Woo! Threads!&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;m.relations&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;count&#34;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;current_user_participated&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>latest_event</code> is the most recent event (topologically to the server) in the thread sent by an
un-<a href="#ignoring-users">ignored user</a>.</p>
<p>Note that, as in the example above, child events of the <code>latest_event</code> should
themselves be aggregated and included under <code>m.relations</code> for that event. The
server should be careful to avoid loops, though loops are not currently
possible due to <code>m.thread</code> not being permitted to target an event with an
<code>m.relates_to</code> property.</p>
<p><code>count</code> is simply the number of events using <code>m.thread</code> as a <code>rel_type</code> pointing to the target event.
It does not include events sent by <a href="#ignoring-users">ignored users</a>.</p>
<p><code>current_user_participated</code> is <code>true</code> when the authenticated user is either:</p>
<ol>
<li>The <code>sender</code> of the thread root event.</li>
<li>The <code>sender</code> of an event which references the thread root with a <code>rel_type</code> of <code>m.thread</code>.</li>
</ol>
<h4 id="querying-threads-in-a-room">Querying threads in a room</h4>
<p>Clients looking to get all the events in a thread can use
<a href="#get_matrixclientv1roomsroomidrelationseventidreltype"><code>GET /relations/{threadRootId}/m.thread</code></a>,
however getting all threads in a room is done through a dedicated API:</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixclientv1roomsroomidthreads">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/client/v1/rooms/{roomId}/threads</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.4</code></strong></p>
<p><p>This API is used to paginate through the list of the thread roots in a given room.</p>
<p>Optionally, the returned list may be filtered according to whether the requesting
user has participated in the thread.</p>
</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID where the thread roots are located.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>from</code></td>
  <td><code>string</code></td>
  <td>
    A pagination token from a previous result. When not provided, the server starts paginating from
the most recent event visible to the user (as per history visibility rules; topologically).</td>
 </tr>
 <tr>
  <td><code>include</code></td>
  <td><code>string</code></td>
  <td>
    Optional (default <code>all</code>) flag to denote which thread roots are of interest to the caller.
When <code>all</code>, all thread roots found in the room are returned. When <code>participated</code>, only
thread roots for threads the user has <a href="/client-server-api/#server-side-aggregation-of-mthread-relationships">participated in</a>
will be returned.<p>One of: <code>[all, participated]</code>.</p></td>
 </tr>
 <tr>
  <td><code>limit</code></td>
  <td><code>integer</code></td>
  <td>
    <p>Optional limit for the maximum number of thread roots to include per response. Must be an integer
greater than zero.</p>
<p>Servers should apply a default value, and impose a maximum value to avoid resource exhaustion.</p>
</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <th class="col-status">Status</th>
  <th class="col-status-description">Description</th>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>A portion of the available thread roots in the room, based on the filter criteria.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td><p>The request was invalid in some way. A meaningful <code>errcode</code>
and description error text will be returned. Example reasons for rejection are:</p>
<ul>
<li>The <code>from</code> token is unknown to the server.</li>
</ul>
</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td><p>The user cannot view or peek on the room. A meaningful <code>errcode</code>
and description error text will be returned. Example reasons for rejection are:</p>
<ul>
<li>The room is not set up for peeking.</li>
<li>The user has been banned from the room.</li>
<li>The room does not exist.</li>
</ul>
</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>chunk</code></td>
  <td><code>[ClientEvent]</code></td>
  <td>
    <strong>Required: </strong><p>The thread roots, ordered by the <code>latest_event</code> in each event&rsquo;s aggregated children. All events
returned include bundled <a href="/client-server-api/#aggregations-of-child-events">aggregations</a>.</p>
<p>If the thread root event was sent by an <a href="/client-server-api/#ignoring-users">ignored user</a>, the
event is returned redacted to the caller. This is to simulate the same behaviour of a client doing
aggregation locally on the thread.</p>
</td>
 </tr>
 <tr>
  <td><code>next_batch</code></td>
  <td><code>string</code></td>
  <td>
    A token to supply to <code>from</code> to keep paginating the responses. Not present when there are
no further results.</td>
 </tr>
</table>
<table id="_matrixclientv1roomsroomidthreads_clientevent" class="object-table">
 <caption>ClientEvent</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The body of this event, as created by the client which sent it.</td>
 </tr>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The globally unique identifier for this event.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>Timestamp (in milliseconds since the unix epoch) on originating homeserver
when this event was sent.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room associated with this event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Contains the fully-qualified ID of the user who sent this event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <p>Present if, and only if, this event is a <em>state</em> event. The key making
this piece of state unique in the room. Note that it is often an empty
string.</p>
<p>State keys starting with an <code>@</code> are reserved for referencing user IDs, such
as room members. With the exception of a few events, state events set with a
given user&rsquo;s ID as the state key MUST only be set by that user.</p>
</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of the event.</td>
 </tr>
 <tr>
  <td><code>unsigned</code></td>
  <td><code>UnsignedData</code></td>
  <td>
    Contains optional extra information about the event.</td>
 </tr>
</table>
<table id="_matrixclientv1roomsroomidthreads_unsigneddata" class="object-table">
 <caption>UnsignedData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>age</code></td>
  <td><code>integer</code></td>
  <td>
    The time in milliseconds that has elapsed since the event was sent. This field is generated by the local homeserver, and may be incorrect if the local time on at least one of the two servers is out of sync, which can cause the age to either be negative or greater than it actually is.</td>
 </tr>
 <tr>
  <td><code>prev_content</code></td>
  <td><code>EventContent</code></td>
  <td>
    The previous <code>content</code> for this event. This field is generated
by the local homeserver, and is only returned if the event is a state event,
and the client has permission to see the previous content.<br><br>
    <strong>
      Changed in <code>v1.2</code>:
    </strong>
    Previously, this field was specified at the top level of returned
events rather than in <code>unsigned</code> (with the exception of the <a href="/client-server-api/#get_matrixclientv3notifications"><code>GET .../notifications</code></a>
endpoint), though in practice no known server implementations honoured
this.
</td>
 </tr>
 <tr>
  <td><code>redacted_because</code></td>
  <td><code>ClientEvent</code></td>
  <td>
    The event that redacted this event, if any.</td>
 </tr>
 <tr>
  <td><code>transaction_id</code></td>
  <td><code>string</code></td>
  <td>
    The client-supplied <a href="/client-server-api/#transaction-identifiers">transaction ID</a>, for example, provided via
<code>PUT /_matrix/client/v3/rooms/{roomId}/send/{eventType}/{txnId}</code>,
if the client being given the event is the same one which sent it.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;chunk&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;body&#34;</span><span class="p">:</span> <span class="s2">&#34;This is an example text message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;org.matrix.custom.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;formatted_body&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;b&gt;This is an example text message&lt;/b&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;msgtype&#34;</span><span class="p">:</span> <span class="s2">&#34;m.text&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!jEsUZKDJdhlrceRyVU:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@example:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;next_batch&#34;</span><span class="p">:</span> <span class="s2">&#34;next_batch_token&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="_matrixclientv1roomsroomidthreads_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_INVALID_PARAM&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Unknown pagination token&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="_matrixclientv1roomsroomidthreads_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;You are not allowed to view this room.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="_matrixclientv1roomsroomidthreads_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>

    







    
<h3 id="reference-relations">Reference relations</h3>
<p><span><strong>[Added in <code>v1.5</code>]</strong></span></p>
<p>Generically referencing another event can be done with a <code>rel_type</code> of <code>m.reference</code>
as a form of <a href="#forming-relationships-between-events">relationship</a>. There is no
implied meaning behind the reference, and is usually context-dependent. One
example is the <a href="#key-verification-framework">key verification framework</a> which uses
reference relations to associate distinct events with a specific verification attempt.</p>
<div class="alert note " role="alert">
Clients which wish to use threads or replies are expected to use other relationship
types than references. References are typically used to associate data rather than
messages.
</div>
<h4 id="server-behaviour">Server behaviour</h4>
<h5 id="server-side-aggregation-of-mreference">Server-side aggregation of <code>m.reference</code></h5>
<p>The <a href="#aggregations-of-child-events">aggregation</a> format of <code>m.reference</code>
relations consists of a single <code>chunk</code> property, which lists all the events
which <code>m.reference</code> the event (the parent). Currently, only a single <code>event_id</code>
field is present on the events in the <code>chunk</code>.</p>
<p>For example, given an event with the following <code>m.reference</code> relationship:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;m.relates_to&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;rel_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.reference&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$another_event&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// other content fields as required
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// other fields as required by events
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>The aggregation would appear similar to the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;m.reference&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;chunk&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span> <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$one&#34;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span> <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$two&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
    

</p>

</div>

          </main>
        </div>
      </div>
      


<footer class="py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-12 text-center text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-dark" target="_blank" rel="noopener noreferrer" href="https://github.com/matrix-org">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitLab" aria-label="GitLab">
    <a class="text-dark" target="_blank" rel="noopener noreferrer" href="https://gitlab.matrix.org/matrix-org">
      <i class="fab fa-gitlab"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="YouTube" aria-label="YouTube">
    <a class="text-dark" target="_blank" rel="noopener noreferrer" href="https://www.youtube.com/channel/UCVFkW-chclhuyYRbmmfwt6w">
      <i class="fab fa-youtube"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-dark" target="_blank" rel="noopener noreferrer" href="https://twitter.com/matrixdotorg">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
    </div>
    <div class="row">
      <div class="col-12 text-center py-2 order-sm-3">
        <small>&copy; 2023 The Matrix.org Foundation CIC</small>
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    

<script src="/js/main.min.be25a680a0d95dc8b5d6664622e2134aa894220e2f224ef609e00f633a3a1b32.js" integrity="sha256-viWmgKDZXci11mZGIuITSqiUIg4vIk72CeAPYzo6GzI=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>


<script defer language="javascript" type="text/javascript"  src="/js/toc.js"></script>

  </body>
</html>
