

<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.119.0">
<meta name="robots" content="index, follow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Room Version 11 | Matrix Specification</title>
<meta name="description" content="This room version builds on version 10 while clarifying redaction rules.
Client considerations Redactions [New in this version] The top-level origin, membership, and prev_state properties are no longer protected from redaction. The m.room.create event now keeps the entire content property. The m.room.redaction event keeps the redacts property under content. The m.room.power_levels event keeps the invite property under content.
The full redaction algorithm follows.
Upon receipt of a redaction event, the server must strip off any keys not in the following list:">
<meta property="og:title" content="Room Version 11" />
<meta property="og:description" content="This room version builds on version 10 while clarifying redaction rules.
Client considerations Redactions [New in this version] The top-level origin, membership, and prev_state properties are no longer protected from redaction. The m.room.create event now keeps the entire content property. The m.room.redaction event keeps the redacts property under content. The m.room.power_levels event keeps the invite property under content.
The full redaction algorithm follows.
Upon receipt of a redaction event, the server must strip off any keys not in the following list:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/rooms/v11/" /><meta property="article:section" content="rooms" />


<meta itemprop="name" content="Room Version 11">
<meta itemprop="description" content="This room version builds on version 10 while clarifying redaction rules.
Client considerations Redactions [New in this version] The top-level origin, membership, and prev_state properties are no longer protected from redaction. The m.room.create event now keeps the entire content property. The m.room.redaction event keeps the redacts property under content. The m.room.power_levels event keeps the invite property under content.
The full redaction algorithm follows.
Upon receipt of a redaction event, the server must strip off any keys not in the following list:">

<meta itemprop="wordCount" content="3818">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Room Version 11"/>
<meta name="twitter:description" content="This room version builds on version 10 while clarifying redaction rules.
Client considerations Redactions [New in this version] The top-level origin, membership, and prev_state properties are no longer protected from redaction. The m.room.create event now keeps the entire content property. The m.room.redaction event keeps the redacts property under content. The m.room.power_levels event keeps the invite property under content.
The full redaction algorithm follows.
Upon receipt of a redaction event, the server must strip off any keys not in the following list:"/>




<link rel="preload" href="/scss/main.min.af4c3a756149c6e6a38a514505696051afd07c3cc0ac1bb64498d5cd0c8f613b.css" as="style">
<link href="/scss/main.min.af4c3a756149c6e6a38a514505696051afd07c3cc0ac1bb64498d5cd0c8f613b.css" rel="stylesheet" integrity="">

<script
  src="/js/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK">
</script>



<link rel="preload" href="/css/fonts/Inter.css" as="style">
<link rel="stylesheet" href="/css/fonts/Inter.css">




<link rel="preload" href="/scss/custom.min.e7010c4aa0015f690b91b7b50c35f1a5f21ea69d2fe93db6b124deb2722a2dcf.css" as="style">
<link href="/scss/custom.min.e7010c4aa0015f690b91b7b50c35f1a5f21ea69d2fe93db6b124deb2722a2dcf.css" rel="stylesheet" integrity="">


  </head>
  <body class="td-page">
    <header>
      


<nav class="js-navbar-scroll navbar navbar-expand navbar-light flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg width="75" height="32" xmlns="http://www.w3.org/2000/svg"><g fill="#000" fill-rule="nonzero"><path d="M.936.732V31.25H3.13v.732H.095V0h3.034v.732zm8.45 9.675v1.544h.044a4.461 4.461.0 011.487-1.368c.58-.323 1.245-.485 1.993-.485.72.0 1.377.14 1.972.42.595.279 1.047.771 1.355 1.477.338-.5.796-.941 1.377-1.323.58-.383 1.266-.574 2.06-.574.602.0 1.16.074 1.674.22.514.148.954.383 1.322.707.366.323.653.746.859 1.268.205.522.308 1.15.308 1.887v7.633H20.71v-6.464c0-.383-.015-.743-.044-1.082a2.305 2.305.0 00-.242-.882 1.473 1.473.0 00-.584-.596c-.257-.146-.606-.22-1.047-.22-.44.0-.796.085-1.068.253-.272.17-.485.39-.639.662a2.654 2.654.0 00-.308.927 7.074 7.074.0 00-.078 1.048v6.354h-3.128v-6.398c0-.338-.007-.673-.021-1.004a2.825 2.825.0 00-.188-.916 1.411 1.411.0 00-.55-.673c-.258-.168-.636-.253-1.135-.253a2.33 2.33.0 00-.584.1 1.94 1.94.0 00-.705.374c-.228.184-.422.449-.584.794-.161.346-.242.798-.242 1.357v6.619H6.434V10.407h2.952zm16.456 1.677a3.751 3.751.0 011.233-1.17 5.37 5.37.0 011.685-.629 9.579 9.579.0 011.884-.187c.573.0 1.153.04 1.74.121.588.081 1.124.24 1.609.475.484.235.88.562 1.19.981.308.42.462.975.462 1.666v5.934c0 .516.03 1.008.088 1.478.058.471.161.824.308 1.06H32.87a4.435 4.435.0 01-.22-1.104c-.5.515-1.087.876-1.762 1.081a7.084 7.084.0 01-2.071.31c-.544.0-1.05-.067-1.52-.2a3.472 3.472.0 01-1.234-.617 2.87 2.87.0 01-.826-1.059c-.199-.426-.298-.934-.298-1.522.0-.647.114-1.18.342-1.6.227-.419.52-.753.881-1.004.36-.25.771-.437 1.234-.562.462-.125.929-.224 1.399-.298.47-.073.932-.132 1.387-.176.456-.044.86-.11 1.212-.199.353-.088.631-.217.837-.386.206-.169.301-.415.287-.74.0-.337-.055-.606-.166-.804a1.217 1.217.0 00-.44-.464 1.737 1.737.0 00-.639-.22 5.292 5.292.0 00-.782-.055c-.617.0-1.101.132-1.454.397-.352.264-.558.706-.617 1.323h-3.128c.044-.735.227-1.345.55-1.83zm6.179 4.423a5.095 5.095.0 01-.639.165 9.68 9.68.0 01-.716.11c-.25.03-.5.067-.749.11a5.616 5.616.0 00-.694.177 2.057 2.057.0 00-.594.298c-.17.125-.305.284-.408.474-.103.192-.154.434-.154.728.0.28.051.515.154.706.103.192.242.342.419.453.176.11.381.187.617.231.234.044.477.066.726.066.617.0 1.094-.102 1.432-.309.338-.205.587-.452.75-.739.16-.286.26-.576.297-.87.036-.295.055-.53.055-.707v-1.17a1.4 1.4.0 01-.496.277zm11.863-6.1v2.096h-2.291v5.647c0 .53.088.883.264 1.059.176.177.529.265 1.057.265.177.0.345-.007.507-.022.161-.015.316-.037.463-.066v2.426a7.49 7.49.0 01-.882.089 21.67 21.67.0 01-.947.022c-.484.0-.944-.034-1.377-.1a3.233 3.233.0 01-1.145-.386 2.04 2.04.0 01-.782-.816c-.191-.353-.287-.816-.287-1.39v-6.728H36.57v-2.096h1.894v-3.42h3.129v3.42h2.29zm4.471.0v2.118h.044a3.907 3.907.0 011.454-1.754 4.213 4.213.0 011.036-.497 3.734 3.734.0 011.145-.176c.206.0.433.037.683.11v2.912a5.862 5.862.0 00-.528-.077 5.566 5.566.0 00-.595-.033c-.573.0-1.058.096-1.454.287a2.52 2.52.0 00-.958.783 3.143 3.143.0 00-.518 1.158 6.32 6.32.0 00-.154 1.434v5.14h-3.128V10.407h2.973zM54.039 8.642V6.06h3.128v2.582H54.04zm3.128 1.765v11.405H54.04V10.407h3.128zm1.63.0h3.569l2.005 2.978 1.982-2.978h3.459l-3.745 5.339 4.208 6.067h-3.57l-2.378-3.596-2.38 3.596h-3.502l4.097-6.001zM74.094 31.25V.732H71.9V0h3.035v31.982H71.9v-.732z"/></g></svg></span><span class="font-weight-bold">specification</span><span class="navbar-version"> &mdash; unstable version</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">

			<li class="nav-item mr-4 mb-2 mb-lg-0"><a href="https://matrix.org/foundation/">Foundation</a>
			</li>

      <li class="nav-item mr-4 mb-2 mb-lg-0"><a href="https://matrix.org/faq/">FAQs</a>
			</li>

      <li class="nav-item mr-4 mb-2 mb-lg-0"><a href="https://matrix.org/blog/posts">Blog</a>
      </li>

			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"></div>
</nav>




    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-3 td-sidebar d-print-none">
            
<div id="td-sidebar-menu" class="td-sidebar__inner">
  <div id="content-mobile">
  <form class="td-sidebar__search d-flex align-items-center">
    
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-section-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  </div>
  <div id="content-desktop"></div>
  <nav class="collapse td-sidebar-nav" id="td-section-nav">
    <ul class="td-sidebar-nav__section pr-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m--li">
  <a href="/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-"><span class="">Matrix Specification</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-client-server-api-li">
  <a href="/client-server-api/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-client-server-api"><span class="">Client-Server API</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-server-server-api-li">
  <a href="/server-server-api/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-server-server-api"><span class="">Server-Server API</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-application-service-api-li">
  <a href="/application-service-api/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-application-service-api"><span class="">Application Service API</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-identity-service-api-li">
  <a href="/identity-service-api/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-identity-service-api"><span class="">Identity Service API</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-push-gateway-api-li">
  <a href="/push-gateway-api/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-push-gateway-api"><span class="">Push Gateway API</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-rooms-li">
  <a href="/rooms/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-rooms"><span class="">Room Versions</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-roomsv1-li">
  <a href="/rooms/v1/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv1"><span class="">Room Version 1</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-roomsv2-li">
  <a href="/rooms/v2/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv2"><span class="">Room Version 2</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-roomsv3-li">
  <a href="/rooms/v3/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv3"><span class="">Room Version 3</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-roomsv4-li">
  <a href="/rooms/v4/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv4"><span class="">Room Version 4</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-roomsv5-li">
  <a href="/rooms/v5/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv5"><span class="">Room Version 5</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-roomsv6-li">
  <a href="/rooms/v6/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv6"><span class="">Room Version 6</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-roomsv7-li">
  <a href="/rooms/v7/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv7"><span class="">Room Version 7</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-roomsv8-li">
  <a href="/rooms/v8/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv8"><span class="">Room Version 8</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-roomsv9-li">
  <a href="/rooms/v9/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv9"><span class="">Room Version 9</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-roomsv10-li">
  <a href="/rooms/v10/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv10"><span class="">Room Version 10</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-roomsv11-li">
  <a href="/rooms/v11/" class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id="m-roomsv11"><span class="td-sidebar-nav-active-item">Room Version 11</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-proposals-li">
  <a href="/proposals/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-proposals"><span class="">Spec Change Proposals</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-appendices-li">
  <a href="/appendices/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-appendices"><span class="">Appendices</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-changelog-li">
  <a href="/changelog/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-changelog"><span class="">Changelog</span></a>
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </div>
          <main class="col-12 col-md-9 col-xl-7 pl-md-5" role="main">
            






<div class="pageinfo pageinfo-primary pageinfo-unstable">
  <p>You're looking at an unstable version of this specification.
  Unstable specifications may change at any time without notice.</p>
  <p><a href="https://spec.matrix.org/latest">Switch to the current stable release</a>.</p>
</div>


            


<nav aria-label="breadcrumb" class="d-none d-md-block d-print-none">
	<ol class="breadcrumb spb-1">







<li class="breadcrumb-item" >
	<a href="/">Matrix Specification</a>
</li>



<li class="breadcrumb-item" >
	<a href="/rooms/">Room Versions</a>
</li>



<li class="breadcrumb-item active" aria-current="page">
	<a href="/rooms/v11/">Room Version 11</a>
</li>

	</ol>
</nav	>




            
<div class="td-content">
	<h1>Room Version 11</h1>
	<p>This room version builds on <a href="/rooms/v10">version 10</a> while clarifying redaction
rules.</p>
<h2 id="client-considerations">Client considerations</h2>
<h3 id="redactions">Redactions</h3>
<p>



  <span><strong>[New in this version]</strong></span>
 
 The top-level <code>origin</code>, <code>membership</code>, and <code>prev_state</code> properties
are no longer protected from redaction. The <a href="/client-server-api#mroomcreate"><code>m.room.create</code></a>
event now keeps the entire <code>content</code> property. The <a href="/client-server-api#mroomredaction"><code>m.room.redaction</code></a>
event keeps the <code>redacts</code> property under <code>content</code>. The
<a href="/client-server-api#mroompower_levels"><code>m.room.power_levels</code></a> event keeps the
<code>invite</code> property under <code>content</code>.</p>
<p>The full redaction algorithm follows.</p>
<p>Upon receipt of a redaction event, the server must strip off any keys
not in the following list:</p>
<ul>
<li><code>event_id</code></li>
<li><code>type</code></li>
<li><code>room_id</code></li>
<li><code>sender</code></li>
<li><code>state_key</code></li>
<li><code>content</code></li>
<li><code>hashes</code></li>
<li><code>signatures</code></li>
<li><code>depth</code></li>
<li><code>prev_events</code></li>
<li><code>auth_events</code></li>
<li><code>origin_server_ts</code></li>
</ul>
<p>The content object must also be stripped of all keys, unless it is one
of the following event types:</p>
<ul>
<li><a href="/client-server-api#mroommember"><code>m.room.member</code></a> allows keys <code>membership</code>, <code>join_authorised_via_users_server</code>.
Additionally, it allows the <code>signed</code> key of the <code>third_party_invite</code> key.</li>
<li><a href="/client-server-api#mroomcreate"><code>m.room.create</code></a> allows all keys.</li>
<li><a href="/client-server-api#mroomjoin_rules"><code>m.room.join_rules</code></a> allows keys <code>join_rule</code>, <code>allow</code>.</li>
<li><a href="/client-server-api#mroompower_levels"><code>m.room.power_levels</code></a> allows keys
<code>ban</code>, <code>events</code>, <code>events_default</code>, <code>invite</code>, <code>kick</code>, <code>redact</code>, <code>state_default</code>,
<code>users</code>, <code>users_default</code>.</li>
<li><a href="/client-server-api#mroomhistory_visibility"><code>m.room.history_visibility</code></a>
allows key <code>history_visibility</code>.</li>
<li><a href="/client-server-api#mroomredaction"><code>m.room.redaction</code></a> allows key <code>redacts</code>.</li>
</ul>
<h3 id="event-format">Event format</h3>
<p>Clients should no longer depend on the <code>creator</code> property in the <code>content</code> of
<a href="/client-server-api#mroomcreate"><code>m.room.create</code></a> events.  In all room versions,
clients can rely on <code>sender</code> instead to determine a room creator.</p>
<p>The format of <a href="/client-server-api#mroomredaction"><code>m.room.redaction</code></a>
events has been modified. Client should look for the <code>redacts</code> key under <code>content</code>
instead of a top-level event property.</p>
<p>The <code>third_party_invite</code> key of <a href="/client-server-api#mroommember"><code>m.room.member</code></a>
events is no longer redacted, <em>but</em> will only contain the <code>signed</code> key after redaction.</p>
<h2 id="server-implementation-components">Server implementation components</h2>
<div class="alert warning " role="alert">
The information contained in this section is strictly for server
implementors. Applications which use the Client-Server API are generally
unaffected by the intricacies contained here. The section above
regarding client considerations is the resource that Client-Server API
use cases should reference.
</div>
<p>This room version updates the redaction algorithm and modifies how servers should
create <code>m.room.create</code> and <code>m.room.redaction</code> events.</p>
<p>Room version 11 is based upon room version 10 with the following considerations.</p>
<h3 id="redactions-1">Redactions</h3>
<p><a href="#redactions">See above</a>.</p>
<h3 id="event-format-1">Event format</h3>
<p>The core event format is the same as <a href="/rooms/v10#event-format">room version 10</a>.
However, this room version changes some properties of some event types.</p>
<p>Events in rooms of this version have the following structure:</p>
<section class="rendered-data definition" id="definition-persistent-data-unit">
<details open>
<summary>
<h1>
 <code>Persistent Data Unit</code>
</h1>
</summary>
<hr/>
<p>A persistent data unit (event) for room version 11 and beyond.</p>
<table class="object-table">
 <caption>Persistent Data Unit</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>auth_events</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong><p>Event IDs for the authorization events that would
allow this event to be in the room.</p>
<p>Must contain less than or equal to 10 events. Note that if the relevant
auth event selection rules are used, this restriction should never be
encountered.</p>
</td>
 </tr>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The content of the event.</td>
 </tr>
 <tr>
  <td><code>depth</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The maximum depth of the <code>prev_events</code>, plus one. Must be less than the
maximum value for an integer (2^63 - 1). If the room&rsquo;s depth is already at
the limit, the depth must be set to the limit.</td>
 </tr>
 <tr>
  <td><code>hashes</code></td>
  <td><code>Event Hash</code></td>
  <td>
    <strong>Required: </strong>Content hashes of the PDU, following the algorithm specified in <a href="/server-server-api/#signing-events">Signing Events</a>.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>Timestamp in milliseconds on origin homeserver when this event was created.</td>
 </tr>
 <tr>
  <td><code>prev_events</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong><p>Event IDs for the most recent events in the room
that the homeserver was aware of when it made this event.</p>
<p>Must contain less than or equal to 20 events.</p>
</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Room identifier.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the user sending the event.</td>
 </tr>
 <tr>
  <td><code>signatures</code></td>
  <td><code>{string: Server Signatures}</code></td>
  <td>
    <strong>Required: </strong>Signatures for the PDU, following the algorithm specified in <a href="/server-server-api/#signing-events">Signing Events</a>.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    If this key is present, the event is a state event, and it will replace previous events
with the same <code>type</code> and <code>state_key</code> in the room state.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Event type</td>
 </tr>
 <tr>
  <td><code>unsigned</code></td>
  <td><code>UnsignedData</code></td>
  <td>
    Additional data added by the origin server but not covered by the <code>signatures</code>.</td>
 </tr>
</table>
<table class="object-table">
 <caption>Event Hash</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>sha256</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The hash.</td>
 </tr>
</table>
<table class="object-table">
 <caption>UnsignedData</caption>
 <thead>
  <th class="col-name">Name</th>
  <th class="col-type">Type</th>
  <th class="col-description">Description</th>
 </thead>
 <tr>
  <td><code>age</code></td>
  <td><code>integer</code></td>
  <td>
    The number of milliseconds that have passed since this message was sent.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;auth_events&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;$urlsafe_base64_encoded_eventid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;$a-different-event-id&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;value&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;depth&#34;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;hashes&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sha256&#34;</span><span class="p">:</span> <span class="s2">&#34;thishashcoversallfieldsincasethisisredacted&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin&#34;</span><span class="p">:</span> <span class="s2">&#34;example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1404838188000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;prev_events&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;$urlsafe_base64_encoded_eventid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;$a-different-event-id&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!UcYsUzyxTGDxLBEvLy:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;ed25519:key_version:&#34;</span><span class="p">:</span> <span class="s2">&#34;these86bytesofbase64signaturecoveressentialfieldsincludinghashessocancheckredactedpdus&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">4612</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></section>
<h4 id="remove-the-creator-property-of-mroomcreate-events">Remove the <code>creator</code> property of <code>m.room.create</code> events</h4>
<p>The <code>content</code> of a <code>m.room.create</code> event no longer has a <code>creator</code> property,
which previously was always equivalent to the <code>sender</code> of the event.</p>
<h4 id="moving-the-redacts-property-of-mroomredaction-events-to-a-content-property">Moving the <code>redacts</code> property of <code>m.room.redaction</code> events to a <code>content</code> property</h4>
<p>The <code>redacts</code> property of <code>m.room.redaction</code> events is moved from a top-level
event property to a property under the event <code>content</code>.</p>
<p>For backwards-compatibility with older clients, servers should add a <code>redacts</code> property
to the top level of <code>m.room.redaction</code> events in when serving such events over the
Client-Server API.</p>
<p>For improved compatibility with newer clients, servers should add a <code>redacts</code> property
to the <code>content</code> of <code>m.room.redaction</code> events in <em>older</em> room versions when serving
such events over the Client-Server API.</p>
<h3 id="authorization-rules">Authorization rules</h3>
<p>Events must be signed by the server denoted by the <code>sender</code> property.</p>
<p><code>m.room.redaction</code> events are not explicitly part of the auth rules.
They are still subject to the minimum power level rules, but should always
fall into &ldquo;10. Otherwise, allow&rdquo;. Instead of being authorized at the time
of receipt, they are authorized at a later stage: see the
<a href="#redactions">Redactions</a> section below for more information.</p>
<p>The types of state events that affect authorization are:</p>
<ul>
<li><a href="/client-server-api#mroomcreate"><code>m.room.create</code></a></li>
<li><a href="/client-server-api#mroommember"><code>m.room.member</code></a></li>
<li><a href="/client-server-api#mroomjoin_rules"><code>m.room.join_rules</code></a></li>
<li><a href="/client-server-api#mroompower_levels"><code>m.room.power_levels</code></a></li>
<li><a href="/client-server-api#mroomthird_party_invite"><code>m.room.third_party_invite</code></a></li>
</ul>
<div class="alert note " role="alert">
Power levels are inferred from defaults when not explicitly supplied.
For example, mentions of the <code>sender</code>&rsquo;s power level can also refer to
the default power level for users in the room.
</div>
<p>The rules are as follows:</p>
<ol>
<li>



  <span><strong>[Changed in this version]</strong></span>
 

If type is <code>m.room.create</code>:
<ol>
<li>If it has any <code>prev_events</code>, reject.</li>
<li>If the domain of the <code>room_id</code> does not match the domain of the
<code>sender</code>, reject.</li>
<li>If <code>content.room_version</code> is present and is not a recognised
version, reject.</li>
<li>Otherwise, allow.</li>
</ol>
</li>
<li>Considering the event&rsquo;s <code>auth_events</code>:
<ol>
<li>If there are duplicate entries for a given <code>type</code> and <code>state_key</code> pair,
reject.</li>
<li>If there are entries whose <code>type</code> and <code>state_key</code> don&rsquo;t match those
specified by the <a href="/server-server-api#auth-events-selection">auth events
selection</a>
algorithm described in the server specification, reject.</li>
<li>If there are entries which were themselves rejected under the <a href="/server-server-api/#checks-performed-on-receipt-of-a-pdu">checks
performed on receipt of a
PDU</a>, reject.</li>
<li>If there is no <code>m.room.create</code> event among the entries, reject.</li>
</ol>
</li>
<li>If the <code>content</code> of the <code>m.room.create</code> event in the room state has the
property <code>m.federate</code> set to <code>false</code>, and the <code>sender</code> domain of the event
does not match the <code>sender</code> domain of the create event, reject.</li>
<li>If type is <code>m.room.member</code>:
<ol>
<li>If there is no <code>state_key</code> property, or no <code>membership</code> property in
<code>content</code>, reject.</li>
<li>If <code>content</code> has a <code>join_authorised_via_users_server</code>
key:
<ol>
<li>If the event is not validly signed by the homeserver of the user ID denoted
by the key, reject.</li>
</ol>
</li>
<li>If <code>membership</code> is <code>join</code>:
<ol>
<li>



  <span><strong>[Changed in this version]</strong></span>
 

If the only previous event is an <code>m.room.create</code> and the
<code>state_key</code> is the sender, allow.</li>
<li>If the <code>sender</code> does not match <code>state_key</code>, reject.</li>
<li>If the <code>sender</code> is banned, reject.</li>
<li>If the <code>join_rule</code> is <code>invite</code> or <code>knock</code> then allow if
membership state is <code>invite</code> or <code>join</code>.</li>
<li>If the <code>join_rule</code> is <code>restricted</code> or <code>knock_restricted</code>:
<ol>
<li>If membership state is <code>join</code> or <code>invite</code>, allow.</li>
<li>If the <code>join_authorised_via_users_server</code> key in <code>content</code>
is not a user with sufficient permission to invite other
users, reject.</li>
<li>Otherwise, allow.</li>
</ol>
</li>
<li>If the <code>join_rule</code> is <code>public</code>, allow.</li>
<li>Otherwise, reject.</li>
</ol>
</li>
<li>If <code>membership</code> is <code>invite</code>:
<ol>
<li>If <code>content</code> has a <code>third_party_invite</code> property:
<ol>
<li>If <em>target user</em> is banned, reject.</li>
<li>If <code>content.third_party_invite</code> does not have a <code>signed</code>
property, reject.</li>
<li>If <code>signed</code> does not have <code>mxid</code> and <code>token</code> properties,
reject.</li>
<li>If <code>mxid</code> does not match <code>state_key</code>, reject.</li>
<li>If there is no <code>m.room.third_party_invite</code> event in the
current room state with <code>state_key</code> matching <code>token</code>,
reject.</li>
<li>If <code>sender</code> does not match <code>sender</code> of the
<code>m.room.third_party_invite</code>, reject.</li>
<li>If any signature in <code>signed</code> matches any public key in
the <code>m.room.third_party_invite</code> event, allow. The public
keys are in <code>content</code> of <code>m.room.third_party_invite</code> as:
<ol>
<li>A single public key in the <code>public_key</code> property.</li>
<li>A list of public keys in the <code>public_keys</code> property.</li>
</ol>
</li>
<li>Otherwise, reject.</li>
</ol>
</li>
<li>If the <code>sender</code>&rsquo;s current membership state is not <code>join</code>,
reject.</li>
<li>If <em>target user</em>&rsquo;s current membership state is <code>join</code> or
<code>ban</code>, reject.</li>
<li>If the <code>sender</code>&rsquo;s power level is greater than or equal to
the <em>invite level</em>, allow.</li>
<li>Otherwise, reject.</li>
</ol>
</li>
<li>If <code>membership</code> is <code>leave</code>:
<ol>
<li>If the <code>sender</code> matches <code>state_key</code>, allow if and only if
that user&rsquo;s current membership state is <code>invite</code>, <code>join</code>,
or <code>knock</code>.</li>
<li>If the <code>sender</code>&rsquo;s current membership state is not <code>join</code>,
reject.</li>
<li>If the <em>target user</em>&rsquo;s current membership state is <code>ban</code>,
and the <code>sender</code>&rsquo;s power level is less than the <em>ban level</em>,
reject.</li>
<li>If the <code>sender</code>&rsquo;s power level is greater than or equal to
the <em>kick level</em>, and the <em>target user</em>&rsquo;s power level is
less than the <code>sender</code>&rsquo;s power level, allow.</li>
<li>Otherwise, reject.</li>
</ol>
</li>
<li>If <code>membership</code> is <code>ban</code>:
<ol>
<li>If the <code>sender</code>&rsquo;s current membership state is not <code>join</code>,
reject.</li>
<li>If the <code>sender</code>&rsquo;s power level is greater than or equal to
the <em>ban level</em>, and the <em>target user</em>&rsquo;s power level is less
than the <code>sender</code>&rsquo;s power level, allow.</li>
<li>Otherwise, reject.</li>
</ol>
</li>
<li>If <code>membership</code> is <code>knock</code>:
<ol>
<li>If the <code>join_rule</code> is anything other than <code>knock</code> or
<code>knock_restricted</code>, reject.</li>
<li>If <code>sender</code> does not match <code>state_key</code>, reject.</li>
<li>If the <code>sender</code>&rsquo;s current membership is not <code>ban</code> or <code>join</code>, allow.</li>
<li>Otherwise, reject.</li>
</ol>
</li>
<li>Otherwise, the membership is unknown. Reject.</li>
</ol>
</li>
<li>If the <code>sender</code>&rsquo;s current membership state is not <code>join</code>, reject.</li>
<li>If type is <code>m.room.third_party_invite</code>:
<ol>
<li>Allow if and only if <code>sender</code>&rsquo;s current power level is greater
than or equal to the <em>invite level</em>.</li>
</ol>
</li>
<li>If the event type&rsquo;s <em>required power level</em> is greater than the
<code>sender</code>&rsquo;s power level, reject.</li>
<li>If the event has a <code>state_key</code> that starts with an <code>@</code> and does not
match the <code>sender</code>, reject.</li>
<li>If type is <code>m.room.power_levels</code>:
<ol>
<li>If any of the properties <code>users_default</code>, <code>events_default</code>, <code>state_default</code>,
<code>ban</code>, <code>redact</code>, <code>kick</code>, or <code>invite</code> in <code>content</code> are present and
not an integer, reject.</li>
<li>If either of the properties <code>events</code> or <code>notifications</code> in <code>content</code>
are present and not an object with values that are integers,
reject.</li>
<li>If the <code>users</code> property in <code>content</code> is not an obiect with keys that
are valid user IDs with values that are integers, reject.</li>
<li>If there is no previous <code>m.room.power_levels</code> event in the room,
allow.</li>
<li>For the properties <code>users_default</code>, <code>events_default</code>, <code>state_default</code>,
<code>ban</code>, <code>redact</code>, <code>kick</code>, <code>invite</code> check if they were added,
changed or removed. For each found alteration:
<ol>
<li>If the current value is higher than the <code>sender</code>&rsquo;s current
power level, reject.</li>
<li>If the new value is higher than the <code>sender</code>&rsquo;s current power
level, reject.</li>
</ol>
</li>
<li>For each entry being changed in, or removed from, the <code>events</code> or
<code>notifications</code> properties:
<ol>
<li>If the current value is greater than the <code>sender</code>&rsquo;s current
power level, reject.</li>
</ol>
</li>
<li>For each entry being added to, or changed in, the <code>events</code> or
<code>notifications</code> properties:
<ol>
<li>If the new value is greater than the <code>sender</code>&rsquo;s current power
level, reject.</li>
</ol>
</li>
<li>For each entry being changed in, or removed from, the <code>users</code> property,
other than the <code>sender</code>&rsquo;s own entry:
<ol>
<li>If the current value is greater than or equal to the <code>sender</code>&rsquo;s
current power level, reject.</li>
</ol>
</li>
<li>For each entry being added to, or changed in, the <code>users</code> property:
<ol>
<li>If the new value is greater than the <code>sender</code>&rsquo;s current power
level, reject.</li>
</ol>
</li>
<li>Otherwise, allow.</li>
</ol>
</li>
<li>Otherwise, allow.</li>
</ol>
<div class="alert note " role="alert">
<p>Some consequences of these rules:</p>
<ul>
<li>Unless you are a member of the room, the only permitted operations
(apart from the initial create/join) are: joining a public room;
accepting or rejecting an invitation to a room.</li>
<li>To unban somebody, you must have power level greater than or equal
to both the kick <em>and</em> ban levels, <em>and</em> greater than the target
user&rsquo;s power level.</li>
</ul>
</div>
<h2 id="unchanged-from-v10">Unchanged from v10</h2>
<p>The following sections have not been modified since v10, but are included for
completeness.</p>
<h3 id="handling-redactions">Handling redactions</h3>
<p><span><strong></strong></span></p>
<p>In room versions 1 and 2, redactions were
explicitly part of the <a href="/rooms/v1/#authorization-rules">authorization rules</a>
under Rule 11. As of room version 3, these conditions no longer exist as
represented by <a href="#authorization-rules">this version&rsquo;s authorization rules</a>.</p>
<p>While redactions are always accepted by the authorization rules for
events, they should not be sent to clients until both the redaction
event and the event the redaction affects have been received, and can
be validated. If both events are valid and have been seen by the server,
then the server applies the redaction if one of the following conditions
is met:</p>
<ol>
<li>The power level of the redaction event&rsquo;s <code>sender</code> is greater than or
equal to the <em>redact level</em>.</li>
<li>The domain of the redaction event&rsquo;s <code>sender</code> matches that of the
original event&rsquo;s <code>sender</code>.</li>
</ol>
<p>If the server would apply a redaction, the redaction event is also sent
to clients. Otherwise, the server simply waits for a valid partner event
to arrive where it can then re-check the above.</p>
<h3 id="event-ids">Event IDs</h3>
<p><span><strong></strong></span></p>
<p>The event ID is the <a href="/server-server-api#calculating-the-reference-hash-for-an-event">reference
hash</a> of
the event encoded using a variation of <a href="/appendices#unpadded-base64">Unpadded
Base64</a> which replaces the 62nd and
63rd characters with <code>-</code> and <code>_</code> instead of using <code>+</code> and <code>/</code>. This
matches <a href="https://tools.ietf.org/html/rfc4648#section-5">RFC4648&rsquo;s definition of URL-safe
base64</a>.</p>
<p>Event IDs are still prefixed with <code>$</code> and might result in looking like
<code>$Rqnc-F-dvnEYJTyHq_iKxU2bZ1CI92-kuZq3a5lr5Zg</code>.</p>
<h3 id="state-resolution">State resolution</h3>
<p>The room state <em>S′(E)</em> after an event <em>E</em> is defined in terms of the
room state <em>S(E)</em> before <em>E</em>, and depends on whether <em>E</em> is a state
event or a message event:</p>
<ul>
<li>If <em>E</em> is a message event, then <em>S′(E)</em> = <em>S(E)</em>.</li>
<li>If <em>E</em> is a state event, then <em>S′(E)</em> is <em>S(E)</em>, except that its
entry corresponding to the <code>event_type</code> and <code>state_key</code> of <em>E</em> is
replaced by the <code>event_id</code> of <em>E</em>.</li>
</ul>
<p>The room state <em>S(E)</em> before <em>E</em> is the <em>resolution</em> of the set of
states {<em>S′(E</em><sub>1</sub><em>)</em>, <em>S′(E</em><sub>2</sub><em>)</em>, …}
after the <code>prev_event</code>s {<em>E</em><sub>1</sub>, <em>E</em><sub>2</sub>, …} of <em>E</em>.
The resolution of a set of states is given in the algorithm below.</p>
<h4 id="definitions">Definitions</h4>
<p>The state resolution algorithm for version 2 rooms uses the following
definitions, given the set of room states
{<em>S</em><sub>1</sub>, <em>S</em><sub>2</sub>, …}:</p>
<p><strong>Power events.</strong>
A <em>power event</em> is a state event with type <code>m.room.power_levels</code> or
<code>m.room.join_rules</code>, or a state event with type <code>m.room.member</code> where
the <code>membership</code> is <code>leave</code> or <code>ban</code> and the <code>sender</code> does not match the
<code>state_key</code>. The idea behind this is that power events are events that
might remove someone&rsquo;s ability to do something in the room.</p>
<p><strong>Unconflicted state map and conflicted state set.</strong>
The keys of the state maps <em>S<sub>i</sub></em> are 2-tuples of strings of the form
<em>K</em> = <code>(event_type, state_key)</code>. The values <em>V</em> are state events.
The key-value pairs (<em>K</em>, <em>V</em>) across all state maps <em>S<sub>i</sub></em> can be
divided into two collections.
If a given key <em>K</em> is present in every <em>S<sub>i</sub></em> with the same value <em>V</em>
in each state map, then the pair (<em>K</em>, <em>V</em>) belongs to the <em>unconflicted state map</em>.
Otherwise, <em>V</em> belongs to the <em>conflicted state set</em>.</p>
<p>Note that the unconflicted state map only has one event for each key <em>K</em>,
whereas the conflicted state set may contain multiple events with the same key.</p>
<p><strong>Auth chain.</strong>
The <em>auth chain</em> of an event <em>E</em> is the set containing all of <em>E</em>&rsquo;s auth events,
all of <em>their</em> auth events, and so on recursively, stretching back to the
start of the room. Put differently, these are the events reachable by walking
the graph induced by an event&rsquo;s <code>auth_events</code> links.</p>
<p><strong>Auth difference.</strong>
The <em>auth difference</em> is calculated by first calculating the full auth
chain for each state <em>S</em><sub><em>i</em></sub>, that is the union of the auth
chains for each event in <em>S</em><sub><em>i</em></sub>, and then taking every event
that doesn&rsquo;t appear in every auth chain. If <em>C</em><sub><em>i</em></sub> is the
full auth chain of <em>S</em><sub><em>i</em></sub>, then the auth difference is
 ∪ <em>C</em><sub><em>i</em></sub> −  ∩ <em>C</em><sub><em>i</em></sub>.</p>
<p><strong>Full conflicted set.</strong>
The <em>full conflicted set</em> is the union of the conflicted state set and
the auth difference.</p>
<p><strong>Reverse topological power ordering.</strong>
The <em>reverse topological power ordering</em> of a set of events is the
lexicographically smallest topological ordering based on the DAG formed
by auth events. The reverse topological power ordering is ordered from
earliest event to latest. For comparing two topological orderings to
determine which is the lexicographically smallest, the following
comparison relation on events is used: for events <em>x</em> and <em>y</em>,
<em>x</em> &lt; <em>y</em> if</p>
<ol>
<li><em>x</em>&rsquo;s sender has <em>greater</em> power level than <em>y</em>&rsquo;s sender, when
looking at their respective <code>auth_event</code>s; or</li>
<li>the senders have the same power level, but <em>x</em>&rsquo;s <code>origin_server_ts</code>
is <em>less</em> than <em>y</em>&rsquo;s <code>origin_server_ts</code>; or</li>
<li>the senders have the same power level and the events have the same
<code>origin_server_ts</code>, but <em>x</em>&rsquo;s <code>event_id</code> is <em>less</em> than <em>y</em>&rsquo;s
<code>event_id</code>.</li>
</ol>
<p>The reverse topological power ordering can be found by sorting the
events using Kahn&rsquo;s algorithm for topological sorting, and at each step
selecting, among all the candidate vertices, the smallest vertex using
the above comparison relation.</p>
<p><strong>Mainline ordering.</strong>
Let <em>P</em> = <em>P</em><sub>0</sub> be an <code>m.room.power_levels</code> event.
Starting with <em>i</em> = 0, repeatedly fetch <em>P</em><sub><em>i</em>+1</sub>, the
<code>m.room.power_levels</code> event in the <code>auth_events</code> of <em>P<sub>i</sub></em>.
Increment <em>i</em> and repeat until <em>P<sub>i</sub></em> has no <code>m.room.power_levels</code>
event in its <code>auth_events</code>.
The <em>mainline of P</em><sub>0</sub> is the list of events
[<em>P</em><sub>0</sub> , <em>P</em><sub>1</sub>, &hellip; , <em>P<sub>n</sub></em>],
fetched in this way.</p>
<p>Let <em>e</em> = <em>e<sub>0</sub></em> be another event (possibly another
<code>m.room.power_levels</code> event). We can compute a similar list of events
[<em>e</em><sub>1</sub>, &hellip;, <em>e<sub>m</sub></em>],
where <em>e</em><sub><em>j</em>+1</sub> is the <code>m.room.power_levels</code> event in the
<code>auth_events</code> of <em>e<sub>j</sub></em> and where <em>e<sub>m</sub></em> has no
<code>m.room.power_levels</code> event in its <code>auth_events</code>. (Note that the event we
started with, <em>e<sub>0</sub></em>, is not included in this list. Also note that it
may be empty, because <em>e</em> may not cite an <code>m.room.power_levels</code> event in its
<code>auth_events</code> at all.)</p>
<p>Now compare these two lists as follows.</p>
<ul>
<li>Find the smallest index <em>j</em> ≥ 1 for which <em>e<sub>j</sub></em> belongs to the
mainline of <em>P</em>.</li>
<li>If such a <em>j</em> exists, then <em>e<sub>j</sub></em> = <em>P<sub>i</sub></em> for some unique
index <em>i</em> ≥ 0. Otherwise set <em>i</em> = ∞, where ∞ is a sentinel value greater
than any integer.</li>
<li>In both cases, the <em>mainline position</em> of <em>e</em> is <em>i</em>.</li>
</ul>
<p>Given mainline positions calculated from <em>P</em>, the <em>mainline ordering based on</em> <em>P</em> of a set of events is the ordering,
from smallest to largest, using the following comparison relation on
events: for events <em>x</em> and <em>y</em>, <em>x</em> &lt; <em>y</em> if</p>
<ol>
<li>the mainline position of <em>x</em> is <strong>greater</strong> than
the mainline position of <em>y</em> (i.e. the auth chain of
<em>x</em> is based on an earlier event in the mainline than <em>y</em>); or</li>
<li>the mainline positions of the events are the same, but <em>x</em>&rsquo;s
<code>origin_server_ts</code> is <em>less</em> than <em>y</em>&rsquo;s <code>origin_server_ts</code>; or</li>
<li>the mainline positions of the events are the same and the events have the
same <code>origin_server_ts</code>, but <em>x</em>&rsquo;s <code>event_id</code> is <em>less</em> than <em>y</em>&rsquo;s
<code>event_id</code>.</li>
</ol>
<p><strong>Iterative auth checks.</strong>
The <em>iterative auth checks algorithm</em> takes as input an initial room
state and a sorted list of state events, and constructs a new room state
by iterating through the event list and applying the state event to the
room state if the state event is allowed by the <a href="/server-server-api#authorization-rules">authorization
rules</a>.
If the state event is not allowed by the authorization rules, then the
event is ignored. If a <code>(event_type, state_key)</code> key that is required
for checking the authorization rules is not present in the state, then
the appropriate state event from the event&rsquo;s <code>auth_events</code> is used if
the auth event is not rejected.</p>
<h4 id="algorithm">Algorithm</h4>
<p>The <em>resolution</em> of a set of states is obtained as follows:</p>
<ol>
<li>Select the set <em>X</em> of all <em>power events</em> that appear in the <em>full
conflicted set</em>. For each such power event <em>P</em>, enlarge <em>X</em> by adding
the events in the auth chain of <em>P</em> which also belong to the full
conflicted set. Sort $X$ into a list using the <em>reverse topological
power ordering</em>.</li>
<li>Apply the <em>iterative auth checks algorithm</em>, starting from the
<em>unconflicted state map</em>, to the list of events from the previous
step to get a partially resolved state.</li>
<li>Take all remaining events that weren&rsquo;t picked in step 1 and order
them by the mainline ordering based on the power level in the
partially resolved state obtained in step 2.</li>
<li>Apply the <em>iterative auth checks algorithm</em> on the partial resolved
state and the list of events from the previous step.</li>
<li>Update the result by replacing any event with the event with the
same key from the <em>unconflicted state map</em>, if such an event exists,
to get the final resolved state.</li>
</ol>
<h4 id="rejected-events">Rejected events</h4>
<p>Events that have been rejected due to failing auth based on the state at
the event (rather than based on their auth chain) are handled as usual
by the algorithm, unless otherwise specified.</p>
<p>Note that no events rejected due to failure to auth against their auth
chain should appear in the process, as they should not appear in state
(the algorithm only uses events that appear in either the state sets or
in the auth chain of the events in the state sets).</p>
<div class="alert rationale " role="alert">
<p>This helps ensure that different servers&rsquo; view of state is more likely
to converge, since rejection state of an event may be different. This
can happen if a third server gives an incorrect version of the state
when a server joins a room via it (either due to being faulty or
malicious). Convergence of state is a desirable property as it ensures
that all users in the room have a (mostly) consistent view of the state
of the room. If the view of the state on different servers diverges it
can lead to bifurcation of the room due to e.g. servers disagreeing on
who is in the room.</p>
<p>Intuitively, using rejected events feels dangerous, however:</p>
<ol>
<li>Servers cannot arbitrarily make up state, since they still need to
pass the auth checks based on the event&rsquo;s auth chain (e.g. they
can&rsquo;t grant themselves power levels if they didn&rsquo;t have them
before).</li>
<li>For a previously rejected event to pass auth there must be a set of
state that allows said event. A malicious server could therefore
produce a fork where it claims the state is that particular set of
state, duplicate the rejected event to point to that fork, and send
the event. The duplicated event would then pass the auth checks.
Ignoring rejected events would therefore not eliminate any potential
attack vectors.</li>
</ol>
</div>
<p>Rejected auth events are deliberately excluded from use in the iterative
auth checks, as auth events aren&rsquo;t re-authed (although non-auth events
are) during the iterative auth checks.</p>
<h3 id="canonical-json">Canonical JSON</h3>
<p>Servers MUST strictly enforce the JSON format specified in the
<a href="/appendices#canonical-json">appendices</a>. This translates to a
400 <code>M_BAD_JSON</code> error on most endpoints, or discarding of events over
federation. For example, the Federation API&rsquo;s <code>/send</code> endpoint would
discard the event whereas the Client Server API&rsquo;s <code>/send/{eventType}</code>
endpoint would return a <code>M_BAD_JSON</code> error.</p>
<h3 id="signing-key-validity-period">Signing key validity period</h3>
<p>When validating event signatures, servers MUST enforce the
<code>valid_until_ts</code> property from a key request is at least as large as the
<code>origin_server_ts</code> for the event being validated. Servers missing a copy
of the signing key MUST try to obtain one via the <a href="/server-server-api#get_matrixkeyv2server">GET
/_matrix/key/v2/server</a>
or <a href="/server-server-api#post_matrixkeyv2query">POST
/_matrix/key/v2/query</a>
APIs. When using the <code>/query</code> endpoint, servers MUST set the
<code>minimum_valid_until_ts</code> property to prompt the notary server to attempt
to refresh the key if appropriate.</p>
<p>Servers MUST use the lesser of <code>valid_until_ts</code> and 7 days into the
future when determining if a key is valid. This is to avoid a situation
where an attacker publishes a key which is valid for a significant
amount of time without a way for the homeserver owner to revoke it.</p>

</div>


          </main>
        </div>
      </div>
      


<footer class="py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-12 text-center text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-dark" target="_blank" rel="noopener noreferrer" href="https://github.com/matrix-org">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitLab" aria-label="GitLab">
    <a class="text-dark" target="_blank" rel="noopener noreferrer" href="https://gitlab.matrix.org/matrix-org">
      <i class="fab fa-gitlab"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="YouTube" aria-label="YouTube">
    <a class="text-dark" target="_blank" rel="noopener noreferrer" href="https://www.youtube.com/channel/UCVFkW-chclhuyYRbmmfwt6w">
      <i class="fab fa-youtube"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-dark" target="_blank" rel="noopener noreferrer" href="https://twitter.com/matrixdotorg">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
    </div>
    <div class="row">
      <div class="col-12 text-center py-2 order-sm-3">
        <small>&copy; 2023 The Matrix.org Foundation CIC</small>
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    

<script src="/js/main.min.be25a680a0d95dc8b5d6664622e2134aa894220e2f224ef609e00f633a3a1b32.js" integrity="sha256-viWmgKDZXci11mZGIuITSqiUIg4vIk72CeAPYzo6GzI=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>


<script defer language="javascript" type="text/javascript"  src="/js/toc.js"></script>

  </body>
</html>
